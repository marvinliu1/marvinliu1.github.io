<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#64CEAA"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#64CEAA">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"marvinliu1.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Take in the good!">
<meta property="og:type" content="website">
<meta property="og:title" content="Marvin&#39;s Blog">
<meta property="og:url" content="https://marvinliu1.github.io/index.html">
<meta property="og:site_name" content="Marvin&#39;s Blog">
<meta property="og:description" content="Take in the good!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Marvin Liu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://marvinliu1.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Marvin's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Marvin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Marvin's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>links</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Marvin Liu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Marvin Liu</p>
  <div class="site-description" itemprop="description">Take in the good!</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/marvinliu1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;marvinliu1" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liuyongquan2010@gmail.com" title="E-Mail → mailto:liuyongquan2010@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="color:white;">document.designMode='on'</div>

        </div>
      </div>
    </div>
    
    <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
    <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
    <div class="widget-wrap">
        <h3 class="widget-title">Tags</h3>
        <div id="myCanvasContainer" class="widget tagcloud">
            <canvas width="250" height="250" id="resCanvas" style="width=100%">
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debugging/" rel="tag">Debugging</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/" rel="tag">Javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MarkDown/" rel="tag">MarkDown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NeXt/" rel="tag">NeXt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Next/" rel="tag">Next</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node/" rel="tag">Node</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nohup/" rel="tag">Nohup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nuxt/" rel="tag">Nuxt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a><span class="tag-list-count">2</span></li></ul>
            </canvas>
        </div>
    </div>
    
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/marvinliu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2020/09/25/How-To-Implement-Auth-in-Nuxt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/25/How-To-Implement-Auth-in-Nuxt/" class="post-title-link" itemprop="url">How To Implement Authentication in a Nuxt.js App</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-25 00:12:31" itemprop="dateCreated datePublished" datetime="2020-09-25T00:12:31-06:00">2020-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nuxt/" itemprop="url" rel="index"><span itemprop="name">Nuxt</span></a>
        </span>
    </span>

  
    <span id="/2020/09/25/How-To-Implement-Auth-in-Nuxt/" class="post-meta-item leancloud_visitors" data-flag-title="How To Implement Authentication in a Nuxt.js App" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/implementing-authentication-in-nuxtjs-app">Original published and copy-righted by Chimezie Enyinnaya</a><br><a target="_blank" rel="noopener" href="https://assets.digitalocean.com/">View more on digitalocean.com</a></p>
<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>In this tutorial, you’ll implement authentication in a <a target="_blank" rel="noopener" href="https://nuxtjs.org/">Nuxt.js</a> app using the <code>Auth</code> module.</p>
<p>For the purpose of this tutorial, you’ll be using <code>JWT</code> for authentication.</p>
<p>Below is a quick demo of what you’ll be building in this tutorial:</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/2tWhMLqrSl2lC07r3JA5_nuxt-auth-demo.gif" alt="Animated gif of the app showing a user signing in"></p>
<p>You can find the <a target="_blank" rel="noopener" href="https://github.com/do-community/nuxt-auth-app">source code for this application at GitHub</a>.</p>
<p><strong>Warning:</strong> Several of the packages in this tutorial now contain dependencies with known vulnerabilities. In a production setting, you would resolve these issues by upgrading these packages, finding alternatives, or creating forked versions with patched fixes. However, within the limited context of a tutorial, it provides educational value as-is.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>To complete this tutorial, you will need:</p>
<ul>
<li>Node.js installed locally, which you can do by following <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorial_series/how-to-install-node-js-and-create-a-local-development-environment">How to Install Node.js and Create a Local Development Environment</a>.</li>
<li>A valid Git installation is optionally required for cloning the API, consult <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-contribute-to-open-source-getting-started-with-git">Getting Started with Git</a>.</li>
</ul>
<p>Some familiarity with Vue.js and Nuxt.js may be beneficial. You can <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/vuejs-server-side-rendering-with-nuxtjs">refer to this post</a> if you’re getting started with Nuxt.js.</p>
<p>This tutorial was verified with Node v13.13.0, npm v6.14.4, <code>vue</code> v2.6.11, and <code>nuxt</code> v2.12.2.</p>
<h2 id="Step-1-—-Spinning-up-a-Sample-API"><a href="#Step-1-—-Spinning-up-a-Sample-API" class="headerlink" title="Step 1 — Spinning up a Sample API"></a>Step 1 — Spinning up a Sample API</h2><p>You are free to use whatever framework that works best for you. However, for quick development, this tutorial will clone an API built with <a target="_blank" rel="noopener" href="https://adonisjs.com/">AdonisJs</a>.</p>
<p>The API utilizes:</p>
<ul>
<li>JWT (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Tokens</a>) for authentication</li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SQLite">SQLite</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> enabled</li>
</ul>
<p>The API has three endpoints:</p>
<ul>
<li><code>/register</code>: endpoint for user registration</li>
<li><code>/login</code>: endpoint for authenticating users</li>
<li><code>/me</code>: endpoint for getting details for the currently authenticated user and it is protected by an <code>auth</code> middleware, which means a user must be authenticated to access the endpoint</li>
</ul>
<p>First, run the following command in your terminal window:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/do-community/jwt-auth-api.git</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Then, navigate to the project directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> jwt-auth-api</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And install the API dependencies:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p><strong>Note</strong>: When running install, you may encounter issues with <code>sqlite3</code> version <code>4.0.1</code> depending on the version of Node you are running. Refer to the <a target="_blank" rel="noopener" href="https://github.com/mapbox/node-sqlite3/blob/master/CHANGELOG.md">changelog</a> to determine compatibility with your environment.</p>
<p>At the time of original publication, the latest version of Node was 10. One option is to downgrade your version of Node to <code>10.20.1</code> (with the understanding that it is nearing end-of-life support). Then, run <code>npm install</code>.</p>
<p>A second option is to remove the <code>package-lock.json</code> file which will cause the system to look for <code>4.2.0</code> which is supported up to Node 13. You may need to also downgrade your version of Node to <code>13.13.0</code>. Then, run <code>npm install</code>.</p>
<p>A third option would be to modify <code>package.json</code> to a version of <code>sqlite3</code> supported by your current version of Node, remove <code>package-lock.json</code>, and run <code>npm install</code>. However, at the time of testing, <code>5.0.0</code> is not yet released to handle Node 14+ support.</p>
<p>Other symptoms of incompatibility include the following errors: <code>TypeError: Cannot read property &#39;data&#39; of undefined</code> and <code>Error: Cannot find module &#39;[...]/node_modules/sqlite3/lib/binding/[...]/node_sqlite3.node&#39;</code>.</p>
<p>Next, rename <code>.env.example</code> to <code>.env</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> .env.example .<span class="built_in">env</span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And generate an <code>APP_KEY</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx @adonisjs/cli@4.0.12 key:generate</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>You should see:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Outputgenerated: unique APP_KEY</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Once that’s coomplete, let’s run the migrations:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx @adonisjs/cli@4.0.12 migration:run</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Now, you can start the API:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ensure that you are in the `jwt-auth-api` project directory</span></span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>You can access the API on <code>http://127.0.0.1:3333/api</code>. Leave this running in a terminal window for the rest of the duration of the tutorial.</p>
<h2 id="Step-2-—-Creating-a-Nuxt-js-App"><a href="#Step-2-—-Creating-a-Nuxt-js-App" class="headerlink" title="Step 2 — Creating a Nuxt.js App"></a>Step 2 — Creating a Nuxt.js App</h2><p>Now, you can create a Nuxt.js app. Open a new terminal window and use <code>vue-cli</code> to initialize a new Vue project with the Nuxt starter template:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx vue-cli@2.9.6 init nuxt/starter nuxt-auth</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p><strong>Note:</strong> At the time of testing, <code>vue-cli</code> is deprecated. <code>@vue/cli</code> is the current command line tool for Vue projects. And <code>@vue/cli-init</code> is the recommended approach for legacy <code>vue-cli</code> projects. However, <code>create-nuxt-app</code> is the recommended approach for modern Nuxt projects.</p>
<p>Next, you need to navigate to the project directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> nuxt-auth</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And install the dependencies:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>Then, you can launch the app:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>The app should be running on <code>http://localhost:3000</code>. You can view the application in a web browser to see the default Vue application created by <code>vue-cli</code>.</p>
<h2 id="Step-3-—-Installing-Necessary-Nuxt-js-Modules"><a href="#Step-3-—-Installing-Necessary-Nuxt-js-Modules" class="headerlink" title="Step 3 — Installing Necessary Nuxt.js Modules"></a>Step 3 — Installing Necessary Nuxt.js Modules</h2><p>Now, let’s install the Nuxt.js modules that you’ll be needing for your app. You’ll be using the <a target="_blank" rel="noopener" href="https://auth.nuxtjs.org/">Nuxt Auth module</a> and the <a target="_blank" rel="noopener" href="https://axios.nuxtjs.org/">Nuxt Axios module</a>, since the <code>auth</code> module makes use of Axios internally:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ensure that you are in the `nuxt-auth` project directory</span></span><br><span class="line">npm install @nuxtjs/auth@4.5.1 @nuxtjs/axios@5.3.1 --save</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Once that’s completed, open <code>nuxt.config.js</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano nuxt.config.js</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Add the code below to <code>nuxt.config.js</code>:</p>
<p>nuxt.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">modules</span>: [</span><br><span class="line">    <span class="string">&#x27;@nuxtjs/axios&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@nuxtjs/auth&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p><strong>Note:</strong> At this point, newer versions of Nuxt may encounter the error: <code>Enable vuex store by creating &#39;store/index.js&#39;</code>. This error can be resolved by <a target="_blank" rel="noopener" href="https://github.com/nuxt-community/auth-module/issues/104">adding an empty <code>index.js</code> file to the <code>store</code> directory</a>.</p>
<p>Next, you need to set up the modules. Paste the code below into <code>nuxt.config.js</code>:</p>
<p>nuxt.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">axios</span>: &#123;</span><br><span class="line">    <span class="attr">baseURL</span>: <span class="string">&#x27;http://127.0.0.1:3333/api&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">auth</span>: &#123;</span><br><span class="line">    <span class="attr">strategies</span>: &#123;</span><br><span class="line">      <span class="attr">local</span>: &#123;</span><br><span class="line">        <span class="attr">endpoints</span>: &#123;</span><br><span class="line">          <span class="attr">login</span>: &#123; <span class="attr">url</span>: <span class="string">&#x27;login&#x27;</span>, <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">propertyName</span>: <span class="string">&#x27;data.token&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">user</span>: &#123; <span class="attr">url</span>: <span class="string">&#x27;me&#x27;</span>, <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>, <span class="attr">propertyName</span>: <span class="string">&#x27;data&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">logout</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Here, you set the base URL that Axios will use when making requests. In our case, we are referencing the sample API we set up earlier.</p>
<p>Then, you define the authentication endpoints for the <code>local</code> strategy corresponding to those on your API:</p>
<ul>
<li>On successful authentication, the token will be available in the response as a <code>token</code> object inside a <code>data</code> object.</li>
<li>Similarly, the response from the <code>/me</code> endpoint will be inside a <code>data</code> object.</li>
<li>Lastly, you set <code>logout</code> to <code>false</code> since your API doesn’t have an endpoint for logout. You’ll just remove the token from localStorage when a user logs out.</li>
</ul>
<h2 id="Step-4-—-Creating-a-Navbar-Component"><a href="#Step-4-—-Creating-a-Navbar-Component" class="headerlink" title="Step 4 — Creating a Navbar Component"></a>Step 4 — Creating a Navbar Component</h2><p>To style your app, you can make use of <a target="_blank" rel="noopener" href="https://bulma.io/">Bulma</a>.</p>
<p>Open <code>nuxt.config.js</code> and paste the code below within the <code>link</code> object that is inside the <code>head</code> object:</p>
<p>nuxt.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">head</span>: &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    link [</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">rel</span>: <span class="string">&#x27;stylesheet&#x27;</span>,</span><br><span class="line">        <span class="attr">href</span>: <span class="string">&#x27;https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Now, let’s create the Navbar component:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano components/Navbar.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And add the following code:</p>
<p>components&#x2F;Navbar.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar is-light&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Nuxt Auth<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button navbar-burger&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-menu&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-end&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item has-dropdown is-hoverable&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-link&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              My Account</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-dropdown&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/profile&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">hr</span> <span class="attr">class</span>=<span class="string">&quot;navbar-divider&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>The Navbar component contains links to <code>login</code>, <code>register</code>, <code>profile</code>, and <code>logout</code>.</p>
<p>Next, let’s update the default layout to make use of the <code>Navbar</code> component.</p>
<p>Open <code>default.vue</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano layouts/default.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And replace the content with the following:</p>
<p>layouts&#x2F;default.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">Navbar</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">nuxt</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">Navbar</span> <span class="keyword">from</span> <span class="string">&#x27;~/components/Navbar&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Navbar</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Also, let’s update the homepage.</p>
<p>Open <code>index.vue</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/index.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And replace the content with the following:</p>
<p>pages&#x2F;index.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>Nuxt Auth<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>At this point, you should have an application that displays a title of <code>&quot;Nuxt Auth&quot;</code> with a header bar with navigation links:</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/Y27FZj1TNm6tj0skgdhV_homepage.png" alt="App page with title and header bar"></p>
<h2 id="Step-5-—-Handling-User-Registration"><a href="#Step-5-—-Handling-User-Registration" class="headerlink" title="Step 5 — Handling User Registration"></a>Step 5 — Handling User Registration</h2><p>Inside the <code>pages</code> directory, create a new <code>register.vue</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/register.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And add the following code:</p>
<p>pages&#x2F;register.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column is-4 is-offset-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title has-text-centered&quot;</span>&gt;</span>Register!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Notification</span> <span class="attr">:message</span>=<span class="string">&quot;error&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;error&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> @<span class="attr">submit.prevent</span>=<span class="string">&quot;register&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;username&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;username&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button is-dark is-fullwidth&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;has-text-centered&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 20px&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            Already got an account? <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">Notification</span> <span class="keyword">from</span> <span class="string">&#x27;~/components/Notification&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Notification</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">email</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">error</span>: <span class="literal">null</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$axios</span>.<span class="title function_">post</span>(<span class="string">&#x27;register&#x27;</span>, &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">username</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">email</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">loginWith</span>(<span class="string">&#x27;local&#x27;</span>, &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">data</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">email</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125; <span class="keyword">catch</span> (e) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">error</span> = e.<span class="property">response</span>.<span class="property">data</span>.<span class="property">message</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>This contains a form with three fields: <code>username</code>, <code>email</code>, and <code>password</code>. Each field is bound to corresponding data on the component. When the form is submitted, a <code>register</code> method will be called. Using the Axios module, you make a post request to the <code>/register</code> endpoint, passing along the user data. If the registration was successful, you make use of the Auth module’s <code>loginWith()</code>, using the <code>local</code> strategy and passing the user data to log the user in. Then, you redirect the user to the homepage. If there is an error during the registration, you set the <code>error</code> data as the error message gotten from the API response.</p>
<p>If there is an error, the error message is displayed by a Notification component.</p>
<p>Create a new <code>Notification.vue</code> file inside <code>components</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano components/Notifaction.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And paste the code below in it:</p>
<p>components&#x2F;Notification.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;notification is-danger&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;&#123; message &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;Notification&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">props</span>: [<span class="string">&#x27;message&#x27;</span>]</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>The Notification component accepts a <code>message</code> props, which is the error message.</p>
<p>Now, you can test out user registration:</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/wOTj1xspRjiwMsaiWKt5_register.png" alt="Register page with Username, Email, and Password fields"></p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/qsHgdfDIR3ijyirZVqu4_register_failed.png" alt="Register page but with a notification message to the user that there was an error"></p>
<h2 id="Step-6-—-Handling-LoggedUsers-Logged-In-and-Logged-Out"><a href="#Step-6-—-Handling-LoggedUsers-Logged-In-and-Logged-Out" class="headerlink" title="Step 6 — Handling LoggedUsers Logged In and Logged Out"></a>Step 6 — Handling LoggedUsers Logged In and Logged Out</h2><p>Upon successful registration, users should be logged in but there is currently no way for the app to know whether users are logged in or not. So let’s fix that by updating the Navbar component and adding some computed properties.</p>
<p>Before you do just that, let’s first activate the Vuex store by creating an <code>index.js</code> file inside the <code>store</code> directory. The Auth module stores user authentication status as well as user details inside Vuex state in an <code>auth</code> object. So you can check if a user is logged in or not with <code>this.$store.state.auth.loggedIn</code>, which will either return <code>true</code> or <code>false</code>. Similarly, you can get a user’s details with <code>this.$store.state.auth.user</code>, which will be <code>null</code> if no user is logged in.</p>
<p><strong>Note:</strong> You can also access the user authentication status as well as the user details directly with the Auth module using <code>this.$auth.loggedIn</code> and <code>this.$auth.user</code> respectively.</p>
<p>Since you might want to use the computed properties in multiple places in your app, let’s create store getters.</p>
<p>Open <code>index.js</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano store/index.js</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And paste the code below in it:</p>
<p>store&#x2F;index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="title function_">isAuthenticated</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> state.<span class="property">auth</span>.<span class="property">loggedIn</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loggedInUser</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> state.<span class="property">auth</span>.<span class="property">user</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Here, you create two getters. The first one (<code>isAuthenticated</code>) will return the authentication status of a user and the second (<code>loggedInUser</code>) will return the details or the logged in user.</p>
<p>Next, let’s update the Navbar component to make use of the getters. Replace the content of <code>components/Navbar.vue</code> with the following:</p>
<p>components&#x2F;Navbar.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar is-light&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Nuxt Auth<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button navbar-burger&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-menu&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-end&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item has-dropdown is-hoverable&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;isAuthenticated&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-link&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              &#123;&#123; loggedInUser.username &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-dropdown&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/profile&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">hr</span> <span class="attr">class</span>=<span class="string">&quot;navbar-divider&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-else</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    ...<span class="title function_">mapGetters</span>([<span class="string">&#x27;isAuthenticated&#x27;</span>, <span class="string">&#x27;loggedInUser&#x27;</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>You create the computed properties by using the spread operator (<code>...</code>) to extract the getters from <code>mapGetters</code>. Then using <code>isAuthenticated</code>, you display the user menu or links to <code>login</code> or <code>register</code> depending on whether the user is logged in or not. Also, you use <code>loggedInUser</code> to display the authenticated user username.</p>
<p>Now, if you give your app a refresh, you should see something similar to below:</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/NwqCBhzrSxysvLV832HE_loggedin.png" alt="App page with the user&#39;s username in the header"></p>
<h2 id="Step-7-—-Handling-User-Log-In"><a href="#Step-7-—-Handling-User-Log-In" class="headerlink" title="Step 7 — Handling User Log In"></a>Step 7 — Handling User Log In</h2><p>Now, let’s allow returning users the ability to log in.</p>
<p>Create a new <code>login.vue</code> file inside the <code>pages</code> directory:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/login.vue</span><br></pre></td></tr></table></figure>

<p>And paste the code below in it:</p>
<p>pages&#x2F;login.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column is-4 is-offset-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title has-text-centered&quot;</span>&gt;</span>Welcome back!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Notification</span> <span class="attr">:message</span>=<span class="string">&quot;error&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;error&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> @<span class="attr">submit.prevent</span>=<span class="string">&quot;login&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button is-dark is-fullwidth&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;has-text-centered&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 20px&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              Don&#x27;t have an account? <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">Notification</span> <span class="keyword">from</span> <span class="string">&#x27;~/components/Notification&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Notification</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">email</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">error</span>: <span class="literal">null</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">loginWith</span>(<span class="string">&#x27;local&#x27;</span>, &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">data</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">email</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125; <span class="keyword">catch</span> (e) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">error</span> = e.<span class="property">response</span>.<span class="property">data</span>.<span class="property">message</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>This is quite similar to the <code>register</code> page. The form contains two fields: <code>email</code> and <code>password</code>. When the form is submitted, a <code>login</code> method will be called. Using the Auth module <code>loginWith()</code> and passing along the user data, you log the user in. If the authentication was successful, you redirect the user to the homepage. Otherwise, set <code>error</code> to the error message gotten from the API response. Again, you are using the Notification component from earlier on to display the error message.</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/neC1nzCQeeBX5jgZZskQ_login.png" alt="App Welcome Back page containing two fields: email and password"></p>
<h2 id="Step-8-—-Displaying-the-User-Profile"><a href="#Step-8-—-Displaying-the-User-Profile" class="headerlink" title="Step 8 — Displaying the User Profile"></a>Step 8 — Displaying the User Profile</h2><p>Let’s allow logged in users to view their profile.</p>
<p>Create a new <code>profile.vue</code> file inside the <code>pages</code> directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/profile.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And paste the code below in it:</p>
<p>pages&#x2F;profile.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Username:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;&#123; loggedInUser.username &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Email:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;&#123; loggedInUser.email &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    ...<span class="title function_">mapGetters</span>([<span class="string">&#x27;loggedInUser&#x27;</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Notice how you are using the <code>loggedInUser</code> getter from earlier on to display the user details.</p>
<p>Clicking on the <strong>My Profile</strong> link should result in a <strong>My Profile</strong> page being displayed.</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/UqKusiHSRCC2H7IcytjA_profile.png" alt="My Profile page displaying username and email"></p>
<h2 id="Step-9-—-Logging-Users-Out"><a href="#Step-9-—-Logging-Users-Out" class="headerlink" title="Step 9 — Logging Users Out"></a>Step 9 — Logging Users Out</h2><p>Update the logout link inside the Navbar component.</p>
<p>Open <code>Navbar.vue</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano components/Navbar.vue</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Modify the logout link to use <code>@click=&quot;logout&quot;</code>:</p>
<p>components&#x2F;Navbar.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">&quot;navbar-dropdown&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/profile&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">class</span>=<span class="string">&quot;navbar-divider&quot;</span>/&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span>  @<span class="attr">click</span>=<span class="string">&quot;logout&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>When the logout link is clicked, it will trigger a <code>logout</code> method.</p>
<p>Next, let’s add the <code>logout</code> method inside the script section of the Navbar component:</p>
<p>components&#x2F;Navbar.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">logout</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>You call the <code>logout()</code> of the Auth module. This will delete the user’s token from localstorage and redirect the user to the homepage.</p>
<h2 id="Step-10-—-Restricting-the-Profile-Page"><a href="#Step-10-—-Restricting-the-Profile-Page" class="headerlink" title="Step 10 — Restricting the Profile Page"></a>Step 10 — Restricting the Profile Page</h2><p>As it stands now, anybody can visit the <code>profile</code> page. And if the user is not logged in, it will result in an error.</p>
<p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/9UMgSTQCQUqSTGAdb6nY_profile_error.png" alt="TypeError on app page"></p>
<p>To fix this, you need to restrict the profile page to only logged in users. Luckily for us, you can achieve that with the Auth module. The Auth module comes with an <code>auth</code> middleware, which you can use in this scenario.</p>
<p>So let’s add the <code>auth</code> middleware to the <code>profile</code> page. Update the <code>script</code> section as below:</p>
<p>pages&#x2F;profile.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">middleware</span>: <span class="string">&#x27;auth&#x27;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Now when a user that is not logged in tries to visit the <code>profile</code> page, the user will be redirected to the <code>login</code> page.</p>
<h2 id="Step-11-—-Creating-a-Guest-Middleware"><a href="#Step-11-—-Creating-a-Guest-Middleware" class="headerlink" title="Step 11 — Creating a Guest Middleware"></a>Step 11 — Creating a Guest Middleware</h2><p>Again as it stands, even as a logged in user, you can still access the login and register pages. One way to fix that is to restrict login and register pages to only users that are not logged in. You can do that by creating a guest middleware.</p>
<p>Inside the <code>middleware</code> directory, create a new <code>guest.js</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano middleware/guest.js</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>And paste the code below in it:</p>
<p>middleware&#x2F;guest.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params">&#123; store, redirect &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">state</span>.<span class="property">auth</span>.<span class="property">loggedIn</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>A middleware accepts the context as its first argument. So you extract <code>store</code> and <code>redirect</code> from the context. Then, you check if the user is logged in then redirect the user to the homepage. Otherwise, you allow the normal execution of the request.</p>
<p>Next, let’s make use of this middleware. Update the <code>script</code> section of both <code>login</code> and <code>register</code> as below:</p>
<p>pages&#x2F;login.vue and pages&#x2F;register.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">middleware</span>: <span class="string">&#x27;guest&#x27;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Copy</p>
<p>Now, everything will be working as expected.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this tutorial, you looked at how to implement authentication in a Nuxt.js application using the Auth module. You also saw how to keep the authentication flow sleek by making use of middleware.</p>
<p>To learn more about the Auth module, check out the <a target="_blank" rel="noopener" href="https://auth.nuxtjs.org/">docs</a>.</p>
<p>If you’d like to learn more about Vue.js, check out <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tags/vue-js">our Vue.js topic page</a> for exercises and programming projects.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2020/05/21/Markdown%E5%85%AC%E5%BC%8F%E7%94%A8%E6%B3%95%E5%A4%A7%E5%85%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/21/Markdown%E5%85%AC%E5%BC%8F%E7%94%A8%E6%B3%95%E5%A4%A7%E5%85%A8/" class="post-title-link" itemprop="url">Markdown Handbook</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-05-21 00:12:31" itemprop="dateCreated datePublished" datetime="2020-05-21T00:12:31-06:00">2020-05-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
        </span>
    </span>

  
    <span id="/2020/05/21/Markdown%E5%85%AC%E5%BC%8F%E7%94%A8%E6%B3%95%E5%A4%A7%E5%85%A8/" class="post-meta-item leancloud_visitors" data-flag-title="Markdown Handbook" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p>Markdown是一种轻量级标记语言</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一级标题</span></span><br><span class="line"><span class="comment">## 二级标题</span></span><br><span class="line"><span class="comment">### 三级标题</span></span><br><span class="line"><span class="comment">#### 四级标题</span></span><br><span class="line"><span class="comment">##### 五级标题</span></span><br><span class="line"><span class="comment">###### 六级标题</span></span><br><span class="line">**加粗**</span><br><span class="line">*斜体*</span><br><span class="line">==高亮==</span><br></pre></td></tr></table></figure>

<h4 id="两种代码引用方式"><a href="#两种代码引用方式" class="headerlink" title="两种代码引用方式"></a>两种代码引用方式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">``式或```式</span><br></pre></td></tr></table></figure>

<h4 id="插入链接并描述"><a href="#插入链接并描述" class="headerlink" title="插入链接并描述"></a>插入链接并描述</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[博客]</span>(<span class="attribute">https</span>:<span class="comment">//www.cnblogs.com/ &quot;博客&quot;)</span></span><br></pre></td></tr></table></figure>

<h4 id="插入图片"><a href="#插入图片" class="headerlink" title="插入图片"></a>插入图片</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![路飞](https://pic.baike.soso.com/ugc/baikepic2/0/ori-20190529230042-1249666563_jpeg_640_960_59726.jpg/800 <span class="string">&#x27;路飞&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表"></a>有序列表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="keyword">one</span></span><br><span class="line"><span class="number">2.</span>two</span><br><span class="line"><span class="number">3.</span>three</span><br></pre></td></tr></table></figure>

<h4 id="无序列表"><a href="#无序列表" class="headerlink" title="无序列表"></a>无序列表</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*</span> one</span><br><span class="line"><span class="bullet">*</span> two</span><br><span class="line"><span class="bullet">*</span> three</span><br></pre></td></tr></table></figure>

<h4 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h4 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name | age | sex</span><br><span class="line"><span class="section">:-: | :- | -:</span></span><br><span class="line">tony|20|男</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">name</th>
<th align="left">age</th>
<th align="center">sex</th>
</tr>
</thead>
<tbody><tr>
<td align="center">tony</td>
<td align="left">20</td>
<td align="center">男</td>
</tr>
</tbody></table>
<p>注：代码中第二行分别表示居中，右对齐，左对齐，若结果不显示，转化成源代码模式去掉行与行之间的空行。</p>
<h3 id="如何插入公式"><a href="#如何插入公式" class="headerlink" title="如何插入公式"></a>如何插入公式</h3><p>数学公式有两种：行中公式（与文字搭配使用）和独立公式（独立成行）</p>
<p>行内公式表示：<code>$ 数学公式 $</code></p>
<p>独立公式表示：<code>$$ 数学公式 $$</code></p>
<h3 id="如何输入上下标"><a href="#如何输入上下标" class="headerlink" title="如何输入上下标"></a>如何输入上下标</h3><p><code>^</code> 表示上标, <code>_</code> 表示下标。如果上下标的内容多于一个字符，需要用 <code>&#123;&#125;</code> 将这些内容括成一个整体。上下标可以嵌套，也可以同时使用。</p>
<p>如：<code>$$ x^&#123;y^z&#125;=(1+&#123;\rm e&#125;^x)^&#123;-2xy^w&#125; $$</code>,显示：$x{yz}&#x3D;(1+{\rm e}x){-2xy^w} $</p>
<p>另外，如果要在左右两边都有上下标，可以用 <code>\sideset</code> 命令。</p>
<p>如：<code>$$ \sideset&#123;^1_2&#125;&#123;^3_4&#125;\bigotimes $$</code>,显示：$ \sideset{1_2}{3_4}\bigotimes $</p>
<h3 id="如何输入括号和分隔符"><a href="#如何输入括号和分隔符" class="headerlink" title="如何输入括号和分隔符"></a>如何输入括号和分隔符</h3><p><code>()</code>、<code>[]</code> 和 <code>|</code> 表示符号本身，使用 <code>\&#123;\&#125;</code> 来表示 <code>&#123;&#125;</code> 。当要显示大号的括号或分隔符时，要用 <code>\left</code> 和 <code>\right</code> 命令。</p>
<table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\langle</td>
<td align="center">⟨⟨</td>
<td align="center">\rangle</td>
<td align="center">⟩⟩</td>
</tr>
<tr>
<td align="center">\lceil</td>
<td align="center">⌈⌈</td>
<td align="center">\rceil</td>
<td align="center">⌉⌉</td>
</tr>
<tr>
<td align="center">\lfloor</td>
<td align="center">⌊⌊</td>
<td align="center">\rfloor</td>
<td align="center">⌋⌋</td>
</tr>
<tr>
<td align="center">\lbrace</td>
<td align="center">{ {</td>
<td align="center">\rbrace</td>
<td align="center">} }</td>
</tr>
</tbody></table>
<p>如：<code>$$ f(x,y,z) = 3y^2z \left( 3+\frac&#123;7x+5&#125;&#123;1+y^2&#125; \right) $$</code>,显示：f(x,y,z)&#x3D;3y2z(3+7x+51+y2)f(x,y,z)&#x3D;3y2z(3+7x+51+y2)</p>
<p>有时候要用 <code>\left.</code> 或 <code>\right.</code> 进行匹配而不显示本身。</p>
<p>如：<code>$$ \left. \frac&#123;&#123;\rm d&#125;u&#125;&#123;&#123;\rm d&#125;x&#125; \right| _&#123;x=0&#125; $$`,显示：[MathProcessingError]dudx∣∣x=0[MathProcessingError]dudx|x=0

### 如何输入分数

通常使用 `\frac &#123;分子&#125; &#123;分母&#125;` 命令产生一个分数，分数可嵌套。便捷情况可直接输入 `\frac ab` 来快速生成一个 abab 。
如果分式很复杂，亦可使用 `分子 \over 分母` 命令，此时分数仅有一层。

如：`$$ \frac&#123;a-1&#125;&#123;b-1&#125; \quad and \quad &#123;a+1\over b+1&#125; $$`,显示：a−1b−1anda+1b+1a−1b−1anda+1b+1

### 如何输入开方

使用 `\sqrt [根指数，省略时为2] &#123;被开方数&#125;` 命令输入开方。

如：`$$ \sqrt&#123;2&#125; \quad and \quad \sqrt[n]&#123;3&#125; $$`,显示：2–√and3–√n2and3n

### 如何输入省略号

数学公式中常见的省略号有两种，`\ldots` 表示与文本底线对齐的省略号，`\cdots` 表示与文本中线对齐的省略号。

如：`$$ f(x_1,x_2,\underbrace&#123;\ldots&#125;_&#123;\rm ldots&#125; ,x_n) = x_1^2 + x_2^2 + \underbrace&#123;\cdots&#125;_&#123;\rm cdots&#125; + x_n^2 $$`,显示：$ f(x_1,x_2,\underbrace&#123;\ldots&#125;*&#123;\rm ldots&#125; ,x_n) = x_1^2 + x_2^2 + \underbrace&#123;\cdots&#125;*&#123;\rm cdots&#125; + x_n^2 $

### 如何输入矢量

使用 `\vec&#123;矢量&#125;` 来自动产生一个矢量。也可以使用 `\overrightarrow` 等命令自定义字母上方的符号。

如：`$$ \vec&#123;a&#125; \cdot \vec&#123;b&#125;=0 $$`,显示：

a⃗ ⋅b⃗ =0a→⋅b→=0



如：`$$ \overleftarrow&#123;xy&#125; \quad and \quad \overleftrightarrow&#123;xy&#125; \quad and \quad \overrightarrow&#123;xy&#125; $$`,显示：

xy←−andxy←→andxy−→xy←andxy↔andxy→



### 如何输入积分

使用 `\int_积分下限^积分上限 &#123;被积表达式&#125;` 来输入一个积分。

如：`$$ \int_0^1 &#123;x^2&#125; \,&#123;\rm d&#125;x $$`,显示：∫10x2,dx∫01x2,dx,例中 `\,` 和 `&#123;\rm d&#125;` 部分可省略，建议加入，使式子更美观。

### 如何输入极限运算

使用 `\lim_&#123;变量 \to 表达式&#125; 表达式` 来输入一个极限。如有需求，可以更改 `\to` 符号至任意符号。

如：`$$ \lim_&#123;n \to +\infty&#125; \frac&#123;1&#125;&#123;n(n+1)&#125; \quad and \quad \lim_&#123;x\leftarrow&#123;示例&#125;&#125; \frac&#123;1&#125;&#123;n(n+1)&#125; $$</code>,显示：</p>
<p>limn→+∞1n(n+1)andlimx←示例1n(n+1)limn→+∞1n(n+1)andlimx←示例1n(n+1)</p>
<h3 id="如何输入累加、累乘运算"><a href="#如何输入累加、累乘运算" class="headerlink" title="如何输入累加、累乘运算"></a>如何输入累加、累乘运算</h3><p>使用 <code>\sum_&#123;下标表达式&#125;^&#123;上标表达式&#125; &#123;累加表达式&#125;</code> 来输入一个累加。与之类似，使用 <code>\prod</code> <code>\bigcup</code> <code>\bigcap</code> 来分别输入累乘、并集和交集。此类符号在行内显示时上下标表达式将会移至右上角和右下角。</p>
<p>如：<code>$$ \sum_&#123;i=1&#125;^n \frac&#123;1&#125;&#123;i^2&#125; \quad and \quad \prod_&#123;i=1&#125;^n \frac&#123;1&#125;&#123;i^2&#125; \quad and \quad \bigcup_&#123;i=1&#125;^&#123;2&#125; R $$</code>,显示：∑ni&#x3D;11i2and∏ni&#x3D;11i2and⋃2i&#x3D;1R∑i&#x3D;1n1i2and∏i&#x3D;1n1i2and⋃i&#x3D;12R</p>
<h3 id="如何输入希腊字母"><a href="#如何输入希腊字母" class="headerlink" title="如何输入希腊字母"></a>如何输入希腊字母</h3><p>输入 <code>\小写希腊字母英文全称</code> 和 <code>\首字母大写希腊字母英文全称</code> 来分别输入小写和大写希腊字母,对于大写希腊字母与现有字母相同的，直接输入大写字母即可。</p>
<table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\alpha</td>
<td align="center">αα</td>
<td align="center">A</td>
<td align="center">AA</td>
<td align="center">\beta</td>
<td align="center">ββ</td>
<td align="center">B</td>
<td align="center">BB</td>
</tr>
<tr>
<td align="center">\gamma</td>
<td align="center">γγ</td>
<td align="center">\Gamma</td>
<td align="center">ΓΓ</td>
<td align="center">\delta</td>
<td align="center">δδ</td>
<td align="center">\Delta</td>
<td align="center">ΔΔ</td>
</tr>
<tr>
<td align="center">\epsilon</td>
<td align="center">ϵϵ</td>
<td align="center">E</td>
<td align="center">EE</td>
<td align="center">\zeta</td>
<td align="center">ζζ</td>
<td align="center">Z</td>
<td align="center">ZZ</td>
</tr>
<tr>
<td align="center">\eta</td>
<td align="center">ηη</td>
<td align="center">H</td>
<td align="center">HH</td>
<td align="center">\theta</td>
<td align="center">θθ</td>
<td align="center">\Theta</td>
<td align="center">ΘΘ</td>
</tr>
<tr>
<td align="center">\iota</td>
<td align="center">ιι</td>
<td align="center">I</td>
<td align="center">II</td>
<td align="center">\kappa</td>
<td align="center">κκ</td>
<td align="center">K</td>
<td align="center">KK</td>
</tr>
<tr>
<td align="center">\lambda</td>
<td align="center">λλ</td>
<td align="center">\Lambda</td>
<td align="center">ΛΛ</td>
<td align="center">\mu</td>
<td align="center">μμ</td>
<td align="center">M</td>
<td align="center">MM</td>
</tr>
<tr>
<td align="center">\nu</td>
<td align="center">νν</td>
<td align="center">N</td>
<td align="center">NN</td>
<td align="center">\xi</td>
<td align="center">ξξ</td>
<td align="center">\Xi</td>
<td align="center">ΞΞ</td>
</tr>
<tr>
<td align="center">o</td>
<td align="center">oo</td>
<td align="center">O</td>
<td align="center">OO</td>
<td align="center">\pi</td>
<td align="center">ππ</td>
<td align="center">\Pi</td>
<td align="center">ΠΠ</td>
</tr>
<tr>
<td align="center">\rho</td>
<td align="center">ρρ</td>
<td align="center">P</td>
<td align="center">PP</td>
<td align="center">\sigma</td>
<td align="center">σσ</td>
<td align="center">\Sigma</td>
<td align="center">ΣΣ</td>
</tr>
<tr>
<td align="center">\tau</td>
<td align="center">ττ</td>
<td align="center">T</td>
<td align="center">TT</td>
<td align="center">\upsilon</td>
<td align="center">υυ</td>
<td align="center">\Upsilon</td>
<td align="center">ΥΥ</td>
</tr>
<tr>
<td align="center">\phi</td>
<td align="center">ϕϕ</td>
<td align="center">\Phi</td>
<td align="center">ΦΦ</td>
<td align="center">\chi</td>
<td align="center">χχ</td>
<td align="center">X</td>
<td align="center">XX</td>
</tr>
<tr>
<td align="center">\psi</td>
<td align="center">ψψ</td>
<td align="center">\Psi</td>
<td align="center">ΨΨ</td>
<td align="center">\omega</td>
<td align="center">ωω</td>
<td align="center">\Omega</td>
<td align="center">ΩΩ</td>
</tr>
</tbody></table>
<p>部分字母有变量专用形式，以 <code>\var-</code> 开头。</p>
<table>
<thead>
<tr>
<th align="center">小写形式</th>
<th align="center">大写形式</th>
<th align="center">变量形式</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\epsilon</td>
<td align="center">E</td>
<td align="center">\varepsilon</td>
<td align="center">ϵ∣E∣εϵ∣E∣ε</td>
</tr>
<tr>
<td align="center">\theta</td>
<td align="center">\Theta</td>
<td align="center">\vartheta</td>
<td align="center">θ∣Θ∣ϑθ∣Θ∣ϑ</td>
</tr>
<tr>
<td align="center">\rho</td>
<td align="center">P</td>
<td align="center">\varrho</td>
<td align="center">ρ∣P∣ϱρ∣P∣ϱ</td>
</tr>
<tr>
<td align="center">\sigma</td>
<td align="center">\Sigma</td>
<td align="center">\varsigma</td>
<td align="center">σ∣Σ∣ςσ∣Σ∣ς</td>
</tr>
<tr>
<td align="center">\phi</td>
<td align="center">\Phi</td>
<td align="center">\varphi</td>
<td align="center">ϕ∣Φ∣φϕ∣Φ∣φ</td>
</tr>
</tbody></table>
<h3 id="如何输入其它特殊字符"><a href="#如何输入其它特殊字符" class="headerlink" title="如何输入其它特殊字符"></a>如何输入其它特殊字符</h3><p>若需要显示更大或更小的字符，在符号前插入 <code>\large</code> 或 <code>\small</code> 命令。若找不到需要的符号，使用 <a target="_blank" rel="noopener" href="http://detexify.kirelabs.org/classify.html">Detexify2Detexify2</a> 来画出想要的符号。</p>
<h4 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\pm</td>
<td align="center">±±</td>
<td align="center">\times</td>
<td align="center">××</td>
<td align="center">\div</td>
<td align="center">÷÷</td>
<td align="center">\mid</td>
<td align="center">∣∣</td>
</tr>
<tr>
<td align="center">\nmid</td>
<td align="center">∤∤</td>
<td align="center">\cdot</td>
<td align="center">⋅⋅</td>
<td align="center">\circ</td>
<td align="center">∘∘</td>
<td align="center">\ast</td>
<td align="center">∗∗</td>
</tr>
<tr>
<td align="center">\bigodot</td>
<td align="center">⨀⨀</td>
<td align="center">\bigotimes</td>
<td align="center">⨂⨂</td>
<td align="center">\bigoplus</td>
<td align="center">⨁⨁</td>
<td align="center">\leq</td>
<td align="center">≤≤</td>
</tr>
<tr>
<td align="center">\geq</td>
<td align="center">≥≥</td>
<td align="center">\neq</td>
<td align="center">≠≠</td>
<td align="center">\approx</td>
<td align="center">≈≈</td>
<td align="center">\equiv</td>
<td align="center">≡≡</td>
</tr>
<tr>
<td align="center">\sum</td>
<td align="center">∑∑</td>
<td align="center">\prod</td>
<td align="center">∏∏</td>
<td align="center">\coprod</td>
<td align="center">∐∐</td>
<td align="center">\backslash</td>
<td align="center">∖∖</td>
</tr>
</tbody></table>
<h4 id="集合运算符"><a href="#集合运算符" class="headerlink" title="集合运算符"></a>集合运算符</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\emptyset</td>
<td align="center">∅∅</td>
<td align="center">\in</td>
<td align="center">∈∈</td>
<td align="center">\notin</td>
<td align="center">∉∉</td>
</tr>
<tr>
<td align="center">\subset</td>
<td align="center">⊂⊂</td>
<td align="center">\supset</td>
<td align="center">⊃⊃</td>
<td align="center">\subseteq</td>
<td align="center">⊆⊆</td>
</tr>
<tr>
<td align="center">\supseteq</td>
<td align="center">⊇⊇</td>
<td align="center">\bigcap</td>
<td align="center">⋂⋂</td>
<td align="center">\bigcup</td>
<td align="center">⋃⋃</td>
</tr>
<tr>
<td align="center">\bigvee</td>
<td align="center">⋁⋁</td>
<td align="center">\bigwedge</td>
<td align="center">⋀⋀</td>
<td align="center">\biguplus</td>
<td align="center">⨄⨄</td>
</tr>
</tbody></table>
<h4 id="对数运算符"><a href="#对数运算符" class="headerlink" title="对数运算符"></a>对数运算符</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\log</td>
<td align="center">loglog</td>
<td align="center">\lg</td>
<td align="center">lglg</td>
<td align="center">\ln</td>
<td align="center">lnln</td>
</tr>
</tbody></table>
<h4 id="三角运算符"><a href="#三角运算符" class="headerlink" title="三角运算符"></a>三角运算符</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">30^\circ</td>
<td align="center">30∘30∘</td>
<td align="center">\bot</td>
<td align="center">⊥⊥</td>
<td align="center">\angle A</td>
<td align="center">∠A∠A</td>
</tr>
<tr>
<td align="center">\sin</td>
<td align="center">sinsin</td>
<td align="center">\cos</td>
<td align="center">coscos</td>
<td align="center">\tan</td>
<td align="center">tantan</td>
</tr>
<tr>
<td align="center">\csc</td>
<td align="center">csccsc</td>
<td align="center">\sec</td>
<td align="center">secsec</td>
<td align="center">\cot</td>
<td align="center">cotcot</td>
</tr>
</tbody></table>
<h4 id="微积分运算符"><a href="#微积分运算符" class="headerlink" title="微积分运算符"></a>微积分运算符</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\int</td>
<td align="center">∫∫</td>
<td align="center">\iint</td>
<td align="center">∬∬</td>
<td align="center">\iiint</td>
<td align="center">∭∭</td>
</tr>
<tr>
<td align="center">\iiiint</td>
<td align="center">∬∬⨌</td>
<td align="center">\oint</td>
<td align="center">∮∮</td>
<td align="center">\prime</td>
<td align="center">′′</td>
</tr>
<tr>
<td align="center">\lim</td>
<td align="center">limlim</td>
<td align="center">\infty</td>
<td align="center">∞∞</td>
<td align="center">\nabla</td>
<td align="center">∇∇</td>
</tr>
</tbody></table>
<h4 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\because</td>
<td align="center">∵∵</td>
<td align="center">\therefore</td>
<td align="center">∴∴</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">\forall</td>
<td align="center">∀∀</td>
<td align="center">\exists</td>
<td align="center">∃∃</td>
<td align="center">\not\subset</td>
<td align="center">⊄⊄</td>
</tr>
<tr>
<td align="center">\not&lt;</td>
<td align="center">≮≮</td>
<td align="center">\not&gt;</td>
<td align="center">≯≯</td>
<td align="center">\not&#x3D;</td>
<td align="center">≠≠</td>
</tr>
</tbody></table>
<h4 id="戴帽符号"><a href="#戴帽符号" class="headerlink" title="戴帽符号"></a>戴帽符号</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\hat{xy}</td>
<td align="center">xy^xy^</td>
<td align="center">\widehat{xyz}</td>
<td align="center">xyzˆxyz^</td>
</tr>
<tr>
<td align="center">\tilde{xy}</td>
<td align="center">xy<del>xy</del></td>
<td align="center">\widetilde{xyz}</td>
<td align="center">xyz˜xyz~</td>
</tr>
<tr>
<td align="center">\check{x}</td>
<td align="center">xˇxˇ</td>
<td align="center">\breve{y}</td>
<td align="center">y˘y˘</td>
</tr>
<tr>
<td align="center">\grave{x}</td>
<td align="center">x<code>x</code></td>
<td align="center">\acute{y}</td>
<td align="center">y´y´</td>
</tr>
</tbody></table>
<h4 id="连线符号"><a href="#连线符号" class="headerlink" title="连线符号"></a>连线符号</h4><table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\fbox{a+b+c+d}</td>
<td align="center">a+b+c+da+b+c+d</td>
</tr>
<tr>
<td align="center">\overleftarrow{a+b+c+d}</td>
<td align="center">a+b+c+d←−−−a+b+c+d←</td>
</tr>
<tr>
<td align="center">\overrightarrow{a+b+c+d}</td>
<td align="center">a+b+c+d−→−−a+b+c+d→</td>
</tr>
<tr>
<td align="center">\overleftrightarrow{a+b+c+d}</td>
<td align="center">a+b+c+d←→−a+b+c+d↔</td>
</tr>
<tr>
<td align="center">\underleftarrow{a+b+c+d}</td>
<td align="center">a+b+c+d←−−−a+b+c+d←</td>
</tr>
<tr>
<td align="center">\underrightarrow{a+b+c+d}</td>
<td align="center">a+b+c+d−→−−a+b+c+d→</td>
</tr>
<tr>
<td align="center">\underleftrightarrow{a+b+c+d}</td>
<td align="center">a+b+c+d←→−a+b+c+d↔</td>
</tr>
<tr>
<td align="center">\overline{a+b+c+d}</td>
<td align="center">a+b+c+d¯¯¯¯¯¯¯¯¯¯¯a+b+c+d¯</td>
</tr>
<tr>
<td align="center">\underline{a+b+c+d}</td>
<td align="center">a+b+c+d–––––a+b+c+d_</td>
</tr>
<tr>
<td align="center">\overbrace{a+b+c+d}^{Sample}</td>
<td align="center">a+b+c+dSamplea+b+c+d⏞Sample</td>
</tr>
<tr>
<td align="center">\underbrace{a+b+c+d}_{Sample}</td>
<td align="center">a+b+c+dSamplea+b+c+d⏟Sample</td>
</tr>
<tr>
<td align="center">\overbrace{a+\underbrace{b+c}_{1.0}+d}^{2.0}</td>
<td align="center">a+b+c1.0+d2.0a+b+c⏟1.0+d⏞2.0</td>
</tr>
<tr>
<td align="center">\underbrace{a\cdot a\cdots a}_{b\text{ times}}</td>
<td align="center">a⋅a⋯ab timesa⋅a⋯a⏟b times</td>
</tr>
</tbody></table>
<h4 id="箭头符号"><a href="#箭头符号" class="headerlink" title="箭头符号"></a>箭头符号</h4><ul>
<li>推荐使用符号：<br>|输入|显示|输入|显示|输入|显示|<br>|:–😐:–😐:–😐:–😐:–😐:–😐<br>|\to|$ \to|↦||↦| \mapsto||||⟹|||||⟹| \implies|⟺||⟺| \iff|⟸||⟸| \impliedby$|</li>
<li>其它可用符号：<br>|输入|显示|输入|显示|<br>|:–😐:–😐:–😐:–😐<br>|\uparrow|$ \uparrow|⇑||⇑| \Uparrow||↓|||↓| \downarrow|⇓||⇓| \Downarrow||←|||←| \leftarrow|⇐||⇐| \Leftarrow||→|||→| \rightarrow|⇒||⇒| \Rightarrow||↔|||↔| \leftrightarrow|⇔||⇔| \Leftrightarrow||⟵|||⟵| \longleftarrow|⟸||⟸| \Longleftarrow||⟶|||⟶| \longrightarrow|⟹||⟹| \Longrightarrow||⟷|||⟷| \longleftrightarrow|⟺||⟺| \Longleftrightarrow$|</li>
</ul>
<h3 id="如何进行字体转换"><a href="#如何进行字体转换" class="headerlink" title="如何进行字体转换"></a>如何进行字体转换</h3><p>若要对公式的某一部分字符进行字体转换，可以用 <code>&#123;\字体 &#123;需转换的部分字符&#125;&#125;</code> 命令，其中 <code>\字体</code> 部分可以参照下表选择合适的字体。一般情况下，公式默认为意大利体 italicitalic 。示例中 全部大写 的字体仅大写可用。</p>
<table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">说明</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">说明</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\rm</td>
<td align="center">罗马体</td>
<td align="center">SampleSample</td>
<td align="center">\cal</td>
<td align="center">花体</td>
<td align="center">SAMPLESAMPLE</td>
</tr>
<tr>
<td align="center">\it</td>
<td align="center">意大利体</td>
<td align="center">SampleSample</td>
<td align="center">\Bbb</td>
<td align="center">黑板粗体</td>
<td align="center">SAMPLESAMPLE</td>
</tr>
<tr>
<td align="center">\bf</td>
<td align="center">粗体</td>
<td align="center">SampleSample</td>
<td align="center">\mit</td>
<td align="center">数学斜体</td>
<td align="center">SAMPLESAMPLE</td>
</tr>
<tr>
<td align="center">\sf</td>
<td align="center">等线体</td>
<td align="center">SampleSample</td>
<td align="center">\scr</td>
<td align="center">手写体</td>
<td align="center">SAMPLESAMPLE</td>
</tr>
<tr>
<td align="center">\tt</td>
<td align="center">打字机体</td>
<td align="center">SampleSample</td>
<td align="center">\frak</td>
<td align="center">旧德式字体</td>
<td align="center">SampleSample</td>
</tr>
</tbody></table>
<p>转换字体十分常用，例如在积分中：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\<span class="keyword">begin</span>&#123;array&#125;&#123;cc&#125;</span><br><span class="line">\<span class="keyword">mathrm</span>&#123;Bad&#125; <span class="operator">&amp;</span> \<span class="keyword">mathrm</span>&#123;Better&#125; \\</span><br><span class="line">\hline \\</span><br><span class="line">\int_0<span class="operator">^</span><span class="number">1</span> x<span class="operator">^</span><span class="number">2</span> dx <span class="operator">&amp;</span> \int_0<span class="operator">^</span><span class="number">1</span> x<span class="operator">^</span><span class="number">2</span> \,&#123;\rm d&#125;x</span><br><span class="line">\<span class="keyword">end</span>&#123;array&#125;</span><br></pre></td></tr></table></figure>

<p>显示：\begin{array}{cc}<br>\mathrm{Bad} &amp; \mathrm{Better} \<br>\hline \<br>\int_0^1 x^2 dx &amp; \int_0^1 x^2 ,{\rm d}x<br>\end{array}\begin{array}{cc} \mathrm{Bad} &amp; \mathrm{Better} \ \hline \ \int_0^1 x^2 dx &amp; \int_0^1 x^2 ,{\rm d}x \end{array},注意比较两个式子间 dxdx 与 dxdx 的不同。</p>
<h3 id="如何使用大括号和行标"><a href="#如何使用大括号和行标" class="headerlink" title="如何使用大括号和行标"></a>如何使用大括号和行标</h3><p>使用 <code>\left</code> 和 <code>\right</code> 来创建自动匹配高度的 (圆括号)，[方括号] 和 {花括号} ，在每个公式末尾前使用 <code>\tag&#123;行标&#125;</code> 来实现行标。</p>
<ul>
<li>例如：</li>
</ul>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">$</span><span class="operator">$</span></span><br><span class="line">f\left(</span><br><span class="line">   \left[ </span><br><span class="line">     \<span class="keyword">frac</span>&#123;</span><br><span class="line">       <span class="number">1</span><span class="operator">+</span>\left\&#123;x,y\right\&#125;</span><br><span class="line">     &#125;&#123;</span><br><span class="line">       \left(</span><br><span class="line">          \<span class="keyword">frac</span>&#123;x&#125;&#123;y&#125;<span class="operator">+</span>\<span class="keyword">frac</span>&#123;y&#125;&#123;x&#125;</span><br><span class="line">       \right)</span><br><span class="line">       \left(u<span class="operator">+</span><span class="number">1</span>\right)</span><br><span class="line">     &#125;<span class="operator">+</span>a</span><br><span class="line">   \right]<span class="operator">^</span>&#123;<span class="number">3</span><span class="operator">/</span><span class="number">2</span>&#125;</span><br><span class="line">\right)</span><br><span class="line">\<span class="keyword">tag</span>&#123;行标&#125;</span><br><span class="line"><span class="operator">$</span><span class="operator">$</span></span><br></pre></td></tr></table></figure>

<ul>
<li>显示：</li>
</ul>
<p>f⎛⎝⎜⎜⎡⎣⎢1+{x,y}(xy+yx)(u+1)+a⎤⎦⎥3&#x2F;2⎞⎠⎟⎟(行标)(行标)f([1+{x,y}(xy+yx)(u+1)+a]3&#x2F;2)</p>
<p>如果你需要在不同的行显示对应括号，可以在每一行对应处使用 <code>\left.</code> 或 <code>\right.</code> 来放一个”影子”括号：</p>
<ul>
<li>例如：</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$$</span></span><br><span class="line">\<span class="keyword">begin</span>&#123;aligned&#125;</span><br><span class="line">a=&amp;\left(<span class="number">1</span>+<span class="number">2</span>+<span class="number">3</span>+  \cdots \right. \\</span><br><span class="line">&amp; \cdots+ \left. \infty-<span class="number">2</span>+\infty-<span class="number">1</span>+\infty\right)</span><br><span class="line">\<span class="keyword">end</span>&#123;aligned&#125;</span><br><span class="line"><span class="variable">$$</span></span><br></pre></td></tr></table></figure>

<ul>
<li>显示：</li>
</ul>
<p>a&#x3D;(1+2+3+⋯⋯+∞−2+∞−1+∞)a&#x3D;(1+2+3+⋯⋯+∞−2+∞−1+∞)</p>
<p>如果你需要将行内显示的分隔符也变大，可以使用 <code>\middle</code> 命令：</p>
<ul>
<li>例如：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span><span class="variable">$</span></span><br><span class="line">\left\langle  </span><br><span class="line">  q</span><br><span class="line">\middle\|</span><br><span class="line">  \frac&#123;\frac&#123;x&#125;&#123;y&#125;&#125;&#123;\frac&#123;u&#125;&#123;v&#125;&#125;</span><br><span class="line">\middle| </span><br><span class="line">   p </span><br><span class="line">\right\rangle</span><br><span class="line"><span class="variable">$</span><span class="variable">$</span></span><br></pre></td></tr></table></figure>

<ul>
<li>显示：</li>
</ul>
<p>⟨q∥∥∥xyuv∣∣∣p⟩⟨q‖xyuv|p⟩</p>
<h3 id="其它公式"><a href="#其它公式" class="headerlink" title="其它公式"></a>其它公式</h3><h4 id="定义新的符号-operatorname"><a href="#定义新的符号-operatorname" class="headerlink" title="定义新的符号\operatorname"></a>定义新的符号<code>\operatorname</code></h4><p>如：<code>$$ \operatorname&#123;Symbol&#125; A $$</code>，显示： SymbolASymbol⁡A</p>
<h4 id="添加注释文字-text"><a href="#添加注释文字-text" class="headerlink" title="添加注释文字 \text"></a>添加注释文字 <code>\text</code></h4><p>在 <code>\text &#123;文字&#125;</code> 中仍可以使用 <code>$公式$</code> 插入其它公式。</p>
<p>如：<code>$$ f(n)= \begin&#123;cases&#125; n/2, &amp; \text &#123;if $n$ is even&#125; \\ 3n+1, &amp; \text&#123;if $n$ is odd&#125; \end&#123;cases&#125; $$</code></p>
<p>显示：$ f(n)&#x3D; \begin{cases} n&#x2F;2, &amp; \text {if nn is even} \ 3n+1, &amp; \text{if nn is odd} \end{cases} $</p>
<h4 id="在字符间加入空格"><a href="#在字符间加入空格" class="headerlink" title="在字符间加入空格"></a>在字符间加入空格</h4><p>有四种宽度的空格可以使用： <code>\,</code>、<code>\;</code>、<code>\quad</code> 和 <code>\qquad</code> 。</p>
<p>如：<code>$$ a \, b \mid a \; b \mid a \quad b \mid a \qquad b $$</code>,显示：a,b∣a;b∣ab∣aba,b∣a;b∣ab∣ab</p>
<p>当然，使用 <code>\text &#123;n个空格&#125;</code> 也可以达到同样效果。</p>
<h4 id="更改文字颜色"><a href="#更改文字颜色" class="headerlink" title="更改文字颜色"></a>更改文字颜色</h4><p>使用 <code>\color&#123;颜色&#125;&#123;文字&#125;</code> 来更改特定的文字颜色,更改文字颜色 需要浏览器支持，如果浏览器不知道你所需的颜色，那么文字将被渲染为黑色。对于较旧的浏览器（HTML4与CSS2），以下颜色是被支持的：</p>
<table>
<thead>
<tr>
<th align="center">输入</th>
<th align="center">显示</th>
<th align="center">输入</th>
<th align="center">显示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">black</td>
<td align="center">texttext</td>
<td align="center">grey</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">silver</td>
<td align="center">texttext</td>
<td align="center">white</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">maroon</td>
<td align="center">texttext</td>
<td align="center">red</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">yellow</td>
<td align="center">texttext</td>
<td align="center">lime</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">olive</td>
<td align="center">texttext</td>
<td align="center">green</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">teal</td>
<td align="center">texttext</td>
<td align="center">auqa</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">blue</td>
<td align="center">texttext</td>
<td align="center">navy</td>
<td align="center">texttext</td>
</tr>
<tr>
<td align="center">purple</td>
<td align="center">texttext</td>
<td align="center">fuchsia</td>
<td align="center">texttext</td>
</tr>
</tbody></table>
<p>对于较新的浏览器（HTML5与CSS3），额外的124种颜色将被支持：输入 &#96;\color </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2020/03/08/8.2%20alinode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/03/08/8.2%20alinode/" class="post-title-link" itemprop="url">Node in Debugging - 8.2 Alinode</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-03-08 00:12:31" itemprop="dateCreated datePublished" datetime="2020-03-08T00:12:31-07:00">2020-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2020/03/08/8.2%20alinode/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 8.2 Alinode" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<h2 id="8-2-1-什么是-alinode？"><a href="#8-2-1-什么是-alinode？" class="headerlink" title="8.2.1 什么是 alinode？"></a>8.2.1 什么是 alinode？</h2><blockquote>
<p>Node.js 性能平台（原 alinode）是面向中大型 Node.js 应用提供性能监控、安全提醒、故障排查、性能优化等服务的整体性解决方案。alinode 团队凭借对 Node.js 内核的深入理解，提供了完善的工具链和服务，协助客户主动、快速地发现和定位线上问题。</p>
</blockquote>
<h2 id="8-2-2-创建-alinode-应用"><a href="#8-2-2-创建-alinode-应用" class="headerlink" title="8.2.2 创建 alinode 应用"></a>8.2.2 创建 alinode 应用</h2><p>访问官网 <a target="_blank" rel="noopener" href="https://www.aliyun.com/product/nodejs">https://www.aliyun.com/product/nodejs</a>，如未开通，则使用阿里云账号登录并免费开通即可。</p>
<p>登录后进入<a target="_blank" rel="noopener" href="https://node.console.aliyun.com/">控制台</a>，单击 “创建新应用”，创建一个名为 test_alinode 的应用。</p>
<p>进入设置页面，如下所示：</p>
<p><img src="/./assets/8.2.1.png"></p>
<p>App ID 和 App Secret 后面会用到。</p>
<h2 id="8-2-3-安装-alinode"><a href="#8-2-3-安装-alinode" class="headerlink" title="8.2.3 安装 alinode"></a>8.2.3 安装 alinode</h2><p>alinode 的整套服务由 alinode 运行时、agenthub（原 agentx + commdx 命令集）和服务平台组成，所以在自己的服务器上部署时需要安装 alinode 运行时和 agenthub。</p>
<p>我们使用交互式一键安装 alinode 和 agenthub：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">uname</span> -a <span class="comment"># 阿里云 ECS Ubuntu@16.04</span></span><br><span class="line">Linux nswbmw 4.4.0-105-generic <span class="comment">#128-Ubuntu SMP Thu Dec 14 12:42:11 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">$ wget https://raw.githubusercontent.com/aliyun-node/alinode-all-in-one/master/alinode_all.sh</span><br><span class="line">$ bash -i alinode_all.sh <span class="comment"># App ID 和 App Secret 填写上面生成的</span></span><br><span class="line">...</span><br><span class="line">$ node -p <span class="string">&#x27;process.alinode&#x27;</span> <span class="comment"># 查看 alinode 版本</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：如果遇到 wget 报错 <code>wget: unable to resolve host address &#39;raw.githubusercontent.com&#39;</code>，需要修改 DNS 配置，在 &#x2F;etc&#x2F;resolv.conf 最上面添加 <code>nameserver 8.8.8.8</code>。</p>
<p>生成一个 yourconfig.json 配置文件，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;agentserver.node.aliyun.com:8080&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;appid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;secret&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;logdir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reconnectDelay&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;heartbeatInterval&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reportInterval&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error_log&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;packages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用该配置启动 agenthub：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">nohup</span> agenthub yourconfig.json &amp;</span><br></pre></td></tr></table></figure>

<p>agenthub 将以常驻进程的方式运行。</p>
<p>下面通过两个例子使用 alinode 分别调试内存泄露和 CPU 性能瓶颈的问题。</p>
<h2 id="8-2-4-使用-alinode-诊断内存泄露"><a href="#8-2-4-使用-alinode-诊断内存泄露" class="headerlink" title="8.2.4 使用 alinode 诊断内存泄露"></a>8.2.4 使用 alinode 诊断内存泄露</h2><p>我们以一段内存泄露代码为例，演示如何使用 alinode 调试内存泄漏的问题。代码如下：</p>
<p><strong>server.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;koa-generic-session&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="property">keys</span> = [<span class="string">&#x27;some secret&#x27;</span>]</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1e6</span>).<span class="title function_">join</span>(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">session</span>.<span class="property">user</span> = <span class="keyword">new</span> <span class="title class_">User</span>()</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>这段代码内存泄露的原因是：koa-generic-session 默认将 session 信息存储到了内存中。</p>
<p><strong>client.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p>打开两个终端，分别运行 ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ENABLE_NODE_LOG=YES node server <span class="comment"># 开启 alinode 的 log 功能，使得 agenthub 可以监控内核级的性能数据</span></span><br><span class="line">$ node client <span class="comment"># 1s 发起一次请求</span></span><br></pre></td></tr></table></figure>

<p>过一会儿就可以在 alinode 控制台看到数据了，如下所示：</p>
<p><img src="/./assets/8.2.2.png"></p>
<p>可以看出，alinode 监控了：</p>
<ul>
<li>异常日志</li>
<li>慢 HTTP 日志</li>
<li>模块依赖</li>
<li>系统监控数据（包含非常详尽的图表数据，有 Memory、CPU、Load、QPS、GC、Apdex、Apdex detail、node 进程数、磁盘）</li>
</ul>
<p>单击 “堆快照” 生成一个 heapsnapshot 文件，单击左侧的 “文件”，查看刚才生成的堆快照：</p>
<p><img src="/./assets/8.2.3.png"></p>
<p>在转储后单击 “分析”，选择 “对象簇视图” 的树状列表，展开后如下所示：</p>
<p><img src="/./assets/8.2.4.png"></p>
<p><strong>可以看出</strong>：MemoryStore 的 sessions 对象中存储了 97 个 session，并且每个 session.user 上有一个 name 字段是长字符串。</p>
<h2 id="8-2-5-使用-alinode-诊断-CPU-性能瓶颈"><a href="#8-2-5-使用-alinode-诊断-CPU-性能瓶颈" class="headerlink" title="8.2.5 使用 alinode 诊断 CPU 性能瓶颈"></a>8.2.5 使用 alinode 诊断 CPU 性能瓶颈</h2><p>测试代码如下：</p>
<p><strong>server.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/encrypt&#x27;</span>, <span class="attr">controller</span>: <span class="keyword">function</span> <span class="title function_">encryptRouter</span> (ctx) &#123;</span><br><span class="line">  <span class="keyword">const</span> password = ctx.<span class="property">query</span>.<span class="property">password</span> || <span class="string">&#x27;test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> salt = crypto.<span class="title function_">randomBytes</span>(<span class="number">128</span>).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> encryptedPassword = crypto.<span class="title function_">pbkdf2Sync</span>(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">&#x27;sha512&#x27;</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  ctx.<span class="property">body</span> = encryptedPassword</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>client.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> tps = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tps; i++) &#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000/encrypt?password=123456&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Sent <span class="subst">$&#123;tps&#125;</span> requests`</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p>打开两个终端，分别运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ENABLE_NODE_LOG=YES node server</span><br><span class="line">$ node client</span><br></pre></td></tr></table></figure>

<p>回到 alinode 控制台，单击 “CPU Profile”，然后到 “文件” 查看刚才生成的 cpuprofile 文件，转储后单击 “分析”，可以看到生成的火焰图。展开后如下所示：</p>
<p><img src="/./assets/8.2.5.png"></p>
<p><strong>可以看出</strong>：server.js 的第 5 行，即 encryptRouter 占用 CPU 较多，而 encryptRouter 里的 exports.pbkdf2Sync 占用了 encryptRouter 绝大部分 CPU 时间。</p>
<p>回到 “文件”，选择 “devtools 分析”，如下所示：</p>
<p><img src="/./assets/8.2.6.png"></p>
<p><strong>可以看出</strong>：alinode 已经帮我们把可疑的 CPU 性能瓶颈的元凶标红显示了。</p>
<p><strong>小提示</strong>：不管是生成的 heapsnapshot 还是 cpuprofile，都可以选择 “下载” 后使用 Chrome DevTools 分析。</p>
<p>我们在上面只演示了 “堆快照” 和 “CPU Profile” 的使用，alinode 支持抓取以下 5 种数据：</p>
<ul>
<li>堆快照</li>
<li>堆时间线</li>
<li>CPU Profile</li>
<li>GC Trace</li>
<li>Heap Profile</li>
</ul>
<p>本节就不一一演示了。</p>
<p>alinode 如此强大，而且免费使用，可以说是开发 Node.js 应用必不可少的好伙伴了。</p>
<h2 id="8-2-6-参考链接"><a href="#8-2-6-参考链接" class="headerlink" title="8.2.6 参考链接"></a>8.2.6 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/nodejs">https://www.aliyun.com/product/nodejs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aliyun-node/agenthub">https://github.com/aliyun-node/agenthub</a></li>
<li><a target="_blank" rel="noopener" href="https://cnodejs.org/topic/561f289b4928c5872abc18ee">https://cnodejs.org/topic/561f289b4928c5872abc18ee</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/8.1%20node-clinic.md">8.1 node-clinic</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2020/02/01/8.1%20node-clinic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/01/8.1%20node-clinic/" class="post-title-link" itemprop="url">Node in Debugging - 8.1 Node-clinic</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-02-01 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-01T00:00:00-07:00">2020-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2020/02/01/8.1%20node-clinic/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 8.1 Node-clinic" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<h2 id="8-1-1-使用-node-clinic"><a href="#8-1-1-使用-node-clinic" class="headerlink" title="8.1.1 使用 node-clinic"></a>8.1.1 使用 node-clinic</h2><p><a target="_blank" rel="noopener" href="https://github.com/nearform/node-clinic">node-clinic</a>（简称 clinic） 是一个开箱即用的 Node.js 应用诊断工具。</p>
<p>首先，安装 Node.js@9+</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nvm install 9</span><br></pre></td></tr></table></figure>

<p>全局安装 clinic：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i clinic -g</span><br></pre></td></tr></table></figure>

<p>创建测试代码：</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sleep</span> (ms) &#123;</span><br><span class="line">  <span class="keyword">const</span> future = <span class="title class_">Date</span>.<span class="title function_">now</span>() + ms</span><br><span class="line">  <span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() &lt; future);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">sleep</span>(<span class="number">50</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>使用 clinic doctor 启动并诊断 Node.js 应用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clinic doctor -- node app.js</span><br></pre></td></tr></table></figure>

<p>使用 ab 压测：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -c 10 -n 200 <span class="string">&quot;http://localhost:3000/&quot;</span></span><br></pre></td></tr></table></figure>

<p>CTRL+C 终止测试程序，终端打印出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: Trace event is an experimental feature and could change at any time.</span><br><span class="line">^Canalysing data</span><br><span class="line">generated HTML file is 51485.clinic-doctor.html</span><br></pre></td></tr></table></figure>

<p>用浏览器打开 51485.clinic-doctor.html，如下所示：</p>
<p><img src="/./assets/8.1.1.png"></p>
<p><strong>可以看出</strong>：Event Loop 被阻塞，CPU Usage 也居高不下，一定是有 CPU 密集计算，与我们的测试代码吻合。</p>
<p>clinic 也给出了猜测和解决方案，我们尝试使用 clinic flame 生成火焰图：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clinic flame -- node app.js</span><br></pre></td></tr></table></figure>

<p>也可以用以下命令代替：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ clinic flame --collect-only -- node app.js <span class="comment"># 只收集数据</span></span><br><span class="line">$ clinic flame --visualize-only PID.flamegraph <span class="comment"># 将数据生成火焰图</span></span><br></pre></td></tr></table></figure>

<p>使用同样的 ab 命令压测后，生成的火焰图如下：</p>
<p><img src="/./assets/8.1.2.png"></p>
<p><strong>可以看出</strong>：app.js 第 4 行的 sleep 函数占用了大量的 CPU 计算。</p>
<h2 id="8-1-2-参考链接"><a href="#8-1-2-参考链接" class="headerlink" title="8.1.2 参考链接"></a>8.1.2 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.nearform.com/blog/introducing-node-clinic-a-performance-toolkit-for-node-js-developers/">https://www.nearform.com/blog/introducing-node-clinic-a-performance-toolkit-for-node-js-developers/</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/7.2%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8B).md">7.2 Telegraf + InfluxDB + Grafana(下)</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/8.2%20alinode.md">8.2 alinode</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/11/28/7.2%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8B)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/11/28/7.2%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8B)/" class="post-title-link" itemprop="url">Node in Debugging - 7.2 Telegraf + InfluxDB + Grafana(2)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-11-28 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-28T00:00:00-07:00">2019-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/11/28/7.2%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8B)/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 7.2 Telegraf + InfluxDB + Grafana(2)" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>上一小节主要讲解了 Telegraf(StatsD) + InfluxDB + Grafana 的搭建和基本用法，并创建了请求量和响应时间这两种图表。本节讲解几个高级用法：</p>
<ol>
<li>如何将 Grafana（监控）跟 ELK（日志）结合起来。</li>
<li>Grafana 监控报警。</li>
<li>脚本一键生成图表。</li>
</ol>
<h2 id="7-2-1-Grafana-ELK"><a href="#7-2-1-Grafana-ELK" class="headerlink" title="7.2.1 Grafana + ELK"></a>7.2.1 Grafana + ELK</h2><p>在观察 Grafana 监控时，我们发现某个 api 接口的响应时间突然有一个尖刺，这个时候想查一查到底是什么原因导致的。在前面介绍过 koa-await-breakpoint + ELK 的用法，是否可以结合 Grafana 使用呢？答案是可以的。</p>
<p>因为涉及的代码量大，所以笔者写了一个 demo 托管到了 GitHub 上，有两个 repo，分别为：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nswbmw/grafana-to-elk">grafana-to-elk</a>：包含 web server 和模拟请求的 client，分别将统计信息发送到 StatsD 和将日志发送到 ELK。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/nswbmw/grafana-to-elk-extension">grafana-to-elk-extension</a>：Chrome 扩展，作用是：<ul>
<li>格式化从 Grafana 跳转到 ELK 的时间范围。</li>
<li>添加 requestId 的链接。</li>
<li>高亮显示重要的字段。</li>
</ul>
</li>
</ul>
<p>首先 clone 到本地：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/nswbmw/grafana-to-elk.git</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/nswbmw/grafana-to-elk-extension.git</span><br></pre></td></tr></table></figure>

<p>测试步骤如下：</p>
<ol>
<li><p>按照 7.2 节启动 Telegraf（StatsD）+ InfluxDB + Grafana。</p>
</li>
<li><p>按照 6.3 节启动 ELK。</p>
</li>
<li><p>到 grafana-to-elk 目录下运行：</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i</span><br><span class="line">$ node server</span><br></pre></td></tr></table></figure>
<p>  打开另外一个终端运行：</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node client</span><br></pre></td></tr></table></figure>
<p>  此时，ELK 应该有日志了。</p>
</li>
<li><p>加载 Chrome 扩展。打开 Chrome 扩展程序页 -&gt; 加载已解压的扩展程序… -&gt; 加载 grafana-to-elk-extension（非测试环境下需要修改 manifest.json 的 matches 字段）。</p>
</li>
<li><p>回到 Grafana 的 “getHome 响应时间” 图表，进入编辑页的 General tab，如下填写：<br>  <img src="/./assets/7.2.1.png"><br>  在保存后，图表的左上角会出现一个类似分享的按钮，鼠标悬浮到上面出现 “Go to ELK”，单击它跳转到 ELK。</p>
</li>
<li><p>ELK 显示如下：<br>  <img src="/./assets/7.2.2.png">grafana-to-elk-extension 插件会自动处理并跳转到对应 Grafana 中的时间段并且查询出了我们关心的结果。单击第 1 个 requestId，将会跳转并显示该请求所有的日志，如下所示：<br>  <img src="/./assets/7.2.3.png"><br>  错误请求的日志如下：<br>  <img src="/./assets/7.2.4.png"></p>
</li>
</ol>
<h2 id="7-2-2-监控报警"><a href="#7-2-2-监控报警" class="headerlink" title="7.2.2 监控报警"></a>7.2.2 监控报警</h2><p>Grafana 有内置的监控报警，设置步骤如下：</p>
<ol>
<li>进入 Alerting -&gt; Notifications 页，单击 New Notification 添加新的报警组，如下所示：<br>  <img src="/./assets/7.2.5.png"></li>
<li>回到 “getHome 响应时间” 图表，进入编辑页的 Alert tab，单击 Create Alert 创建报警规则，如下所示：<br>  <img src="/./assets/7.2.6.png"><br>  <strong>报警规则为</strong>：每 60s 检查一次过去 1min 的 mean（B 在 Metrics 里面代表了别名为 mean 的折线图）折线图的平均值是否大于 50，如果是则触发报警。<br>  <strong>注意</strong>：如需发邮件，则需要设置 Grafana 的 <a target="_blank" rel="noopener" href="http://docs.grafana.org/installation/configuration/#smtp">SMTP settings</a>。</li>
</ol>
<p>我们还可以给 “getHome 请求量” 设置错误报警监控，如下所示：</p>
<p><img src="/./assets/7.2.7.png"></p>
<p>每 60s 检查一次过去 1min 内是否有 400 报错，如果有则触发报警，其中 B 代表了别名为 400 的折线图。 </p>
<p><strong>小提示</strong>：报警信息可以发送到 Email、Slack、DingTalk 或者 Webhook 等等。报警的内容可以包含图表的截图，需要配置 <a target="_blank" rel="noopener" href="http://docs.grafana.org/installation/configuration/#external-image-storage">external image uploader</a>。</p>
<p><strong>小提示</strong>：Grafana 配置文件在 &#x2F;etc&#x2F;grafana&#x2F;grafana.ini，如需修改步骤如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it docker-statsd-influxdb-grafana bash <span class="comment"># 进入 docker 容器</span></span><br><span class="line">$ apt update</span><br><span class="line">$ apt install vim</span><br><span class="line">$ vim /etc/grafana/grafana.ini</span><br></pre></td></tr></table></figure>

<h2 id="7-2-3-脚本一键生成图表"><a href="#7-2-3-脚本一键生成图表" class="headerlink" title="7.2.3 脚本一键生成图表"></a>7.2.3 脚本一键生成图表</h2><p>我们只创建了一个接口的两种（请求量和响应时间）图表，每个图表要设置 link、alert 等等就很麻烦了。如果我们的 api 有几百个接口，岂不成了灾难了。</p>
<p>Grafana 虽然有 Template 的功能，但我们接下来讲一个奇技淫巧。</p>
<p>我们在保存图表的时候从 Chrome DevTools 的 Network 看到发起了一个 Ajax 请求，如下所示：</p>
<p><img src="/./assets/7.2.8.png"></p>
<p>dashboard 就是包含了当前仪表盘页所有图表的完整 JSON，其中：</p>
<ul>
<li>dashboard：包含一到多行 row。</li>
<li>rows：一行 row 包含一到多个 panel。</li>
<li>panels：一个 panel 是一个具体的图表。</li>
</ul>
<p>在拿到这个 JSON 后，我们就可以不断地尝试修改它，然后用 axios 带上浏览器拿到的 Cookie 发送到图中的 URL，模拟浏览器的保存操作，这里就不再展开讲解了。</p>
<h2 id="7-2-4-参考链接"><a href="#7-2-4-参考链接" class="headerlink" title="7.2.4 参考链接"></a>7.2.4 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="http://docs.grafana.org/alerting/notifications/">http://docs.grafana.org/alerting/notifications/</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/7.1%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8A).md">7.1 Telegraf + InfluxDB + Grafana(上)</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/8.1%20node-clinic.md">8.1 node-clinic</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/11/26/7.1%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8A)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/11/26/7.1%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8A)/" class="post-title-link" itemprop="url">Node in Debugging - 7.1 Telegraf + InfluxDB + Grafana(1)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-11-26 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-26T00:00:00-07:00">2019-11-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/11/26/7.1%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8A)/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 7.1 Telegraf + InfluxDB + Grafana(1)" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>本节将会讲解如何使用 Telegraf(StatsD) + InfluxDB + Grafana 搭建一套完整的监控系统。</p>
<h2 id="7-1-1-Telegraf-StatsD-InfluxDB-Grafana-简介"><a href="#7-1-1-Telegraf-StatsD-InfluxDB-Grafana-简介" class="headerlink" title="7.1.1 Telegraf(StatsD) + InfluxDB + Grafana 简介"></a>7.1.1 Telegraf(StatsD) + InfluxDB + Grafana 简介</h2><p><a target="_blank" rel="noopener" href="https://github.com/influxdata/telegraf">Telegraf</a> 是一个使用 Go 语言开发的代理程序，可收集系统和服务或者其他来源（inputs）的数据，并将其写入 InfluxDB（outputs）数据库，支持多种 inputs 和 outputs 插件。<a target="_blank" rel="noopener" href="https://github.com/etsy/statsd">StatsD</a> 是一个使用 Node.js 开发的网络守护进程，通过 UDP 或者 TCP 方式收集各种统计信息，包括计数器和定时器等。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/influxdata/influxdb">InfluxDB</a> 是一个使用 Go 语言开发的开源的分布式时序、事件和指标数据库，无需外部依赖，其设计目标是实现分布式和水平伸缩扩展。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/grafana/grafana">Grafana</a> 是一个使用 Angular + Go 语言开发的开源的、功能齐全的、漂亮的仪表盘和图表的编辑器，可用来做日志的分析与展示曲线图（如 api 的请求日志），支持多种 backend，如 ElasticSearch、InfluxDB、OpenTSDB 等等。</p>
<p><strong>工作流程</strong>：Telegraf 将 StatsD（inputs）和 InfluxDB（outputs）结合起来，即发往 StatsD 的数据，最终通过 Telegraf 写入了 InfluxDB，然后 Grafana 读取 InfluxDB 的数据展示成图表。</p>
<h2 id="7-1-2-启动-docker-statsd-influxdb-grafana"><a href="#7-1-2-启动-docker-statsd-influxdb-grafana" class="headerlink" title="7.1.2 启动 docker-statsd-influxdb-grafana"></a>7.1.2 启动 docker-statsd-influxdb-grafana</h2><p>我们使用 Docker 一键启动 Telegraf(StatsD)+ InfluxDB + Grafana，节省搭建环境的时间。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name docker-statsd-influxdb-grafana \</span><br><span class="line">  -p 3003:3003 \</span><br><span class="line">  -p 3004:8083 \</span><br><span class="line">  -p 8086:8086 \</span><br><span class="line">  -p 22022:22 \</span><br><span class="line">  -p 8125:8125/udp \</span><br><span class="line">  samuelebistoletti/docker-statsd-influxdb-grafana:latest</span><br></pre></td></tr></table></figure>

<p>端口映射关系如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Host        Container       Service</span><br><span class="line">-----------------------------------</span><br><span class="line">3003        3003            grafana</span><br><span class="line">3004        8083            influxdb-admin</span><br><span class="line">8086        8086            influxdb</span><br><span class="line">8125        8125            statsd</span><br><span class="line">22022       22              sshd</span><br></pre></td></tr></table></figure>

<h2 id="7-1-3-熟悉-InfluxDB"><a href="#7-1-3-熟悉-InfluxDB" class="headerlink" title="7.1.3 熟悉 InfluxDB"></a>7.1.3 熟悉 InfluxDB</h2><p>容器启动后，浏览器访问 localhost:3004（以下称为 influxdb-admin），如下所示：</p>
<p><img src="/./assets/7.1.1.png"></p>
<p>InfluxDB 的基本概念如下：</p>
<ul>
<li>database：数据库。</li>
<li>measurement：数据库中的表。</li>
<li>point：表里面的一行数据，由时间戳（time）、数据（field）和标签（tag）组成<ul>
<li>time：每条数据记录的时间戳，是数据库中的主索引（会自动生成）。</li>
<li>field：各种记录的值（没有索引的属性）。</li>
<li>tag：各种有索引的属性。</li>
</ul>
</li>
<li>…</li>
</ul>
<p>InfluxDB 采用了类 SQL 的查询语法，例如：</p>
<ul>
<li>show databases：列出所有数据库。</li>
<li>show measurements：列出当前数据库的所有表。</li>
<li>select * from xxx：列出 xxx 表的所有数据。</li>
<li>…</li>
</ul>
<p>我们在 Query 中输入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases</span><br></pre></td></tr></table></figure>

<p>查询结果如下：</p>
<p><img src="/./assets/7.1.2.png"></p>
<p>_interal 是 InfluxDB 内部使用的数据库，telegraf 是我们当前 Docker 容器启动后默认创建的测试数据库。</p>
<h2 id="7-1-4-配置-Grafana"><a href="#7-1-4-配置-Grafana" class="headerlink" title="7.1.4 配置 Grafana"></a>7.1.4 配置 Grafana</h2><p>用浏览器打开 localhost:3003，如下所示：</p>
<p><img src="/./assets/7.1.3.png"></p>
<p>输入用户名 root 和密码 root 登录，进入初始化配置页，单击 “Add data source”，如下填写：</p>
<p><img src="/./assets/7.1.4.png"></p>
<p>单击 “Save &amp; Test” 保存配置。目前配置好了 Grafana 默认的 datasource 是名为 api 的 InfluxDB，接下来创建测试代码，产生测试数据。</p>
<h2 id="7-1-5-node-statsd"><a href="#7-1-5-node-statsd" class="headerlink" title="7.1.5 node-statsd"></a>7.1.5 node-statsd</h2><p><a target="_blank" rel="noopener" href="https://github.com/sivy/node-statsd">node-statsd</a> 是一个 statsd 的 Node.js client。创建以下测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">StatsD</span> = <span class="built_in">require</span>(<span class="string">&#x27;node-statsd&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> statsdClient = <span class="keyword">new</span> <span class="title class_">StatsD</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8125</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> responseTime = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span>)</span><br><span class="line">  statsdClient.<span class="title function_">timing</span>(<span class="string">&#x27;api&#x27;</span>, responseTime, <span class="keyword">function</span> (<span class="params">error, bytes</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Successfully sent <span class="subst">$&#123;bytes&#125;</span> bytes, responseTime <span class="subst">$&#123;responseTime&#125;</span>ms`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p>运行以上代码，每一秒钟会产生一个 0~99 之间的随机值（模拟响应时间，单位为毫秒），发送到 StatsD，StatsD 会通过 Telegraf 将这些数据写入 InfluxDB 的 telegraf 数据库。</p>
<p>回到 influxdb-admin，单击右上角的下拉菜单切换到 telegraf 数据库，然后输入 <code>show measurements </code> 查看已经存在 api 表了，然后输入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> api</span><br></pre></td></tr></table></figure>

<p>查询结果如下：</p>
<p><img src="/./assets/7.1.5.png"></p>
<p>可以看出 api 表有以下几个字段：</p>
<ul>
<li>time：InfluxDB 默认添加的时间戳。</li>
<li>90_percentile：所有记录中从小到大 90% 那个点的值。</li>
<li>count：一次收集的日志数量，可以看出每条记录（point）的 count 值接近或等于 10，而我们的测试代码是 1s 发送一条数据，也就说明 Telegraf 默认设置是 10s 收集一次数据，默认配置也的确是这样的，见：<a target="_blank" rel="noopener" href="https://github.com/samuelebistoletti/docker-statsd-influxdb-grafana/blob/master/telegraf/telegraf.conf">https://github.com/samuelebistoletti/docker-statsd-influxdb-grafana/blob/master/telegraf/telegraf.conf</a>。</li>
<li>host：机器地址。</li>
<li>lower：最小的那条记录的值。</li>
<li>mean：所有记录的平均值。</li>
<li>metric_type：metric 类型。</li>
<li>stddev：所有记录的标准差。</li>
<li>upper：最大的那条记录的值。</li>
</ul>
<h2 id="7-1-6-创建-Grafana-图表"><a href="#7-1-6-创建-Grafana-图表" class="headerlink" title="7.1.6 创建 Grafana 图表"></a>7.1.6 创建 Grafana 图表</h2><p>回到 Grafana，单击左上角 Grafana 图标的下拉菜单，单击 Dashboards 回到仪表盘页继续完成配置，单击 “New dashboard”，然后单击创建 Graph 类型的图表，就创建了一个空的图表，如下所示：</p>
<p><img src="/./assets/7.1.6.png"></p>
<p>单击当前的图表，选择 Edit，修改如下几个地方：</p>
<ol>
<li>Metrics 配置中选择 FROM -&gt; api 表，SELECT -&gt; field(mean) 字段。</li>
<li>Display 配置中 “Null value” 选择 connected，将每个点连成折线。</li>
</ol>
<p>效果如下所示：</p>
<p><img src="/./assets/7.1.7.png"></p>
<h2 id="7-1-7-模拟真实环境"><a href="#7-1-7-模拟真实环境" class="headerlink" title="7.1.7 模拟真实环境"></a>7.1.7 模拟真实环境</h2><p><strong>middlewares&#x2F;statsd.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">StatsD</span> = <span class="built_in">require</span>(<span class="string">&#x27;node-statsd&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> statsdClient = <span class="keyword">new</span> <span class="title class_">StatsD</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8125</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">routerName</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">statsdMiddleware</span> (ctx, next) &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">      <span class="keyword">const</span> spent = <span class="title class_">Date</span>.<span class="title function_">now</span>() - start</span><br><span class="line">      statsdClient.<span class="title function_">timing</span>(<span class="string">`api_<span class="subst">$&#123;routerName&#125;</span>`</span>, spent)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      statsdClient.<span class="title function_">increment</span>(<span class="string">`api_<span class="subst">$&#123;routerName&#125;</span>_<span class="subst">$&#123;e.status || (ctx.status !== <span class="number">404</span> ? ctx.status : <span class="number">500</span>)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>server.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Bluebird</span> = <span class="built_in">require</span>(<span class="string">&#x27;bluebird&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> statsd = <span class="built_in">require</span>(<span class="string">&#x27;./middlewares/statsd&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">controller</span>: [</span><br><span class="line">  <span class="title function_">statsd</span>(<span class="string">&#x27;getHome&#x27;</span>),</span><br><span class="line">  <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 模拟十分之一出错概率</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">0.1</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">400</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 模拟 1-100 毫秒响应时间</span></span><br><span class="line">    <span class="keyword">const</span> responseTime = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span> + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Bluebird</span>.<span class="title function_">delay</span>(responseTime)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Spent <span class="subst">$&#123;responseTime&#125;</span>ms`</span>)</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">  &#125;</span><br><span class="line">]&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>client.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 模拟 1-10 的 tps</span></span><br><span class="line">  <span class="keyword">const</span> tps = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span> + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tps; i++) &#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p>打开两个终端，分别运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js</span><br><span class="line">$ node client.js</span><br></pre></td></tr></table></figure>

<p>回到 influxdb-admin，输入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> measurements</span><br></pre></td></tr></table></figure>

<p>可以看到已经有 api_getHome 和 api_getHome_400 表了。回到 Grafana，在一行（row）里创建两个图表，分别为：</p>
<ul>
<li>请求量：包含了正常请求（200）和错误请求（4xx、5xx 等等）请求量的折线图。</li>
<li>响应时间：正常请求的最低（lower）、平均（mean）、最高（upper）响应时间的折线图。</li>
</ul>
<p><img src="/./assets/7.1.8.png"></p>
<p>以 “getHome 响应时间” 的图表为例，Metrics 配置截图如下：</p>
<p><img src="/./assets/7.1.9.png"></p>
<h2 id="7-1-8-参考链接"><a href="#7-1-8-参考链接" class="headerlink" title="7.1.8 参考链接"></a>7.1.8 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shhnwangjian/p/6897216.html">https://www.cnblogs.com/shhnwangjian/p/6897216.html</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.5%20Sentry.md">6.5 Sentry</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/7.2%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8B).md">7.2 Telegraf + InfluxDB + Grafana(下)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/11/03/6.5%20Sentry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/11/03/6.5%20Sentry/" class="post-title-link" itemprop="url">Node in Debugging - 6.5 Sentry</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-11-03 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-03T00:00:00-06:00">2019-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/11/03/6.5%20Sentry/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.5 Sentry" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<h2 id="6-5-1-什么是-Sentry？"><a href="#6-5-1-什么是-Sentry？" class="headerlink" title="6.5.1 什么是 Sentry？"></a>6.5.1 什么是 Sentry？</h2><p>Sentry<a href="sentry.io">官网</a>的介绍：</p>
<blockquote>
<p>Sentry’s real-time error tracking gives you insight into production deployments and information to reproduce and fix crashes.</p>
</blockquote>
<p><strong>简而言之</strong>：Sentry 是一个开源的实时错误日志收集平台。</p>
<h2 id="6-5-2-安装-Sentry"><a href="#6-5-2-安装-Sentry" class="headerlink" title="6.5.2 安装 Sentry"></a>6.5.2 安装 Sentry</h2><p>我们使用 Docker 安装并启动 Sentry，步骤如下：</p>
<ol>
<li><p>启动一个 Redis 容器，命名为 sentry-redis：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name sentry-redis redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动一个 Postgres 容器，命名为 sentry-postgres：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name sentry-postgres \</span><br><span class="line">  -e POSTGRES_PASSWORD=secret \</span><br><span class="line">  -e POSTGRES_USER=sentry \</span><br><span class="line">  postgres</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成一个 Sentry 的 secret key：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --<span class="built_in">rm</span> sentry config generate-secret-key</span><br></pre></td></tr></table></figure>

<p>将下面的 &lt;secret-key&gt; 都替换成上面生成的 secret key。</p>
</li>
<li><p>如果是新的数据库（第 1 次运行），则需要运行 upgrade：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --<span class="built_in">rm</span> \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  sentry upgrade</span><br></pre></td></tr></table></figure>

<p>按步骤填写自己的信息：</p>
<p><img src="/./assets/6.5.1.jpg"></p>
<p>最终创建了一个超级管理员和一个默认的名为 sentry 的组织（organization）。</p>
</li>
<li><p>启动 Sentry，并对外暴露 9000 端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name my-sentry \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  -p 9000:9000 \</span><br><span class="line">  sentry</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Celery cron 和 Celery workers：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name sentry-cron \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  sentry run cron</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name sentry-worker-1 \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  sentry run worker</span><br></pre></td></tr></table></figure>

<p><strong>小提示</strong>：Celery 是用 Python 写的一个分布式任务调度模块。</p>
</li>
<li><p>完成！</p>
</li>
</ol>
<p>用浏览器打开 localhost:9000，就能看到 Sentry 的登录页面了，如下所示：</p>
<p><img src="/./assets/6.5.2.jpg"></p>
<p>首次登录时需要填写一些必要信息 ，如下所示：</p>
<p><img src="/./assets/6.5.3.png"></p>
<p>单击 Continue 进入 Sentry 仪表盘（Dashboard）。单击右上角的 New Project 按钮创建一个项目，选择 Node.js 并填写项目名称为 API，然后单击 Create Project 按钮创建项目。如下所示：</p>
<p><img src="/./assets/6.5.4.png"></p>
<p>创建成功后进入 Node.js 使用示例页面，我们选择使用 Koa 测试，在右侧选择 Koa：</p>
<p><img src="/./assets/6.5.5.png"></p>
<p>上图所示是 koa@1 的示例代码，我们以 Paloma（基于  koa@2）为例，编写测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Raven</span> = <span class="built_in">require</span>(<span class="string">&#x27;raven&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line"><span class="title class_">Raven</span>.<span class="title function_">config</span>(<span class="variable constant_">DSN</span>).<span class="title function_">install</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Raven</span>.<span class="title function_">captureException</span>(err, <span class="function">(<span class="params">err, eventId</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Reported error &#x27;</span> + eventId)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>raven 是 Node.js 版的 Sentry SDK，用来收集和发送错误日志。</p>
<p><strong>小提示</strong>：将 DSN 替换为上图中的 <code>http://xxx@localhost:9000/2</code>，DSN 既告诉客户端 Sentry 服务器的地址，也用来当做身份认证的 token。</p>
<p>运行以上测试代码，访问 localhost:3000，错误信息会发送给 Sentry。Sentry 展示如下：</p>
<p><img src="/./assets/6.5.6.png"></p>
<p>点进去可以看到详细的信息：</p>
<p><img src="/./assets/6.5.7.png"></p>
<p>Sentry 还有许多功能，比如：错误归类、展示错误的频率柱状图、将错误指派给组织中的某个人、给错误添加标签、查看这类错误事件的历史、标记错误为已解决、在错误下发表评论、警报等等功能。</p>
<h2 id="6-5-3-koa-raven"><a href="#6-5-3-koa-raven" class="headerlink" title="6.5.3 koa-raven"></a>6.5.3 koa-raven</h2><p>笔者将 raven 封装成 Koa 的一个中间件。使用如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> raven = <span class="built_in">require</span>(<span class="string">&#x27;koa-raven&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">raven</span>(<span class="variable constant_">DSN</span>))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>或者使用 ctx.raven：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> raven = <span class="built_in">require</span>(<span class="string">&#x27;koa-raven&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">raven</span>(<span class="variable constant_">DSN</span>))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    ctx.<span class="property">raven</span>.<span class="title function_">captureException</span>(e, &#123; <span class="attr">extra</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;tom&#x27;</span> &#125; &#125;)</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">500</span></span><br><span class="line">    ctx.<span class="property">body</span> = e.<span class="property">stack</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="6-5-4-参考链接"><a href="#6-5-4-参考链接" class="headerlink" title="6.5.4 参考链接"></a>6.5.4 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://sentry.io/">https://sentry.io/</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.4%20OpenTracing%20%2B%20Jaeger.md">6.4 OpenTracing + Jaeger</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/7.1%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8A).md">7.1 Telegraf + InfluxDB + Grafana(上)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/10/28/6.4%20OpenTracing%20+%20Jaeger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/28/6.4%20OpenTracing%20+%20Jaeger/" class="post-title-link" itemprop="url">Node in Debugging - 6.4 OpenTracing + Jaeger</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-10-28 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-28T00:00:00-06:00">2019-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/10/28/6.4%20OpenTracing%20+%20Jaeger/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.4 OpenTracing + Jaeger" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<h2 id="6-4-1-什么是-OpenTracing？"><a href="#6-4-1-什么是-OpenTracing？" class="headerlink" title="6.4.1 什么是 OpenTracing？"></a>6.4.1 什么是 OpenTracing？</h2><p><a target="_blank" rel="noopener" href="http://opentracing.io/">OpenTracing</a> 是一个分布式追踪规范。OpenTracing 通过提供平台无关、厂商无关的 API，为分布式追踪提供统一的概念和数据标准，使得开发人员能够方便的添加（或更换）追踪系统的实现。OpenTracing 定义了如下几个术语：</p>
<ul>
<li>Span：代表了系统中的一个逻辑工作单元，它具有操作名、操作开始时间以及持续时长。Span 可能会有嵌套或排序，从而对因果关系建模。<ul>
<li>Tags：每个 Span 可以有多个键值对（key: value）形式的 Tags，Tags 是没有时间戳的，支持简单地对 Span 进行注解和补充。</li>
<li>Logs：每个 Span 可以进行多次 Log 操作，每一次 Log 操作，都需要一个带时间戳的时间名称，以及可选的任意大小的存储结构。</li>
</ul>
</li>
<li>Trace：代表了系统中的一个数据&#x2F;执行路径（一个或多个 Span），可以将其理解为 Span 的有向无环图。</li>
</ul>
<p>OpenTracing 还有其他一些概念，这里不过多解释。我们看个传统的调用关系例子，如下所示：</p>
<p><img src="/./assets/6.4.1.jpg"></p>
<blockquote>
<p>在一个分布式系统中，追踪一个事务或者调用流一般如上图所示。虽然这种图对于看清各组件的组合关系是很有用的，但是，它不能很好显示组件的调用时间，以及是串行调用还是并行调用。如果展现更复杂的调用关系，会更加复杂，甚至无法画出这样的图。另外，这种图也无法显示调用间的时间间隔以及是否通过定时调用来启动调用。一种更有效的展现一个典型的 trace 过程，如下图所示：</p>
</blockquote>
<p><img src="/./assets/6.4.2.jpg"></p>
<blockquote>
<p>这种展现方式增加了执行时间的上下文，相关服务间的层次关系，进程或者任务的串行或并行调用关系。这样的视图有助于发现系统调用的关键路径。通过关注关键路径的执行过程，项目团队可能专注于优化路径中的关键位置，最大幅度地提升系统的性能。例如：可以通过追踪一个资源定位的调用情况，明确底层的调用情况，发现哪些操作有阻塞的情况。</p>
</blockquote>
<h2 id="6-4-2-什么是-Jaeger"><a href="#6-4-2-什么是-Jaeger" class="headerlink" title="6.4.2 什么是 Jaeger?"></a>6.4.2 什么是 Jaeger?</h2><p>Jaeger 是 OpenTracing 的一个实现，是 Uber 开源的一个分布式追踪系统，其灵感来源于Dapper 和 OpenZipkin。从 2016 年开始，该系统已经在 Uber 内部得到了广泛的应用，它可以用于微服务架构应用的监控，特性包括分布式上下文传播（Distributed context propagation）、分布式事务监控、根原因分析、服务依赖分析以及性能优化。该项目已经被云原生计算基金会（Cloud Native Computing Foundation，CNCF）接纳为第 12 个项目。</p>
<h2 id="6-4-3-启动-Jaeger-Jaeger-UI"><a href="#6-4-3-启动-Jaeger-Jaeger-UI" class="headerlink" title="6.4.3 启动 Jaeger + Jaeger UI"></a>6.4.3 启动 Jaeger + Jaeger UI</h2><p>我们使用 Docker 启动 Jaeger + Jaeger UI（Jaeger 可视化 web 控制台），运行如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p5775:5775/udp \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  jaegertracing/all-in-one:latest</span><br></pre></td></tr></table></figure>

<p>用浏览器打开 localhost:16686，如下所示：</p>
<p><img src="/./assets/6.4.3.jpg"></p>
<p>现在并没有任何数据，接下来我们看看如何使用 Jaeger 接收并查询日志。</p>
<h2 id="6-4-4-如何使用-OpenTracing-Jaeger"><a href="#6-4-4-如何使用-OpenTracing-Jaeger" class="headerlink" title="6.4.4 如何使用 OpenTracing + Jaeger?"></a>6.4.4 如何使用 OpenTracing + Jaeger?</h2><p>OpenTracing 和 Jaeger 分别提供了 JavaScript&#x2F;Node.js 的 SDK：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/opentracing/opentracing-javascript">opentracing&#x2F;opentracing-javascript</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jaegertracing/jaeger-client-node">jaegertracing&#x2F;jaeger-client-node</a></li>
</ul>
<p>opentracing 示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> opentracing = <span class="built_in">require</span>(<span class="string">&#x27;opentracing&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> the default OpenTracing tracer does not record any tracing information.</span></span><br><span class="line"><span class="comment">// Replace this line with the tracer implementation of your choice.</span></span><br><span class="line"><span class="keyword">const</span> tracer = <span class="keyword">new</span> opentracing.<span class="title class_">Tracer</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> span = tracer.<span class="title function_">startSpan</span>(<span class="string">&#x27;http_request&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> opts = &#123;</span><br><span class="line">  host : <span class="string">&#x27;example.com&#x27;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  port : <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">http.<span class="title function_">request</span>(opts, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// assuming no retries, mark the span as failed</span></span><br><span class="line">    span.<span class="title function_">setTag</span>(opentracing.<span class="property">Tags</span>.<span class="property">ERROR</span>, <span class="literal">true</span>)</span><br><span class="line">    span.<span class="title function_">log</span>(&#123;<span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;error.object&#x27;</span>: err, <span class="string">&#x27;message&#x27;</span>: err.<span class="property">message</span>, <span class="string">&#x27;stack&#x27;</span>: err.<span class="property">stack</span>&#125;)</span><br><span class="line">    span.<span class="title function_">finish</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123;</span><br><span class="line">    span.<span class="title function_">log</span>(&#123;<span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;data_received&#x27;</span>, <span class="string">&#x27;chunk_length&#x27;</span>: chunk.<span class="property">length</span>&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    span.<span class="title function_">log</span>(&#123;<span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;request_end&#x27;</span>&#125;)</span><br><span class="line">    span.<span class="title function_">finish</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).<span class="title function_">end</span>()</span><br></pre></td></tr></table></figure>

<p>有以下两点需要解释：</p>
<ol>
<li>需要将上面的 <code>const tracer = new opentracing.Tracer()</code> 替换成自己的 tracer 实现，即 Jaeger 的实现。</li>
<li>通过 tracer.startSpan 启动一个 Span，span.setTag 用来设置 Tags，span.log 用来设置 Logs，span.finish 用来结束一个 Span。</li>
</ol>
<p>这有点类似于我们的手动埋点，只不过变成了一个规范而已。但 OpenTracing 的功能不止如此，上面只是一个 Span 的用法，Span 之间还可以关联调用关系，最后得到一个 DAG（有向无环图）。</p>
<p><strong>举个例子</strong>：假如我们正在做微服务，多个服务之间有调用关系（不管是 HTTP 还是 RPC 等），每次调用服务在内部可能产生多个 Span，最终会在 Jaeger 控制台页面看到一个完整的 Trace 和 DAG 图（微服务之间的调用关系）。</p>
<p>jaeger-client-node 使用如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tracer = <span class="keyword">new</span> jaeger.<span class="title class_">Tracer</span>(</span><br><span class="line">  serviceName,</span><br><span class="line">  <span class="keyword">new</span> jaeger.<span class="title class_">RemoteReporter</span>(<span class="keyword">new</span> <span class="title class_">UDPSender</span>()),</span><br><span class="line">  <span class="keyword">new</span> jaeger.<span class="title class_">RateLimitingSampler</span>(<span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>创建一个 tracer，可以接收 3 个参数：</p>
<ol>
<li>serviceName：服务名。</li>
<li>Reporter：上报器，即往哪发日志，如上述代码是通过 UDP 发送日志，默认地址 localhost:6832。</li>
<li>Sampler：采样器，即日志如何采样，如上述代码是限制 1 秒采样一次。</li>
</ol>
<p>这里不再详细介绍其它选项，读者可自行去查阅 jaeger-client-node 的文档。</p>
<h2 id="6-4-5-koa-await-breakpoint-jaeger"><a href="#6-4-5-koa-await-breakpoint-jaeger" class="headerlink" title="6.4.5 koa-await-breakpoint-jaeger"></a>6.4.5 koa-await-breakpoint-jaeger</h2><p>通过上面的例子我们知道，在使用 Jaeger 时需要手动埋点。前面我们介绍了 koa-await-breakpoint 日志自动打点，可自定义 store，koa-await-breakpoint-jaeger 是为 koa-await-breakpoint 写的 store 的 adaptor，在实现上有一些小技巧，有兴趣的读者可以去读下源码。</p>
<p>还是以 koa-await-breakpoint 的 example 举例，只添加了两行代码引入 jaeger 的使用。代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">JaegerStore</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint-jaeger&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>],</span><br><span class="line">  <span class="attr">store</span>: <span class="keyword">new</span> <span class="title class_">JaegerStore</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure>

<p>刷新 localhost:16686，可以看到已经有日志了，如下所示：</p>
<p><img src="/./assets/6.4.4.jpg"></p>
<p>选择 Sercice -&gt; api，Operation -&gt; POST &#x2F;users，单击 Find Traces 查看所有结果，右侧展示了一条日志，点进去如下所示：</p>
<p><img src="/./assets/6.4.5.jpg"></p>
<p><strong>小提示</strong>：可以根据 tags 过滤结果。</p>
<p><strong>注意</strong>：Jaeger 是分布式追踪系统，通常用来追踪多个服务之间的调用关系，而这里用来追踪一个服务的多个函数之间的调用关系。</p>
<p>修改 routes&#x2F;user.js 的 createComment 函数 throw 一个 <code>new Error(&#39;test&#39;)</code>，重新运行，如下所示：</p>
<p><img src="/./assets/6.4.6.jpg"></p>
<p>可以看出，Jaeger 完美地展现了在一个请求到来时，函数之间的调用关系、层级关系及耗时，甚至函数体和错误栈都有！然后，我们可以用 requestId 去 ELK 中查询日志了。</p>
<h2 id="6-4-6-参考链接"><a href="#6-4-6-参考链接" class="headerlink" title="6.4.6 参考链接"></a>6.4.6 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wu-sheng.gitbooks.io/opentracing-io/content/">https://wu-sheng.gitbooks.io/opentracing-io/content/</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008895129">https://segmentfault.com/a/1190000008895129</a></li>
<li><a target="_blank" rel="noopener" href="http://www.infoq.com/cn/news/2017/11/Uber-open-spurce-Jaeger">http://www.infoq.com/cn/news/2017/11/Uber-open-spurce-Jaeger</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.3%20ELK.md">6.3 ELK</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.5%20Sentry.md">6.5 Sentry</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/10/15/6.3%20ELK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/15/6.3%20ELK/" class="post-title-link" itemprop="url">Node in Debugging - 6.3 ELK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-10-15 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-15T00:00:00-06:00">2019-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/10/15/6.3%20ELK/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.3 ELK" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>ELK 是 ElasticSearch + Logstash + Kibana 这套组合工具的简称，是一个常用的日志系统。</p>
<ul>
<li>ElasticSearch：是一款开源的基于 Lucene 之上实现的一个分布式搜索引擎，也是一个存储引擎（例如：日志），它的特点有：分布式、零配置、自动发现、索引自动分片、索引副本机制、Restful 风格的接口、多数据源和自动搜索负载等。</li>
<li>Logstash：是一款开源的日志收集工具，它可以对日志进行收集、分析、过滤，并将其存储（例如：ElasticSearch）起来供以后使用。</li>
<li>Kibana：是一款开源的可视化工具，可以为 ElasticSearch 提供的日志分析友好的 Web 界面，可以汇总、分析和搜索重要的数据日志。</li>
</ul>
<h2 id="6-3-1-安装-ELK"><a href="#6-3-1-安装-ELK" class="headerlink" title="6.3.1 安装 ELK"></a>6.3.1 安装 ELK</h2><p>我们使用 Docker 安装 ELK，运行如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 5601:5601 \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 5044:5044 \</span><br><span class="line">    -p 15044:15044/udp \</span><br><span class="line">    -it --name elk sebp/elk</span><br></pre></td></tr></table></figure>

<p>进入容器：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it elk /bin/bash</span><br></pre></td></tr></table></figure>

<p>运行以下命令设置 logstash 的 input 和 output：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /opt/logstash/bin/logstash --path.data /tmp/logstash/data \</span></span><br><span class="line">  -e <span class="string">&#x27;input &#123; udp &#123; codec =&gt; &quot;json&quot; port =&gt; 15044 &#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; [&quot;localhost&quot;] &#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里我们启动一个 15044 的 UDP 端口，用来接收通过 UDP 发送到 Logstash 的日志。</p>
<p>用浏览器打开 localhost:5601，如下所示：</p>
<p><img src="/./assets/6.3.1.png"></p>
<p>目前还没有指定 index（ElasticSearch 的 index 类似于 MySQL&#x2F;MongoDB 中的 database），即日志来源。下面我们尝试向 ELK 中写入一些日志。</p>
<h2 id="6-3-2-使用-ELK"><a href="#6-3-2-使用-ELK" class="headerlink" title="6.3.2 使用 ELK"></a>6.3.2 使用 ELK</h2><p>这里仍然以使用 koa-await-breakpoint 为例，来演示如何将日志发送到 ELK。</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>],</span><br><span class="line">  <span class="attr">store</span>: <span class="built_in">require</span>(<span class="string">&#x27;./logger&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>logger.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Logstash</span> = <span class="built_in">require</span>(<span class="string">&#x27;logstash-client&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logstash = <span class="keyword">new</span> <span class="title class_">Logstash</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;udp&#x27;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">15044</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  save (log) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.<span class="property">error</span>) &#123;</span><br><span class="line">      log.<span class="property">errMsg</span> = log.<span class="property">error</span>.<span class="property">message</span></span><br><span class="line">      log.<span class="property">errStack</span> = log.<span class="property">error</span>.<span class="property">stack</span></span><br><span class="line">    &#125;</span><br><span class="line">    logstash.<span class="title function_">send</span>(log)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>routes&#x2F;user.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Post</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Comment</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createPost</span>(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> post = (<span class="keyword">await</span> <span class="title class_">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">uid</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;post&#x27;</span></span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createComment</span>(user, post)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (user, post) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">userId</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">postId</span>: post.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;comment&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure>

<p>此时刷新 Kibana，如下所示：</p>
<p><img src="/./assets/6.3.2.png"></p>
<p>在初次使用 Kibana 时，需要配置 Kibana 从 ElasticSearch 的哪些 index 中搜索日志，我们在 <code>Index pattern</code> 处填 <code>logstash-*</code>，然后单击 Next step 按钮，在 <code>Time Filter field name</code> 中选择 timestamp，单击 Create index pattern 完成配置。</p>
<p><strong>注意</strong>：我们选择 timestamp 而不是默认的 @timestamp，是因为在 koa-await-breakpoint 的日志中有 timestamp 字段。</p>
<p>单击左侧目录的 Discover，我们发现已经有日志了。分别单击左侧出现的 Available Fields 的 fn、type、step、take，然后按 step 升序展示，如下所示：</p>
<p><img src="/./assets/6.3.3.png"></p>
<p>是不是一目了然！我们把每个请求的每一步的函数及其执行时间都记录下来了。</p>
<p>修改 routes&#x2F;users.js 的 createComment，throw 一个 <code>new Error(&#39;test&#39;)</code>。重启程序并发起一个请求，ELK 显示如下：</p>
<p><img src="/./assets/6.3.4.png"></p>
<p><strong>小提示</strong>：在实际应用中会有非常多的日志，我们可以通过 requestId 找到一个请求的所有日志，在 7.2 小节会讲解。</p>
<p>ELK 非常强大，基本能满足所有日志查询需求，Kibana 的查询使用 lucene 语法，用 10 分钟左右就能大体上手。Kibana 还能创建各种仪表盘和聚合图表，读者可自行尝试。</p>
<h2 id="6-3-3-参考链接"><a href="#6-3-3-参考链接" class="headerlink" title="6.3.3 参考链接"></a>6.3.3 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="http://blog.51cto.com/baidu/1676798">http://blog.51cto.com/baidu/1676798</a></li>
<li><a target="_blank" rel="noopener" href="http://elk-docker.readthedocs.io/">http://elk-docker.readthedocs.io</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.2%20async_hooks.md">6.2 async_hooks</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.4%20OpenTracing%20%2B%20Jaeger.md">6.4 OpenTracing + Jaeger</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/09/29/6.2%20async_hooks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/29/6.2%20async_hooks/" class="post-title-link" itemprop="url">Node in Debugging - 6.2 Async Hooks</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-29 00:00:00" itemprop="dateCreated datePublished" datetime="2019-09-29T00:00:00-06:00">2019-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/09/29/6.2%20async_hooks/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.2 Async Hooks" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>上一小节讲解了 koa-await-breakpoint 的用法，但 koa-await-breakpoint 仍然有一个很大的缺憾，即无法记录除 routes&#x2F;controllers 外的函数的执行时间（因为获取不到当前请求的 ctx）。举个通俗的例子：在一个路由的 controller 里面调用了 A ，A 调用了其他文件的 B ，B 又调用了其他文件的 C…这是非常常见的用法，但之前使用 koa-await-breakpoint 只能获取 A 的执行时间，无法获取 B 和 C 的执行时间。</p>
<p><strong>根本原因在于</strong>：无法知道函数之间的调用关系，即 B 不知道是 A 调用的它，即便知道也不知道是哪次请求到来时执行的 A 调用的它。</p>
<p>但是，<a href="mailto:&#110;&#111;&#x64;&#101;&#64;&#x38;&#46;&#x31;">&#110;&#111;&#x64;&#101;&#64;&#x38;&#46;&#x31;</a> 引入了一个黑魔法——Async Hooks。</p>
<h2 id="6-2-1-Async-Hooks"><a href="#6-2-1-Async-Hooks" class="headerlink" title="6.2.1 Async Hooks"></a>6.2.1 Async Hooks</h2><p>我们先看看 async_hooks 是什么。Node.js 官网对 async_hooks 的介绍为：</p>
<blockquote>
<p>The <code>async_hooks</code> module provides an API to register callbacks tracking the lifetime of asynchronous resources created inside a Node.js application.</p>
</blockquote>
<p><strong>一句话概括</strong>：async_hooks 用来追踪 Node.js 中异步资源的生命周期。</p>
<p>我们来看段测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">&#x27;async_hooks&#x27;</span>)</span><br><span class="line"></span><br><span class="line">async_hooks.<span class="title function_">createHook</span>(&#123;</span><br><span class="line">  init (asyncId, type, triggerAsyncId, resource) &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`<span class="subst">$&#123;type&#125;</span>(<span class="subst">$&#123;asyncId&#125;</span>): trigger: <span class="subst">$&#123;triggerAsyncId&#125;</span>\n`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy (asyncId) &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`destroy: <span class="subst">$&#123;asyncId&#125;</span>\n`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">enable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">A</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`A -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`A in setTimeout -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">    <span class="title function_">B</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">B</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`B -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`B in process.nextTick -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">    <span class="title function_">C</span>()</span><br><span class="line">    <span class="title function_">C</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">C</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`C -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`C in promise.then -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`top level -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line"><span class="title function_">A</span>()</span><br></pre></td></tr></table></figure>

<p>async_hooks.createHook 可以注册 4 个方法来跟踪所有异步资源的初始化（init）、回调之前（before）、回调之后（after）、销毁后（destroy）事件，并通过调用 .enable() 启用，调用 .disable() 关闭。</p>
<p>这里我们只关心异步资源的初始化和销毁的事件，并使用 <code>fs.writeSync(1, msg)</code> 打印到标准输出，writeSync 的第 1 个参数接收文件描述符，1 表示标准输出。为什么不使用 console.log 呢？因为 console.log 是一个异步操作，如果在 init、before、after 和 destroy 事件处理函数中出现，就会导致无限循环，同理也不能使用任何其他的异步操作。</p>
<p>运行该程序，打印如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">top level -&gt; 1</span><br><span class="line">PROMISE(6): trigger: 1</span><br><span class="line">A -&gt; 1</span><br><span class="line">Timeout(7): trigger: 1</span><br><span class="line">TIMERWRAP(8): trigger: 1</span><br><span class="line">A in setTimeout -&gt; 7</span><br><span class="line">PROMISE(9): trigger: 7</span><br><span class="line">B -&gt; 7</span><br><span class="line">TickObject(10): trigger: 7</span><br><span class="line">B in process.nextTick -&gt; 10</span><br><span class="line">C -&gt; 10</span><br><span class="line">PROMISE(11): trigger: 10</span><br><span class="line">PROMISE(12): trigger: 11</span><br><span class="line">C -&gt; 10</span><br><span class="line">PROMISE(13): trigger: 10</span><br><span class="line">PROMISE(14): trigger: 13</span><br><span class="line">C in promise.then -&gt; 12</span><br><span class="line">C in promise.then -&gt; 14</span><br><span class="line">destroy: 7</span><br><span class="line">destroy: 10</span><br><span class="line">destroy: 8</span><br></pre></td></tr></table></figure>

<p>这段程序的打印结果包含了很多信息，下面逐一进行解释：</p>
<ol>
<li>为了实现对异步资源的跟踪，Node.js 对每一个函数（不论异步还是同步）提供了一个 async scope，我们可以通过调用 <code>async_hooks.executionAsyncId()</code> 来获取函数当前的 async scope 的 id（称为 asyncId），通过调用 <code>async_hooks.triggerAsyncId()</code> 来获取当前函数调用者的 asyncId。</li>
<li>异步资源在创建时触发 init 事件函数，init 函数中的第 1 个参数代表该异步资源的 asyncId，type 表示异步资源的类型（例如 TCPWRAP、PROMISE、Timeout、Immediate、TickObject 等等），triggerAsyncId 表示该异步资源的调用者的 asyncId。异步资源在销毁时触发 destroy 事件函数，该函数只接收一个参数，即该异步资源的 asyncId。</li>
<li>函数调用关系明确。我们通过上面的打印结果可以很容易地看出（从下往上看） ：C（asyncId: 10）被 B（asyncId: 7）调用，B（asyncId: 7）被 A（asyncId: 1）调用。而且 C 的 promise.then 里面的 asyncId（值为 12&#x2F;14）也可以通过 12&#x2F;14 -&gt; 11&#x2F;13 -&gt; 10 定位到 C 的 asyncId（值为 10）。</li>
<li>同步函数每次调用的 asyncId 都一样，如上所示，C 调用了两次，都打印了 C -&gt; 10，与调用方的作用域的 asyncId 一致，即如上所示打印的 B in process.nextTick -&gt; 10。异步函数每次调用的 asyncId 都不一样，即如上所示打印的 C in promise.then -&gt; 12 和 C in promise.then -&gt; 14。</li>
<li>最外层作用域的 asyncId 总是 1，每个异步资源在创建时 asyncId 全局递增。</li>
</ol>
<p>上面 5 条结论非常重要。接下来我们看看如何使用 async_hooks 改造 koa-await-breakpoint。</p>
<h2 id="6-2-2-改造-koa-await-breakpoint"><a href="#6-2-2-改造-koa-await-breakpoint" class="headerlink" title="6.2.2 改造 koa-await-breakpoint"></a>6.2.2 改造 koa-await-breakpoint</h2><p>我们通过前面的结论已经知道，使用 async_hooks 时可以通过 asyncId 串起函数的调用关系，但是如何将这些函数的调用链与 koa 接收的每个请求关联起来呢?</p>
<p>首先，定义一个全局 Map，存储函数的调用关系：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">&#x27;async_hooks&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> asyncIdMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">async_hooks.<span class="title function_">createHook</span>(&#123;</span><br><span class="line">  init (asyncId, type, triggerAsyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="title function_">getCtx</span>(triggerAsyncId)</span><br><span class="line">    <span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">      asyncIdMap.<span class="title function_">set</span>(asyncId, ctx)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      asyncIdMap.<span class="title function_">set</span>(asyncId, triggerAsyncId)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy (asyncId) &#123;</span><br><span class="line">    asyncIdMap.<span class="title function_">delete</span>(asyncId)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">enable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCtx</span> (asyncId) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!asyncId) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> asyncId === <span class="string">&#x27;object&#x27;</span> &amp;&amp; asyncId.<span class="property">app</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> asyncId</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getCtx</span>(asyncIdMap.<span class="title function_">get</span>(asyncId))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有以下三点需要解释：</p>
<ol>
<li>定义了一个全局 Map 来存储函数的调用关系，在适当的地方（下面会讲到）将当前请求的 ctx 存储到 Map 中，key 是 asyncId。</li>
<li>每个异步资源在初始化时，会尝试通过 asyncId 向上寻找祖先的 value 是否是 ctx（koa 应用中每个请求的 ctx），如果有，则直接将 value 设置为 ctx，否则将 value 设置为调用者的 asyncId（即 triggerAsyncId）。</li>
<li>在 destroy 事件函数里直接删除调用关系，保证了不会引起内存泄漏，即杜绝引用了 ctx 但没有释放的情况。</li>
</ol>
<p>然后，修改 global[loggerName] 如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>[loggerName] = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, fn, fnStr, filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> originalContext = ctx</span><br><span class="line">  <span class="keyword">let</span> requestId = <span class="title function_">_getRequestId</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> asyncId = async_hooks.<span class="title function_">executionAsyncId</span>()</span><br><span class="line">  <span class="keyword">if</span> (!requestId) &#123;</span><br><span class="line">    <span class="keyword">const</span> _ctx = <span class="title function_">getCtx</span>(asyncId)</span><br><span class="line">    <span class="keyword">if</span> (_ctx) &#123;</span><br><span class="line">      ctx = _ctx</span><br><span class="line">      requestId = <span class="title function_">_getRequestId</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    asyncIdMap.<span class="title function_">set</span>(asyncId, ctx)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestId) &#123;</span><br><span class="line">    <span class="title function_">_logger</span>(<span class="string">&#x27;beforeAwait&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> fn.<span class="title function_">call</span>(originalContext)</span><br><span class="line">  <span class="keyword">if</span> (requestId) &#123;</span><br><span class="line">    <span class="title function_">_logger</span>(<span class="string">&#x27;afterAwait&#x27;</span>, result)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_getRequestId</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx &amp;&amp; ctx.<span class="property">app</span> &amp;&amp; _.<span class="title function_">get</span>(ctx, requestIdPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_logger</span> (type, result) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有以下两点需要解释：</p>
<ol>
<li>logger 函数传入的第 1 个参数 ctx，之前是每个请求的 ctx，现在可能是当前执行上下文的 this，所以先将 ctx 赋值给 originalContext，然后通过 <code>await fn.call(originalContext)</code> 让函数在执行时有正确的上下文。</li>
<li>如果传入的 ctx 是来自请求的 ctx 且能拿到 requestId，那么将当前 asyncId 和 ctx 写入 Map，如果不是来自请求的 ctx，则尝试从 Map 里向上寻找祖先的 value 是否是 ctx，如果找到，则覆盖当前的 ctx 并拿到 requestId。</li>
</ol>
<p>至此，koa-await-breakpoint 全部改造完毕。接下来我们通过一个例子验证下升级后的 koa-await-breakpoint：</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>routes&#x2F;users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Post</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Comment</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createPost</span>(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> post = (<span class="keyword">await</span> <span class="title class_">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">uid</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;post&#x27;</span></span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createComment</span>(user, post)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (user, post) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">userId</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">postId</span>: post.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;comment&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的意思是：在访问创建用户接口时，调用 createUser，createUser 里面又调用了 createPost，createPost 里面又调用了 createComment。运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure>

<p>打印如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;start&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createUser(name, age)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;User.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;User.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">36</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createPost(user)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">6</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Post.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">7</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Post.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">3</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createComment(user, post)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">9</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Comment.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Comment.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">11</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createComment(user, post)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createPost(user)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">6</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createUser(name, age)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">44</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;end&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br></pre></td></tr></table></figure>

<p>至此，一个全链路、无侵入、强大的日志打点工具就完成了。</p>
<p><strong>注意</strong>：使用 async_hooks 在目前有较严重的性能损耗，见 <a target="_blank" rel="noopener" href="https://github.com/bmeurer/async-hooks-performance-impact">https://github.com/bmeurer/async-hooks-performance-impact</a>，请慎重在生产环境中使用。</p>
<h2 id="6-2-3-参考链接"><a href="#6-2-3-参考链接" class="headerlink" title="6.2.3 参考链接"></a>6.2.3 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html">https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27394440">https://zhuanlan.zhihu.com/p/27394440</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a568dac41ed">https://www.jianshu.com/p/4a568dac41ed</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.1%20koa-await-breakpoint.md">6.1 koa-await-breakpoint</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.3%20ELK.md">6.3 ELK</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018  
  <!-- <span itemprop="copyrightYear">2022</span> -->
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Marvin Liu</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"appid":"qAsjmBkdw5m0pBHIrH2owQQT-MdYXbMMI","appkey":"xmNL8CNHrbd2QvJOzWwbj3ny","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
