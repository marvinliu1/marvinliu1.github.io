{"meta":{"title":"Marvin's Blog","subtitle":"","description":"Take in the good!","author":"Marvin Liu","url":"https://marvinliu1.github.io","root":"/"},"pages":[{"title":"","date":"2020-10-21T08:57:00.000Z","updated":"2022-05-21T10:04:11.949Z","comments":true,"path":"about/index.html","permalink":"https://marvinliu1.github.io/about/index.html","excerpt":"","text":"About me . . . A passionate coder Fantastic troubleshooter And enthusiastic software developer $(\"#code\").typewriter();"},{"title":"categories","date":"2022-05-21T07:31:25.000Z","updated":"2022-05-21T07:31:40.888Z","comments":true,"path":"categories/index.html","permalink":"https://marvinliu1.github.io/categories/index.html","excerpt":"","text":""},{"title":"Favorite Links","date":"2022-05-24T22:20:17.136Z","updated":"2022-05-24T22:20:17.136Z","comments":true,"path":"links/index.html","permalink":"https://marvinliu1.github.io/links/index.html","excerpt":"","text":"NodeJS Usefull Links Nuxt authentication A very good auth implementation by Chimezie Enyinnaya Official Tutorials about NodeJS & Vue & Nuxt Vue Tutorial Vue's tutorial from vuejs.org MDN - Getting started with Vue MDN's fine introduction about vue NuxtJS - Tutorials Discover tutorials made by the Nuxt community."},{"title":"tags","date":"2022-05-21T07:32:07.000Z","updated":"2022-05-21T07:32:16.953Z","comments":true,"path":"tags/index.html","permalink":"https://marvinliu1.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Hexo - How to add external links","slug":"Adding links into Hexo NexT8 ","date":"2021-05-22T18:11:00.000Z","updated":"2022-05-25T15:23:53.533Z","comments":true,"path":"2021/05/22/Adding links into Hexo NexT8 /","link":"","permalink":"https://marvinliu1.github.io/2021/05/22/Adding%20links%20into%20Hexo%20NexT8%20/","excerpt":"","text":"æœ¬æ–‡è½¬è½½è‡ªCu Blog NexT ä¸»é¢˜è‡ªå¸¦çš„å¹¶æ²¡æœ‰å‹é“¾é¡µé¢ï¼Œæœ¬ç€ â€œå¯ä»¥ä¸ç”¨ä½†å¿…é¡»æœ‰â€ çš„æ€æƒ³ï¼Œæˆ‘é€šè¿‡æœç´¢å¼•æ“æ‰¾åˆ°äº†å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨æ­¤è®°å½•ï¼Œå¸Œæœ›èƒ½å¸®åˆ°å…¶ä»–äººã€‚ NexT ç‰ˆæœ¬ï¼š8.10.1ã€‚ å…ˆçœ‹ä¸€ä¸‹æœ€ç»ˆæ•ˆæœå§ï¼š NexT é…ç½®æ–‡ä»¶ä¿®æ”¹æ‰“å¼€_config.next.yml æ–‡ä»¶ï¼Œæœç´¢_dataï¼Œèƒ½å¤Ÿæ‰¾åˆ°è¿™æ ·ä¸€æ¡è¢«æ³¨é‡Šçš„è¯­å¥ï¼šstyle: source/_data/styles.stylï¼Œå–æ¶ˆæ³¨é‡Šå³å¯ã€‚ ç„¶ååœ¨ source æ–‡ä»¶å¤¹ä¸‹æ–°å»º_data ç›®å½•ï¼Œå¹¶åˆ›å»ºæ–‡ä»¶ styles.stylï¼Œåœ¨é‡Œé¢å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364#links &#123; margin-top: 5rem;&#125;.links-content &#123; margin-top:1rem;&#125;.link-navigation::after &#123; content: &quot; &quot;; display: block; clear: both;&#125;.card &#123; width: 300px; font-size: 1rem; padding: 10px 20px; border-radius: 4px; transition-duration: 0.15s; margin-bottom: 1rem; display:flex;&#125;.card:nth-child(odd) &#123; float: left;&#125;.card:nth-child(even) &#123; float: right;&#125;.card:hover &#123; transform: scale(1.1); box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.12), 0 0 6px 0 rgba(0, 0, 0, 0.04);&#125;.card a &#123; border:none;&#125;.card .ava &#123; width: 3rem!important; height: 3rem!important; margin:0!important; margin-right: 1em!important; border-radius:4px;&#125;.card .card-header &#123; font-style: italic; overflow: hidden; width: 236px;&#125;.card .card-header a &#123; font-style: normal; color: #2bbc8a; font-weight: bold; text-decoration: none;&#125;.card .card-header a:hover &#123; color: #d480aa; text-decoration: none;&#125;.card .card-header .info &#123; font-style:normal; color:#a3a3a3; font-size:14px; min-width: 0; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;&#125; ç„¶åä¿®æ”¹ä¸»é¡µé¢æ¿ï¼š 1å‹é“¾: /links || fas fa-link åˆ›å»ºå‹é“¾é¡µé¢ä½¿ç”¨ hexo new page link å¯ä»¥æ–°å»ºä¸€ä¸ª link é¡µé¢ï¼Œæˆ‘ä»¬å°†å…¶ä½œä¸ºå‹é“¾é¡µé¢ã€‚åˆ›å»ºå®Œæˆåï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼ˆè‡ªå·±ä½¿ç”¨æ—¶è¯·æŒ‰éœ€ä¿®æ”¹ï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142---title: å‹é“¾type: links---&lt;div class=&quot;links-content&quot;&gt;&lt;div class=&quot;no-icon note warning&quot;&gt;&lt;div class=&quot;link-info&quot;&gt;æ¬¢è¿ä¸æˆ‘äº¤æ¢å‹é“¾ï¼&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;link-navigation&quot;&gt;&#123;% for link in site.data.links %&#125;&lt;div class=&quot;card&quot;&gt;&lt;img class=&quot;ava nomediumzoom&quot; src=&quot;&#123;&#123; link.avatar &#125;&#125;&quot;/&gt;&lt;div class=&quot;card-header&quot;&gt;&lt;div&gt;&lt;a href=&quot;&#123;&#123; link.site &#125;&#125;&quot; target=&quot;_blank&quot;&gt; &#123;&#123; link.name &#125;&#125;&lt;/a&gt; &lt;/div&gt;&lt;div class=&quot;info&quot;&gt;&#123;&#123; link.info &#125;&#125;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&#123;% endfor %&#125;&lt;/div&gt;------&#123;% note success %&#125;**å‹é“¾ç”³è¯·æ¡ä»¶ï¼š**- ç½‘ç«™å†…å®¹ç¬¦åˆä¸­å›½å¤§é™†æ³•å¾‹- å·²å¼€å¯HTTPSï¼Œä¸”è‡³å°‘æœ‰3ç¯‡åšå®¢ï¼Œæœ€æ–°ä¸€ç¯‡ä¸ºä¸‰ä¸ªæœˆä¹‹å†…å‘è¡¨- ç½‘ç«™å†…å®¹ä»¥åŸåˆ›ä¸ºä¸»ï¼ŒæŠ€æœ¯æ€§åšå®¢ä¼˜å…ˆï¼Œå¨±ä¹æ€§åšå®¢é™¤éç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œå¦åˆ™ä¸ä¼šè€ƒè™‘**å‹é“¾æ ¼å¼ï¼š**```yaml- name: Cu Blog site: https://www.litcu.cn info: å®‰å…¨æ–°äººå°é†‹çš„å¿«ä¹æ”¶é›†å¤„ avatar: https://img.litcu.cn/avatar/avatar1.jpg```&#123;% endnote %&#125; æ ¸å¿ƒæ˜¯ HTML ä»£ç ä¸­çš„é‚£ä¸ª for å¾ªç¯ï¼Œsite.data å°±æ˜¯ source/_data ç›®å½•ï¼Œåé¢çš„ links å°±æ˜¯æˆ‘ä»¬ä¹‹åè¦åˆ›å»ºçš„ links.yml å‹é“¾æ–‡ä»¶ã€‚å¦‚æœåç»­æ²¡æœ‰æ­£å¸¸æ˜¾ç¤ºå‹é“¾ï¼Œå¯ä»¥çœ‹çœ‹è¿™é‡Œæ˜¯å¦å‡ºç°äº†é—®é¢˜ã€‚ æ·»åŠ å‹é“¾åœ¨ source/_data/ ç›®å½•ä¸‹æ–°å»º link.yml æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼š 1234- name: Cu Blog site: https://www.litcu.cn info: å®‰å…¨æ–°äººå°é†‹çš„å¿«ä¹æ”¶é›†å¤„ avatar: https://img.litcu.cn/avatar/avatar1.jpg ç„¶å hexo cl &amp;&amp; hexo g &amp;&amp; hexo s å°±å¯ä»¥çœ‹åˆ°æ•ˆæœå•¦ï¼","categories":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/categories/Hexo/"}],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/tags/Hexo/"}]},{"title":"How To Implement Authentication in a Nuxt.js App","slug":"How-To-Implement-Auth-in-Nuxt","date":"2020-09-25T06:12:31.000Z","updated":"2022-05-24T22:31:18.910Z","comments":true,"path":"2020/09/25/How-To-Implement-Auth-in-Nuxt/","link":"","permalink":"https://marvinliu1.github.io/2020/09/25/How-To-Implement-Auth-in-Nuxt/","excerpt":"","text":"Original published and copy-righted by Chimezie EnyinnayaView more on digitalocean.com IntroductionIn this tutorial, youâ€™ll implement authentication in a Nuxt.js app using the Auth module. For the purpose of this tutorial, youâ€™ll be using JWT for authentication. Below is a quick demo of what youâ€™ll be building in this tutorial: You can find the source code for this application at GitHub. Warning: Several of the packages in this tutorial now contain dependencies with known vulnerabilities. In a production setting, you would resolve these issues by upgrading these packages, finding alternatives, or creating forked versions with patched fixes. However, within the limited context of a tutorial, it provides educational value as-is. PrerequisitesTo complete this tutorial, you will need: Node.js installed locally, which you can do by following How to Install Node.js and Create a Local Development Environment. A valid Git installation is optionally required for cloning the API, consult Getting Started with Git. Some familiarity with Vue.js and Nuxt.js may be beneficial. You can refer to this post if youâ€™re getting started with Nuxt.js. This tutorial was verified with Node v13.13.0, npm v6.14.4, vue v2.6.11, and nuxt v2.12.2. Step 1 â€” Spinning up a Sample APIYou are free to use whatever framework that works best for you. However, for quick development, this tutorial will clone an API built with AdonisJs. The API utilizes: JWT (JSON Web Tokens) for authentication SQLite CORS enabled The API has three endpoints: /register: endpoint for user registration /login: endpoint for authenticating users /me: endpoint for getting details for the currently authenticated user and it is protected by an auth middleware, which means a user must be authenticated to access the endpoint First, run the following command in your terminal window: 1git clone https://github.com/do-community/jwt-auth-api.git Copy Then, navigate to the project directory: 1cd jwt-auth-api Copy And install the API dependencies: 1npm install Copy Note: When running install, you may encounter issues with sqlite3 version 4.0.1 depending on the version of Node you are running. Refer to the changelog to determine compatibility with your environment. At the time of original publication, the latest version of Node was 10. One option is to downgrade your version of Node to 10.20.1 (with the understanding that it is nearing end-of-life support). Then, run npm install. A second option is to remove the package-lock.json file which will cause the system to look for 4.2.0 which is supported up to Node 13. You may need to also downgrade your version of Node to 13.13.0. Then, run npm install. A third option would be to modify package.json to a version of sqlite3 supported by your current version of Node, remove package-lock.json, and run npm install. However, at the time of testing, 5.0.0 is not yet released to handle Node 14+ support. Other symptoms of incompatibility include the following errors: TypeError: Cannot read property &#39;data&#39; of undefined and Error: Cannot find module &#39;[...]/node_modules/sqlite3/lib/binding/[...]/node_sqlite3.node&#39;. Next, rename .env.example to .env: 1mv .env.example .env Copy And generate an APP_KEY: 1npx @adonisjs/cli@4.0.12 key:generate Copy You should see: 1Outputgenerated: unique APP_KEY Copy Once thatâ€™s coomplete, letâ€™s run the migrations: 1npx @adonisjs/cli@4.0.12 migration:run Copy Now, you can start the API: 12# ensure that you are in the `jwt-auth-api` project directorynpm start Copy You can access the API on http://127.0.0.1:3333/api. Leave this running in a terminal window for the rest of the duration of the tutorial. Step 2 â€” Creating a Nuxt.js AppNow, you can create a Nuxt.js app. Open a new terminal window and use vue-cli to initialize a new Vue project with the Nuxt starter template: 1npx vue-cli@2.9.6 init nuxt/starter nuxt-auth Copy Note: At the time of testing, vue-cli is deprecated. @vue/cli is the current command line tool for Vue projects. And @vue/cli-init is the recommended approach for legacy vue-cli projects. However, create-nuxt-app is the recommended approach for modern Nuxt projects. Next, you need to navigate to the project directory: 1cd nuxt-auth Copy And install the dependencies: 1npm install Then, you can launch the app: 1npm run dev Copy The app should be running on http://localhost:3000. You can view the application in a web browser to see the default Vue application created by vue-cli. Step 3 â€” Installing Necessary Nuxt.js ModulesNow, letâ€™s install the Nuxt.js modules that youâ€™ll be needing for your app. Youâ€™ll be using the Nuxt Auth module and the Nuxt Axios module, since the auth module makes use of Axios internally: 12# ensure that you are in the `nuxt-auth` project directorynpm install @nuxtjs/auth@4.5.1 @nuxtjs/axios@5.3.1 --save Copy Once thatâ€™s completed, open nuxt.config.js: 1nano nuxt.config.js Copy Add the code below to nuxt.config.js: nuxt.config.js 12345678module.exports = &#123; // ... modules: [ &#x27;@nuxtjs/axios&#x27;, &#x27;@nuxtjs/auth&#x27; ],&#125; Copy Note: At this point, newer versions of Nuxt may encounter the error: Enable vuex store by creating &#39;store/index.js&#39;. This error can be resolved by adding an empty index.js file to the store directory. Next, you need to set up the modules. Paste the code below into nuxt.config.js: nuxt.config.js 12345678910111213141516171819module.exports = &#123; // ... axios: &#123; baseURL: &#x27;http://127.0.0.1:3333/api&#x27; &#125;, auth: &#123; strategies: &#123; local: &#123; endpoints: &#123; login: &#123; url: &#x27;login&#x27;, method: &#x27;post&#x27;, propertyName: &#x27;data.token&#x27; &#125;, user: &#123; url: &#x27;me&#x27;, method: &#x27;get&#x27;, propertyName: &#x27;data&#x27; &#125;, logout: false &#125; &#125; &#125; &#125;&#125; Copy Here, you set the base URL that Axios will use when making requests. In our case, we are referencing the sample API we set up earlier. Then, you define the authentication endpoints for the local strategy corresponding to those on your API: On successful authentication, the token will be available in the response as a token object inside a data object. Similarly, the response from the /me endpoint will be inside a data object. Lastly, you set logout to false since your API doesnâ€™t have an endpoint for logout. Youâ€™ll just remove the token from localStorage when a user logs out. Step 4 â€” Creating a Navbar ComponentTo style your app, you can make use of Bulma. Open nuxt.config.js and paste the code below within the link object that is inside the head object: nuxt.config.js 1234567891011121314module.exports = &#123; // ... head: &#123; // ... link [ // ... &#123; rel: &#x27;stylesheet&#x27;, href: &#x27;https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css&#x27; &#125; ] &#125;, // ...&#125; Copy Now, letâ€™s create the Navbar component: 1nano components/Navbar.vue Copy And add the following code: components&#x2F;Navbar.vue 1234567891011121314151617181920212223242526272829303132&lt;template&gt; &lt;nav class=&quot;navbar is-light&quot;&gt; &lt;div class=&quot;container&quot;&gt; &lt;div class=&quot;navbar-brand&quot;&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/&quot;&gt;Nuxt Auth&lt;/nuxt-link&gt; &lt;button class=&quot;button navbar-burger&quot;&gt; &lt;span&gt;&lt;/span&gt; &lt;span&gt;&lt;/span&gt; &lt;span&gt;&lt;/span&gt; &lt;/button&gt; &lt;/div&gt; &lt;div class=&quot;navbar-menu&quot;&gt; &lt;div class=&quot;navbar-end&quot;&gt; &lt;div class=&quot;navbar-item has-dropdown is-hoverable&quot;&gt; &lt;a class=&quot;navbar-link&quot;&gt; My Account &lt;/a&gt; &lt;div class=&quot;navbar-dropdown&quot;&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/profile&quot;&gt;My Profile&lt;/nuxt-link&gt; &lt;hr class=&quot;navbar-divider&quot;/&gt; &lt;a class=&quot;navbar-item&quot;&gt;Logout&lt;/a&gt; &lt;/div&gt; &lt;/div&gt; &lt;template&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/register&quot;&gt;Register&lt;/nuxt-link&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/login&quot;&gt;Log In&lt;/nuxt-link&gt; &lt;/template&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/nav&gt;&lt;/template&gt; Copy The Navbar component contains links to login, register, profile, and logout. Next, letâ€™s update the default layout to make use of the Navbar component. Open default.vue: 1nano layouts/default.vue Copy And replace the content with the following: layouts&#x2F;default.vue 12345678910111213141516&lt;template&gt; &lt;div&gt; &lt;Navbar/&gt; &lt;nuxt/&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;import Navbar from &#x27;~/components/Navbar&#x27;export default &#123; components: &#123; Navbar &#125;&#125;&lt;/script&gt; Copy Also, letâ€™s update the homepage. Open index.vue: 1nano pages/index.vue Copy And replace the content with the following: pages&#x2F;index.vue 1234567&lt;template&gt; &lt;section class=&quot;section&quot;&gt; &lt;div class=&quot;container&quot;&gt; &lt;h1 class=&quot;title&quot;&gt;Nuxt Auth&lt;/h1&gt; &lt;/div&gt; &lt;/section&gt;&lt;/template&gt; Copy At this point, you should have an application that displays a title of &quot;Nuxt Auth&quot; with a header bar with navigation links: Step 5 â€” Handling User RegistrationInside the pages directory, create a new register.vue file: 1nano pages/register.vue Copy And add the following code: pages&#x2F;register.vue 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101&lt;template&gt; &lt;section class=&quot;section&quot;&gt; &lt;div class=&quot;container&quot;&gt; &lt;div class=&quot;columns&quot;&gt; &lt;div class=&quot;column is-4 is-offset-4&quot;&gt; &lt;h2 class=&quot;title has-text-centered&quot;&gt;Register!&lt;/h2&gt; &lt;Notification :message=&quot;error&quot; v-if=&quot;error&quot;/&gt; &lt;form method=&quot;post&quot; @submit.prevent=&quot;register&quot;&gt; &lt;div class=&quot;field&quot;&gt; &lt;label class=&quot;label&quot;&gt;Username&lt;/label&gt; &lt;div class=&quot;control&quot;&gt; &lt;input type=&quot;text&quot; class=&quot;input&quot; name=&quot;username&quot; v-model=&quot;username&quot; required /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;field&quot;&gt; &lt;label class=&quot;label&quot;&gt;Email&lt;/label&gt; &lt;div class=&quot;control&quot;&gt; &lt;input type=&quot;email&quot; class=&quot;input&quot; name=&quot;email&quot; v-model=&quot;email&quot; required /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;field&quot;&gt; &lt;label class=&quot;label&quot;&gt;Password&lt;/label&gt; &lt;div class=&quot;control&quot;&gt; &lt;input type=&quot;password&quot; class=&quot;input&quot; name=&quot;password&quot; v-model=&quot;password&quot; required /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;control&quot;&gt; &lt;button type=&quot;submit&quot; class=&quot;button is-dark is-fullwidth&quot;&gt;Register&lt;/button&gt; &lt;/div&gt; &lt;/form&gt; &lt;div class=&quot;has-text-centered&quot; style=&quot;margin-top: 20px&quot;&gt; Already got an account? &lt;nuxt-link to=&quot;/login&quot;&gt;Login&lt;/nuxt-link&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/section&gt;&lt;/template&gt;&lt;script&gt;import Notification from &#x27;~/components/Notification&#x27;export default &#123; components: &#123; Notification, &#125;, data() &#123; return &#123; username: &#x27;&#x27;, email: &#x27;&#x27;, password: &#x27;&#x27;, error: null &#125; &#125;, methods: &#123; async register() &#123; try &#123; await this.$axios.post(&#x27;register&#x27;, &#123; username: this.username, email: this.email, password: this.password &#125;) await this.$auth.loginWith(&#x27;local&#x27;, &#123; data: &#123; email: this.email, password: this.password &#125;, &#125;) this.$router.push(&#x27;/&#x27;) &#125; catch (e) &#123; this.error = e.response.data.message &#125; &#125; &#125;&#125;&lt;/script&gt; Copy This contains a form with three fields: username, email, and password. Each field is bound to corresponding data on the component. When the form is submitted, a register method will be called. Using the Axios module, you make a post request to the /register endpoint, passing along the user data. If the registration was successful, you make use of the Auth moduleâ€™s loginWith(), using the local strategy and passing the user data to log the user in. Then, you redirect the user to the homepage. If there is an error during the registration, you set the error data as the error message gotten from the API response. If there is an error, the error message is displayed by a Notification component. Create a new Notification.vue file inside components: 1nano components/Notifaction.vue Copy And paste the code below in it: components&#x2F;Notification.vue 123456789101112&lt;template&gt; &lt;div class=&quot;notification is-danger&quot;&gt; &#123;&#123; message &#125;&#125; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;export default &#123; name: &#x27;Notification&#x27;, props: [&#x27;message&#x27;]&#125;&lt;/script&gt; Copy The Notification component accepts a message props, which is the error message. Now, you can test out user registration: Step 6 â€” Handling LoggedUsers Logged In and Logged OutUpon successful registration, users should be logged in but there is currently no way for the app to know whether users are logged in or not. So letâ€™s fix that by updating the Navbar component and adding some computed properties. Before you do just that, letâ€™s first activate the Vuex store by creating an index.js file inside the store directory. The Auth module stores user authentication status as well as user details inside Vuex state in an auth object. So you can check if a user is logged in or not with this.$store.state.auth.loggedIn, which will either return true or false. Similarly, you can get a userâ€™s details with this.$store.state.auth.user, which will be null if no user is logged in. Note: You can also access the user authentication status as well as the user details directly with the Auth module using this.$auth.loggedIn and this.$auth.user respectively. Since you might want to use the computed properties in multiple places in your app, letâ€™s create store getters. Open index.js: 1nano store/index.js Copy And paste the code below in it: store&#x2F;index.js 123456789export const getters = &#123; isAuthenticated(state) &#123; return state.auth.loggedIn &#125;, loggedInUser(state) &#123; return state.auth.user &#125;&#125; Copy Here, you create two getters. The first one (isAuthenticated) will return the authentication status of a user and the second (loggedInUser) will return the details or the logged in user. Next, letâ€™s update the Navbar component to make use of the getters. Replace the content of components/Navbar.vue with the following: components&#x2F;Navbar.vue 123456789101112131415161718192021222324252627282930313233343536373839404142&lt;template&gt; &lt;nav class=&quot;navbar is-light&quot;&gt; &lt;div class=&quot;container&quot;&gt; &lt;div class=&quot;navbar-brand&quot;&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/&quot;&gt;Nuxt Auth&lt;/nuxt-link&gt; &lt;button class=&quot;button navbar-burger&quot;&gt; &lt;span&gt;&lt;/span&gt; &lt;span&gt;&lt;/span&gt; &lt;span&gt;&lt;/span&gt; &lt;/button&gt; &lt;/div&gt; &lt;div class=&quot;navbar-menu&quot;&gt; &lt;div class=&quot;navbar-end&quot;&gt; &lt;div class=&quot;navbar-item has-dropdown is-hoverable&quot; v-if=&quot;isAuthenticated&quot;&gt; &lt;a class=&quot;navbar-link&quot;&gt; &#123;&#123; loggedInUser.username &#125;&#125; &lt;/a&gt; &lt;div class=&quot;navbar-dropdown&quot;&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/profile&quot;&gt;My Profile&lt;/nuxt-link&gt; &lt;hr class=&quot;navbar-divider&quot;/&gt; &lt;a class=&quot;navbar-item&quot;&gt;Logout&lt;/a&gt; &lt;/div&gt; &lt;/div&gt; &lt;template v-else&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/register&quot;&gt;Register&lt;/nuxt-link&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/login&quot;&gt;Log In&lt;/nuxt-link&gt; &lt;/template&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/nav&gt;&lt;/template&gt;&lt;script&gt;import &#123; mapGetters &#125; from &#x27;vuex&#x27;export default &#123; computed: &#123; ...mapGetters([&#x27;isAuthenticated&#x27;, &#x27;loggedInUser&#x27;]) &#125;&#125;&lt;/script&gt; Copy You create the computed properties by using the spread operator (...) to extract the getters from mapGetters. Then using isAuthenticated, you display the user menu or links to login or register depending on whether the user is logged in or not. Also, you use loggedInUser to display the authenticated user username. Now, if you give your app a refresh, you should see something similar to below: Step 7 â€” Handling User Log InNow, letâ€™s allow returning users the ability to log in. Create a new login.vue file inside the pages directory: 1nano pages/login.vue And paste the code below in it: pages&#x2F;login.vue 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081&lt;template&gt; &lt;section class=&quot;section&quot;&gt; &lt;div class=&quot;container&quot;&gt; &lt;div class=&quot;columns&quot;&gt; &lt;div class=&quot;column is-4 is-offset-4&quot;&gt; &lt;h2 class=&quot;title has-text-centered&quot;&gt;Welcome back!&lt;/h2&gt; &lt;Notification :message=&quot;error&quot; v-if=&quot;error&quot;/&gt; &lt;form method=&quot;post&quot; @submit.prevent=&quot;login&quot;&gt; &lt;div class=&quot;field&quot;&gt; &lt;label class=&quot;label&quot;&gt;Email&lt;/label&gt; &lt;div class=&quot;control&quot;&gt; &lt;input type=&quot;email&quot; class=&quot;input&quot; name=&quot;email&quot; v-model=&quot;email&quot; /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;field&quot;&gt; &lt;label class=&quot;label&quot;&gt;Password&lt;/label&gt; &lt;div class=&quot;control&quot;&gt; &lt;input type=&quot;password&quot; class=&quot;input&quot; name=&quot;password&quot; v-model=&quot;password&quot; /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;control&quot;&gt; &lt;button type=&quot;submit&quot; class=&quot;button is-dark is-fullwidth&quot;&gt;Log In&lt;/button&gt; &lt;/div&gt; &lt;/form&gt; &lt;div class=&quot;has-text-centered&quot; style=&quot;margin-top: 20px&quot;&gt; &lt;p&gt; Don&#x27;t have an account? &lt;nuxt-link to=&quot;/register&quot;&gt;Register&lt;/nuxt-link&gt; &lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/section&gt;&lt;/template&gt;&lt;script&gt;import Notification from &#x27;~/components/Notification&#x27;export default &#123; components: &#123; Notification, &#125;, data() &#123; return &#123; email: &#x27;&#x27;, password: &#x27;&#x27;, error: null &#125; &#125;, methods: &#123; async login() &#123; try &#123; await this.$auth.loginWith(&#x27;local&#x27;, &#123; data: &#123; email: this.email, password: this.password &#125; &#125;) this.$router.push(&#x27;/&#x27;) &#125; catch (e) &#123; this.error = e.response.data.message &#125; &#125; &#125;&#125;&lt;/script&gt; Copy This is quite similar to the register page. The form contains two fields: email and password. When the form is submitted, a login method will be called. Using the Auth module loginWith() and passing along the user data, you log the user in. If the authentication was successful, you redirect the user to the homepage. Otherwise, set error to the error message gotten from the API response. Again, you are using the Notification component from earlier on to display the error message. Step 8 â€” Displaying the User ProfileLetâ€™s allow logged in users to view their profile. Create a new profile.vue file inside the pages directory: 1nano pages/profile.vue Copy And paste the code below in it: pages&#x2F;profile.vue 123456789101112131415161718192021222324252627&lt;template&gt; &lt;section class=&quot;section&quot;&gt; &lt;div class=&quot;container&quot;&gt; &lt;h2 class=&quot;title&quot;&gt;My Profile&lt;/h2&gt; &lt;div class=&quot;content&quot;&gt; &lt;p&gt; &lt;strong&gt;Username:&lt;/strong&gt; &#123;&#123; loggedInUser.username &#125;&#125; &lt;/p&gt; &lt;p&gt; &lt;strong&gt;Email:&lt;/strong&gt; &#123;&#123; loggedInUser.email &#125;&#125; &lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;/section&gt;&lt;/template&gt;&lt;script&gt;import &#123; mapGetters &#125; from &#x27;vuex&#x27;export default &#123; computed: &#123; ...mapGetters([&#x27;loggedInUser&#x27;]) &#125;&#125;&lt;/script&gt; Copy Notice how you are using the loggedInUser getter from earlier on to display the user details. Clicking on the My Profile link should result in a My Profile page being displayed. Step 9 â€” Logging Users OutUpdate the logout link inside the Navbar component. Open Navbar.vue: 1nano components/Navbar.vue Copy Modify the logout link to use @click=&quot;logout&quot;: components&#x2F;Navbar.vue 1234567// ...&lt;div class=&quot;navbar-dropdown&quot;&gt; &lt;nuxt-link class=&quot;navbar-item&quot; to=&quot;/profile&quot;&gt;My Profile&lt;/nuxt-link&gt; &lt;hr class=&quot;navbar-divider&quot;/&gt; &lt;a class=&quot;navbar-item&quot; @click=&quot;logout&quot;&gt;Logout&lt;/a&gt;&lt;/div&gt;// ... Copy When the logout link is clicked, it will trigger a logout method. Next, letâ€™s add the logout method inside the script section of the Navbar component: components&#x2F;Navbar.vue 12345678910// ...export default &#123; // ... methods: &#123; async logout() &#123; await this.$auth.logout(); &#125;, &#125;,&#125; Copy You call the logout() of the Auth module. This will delete the userâ€™s token from localstorage and redirect the user to the homepage. Step 10 â€” Restricting the Profile PageAs it stands now, anybody can visit the profile page. And if the user is not logged in, it will result in an error. To fix this, you need to restrict the profile page to only logged in users. Luckily for us, you can achieve that with the Auth module. The Auth module comes with an auth middleware, which you can use in this scenario. So letâ€™s add the auth middleware to the profile page. Update the script section as below: pages&#x2F;profile.vue 123456// ...export default &#123; middleware: &#x27;auth&#x27;, // ...&#125; Copy Now when a user that is not logged in tries to visit the profile page, the user will be redirected to the login page. Step 11 â€” Creating a Guest MiddlewareAgain as it stands, even as a logged in user, you can still access the login and register pages. One way to fix that is to restrict login and register pages to only users that are not logged in. You can do that by creating a guest middleware. Inside the middleware directory, create a new guest.js file: 1nano middleware/guest.js Copy And paste the code below in it: middleware&#x2F;guest.js 12345export default function (&#123; store, redirect &#125;) &#123; if (store.state.auth.loggedIn) &#123; return redirect(&#x27;/&#x27;) &#125;&#125; Copy A middleware accepts the context as its first argument. So you extract store and redirect from the context. Then, you check if the user is logged in then redirect the user to the homepage. Otherwise, you allow the normal execution of the request. Next, letâ€™s make use of this middleware. Update the script section of both login and register as below: pages&#x2F;login.vue and pages&#x2F;register.vue 123456// ...export default &#123; middleware: &#x27;guest&#x27;, // ...&#125; Copy Now, everything will be working as expected. ConclusionIn this tutorial, you looked at how to implement authentication in a Nuxt.js application using the Auth module. You also saw how to keep the authentication flow sleek by making use of middleware. To learn more about the Auth module, check out the docs. If youâ€™d like to learn more about Vue.js, check out our Vue.js topic page for exercises and programming projects.","categories":[{"name":"Nuxt","slug":"Nuxt","permalink":"https://marvinliu1.github.io/categories/Nuxt/"}],"tags":[{"name":"NeXt","slug":"NeXt","permalink":"https://marvinliu1.github.io/tags/NeXt/"},{"name":"Vue","slug":"Vue","permalink":"https://marvinliu1.github.io/tags/Vue/"}]},{"title":"Markdown Handbook","slug":"Markdownå…¬å¼ç”¨æ³•å¤§å…¨","date":"2020-05-21T06:12:31.000Z","updated":"2022-05-25T04:06:46.126Z","comments":true,"path":"2020/05/21/Markdownå…¬å¼ç”¨æ³•å¤§å…¨/","link":"","permalink":"https://marvinliu1.github.io/2020/05/21/Markdown%E5%85%AC%E5%BC%8F%E7%94%A8%E6%B3%95%E5%A4%A7%E5%85%A8/","excerpt":"","text":"åŸºæœ¬è¯­æ³•Markdownæ˜¯ä¸€ç§è½»é‡çº§æ ‡è®°è¯­è¨€ 123456789# ä¸€çº§æ ‡é¢˜## äºŒçº§æ ‡é¢˜### ä¸‰çº§æ ‡é¢˜#### å››çº§æ ‡é¢˜##### äº”çº§æ ‡é¢˜###### å…­çº§æ ‡é¢˜**åŠ ç²—***æ–œä½“*==é«˜äº®== ä¸¤ç§ä»£ç å¼•ç”¨æ–¹å¼1``å¼æˆ–```å¼ æ’å…¥é“¾æ¥å¹¶æè¿°1[åšå®¢](https://www.cnblogs.com/ &quot;åšå®¢&quot;) æ’å…¥å›¾ç‰‡1![è·¯é£](https://pic.baike.soso.com/ugc/baikepic2/0/ori-20190529230042-1249666563_jpeg_640_960_59726.jpg/800 &#x27;è·¯é£&#x27;) æœ‰åºåˆ—è¡¨1231.one2.two3.three æ— åºåˆ—è¡¨123* one* two* three åˆ†å‰²çº¿1--- è¡¨æ ¼123name | age | sex:-: | :- | -:tony|20|ç”· name age sex tony 20 ç”· æ³¨ï¼šä»£ç ä¸­ç¬¬äºŒè¡Œåˆ†åˆ«è¡¨ç¤ºå±…ä¸­ï¼Œå³å¯¹é½ï¼Œå·¦å¯¹é½ï¼Œè‹¥ç»“æœä¸æ˜¾ç¤ºï¼Œè½¬åŒ–æˆæºä»£ç æ¨¡å¼å»æ‰è¡Œä¸è¡Œä¹‹é—´çš„ç©ºè¡Œã€‚ å¦‚ä½•æ’å…¥å…¬å¼æ•°å­¦å…¬å¼æœ‰ä¸¤ç§ï¼šè¡Œä¸­å…¬å¼ï¼ˆä¸æ–‡å­—æ­é…ä½¿ç”¨ï¼‰å’Œç‹¬ç«‹å…¬å¼ï¼ˆç‹¬ç«‹æˆè¡Œï¼‰ è¡Œå†…å…¬å¼è¡¨ç¤ºï¼š$ æ•°å­¦å…¬å¼ $ ç‹¬ç«‹å…¬å¼è¡¨ç¤ºï¼š$$ æ•°å­¦å…¬å¼ $$ å¦‚ä½•è¾“å…¥ä¸Šä¸‹æ ‡^ è¡¨ç¤ºä¸Šæ ‡, _ è¡¨ç¤ºä¸‹æ ‡ã€‚å¦‚æœä¸Šä¸‹æ ‡çš„å†…å®¹å¤šäºä¸€ä¸ªå­—ç¬¦ï¼Œéœ€è¦ç”¨ &#123;&#125; å°†è¿™äº›å†…å®¹æ‹¬æˆä¸€ä¸ªæ•´ä½“ã€‚ä¸Šä¸‹æ ‡å¯ä»¥åµŒå¥—ï¼Œä¹Ÿå¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚ å¦‚ï¼š$$ x^&#123;y^z&#125;=(1+&#123;\\rm e&#125;^x)^&#123;-2xy^w&#125; $$,æ˜¾ç¤ºï¼š$x{yz}&#x3D;(1+{\\rm e}x){-2xy^w} $ å¦å¤–ï¼Œå¦‚æœè¦åœ¨å·¦å³ä¸¤è¾¹éƒ½æœ‰ä¸Šä¸‹æ ‡ï¼Œå¯ä»¥ç”¨ \\sideset å‘½ä»¤ã€‚ å¦‚ï¼š$$ \\sideset&#123;^1_2&#125;&#123;^3_4&#125;\\bigotimes $$,æ˜¾ç¤ºï¼š$ \\sideset{1_2}{3_4}\\bigotimes $ å¦‚ä½•è¾“å…¥æ‹¬å·å’Œåˆ†éš”ç¬¦()ã€[] å’Œ | è¡¨ç¤ºç¬¦å·æœ¬èº«ï¼Œä½¿ç”¨ \\&#123;\\&#125; æ¥è¡¨ç¤º &#123;&#125; ã€‚å½“è¦æ˜¾ç¤ºå¤§å·çš„æ‹¬å·æˆ–åˆ†éš”ç¬¦æ—¶ï¼Œè¦ç”¨ \\left å’Œ \\right å‘½ä»¤ã€‚ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\langle âŸ¨âŸ¨ \\rangle âŸ©âŸ© \\lceil âŒˆâŒˆ \\rceil âŒ‰âŒ‰ \\lfloor âŒŠâŒŠ \\rfloor âŒ‹âŒ‹ \\lbrace { { \\rbrace } } å¦‚ï¼š$$ f(x,y,z) = 3y^2z \\left( 3+\\frac&#123;7x+5&#125;&#123;1+y^2&#125; \\right) $$,æ˜¾ç¤ºï¼šf(x,y,z)&#x3D;3y2z(3+7x+51+y2)f(x,y,z)&#x3D;3y2z(3+7x+51+y2) æœ‰æ—¶å€™è¦ç”¨ \\left. æˆ– \\right. è¿›è¡ŒåŒ¹é…è€Œä¸æ˜¾ç¤ºæœ¬èº«ã€‚ å¦‚ï¼š$$ \\left. \\frac&#123;&#123;\\rm d&#125;u&#125;&#123;&#123;\\rm d&#125;x&#125; \\right| _&#123;x=0&#125; $$`,æ˜¾ç¤ºï¼š[MathProcessingError]dudxâˆ£âˆ£x=0[MathProcessingError]dudx|x=0 ### å¦‚ä½•è¾“å…¥åˆ†æ•° é€šå¸¸ä½¿ç”¨ `\\frac &#123;åˆ†å­&#125; &#123;åˆ†æ¯&#125;` å‘½ä»¤äº§ç”Ÿä¸€ä¸ªåˆ†æ•°ï¼Œåˆ†æ•°å¯åµŒå¥—ã€‚ä¾¿æ·æƒ…å†µå¯ç›´æ¥è¾“å…¥ `\\frac ab` æ¥å¿«é€Ÿç”Ÿæˆä¸€ä¸ª abab ã€‚ å¦‚æœåˆ†å¼å¾ˆå¤æ‚ï¼Œäº¦å¯ä½¿ç”¨ `åˆ†å­ \\over åˆ†æ¯` å‘½ä»¤ï¼Œæ­¤æ—¶åˆ†æ•°ä»…æœ‰ä¸€å±‚ã€‚ å¦‚ï¼š`$$ \\frac&#123;a-1&#125;&#123;b-1&#125; \\quad and \\quad &#123;a+1\\over b+1&#125; $$`,æ˜¾ç¤ºï¼šaâˆ’1bâˆ’1anda+1b+1aâˆ’1bâˆ’1anda+1b+1 ### å¦‚ä½•è¾“å…¥å¼€æ–¹ ä½¿ç”¨ `\\sqrt [æ ¹æŒ‡æ•°ï¼Œçœç•¥æ—¶ä¸º2] &#123;è¢«å¼€æ–¹æ•°&#125;` å‘½ä»¤è¾“å…¥å¼€æ–¹ã€‚ å¦‚ï¼š`$$ \\sqrt&#123;2&#125; \\quad and \\quad \\sqrt[n]&#123;3&#125; $$`,æ˜¾ç¤ºï¼š2â€“âˆšand3â€“âˆšn2and3n ### å¦‚ä½•è¾“å…¥çœç•¥å· æ•°å­¦å…¬å¼ä¸­å¸¸è§çš„çœç•¥å·æœ‰ä¸¤ç§ï¼Œ`\\ldots` è¡¨ç¤ºä¸æ–‡æœ¬åº•çº¿å¯¹é½çš„çœç•¥å·ï¼Œ`\\cdots` è¡¨ç¤ºä¸æ–‡æœ¬ä¸­çº¿å¯¹é½çš„çœç•¥å·ã€‚ å¦‚ï¼š`$$ f(x_1,x_2,\\underbrace&#123;\\ldots&#125;_&#123;\\rm ldots&#125; ,x_n) = x_1^2 + x_2^2 + \\underbrace&#123;\\cdots&#125;_&#123;\\rm cdots&#125; + x_n^2 $$`,æ˜¾ç¤ºï¼š$ f(x_1,x_2,\\underbrace&#123;\\ldots&#125;*&#123;\\rm ldots&#125; ,x_n) = x_1^2 + x_2^2 + \\underbrace&#123;\\cdots&#125;*&#123;\\rm cdots&#125; + x_n^2 $ ### å¦‚ä½•è¾“å…¥çŸ¢é‡ ä½¿ç”¨ `\\vec&#123;çŸ¢é‡&#125;` æ¥è‡ªåŠ¨äº§ç”Ÿä¸€ä¸ªçŸ¢é‡ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `\\overrightarrow` ç­‰å‘½ä»¤è‡ªå®šä¹‰å­—æ¯ä¸Šæ–¹çš„ç¬¦å·ã€‚ å¦‚ï¼š`$$ \\vec&#123;a&#125; \\cdot \\vec&#123;b&#125;=0 $$`,æ˜¾ç¤ºï¼š aâƒ— â‹…bâƒ— =0aâ†’â‹…bâ†’=0 å¦‚ï¼š`$$ \\overleftarrow&#123;xy&#125; \\quad and \\quad \\overleftrightarrow&#123;xy&#125; \\quad and \\quad \\overrightarrow&#123;xy&#125; $$`,æ˜¾ç¤ºï¼š xyâ†âˆ’andxyâ†â†’andxyâˆ’â†’xyâ†andxyâ†”andxyâ†’ ### å¦‚ä½•è¾“å…¥ç§¯åˆ† ä½¿ç”¨ `\\int_ç§¯åˆ†ä¸‹é™^ç§¯åˆ†ä¸Šé™ &#123;è¢«ç§¯è¡¨è¾¾å¼&#125;` æ¥è¾“å…¥ä¸€ä¸ªç§¯åˆ†ã€‚ å¦‚ï¼š`$$ \\int_0^1 &#123;x^2&#125; \\,&#123;\\rm d&#125;x $$`,æ˜¾ç¤ºï¼šâˆ«10x2,dxâˆ«01x2,dx,ä¾‹ä¸­ `\\,` å’Œ `&#123;\\rm d&#125;` éƒ¨åˆ†å¯çœç•¥ï¼Œå»ºè®®åŠ å…¥ï¼Œä½¿å¼å­æ›´ç¾è§‚ã€‚ ### å¦‚ä½•è¾“å…¥æé™è¿ç®— ä½¿ç”¨ `\\lim_&#123;å˜é‡ \\to è¡¨è¾¾å¼&#125; è¡¨è¾¾å¼` æ¥è¾“å…¥ä¸€ä¸ªæé™ã€‚å¦‚æœ‰éœ€æ±‚ï¼Œå¯ä»¥æ›´æ”¹ `\\to` ç¬¦å·è‡³ä»»æ„ç¬¦å·ã€‚ å¦‚ï¼š`$$ \\lim_&#123;n \\to +\\infty&#125; \\frac&#123;1&#125;&#123;n(n+1)&#125; \\quad and \\quad \\lim_&#123;x\\leftarrow&#123;ç¤ºä¾‹&#125;&#125; \\frac&#123;1&#125;&#123;n(n+1)&#125; $$,æ˜¾ç¤ºï¼š limnâ†’+âˆ1n(n+1)andlimxâ†ç¤ºä¾‹1n(n+1)limnâ†’+âˆ1n(n+1)andlimxâ†ç¤ºä¾‹1n(n+1) å¦‚ä½•è¾“å…¥ç´¯åŠ ã€ç´¯ä¹˜è¿ç®—ä½¿ç”¨ \\sum_&#123;ä¸‹æ ‡è¡¨è¾¾å¼&#125;^&#123;ä¸Šæ ‡è¡¨è¾¾å¼&#125; &#123;ç´¯åŠ è¡¨è¾¾å¼&#125; æ¥è¾“å…¥ä¸€ä¸ªç´¯åŠ ã€‚ä¸ä¹‹ç±»ä¼¼ï¼Œä½¿ç”¨ \\prod \\bigcup \\bigcap æ¥åˆ†åˆ«è¾“å…¥ç´¯ä¹˜ã€å¹¶é›†å’Œäº¤é›†ã€‚æ­¤ç±»ç¬¦å·åœ¨è¡Œå†…æ˜¾ç¤ºæ—¶ä¸Šä¸‹æ ‡è¡¨è¾¾å¼å°†ä¼šç§»è‡³å³ä¸Šè§’å’Œå³ä¸‹è§’ã€‚ å¦‚ï¼š$$ \\sum_&#123;i=1&#125;^n \\frac&#123;1&#125;&#123;i^2&#125; \\quad and \\quad \\prod_&#123;i=1&#125;^n \\frac&#123;1&#125;&#123;i^2&#125; \\quad and \\quad \\bigcup_&#123;i=1&#125;^&#123;2&#125; R $$,æ˜¾ç¤ºï¼šâˆ‘ni&#x3D;11i2andâˆni&#x3D;11i2andâ‹ƒ2i&#x3D;1Râˆ‘i&#x3D;1n1i2andâˆi&#x3D;1n1i2andâ‹ƒi&#x3D;12R å¦‚ä½•è¾“å…¥å¸Œè…Šå­—æ¯è¾“å…¥ \\å°å†™å¸Œè…Šå­—æ¯è‹±æ–‡å…¨ç§° å’Œ \\é¦–å­—æ¯å¤§å†™å¸Œè…Šå­—æ¯è‹±æ–‡å…¨ç§° æ¥åˆ†åˆ«è¾“å…¥å°å†™å’Œå¤§å†™å¸Œè…Šå­—æ¯,å¯¹äºå¤§å†™å¸Œè…Šå­—æ¯ä¸ç°æœ‰å­—æ¯ç›¸åŒçš„ï¼Œç›´æ¥è¾“å…¥å¤§å†™å­—æ¯å³å¯ã€‚ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\alpha Î±Î± A AA \\beta Î²Î² B BB \\gamma Î³Î³ \\Gamma Î“Î“ \\delta Î´Î´ \\Delta Î”Î” \\epsilon ÏµÏµ E EE \\zeta Î¶Î¶ Z ZZ \\eta Î·Î· H HH \\theta Î¸Î¸ \\Theta Î˜Î˜ \\iota Î¹Î¹ I II \\kappa ÎºÎº K KK \\lambda Î»Î» \\Lambda Î›Î› \\mu Î¼Î¼ M MM \\nu Î½Î½ N NN \\xi Î¾Î¾ \\Xi ÎÎ o oo O OO \\pi Ï€Ï€ \\Pi Î Î  \\rho ÏÏ P PP \\sigma ÏƒÏƒ \\Sigma Î£Î£ \\tau Ï„Ï„ T TT \\upsilon Ï…Ï… \\Upsilon Î¥Î¥ \\phi Ï•Ï• \\Phi Î¦Î¦ \\chi Ï‡Ï‡ X XX \\psi ÏˆÏˆ \\Psi Î¨Î¨ \\omega Ï‰Ï‰ \\Omega Î©Î© éƒ¨åˆ†å­—æ¯æœ‰å˜é‡ä¸“ç”¨å½¢å¼ï¼Œä»¥ \\var- å¼€å¤´ã€‚ å°å†™å½¢å¼ å¤§å†™å½¢å¼ å˜é‡å½¢å¼ æ˜¾ç¤º \\epsilon E \\varepsilon Ïµâˆ£Eâˆ£ÎµÏµâˆ£Eâˆ£Îµ \\theta \\Theta \\vartheta Î¸âˆ£Î˜âˆ£Ï‘Î¸âˆ£Î˜âˆ£Ï‘ \\rho P \\varrho Ïâˆ£Pâˆ£Ï±Ïâˆ£Pâˆ£Ï± \\sigma \\Sigma \\varsigma Ïƒâˆ£Î£âˆ£Ï‚Ïƒâˆ£Î£âˆ£Ï‚ \\phi \\Phi \\varphi Ï•âˆ£Î¦âˆ£Ï†Ï•âˆ£Î¦âˆ£Ï† å¦‚ä½•è¾“å…¥å…¶å®ƒç‰¹æ®Šå­—ç¬¦è‹¥éœ€è¦æ˜¾ç¤ºæ›´å¤§æˆ–æ›´å°çš„å­—ç¬¦ï¼Œåœ¨ç¬¦å·å‰æ’å…¥ \\large æˆ– \\small å‘½ä»¤ã€‚è‹¥æ‰¾ä¸åˆ°éœ€è¦çš„ç¬¦å·ï¼Œä½¿ç”¨ Detexify2Detexify2 æ¥ç”»å‡ºæƒ³è¦çš„ç¬¦å·ã€‚ å…³ç³»è¿ç®—ç¬¦ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\pm Â±Â± \\times Ã—Ã— \\div Ã·Ã· \\mid âˆ£âˆ£ \\nmid âˆ¤âˆ¤ \\cdot â‹…â‹… \\circ âˆ˜âˆ˜ \\ast âˆ—âˆ— \\bigodot â¨€â¨€ \\bigotimes â¨‚â¨‚ \\bigoplus â¨â¨ \\leq â‰¤â‰¤ \\geq â‰¥â‰¥ \\neq â‰ â‰  \\approx â‰ˆâ‰ˆ \\equiv â‰¡â‰¡ \\sum âˆ‘âˆ‘ \\prod âˆâˆ \\coprod âˆâˆ \\backslash âˆ–âˆ– é›†åˆè¿ç®—ç¬¦ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\emptyset âˆ…âˆ… \\in âˆˆâˆˆ \\notin âˆ‰âˆ‰ \\subset âŠ‚âŠ‚ \\supset âŠƒâŠƒ \\subseteq âŠ†âŠ† \\supseteq âŠ‡âŠ‡ \\bigcap â‹‚â‹‚ \\bigcup â‹ƒâ‹ƒ \\bigvee â‹â‹ \\bigwedge â‹€â‹€ \\biguplus â¨„â¨„ å¯¹æ•°è¿ç®—ç¬¦ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\log loglog \\lg lglg \\ln lnln ä¸‰è§’è¿ç®—ç¬¦ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º 30^\\circ 30âˆ˜30âˆ˜ \\bot âŠ¥âŠ¥ \\angle A âˆ Aâˆ A \\sin sinsin \\cos coscos \\tan tantan \\csc csccsc \\sec secsec \\cot cotcot å¾®ç§¯åˆ†è¿ç®—ç¬¦ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\int âˆ«âˆ« \\iint âˆ¬âˆ¬ \\iiint âˆ­âˆ­ \\iiiint âˆ¬âˆ¬â¨Œ \\oint âˆ®âˆ® \\prime â€²â€² \\lim limlim \\infty âˆâˆ \\nabla âˆ‡âˆ‡ é€»è¾‘è¿ç®—ç¬¦ è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\because âˆµâˆµ \\therefore âˆ´âˆ´ \\forall âˆ€âˆ€ \\exists âˆƒâˆƒ \\not\\subset âŠ‚Ì¸âŠ„ \\not&lt; â‰®â‰® \\not&gt; â‰¯â‰¯ \\not&#x3D; â‰ â‰  æˆ´å¸½ç¬¦å· è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º \\hat{xy} xy^xy^ \\widehat{xyz} xyzË†xyz^ \\tilde{xy} xyxy \\widetilde{xyz} xyzËœxyz~ \\check{x} xË‡xË‡ \\breve{y} yË˜yË˜ \\grave{x} xx \\acute{y} yÂ´yÂ´ è¿çº¿ç¬¦å· è¾“å…¥ æ˜¾ç¤º \\fbox{a+b+c+d} a+b+c+da+b+c+d \\overleftarrow{a+b+c+d} a+b+c+dâ†âˆ’âˆ’âˆ’a+b+c+dâ† \\overrightarrow{a+b+c+d} a+b+c+dâˆ’â†’âˆ’âˆ’a+b+c+dâ†’ \\overleftrightarrow{a+b+c+d} a+b+c+dâ†â†’âˆ’a+b+c+dâ†” \\underleftarrow{a+b+c+d} a+b+c+dâ†âˆ’âˆ’âˆ’a+b+c+dâ† \\underrightarrow{a+b+c+d} a+b+c+dâˆ’â†’âˆ’âˆ’a+b+c+dâ†’ \\underleftrightarrow{a+b+c+d} a+b+c+dâ†â†’âˆ’a+b+c+dâ†” \\overline{a+b+c+d} a+b+c+dÂ¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯a+b+c+dÂ¯ \\underline{a+b+c+d} a+b+c+dâ€“â€“â€“â€“â€“a+b+c+d_ \\overbrace{a+b+c+d}^{Sample} a+b+c+dî…î…‘î…“î…’î…”î…”Samplea+b+c+dâSample \\underbrace{a+b+c+d}_{Sample} a+b+c+dî…’î…“î…‘î…î…”î…”Samplea+b+c+dâŸSample \\overbrace{a+\\underbrace{b+c}_{1.0}+d}^{2.0} a+b+cî…’î…“î…‘î…î…”î…”1.0+dî…î…‘î…“î…’î…”î…”î…”î…”2.0a+b+câŸ1.0+dâ2.0 \\underbrace{a\\cdot a\\cdots a}_{b\\text{ times}} aâ‹…aâ‹¯aî…’î…“î…‘î…î…”î…”b timesaâ‹…aâ‹¯aâŸb times ç®­å¤´ç¬¦å· æ¨èä½¿ç”¨ç¬¦å·ï¼š|è¾“å…¥|æ˜¾ç¤º|è¾“å…¥|æ˜¾ç¤º|è¾“å…¥|æ˜¾ç¤º||:â€“ğŸ˜:â€“ğŸ˜:â€“ğŸ˜:â€“ğŸ˜:â€“ğŸ˜:â€“ğŸ˜|\\to|$ \\to|â†¦||â†¦| \\mapsto||||âŸ¹|||||âŸ¹| \\implies|âŸº||âŸº| \\iff|âŸ¸||âŸ¸| \\impliedby$| å…¶å®ƒå¯ç”¨ç¬¦å·ï¼š|è¾“å…¥|æ˜¾ç¤º|è¾“å…¥|æ˜¾ç¤º||:â€“ğŸ˜:â€“ğŸ˜:â€“ğŸ˜:â€“ğŸ˜|\\uparrow|$ \\uparrow|â‡‘||â‡‘| \\Uparrow||â†“|||â†“| \\downarrow|â‡“||â‡“| \\Downarrow||â†|||â†| \\leftarrow|â‡||â‡| \\Leftarrow||â†’|||â†’| \\rightarrow|â‡’||â‡’| \\Rightarrow||â†”|||â†”| \\leftrightarrow|â‡”||â‡”| \\Leftrightarrow||âŸµ|||âŸµ| \\longleftarrow|âŸ¸||âŸ¸| \\Longleftarrow||âŸ¶|||âŸ¶| \\longrightarrow|âŸ¹||âŸ¹| \\Longrightarrow||âŸ·|||âŸ·| \\longleftrightarrow|âŸº||âŸº| \\Longleftrightarrow$| å¦‚ä½•è¿›è¡Œå­—ä½“è½¬æ¢è‹¥è¦å¯¹å…¬å¼çš„æŸä¸€éƒ¨åˆ†å­—ç¬¦è¿›è¡Œå­—ä½“è½¬æ¢ï¼Œå¯ä»¥ç”¨ &#123;\\å­—ä½“ &#123;éœ€è½¬æ¢çš„éƒ¨åˆ†å­—ç¬¦&#125;&#125; å‘½ä»¤ï¼Œå…¶ä¸­ \\å­—ä½“ éƒ¨åˆ†å¯ä»¥å‚ç…§ä¸‹è¡¨é€‰æ‹©åˆé€‚çš„å­—ä½“ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå…¬å¼é»˜è®¤ä¸ºæ„å¤§åˆ©ä½“ italicitalic ã€‚ç¤ºä¾‹ä¸­ å…¨éƒ¨å¤§å†™ çš„å­—ä½“ä»…å¤§å†™å¯ç”¨ã€‚ è¾“å…¥ è¯´æ˜ æ˜¾ç¤º è¾“å…¥ è¯´æ˜ æ˜¾ç¤º \\rm ç½—é©¬ä½“ SampleSample \\cal èŠ±ä½“ SAMPLESAMPLE \\it æ„å¤§åˆ©ä½“ SampleSample \\Bbb é»‘æ¿ç²—ä½“ SAMPLESAMPLE \\bf ç²—ä½“ SampleSample \\mit æ•°å­¦æ–œä½“ SAMPLESAMPLE \\sf ç­‰çº¿ä½“ SampleSample \\scr æ‰‹å†™ä½“ SAMPLESAMPLE \\tt æ‰“å­—æœºä½“ SampleSample \\frak æ—§å¾·å¼å­—ä½“ SampleSample è½¬æ¢å­—ä½“ååˆ†å¸¸ç”¨ï¼Œä¾‹å¦‚åœ¨ç§¯åˆ†ä¸­ï¼š 12345\\begin&#123;array&#125;&#123;cc&#125;\\mathrm&#123;Bad&#125; &amp; \\mathrm&#123;Better&#125; \\\\\\hline \\\\\\int_0^1 x^2 dx &amp; \\int_0^1 x^2 \\,&#123;\\rm d&#125;x\\end&#123;array&#125; æ˜¾ç¤ºï¼š\\begin{array}{cc}\\mathrm{Bad} &amp; \\mathrm{Better} \\\\hline \\\\int_0^1 x^2 dx &amp; \\int_0^1 x^2 ,{\\rm d}x\\end{array}\\begin{array}{cc} \\mathrm{Bad} &amp; \\mathrm{Better} \\ \\hline \\ \\int_0^1 x^2 dx &amp; \\int_0^1 x^2 ,{\\rm d}x \\end{array},æ³¨æ„æ¯”è¾ƒä¸¤ä¸ªå¼å­é—´ dxdx ä¸ dxdx çš„ä¸åŒã€‚ å¦‚ä½•ä½¿ç”¨å¤§æ‹¬å·å’Œè¡Œæ ‡ä½¿ç”¨ \\left å’Œ \\right æ¥åˆ›å»ºè‡ªåŠ¨åŒ¹é…é«˜åº¦çš„ (åœ†æ‹¬å·)ï¼Œ[æ–¹æ‹¬å·] å’Œ {èŠ±æ‹¬å·} ï¼Œåœ¨æ¯ä¸ªå…¬å¼æœ«å°¾å‰ä½¿ç”¨ \\tag&#123;è¡Œæ ‡&#125; æ¥å®ç°è¡Œæ ‡ã€‚ ä¾‹å¦‚ï¼š 123456789101112131415$$f\\left( \\left[ \\frac&#123; 1+\\left\\&#123;x,y\\right\\&#125; &#125;&#123; \\left( \\frac&#123;x&#125;&#123;y&#125;+\\frac&#123;y&#125;&#123;x&#125; \\right) \\left(u+1\\right) &#125;+a \\right]^&#123;3/2&#125;\\right)\\tag&#123;è¡Œæ ‡&#125;$$ æ˜¾ç¤ºï¼š fâ›ââœâœâ¡â£â¢1+{x,y}(xy+yx)(u+1)+aâ¤â¦â¥3&#x2F;2ââ âŸâŸ(è¡Œæ ‡)(è¡Œæ ‡)f([1+{x,y}(xy+yx)(u+1)+a]3&#x2F;2) å¦‚æœä½ éœ€è¦åœ¨ä¸åŒçš„è¡Œæ˜¾ç¤ºå¯¹åº”æ‹¬å·ï¼Œå¯ä»¥åœ¨æ¯ä¸€è¡Œå¯¹åº”å¤„ä½¿ç”¨ \\left. æˆ– \\right. æ¥æ”¾ä¸€ä¸ªâ€å½±å­â€æ‹¬å·ï¼š ä¾‹å¦‚ï¼š 123456$$\\begin&#123;aligned&#125;a=&amp;\\left(1+2+3+ \\cdots \\right. \\\\&amp; \\cdots+ \\left. \\infty-2+\\infty-1+\\infty\\right)\\end&#123;aligned&#125;$$ æ˜¾ç¤ºï¼š a&#x3D;(1+2+3+â‹¯â‹¯+âˆâˆ’2+âˆâˆ’1+âˆ)a&#x3D;(1+2+3+â‹¯â‹¯+âˆâˆ’2+âˆâˆ’1+âˆ) å¦‚æœä½ éœ€è¦å°†è¡Œå†…æ˜¾ç¤ºçš„åˆ†éš”ç¬¦ä¹Ÿå˜å¤§ï¼Œå¯ä»¥ä½¿ç”¨ \\middle å‘½ä»¤ï¼š ä¾‹å¦‚ï¼š 123456789$$\\left\\langle q\\middle\\| \\frac&#123;\\frac&#123;x&#125;&#123;y&#125;&#125;&#123;\\frac&#123;u&#125;&#123;v&#125;&#125;\\middle| p \\right\\rangle$$ æ˜¾ç¤ºï¼š âŸ¨qâˆ¥âˆ¥âˆ¥xyuvâˆ£âˆ£âˆ£pâŸ©âŸ¨qâ€–xyuv|pâŸ© å…¶å®ƒå…¬å¼å®šä¹‰æ–°çš„ç¬¦å·\\operatornameå¦‚ï¼š$$ \\operatorname&#123;Symbol&#125; A $$ï¼Œæ˜¾ç¤ºï¼š SymbolASymbolâ¡A æ·»åŠ æ³¨é‡Šæ–‡å­— \\textåœ¨ \\text &#123;æ–‡å­—&#125; ä¸­ä»å¯ä»¥ä½¿ç”¨ $å…¬å¼$ æ’å…¥å…¶å®ƒå…¬å¼ã€‚ å¦‚ï¼š$$ f(n)= \\begin&#123;cases&#125; n/2, &amp; \\text &#123;if $n$ is even&#125; \\\\ 3n+1, &amp; \\text&#123;if $n$ is odd&#125; \\end&#123;cases&#125; $$ æ˜¾ç¤ºï¼š$ f(n)&#x3D; \\begin{cases} n&#x2F;2, &amp; \\text {if nn is even} \\ 3n+1, &amp; \\text{if nn is odd} \\end{cases} $ åœ¨å­—ç¬¦é—´åŠ å…¥ç©ºæ ¼æœ‰å››ç§å®½åº¦çš„ç©ºæ ¼å¯ä»¥ä½¿ç”¨ï¼š \\,ã€\\;ã€\\quad å’Œ \\qquad ã€‚ å¦‚ï¼š$$ a \\, b \\mid a \\; b \\mid a \\quad b \\mid a \\qquad b $$,æ˜¾ç¤ºï¼ša,bâˆ£a;bâˆ£abâˆ£aba,bâˆ£a;bâˆ£abâˆ£ab å½“ç„¶ï¼Œä½¿ç”¨ \\text &#123;nä¸ªç©ºæ ¼&#125; ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·æ•ˆæœã€‚ æ›´æ”¹æ–‡å­—é¢œè‰²ä½¿ç”¨ \\color&#123;é¢œè‰²&#125;&#123;æ–‡å­—&#125; æ¥æ›´æ”¹ç‰¹å®šçš„æ–‡å­—é¢œè‰²,æ›´æ”¹æ–‡å­—é¢œè‰² éœ€è¦æµè§ˆå™¨æ”¯æŒï¼Œå¦‚æœæµè§ˆå™¨ä¸çŸ¥é“ä½ æ‰€éœ€çš„é¢œè‰²ï¼Œé‚£ä¹ˆæ–‡å­—å°†è¢«æ¸²æŸ“ä¸ºé»‘è‰²ã€‚å¯¹äºè¾ƒæ—§çš„æµè§ˆå™¨ï¼ˆHTML4ä¸CSS2ï¼‰ï¼Œä»¥ä¸‹é¢œè‰²æ˜¯è¢«æ”¯æŒçš„ï¼š è¾“å…¥ æ˜¾ç¤º è¾“å…¥ æ˜¾ç¤º black texttext grey texttext silver texttext white texttext maroon texttext red texttext yellow texttext lime texttext olive texttext green texttext teal texttext auqa texttext blue texttext navy texttext purple texttext fuchsia texttext å¯¹äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼ˆHTML5ä¸CSS3ï¼‰ï¼Œé¢å¤–çš„124ç§é¢œè‰²å°†è¢«æ”¯æŒï¼šè¾“å…¥ &#96;\\color","categories":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/categories/Hexo/"}],"tags":[{"name":"MarkDown","slug":"MarkDown","permalink":"https://marvinliu1.github.io/tags/MarkDown/"},{"name":"Next","slug":"Next","permalink":"https://marvinliu1.github.io/tags/Next/"}]},{"title":"Node in Debugging - 8.2 Alinode","slug":"8.2 alinode","date":"2020-03-08T07:12:31.000Z","updated":"2022-05-25T04:31:30.684Z","comments":true,"path":"2020/03/08/8.2 alinode/","link":"","permalink":"https://marvinliu1.github.io/2020/03/08/8.2%20alinode/","excerpt":"","text":"Node in Debugging 8.2.1 ä»€ä¹ˆæ˜¯ alinodeï¼Ÿ Node.js æ€§èƒ½å¹³å°ï¼ˆåŸ alinodeï¼‰æ˜¯é¢å‘ä¸­å¤§å‹ Node.js åº”ç”¨æä¾›æ€§èƒ½ç›‘æ§ã€å®‰å…¨æé†’ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–ç­‰æœåŠ¡çš„æ•´ä½“æ€§è§£å†³æ–¹æ¡ˆã€‚alinode å›¢é˜Ÿå‡­å€Ÿå¯¹ Node.js å†…æ ¸çš„æ·±å…¥ç†è§£ï¼Œæä¾›äº†å®Œå–„çš„å·¥å…·é“¾å’ŒæœåŠ¡ï¼ŒååŠ©å®¢æˆ·ä¸»åŠ¨ã€å¿«é€Ÿåœ°å‘ç°å’Œå®šä½çº¿ä¸Šé—®é¢˜ã€‚ 8.2.2 åˆ›å»º alinode åº”ç”¨è®¿é—®å®˜ç½‘ https://www.aliyun.com/product/nodejsï¼Œå¦‚æœªå¼€é€šï¼Œåˆ™ä½¿ç”¨é˜¿é‡Œäº‘è´¦å·ç™»å½•å¹¶å…è´¹å¼€é€šå³å¯ã€‚ ç™»å½•åè¿›å…¥æ§åˆ¶å°ï¼Œå•å‡» â€œåˆ›å»ºæ–°åº”ç”¨â€ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º test_alinode çš„åº”ç”¨ã€‚ è¿›å…¥è®¾ç½®é¡µé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š App ID å’Œ App Secret åé¢ä¼šç”¨åˆ°ã€‚ 8.2.3 å®‰è£… alinodealinode çš„æ•´å¥—æœåŠ¡ç”± alinode è¿è¡Œæ—¶ã€agenthubï¼ˆåŸ agentx + commdx å‘½ä»¤é›†ï¼‰å’ŒæœåŠ¡å¹³å°ç»„æˆï¼Œæ‰€ä»¥åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²æ—¶éœ€è¦å®‰è£… alinode è¿è¡Œæ—¶å’Œ agenthubã€‚ æˆ‘ä»¬ä½¿ç”¨äº¤äº’å¼ä¸€é”®å®‰è£… alinode å’Œ agenthubï¼š 123456$ uname -a # é˜¿é‡Œäº‘ ECS Ubuntu@16.04Linux nswbmw 4.4.0-105-generic #128-Ubuntu SMP Thu Dec 14 12:42:11 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux$ wget https://raw.githubusercontent.com/aliyun-node/alinode-all-in-one/master/alinode_all.sh$ bash -i alinode_all.sh # App ID å’Œ App Secret å¡«å†™ä¸Šé¢ç”Ÿæˆçš„...$ node -p &#x27;process.alinode&#x27; # æŸ¥çœ‹ alinode ç‰ˆæœ¬ æ³¨æ„ï¼šå¦‚æœé‡åˆ° wget æŠ¥é”™ wget: unable to resolve host address &#39;raw.githubusercontent.com&#39;ï¼Œéœ€è¦ä¿®æ”¹ DNS é…ç½®ï¼Œåœ¨ &#x2F;etc&#x2F;resolv.conf æœ€ä¸Šé¢æ·»åŠ  nameserver 8.8.8.8ã€‚ ç”Ÿæˆä¸€ä¸ª yourconfig.json é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 1234567891011&#123; &quot;server&quot;: &quot;agentserver.node.aliyun.com:8080&quot;, &quot;appid&quot;: &quot;xxx&quot;, &quot;secret&quot;: &quot;xxx&quot;, &quot;logdir&quot;: &quot;/tmp/&quot;, &quot;reconnectDelay&quot;: 10, &quot;heartbeatInterval&quot;: 60, &quot;reportInterval&quot;: 60, &quot;error_log&quot;: [], &quot;packages&quot;: []&#125; ä½¿ç”¨è¯¥é…ç½®å¯åŠ¨ agenthubï¼š 1$ nohup agenthub yourconfig.json &amp; agenthub å°†ä»¥å¸¸é©»è¿›ç¨‹çš„æ–¹å¼è¿è¡Œã€‚ ä¸‹é¢é€šè¿‡ä¸¤ä¸ªä¾‹å­ä½¿ç”¨ alinode åˆ†åˆ«è°ƒè¯•å†…å­˜æ³„éœ²å’Œ CPU æ€§èƒ½ç“¶é¢ˆçš„é—®é¢˜ã€‚ 8.2.4 ä½¿ç”¨ alinode è¯Šæ–­å†…å­˜æ³„éœ²æˆ‘ä»¬ä»¥ä¸€æ®µå†…å­˜æ³„éœ²ä»£ç ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ alinode è°ƒè¯•å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ä»£ç å¦‚ä¸‹ï¼š server.js 12345678910111213141516171819const Paloma = require(&#x27;paloma&#x27;)const session = require(&#x27;koa-generic-session&#x27;)const app = new Paloma()app.keys = [&#x27;some secret&#x27;]app.use(session())class User &#123; constructor () &#123; this.name = new Array(1e6).join(&#x27;*&#x27;) &#125;&#125;app.use((ctx) =&gt; &#123; ctx.session.user = new User() ctx.status = 204&#125;)app.listen(3000) è¿™æ®µä»£ç å†…å­˜æ³„éœ²çš„åŸå› æ˜¯ï¼škoa-generic-session é»˜è®¤å°† session ä¿¡æ¯å­˜å‚¨åˆ°äº†å†…å­˜ä¸­ã€‚ client.js 12345const axios = require(&#x27;axios&#x27;)setInterval(() =&gt; &#123; axios.get(&#x27;http://localhost:3000&#x27;)&#125;, 1000) æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ«è¿è¡Œ ï¼š 12$ ENABLE_NODE_LOG=YES node server # å¼€å¯ alinode çš„ log åŠŸèƒ½ï¼Œä½¿å¾— agenthub å¯ä»¥ç›‘æ§å†…æ ¸çº§çš„æ€§èƒ½æ•°æ®$ node client # 1s å‘èµ·ä¸€æ¬¡è¯·æ±‚ è¿‡ä¸€ä¼šå„¿å°±å¯ä»¥åœ¨ alinode æ§åˆ¶å°çœ‹åˆ°æ•°æ®äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼Œalinode ç›‘æ§äº†ï¼š å¼‚å¸¸æ—¥å¿— æ…¢ HTTP æ—¥å¿— æ¨¡å—ä¾èµ– ç³»ç»Ÿç›‘æ§æ•°æ®ï¼ˆåŒ…å«éå¸¸è¯¦å°½çš„å›¾è¡¨æ•°æ®ï¼Œæœ‰ Memoryã€CPUã€Loadã€QPSã€GCã€Apdexã€Apdex detailã€node è¿›ç¨‹æ•°ã€ç£ç›˜ï¼‰ å•å‡» â€œå †å¿«ç…§â€ ç”Ÿæˆä¸€ä¸ª heapsnapshot æ–‡ä»¶ï¼Œå•å‡»å·¦ä¾§çš„ â€œæ–‡ä»¶â€ï¼ŒæŸ¥çœ‹åˆšæ‰ç”Ÿæˆçš„å †å¿«ç…§ï¼š åœ¨è½¬å‚¨åå•å‡» â€œåˆ†æâ€ï¼Œé€‰æ‹© â€œå¯¹è±¡ç°‡è§†å›¾â€ çš„æ ‘çŠ¶åˆ—è¡¨ï¼Œå±•å¼€åå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šMemoryStore çš„ sessions å¯¹è±¡ä¸­å­˜å‚¨äº† 97 ä¸ª sessionï¼Œå¹¶ä¸”æ¯ä¸ª session.user ä¸Šæœ‰ä¸€ä¸ª name å­—æ®µæ˜¯é•¿å­—ç¬¦ä¸²ã€‚ 8.2.5 ä½¿ç”¨ alinode è¯Šæ–­ CPU æ€§èƒ½ç“¶é¢ˆæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š server.js 12345678910111213const crypto = require(&#x27;crypto&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/encrypt&#x27;, controller: function encryptRouter (ctx) &#123; const password = ctx.query.password || &#x27;test&#x27; const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;) const encryptedPassword = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;) ctx.body = encryptedPassword&#125;&#125;)app.listen(3000) client.js 123456789const axios = require(&#x27;axios&#x27;)setInterval(() =&gt; &#123; const tps = Math.floor(Math.random() * 10) for (let i = 0; i &lt; tps; i++) &#123; axios.get(&#x27;http://localhost:3000/encrypt?password=123456&#x27;) &#125; console.log(`Sent $&#123;tps&#125; requests`)&#125;, 1000) æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ«è¿è¡Œï¼š 12$ ENABLE_NODE_LOG=YES node server$ node client å›åˆ° alinode æ§åˆ¶å°ï¼Œå•å‡» â€œCPU Profileâ€ï¼Œç„¶ååˆ° â€œæ–‡ä»¶â€ æŸ¥çœ‹åˆšæ‰ç”Ÿæˆçš„ cpuprofile æ–‡ä»¶ï¼Œè½¬å‚¨åå•å‡» â€œåˆ†æâ€ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ç«ç„°å›¾ã€‚å±•å¼€åå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šserver.js çš„ç¬¬ 5 è¡Œï¼Œå³ encryptRouter å ç”¨ CPU è¾ƒå¤šï¼Œè€Œ encryptRouter é‡Œçš„ exports.pbkdf2Sync å ç”¨äº† encryptRouter ç»å¤§éƒ¨åˆ† CPU æ—¶é—´ã€‚ å›åˆ° â€œæ–‡ä»¶â€ï¼Œé€‰æ‹© â€œdevtools åˆ†æâ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šalinode å·²ç»å¸®æˆ‘ä»¬æŠŠå¯ç–‘çš„ CPU æ€§èƒ½ç“¶é¢ˆçš„å…ƒå‡¶æ ‡çº¢æ˜¾ç¤ºäº†ã€‚ å°æç¤ºï¼šä¸ç®¡æ˜¯ç”Ÿæˆçš„ heapsnapshot è¿˜æ˜¯ cpuprofileï¼Œéƒ½å¯ä»¥é€‰æ‹© â€œä¸‹è½½â€ åä½¿ç”¨ Chrome DevTools åˆ†æã€‚ æˆ‘ä»¬åœ¨ä¸Šé¢åªæ¼”ç¤ºäº† â€œå †å¿«ç…§â€ å’Œ â€œCPU Profileâ€ çš„ä½¿ç”¨ï¼Œalinode æ”¯æŒæŠ“å–ä»¥ä¸‹ 5 ç§æ•°æ®ï¼š å †å¿«ç…§ å †æ—¶é—´çº¿ CPU Profile GC Trace Heap Profile æœ¬èŠ‚å°±ä¸ä¸€ä¸€æ¼”ç¤ºäº†ã€‚ alinode å¦‚æ­¤å¼ºå¤§ï¼Œè€Œä¸”å…è´¹ä½¿ç”¨ï¼Œå¯ä»¥è¯´æ˜¯å¼€å‘ Node.js åº”ç”¨å¿…ä¸å¯å°‘çš„å¥½ä¼™ä¼´äº†ã€‚ 8.2.6 å‚è€ƒé“¾æ¥ https://www.aliyun.com/product/nodejs https://github.com/aliyun-node/agenthub https://cnodejs.org/topic/561f289b4928c5872abc18ee ä¸Šä¸€èŠ‚ï¼š8.1 node-clinic","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 8.1 Node-clinic","slug":"8.1 node-clinic","date":"2020-02-01T07:00:00.000Z","updated":"2022-05-25T04:30:57.228Z","comments":true,"path":"2020/02/01/8.1 node-clinic/","link":"","permalink":"https://marvinliu1.github.io/2020/02/01/8.1%20node-clinic/","excerpt":"","text":"Node in Debugging 8.1.1 ä½¿ç”¨ node-clinicnode-clinicï¼ˆç®€ç§° clinicï¼‰ æ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ Node.js åº”ç”¨è¯Šæ–­å·¥å…·ã€‚ é¦–å…ˆï¼Œå®‰è£… Node.js@9+ 1$ nvm install 9 å…¨å±€å®‰è£… clinicï¼š 1$ npm i clinic -g åˆ›å»ºæµ‹è¯•ä»£ç ï¼š app.js 12345678910111213const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()function sleep (ms) &#123; const future = Date.now() + ms while (Date.now() &lt; future);&#125;app.use(() =&gt; &#123; sleep(50)&#125;)app.listen(3000) ä½¿ç”¨ clinic doctor å¯åŠ¨å¹¶è¯Šæ–­ Node.js åº”ç”¨ï¼š 1$ clinic doctor -- node app.js ä½¿ç”¨ ab å‹æµ‹ï¼š 1$ ab -c 10 -n 200 &quot;http://localhost:3000/&quot; CTRL+C ç»ˆæ­¢æµ‹è¯•ç¨‹åºï¼Œç»ˆç«¯æ‰“å°å‡ºï¼š 123Warning: Trace event is an experimental feature and could change at any time.^Canalysing datagenerated HTML file is 51485.clinic-doctor.html ç”¨æµè§ˆå™¨æ‰“å¼€ 51485.clinic-doctor.htmlï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šEvent Loop è¢«é˜»å¡ï¼ŒCPU Usage ä¹Ÿå±…é«˜ä¸ä¸‹ï¼Œä¸€å®šæ˜¯æœ‰ CPU å¯†é›†è®¡ç®—ï¼Œä¸æˆ‘ä»¬çš„æµ‹è¯•ä»£ç å»åˆã€‚ clinic ä¹Ÿç»™å‡ºäº†çŒœæµ‹å’Œè§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨ clinic flame ç”Ÿæˆç«ç„°å›¾ï¼š 1$ clinic flame -- node app.js ä¹Ÿå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤ä»£æ›¿ï¼š 12$ clinic flame --collect-only -- node app.js # åªæ”¶é›†æ•°æ®$ clinic flame --visualize-only PID.flamegraph # å°†æ•°æ®ç”Ÿæˆç«ç„°å›¾ ä½¿ç”¨åŒæ ·çš„ ab å‘½ä»¤å‹æµ‹åï¼Œç”Ÿæˆçš„ç«ç„°å›¾å¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºï¼šapp.js ç¬¬ 4 è¡Œçš„ sleep å‡½æ•°å ç”¨äº†å¤§é‡çš„ CPU è®¡ç®—ã€‚ 8.1.2 å‚è€ƒé“¾æ¥ https://www.nearform.com/blog/introducing-node-clinic-a-performance-toolkit-for-node-js-developers/ ä¸Šä¸€èŠ‚ï¼š7.2 Telegraf + InfluxDB + Grafana(ä¸‹) ä¸‹ä¸€èŠ‚ï¼š8.2 alinode","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 7.2 Telegraf + InfluxDB + Grafana(2)","slug":"7.2 Telegraf + InfluxDB + Grafana(ä¸‹)","date":"2019-11-28T07:00:00.000Z","updated":"2022-05-25T04:31:46.056Z","comments":true,"path":"2019/11/28/7.2 Telegraf + InfluxDB + Grafana(ä¸‹)/","link":"","permalink":"https://marvinliu1.github.io/2019/11/28/7.2%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8B)/","excerpt":"","text":"Node in Debugging ä¸Šä¸€å°èŠ‚ä¸»è¦è®²è§£äº† Telegraf(StatsD) + InfluxDB + Grafana çš„æ­å»ºå’ŒåŸºæœ¬ç”¨æ³•ï¼Œå¹¶åˆ›å»ºäº†è¯·æ±‚é‡å’Œå“åº”æ—¶é—´è¿™ä¸¤ç§å›¾è¡¨ã€‚æœ¬èŠ‚è®²è§£å‡ ä¸ªé«˜çº§ç”¨æ³•ï¼š å¦‚ä½•å°† Grafanaï¼ˆç›‘æ§ï¼‰è·Ÿ ELKï¼ˆæ—¥å¿—ï¼‰ç»“åˆèµ·æ¥ã€‚ Grafana ç›‘æ§æŠ¥è­¦ã€‚ è„šæœ¬ä¸€é”®ç”Ÿæˆå›¾è¡¨ã€‚ 7.2.1 Grafana + ELKåœ¨è§‚å¯Ÿ Grafana ç›‘æ§æ—¶ï¼Œæˆ‘ä»¬å‘ç°æŸä¸ª api æ¥å£çš„å“åº”æ—¶é—´çªç„¶æœ‰ä¸€ä¸ªå°–åˆºï¼Œè¿™ä¸ªæ—¶å€™æƒ³æŸ¥ä¸€æŸ¥åˆ°åº•æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ã€‚åœ¨å‰é¢ä»‹ç»è¿‡ koa-await-breakpoint + ELK çš„ç”¨æ³•ï¼Œæ˜¯å¦å¯ä»¥ç»“åˆ Grafana ä½¿ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚ å› ä¸ºæ¶‰åŠçš„ä»£ç é‡å¤§ï¼Œæ‰€ä»¥ç¬”è€…å†™äº†ä¸€ä¸ª demo æ‰˜ç®¡åˆ°äº† GitHub ä¸Šï¼Œæœ‰ä¸¤ä¸ª repoï¼Œåˆ†åˆ«ä¸ºï¼š grafana-to-elkï¼šåŒ…å« web server å’Œæ¨¡æ‹Ÿè¯·æ±‚çš„ clientï¼Œåˆ†åˆ«å°†ç»Ÿè®¡ä¿¡æ¯å‘é€åˆ° StatsD å’Œå°†æ—¥å¿—å‘é€åˆ° ELKã€‚ grafana-to-elk-extensionï¼šChrome æ‰©å±•ï¼Œä½œç”¨æ˜¯ï¼š æ ¼å¼åŒ–ä» Grafana è·³è½¬åˆ° ELK çš„æ—¶é—´èŒƒå›´ã€‚ æ·»åŠ  requestId çš„é“¾æ¥ã€‚ é«˜äº®æ˜¾ç¤ºé‡è¦çš„å­—æ®µã€‚ é¦–å…ˆ clone åˆ°æœ¬åœ°ï¼š 12$ git clone https://github.com/nswbmw/grafana-to-elk.git$ git clone https://github.com/nswbmw/grafana-to-elk-extension.git æµ‹è¯•æ­¥éª¤å¦‚ä¸‹ï¼š æŒ‰ç…§ 7.2 èŠ‚å¯åŠ¨ Telegrafï¼ˆStatsDï¼‰+ InfluxDB + Grafanaã€‚ æŒ‰ç…§ 6.3 èŠ‚å¯åŠ¨ ELKã€‚ åˆ° grafana-to-elk ç›®å½•ä¸‹è¿è¡Œï¼š 12$ npm i$ node server æ‰“å¼€å¦å¤–ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š 1$ node client æ­¤æ—¶ï¼ŒELK åº”è¯¥æœ‰æ—¥å¿—äº†ã€‚ åŠ è½½ Chrome æ‰©å±•ã€‚æ‰“å¼€ Chrome æ‰©å±•ç¨‹åºé¡µ -&gt; åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºâ€¦ -&gt; åŠ è½½ grafana-to-elk-extensionï¼ˆéæµ‹è¯•ç¯å¢ƒä¸‹éœ€è¦ä¿®æ”¹ manifest.json çš„ matches å­—æ®µï¼‰ã€‚ å›åˆ° Grafana çš„ â€œgetHome å“åº”æ—¶é—´â€ å›¾è¡¨ï¼Œè¿›å…¥ç¼–è¾‘é¡µçš„ General tabï¼Œå¦‚ä¸‹å¡«å†™ï¼š åœ¨ä¿å­˜åï¼Œå›¾è¡¨çš„å·¦ä¸Šè§’ä¼šå‡ºç°ä¸€ä¸ªç±»ä¼¼åˆ†äº«çš„æŒ‰é’®ï¼Œé¼ æ ‡æ‚¬æµ®åˆ°ä¸Šé¢å‡ºç° â€œGo to ELKâ€ï¼Œå•å‡»å®ƒè·³è½¬åˆ° ELKã€‚ ELK æ˜¾ç¤ºå¦‚ä¸‹ï¼š grafana-to-elk-extension æ’ä»¶ä¼šè‡ªåŠ¨å¤„ç†å¹¶è·³è½¬åˆ°å¯¹åº” Grafana ä¸­çš„æ—¶é—´æ®µå¹¶ä¸”æŸ¥è¯¢å‡ºäº†æˆ‘ä»¬å…³å¿ƒçš„ç»“æœã€‚å•å‡»ç¬¬ 1 ä¸ª requestIdï¼Œå°†ä¼šè·³è½¬å¹¶æ˜¾ç¤ºè¯¥è¯·æ±‚æ‰€æœ‰çš„æ—¥å¿—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š é”™è¯¯è¯·æ±‚çš„æ—¥å¿—å¦‚ä¸‹ï¼š 7.2.2 ç›‘æ§æŠ¥è­¦Grafana æœ‰å†…ç½®çš„ç›‘æ§æŠ¥è­¦ï¼Œè®¾ç½®æ­¥éª¤å¦‚ä¸‹ï¼š è¿›å…¥ Alerting -&gt; Notifications é¡µï¼Œå•å‡» New Notification æ·»åŠ æ–°çš„æŠ¥è­¦ç»„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å›åˆ° â€œgetHome å“åº”æ—¶é—´â€ å›¾è¡¨ï¼Œè¿›å…¥ç¼–è¾‘é¡µçš„ Alert tabï¼Œå•å‡» Create Alert åˆ›å»ºæŠ¥è­¦è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š æŠ¥è­¦è§„åˆ™ä¸ºï¼šæ¯ 60s æ£€æŸ¥ä¸€æ¬¡è¿‡å» 1min çš„ meanï¼ˆB åœ¨ Metrics é‡Œé¢ä»£è¡¨äº†åˆ«åä¸º mean çš„æŠ˜çº¿å›¾ï¼‰æŠ˜çº¿å›¾çš„å¹³å‡å€¼æ˜¯å¦å¤§äº 50ï¼Œå¦‚æœæ˜¯åˆ™è§¦å‘æŠ¥è­¦ã€‚ æ³¨æ„ï¼šå¦‚éœ€å‘é‚®ä»¶ï¼Œåˆ™éœ€è¦è®¾ç½® Grafana çš„ SMTP settingsã€‚ æˆ‘ä»¬è¿˜å¯ä»¥ç»™ â€œgetHome è¯·æ±‚é‡â€ è®¾ç½®é”™è¯¯æŠ¥è­¦ç›‘æ§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š æ¯ 60s æ£€æŸ¥ä¸€æ¬¡è¿‡å» 1min å†…æ˜¯å¦æœ‰ 400 æŠ¥é”™ï¼Œå¦‚æœæœ‰åˆ™è§¦å‘æŠ¥è­¦ï¼Œå…¶ä¸­ B ä»£è¡¨äº†åˆ«åä¸º 400 çš„æŠ˜çº¿å›¾ã€‚ å°æç¤ºï¼šæŠ¥è­¦ä¿¡æ¯å¯ä»¥å‘é€åˆ° Emailã€Slackã€DingTalk æˆ–è€… Webhook ç­‰ç­‰ã€‚æŠ¥è­¦çš„å†…å®¹å¯ä»¥åŒ…å«å›¾è¡¨çš„æˆªå›¾ï¼Œéœ€è¦é…ç½® external image uploaderã€‚ å°æç¤ºï¼šGrafana é…ç½®æ–‡ä»¶åœ¨ &#x2F;etc&#x2F;grafana&#x2F;grafana.iniï¼Œå¦‚éœ€ä¿®æ”¹æ­¥éª¤å¦‚ä¸‹ï¼š 1234$ docker exec -it docker-statsd-influxdb-grafana bash # è¿›å…¥ docker å®¹å™¨$ apt update$ apt install vim$ vim /etc/grafana/grafana.ini 7.2.3 è„šæœ¬ä¸€é”®ç”Ÿæˆå›¾è¡¨æˆ‘ä»¬åªåˆ›å»ºäº†ä¸€ä¸ªæ¥å£çš„ä¸¤ç§ï¼ˆè¯·æ±‚é‡å’Œå“åº”æ—¶é—´ï¼‰å›¾è¡¨ï¼Œæ¯ä¸ªå›¾è¡¨è¦è®¾ç½® linkã€alert ç­‰ç­‰å°±å¾ˆéº»çƒ¦äº†ã€‚å¦‚æœæˆ‘ä»¬çš„ api æœ‰å‡ ç™¾ä¸ªæ¥å£ï¼Œå²‚ä¸æˆäº†ç¾éš¾äº†ã€‚ Grafana è™½ç„¶æœ‰ Template çš„åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬æ¥ä¸‹æ¥è®²ä¸€ä¸ªå¥‡æŠ€æ·«å·§ã€‚ æˆ‘ä»¬åœ¨ä¿å­˜å›¾è¡¨çš„æ—¶å€™ä» Chrome DevTools çš„ Network çœ‹åˆ°å‘èµ·äº†ä¸€ä¸ª Ajax è¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š dashboard å°±æ˜¯åŒ…å«äº†å½“å‰ä»ªè¡¨ç›˜é¡µæ‰€æœ‰å›¾è¡¨çš„å®Œæ•´ JSONï¼Œå…¶ä¸­ï¼š dashboardï¼šåŒ…å«ä¸€åˆ°å¤šè¡Œ rowã€‚ rowsï¼šä¸€è¡Œ row åŒ…å«ä¸€åˆ°å¤šä¸ª panelã€‚ panelsï¼šä¸€ä¸ª panel æ˜¯ä¸€ä¸ªå…·ä½“çš„å›¾è¡¨ã€‚ åœ¨æ‹¿åˆ°è¿™ä¸ª JSON åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸æ–­åœ°å°è¯•ä¿®æ”¹å®ƒï¼Œç„¶åç”¨ axios å¸¦ä¸Šæµè§ˆå™¨æ‹¿åˆ°çš„ Cookie å‘é€åˆ°å›¾ä¸­çš„ URLï¼Œæ¨¡æ‹Ÿæµè§ˆå™¨çš„ä¿å­˜æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€è®²è§£äº†ã€‚ 7.2.4 å‚è€ƒé“¾æ¥ http://docs.grafana.org/alerting/notifications/ ä¸Šä¸€èŠ‚ï¼š7.1 Telegraf + InfluxDB + Grafana(ä¸Š) ä¸‹ä¸€èŠ‚ï¼š8.1 node-clinic","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 7.1 Telegraf + InfluxDB + Grafana(1)","slug":"7.1 Telegraf + InfluxDB + Grafana(ä¸Š)","date":"2019-11-26T07:00:00.000Z","updated":"2022-05-25T04:30:08.253Z","comments":true,"path":"2019/11/26/7.1 Telegraf + InfluxDB + Grafana(ä¸Š)/","link":"","permalink":"https://marvinliu1.github.io/2019/11/26/7.1%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8A)/","excerpt":"","text":"Node in Debugging æœ¬èŠ‚å°†ä¼šè®²è§£å¦‚ä½•ä½¿ç”¨ Telegraf(StatsD) + InfluxDB + Grafana æ­å»ºä¸€å¥—å®Œæ•´çš„ç›‘æ§ç³»ç»Ÿã€‚ 7.1.1 Telegraf(StatsD) + InfluxDB + Grafana ç®€ä»‹Telegraf æ˜¯ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„ä»£ç†ç¨‹åºï¼Œå¯æ”¶é›†ç³»ç»Ÿå’ŒæœåŠ¡æˆ–è€…å…¶ä»–æ¥æºï¼ˆinputsï¼‰çš„æ•°æ®ï¼Œå¹¶å°†å…¶å†™å…¥ InfluxDBï¼ˆoutputsï¼‰æ•°æ®åº“ï¼Œæ”¯æŒå¤šç§ inputs å’Œ outputs æ’ä»¶ã€‚StatsD æ˜¯ä¸€ä¸ªä½¿ç”¨ Node.js å¼€å‘çš„ç½‘ç»œå®ˆæŠ¤è¿›ç¨‹ï¼Œé€šè¿‡ UDP æˆ–è€… TCP æ–¹å¼æ”¶é›†å„ç§ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¡æ•°å™¨å’Œå®šæ—¶å™¨ç­‰ã€‚ InfluxDB æ˜¯ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„å¼€æºçš„åˆ†å¸ƒå¼æ—¶åºã€äº‹ä»¶å’ŒæŒ‡æ ‡æ•°æ®åº“ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯å®ç°åˆ†å¸ƒå¼å’Œæ°´å¹³ä¼¸ç¼©æ‰©å±•ã€‚ Grafana æ˜¯ä¸€ä¸ªä½¿ç”¨ Angular + Go è¯­è¨€å¼€å‘çš„å¼€æºçš„ã€åŠŸèƒ½é½å…¨çš„ã€æ¼‚äº®çš„ä»ªè¡¨ç›˜å’Œå›¾è¡¨çš„ç¼–è¾‘å™¨ï¼Œå¯ç”¨æ¥åšæ—¥å¿—çš„åˆ†æä¸å±•ç¤ºæ›²çº¿å›¾ï¼ˆå¦‚ api çš„è¯·æ±‚æ—¥å¿—ï¼‰ï¼Œæ”¯æŒå¤šç§ backendï¼Œå¦‚ ElasticSearchã€InfluxDBã€OpenTSDB ç­‰ç­‰ã€‚ å·¥ä½œæµç¨‹ï¼šTelegraf å°† StatsDï¼ˆinputsï¼‰å’Œ InfluxDBï¼ˆoutputsï¼‰ç»“åˆèµ·æ¥ï¼Œå³å‘å¾€ StatsD çš„æ•°æ®ï¼Œæœ€ç»ˆé€šè¿‡ Telegraf å†™å…¥äº† InfluxDBï¼Œç„¶å Grafana è¯»å– InfluxDB çš„æ•°æ®å±•ç¤ºæˆå›¾è¡¨ã€‚ 7.1.2 å¯åŠ¨ docker-statsd-influxdb-grafanaæˆ‘ä»¬ä½¿ç”¨ Docker ä¸€é”®å¯åŠ¨ Telegraf(StatsD)+ InfluxDB + Grafanaï¼ŒèŠ‚çœæ­å»ºç¯å¢ƒçš„æ—¶é—´ã€‚ 12345678$ docker run -d \\ --name docker-statsd-influxdb-grafana \\ -p 3003:3003 \\ -p 3004:8083 \\ -p 8086:8086 \\ -p 22022:22 \\ -p 8125:8125/udp \\ samuelebistoletti/docker-statsd-influxdb-grafana:latest ç«¯å£æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š 1234567Host Container Service-----------------------------------3003 3003 grafana3004 8083 influxdb-admin8086 8086 influxdb8125 8125 statsd22022 22 sshd 7.1.3 ç†Ÿæ‚‰ InfluxDBå®¹å™¨å¯åŠ¨åï¼Œæµè§ˆå™¨è®¿é—® localhost:3004ï¼ˆä»¥ä¸‹ç§°ä¸º influxdb-adminï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š InfluxDB çš„åŸºæœ¬æ¦‚å¿µå¦‚ä¸‹ï¼š databaseï¼šæ•°æ®åº“ã€‚ measurementï¼šæ•°æ®åº“ä¸­çš„è¡¨ã€‚ pointï¼šè¡¨é‡Œé¢çš„ä¸€è¡Œæ•°æ®ï¼Œç”±æ—¶é—´æˆ³ï¼ˆtimeï¼‰ã€æ•°æ®ï¼ˆfieldï¼‰å’Œæ ‡ç­¾ï¼ˆtagï¼‰ç»„æˆ timeï¼šæ¯æ¡æ•°æ®è®°å½•çš„æ—¶é—´æˆ³ï¼Œæ˜¯æ•°æ®åº“ä¸­çš„ä¸»ç´¢å¼•ï¼ˆä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ã€‚ fieldï¼šå„ç§è®°å½•çš„å€¼ï¼ˆæ²¡æœ‰ç´¢å¼•çš„å±æ€§ï¼‰ã€‚ tagï¼šå„ç§æœ‰ç´¢å¼•çš„å±æ€§ã€‚ â€¦ InfluxDB é‡‡ç”¨äº†ç±» SQL çš„æŸ¥è¯¢è¯­æ³•ï¼Œä¾‹å¦‚ï¼š show databasesï¼šåˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ã€‚ show measurementsï¼šåˆ—å‡ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨ã€‚ select * from xxxï¼šåˆ—å‡º xxx è¡¨çš„æ‰€æœ‰æ•°æ®ã€‚ â€¦ æˆ‘ä»¬åœ¨ Query ä¸­è¾“å…¥ï¼š 1show databases æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š _interal æ˜¯ InfluxDB å†…éƒ¨ä½¿ç”¨çš„æ•°æ®åº“ï¼Œtelegraf æ˜¯æˆ‘ä»¬å½“å‰ Docker å®¹å™¨å¯åŠ¨åé»˜è®¤åˆ›å»ºçš„æµ‹è¯•æ•°æ®åº“ã€‚ 7.1.4 é…ç½® Grafanaç”¨æµè§ˆå™¨æ‰“å¼€ localhost:3003ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š è¾“å…¥ç”¨æˆ·å root å’Œå¯†ç  root ç™»å½•ï¼Œè¿›å…¥åˆå§‹åŒ–é…ç½®é¡µï¼Œå•å‡» â€œAdd data sourceâ€ï¼Œå¦‚ä¸‹å¡«å†™ï¼š å•å‡» â€œSave &amp; Testâ€ ä¿å­˜é…ç½®ã€‚ç›®å‰é…ç½®å¥½äº† Grafana é»˜è®¤çš„ datasource æ˜¯åä¸º api çš„ InfluxDBï¼Œæ¥ä¸‹æ¥åˆ›å»ºæµ‹è¯•ä»£ç ï¼Œäº§ç”Ÿæµ‹è¯•æ•°æ®ã€‚ 7.1.5 node-statsdnode-statsd æ˜¯ä¸€ä¸ª statsd çš„ Node.js clientã€‚åˆ›å»ºä»¥ä¸‹æµ‹è¯•ä»£ç ï¼š 12345678910111213141516const StatsD = require(&#x27;node-statsd&#x27;)const statsdClient = new StatsD(&#123; host: &#x27;localhost&#x27;, port: 8125&#125;)setInterval(() =&gt; &#123; const responseTime = Math.floor(Math.random() * 100) statsdClient.timing(&#x27;api&#x27;, responseTime, function (error, bytes) &#123; if (error) &#123; console.error(error) &#125; else &#123; console.log(`Successfully sent $&#123;bytes&#125; bytes, responseTime $&#123;responseTime&#125;ms`) &#125; &#125;)&#125;, 1000) è¿è¡Œä»¥ä¸Šä»£ç ï¼Œæ¯ä¸€ç§’é’Ÿä¼šäº§ç”Ÿä¸€ä¸ª 0~99 ä¹‹é—´çš„éšæœºå€¼ï¼ˆæ¨¡æ‹Ÿå“åº”æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼‰ï¼Œå‘é€åˆ° StatsDï¼ŒStatsD ä¼šé€šè¿‡ Telegraf å°†è¿™äº›æ•°æ®å†™å…¥ InfluxDB çš„ telegraf æ•°æ®åº“ã€‚ å›åˆ° influxdb-adminï¼Œå•å‡»å³ä¸Šè§’çš„ä¸‹æ‹‰èœå•åˆ‡æ¢åˆ° telegraf æ•°æ®åº“ï¼Œç„¶åè¾“å…¥ show measurements æŸ¥çœ‹å·²ç»å­˜åœ¨ api è¡¨äº†ï¼Œç„¶åè¾“å…¥ï¼š 1select * from api æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡º api è¡¨æœ‰ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š timeï¼šInfluxDB é»˜è®¤æ·»åŠ çš„æ—¶é—´æˆ³ã€‚ 90_percentileï¼šæ‰€æœ‰è®°å½•ä¸­ä»å°åˆ°å¤§ 90% é‚£ä¸ªç‚¹çš„å€¼ã€‚ countï¼šä¸€æ¬¡æ”¶é›†çš„æ—¥å¿—æ•°é‡ï¼Œå¯ä»¥çœ‹å‡ºæ¯æ¡è®°å½•ï¼ˆpointï¼‰çš„ count å€¼æ¥è¿‘æˆ–ç­‰äº 10ï¼Œè€Œæˆ‘ä»¬çš„æµ‹è¯•ä»£ç æ˜¯ 1s å‘é€ä¸€æ¡æ•°æ®ï¼Œä¹Ÿå°±è¯´æ˜ Telegraf é»˜è®¤è®¾ç½®æ˜¯ 10s æ”¶é›†ä¸€æ¬¡æ•°æ®ï¼Œé»˜è®¤é…ç½®ä¹Ÿçš„ç¡®æ˜¯è¿™æ ·çš„ï¼Œè§ï¼šhttps://github.com/samuelebistoletti/docker-statsd-influxdb-grafana/blob/master/telegraf/telegraf.confã€‚ hostï¼šæœºå™¨åœ°å€ã€‚ lowerï¼šæœ€å°çš„é‚£æ¡è®°å½•çš„å€¼ã€‚ meanï¼šæ‰€æœ‰è®°å½•çš„å¹³å‡å€¼ã€‚ metric_typeï¼šmetric ç±»å‹ã€‚ stddevï¼šæ‰€æœ‰è®°å½•çš„æ ‡å‡†å·®ã€‚ upperï¼šæœ€å¤§çš„é‚£æ¡è®°å½•çš„å€¼ã€‚ 7.1.6 åˆ›å»º Grafana å›¾è¡¨å›åˆ° Grafanaï¼Œå•å‡»å·¦ä¸Šè§’ Grafana å›¾æ ‡çš„ä¸‹æ‹‰èœå•ï¼Œå•å‡» Dashboards å›åˆ°ä»ªè¡¨ç›˜é¡µç»§ç»­å®Œæˆé…ç½®ï¼Œå•å‡» â€œNew dashboardâ€ï¼Œç„¶åå•å‡»åˆ›å»º Graph ç±»å‹çš„å›¾è¡¨ï¼Œå°±åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„å›¾è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å•å‡»å½“å‰çš„å›¾è¡¨ï¼Œé€‰æ‹© Editï¼Œä¿®æ”¹å¦‚ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š Metrics é…ç½®ä¸­é€‰æ‹© FROM -&gt; api è¡¨ï¼ŒSELECT -&gt; field(mean) å­—æ®µã€‚ Display é…ç½®ä¸­ â€œNull valueâ€ é€‰æ‹© connectedï¼Œå°†æ¯ä¸ªç‚¹è¿æˆæŠ˜çº¿ã€‚ æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š 7.1.7 æ¨¡æ‹ŸçœŸå®ç¯å¢ƒmiddlewares&#x2F;statsd.js 1234567891011121314151617181920const StatsD = require(&#x27;node-statsd&#x27;)const statsdClient = new StatsD(&#123; host: &#x27;localhost&#x27;, port: 8125&#125;)module.exports = function (routerName) &#123; return async function statsdMiddleware (ctx, next) &#123; const start = Date.now() try &#123; await next() const spent = Date.now() - start statsdClient.timing(`api_$&#123;routerName&#125;`, spent) &#125; catch (e) &#123; statsdClient.increment(`api_$&#123;routerName&#125;_$&#123;e.status || (ctx.status !== 404 ? ctx.status : 500)&#125;`) throw e &#125; &#125;&#125; server.js 12345678910111213141516171819202122const Bluebird = require(&#x27;bluebird&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()const statsd = require(&#x27;./middlewares/statsd&#x27;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/&#x27;, controller: [ statsd(&#x27;getHome&#x27;), async (ctx) =&gt; &#123; // æ¨¡æ‹Ÿååˆ†ä¹‹ä¸€å‡ºé”™æ¦‚ç‡ if (Math.random() &lt; 0.1) &#123; console.error(&#x27;error&#x27;) ctx.throw(400) &#125; // æ¨¡æ‹Ÿ 1-100 æ¯«ç§’å“åº”æ—¶é—´ const responseTime = Math.floor(Math.random() * 100 + 1) await Bluebird.delay(responseTime) console.log(`Spent $&#123;responseTime&#125;ms`) ctx.status = 200 &#125;]&#125;)app.listen(3000) client.js 123456789const axios = require(&#x27;axios&#x27;)setInterval(() =&gt; &#123; // æ¨¡æ‹Ÿ 1-10 çš„ tps const tps = Math.floor(Math.random() * 10 + 1) for (let i = 0; i &lt; tps; i++) &#123; axios.get(&#x27;http://localhost:3000&#x27;) &#125;&#125;, 1000) æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ«è¿è¡Œï¼š 12$ node server.js$ node client.js å›åˆ° influxdb-adminï¼Œè¾“å…¥ï¼š 1show measurements å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ api_getHome å’Œ api_getHome_400 è¡¨äº†ã€‚å›åˆ° Grafanaï¼Œåœ¨ä¸€è¡Œï¼ˆrowï¼‰é‡Œåˆ›å»ºä¸¤ä¸ªå›¾è¡¨ï¼Œåˆ†åˆ«ä¸ºï¼š è¯·æ±‚é‡ï¼šåŒ…å«äº†æ­£å¸¸è¯·æ±‚ï¼ˆ200ï¼‰å’Œé”™è¯¯è¯·æ±‚ï¼ˆ4xxã€5xx ç­‰ç­‰ï¼‰è¯·æ±‚é‡çš„æŠ˜çº¿å›¾ã€‚ å“åº”æ—¶é—´ï¼šæ­£å¸¸è¯·æ±‚çš„æœ€ä½ï¼ˆlowerï¼‰ã€å¹³å‡ï¼ˆmeanï¼‰ã€æœ€é«˜ï¼ˆupperï¼‰å“åº”æ—¶é—´çš„æŠ˜çº¿å›¾ã€‚ ä»¥ â€œgetHome å“åº”æ—¶é—´â€ çš„å›¾è¡¨ä¸ºä¾‹ï¼ŒMetrics é…ç½®æˆªå›¾å¦‚ä¸‹ï¼š 7.1.8 å‚è€ƒé“¾æ¥ https://www.cnblogs.com/shhnwangjian/p/6897216.html ä¸Šä¸€èŠ‚ï¼š6.5 Sentry ä¸‹ä¸€èŠ‚ï¼š7.2 Telegraf + InfluxDB + Grafana(ä¸‹)","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 6.5 Sentry","slug":"6.5 Sentry","date":"2019-11-03T06:00:00.000Z","updated":"2022-05-25T04:29:30.953Z","comments":true,"path":"2019/11/03/6.5 Sentry/","link":"","permalink":"https://marvinliu1.github.io/2019/11/03/6.5%20Sentry/","excerpt":"","text":"Node in Debugging 6.5.1 ä»€ä¹ˆæ˜¯ Sentryï¼ŸSentryå®˜ç½‘çš„ä»‹ç»ï¼š Sentryâ€™s real-time error tracking gives you insight into production deployments and information to reproduce and fix crashes. ç®€è€Œè¨€ä¹‹ï¼šSentry æ˜¯ä¸€ä¸ªå¼€æºçš„å®æ—¶é”™è¯¯æ—¥å¿—æ”¶é›†å¹³å°ã€‚ 6.5.2 å®‰è£… Sentryæˆ‘ä»¬ä½¿ç”¨ Docker å®‰è£…å¹¶å¯åŠ¨ Sentryï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š å¯åŠ¨ä¸€ä¸ª Redis å®¹å™¨ï¼Œå‘½åä¸º sentry-redisï¼š 1$ docker run -d --name sentry-redis redis å¯åŠ¨ä¸€ä¸ª Postgres å®¹å™¨ï¼Œå‘½åä¸º sentry-postgresï¼š 12345$ docker run -d \\ --name sentry-postgres \\ -e POSTGRES_PASSWORD=secret \\ -e POSTGRES_USER=sentry \\ postgres ç”Ÿæˆä¸€ä¸ª Sentry çš„ secret keyï¼š 1$ docker run --rm sentry config generate-secret-key å°†ä¸‹é¢çš„ &lt;secret-key&gt; éƒ½æ›¿æ¢æˆä¸Šé¢ç”Ÿæˆçš„ secret keyã€‚ å¦‚æœæ˜¯æ–°çš„æ•°æ®åº“ï¼ˆç¬¬ 1 æ¬¡è¿è¡Œï¼‰ï¼Œåˆ™éœ€è¦è¿è¡Œ upgradeï¼š 12345$ docker run -it --rm \\ -e SENTRY_SECRET_KEY=&#x27;&lt;secret-key&gt;&#x27; \\ --link sentry-postgres:postgres \\ --link sentry-redis:redis \\ sentry upgrade æŒ‰æ­¥éª¤å¡«å†™è‡ªå·±çš„ä¿¡æ¯ï¼š æœ€ç»ˆåˆ›å»ºäº†ä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜å’Œä¸€ä¸ªé»˜è®¤çš„åä¸º sentry çš„ç»„ç»‡ï¼ˆorganizationï¼‰ã€‚ å¯åŠ¨ Sentryï¼Œå¹¶å¯¹å¤–æš´éœ² 9000 ç«¯å£ï¼š 1234567$ docker run -d \\ --name my-sentry \\ -e SENTRY_SECRET_KEY=&#x27;&lt;secret-key&gt;&#x27; \\ --link sentry-redis:redis \\ --link sentry-postgres:postgres \\ -p 9000:9000 \\ sentry å¯åŠ¨ Celery cron å’Œ Celery workersï¼š 123456$ docker run -d \\ --name sentry-cron \\ -e SENTRY_SECRET_KEY=&#x27;&lt;secret-key&gt;&#x27; \\ --link sentry-postgres:postgres \\ --link sentry-redis:redis \\ sentry run cron 123456$ docker run -d \\ --name sentry-worker-1 \\ -e SENTRY_SECRET_KEY=&#x27;&lt;secret-key&gt;&#x27; \\ --link sentry-postgres:postgres \\ --link sentry-redis:redis \\ sentry run worker å°æç¤ºï¼šCelery æ˜¯ç”¨ Python å†™çš„ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¨¡å—ã€‚ å®Œæˆï¼ ç”¨æµè§ˆå™¨æ‰“å¼€ localhost:9000ï¼Œå°±èƒ½çœ‹åˆ° Sentry çš„ç™»å½•é¡µé¢äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š é¦–æ¬¡ç™»å½•æ—¶éœ€è¦å¡«å†™ä¸€äº›å¿…è¦ä¿¡æ¯ ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å•å‡» Continue è¿›å…¥ Sentry ä»ªè¡¨ç›˜ï¼ˆDashboardï¼‰ã€‚å•å‡»å³ä¸Šè§’çš„ New Project æŒ‰é’®åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œé€‰æ‹© Node.js å¹¶å¡«å†™é¡¹ç›®åç§°ä¸º APIï¼Œç„¶åå•å‡» Create Project æŒ‰é’®åˆ›å»ºé¡¹ç›®ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š åˆ›å»ºæˆåŠŸåè¿›å…¥ Node.js ä½¿ç”¨ç¤ºä¾‹é¡µé¢ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ Koa æµ‹è¯•ï¼Œåœ¨å³ä¾§é€‰æ‹© Koaï¼š ä¸Šå›¾æ‰€ç¤ºæ˜¯ koa@1 çš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬ä»¥ Palomaï¼ˆåŸºäº koa@2ï¼‰ä¸ºä¾‹ï¼Œç¼–å†™æµ‹è¯•ä»£ç ï¼š 1234567891011121314151617const Raven = require(&#x27;raven&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()Raven.config(DSN).install()app.on(&#x27;error&#x27;, (err) =&gt; &#123; Raven.captureException(err, (err, eventId) =&gt; &#123; console.log(&#x27;Reported error &#x27; + eventId) &#125;)&#125;)app.use((ctx) =&gt; &#123; throw new Error(&#x27;test&#x27;)&#125;)app.listen(3000) raven æ˜¯ Node.js ç‰ˆçš„ Sentry SDKï¼Œç”¨æ¥æ”¶é›†å’Œå‘é€é”™è¯¯æ—¥å¿—ã€‚ å°æç¤ºï¼šå°† DSN æ›¿æ¢ä¸ºä¸Šå›¾ä¸­çš„ http://xxx@localhost:9000/2ï¼ŒDSN æ—¢å‘Šè¯‰å®¢æˆ·ç«¯ Sentry æœåŠ¡å™¨çš„åœ°å€ï¼Œä¹Ÿç”¨æ¥å½“åšèº«ä»½è®¤è¯çš„ tokenã€‚ è¿è¡Œä»¥ä¸Šæµ‹è¯•ä»£ç ï¼Œè®¿é—® localhost:3000ï¼Œé”™è¯¯ä¿¡æ¯ä¼šå‘é€ç»™ Sentryã€‚Sentry å±•ç¤ºå¦‚ä¸‹ï¼š ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„ä¿¡æ¯ï¼š Sentry è¿˜æœ‰è®¸å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šé”™è¯¯å½’ç±»ã€å±•ç¤ºé”™è¯¯çš„é¢‘ç‡æŸ±çŠ¶å›¾ã€å°†é”™è¯¯æŒ‡æ´¾ç»™ç»„ç»‡ä¸­çš„æŸä¸ªäººã€ç»™é”™è¯¯æ·»åŠ æ ‡ç­¾ã€æŸ¥çœ‹è¿™ç±»é”™è¯¯äº‹ä»¶çš„å†å²ã€æ ‡è®°é”™è¯¯ä¸ºå·²è§£å†³ã€åœ¨é”™è¯¯ä¸‹å‘è¡¨è¯„è®ºã€è­¦æŠ¥ç­‰ç­‰åŠŸèƒ½ã€‚ 6.5.3 koa-ravenç¬”è€…å°† raven å°è£…æˆ Koa çš„ä¸€ä¸ªä¸­é—´ä»¶ã€‚ä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011const raven = require(&#x27;koa-raven&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(raven(DSN))app.use((ctx) =&gt; &#123; throw new Error(&#x27;test&#x27;)&#125;)app.listen(3000) æˆ–è€…ä½¿ç”¨ ctx.ravenï¼š 1234567891011121314151617const raven = require(&#x27;koa-raven&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(raven(DSN))app.use((ctx) =&gt; &#123; try &#123; throw new Error(&#x27;test&#x27;) &#125; catch (e) &#123; ctx.raven.captureException(e, &#123; extra: &#123; name: &#x27;tom&#x27; &#125; &#125;) ctx.status = 500 ctx.body = e.stack &#125;&#125;)app.listen(3000) 6.5.4 å‚è€ƒé“¾æ¥ https://sentry.io/ ä¸Šä¸€èŠ‚ï¼š6.4 OpenTracing + Jaeger ä¸‹ä¸€èŠ‚ï¼š7.1 Telegraf + InfluxDB + Grafana(ä¸Š)","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 6.4 OpenTracing + Jaeger","slug":"6.4 OpenTracing + Jaeger","date":"2019-10-28T06:00:00.000Z","updated":"2022-05-25T04:29:03.625Z","comments":true,"path":"2019/10/28/6.4 OpenTracing + Jaeger/","link":"","permalink":"https://marvinliu1.github.io/2019/10/28/6.4%20OpenTracing%20+%20Jaeger/","excerpt":"","text":"Node in Debugging 6.4.1 ä»€ä¹ˆæ˜¯ OpenTracingï¼ŸOpenTracing æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è¿½è¸ªè§„èŒƒã€‚OpenTracing é€šè¿‡æä¾›å¹³å°æ— å…³ã€å‚å•†æ— å…³çš„ APIï¼Œä¸ºåˆ†å¸ƒå¼è¿½è¸ªæä¾›ç»Ÿä¸€çš„æ¦‚å¿µå’Œæ•°æ®æ ‡å‡†ï¼Œä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿæ–¹ä¾¿çš„æ·»åŠ ï¼ˆæˆ–æ›´æ¢ï¼‰è¿½è¸ªç³»ç»Ÿçš„å®ç°ã€‚OpenTracing å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªæœ¯è¯­ï¼š Spanï¼šä»£è¡¨äº†ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé€»è¾‘å·¥ä½œå•å…ƒï¼Œå®ƒå…·æœ‰æ“ä½œåã€æ“ä½œå¼€å§‹æ—¶é—´ä»¥åŠæŒç»­æ—¶é•¿ã€‚Span å¯èƒ½ä¼šæœ‰åµŒå¥—æˆ–æ’åºï¼Œä»è€Œå¯¹å› æœå…³ç³»å»ºæ¨¡ã€‚ Tagsï¼šæ¯ä¸ª Span å¯ä»¥æœ‰å¤šä¸ªé”®å€¼å¯¹ï¼ˆkey: valueï¼‰å½¢å¼çš„ Tagsï¼ŒTags æ˜¯æ²¡æœ‰æ—¶é—´æˆ³çš„ï¼Œæ”¯æŒç®€å•åœ°å¯¹ Span è¿›è¡Œæ³¨è§£å’Œè¡¥å……ã€‚ Logsï¼šæ¯ä¸ª Span å¯ä»¥è¿›è¡Œå¤šæ¬¡ Log æ“ä½œï¼Œæ¯ä¸€æ¬¡ Log æ“ä½œï¼Œéƒ½éœ€è¦ä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„æ—¶é—´åç§°ï¼Œä»¥åŠå¯é€‰çš„ä»»æ„å¤§å°çš„å­˜å‚¨ç»“æ„ã€‚ Traceï¼šä»£è¡¨äº†ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ•°æ®&#x2F;æ‰§è¡Œè·¯å¾„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ª Spanï¼‰ï¼Œå¯ä»¥å°†å…¶ç†è§£ä¸º Span çš„æœ‰å‘æ— ç¯å›¾ã€‚ OpenTracing è¿˜æœ‰å…¶ä»–ä¸€äº›æ¦‚å¿µï¼Œè¿™é‡Œä¸è¿‡å¤šè§£é‡Šã€‚æˆ‘ä»¬çœ‹ä¸ªä¼ ç»Ÿçš„è°ƒç”¨å…³ç³»ä¾‹å­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿½è¸ªä¸€ä¸ªäº‹åŠ¡æˆ–è€…è°ƒç”¨æµä¸€èˆ¬å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚è™½ç„¶è¿™ç§å›¾å¯¹äºçœ‹æ¸…å„ç»„ä»¶çš„ç»„åˆå…³ç³»æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä½†æ˜¯ï¼Œå®ƒä¸èƒ½å¾ˆå¥½æ˜¾ç¤ºç»„ä»¶çš„è°ƒç”¨æ—¶é—´ï¼Œä»¥åŠæ˜¯ä¸²è¡Œè°ƒç”¨è¿˜æ˜¯å¹¶è¡Œè°ƒç”¨ã€‚å¦‚æœå±•ç°æ›´å¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œä¼šæ›´åŠ å¤æ‚ï¼Œç”šè‡³æ— æ³•ç”»å‡ºè¿™æ ·çš„å›¾ã€‚å¦å¤–ï¼Œè¿™ç§å›¾ä¹Ÿæ— æ³•æ˜¾ç¤ºè°ƒç”¨é—´çš„æ—¶é—´é—´éš”ä»¥åŠæ˜¯å¦é€šè¿‡å®šæ—¶è°ƒç”¨æ¥å¯åŠ¨è°ƒç”¨ã€‚ä¸€ç§æ›´æœ‰æ•ˆçš„å±•ç°ä¸€ä¸ªå…¸å‹çš„ trace è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™ç§å±•ç°æ–¹å¼å¢åŠ äº†æ‰§è¡Œæ—¶é—´çš„ä¸Šä¸‹æ–‡ï¼Œç›¸å…³æœåŠ¡é—´çš„å±‚æ¬¡å…³ç³»ï¼Œè¿›ç¨‹æˆ–è€…ä»»åŠ¡çš„ä¸²è¡Œæˆ–å¹¶è¡Œè°ƒç”¨å…³ç³»ã€‚è¿™æ ·çš„è§†å›¾æœ‰åŠ©äºå‘ç°ç³»ç»Ÿè°ƒç”¨çš„å…³é”®è·¯å¾„ã€‚é€šè¿‡å…³æ³¨å…³é”®è·¯å¾„çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé¡¹ç›®å›¢é˜Ÿå¯èƒ½ä¸“æ³¨äºä¼˜åŒ–è·¯å¾„ä¸­çš„å…³é”®ä½ç½®ï¼Œæœ€å¤§å¹…åº¦åœ°æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼šå¯ä»¥é€šè¿‡è¿½è¸ªä¸€ä¸ªèµ„æºå®šä½çš„è°ƒç”¨æƒ…å†µï¼Œæ˜ç¡®åº•å±‚çš„è°ƒç”¨æƒ…å†µï¼Œå‘ç°å“ªäº›æ“ä½œæœ‰é˜»å¡çš„æƒ…å†µã€‚ 6.4.2 ä»€ä¹ˆæ˜¯ Jaeger?Jaeger æ˜¯ OpenTracing çš„ä¸€ä¸ªå®ç°ï¼Œæ˜¯ Uber å¼€æºçš„ä¸€ä¸ªåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œå…¶çµæ„Ÿæ¥æºäºDapper å’Œ OpenZipkinã€‚ä» 2016 å¹´å¼€å§‹ï¼Œè¯¥ç³»ç»Ÿå·²ç»åœ¨ Uber å†…éƒ¨å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ï¼Œå®ƒå¯ä»¥ç”¨äºå¾®æœåŠ¡æ¶æ„åº”ç”¨çš„ç›‘æ§ï¼Œç‰¹æ€§åŒ…æ‹¬åˆ†å¸ƒå¼ä¸Šä¸‹æ–‡ä¼ æ’­ï¼ˆDistributed context propagationï¼‰ã€åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§ã€æ ¹åŸå› åˆ†æã€æœåŠ¡ä¾èµ–åˆ†æä»¥åŠæ€§èƒ½ä¼˜åŒ–ã€‚è¯¥é¡¹ç›®å·²ç»è¢«äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCloud Native Computing Foundationï¼ŒCNCFï¼‰æ¥çº³ä¸ºç¬¬ 12 ä¸ªé¡¹ç›®ã€‚ 6.4.3 å¯åŠ¨ Jaeger + Jaeger UIæˆ‘ä»¬ä½¿ç”¨ Docker å¯åŠ¨ Jaeger + Jaeger UIï¼ˆJaeger å¯è§†åŒ– web æ§åˆ¶å°ï¼‰ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1234567$ docker run -d -p5775:5775/udp \\ -p 6831:6831/udp \\ -p 6832:6832/udp \\ -p 5778:5778 \\ -p 16686:16686 \\ -p 14268:14268 \\ jaegertracing/all-in-one:latest ç”¨æµè§ˆå™¨æ‰“å¼€ localhost:16686ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ç°åœ¨å¹¶æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Jaeger æ¥æ”¶å¹¶æŸ¥è¯¢æ—¥å¿—ã€‚ 6.4.4 å¦‚ä½•ä½¿ç”¨ OpenTracing + Jaeger?OpenTracing å’Œ Jaeger åˆ†åˆ«æä¾›äº† JavaScript&#x2F;Node.js çš„ SDKï¼š opentracing&#x2F;opentracing-javascript jaegertracing&#x2F;jaeger-client-node opentracing ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930const http = require(&#x27;http&#x27;)const opentracing = require(&#x27;opentracing&#x27;)// NOTE: the default OpenTracing tracer does not record any tracing information.// Replace this line with the tracer implementation of your choice.const tracer = new opentracing.Tracer()const span = tracer.startSpan(&#x27;http_request&#x27;)const opts = &#123; host : &#x27;example.com&#x27;, method: &#x27;GET&#x27;, port : &#x27;80&#x27;, path: &#x27;/&#x27;,&#125;http.request(opts, res =&gt; &#123; res.setEncoding(&#x27;utf8&#x27;) res.on(&#x27;error&#x27;, err =&gt; &#123; // assuming no retries, mark the span as failed span.setTag(opentracing.Tags.ERROR, true) span.log(&#123;&#x27;event&#x27;: &#x27;error&#x27;, &#x27;error.object&#x27;: err, &#x27;message&#x27;: err.message, &#x27;stack&#x27;: err.stack&#125;) span.finish() &#125;) res.on(&#x27;data&#x27;, chunk =&gt; &#123; span.log(&#123;&#x27;event&#x27;: &#x27;data_received&#x27;, &#x27;chunk_length&#x27;: chunk.length&#125;) &#125;) res.on(&#x27;end&#x27;, () =&gt; &#123; span.log(&#123;&#x27;event&#x27;: &#x27;request_end&#x27;&#125;) span.finish() &#125;)&#125;).end() æœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦è§£é‡Šï¼š éœ€è¦å°†ä¸Šé¢çš„ const tracer = new opentracing.Tracer() æ›¿æ¢æˆè‡ªå·±çš„ tracer å®ç°ï¼Œå³ Jaeger çš„å®ç°ã€‚ é€šè¿‡ tracer.startSpan å¯åŠ¨ä¸€ä¸ª Spanï¼Œspan.setTag ç”¨æ¥è®¾ç½® Tagsï¼Œspan.log ç”¨æ¥è®¾ç½® Logsï¼Œspan.finish ç”¨æ¥ç»“æŸä¸€ä¸ª Spanã€‚ è¿™æœ‰ç‚¹ç±»ä¼¼äºæˆ‘ä»¬çš„æ‰‹åŠ¨åŸ‹ç‚¹ï¼Œåªä¸è¿‡å˜æˆäº†ä¸€ä¸ªè§„èŒƒè€Œå·²ã€‚ä½† OpenTracing çš„åŠŸèƒ½ä¸æ­¢å¦‚æ­¤ï¼Œä¸Šé¢åªæ˜¯ä¸€ä¸ª Span çš„ç”¨æ³•ï¼ŒSpan ä¹‹é—´è¿˜å¯ä»¥å…³è”è°ƒç”¨å…³ç³»ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ª DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬æ­£åœ¨åšå¾®æœåŠ¡ï¼Œå¤šä¸ªæœåŠ¡ä¹‹é—´æœ‰è°ƒç”¨å…³ç³»ï¼ˆä¸ç®¡æ˜¯ HTTP è¿˜æ˜¯ RPC ç­‰ï¼‰ï¼Œæ¯æ¬¡è°ƒç”¨æœåŠ¡åœ¨å†…éƒ¨å¯èƒ½äº§ç”Ÿå¤šä¸ª Spanï¼Œæœ€ç»ˆä¼šåœ¨ Jaeger æ§åˆ¶å°é¡µé¢çœ‹åˆ°ä¸€ä¸ªå®Œæ•´çš„ Trace å’Œ DAG å›¾ï¼ˆå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼‰ã€‚ jaeger-client-node ä½¿ç”¨å¦‚ä¸‹ï¼š 12345const tracer = new jaeger.Tracer( serviceName, new jaeger.RemoteReporter(new UDPSender()), new jaeger.RateLimitingSampler(1)) åˆ›å»ºä¸€ä¸ª tracerï¼Œå¯ä»¥æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼š serviceNameï¼šæœåŠ¡åã€‚ Reporterï¼šä¸ŠæŠ¥å™¨ï¼Œå³å¾€å“ªå‘æ—¥å¿—ï¼Œå¦‚ä¸Šè¿°ä»£ç æ˜¯é€šè¿‡ UDP å‘é€æ—¥å¿—ï¼Œé»˜è®¤åœ°å€ localhost:6832ã€‚ Samplerï¼šé‡‡æ ·å™¨ï¼Œå³æ—¥å¿—å¦‚ä½•é‡‡æ ·ï¼Œå¦‚ä¸Šè¿°ä»£ç æ˜¯é™åˆ¶ 1 ç§’é‡‡æ ·ä¸€æ¬¡ã€‚ è¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»å…¶å®ƒé€‰é¡¹ï¼Œè¯»è€…å¯è‡ªè¡Œå»æŸ¥é˜… jaeger-client-node çš„æ–‡æ¡£ã€‚ 6.4.5 koa-await-breakpoint-jaegeré€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä½¿ç”¨ Jaeger æ—¶éœ€è¦æ‰‹åŠ¨åŸ‹ç‚¹ã€‚å‰é¢æˆ‘ä»¬ä»‹ç»äº† koa-await-breakpoint æ—¥å¿—è‡ªåŠ¨æ‰“ç‚¹ï¼Œå¯è‡ªå®šä¹‰ storeï¼Œkoa-await-breakpoint-jaeger æ˜¯ä¸º koa-await-breakpoint å†™çš„ store çš„ adaptorï¼Œåœ¨å®ç°ä¸Šæœ‰ä¸€äº›å°æŠ€å·§ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»è¯»ä¸‹æºç ã€‚ è¿˜æ˜¯ä»¥ koa-await-breakpoint çš„ example ä¸¾ä¾‹ï¼Œåªæ·»åŠ äº†ä¸¤è¡Œä»£ç å¼•å…¥ jaeger çš„ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š app.js 1234567891011121314const JaegerStore = require(&#x27;koa-await-breakpoint-jaeger&#x27;)const koaAwaitBreakpoint = require(&#x27;koa-await-breakpoint&#x27;)(&#123; name: &#x27;api&#x27;, files: [&#x27;./routes/*.js&#x27;], store: new JaegerStore()&#125;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(koaAwaitBreakpoint)app.route(&#123; method: &#x27;POST&#x27;, path: &#x27;/users&#x27;, controller: require(&#x27;./routes/user&#x27;).createUser &#125;)app.listen(3000) è¿è¡Œï¼š 1$ curl -XPOST localhost:3000/users åˆ·æ–° localhost:16686ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æœ‰æ—¥å¿—äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š é€‰æ‹© Sercice -&gt; apiï¼ŒOperation -&gt; POST &#x2F;usersï¼Œå•å‡» Find Traces æŸ¥çœ‹æ‰€æœ‰ç»“æœï¼Œå³ä¾§å±•ç¤ºäº†ä¸€æ¡æ—¥å¿—ï¼Œç‚¹è¿›å»å¦‚ä¸‹æ‰€ç¤ºï¼š å°æç¤ºï¼šå¯ä»¥æ ¹æ® tags è¿‡æ»¤ç»“æœã€‚ æ³¨æ„ï¼šJaeger æ˜¯åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œé€šå¸¸ç”¨æ¥è¿½è¸ªå¤šä¸ªæœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œè€Œè¿™é‡Œç”¨æ¥è¿½è¸ªä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªå‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€‚ ä¿®æ”¹ routes&#x2F;user.js çš„ createComment å‡½æ•° throw ä¸€ä¸ª new Error(&#39;test&#39;)ï¼Œé‡æ–°è¿è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼ŒJaeger å®Œç¾åœ°å±•ç°äº†åœ¨ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œå‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€å±‚çº§å…³ç³»åŠè€—æ—¶ï¼Œç”šè‡³å‡½æ•°ä½“å’Œé”™è¯¯æ ˆéƒ½æœ‰ï¼ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ requestId å» ELK ä¸­æŸ¥è¯¢æ—¥å¿—äº†ã€‚ 6.4.6 å‚è€ƒé“¾æ¥ https://wu-sheng.gitbooks.io/opentracing-io/content/ https://segmentfault.com/a/1190000008895129 http://www.infoq.com/cn/news/2017/11/Uber-open-spurce-Jaeger ä¸Šä¸€èŠ‚ï¼š6.3 ELK ä¸‹ä¸€èŠ‚ï¼š6.5 Sentry","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 6.3 ELK","slug":"6.3 ELK","date":"2019-10-15T06:00:00.000Z","updated":"2022-05-25T04:28:29.086Z","comments":true,"path":"2019/10/15/6.3 ELK/","link":"","permalink":"https://marvinliu1.github.io/2019/10/15/6.3%20ELK/","excerpt":"","text":"Node in Debugging ELK æ˜¯ ElasticSearch + Logstash + Kibana è¿™å¥—ç»„åˆå·¥å…·çš„ç®€ç§°ï¼Œæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ—¥å¿—ç³»ç»Ÿã€‚ ElasticSearchï¼šæ˜¯ä¸€æ¬¾å¼€æºçš„åŸºäº Lucene ä¹‹ä¸Šå®ç°çš„ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå­˜å‚¨å¼•æ“ï¼ˆä¾‹å¦‚ï¼šæ—¥å¿—ï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æœ‰ï¼šåˆ†å¸ƒå¼ã€é›¶é…ç½®ã€è‡ªåŠ¨å‘ç°ã€ç´¢å¼•è‡ªåŠ¨åˆ†ç‰‡ã€ç´¢å¼•å‰¯æœ¬æœºåˆ¶ã€Restful é£æ ¼çš„æ¥å£ã€å¤šæ•°æ®æºå’Œè‡ªåŠ¨æœç´¢è´Ÿè½½ç­‰ã€‚ Logstashï¼šæ˜¯ä¸€æ¬¾å¼€æºçš„æ—¥å¿—æ”¶é›†å·¥å…·ï¼Œå®ƒå¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œæ”¶é›†ã€åˆ†æã€è¿‡æ»¤ï¼Œå¹¶å°†å…¶å­˜å‚¨ï¼ˆä¾‹å¦‚ï¼šElasticSearchï¼‰èµ·æ¥ä¾›ä»¥åä½¿ç”¨ã€‚ Kibanaï¼šæ˜¯ä¸€æ¬¾å¼€æºçš„å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥ä¸º ElasticSearch æä¾›çš„æ—¥å¿—åˆ†æå‹å¥½çš„ Web ç•Œé¢ï¼Œå¯ä»¥æ±‡æ€»ã€åˆ†æå’Œæœç´¢é‡è¦çš„æ•°æ®æ—¥å¿—ã€‚ 6.3.1 å®‰è£… ELKæˆ‘ä»¬ä½¿ç”¨ Docker å®‰è£… ELKï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 12345$ docker run -p 5601:5601 \\ -p 9200:9200 \\ -p 5044:5044 \\ -p 15044:15044/udp \\ -it --name elk sebp/elk è¿›å…¥å®¹å™¨ï¼š 1$ docker exec -it elk /bin/bash è¿è¡Œä»¥ä¸‹å‘½ä»¤è®¾ç½® logstash çš„ input å’Œ outputï¼š 12# /opt/logstash/bin/logstash --path.data /tmp/logstash/data \\ -e &#x27;input &#123; udp &#123; codec =&gt; &quot;json&quot; port =&gt; 15044 &#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; [&quot;localhost&quot;] &#125; &#125;&#x27; è¿™é‡Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ª 15044 çš„ UDP ç«¯å£ï¼Œç”¨æ¥æ¥æ”¶é€šè¿‡ UDP å‘é€åˆ° Logstash çš„æ—¥å¿—ã€‚ ç”¨æµè§ˆå™¨æ‰“å¼€ localhost:5601ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ç›®å‰è¿˜æ²¡æœ‰æŒ‡å®š indexï¼ˆElasticSearch çš„ index ç±»ä¼¼äº MySQL&#x2F;MongoDB ä¸­çš„ databaseï¼‰ï¼Œå³æ—¥å¿—æ¥æºã€‚ä¸‹é¢æˆ‘ä»¬å°è¯•å‘ ELK ä¸­å†™å…¥ä¸€äº›æ—¥å¿—ã€‚ 6.3.2 ä½¿ç”¨ ELKè¿™é‡Œä»ç„¶ä»¥ä½¿ç”¨ koa-await-breakpoint ä¸ºä¾‹ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•å°†æ—¥å¿—å‘é€åˆ° ELKã€‚ app.js 12345678910111213const koaAwaitBreakpoint = require(&#x27;koa-await-breakpoint&#x27;)(&#123; name: &#x27;api&#x27;, files: [&#x27;./routes/*.js&#x27;], store: require(&#x27;./logger&#x27;)&#125;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(koaAwaitBreakpoint)app.route(&#123; method: &#x27;POST&#x27;, path: &#x27;/users&#x27;, controller: require(&#x27;./routes/user&#x27;).createUser &#125;)app.listen(3000) logger.js 1234567891011121314151617const Logstash = require(&#x27;logstash-client&#x27;)const logstash = new Logstash(&#123; type: &#x27;udp&#x27;, host: &#x27;localhost&#x27;, port: 15044&#125;)module.exports = &#123; save (log) &#123; if (log.error) &#123; log.errMsg = log.error.message log.errStack = log.error.stack &#125; logstash.send(log) &#125;&#125; routes&#x2F;user.js 1234567891011121314151617181920212223242526272829303132333435363738const Mongolass = require(&#x27;mongolass&#x27;)const mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;)const User = mongolass.model(&#x27;User&#x27;)const Post = mongolass.model(&#x27;Post&#x27;)const Comment = mongolass.model(&#x27;Comment&#x27;)exports.createUser = async function (ctx) &#123; const name = ctx.query.name || &#x27;default&#x27; const age = +ctx.query.age || 18 await createUser(name, age) ctx.status = 204&#125;async function createUser (name, age) &#123; const user = (await User.create(&#123; name, age &#125;)).ops[0] await createPost(user)&#125;async function createPost (user) &#123; const post = (await Post.create(&#123; uid: user._id, title: &#x27;post&#x27;, content: &#x27;post&#x27; &#125;)).ops[0] await createComment(user, post)&#125;async function createComment (user, post) &#123; await Comment.create(&#123; userId: user._id, postId: post._id, content: &#x27;comment&#x27; &#125;)&#125; è¿è¡Œï¼š 1$ curl -XPOST localhost:3000/users æ­¤æ—¶åˆ·æ–° Kibanaï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š åœ¨åˆæ¬¡ä½¿ç”¨ Kibana æ—¶ï¼Œéœ€è¦é…ç½® Kibana ä» ElasticSearch çš„å“ªäº› index ä¸­æœç´¢æ—¥å¿—ï¼Œæˆ‘ä»¬åœ¨ Index pattern å¤„å¡« logstash-*ï¼Œç„¶åå•å‡» Next step æŒ‰é’®ï¼Œåœ¨ Time Filter field name ä¸­é€‰æ‹© timestampï¼Œå•å‡» Create index pattern å®Œæˆé…ç½®ã€‚ æ³¨æ„ï¼šæˆ‘ä»¬é€‰æ‹© timestamp è€Œä¸æ˜¯é»˜è®¤çš„ @timestampï¼Œæ˜¯å› ä¸ºåœ¨ koa-await-breakpoint çš„æ—¥å¿—ä¸­æœ‰ timestamp å­—æ®µã€‚ å•å‡»å·¦ä¾§ç›®å½•çš„ Discoverï¼Œæˆ‘ä»¬å‘ç°å·²ç»æœ‰æ—¥å¿—äº†ã€‚åˆ†åˆ«å•å‡»å·¦ä¾§å‡ºç°çš„ Available Fields çš„ fnã€typeã€stepã€takeï¼Œç„¶åæŒ‰ step å‡åºå±•ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š æ˜¯ä¸æ˜¯ä¸€ç›®äº†ç„¶ï¼æˆ‘ä»¬æŠŠæ¯ä¸ªè¯·æ±‚çš„æ¯ä¸€æ­¥çš„å‡½æ•°åŠå…¶æ‰§è¡Œæ—¶é—´éƒ½è®°å½•ä¸‹æ¥äº†ã€‚ ä¿®æ”¹ routes&#x2F;users.js çš„ createCommentï¼Œthrow ä¸€ä¸ª new Error(&#39;test&#39;)ã€‚é‡å¯ç¨‹åºå¹¶å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼ŒELK æ˜¾ç¤ºå¦‚ä¸‹ï¼š å°æç¤ºï¼šåœ¨å®é™…åº”ç”¨ä¸­ä¼šæœ‰éå¸¸å¤šçš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ requestId æ‰¾åˆ°ä¸€ä¸ªè¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—ï¼Œåœ¨ 7.2 å°èŠ‚ä¼šè®²è§£ã€‚ ELK éå¸¸å¼ºå¤§ï¼ŒåŸºæœ¬èƒ½æ»¡è¶³æ‰€æœ‰æ—¥å¿—æŸ¥è¯¢éœ€æ±‚ï¼ŒKibana çš„æŸ¥è¯¢ä½¿ç”¨ lucene è¯­æ³•ï¼Œç”¨ 10 åˆ†é’Ÿå·¦å³å°±èƒ½å¤§ä½“ä¸Šæ‰‹ã€‚Kibana è¿˜èƒ½åˆ›å»ºå„ç§ä»ªè¡¨ç›˜å’Œèšåˆå›¾è¡¨ï¼Œè¯»è€…å¯è‡ªè¡Œå°è¯•ã€‚ 6.3.3 å‚è€ƒé“¾æ¥ http://blog.51cto.com/baidu/1676798 http://elk-docker.readthedocs.io ä¸Šä¸€èŠ‚ï¼š6.2 async_hooks ä¸‹ä¸€èŠ‚ï¼š6.4 OpenTracing + Jaeger","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 6.2 Async Hooks","slug":"6.2 async_hooks","date":"2019-09-29T06:00:00.000Z","updated":"2022-05-25T04:28:09.798Z","comments":true,"path":"2019/09/29/6.2 async_hooks/","link":"","permalink":"https://marvinliu1.github.io/2019/09/29/6.2%20async_hooks/","excerpt":"","text":"Node in Debugging ä¸Šä¸€å°èŠ‚è®²è§£äº† koa-await-breakpoint çš„ç”¨æ³•ï¼Œä½† koa-await-breakpoint ä»ç„¶æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºæ†¾ï¼Œå³æ— æ³•è®°å½•é™¤ routes&#x2F;controllers å¤–çš„å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ï¼ˆå› ä¸ºè·å–ä¸åˆ°å½“å‰è¯·æ±‚çš„ ctxï¼‰ã€‚ä¸¾ä¸ªé€šä¿—çš„ä¾‹å­ï¼šåœ¨ä¸€ä¸ªè·¯ç”±çš„ controller é‡Œé¢è°ƒç”¨äº† A ï¼ŒA è°ƒç”¨äº†å…¶ä»–æ–‡ä»¶çš„ B ï¼ŒB åˆè°ƒç”¨äº†å…¶ä»–æ–‡ä»¶çš„ Câ€¦è¿™æ˜¯éå¸¸å¸¸è§çš„ç”¨æ³•ï¼Œä½†ä¹‹å‰ä½¿ç”¨ koa-await-breakpoint åªèƒ½è·å– A çš„æ‰§è¡Œæ—¶é—´ï¼Œæ— æ³•è·å– B å’Œ C çš„æ‰§è¡Œæ—¶é—´ã€‚ æ ¹æœ¬åŸå› åœ¨äºï¼šæ— æ³•çŸ¥é“å‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œå³ B ä¸çŸ¥é“æ˜¯ A è°ƒç”¨çš„å®ƒï¼Œå³ä¾¿çŸ¥é“ä¹Ÿä¸çŸ¥é“æ˜¯å“ªæ¬¡è¯·æ±‚åˆ°æ¥æ—¶æ‰§è¡Œçš„ A è°ƒç”¨çš„å®ƒã€‚ ä½†æ˜¯ï¼Œ&#110;&#x6f;&#100;&#x65;&#x40;&#56;&#46;&#49; å¼•å…¥äº†ä¸€ä¸ªé»‘é­”æ³•â€”â€”Async Hooksã€‚ 6.2.1 Async Hooksæˆ‘ä»¬å…ˆçœ‹çœ‹ async_hooks æ˜¯ä»€ä¹ˆã€‚Node.js å®˜ç½‘å¯¹ async_hooks çš„ä»‹ç»ä¸ºï¼š The async_hooks module provides an API to register callbacks tracking the lifetime of asynchronous resources created inside a Node.js application. ä¸€å¥è¯æ¦‚æ‹¬ï¼šasync_hooks ç”¨æ¥è¿½è¸ª Node.js ä¸­å¼‚æ­¥èµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚ æˆ‘ä»¬æ¥çœ‹æ®µæµ‹è¯•ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738const fs = require(&#x27;fs&#x27;)const async_hooks = require(&#x27;async_hooks&#x27;)async_hooks.createHook(&#123; init (asyncId, type, triggerAsyncId, resource) &#123; fs.writeSync(1, `$&#123;type&#125;($&#123;asyncId&#125;): trigger: $&#123;triggerAsyncId&#125;\\n`) &#125;, destroy (asyncId) &#123; fs.writeSync(1, `destroy: $&#123;asyncId&#125;\\n`); &#125;&#125;).enable()async function A () &#123; fs.writeSync(1, `A -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`) setTimeout(() =&gt; &#123; fs.writeSync(1, `A in setTimeout -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`) B() &#125;)&#125;async function B () &#123; fs.writeSync(1, `B -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`) process.nextTick(() =&gt; &#123; fs.writeSync(1, `B in process.nextTick -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`) C() C() &#125;)&#125;function C () &#123; fs.writeSync(1, `C -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`) Promise.resolve().then(() =&gt; &#123; fs.writeSync(1, `C in promise.then -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`) &#125;)&#125;fs.writeSync(1, `top level -&gt; $&#123;async_hooks.executionAsyncId()&#125;\\n`)A() async_hooks.createHook å¯ä»¥æ³¨å†Œ 4 ä¸ªæ–¹æ³•æ¥è·Ÿè¸ªæ‰€æœ‰å¼‚æ­¥èµ„æºçš„åˆå§‹åŒ–ï¼ˆinitï¼‰ã€å›è°ƒä¹‹å‰ï¼ˆbeforeï¼‰ã€å›è°ƒä¹‹åï¼ˆafterï¼‰ã€é”€æ¯åï¼ˆdestroyï¼‰äº‹ä»¶ï¼Œå¹¶é€šè¿‡è°ƒç”¨ .enable() å¯ç”¨ï¼Œè°ƒç”¨ .disable() å…³é—­ã€‚ è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒå¼‚æ­¥èµ„æºçš„åˆå§‹åŒ–å’Œé”€æ¯çš„äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨ fs.writeSync(1, msg) æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼ŒwriteSync çš„ç¬¬ 1 ä¸ªå‚æ•°æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦ï¼Œ1 è¡¨ç¤ºæ ‡å‡†è¾“å‡ºã€‚ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ console.log å‘¢ï¼Ÿå› ä¸º console.log æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå¦‚æœåœ¨ initã€beforeã€after å’Œ destroy äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å‡ºç°ï¼Œå°±ä¼šå¯¼è‡´æ— é™å¾ªç¯ï¼ŒåŒç†ä¹Ÿä¸èƒ½ä½¿ç”¨ä»»ä½•å…¶ä»–çš„å¼‚æ­¥æ“ä½œã€‚ è¿è¡Œè¯¥ç¨‹åºï¼Œæ‰“å°å¦‚ä¸‹ï¼š 123456789101112131415161718192021top level -&gt; 1PROMISE(6): trigger: 1A -&gt; 1Timeout(7): trigger: 1TIMERWRAP(8): trigger: 1A in setTimeout -&gt; 7PROMISE(9): trigger: 7B -&gt; 7TickObject(10): trigger: 7B in process.nextTick -&gt; 10C -&gt; 10PROMISE(11): trigger: 10PROMISE(12): trigger: 11C -&gt; 10PROMISE(13): trigger: 10PROMISE(14): trigger: 13C in promise.then -&gt; 12C in promise.then -&gt; 14destroy: 7destroy: 10destroy: 8 è¿™æ®µç¨‹åºçš„æ‰“å°ç»“æœåŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼Œä¸‹é¢é€ä¸€è¿›è¡Œè§£é‡Šï¼š ä¸ºäº†å®ç°å¯¹å¼‚æ­¥èµ„æºçš„è·Ÿè¸ªï¼ŒNode.js å¯¹æ¯ä¸€ä¸ªå‡½æ•°ï¼ˆä¸è®ºå¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼‰æä¾›äº†ä¸€ä¸ª async scopeï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ async_hooks.executionAsyncId() æ¥è·å–å‡½æ•°å½“å‰çš„ async scope çš„ idï¼ˆç§°ä¸º asyncIdï¼‰ï¼Œé€šè¿‡è°ƒç”¨ async_hooks.triggerAsyncId() æ¥è·å–å½“å‰å‡½æ•°è°ƒç”¨è€…çš„ asyncIdã€‚ å¼‚æ­¥èµ„æºåœ¨åˆ›å»ºæ—¶è§¦å‘ init äº‹ä»¶å‡½æ•°ï¼Œinit å‡½æ•°ä¸­çš„ç¬¬ 1 ä¸ªå‚æ•°ä»£è¡¨è¯¥å¼‚æ­¥èµ„æºçš„ asyncIdï¼Œtype è¡¨ç¤ºå¼‚æ­¥èµ„æºçš„ç±»å‹ï¼ˆä¾‹å¦‚ TCPWRAPã€PROMISEã€Timeoutã€Immediateã€TickObject ç­‰ç­‰ï¼‰ï¼ŒtriggerAsyncId è¡¨ç¤ºè¯¥å¼‚æ­¥èµ„æºçš„è°ƒç”¨è€…çš„ asyncIdã€‚å¼‚æ­¥èµ„æºåœ¨é”€æ¯æ—¶è§¦å‘ destroy äº‹ä»¶å‡½æ•°ï¼Œè¯¥å‡½æ•°åªæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå³è¯¥å¼‚æ­¥èµ„æºçš„ asyncIdã€‚ å‡½æ•°è°ƒç”¨å…³ç³»æ˜ç¡®ã€‚æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„æ‰“å°ç»“æœå¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹å‡ºï¼ˆä»ä¸‹å¾€ä¸Šçœ‹ï¼‰ ï¼šCï¼ˆasyncId: 10ï¼‰è¢« Bï¼ˆasyncId: 7ï¼‰è°ƒç”¨ï¼ŒBï¼ˆasyncId: 7ï¼‰è¢« Aï¼ˆasyncId: 1ï¼‰è°ƒç”¨ã€‚è€Œä¸” C çš„ promise.then é‡Œé¢çš„ asyncIdï¼ˆå€¼ä¸º 12&#x2F;14ï¼‰ä¹Ÿå¯ä»¥é€šè¿‡ 12&#x2F;14 -&gt; 11&#x2F;13 -&gt; 10 å®šä½åˆ° C çš„ asyncIdï¼ˆå€¼ä¸º 10ï¼‰ã€‚ åŒæ­¥å‡½æ•°æ¯æ¬¡è°ƒç”¨çš„ asyncId éƒ½ä¸€æ ·ï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼ŒC è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œéƒ½æ‰“å°äº† C -&gt; 10ï¼Œä¸è°ƒç”¨æ–¹çš„ä½œç”¨åŸŸçš„ asyncId ä¸€è‡´ï¼Œå³å¦‚ä¸Šæ‰€ç¤ºæ‰“å°çš„ B in process.nextTick -&gt; 10ã€‚å¼‚æ­¥å‡½æ•°æ¯æ¬¡è°ƒç”¨çš„ asyncId éƒ½ä¸ä¸€æ ·ï¼Œå³å¦‚ä¸Šæ‰€ç¤ºæ‰“å°çš„ C in promise.then -&gt; 12 å’Œ C in promise.then -&gt; 14ã€‚ æœ€å¤–å±‚ä½œç”¨åŸŸçš„ asyncId æ€»æ˜¯ 1ï¼Œæ¯ä¸ªå¼‚æ­¥èµ„æºåœ¨åˆ›å»ºæ—¶ asyncId å…¨å±€é€’å¢ã€‚ ä¸Šé¢ 5 æ¡ç»“è®ºéå¸¸é‡è¦ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ async_hooks æ”¹é€  koa-await-breakpointã€‚ 6.2.2 æ”¹é€  koa-await-breakpointæˆ‘ä»¬é€šè¿‡å‰é¢çš„ç»“è®ºå·²ç»çŸ¥é“ï¼Œä½¿ç”¨ async_hooks æ—¶å¯ä»¥é€šè¿‡ asyncId ä¸²èµ·å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼Œä½†æ˜¯å¦‚ä½•å°†è¿™äº›å‡½æ•°çš„è°ƒç”¨é“¾ä¸ koa æ¥æ”¶çš„æ¯ä¸ªè¯·æ±‚å…³è”èµ·æ¥å‘¢? é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªå…¨å±€ Mapï¼Œå­˜å‚¨å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼š 1234567891011121314151617181920212223242526const async_hooks = require(&#x27;async_hooks&#x27;)const asyncIdMap = new Map()async_hooks.createHook(&#123; init (asyncId, type, triggerAsyncId) &#123; const ctx = getCtx(triggerAsyncId) if (ctx) &#123; asyncIdMap.set(asyncId, ctx) &#125; else &#123; asyncIdMap.set(asyncId, triggerAsyncId) &#125; &#125;, destroy (asyncId) &#123; asyncIdMap.delete(asyncId) &#125;&#125;).enable()function getCtx (asyncId) &#123; if (!asyncId) &#123; return &#125; if (typeof asyncId === &#x27;object&#x27; &amp;&amp; asyncId.app) &#123; return asyncId &#125; return getCtx(asyncIdMap.get(asyncId))&#125; æœ‰ä»¥ä¸‹ä¸‰ç‚¹éœ€è¦è§£é‡Šï¼š å®šä¹‰äº†ä¸€ä¸ªå…¨å±€ Map æ¥å­˜å‚¨å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼Œåœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¸‹é¢ä¼šè®²åˆ°ï¼‰å°†å½“å‰è¯·æ±‚çš„ ctx å­˜å‚¨åˆ° Map ä¸­ï¼Œkey æ˜¯ asyncIdã€‚ æ¯ä¸ªå¼‚æ­¥èµ„æºåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šå°è¯•é€šè¿‡ asyncId å‘ä¸Šå¯»æ‰¾ç¥–å…ˆçš„ value æ˜¯å¦æ˜¯ ctxï¼ˆkoa åº”ç”¨ä¸­æ¯ä¸ªè¯·æ±‚çš„ ctxï¼‰ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥å°† value è®¾ç½®ä¸º ctxï¼Œå¦åˆ™å°† value è®¾ç½®ä¸ºè°ƒç”¨è€…çš„ asyncIdï¼ˆå³ triggerAsyncIdï¼‰ã€‚ åœ¨ destroy äº‹ä»¶å‡½æ•°é‡Œç›´æ¥åˆ é™¤è°ƒç”¨å…³ç³»ï¼Œä¿è¯äº†ä¸ä¼šå¼•èµ·å†…å­˜æ³„æ¼ï¼Œå³æœç»å¼•ç”¨äº† ctx ä½†æ²¡æœ‰é‡Šæ”¾çš„æƒ…å†µã€‚ ç„¶åï¼Œä¿®æ”¹ global[loggerName] å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132global[loggerName] = async function (ctx, fn, fnStr, filename) &#123; const originalContext = ctx let requestId = _getRequestId() const asyncId = async_hooks.executionAsyncId() if (!requestId) &#123; const _ctx = getCtx(asyncId) if (_ctx) &#123; ctx = _ctx requestId = _getRequestId() &#125; &#125; else &#123; asyncIdMap.set(asyncId, ctx) &#125; if (requestId) &#123; _logger(&#x27;beforeAwait&#x27;) &#125; const result = await fn.call(originalContext) if (requestId) &#123; _logger(&#x27;afterAwait&#x27;, result) &#125; return result function _getRequestId () &#123; return ctx &amp;&amp; ctx.app &amp;&amp; _.get(ctx, requestIdPath) &#125; function _logger (type, result) &#123; ... &#125;&#125; æœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦è§£é‡Šï¼š logger å‡½æ•°ä¼ å…¥çš„ç¬¬ 1 ä¸ªå‚æ•° ctxï¼Œä¹‹å‰æ˜¯æ¯ä¸ªè¯·æ±‚çš„ ctxï¼Œç°åœ¨å¯èƒ½æ˜¯å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„ thisï¼Œæ‰€ä»¥å…ˆå°† ctx èµ‹å€¼ç»™ originalContextï¼Œç„¶åé€šè¿‡ await fn.call(originalContext) è®©å‡½æ•°åœ¨æ‰§è¡Œæ—¶æœ‰æ­£ç¡®çš„ä¸Šä¸‹æ–‡ã€‚ å¦‚æœä¼ å…¥çš„ ctx æ˜¯æ¥è‡ªè¯·æ±‚çš„ ctx ä¸”èƒ½æ‹¿åˆ° requestIdï¼Œé‚£ä¹ˆå°†å½“å‰ asyncId å’Œ ctx å†™å…¥ Mapï¼Œå¦‚æœä¸æ˜¯æ¥è‡ªè¯·æ±‚çš„ ctxï¼Œåˆ™å°è¯•ä» Map é‡Œå‘ä¸Šå¯»æ‰¾ç¥–å…ˆçš„ value æ˜¯å¦æ˜¯ ctxï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¦†ç›–å½“å‰çš„ ctx å¹¶æ‹¿åˆ° requestIdã€‚ è‡³æ­¤ï¼Œkoa-await-breakpoint å…¨éƒ¨æ”¹é€ å®Œæ¯•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­éªŒè¯ä¸‹å‡çº§åçš„ koa-await-breakpointï¼š app.js 1234567891011const koaAwaitBreakpoint = require(&#x27;koa-await-breakpoint&#x27;)(&#123; files: [&#x27;./routes/*.js&#x27;]&#125;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(koaAwaitBreakpoint)app.route(&#123; method: &#x27;POST&#x27;, path: &#x27;/users&#x27;, controller: require(&#x27;./routes/user&#x27;).createUser &#125;)app.listen(3000) routes&#x2F;users.js 1234567891011121314151617181920212223242526272829303132333435363738const Mongolass = require(&#x27;mongolass&#x27;)const mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;)const User = mongolass.model(&#x27;User&#x27;)const Post = mongolass.model(&#x27;Post&#x27;)const Comment = mongolass.model(&#x27;Comment&#x27;)exports.createUser = async function (ctx) &#123; const name = ctx.query.name || &#x27;default&#x27; const age = +ctx.query.age || 18 await createUser(name, age) ctx.status = 204&#125;async function createUser (name, age) &#123; const user = (await User.create(&#123; name, age &#125;)).ops[0] await createPost(user)&#125;async function createPost (user) &#123; const post = (await Post.create(&#123; uid: user._id, title: &#x27;post&#x27;, content: &#x27;post&#x27; &#125;)).ops[0] await createComment(user, post)&#125;async function createComment (user, post) &#123; await Comment.create(&#123; userId: user._id, postId: post._id, content: &#x27;comment&#x27; &#125;)&#125; è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼šåœ¨è®¿é—®åˆ›å»ºç”¨æˆ·æ¥å£æ—¶ï¼Œè°ƒç”¨ createUserï¼ŒcreateUser é‡Œé¢åˆè°ƒç”¨äº† createPostï¼ŒcreatePost é‡Œé¢åˆè°ƒç”¨äº† createCommentã€‚è¿è¡Œï¼š 1$ curl -XPOST localhost:3000/users æ‰“å°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354&#123; type: &#x27;start&#x27;, step: 1, take: 0 ... &#125;&#123; type: &#x27;beforeAwait&#x27;, step: 2, fn: &#x27;createUser(name, age)&#x27;, take: 1 ... &#125;&#123; type: &#x27;beforeAwait&#x27;, step: 3, fn: &#x27;User.create(...)&#x27;, take: 1 ... &#125;&#123; type: &#x27;afterAwait&#x27;, step: 4, fn: &#x27;User.create(...)&#x27;, take: 36 ... &#125;&#123; type: &#x27;beforeAwait&#x27;, step: 5, fn: &#x27;createPost(user)&#x27;, take: 1 ... &#125;&#123; type: &#x27;beforeAwait&#x27;, step: 6, fn: &#x27;Post.create(...)&#x27;, take: 0 ... &#125;&#123; type: &#x27;afterAwait&#x27;, step: 7, fn: &#x27;Post.create(...)&#x27;, take: 3 ... &#125;&#123; type: &#x27;beforeAwait&#x27;, step: 8, fn: &#x27;createComment(user, post)&#x27;, take: 1 ... &#125;&#123; type: &#x27;beforeAwait&#x27;, step: 9, fn: &#x27;Comment.create(...)&#x27;, take: 0 ... &#125;&#123; type: &#x27;afterAwait&#x27;, step: 10, fn: &#x27;Comment.create(...)&#x27;, take: 1 ... &#125;&#123; type: &#x27;afterAwait&#x27;, step: 11, fn: &#x27;createComment(user, post)&#x27;, take: 1 ... &#125;&#123; type: &#x27;afterAwait&#x27;, step: 12, fn: &#x27;createPost(user)&#x27;, take: 6 ... &#125;&#123; type: &#x27;afterAwait&#x27;, step: 13, fn: &#x27;createUser(name, age)&#x27;, take: 44 ... &#125;&#123; type: &#x27;end&#x27;, step: 14, take: 0 ... &#125; è‡³æ­¤ï¼Œä¸€ä¸ªå…¨é“¾è·¯ã€æ— ä¾µå…¥ã€å¼ºå¤§çš„æ—¥å¿—æ‰“ç‚¹å·¥å…·å°±å®Œæˆäº†ã€‚ æ³¨æ„ï¼šä½¿ç”¨ async_hooks åœ¨ç›®å‰æœ‰è¾ƒä¸¥é‡çš„æ€§èƒ½æŸè€—ï¼Œè§ https://github.com/bmeurer/async-hooks-performance-impactï¼Œè¯·æ…é‡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ 6.2.3 å‚è€ƒé“¾æ¥ https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html https://zhuanlan.zhihu.com/p/27394440 https://www.jianshu.com/p/4a568dac41ed ä¸Šä¸€èŠ‚ï¼š6.1 koa-await-breakpoint ä¸‹ä¸€èŠ‚ï¼š6.3 ELK","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 6.1 Koa-await-breakpoint","slug":"6.1 koa-await-breakpoint","date":"2019-09-20T06:00:00.000Z","updated":"2022-05-25T04:27:36.571Z","comments":true,"path":"2019/09/20/6.1 koa-await-breakpoint/","link":"","permalink":"https://marvinliu1.github.io/2019/09/20/6.1%20koa-await-breakpoint/","excerpt":"","text":"Node in Debugging æ—¥å¿—æ‰“ç‚¹ä¸€ç›´æ˜¯ä¸ªè°ƒè¯•æœ€å¤´ç–¼çš„é—®é¢˜ã€‚å¦‚æœç›´æ¥åœ¨ä»£ç ä¸­æ’å…¥åŸ‹ç‚¹ä»£ç ï¼Œä¸ä»…ä¾µå…¥æ€§å¼ºè€Œä¸”å·¥ä½œé‡å¤§ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œè¦æ˜¯èƒ½åšåˆ°æ™ºèƒ½æ‰“ç‚¹å°±å¥½äº†ï¼Œkoa-await-breakpoint æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚ 6.1.1 ä»€ä¹ˆæ˜¯ koa-await-breakpointï¼Ÿkoa-await-breakpoint æ˜¯ä¸€ä¸ª Koa çš„ä¸­é—´ä»¶ï¼Œæ˜¯ä¸€ä¸ªåœ¨ routes&#x2F;controllers é‡Œï¼ˆä½œç”¨åŸŸåŒ…å« ctxï¼‰çš„ await è¡¨è¾¾å¼å‰åè‡ªåŠ¨æ‰“ç‚¹çš„å·¥å…·ï¼Œä¸ç”¨æ’å…¥ä¸€è¡Œæ—¥å¿—æ‰“ç‚¹ä»£ç ï¼Œåªéœ€è¦åœ¨å¼•å…¥æ—¶é…ç½®ä¸€ä¸‹ï¼Œå°±å¯ä»¥è®°å½•æ¯ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ await è¡¨è¾¾å¼å‰åçš„ç°åœºï¼Œä¾‹å¦‚ï¼š await è¡¨è¾¾å¼æ‰€åœ¨çš„æ–‡ä»¶åŠè¡Œåˆ—å·ï¼ˆfilenameï¼‰ã€‚ await è¡¨è¾¾å¼æ˜¯æ‰§è¡Œçš„ç¬¬å‡ æ­¥ï¼ˆstepï¼‰ã€‚ await è¡¨è¾¾å¼å­—ç¬¦ä¸²å½¢å¼ï¼ˆfnï¼‰ã€‚ æ‰§è¡Œ await è¡¨è¾¾å¼æ‰€èŠ±è´¹çš„æ¯«ç§’ï¼ˆtakeï¼‰ã€‚ æ‰§è¡Œ await è¡¨è¾¾å¼çš„ç»“æœï¼ˆresultï¼‰ã€‚ å½“å‰è¯·æ±‚çš„ ctxã€‚ ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 1234567891011121314// On top of the main fileconst koaAwaitBreakpoint = require(&#x27;koa-await-breakpoint&#x27;)(&#123; name: &#x27;api&#x27;, files: [&#x27;./routes/*.js&#x27;]&#125;)const Koa = require(&#x27;koa&#x27;)const app = new Koa()// Generally, above other middlewaresapp.use(koaAwaitBreakpoint)...app.listen(3000) 6.1.2 å®ç°åŸç† é‡è½½ Module.prototype._compileï¼Œç›¸å½“äº hack äº† requireï¼Œå¦‚æœå‘ç°æ˜¯ require äº†é…ç½®é‡ŒæŒ‡å®šçš„æ–‡ä»¶ï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå¦åˆ™è¿”å›åŸå§‹ä»£ç çš„å†…å®¹ï¼Œç›¸å…³æºä»£ç å¦‚ä¸‹ï¼š 12345678shimmer.wrap(Module.prototype, &#x27;_compile&#x27;, function (__compile) &#123; return function koaBreakpointCompile(content, filename) &#123; if (!_.includes(filenames, filename)) &#123; return __compile.call(this, content, filename); &#125; ... &#125;;&#125;); ç”¨ esprima è§£æä»£ç ï¼Œç”Ÿæˆ ASTã€‚ä¾‹å¦‚ï¼š 123456789101112const Mongolass = require(&#x27;mongolass&#x27;)const mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;)const User = mongolass.model(&#x27;users&#x27;)exports.getUsers = async function getUsers(ctx) &#123; await User.create(&#123; name: &#x27;xx&#x27;, age: 18 &#125;) const users = await User.find() return users&#125; ä¼šç”Ÿæˆå¦‚ä¸‹ ASTï¼Œåªæˆªå–äº† await User.create(...) ç›¸å…³çš„ ASTï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566Script &#123; ... AwaitExpression &#123; type: &#x27;AwaitExpression&#x27;, argument: CallExpression &#123; type: &#x27;CallExpression&#x27;, callee: StaticMemberExpression &#123; type: &#x27;MemberExpression&#x27;, computed: false, object: Identifier &#123; type: &#x27;Identifier&#x27;, name: &#x27;User&#x27;, loc: &#123; start: &#123; line: 6, column: 10 &#125;, end: &#123; line: 6, column: 14 &#125; &#125; &#125;, property: Identifier &#123; type: &#x27;Identifier&#x27;, name: &#x27;create&#x27;, loc: &#123; start: &#123; line: 6, column: 15 &#125;, end: &#123; line: 6, column: 21 &#125; &#125; &#125;, loc: &#123; start: &#123; line: 6, column: 10 &#125;, end: &#123; line: 6, column: 21 &#125; &#125; &#125;, arguments: [ ObjectExpression &#123; type: &#x27;ObjectExpression&#x27;, properties: [ Property &#123; type: &#x27;Property&#x27;, key: Identifier &#123; type: &#x27;Identifier&#x27;, name: &#x27;name&#x27;, loc: &#123; start: &#123; line: 7, column: 6 &#125;, end: &#123; line: 7, column: 10 &#125; &#125; &#125;, computed: false, value: Literal &#123; type: &#x27;Literal&#x27;, value: &#x27;xx&#x27;, raw: &#x27;\\&#x27;xx\\&#x27;&#x27;, loc: &#123; start: &#123; line: 7, column: 12 &#125;, end: &#123; line: 7, column: 16 &#125; &#125; &#125;, kind: &#x27;init&#x27;, method: false, shorthand: false, loc: &#123; start: &#123; line: 7, column: 6 &#125;, end: &#123; line: 7, column: 16 &#125; &#125; &#125;, Property &#123; type: &#x27;Property&#x27;, key: Identifier &#123; type: &#x27;Identifier&#x27;, name: &#x27;age&#x27;, loc: &#123; start: &#123; line: 8, column: 6 &#125;, end: &#123; line: 8, column: 9 &#125; &#125; &#125;, computed: false, value: Literal &#123; type: &#x27;Literal&#x27;, value: 18, raw: &#x27;18&#x27;, loc: &#123; start: &#123; line: 8, column: 11 &#125;, end: &#123; line: 8, column: 13 &#125; &#125; &#125;, kind: &#x27;init&#x27;, method: false, shorthand: false, loc: &#123; start: &#123; line: 8, column: 6 &#125;, end: &#123; line: 8, column: 13 &#125; &#125; &#125; ], loc: &#123; start: &#123; line: 6, column: 22 &#125;, end: &#123; line: 9, column: 5 &#125; &#125; &#125; ], loc: &#123; start: &#123; line: 6, column: 10 &#125;, end: &#123; line: 9, column: 6 &#125; &#125; &#125;, loc: &#123; start: &#123; line: 6, column: 4 &#125;, end: &#123; line: 9, column: 6 &#125; &#125; &#125;, ... éå†æ‰¾åˆ° awaitExpression èŠ‚ç‚¹ï¼Œè¿›è¡Œä»¥ä¸‹åŒ…è£…åç”Ÿæˆ ASTï¼Œæ›¿æ¢æ‰åŸæ¥çš„èŠ‚ç‚¹ã€‚ 12345678global.logger( (typeof ctx !== &#x27;undefined&#x27; ? ctx : this), function()&#123; return awaitExpression &#125;, awaitExpressionString, filename) ç›¸å…³æºä»£ç å¦‚ä¸‹ï¼š 12345678910111213findAwaitAndWrapLogger(parsedCodes)try &#123; content = escodegen.generate(parsedCodes, &#123; format: &#123; indent: &#123; style: &#x27; &#x27; &#125; &#125;, sourceMap: filename, sourceMapWithCode: true &#125;)&#125; catch (e) &#123; console.error(&#x27;cannot generate code for file: %s&#x27;, filename) console.error(e.stack) process.exit(1)&#125;debug(&#x27;file %s regenerate codes:\\n%s&#x27;, filename, content.code) findAwaitAndWrapLogger çš„ä½œç”¨å°±æ˜¯éå† ASTï¼Œå°† awaitExpression æ›¿æ¢æˆç”¨æ—¥å¿—å‡½æ•°åŒ…è£¹åæ–°çš„ awaitExpression çš„ ASTã€‚æœ€åç”¨ escodegen å°† AST ç”Ÿæˆä»£ç ï¼ˆæ”¯æŒ soucemapï¼Œæ‰€ä»¥é”™è¯¯æ ˆå¯¹åº”çš„è¡Œæ•°æ˜¯æ­£ç¡®çš„ï¼‰ã€‚ æ ¸å¿ƒï¼šæ¯ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œç”Ÿæˆä¸€ä¸ª requestIdï¼ˆå¯è‡ªå®šä¹‰ï¼Œé»˜è®¤ä¸º uuidï¼‰æŒ‚è½½åˆ° ctx ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ requestId å°†æ—¥å¿—ä¸²èµ·æ¥äº†ã€‚ ç‰¹ç‚¹ï¼šå¯ä»¥è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ¯ä¸€æ­¥ï¼ˆawait è¡¨è¾¾å¼ï¼‰çš„ç°åœºåŠè¿”å›å€¼ï¼Œæ–¹ä¾¿æŸ¥æ—¥å¿—ã€‚ 6.1.3 ä½¿ç”¨ koa-await-breakpointæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š app.js 12345678910111213const koaAwaitBreakpoint = require(&#x27;koa-await-breakpoint&#x27;)(&#123; name: &#x27;api&#x27;, files: [&#x27;./routes/*.js&#x27;]&#125;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()const userRouter = require(&#x27;./routes/user&#x27;)app.use(koaAwaitBreakpoint)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/users&#x27;, controller: userRouter.getUsers &#125;)app.listen(3000) routes&#x2F;user.js 12345678910111213const Mongolass = require(&#x27;mongolass&#x27;)const mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;)const User = mongolass.model(&#x27;users&#x27;)exports.getUsers = async function getUsers (ctx) &#123; await User.create(&#123; name: &#x27;xx&#x27;, age: 18 &#125;) const users = await User.find() ctx.body = users&#125; è¿è¡Œï¼š 1$ DEBUG=koa-await-breakpoint node app.js ç»ˆç«¯æ‰“å°å‡ºè½¬æ¢åçš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡º routes&#x2F;users.js è¢«è½¬æ¢æˆäº†ï¼š 123456789101112131415const Mongolass = require(&#x27;mongolass&#x27;);const mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;);const User = mongolass.model(&#x27;users&#x27;);exports.getUsers = async function getUsers(ctx) &#123; await global.logger(typeof ctx !== &#x27;undefined&#x27; ? ctx : this, function () &#123; return User.create(&#123; name: &#x27;xx&#x27;, age: 18 &#125;); &#125;, &#x27;User.create(&#123;\\n name: \\&#x27;xx\\&#x27;,\\n age: 18\\n&#125;)&#x27;, &#x27;/Users/nswbmw/Desktop/test/routes/user.js:6:2&#x27;); const users = await global.logger(typeof ctx !== &#x27;undefined&#x27; ? ctx : this, function () &#123; return User.find(); &#125;, &#x27;User.find()&#x27;, &#x27;/Users/nswbmw/Desktop/test/routes/user.js:11:16&#x27;); ctx.body = users;&#125;; è®¿é—® localhost:3000&#x2F;usersï¼Œç»ˆç«¯æ‰“å°å‡º: 123456&#123;&quot;name&quot;:&quot;api&quot;,&quot;requestId&quot;:&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;,&quot;timestamp&quot;:&quot;2018-02-26T06:31:31.100Z&quot;,&quot;this&quot;:...,&quot;type&quot;:&quot;start&quot;,&quot;step&quot;:1,&quot;take&quot;:0&#125;&#123;&quot;name&quot;:&quot;api&quot;,&quot;requestId&quot;:&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;,&quot;step&quot;:2,&quot;filename&quot;:&quot;/Users/nswbmw/Desktop/test/routes/user.js:6:2&quot;,&quot;timestamp&quot;:&quot;2018-02-26T06:31:31.104Z&quot;,&quot;this&quot;:...,&quot;type&quot;:&quot;beforeAwait&quot;,&quot;fn&quot;:&quot;User.create(&#123;\\n name: &#x27;xx&#x27;,\\n age: 18\\n&#125;)&quot;,&quot;take&quot;:4&#125;&#123;&quot;name&quot;:&quot;api&quot;,&quot;requestId&quot;:&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;,&quot;step&quot;:3,&quot;filename&quot;:&quot;/Users/nswbmw/Desktop/test/routes/user.js:6:2&quot;,&quot;timestamp&quot;:&quot;2018-02-26T06:31:31.175Z&quot;,&quot;this&quot;:...,&quot;type&quot;:&quot;afterAwait&quot;,&quot;fn&quot;:&quot;User.create(&#123;\\n name: &#x27;xx&#x27;,\\n age: 18\\n&#125;)&quot;,&quot;result&quot;:&#123;&quot;result&quot;:&#123;&quot;ok&quot;:1,&quot;n&quot;:1&#125;,&quot;ops&quot;:[&#123;&quot;name&quot;:&quot;xx&quot;,&quot;age&quot;:18,&quot;_id&quot;:&quot;5a93a9c3cf8c8797c9b47482&quot;&#125;],&quot;insertedCount&quot;:1,&quot;insertedIds&quot;:[&quot;5a93a9c3cf8c8797c9b47482&quot;]&#125;,&quot;take&quot;:71&#125;&#123;&quot;name&quot;:&quot;api&quot;,&quot;requestId&quot;:&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;,&quot;step&quot;:4,&quot;filename&quot;:&quot;/Users/nswbmw/Desktop/test/routes/user.js:11:16&quot;,&quot;timestamp&quot;:&quot;2018-02-26T06:31:31.175Z&quot;,&quot;this&quot;:...,&quot;type&quot;:&quot;beforeAwait&quot;,&quot;fn&quot;:&quot;User.find()&quot;,&quot;take&quot;:0&#125;&#123;&quot;name&quot;:&quot;api&quot;,&quot;requestId&quot;:&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;,&quot;step&quot;:5,&quot;filename&quot;:&quot;/Users/nswbmw/Desktop/test/routes/user.js:11:16&quot;,&quot;timestamp&quot;:&quot;2018-02-26T06:31:31.180Z&quot;,&quot;this&quot;:...,&quot;type&quot;:&quot;afterAwait&quot;,&quot;fn&quot;:&quot;User.find()&quot;,&quot;result&quot;:[&#123;&quot;_id&quot;:&quot;5a93a9c3cf8c8797c9b47482&quot;,&quot;name&quot;:&quot;xx&quot;,&quot;age&quot;:18&#125;],&quot;take&quot;:5&#125;&#123;&quot;name&quot;:&quot;api&quot;,&quot;requestId&quot;:&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;,&quot;timestamp&quot;:&quot;2018-02-26T06:31:31.181Z&quot;,&quot;this&quot;:...,&quot;type&quot;:&quot;end&quot;,&quot;step&quot;:6,&quot;take&quot;:1&#125; æ³¨æ„ï¼štype æ˜¯ä»¥ä¸‹å…¶ä¸­ä¸€ç§ï¼Œtake çš„å•ä½æ˜¯ msã€‚ startï¼šè¯·æ±‚åˆ°æ¥æ—¶ç¬¬ 1 æ¬¡æ‰“ç‚¹ã€‚ beforeAwaitï¼šä¸Šä¸€ä¸ª awaitExpression ä¹‹ååˆ°è¿™ä¸€ä¸ª awaitExpression ä¹‹å‰ã€‚ afterAwaitï¼šè¿™ä¸ª awaitExpression å¼€å§‹åˆ°ç»“æŸã€‚ errorï¼šé”™è¯¯æ—¥å¿—ï¼ŒåŒ…å«äº†é”™è¯¯ä¿¡æ¯ã€‚ endï¼šè¯·æ±‚ç»“æŸæ—¶æ‰“ç‚¹ã€‚ 6.1.4 è‡ªå®šä¹‰æ—¥å¿—å­˜å‚¨store å‚æ•°æœ€å¥½è‡ªå·±å®šä¹‰ï¼ˆé»˜è®¤æ‰“å°æ—¥å¿—åˆ° stdoutï¼‰ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡å¹¶ä¸”æœ‰ä¸€ä¸ª save æ–¹æ³•å³å¯ã€‚åœ¨ save æ–¹æ³•å†…å¯åšä¸€äº›é€»è¾‘ä¿®æ”¹æˆ–è€…æ—¥å¿—ç­–ç•¥ï¼Œæ¯”å¦‚ï¼š æ·»åŠ æ—¥å¿—æ ‡è¯†ï¼ˆä¾‹å¦‚ï¼šnameï¼‰æ–¹ä¾¿åŒºåˆ†ä¸åŒæœåŠ¡çš„æ—¥å¿—ã€‚ é’ˆå¯¹é”™è¯¯æ—¥å¿—ï¼Œæ·»åŠ ä¸€äº›é¢å¤–å­—æ®µæ–¹ä¾¿è¿½è¸ªç°åœºã€‚ å°†æ—¥å¿—å‘é€åˆ° Logstash æˆ–å…¶ä»–æ—¥å¿—æœåŠ¡ã€‚ é™åˆ¶æ—¥å¿—é¢‘ç‡ï¼Œæ¯”å¦‚ï¼šåªæœ‰å“åº”æ—¶é—´å¤§äº 500ms çš„è¯·æ±‚æ—¥å¿—æ‰ä¼šè¢«è®°å½•ã€‚ koa_await_breakpoint_store.js 1234567891011121314exports.save = function save(record, ctx) &#123; record.name = &#x27;app name&#x27; record.env = process.env.NODE_ENV if (record.error) &#123; record.error = &#123; message: record.error.message, stack: record.error.stack, status: record.error.status || record.error.statusCode || 500 &#125; &#125; ... logstash.send(record)&#125; 6.1.5 å‚è€ƒé“¾æ¥ https://github.com/jquery/esprima https://github.com/estools/escodegen ä¸Šä¸€èŠ‚ï¼š5.2 Elastic APM ä¸‹ä¸€èŠ‚ï¼š6.2 async_hooks","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging - 5.2 Elastic APM","slug":"5.2 Elastic APM","date":"2019-08-26T06:00:00.000Z","updated":"2022-05-25T04:27:00.216Z","comments":true,"path":"2019/08/26/5.2 Elastic APM/","link":"","permalink":"https://marvinliu1.github.io/2019/08/26/5.2%20Elastic%20APM/","excerpt":"","text":"Node in Debugging 5.2.1 ä»€ä¹ˆæ˜¯ Elastic APMï¼ŸElastic APM æ˜¯ Elastic å…¬å¸å¼€æºçš„ä¸€æ¬¾ APM å·¥å…·ï¼Œç›®å‰è¿˜å¤„äº Beta é˜¶æ®µï¼Œå®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜åŠ¿ï¼š å¼€æºã€‚æˆ‘ä»¬å¯ä»¥å…è´¹ä½¿ç”¨ï¼Œåƒä½¿ç”¨ ELK ä¸€æ ·ã€‚ åŠŸèƒ½å®Œå–„ã€‚API æ¯”è¾ƒå®Œå–„ï¼Œæœ‰ Agentã€Transaction å’Œ Traceï¼Œé»˜è®¤åˆ›å»ºå“åº”æ—¶é—´å’Œæ¯åˆ†é’Ÿè¯·æ±‚æ•°ä¸¤ç§å›¾è¡¨ï¼Œä¸”å¯ä»¥ä½¿ç”¨ Kibana çš„ Filter è¿‡æ»¤ç”Ÿæˆå…³å¿ƒçš„æ•°æ®çš„å›¾è¡¨ã€‚ ç›‘æ§ä¸æ—¥å¿—ç»Ÿä¸€ã€‚Elastic APM ä¾èµ– ElasticSearch + Kibanaï¼Œæ‰€ä»¥å¯ä»¥ç»“åˆ ELK ä½¿ç”¨ï¼Œå¯åœ¨ Kibana ä¸­æŸ¥çœ‹ç›‘æ§ï¼Œç„¶åç›´æ¥æŸ¥è¯¢æ—¥å¿—ã€‚ Elastic APM æ¶æ„å¦‚ä¸‹ï¼š APM Agentï¼ˆå³åœ¨åº”ç”¨ç«¯å¼•å…¥çš„æ¢é’ˆï¼‰å°†æ”¶é›†çš„æ—¥å¿—å‘é€åˆ° APM Serverï¼ˆGo å†™çš„ HTTP æœåŠ¡ï¼‰ï¼ŒAPM Server å°†æ•°æ®å­˜å‚¨åˆ° ElasticSearch ä¸­ï¼Œç„¶åé€šè¿‡ Kibana å±•ç¤ºã€‚ Kibana å±•ç¤ºå¦‚ä¸‹ï¼š 5.2.2 å¯åŠ¨ ELKæˆ‘ä»¬ä½¿ç”¨ Docker å®‰è£…å¹¶å¯åŠ¨ ELKï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1234$ docker run -p 5601:5601 \\ -p 9200:9200 \\ -p 5044:5044 \\ -it --name elk sebp/elk 5.2.3 å¯åŠ¨ APM Serveré¦–å…ˆï¼Œä¸‹è½½ APM Server è§£å‹ã€‚ç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 12$ ./apm-server setup # å¯¼å…¥ APM ä»ªè¡¨ç›˜åˆ° Kibana$ ./apm-server -e # å¯åŠ¨ APM Serverï¼Œé»˜è®¤ç›‘å¬ 8200 ç«¯å£ ç”¨æµè§ˆå™¨æ‰“å¼€ localhost:5601ï¼Œè¿›å…¥ Dashboard é¡µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 5.2.4 ä½¿ç”¨ Elastic APMæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718const apm = require(&#x27;elastic-apm-node&#x27;).start(&#123; appName: &#x27;test&#x27;&#125;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/&#x27;, controller (ctx) &#123; apm.setTransactionName(`$&#123;ctx.method&#125; $&#123;ctx._matchedRoute&#125;`) ctx.status = 200&#125;&#125;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/:name&#x27;, controller (ctx) &#123; apm.setTransactionName(`$&#123;ctx.method&#125; $&#123;ctx._matchedRoute&#125;`) ctx.status = 200&#125;&#125;)app.listen(3000) è¿è¡Œè¯¥ç¨‹åºï¼Œå‘èµ·ä¸¤ä¸ªè¯·æ±‚ï¼š 12$ curl localhost:3000/$ curl localhost:3000/nswbmw ç­‰å¾…ä¸€ä¼šï¼ŒKibana å±•ç¤ºå¦‚ä¸‹ï¼š åœ¨ Elastic APM ä¸­ï¼Œæœ‰ä¸¤ä¸ªæœ¯è¯­ï¼š transactionï¼šä¸€ç»„ traces çš„é›†åˆï¼Œä¾‹å¦‚ï¼šä¸€ä¸ª HTTP è¯·æ±‚ã€‚ traceï¼šä¸€ä¸ªäº‹ä»¶åŠæŒç»­æ—¶é—´ï¼Œä¾‹å¦‚ï¼šä¸€ä¸ª SQL æŸ¥è¯¢ã€‚ 5.2.5 é”™è¯¯æ—¥å¿—ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ Elastic APM çš„é”™è¯¯æ”¶é›†åŠŸèƒ½ã€‚ä¿®æ”¹æµ‹è¯•ä»£ç ä¸ºï¼š 1234567891011121314151617181920212223const apm = require(&#x27;elastic-apm-node&#x27;).start(&#123; appName: &#x27;test&#x27;&#125;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(async (ctx, next) =&gt; &#123; try &#123; await next() &#125; catch (e) &#123; apm.captureError(e) ctx.status = 500 ctx.message = e.message &#125;&#125;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/&#x27;, controller: function indexRouter (ctx) &#123; apm.setTransactionName(`$&#123;ctx.method&#125; $&#123;ctx._matchedRoute&#125;`) throw new Error(&#x27;error!!!&#x27;)&#125;&#125;)app.listen(3000) é‡å¯æµ‹è¯•ç¨‹åºï¼Œå¹¶å‘èµ·ä¸€æ¬¡è¯·æ±‚ã€‚å›åˆ° Kibanaï¼Œå•å‡» Dashboard -&gt; [APM] Errors å¯ä»¥çœ‹åˆ°é”™è¯¯æ—¥å¿—è®°å½•ï¼ˆè‡ªåŠ¨èšåˆï¼‰å’Œå›¾è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å•å‡» View Error Details è¿›å…¥é”™è¯¯è¯¦æƒ…é¡µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šåœ¨é”™è¯¯æ—¥å¿—ä¸­å±•ç¤ºäº†é”™è¯¯ä»£ç åŠè¡Œæ•°ã€ä¸Šä¸‹å‡ è¡Œä»£ç ã€çˆ¶çº§å‡½æ•°åå’Œæ‰€åœ¨æ–‡ä»¶ç­‰ä¿¡æ¯ã€‚ 5.2.6 å‚è€ƒé“¾æ¥ https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/index.html https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/custom-stack.html ä¸Šä¸€èŠ‚ï¼š5.1 NewRelic ä¸‹ä¸€èŠ‚ï¼š6.1 koa-await-breakpoint","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 5.1 NewRelic","slug":"5.1 NewRelic","date":"2019-08-05T06:00:00.000Z","updated":"2022-05-25T04:24:35.358Z","comments":true,"path":"2019/08/05/5.1 NewRelic/","link":"","permalink":"https://marvinliu1.github.io/2019/08/05/5.1%20NewRelic/","excerpt":"","text":"Node in Debugging NewRelic æ˜¯ä¸€ä¸ªè€ç‰Œçš„åº”ç”¨æ€§èƒ½ç›‘æµ‹å·¥å…·ï¼Œæä¾› 14 å¤©å…è´¹è¯•ç”¨ï¼Œæœ¬èŠ‚å°†è®²è§£å¦‚ä½•ä½¿ç”¨ NewRelic ç›‘æ§ Node.js ç¨‹åºçš„æ€§èƒ½ã€‚ æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š app.js 1234567891011121314151617181920212223require(&#x27;newrelic&#x27;)const crypto = require(&#x27;crypto&#x27;)const express = require(&#x27;express&#x27;)const app = express()const createUser = require(&#x27;./routes/users&#x27;).createUserapp.get(&#x27;/&#x27;, (req, res) =&gt; &#123; const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;) const hash = crypto.pbkdf2Sync(String(Math.random()), salt, 10000, 512, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;) res.json(&#123; salt, hash &#125;)&#125;)app.get(&#x27;/error&#x27;, (req, res, next) =&gt; &#123; next(new Error(&#x27;error!!!&#x27;))&#125;)app.post(&#x27;/users/:user&#x27;, async (req, res) =&gt; &#123; const user = await createUser(req.params.user, 18) res.json(user)&#125;)app.listen(3000) routes&#x2F;users.js 123456789101112131415161718const Mongolass = require(&#x27;mongolass&#x27;)const mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;)const User = mongolass.model(&#x27;User&#x27;)exports.createUser = async function (ctx) &#123; const name = ctx.query.name || &#x27;default&#x27; const age = +ctx.query.age || 18 const user = await createUser(name, age) ctx.status = user&#125;async function createUser (name, age) &#123; const user = (await User.create(&#123; name, age &#125;)).ops[0] return user&#125; 5.1.1 ä½¿ç”¨ NewRelicé¦–å…ˆï¼Œæ³¨å†Œä¸€ä¸ª NewRelic è´¦å·ã€‚åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š é€‰æ‹© APMï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼Œé€‰æ‹© Node.js åº”ç”¨ï¼Œå¹¶æ‹¿åˆ° license keyï¼š åœ¨ Node.js ä¸­ä½¿ç”¨ NewRelic çš„æ­¥éª¤å¦‚ä¸‹ï¼š 12$ npm i newrelic --save # å®‰è£… NewRelic çš„ Node.js SDK$ cp node_modules/newrelic/newrelic.js . # å°†é»˜è®¤é…ç½®æ–‡ä»¶æ‹·è´åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹ ä¿®æ”¹ newrelic.jsï¼Œapp_name å¡«å†™æˆ‘ä»¬çš„åº”ç”¨åï¼ˆä¾‹å¦‚ï¼šapiï¼‰ï¼Œlicense_key å¡«å†™åˆšæ‰ç”Ÿæˆçš„ license keyã€‚ å¯åŠ¨æµ‹è¯•ç¨‹åºï¼Œå¹¶å‘èµ·å‡ ä¸ªè¯·æ±‚ï¼Œç¨ç­‰å‡ åˆ†é’Ÿï¼ŒNewRelic çš„åå°å°†ä¼šæ”¶åˆ°å¹¶å±•ç¤ºä¸€äº›æ•°æ®ï¼ˆä¾‹å¦‚ï¼šååé‡ï¼Œè¯·æ±‚çš„ Urlsï¼Œé”™è¯¯ç‡ã€Apdex score ç­‰ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š è¯•ç”¨ç‰ˆçš„åŠŸèƒ½æœ‰é™ï¼Œå‡çº§åˆ°ä»˜è´¹ç‰ˆå¯è§£é”æ›´å¤šåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šæ•°æ®åº“åˆ†æã€é”™è¯¯åˆ†æç”šè‡³ Node.js VM ç›‘æ§ï¼ˆCPUã€å†…å­˜ã€GCã€Event Loopï¼‰ç­‰ç­‰ã€‚ ç±»ä¼¼çš„å…¶ä»– APM æœ‰ï¼š AppDynamics OneAPM DataDog atatus opbeat ç”¨æ³•å¤§åŒå°å¼‚ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚ 5.1.2 å‚è€ƒé“¾æ¥ https://newrelic.com/ ä¸Šä¸€èŠ‚ï¼š4.5 supervisor-hot-reload ä¸‹ä¸€èŠ‚ï¼š5.2 Elastic APM","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 4.5 Supervisor-hot-reload","slug":"4.5 supervisor-hot-reload","date":"2019-08-03T06:00:00.000Z","updated":"2022-05-25T04:24:07.404Z","comments":true,"path":"2019/08/03/4.5 supervisor-hot-reload/","link":"","permalink":"https://marvinliu1.github.io/2019/08/03/4.5%20supervisor-hot-reload/","excerpt":"","text":"Node in Debugging æˆ‘ä»¬åœ¨æœ¬åœ°å¼€å‘ Node.js ç¨‹åºæ—¶é€šå¸¸ä¼šä½¿ç”¨ nodemon æˆ–è€… supervisor è¿™ç§è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œå½“æœ‰æ–‡ä»¶ä¿®æ”¹æ—¶è‡ªåŠ¨é‡å¯åº”ç”¨ã€‚å°é¡¹ç›®è¿˜å¥½ï¼Œé¡¹ç›®å¤§äº†ï¼ˆå°¤å…¶æ˜¯å‰ç«¯åº”ç”¨ï¼‰æ¯æ¬¡é‡å¯åº”ç”¨éƒ½ç”¨å‡ ç§’åˆ°å‡ åç§’çš„æ—¶é—´ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†åŠ è½½åŠç¼–è¯‘ä»£ç ä¸Šã€‚ è¿™è®©ç¬”è€…è”æƒ³åˆ°å‰ç«¯æ¯”è¾ƒç«çš„ä¸€ä¸ªåè¯â€”â€”Hot Reloadï¼ˆçƒ­åŠ è½½ï¼‰ï¼Œæ¯”å¦‚ React é™æ€èµ„æºçš„çƒ­åŠ è½½é€šè¿‡ webpack-dev-server å’Œ react-hot-loader å®ç°ï¼Œwebpack-dev-server è´Ÿè´£é‡æ–°ç¼–è¯‘ä»£ç ï¼Œreact-hot-loader è´Ÿè´£çƒ­åŠ è½½ã€‚ é‚£åœ¨ Node.js åº”ç”¨ä¸­ï¼Œå¦‚ä½•å®ç° Hot Reload å‘¢ï¼Ÿæœ€å¥½èƒ½å®ç°ä¸é‡å¯åº”ç”¨ä¾¿ä½¿æ–°ä»£ç ç”Ÿæ•ˆã€‚å¹¸å¥½ ES6 å¼•å…¥äº†ä¸€ä¸ªæ–°ç‰¹æ€§â€”â€”Proxyã€‚ 4.5.1 ProxyProxy ç”¨äºä¿®æ”¹å¯¹è±¡çš„é»˜è®¤è¡Œä¸ºï¼Œç­‰åŒäºåœ¨è¯­è¨€å±‚é¢åšå‡ºä¿®æ”¹ï¼Œå±äºä¸€ç§ â€œå…ƒç¼–ç¨‹â€ã€‚Proxy åœ¨è¦è®¿é—®çš„å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚æ‹¦æˆªï¼Œåœ¨è®¿é—®è¯¥å¯¹è±¡æˆå‘˜æ—¶å¿…é¡»å…ˆç»è¿‡è¿™å±‚æ‹¦æˆªã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 12345678910111213const obj = new Proxy(&#123;&#125;, &#123; get: function (target, key) &#123; console.log(`getting $&#123;key&#125;!`) return &#x27;haha&#x27; &#125;&#125;)console.log(obj.name)// getting name!// hahaconsole.log(obj.age)// getting age!// haha å¯ä»¥çœ‹å‡ºï¼šæˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ obj ä¸Šå®šä¹‰ name å’Œ age å±æ€§ï¼Œæ‰€æœ‰è·å– obj ä¸Šå±æ€§éƒ½ä¼šæ‰§è¡Œ get æ–¹æ³•ç„¶åæ‰“å° getting xxx! å’Œè¿”å› hahaã€‚ è¿™é‡Œ Proxy çš„ç¬¬ 1 ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå…¶ä»–çš„å¯¹è±¡ï¼Œæ¯”å¦‚å‡½æ•°ï¼ˆæ¯•ç«Ÿåœ¨ JavaScript ä¸­å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼‰ã€‚ 123456789101112131415161718192021function user () &#123;&#125;const obj = new Proxy(user, &#123; get: function (target, key) &#123; console.log(`getting $&#123;key&#125;!`) return &#x27;haha&#x27; &#125;&#125;)console.log(user.name)// userconsole.log(user.age)// undefinedconsole.log(obj.name)// getting name!// hahaconsole.log(obj.age)// getting age!// hahanew Proxy(1, &#123;&#125;)// TypeError: Cannot create proxy with a non-object as target or handler 4.5.2 Proxy å®ç° Hot Reloadæ ¸å¿ƒåŸç†ï¼šä½¿ç”¨ Proxy å°†æ¨¡å—å¯¼å‡ºçš„å¯¹è±¡åŒ…è£…ä¸€å±‚ â€œä»£ç†â€ï¼Œå³ module.exports å¯¼å‡ºçš„æ˜¯ä¸€ä¸ª Proxy å®ä¾‹ï¼Œå®šä¹‰ä¸€ä¸ª get æ–¹æ³•ï¼Œä½¿å¾—è·å–å®ä¾‹ä¸Šçš„å±æ€§å…¶å®æ˜¯å»è·å–æœ€æ–°çš„ require.cache ä¸­çš„å¯¹è±¡ä¸Šçš„å±æ€§ã€‚åŒæ—¶ï¼Œç›‘å¬ä»£ç æ–‡ä»¶ï¼Œå¦‚æœæœ‰ä¿®æ”¹ï¼Œåˆ™æ›´æ–° require.cacheã€‚ ç®€è€Œè¨€ä¹‹ï¼šæˆ‘ä»¬åœ¨è·å–å¯¹è±¡çš„å±æ€§æ—¶ï¼Œä¸­é—´åŠ äº†ä¸€å±‚ä»£ç†ï¼Œé€šè¿‡ä»£ç†é—´æ¥è·å–åŸæœ‰å±æ€§çš„å€¼ï¼Œå¦‚æœå±æ€§å€¼æœ‰æ›´æ–°ï¼Œåˆ™ä¼šæ›´æ–° require.cache çš„ç¼“å­˜ï¼Œé‚£ä¹ˆä¸‹æ¬¡å†è·å–å¯¹è±¡çš„å±æ€§æ—¶ï¼Œé€šè¿‡ä»£ç†å°†è·å–è¯¥å±æ€§æœ€æ–°çš„å€¼ã€‚å¯è§ï¼ŒProxy å¯ä»¥å®ç°å±æ€§è®¿é—®æ‹¦æˆªï¼Œä¹Ÿå¯å®ç°æ–­å¼€å¼ºå¼•ç”¨çš„ä½œç”¨ã€‚ ç¬”è€…å‘å¸ƒäº†ä¸€ä¸ª proxy-hot-reload æ¨¡å—ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152module.exports = function proxyHotReload(opts) &#123; const includes = [ ... ] const excludes = [ ... ] const filenames = _.difference(includes, excludes) chokidar .watch(filenames, &#123; usePolling: true &#125;) .on(&#x27;change&#x27;, (path) =&gt; &#123; try &#123; if (require.cache[path]) &#123; const _exports = require.cache[path].exports if (_.isPlainObject(_exports) &amp;&amp; !_.isEmpty(_exports)) &#123; delete require.cache[path] require(path) &#125; &#125; &#125; catch (e) &#123; ... &#125; &#125;) .on(&#x27;error&#x27;, (error) =&gt; console.error(error)) shimmer.wrap(Module.prototype, &#x27;_compile&#x27;, function (__compile) &#123; return function proxyHotReloadCompile(content, filename) &#123; if (!_.includes(filenames, filename)) &#123; try &#123; return __compile.call(this, content, filename) &#125; catch (e) &#123; ... &#125; &#125; else &#123; const result = __compile.call(this, content, filename) this._exports = this.exports // non-object return original compiled code if (!_.isPlainObject(this._exports)) &#123; return result &#125; try &#123; this.exports = new Proxy(this._exports, &#123; get: function (target, key, receiver) &#123; try &#123; if (require.cache[filename]) &#123; return require.cache[filename]._exports[key] &#125; else &#123; return Reflect.get(target, key, receiver) &#125; &#125; catch (e) &#123; ... &#125; &#125; &#125;) &#125; catch (e) &#123; ... &#125; &#125; &#125; &#125;)&#125; ç®€å•è®²è§£ä¸€ä¸‹ï¼š å¯ä¼ å…¥ includes å’Œ excludes å‚æ•°ï¼Œæ”¯æŒ glob å†™æ³•ï¼Œç”¨æ¥è®¾ç½®ç›‘å¬å“ªäº›ä»£ç æ–‡ä»¶ã€‚ ç”¨ chokidar æ¨¡å—ç›‘å¬æ–‡ä»¶ï¼Œå¦‚æœæœ‰æ”¹åŠ¨åˆ™é‡æ–°åŠ è½½è¯¥æ–‡ä»¶ã€‚è¿™é‡Œåªé’ˆå¯¹ module.exports å¯¼å‡ºçš„æ˜¯çº¯å¯¹è±¡çš„æ¨¡å—æœ‰ç”¨ï¼Œåšè¿™ä¸ªé™åˆ¶çš„åŸå› æ˜¯ï¼šå¯¹äºéå¯¹è±¡æ¯”å¦‚å‡½æ•°ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯¼å‡ºä¸€ä¸ªå‡½æ•°ä¼šç›´æ¥è°ƒç”¨æ‰§è¡Œè€Œä¸æ˜¯è·å–å‡½æ•°ä¸Šçš„å±æ€§æˆ–æ–¹æ³•ï¼Œè¿™ç§å¯¼å‡ºéçº¯å¯¹è±¡æ¨¡å—å³ä½¿é‡å»ºç¼“å­˜ä¹Ÿä¸ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥å¹²è„†å¿½ç•¥ã€‚å¹¸è¿çš„æ˜¯ï¼Œmodule.exports å¯¼å‡ºå¯¹è±¡å äº†å¤§å¤šæ•°åœºæ™¯ã€‚ ç”¨ shimmer æ¨¡å—é‡è½½ Module.prototype._compile æ–¹æ³•ï¼Œå¦‚æœæ˜¯è¢«ç›‘å¬çš„æ–‡ä»¶å¹¶ä¸”å¯¼å‡ºçš„æ˜¯çº¯å¯¹è±¡ï¼Œåˆ™å°è¯•å°†å¯¼å‡ºçš„å¯¹è±¡åŒ…è£…æˆ Proxy å®ä¾‹ã€‚è¿™æ ·ï¼Œåœ¨è·å–è¯¥å¯¹è±¡ä¸Šçš„å±æ€§æ—¶ï¼Œå°†ä» require.cache ä¸­è¯»å–æœ€æ–°çš„å€¼ã€‚ ä½¿ç”¨ç¤ºä¾‹ï¼š user.js 1234module.exports = &#123; id: 1, name: &#x27;nswbmw&#x27;&#125; app.js 123456789101112131415if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123; require(&#x27;proxy-hot-reload&#x27;)(&#123; includes: &#x27;**/*.js&#x27; &#125;)&#125;const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()const user = require(&#x27;./user&#x27;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/&#x27;, controller (ctx) &#123; ctx.body = user&#125;&#125;)app.listen(3000) æµè§ˆå™¨è®¿é—® localhost:3000 æŸ¥çœ‹ç»“æœï¼Œä¿®æ”¹ user.js ä¸­å­—æ®µçš„å€¼ï¼Œç„¶ååˆ·æ–°æµè§ˆå™¨æŸ¥çœ‹ç»“æœã€‚ proxy-hot-reload æœ‰ä¸ªéå¸¸æ˜æ˜¾çš„ç¼ºç‚¹ï¼šåªæ”¯æŒå¯¹å¯¼å‡ºçš„æ˜¯çº¯å¯¹è±¡çš„æ–‡ä»¶åšä»£ç†ï¼Œè€Œä¸”ç¨‹åºå…¥å£æ–‡ä»¶ä¸ä¼šç”Ÿæ•ˆï¼Œæ¯”å¦‚ä¸Šé¢çš„ app.jsï¼Œä¿®æ”¹ç«¯å£å·åªèƒ½é‡å¯æ‰ä¼šç”Ÿæ•ˆã€‚Proxy å†æ€ä¹ˆé»‘é­”æ³•ä¹Ÿåªèƒ½åšåˆ°è¿™ä¸ªåœ°æ­¥äº†ï¼Œé€€ä¸€æ­¥æƒ³ï¼Œå¦‚æœä¿®æ”¹äº† proxy-hot-reload è¦†ç›–ä¸åˆ°çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼šapp.jsï¼‰é™çº§æˆè‡ªåŠ¨é‡å¯å°±å¥½äº†ï¼Œå¦‚æœå°† proxy-hot-reload å’Œ supervisor ç»“åˆï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ 4.5.3 supervisor-hot-reloadå¦‚æœè¦å°† proxy-hot-reload ç»“åˆ supervisor ä½¿ç”¨ï¼Œéœ€è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªéš¾ç‚¹ï¼š éä¾µå…¥å¼ã€‚å³ä»£ç é‡Œä¸å†å†™ï¼š 12345if (process.env.NODE_ENV !== &#x27;production&#x27;) &#123; require(&#x27;proxy-hot-reload&#x27;)(&#123; includes: &#x27;**/*.js&#x27; &#125;)&#125; å‚æ•°ç»Ÿä¸€ã€‚supervisor å¯æ¥å— -w å‚æ•°è¡¨æ˜ç›‘å¬å“ªäº›æ–‡ä»¶ï¼Œ-i å‚æ•°è¡¨æ˜å¿½ç•¥å“ªäº›æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªå‚æ•°æ€ä¹ˆä¸ proxy-hot-reload çš„ includes å’Œ excludes å‚æ•°æ•´åˆã€‚ èŒè´£åˆ†æ˜ã€‚ä¿®æ”¹ä»£ç æ–‡ä»¶å¹¶ä¿å­˜åï¼Œä¼˜å…ˆå°è¯• proxy-hot-reload çš„çƒ­æ›´æ–°ï¼Œå¦‚æœ proxy-hot-reload çƒ­æ›´æ–°ä¸äº†ï¼Œåˆ™ä½¿ç”¨ supervisor é‡å¯ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ supervisor çš„æºç ï¼ˆlib&#x2F;supervisor.jsï¼‰ï¼Œæºç ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š 1234567891011121314var watchItems = watch.split(&#x27;,&#x27;);watchItems.forEach(function (watchItem) &#123; watchItem = path.resolve(watchItem); if ( ! ignoredPaths[watchItem] ) &#123; log(&quot;Watching directory &#x27;&quot; + watchItem + &quot;&#x27; for changes.&quot;); if(interactive) &#123; log(&quot;Press rs for restarting the process.&quot;); &#125; findAllWatchFiles(watchItem, function(f) &#123; watchGivenFile( f, poll_interval ); &#125;); &#125;&#125;); ä»¥ä¸Šä»£ç çš„ä½œç”¨æ˜¯ï¼šéå†æ‰¾åˆ°æ‰€æœ‰éœ€è¦ç›‘å¬çš„æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨ watchGivenFile ç›‘å¬æ–‡ä»¶ã€‚watchGivenFile ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718function watchGivenFile (watch, poll_interval) &#123; if (isWindowsWithoutWatchFile || forceWatchFlag) &#123; fs.watch(watch, &#123; persistent: true, interval: poll_interval &#125;, crashWin); &#125; else &#123; fs.watchFile(watch, &#123; persistent: true, interval: poll_interval &#125;, function(oldStat, newStat) &#123; // we only care about modification time, not access time. if ( newStat.mtime.getTime() !== oldStat.mtime.getTime() ) &#123; if (verbose) &#123; log(&quot;file changed: &quot; + watch); &#125; &#125; crash(); &#125;); &#125; if (verbose) &#123; log(&quot;watching file &#x27;&quot; + watch + &quot;&#x27;&quot;); &#125;&#125; watchGivenFile çš„ä½œç”¨æ˜¯ï¼šç”¨ fs.watch&#x2F;fs.watchFile ç›‘å¬æ–‡ä»¶ï¼Œå¦‚æœæœ‰æ”¹åŠ¨åˆ™è°ƒç”¨ crashWin&#x2F;crash ç¨‹åºé€€å‡ºã€‚supervisor ä½¿ç”¨ child_process.spawn å°†ç¨‹åºè¿è¡Œåœ¨å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹é€€å‡ºåä¼šè¢« supervisor é‡æ–°å¯åŠ¨ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š 12345678function startProgram (prog, exec) &#123; var child = exports.child = spawn(exec, prog, &#123;stdio: &#x27;inherit&#x27;&#125;); ... child.addListener(&quot;exit&quot;, function (code) &#123; ... startProgram(prog, exec); &#125;);&#125; å¤§ä½“ç†æ¸… supervisor çš„å…³é”®æºç åï¼Œæˆ‘ä»¬å°±çŸ¥é“å¦‚ä½•è§£å†³ä¸Šé¢æåˆ°çš„å‡ ä¸ªéš¾ç‚¹äº†ã€‚ é¦–å…ˆéœ€è¦ä¿®æ”¹ proxy-hot-reloadï¼Œæ·»åŠ ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š æ·»åŠ  includeFiles å’Œ excludeFiles é€‰é¡¹ï¼Œå€¼ä¸ºæ•°ç»„ï¼Œç”¨æ¥æ¥æ”¶ supervisor ä¼ æ¥çš„æ–‡ä»¶åˆ—è¡¨ã€‚ æ·»åŠ  watchedFileChangedButNotReloadCache å‚æ•°ã€‚proxy-hot-reload å¯ä»¥çŸ¥é“å“ªäº›ä»£ç æ–‡ä»¶å¯ä»¥çƒ­æ›´æ–°ï¼Œå“ªäº›ä¸å¯ä»¥ã€‚å½“ç›‘å¬åˆ°ä¸èƒ½çƒ­æ›´æ–°çš„æ–‡ä»¶æœ‰ä¿®æ”¹æ—¶ï¼Œåˆ™è°ƒç”¨ watchedFileChangedButNotReloadCache å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œæœ‰ process.exit() ä½¿è¿›ç¨‹é€€å‡ºã€‚ éš¾ç‚¹åŠè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š éä¾µå…¥å¼ã€‚å› ä¸ºçœŸæ­£çš„ç¨‹åºè¯•è¿è¡Œåœ¨ supervisor åˆ›å»ºçš„å­è¿›ç¨‹ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•åœ¨ supervisor è¿›ç¨‹ä¸­å¼•å…¥ proxy-hot-reloadï¼Œåªèƒ½é€šè¿‡å­è¿›ç¨‹ç”¨ node -r xxx æå‰å¼•å…¥å¹¶è¦†ç›– Module.prototype._compileã€‚è§£å†³æ–¹æ¡ˆï¼šå°† supervisor éœ€è¦ç›‘å¬çš„æ–‡ä»¶æ•°ç»„ï¼ˆwatchFilesï¼‰å’Œ proxy-hot-reload é…ç½®å†™åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼šproxy-hot-reload.jsï¼‰é‡Œï¼Œå­è¿›ç¨‹é€šè¿‡ node -r proxy-hot-reload.js app.js é¢„åŠ è½½æ­¤æ–‡ä»¶å¯åŠ¨ã€‚ supervisor ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š 12345678910111213// è·å– watchFilesfs.writeFileSync(path.join(__dirname, &#x27;proxy-hot-reload.js&#x27;), ` require(&#x27;$&#123;path.join(__dirname, &quot;..&quot;, &quot;node_modules&quot;, &quot;proxy-hot-reload&quot;)&#125;&#x27;)(&#123; includeFiles: $&#123;JSON.stringify(watchFiles)&#125;, excludeFiles: [], watchedFileChangedButNotReloadCache: function (filename) &#123; console.log(filename + &#x27; changed, restarting...&#x27;); setTimeout(function () &#123; process.exit(); &#125;, $&#123;poll_interval&#125;); &#125;&#125;);`);// startChildProcess() å‚æ•°ç»Ÿä¸€ã€‚å°†ä¸Šé¢çš„ watchItems.forEach å†…å¼‚æ­¥éå†éœ€è¦ç›‘å¬çš„æ–‡ä»¶åˆ—è¡¨ä¿®æ”¹ä¸ºåŒæ­¥ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415var watchFiles = []var watchItems = watch.split(&#x27;,&#x27;);watchItems.forEach(function (watchItem) &#123; watchItem = path.resolve(watchItem); if ( ! ignoredPaths[watchItem] ) &#123; log(&quot;Watching directory &#x27;&quot; + watchItem + &quot;&#x27; for changes.&quot;); if(interactive) &#123; log(&quot;Press rs for restarting the process.&quot;); &#125; findAllWatchFiles(watchItem, function(f) &#123; watchFiles.push(f) // watchGivenFile( f, poll_interval ); &#125;); &#125;&#125;); æ³¨æ„ï¼šè¿™é‡Œ findAllWatchFiles è™½ç„¶æœ‰å›è°ƒå‡½æ•°ï¼Œä½†å´æ˜¯åŒæ­¥çš„ã€‚å°† findAllWatchFiles å†…çš„ fs.lstat&#x2F;fs.stat&#x2F;fs.readdir åˆ†åˆ«æ”¹ä¸º fs.lstatSync&#x2F;fs.statSync&#x2F;fs.readdirSyncï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚ èŒè´£åˆ†æ˜ã€‚å­è¿›ç¨‹ä½¿ç”¨ node -r proxy-hot-reload.js app.js å¯åŠ¨åï¼Œèƒ½çƒ­æ›´æ–°çš„åˆ™çƒ­æ›´æ–°ï¼Œä¸èƒ½çƒ­æ›´æ–°çš„æ‰§è¡Œ watchedFileChangedButNotReloadCacheï¼Œå­è¿›ç¨‹é€€å‡ºï¼Œsupervisor ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œå®ç°äº†èŒè´£åˆ†æ˜ã€‚ ç¬”è€…å°†æ”¹è¿›åçš„ supervisor å‘å¸ƒæˆä¸€ä¸ªæ–°çš„åŒ…â€”â€”supervisor-hot-reload ã€‚ä½¿ç”¨å¦‚ä¸‹ï¼š user.js 1234module.exports = &#123; id: 1, name: &#x27;nswbmw&#x27;&#125; app.js 123456789const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()const user = require(&#x27;./user&#x27;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/&#x27;, controller (ctx) &#123; ctx.body = user&#125;&#125;)app.listen(3000) å…¨å±€å®‰è£…å¹¶ä½¿ç”¨ supervisor-hot-reloadï¼š 12$ npm i supervisor-hot-reload -g$ DEBUG=proxy-hot-reload supervisor-hot-reload app.js ä¿®æ”¹ user.jsï¼Œç¨‹åºä¸ä¼šé‡å¯ï¼Œæ‰“å°ï¼š 1proxy-hot-reload Reload file: /Users/nswbmw/Desktop/test/user.js ä¿®æ”¹ app.jsï¼Œç¨‹åºä¼šé‡å¯ï¼Œæ‰“å°ï¼š 12345/Users/nswbmw/Desktop/test/app.js changed, restarting...Program node app.js exited with code 0Starting child process with &#x27;node app.js&#x27;... 4.5.4 å†…å­˜æ³„éœ²é—®é¢˜è¿™é‡Œéœ€è¦å£°æ˜ä¸€ä¸‹ï¼Œè™½ç„¶ä¿®æ”¹ require.cache + Proxy å®ç°äº†æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ï¼Œä½†è¿™æ ·åšå­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå› ä¸ºå³ä½¿åˆ é™¤äº†ä¸€ä¸ªæ¨¡å—çš„ç¼“å­˜ï¼Œä½†çˆ¶æ¨¡å—çš„ç¼“å­˜ä¸­è¿˜å¼•ç”¨ç€æ—§çš„æ¨¡å—å¯¼å‡ºçš„å¯¹è±¡ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ä¸ç”¨å¤ªå…³å¿ƒï¼ŒçŸ¥é“ä¸ºä»€ä¹ˆå°±å¥½ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ proxy-hot-reloadã€‚ 4.5.5 å‚è€ƒé“¾æ¥ https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html ä¸Šä¸€èŠ‚ï¼š4.4 debug + repl2 + power-assert ä¸‹ä¸€èŠ‚ï¼š5.1 NewRelic","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 4.4 Debug","slug":"4.4.1 debug","date":"2019-07-30T06:00:00.000Z","updated":"2022-05-25T04:23:30.946Z","comments":true,"path":"2019/07/30/4.4.1 debug/","link":"","permalink":"https://marvinliu1.github.io/2019/07/30/4.4.1%20debug/","excerpt":"","text":"Node in Debugging ä¸Šä¸€å°èŠ‚è®²è§£äº†å¦‚ä½•ç”¨ä½¿ç”¨ VS Code è°ƒè¯• Node.js ä»£ç ï¼Œä½†è°ƒè¯•ä¸åªæ˜¯æ‰“æ–­ç‚¹ï¼Œæ¯”å¦‚ï¼š å¦‚ä½•å¿«é€Ÿåœ°åˆ‡æ¢è¾“å‡ºçš„æ—¥å¿—ç±»å‹ï¼ˆæˆ–çº§åˆ«ï¼‰? æˆ‘æƒ³ç”¨ moment æ‰“å°å‡ºå¹´ä»½ï¼Œæ˜¯ä½¿ç”¨ moment().format(&#39;YYYY&#39;)ï¼Œè¿˜æ˜¯ moment().format(&#39;yyyy&#39;)ï¼Œè¿˜æ˜¯ä¸¤ç§å†™æ³•éƒ½å¯ä»¥? æ–­è¨€æŠ¥é”™ï¼šAssertionError: false &#x3D;&#x3D; trueï¼Œæ²¡å•¥æœ‰ç”¨ä¿¡æ¯ï¼Œé»‘äººé—®å·??? æœ¬èŠ‚å°†ä»‹ç» 3 æ¬¾å®ç”¨çš„è°ƒè¯•å·¥å…·ï¼Œåˆ†åˆ«è§£å†³ä»¥ä¸Š 3 ç§æƒ…å†µï¼Œæ¥æé«˜æˆ‘ä»¬çš„è°ƒè¯•æ•ˆç‡ã€‚ 4.4.1 debugdebug æ˜¯ä¸€ä¸ªå°å·§å´éå¸¸å®ç”¨çš„æ—¥å¿—æ¨¡å—ï¼Œå¯ä»¥æ ¹æ®ç¯å¢ƒå˜é‡å†³å®šæ‰“å°ä¸åŒç±»å‹ï¼ˆæˆ–çº§åˆ«ï¼‰çš„æ—¥å¿—ã€‚ä»£ç å¦‚ä¸‹ï¼š app.js 123456789101112131415const normalLog = require(&#x27;debug&#x27;)(&#x27;log&#x27;)const errorLowLog = require(&#x27;debug&#x27;)(&#x27;error:low&#x27;)const errorNormalLog = require(&#x27;debug&#x27;)(&#x27;error:normal&#x27;)const errorHighLog = require(&#x27;debug&#x27;)(&#x27;error:high&#x27;)setInterval(() =&gt; &#123; const value = Math.random() switch (true) &#123; case value &lt; 0.5: normalLog(value); break case value &gt;= 0.5 &amp;&amp; value &lt; 0.7: errorLowLog(value); break case value &gt;= 0.7 &amp;&amp; value &lt; 0.9: errorNormalLog(value); break case value &gt;= 0.9: errorHighLog(value); break default: normalLog(value) &#125;&#125;, 1000) è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œæ¯ä¸€ç§’ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œæ ¹æ®éšæœºæ•°çš„å€¼æ¨¡æ‹Ÿä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡ºï¼š &lt; 0.5ï¼šæ­£å¸¸æ—¥å¿—ã€‚ 0.5~0.7ï¼šä½çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚ 0.7~0.9ï¼šä¸€èˆ¬çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚ &gt;&#x3D; 0.9ï¼šä¸¥é‡çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚ è¿è¡Œï¼š 1$ DEBUG=* node app.js æ‰“å°å¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºï¼Œdebug æ¨¡å—æ‰“å°çš„æ—¥å¿—ä¸ console.log ç›¸æ¯”ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š ä¸åŒçš„æ—¥å¿—ç±»å‹åˆ†é…äº†ä¸åŒçš„é¢œè‰²åŠ ä»¥åŒºåˆ†ï¼Œæ›´ç›´è§‚ã€‚ æ·»åŠ äº†æ—¥å¿—ç±»å‹çš„å‰ç¼€ã€‚ æ·»åŠ äº†è‡ªä¸Šä¸€æ¬¡è¯¥ç±»å‹æ—¥å¿—æ‰“å°åˆ°è¿™æ¬¡æ—¥å¿—æ‰“å°ç»å†äº†å¤šé•¿æ—¶é—´çš„åç¼€ã€‚ debug æ¨¡å—æ”¯æŒä»¥ä¸‹ç”¨æ³•ï¼š DEBUG&#x3D;*ï¼šæ‰“å°æ‰€æœ‰ç±»å‹çš„æ—¥å¿—ã€‚ DEBUG&#x3D;logï¼šåªæ‰“å° log ç±»å‹çš„æ—¥å¿—ã€‚ DEBUG&#x3D;error:*ï¼šæ‰“å°æ‰€æœ‰ä»¥ error: å¼€å¤´çš„æ—¥å¿—ã€‚ DEBUG&#x3D;error:*,-error:lowï¼šæ‰“å°æ‰€æœ‰ä»¥ error: å¼€å¤´çš„å¹¶ä¸”è¿‡æ»¤æ‰ error:low ç±»å‹çš„æ—¥å¿—ã€‚ ä¸‹é¢æ¼”ç¤ºä¸€ä¸‹ç¬¬ 4 ç§çš„ç”¨æ³•ï¼Œè¿è¡Œï¼š 1$ DEBUG=error:*,-error:low node app.js æ‰“å°å¦‚ä¸‹ï¼š 4.4.2 repl2æˆ‘ä»¬åœ¨å†™ä»£ç æ—¶ï¼Œæœ‰æ—¶å¯èƒ½è®°ä¸æ¸…æŸä¸ªæ¨¡å—çš„æŸä¸ªæ–¹æ³•çš„å…·ä½“ç”¨æ³•ï¼Œæ¯”å¦‚ï¼šç”¨ moment æ ¼å¼åŒ–å¹´ä»½æ˜¯ç”¨ moment().format(&#39;YYYY&#39;) è¿˜æ˜¯ç”¨ moment().format(&#39;yyyy&#39;) è¿˜æ˜¯ä¸¤ç§å†™æ³•éƒ½å¯ä»¥ï¼Ÿlodash çš„ _.pick æ–¹æ³•èƒ½å¦èƒ½æ¥æ”¶æ•°ç»„ä½œä¸ºå‚æ•°ï¼Ÿè¿™ä¸ªæ—¶å€™ç›¸å¯¹äºç¿»é˜…å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨ REPL é‡Œè¯•ä¸€ä¸‹å¯èƒ½ä¼šæ›´å¿«ï¼Œé€šå¸¸æ­¥éª¤æ˜¯ï¼š 1234567$ npm i moment$ node&gt; const moment = require(&#x27;moment&#x27;)&gt; moment().format(&#x27;YYYY&#x27;)&#x27;2017&#x27;&gt; moment().format(&#x27;yyyy&#x27;)&#x27;yyyy&#x27; ä¸€æ¬¡è¿˜å¥½ï¼Œæ¬¡æ•°å¤šäº†ä¹Ÿç•¥å¾®çƒ¦çã€‚repl2 æ¨¡å—ä¾¿æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œç”Ÿçš„ã€‚ repl2 é¡¾åæ€ä¹‰æ˜¯ REPL çš„å¢å¼ºç‰ˆï¼Œrepl2 ä¼šæ ¹æ®ä¸€ä¸ªç”¨æˆ·é…ç½®ï¼ˆ~&#x2F;.nodercï¼‰ï¼Œé¢„å…ˆåŠ è½½æ¨¡å—åˆ° REPL ä¸­ï¼Œçœä¸‹äº†æˆ‘ä»¬æ‰‹åŠ¨åœ¨ REPL ä¸­ require æ¨¡å—çš„è¿‡ç¨‹ã€‚ å…¨å±€å®‰è£… repl2ï¼š 1$ npm i repl2 -g ä½¿ç”¨æ–¹å¼å¾ˆç®€å•: å°†å¸¸ç”¨çš„æ¨¡å—å…¨å±€å®‰è£…ï¼Œä¾‹å¦‚ï¼š 1$ npm i lodash validator moment -g æ·»åŠ é…ç½®åˆ° ~&#x2F;.nodercï¼š 12345&#123; &quot;lodash&quot;: &quot;__&quot;, &quot;moment&quot;: &quot;moment&quot;, &quot;validator&quot;: &quot;validator&quot;&#125; è¿è¡Œ noderï¼š 12345678910$ noder__ = lodash@4.17.4 -&gt; localmoment = moment@2.18.1 -&gt; globalvalidator = validator@7.0.0 -&gt; global&gt; moment().format(&#x27;YYYY&#x27;)&#x27;2017&#x27;&gt; __.random(0, 5)3&gt; validator.isEmail(&#x27;foo@bar.com&#x27;)true éœ€è¦è®²è§£ä»¥ä¸‹å‡ ç‚¹ï¼š ~&#x2F;.noderc æ˜¯ä¸€ä¸ª JSON æ–‡ä»¶ï¼Œkey æ˜¯æ¨¡å—çš„åå­—ï¼Œvalue æ˜¯ require è¿™ä¸ªæ¨¡å—ååŠ è½½åˆ° REPL ä¸­çš„å˜é‡åã€‚è¿™é‡Œç»™ lodash å‘½åçš„å˜é‡åæ˜¯ __ è€Œä¸æ˜¯ _ï¼Œæ˜¯å› ä¸º REPL ä¸­ _ æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œè¡¨ç¤ºä¸Šä¸€ä¸ªè¡¨è¾¾å¼çš„ç»“æœã€‚ repl2 ä¼šä¼˜å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„æ¨¡å—ï¼Œæ²¡æœ‰æ‰¾åˆ°ç„¶åå†å»åŠ è½½å…¨å±€å®‰è£…çš„æ¨¡å—ã€‚ä¸Šé¢ç»“æœæ˜¾ç¤º lodash æ˜¯ä»æœ¬åœ°ç›®å½•åŠ è½½çš„ï¼Œå› ä¸º test ç›®å½•ä¸‹å·²ç»å®‰è£…äº† lodashï¼Œå…¶ä½™çš„æ¨¡å—æ²¡æœ‰ä»æœ¬åœ°ç›®å½•æ‰¾åˆ°åˆ™å°è¯•ä»å…¨å±€ npm ç›®å½•åŠ è½½ã€‚å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¸ä¼šåŠ è½½ã€‚ 4.4.3 power-assertæˆ‘ä»¬å¸¸ç”¨çš„æ–­è¨€åº“æœ‰ï¼š should.js expect.js chai ä½†è¿™ç±»æ–­è¨€åº“éƒ½æœ‰ä¸€äº›é€šç—…ï¼š è¿‡åˆ†è¿½æ±‚è¯­ä¹‰åŒ–ï¼ŒAPI å¤æ‚ã€‚ é”™è¯¯ä¿¡æ¯ä¸è¶³ã€‚ å…ˆçœ‹ä¸€æ®µä»£ç ï¼š test.js 123456789101112131415161718const assert = require(&#x27;assert&#x27;)const should = require(&#x27;should&#x27;)const expect = require(&#x27;expect.js&#x27;)const tom = &#123; id: 1, age: 18 &#125;const bob = &#123; id: 2, age: 20 &#125;describe(&#x27;app.js&#x27;, () =&gt; &#123; it(&#x27;assert&#x27;, () =&gt; &#123; assert(tom.age &gt; bob.age) &#125;) it(&#x27;should.js&#x27;, () =&gt; &#123; tom.age.should.be.above(bob.age) &#125;) it(&#x27;expect.js&#x27;, () =&gt; &#123; expect(tom.age).be.above(bob.age) &#125;)&#125;) è¿è¡Œï¼š 1$ mocha ç»“æœå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334app.js 1) assert 2) should.js 3) expect.js0 passing (13ms)3 failing1) app.js assert: AssertionError [ERR_ASSERTION]: false == true + expected - actual -false +true at Context.it (test.js:10:5)2) app.js should.js: AssertionError: expected 18 to be above 20 at Assertion.fail (node_modules/should/cjs/should.js:275:17) at Assertion.value (node_modules/should/cjs/should.js:356:19) at Context.it (test.js:13:23)3) app.js expect.js: Error: expected 18 to be above 20 at Assertion.assert (node_modules/expect.js/index.js:96:13) at Assertion.greaterThan.Assertion.above (node_modules/expect.js/index.js:297:10) at Function.above (node_modules/expect.js/index.js:499:17) at Context.it (test.js:16:24) å¯ä»¥çœ‹å‡ºï¼ŒåŸºæœ¬æ²¡æœ‰æœ‰ç”¨çš„ä¿¡æ¯ã€‚è¿™æ—¶ï¼Œpower-assert ç²‰å¢¨ç™»åœºã€‚ power-assert ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œç†è®ºä¸Šåªç”¨ä¸€ä¸ª assert å°±å¯ä»¥äº†ï¼Œè€Œä¸”å¯ä»¥æ— ç¼è¿ç§»ã€‚ æ³¨æ„ï¼šåœ¨ä½¿ç”¨ intelli-espower-loader æ—¶ï¼Œè¦æ±‚å¿…é¡»å°†æµ‹è¯•æ–‡ä»¶æ”¾åˆ° test&#x2F; ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ test ç›®å½•ä¸‹åˆ›å»º test&#x2F;app.jsï¼Œå°†åŸæ¥çš„ test.js ä»£ç ç²˜è´´è¿‡å»ã€‚ å®‰è£… power-assert å’Œ intelli-espower-loaderï¼Œç„¶åè¿è¡Œæµ‹è¯•ï¼š 12$ npm i power-assert intelli-espower-loader --save-dev$ mocha -r intelli-espower-loader ç»“æœå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526app.js 1) assert 2) should.js 3) expect.js0 passing (42ms)3 failing1) app.js assert: AssertionError [ERR_ASSERTION]: # test/app.js:10assert(tom.age &gt; bob.age) | | | | | | | | | 20 | | | Object&#123;id:2,age:20&#125; | 18 false Object&#123;id:1,age:18&#125; + expected - actual -false +true ... é”™è¯¯ä¿¡æ¯éå¸¸ç›´è§‚ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦è¯´æ˜ï¼š mocha éœ€è¦å¼•å…¥ intelli-espower-loaderï¼Œä¸»è¦æ˜¯è½¬è¯‘ä»£ç ï¼Œè½¬è¯‘ä¹‹å require(&#39;assert&#39;) éƒ½ä¸éœ€è¦æ”¹ã€‚ intelli-espower-loader å¯é€‰æ‹©åœ°åœ¨ package.json ä¸­æ·»åŠ  directories.test é…ç½®ï¼Œä¾‹å¦‚ï¼š 123&quot;directories&quot;: &#123; &quot;test&quot;: &quot;mytest/&quot;&#125; å¦‚æœæ²¡æœ‰ directories.test é…ç½®ï¼Œåˆ™é»˜è®¤æ˜¯ test/ã€‚ 4.4.4 å‚è€ƒé“¾æ¥ https://zhuanlan.zhihu.com/p/25956323 https://www.npmjs.com/package/intelli-espower-loader","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 4.3 VS Code Debugging","slug":"4.3.1 åŸºæœ¬è°ƒè¯•","date":"2019-07-26T06:00:00.000Z","updated":"2022-05-25T04:23:06.702Z","comments":true,"path":"2019/07/26/4.3.1 åŸºæœ¬è°ƒè¯•/","link":"","permalink":"https://marvinliu1.github.io/2019/07/26/4.3.1%20%E5%9F%BA%E6%9C%AC%E8%B0%83%E8%AF%95/","excerpt":"","text":"Node in Debugging Visual Studio Codeï¼ˆç®€ç§° VS Codeï¼‰æ˜¯ä¸€æ¬¾å¾®è½¯å¼€æºçš„ç°ä»£åŒ–ã€è·¨å¹³å°ã€è½»é‡çº§çš„ä»£ç ç¼–è¾‘å™¨ã€‚VS Code å¾ˆå¥½å¾ˆå¼ºå¤§ï¼Œæœ¬èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ VS Code æ¥è°ƒè¯• Node.js ä»£ç ã€‚ 4.3.1 åŸºæœ¬è°ƒè¯•ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š app.js 12345678const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(ctx =&gt; &#123; ctx.body = &#x27;hello world!&#x27;&#125;)app.listen(3000) ç”¨ VS Code åŠ è½½ test æ–‡ä»¶å¤¹ï¼Œæ‰“å¼€ app.jsï¼Œç„¶åè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š å•å‡»å·¦ä¾§ç¬¬ 4 ä¸ª tabï¼Œåˆ‡æ¢åˆ°è°ƒè¯•æ¨¡å¼ã€‚ å•å‡»ä»£ç ç¬¬ 5 è¡Œ ctx.body=&#39;hello world!&#39; å·¦ä¾§ç©ºç™½å¤„æ·»åŠ æ–­ç‚¹ã€‚ å•å‡»å·¦ä¸Šè§’ â€è°ƒè¯•â€œ çš„ç»¿è‰²ä¸‰è§’æŒ‰é’®å¯åŠ¨è°ƒè¯•ã€‚ å•å‡»å·¦ä¸Šè§’çš„ç»ˆç«¯å›¾æ ‡æ‰“å¼€è°ƒè¯•æ§åˆ¶å°ã€‚ æœ€ç»ˆå¦‚ä¸‹æ‰€ç¤ºï¼š ä» â€œè°ƒè¯•æ§åˆ¶å°â€œ åˆ‡æ¢åˆ° â€ç»ˆç«¯â€œï¼Œè¿è¡Œï¼š 1$ curl localhost:3000 å¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼ŒVS Code åŸºæœ¬è¦†ç›–äº† Chrome DevTools çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶ä¸”æœ‰ä¸¤ä¸ªé¢å¤–çš„ä¼˜ç‚¹ï¼š é›†æˆäº†ç»ˆç«¯ï¼Œä¸ç”¨å†æ‰“å¼€æ–°çš„ç»ˆç«¯è¾“å…¥å‘½ä»¤äº†ã€‚ è°ƒè¯•åŠ¨ä½œé‡Œæ·»åŠ äº† â€é‡å¯â€œ å’Œ â€åœæ­¢â€œ æŒ‰é’®ï¼Œä¸ç”¨æ¯æ¬¡ä¿®æ”¹å®Œä»£ç ååˆ‡å›ç»ˆç«¯å»é‡å¯äº†ã€‚ ä½† VS Code çš„å¼ºå¤§è¿œä¸æ­¢å¦‚æ­¤ï¼Œé€šè¿‡ launch.json å¯ä»¥é…ç½®è¯¦ç»†çš„è°ƒè¯•åŠŸèƒ½ã€‚ 4.3.2 launch.jsonä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œâ€è°ƒè¯•â€œ æŒ‰é’®å³è¾¹æœ‰ä¸€ä¸ªä¸‹æ‹‰èœå•ï¼Œé»˜è®¤æ˜¯ â€æ²¡æœ‰é…ç½®â€œã€‚å•å‡»å³ä¾§çš„é½¿è½®çŠ¶å›¾æ ‡ï¼Œä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º .vscode æ–‡ä»¶å¤¹åŠ launch.json æ–‡ä»¶ã€‚launch.json çš„å†…å®¹å¦‚ä¸‹ï¼š è¿™ä¸ªé»˜è®¤é…ç½®çš„æ„æ€æ˜¯æ‰§è¡Œï¼š 1$ node $&#123;workspaceFolder&#125;/app.js launch.json å…¶å®å°±æ˜¯å­˜å‚¨äº†ä¸€äº›è°ƒè¯•ç›¸å…³çš„é…ç½®ï¼ŒVS Code åœ¨å¯åŠ¨è°ƒè¯•æ—¶ï¼Œä¼šè¯»å– launch.json å†³å®šä»¥ä½•ç§æ–¹å¼è°ƒè¯•ã€‚launch.json æœ‰ä»¥ä¸‹å¸¸ç”¨é€‰é¡¹ï¼š å¿…éœ€å­—æ®µå¦‚ä¸‹ï¼š typeï¼šè°ƒè¯•å™¨ç±»å‹ã€‚è¿™é‡Œæ˜¯ nodeï¼ˆå†…ç½®çš„è°ƒè¯•å™¨ï¼‰ï¼Œå¦‚æœå®‰è£…äº† Go å’Œ PHP çš„æ‰©å±•åï¼Œåˆ™å¯¹åº”çš„ type åˆ†åˆ«ä¸º go å’Œ phpã€‚ requestï¼šè¯·æ±‚çš„ç±»å‹ï¼Œæ”¯æŒ launch å’Œ attachã€‚launch å°±æ˜¯ä»¥ debug æ¨¡å¼å¯åŠ¨è°ƒè¯•ï¼Œattach å°±æ˜¯é™„åŠ åˆ°å·²ç»å¯åŠ¨çš„è¿›ç¨‹å¼€å¯ debug æ¨¡å¼å¹¶è°ƒè¯•ï¼Œè·Ÿåœ¨ä¸Šä¸€å°èŠ‚ä¸­æåˆ°çš„ç”¨ node -e &quot;process._debugProcess(PID)&quot; ä½œç”¨ä¸€æ ·ã€‚ nameï¼šä¸‹æ‹‰èœå•æ˜¾ç¤ºçš„åå­—ã€‚ å¯é€‰å­—æ®µï¼ˆæ‹¬å·é‡Œè¡¨ç¤ºé€‚ç”¨çš„ç±»å‹ï¼‰å¦‚ä¸‹ï¼š programï¼šå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…è°ƒè¯•å™¨è¦è¿è¡Œçš„æ–‡ä»¶ (launch)ã€‚ argsï¼šè¦ä¼ é€’ç»™è°ƒè¯•ç¨‹åºçš„å‚æ•° (launch)ã€‚ envï¼šç¯å¢ƒå˜é‡ (launch)ã€‚ cwdï¼šå½“å‰æ‰§è¡Œç›®å½• (launch)ã€‚ addressï¼šIP åœ°å€ (launch &amp; attach)ã€‚ portï¼šç«¯å£å· (launch &amp; attach)ã€‚ skipFilesï¼šæƒ³è¦å¿½ç•¥çš„æ–‡ä»¶ï¼Œæ•°ç»„ç±»å‹ (launch &amp; attach)ã€‚ processIdï¼šè¿›ç¨‹ PID (attach)ã€‚ â€¦ å˜é‡æ›¿æ¢ï¼š ${workspaceFolder}ï¼šå½“å‰æ‰“å¼€å·¥ç¨‹çš„è·¯å¾„ã€‚ ${file}ï¼šå½“å‰æ‰“å¼€æ–‡ä»¶çš„è·¯å¾„ã€‚ ${fileBasename}ï¼šå½“å‰æ‰“å¼€æ–‡ä»¶çš„åå­—ï¼ŒåŒ…å«åç¼€åã€‚ ${fileDirname}ï¼šå½“å‰æ‰“å¼€æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹çš„è·¯å¾„ã€‚ ${fileExtname}ï¼šå½“å‰æ‰“å¼€æ–‡ä»¶çš„åç¼€åã€‚ ${cwd}ï¼šå½“å‰æ‰§è¡Œç›®å½•ã€‚ â€¦ å¦‚æœå½“å‰æ‰“å¼€çš„æ–‡ä»¶æ˜¯ app.jsï¼Œåˆ™ä»¥ä¸‹é…ç½®ä¸é»˜è®¤é…ç½®æ˜¯ç­‰æ•ˆçš„ï¼š 1234567891011&#123; &quot;version&quot;: &quot;0.2.0&quot;, &quot;configurations&quot;: [ &#123; &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;launch&quot;, &quot;name&quot;: &quot;å¯åŠ¨ç¨‹åº&quot;, &quot;program&quot;: &quot;$&#123;file&#125;&quot; &#125; ]&#125; è‹¥æƒ³äº†è§£æ›´å¤šçš„ launch.json é€‰é¡¹ï¼Œåˆ™è¯·æŸ¥é˜…ï¼š Debugging in Visual Studio Codeã€‚ Debug Node.js Apps using VS Codeã€‚ ä¸‹é¢ä»¥ 5 ä¸ªå®ç”¨çš„æŠ€å·§è®²è§£éƒ¨åˆ† launch.json é…ç½®çš„ä½œç”¨ã€‚ 4.3.3 æŠ€å·§ 1â€”â€”æ¡ä»¶æ–­ç‚¹VS Code å¯ä»¥æ·»åŠ æ¡ä»¶æ–­ç‚¹ï¼Œå³æ‰§è¡Œåˆ°è¯¥è¡Œä»£ç æ»¡è¶³ç‰¹å®šæ¡ä»¶åç¨‹åºæ‰ä¼šä¸­æ–­ã€‚åœ¨æ–­ç‚¹å°çº¢ç‚¹ä¸Šå³é”®é€‰æ‹© â€ç¼–è¾‘æ–­ç‚¹â€œï¼Œå¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ¡ä»¶ï¼š è¡¨è¾¾å¼ï¼šå½“è¡¨è¾¾å¼è®¡ç®—ç»“æœä¸º true æ—¶ä¸­æ–­ï¼Œä¾‹å¦‚è®¾ç½®ï¼šctx.query.name === &#39;nswbmw&#39;ï¼Œè¡¨ç¤ºå½“è®¿é—® localhost:3000?name=nswbmw æ—¶æ–­ç‚¹æ‰ä¼šç”Ÿæ•ˆï¼Œå…¶ä½™è¯·æ±‚æ–­ç‚¹æ— æ•ˆã€‚ å‘½ä¸­æ¬¡æ•°ï¼šåŒæ ·å½“è¡¨è¾¾å¼è®¡ç®—ç»“æœä¸º true æ—¶ä¸­æ–­ï¼Œæ”¯æŒè¿ç®—ç¬¦ &lt;ã€&lt;&#x3D;ã€&#x3D;&#x3D;ã€&gt;ã€&gt;&#x3D;ã€%ã€‚ä¾‹å¦‚ï¼š &gt;10ï¼šæ‰§è¡Œ 10 æ¬¡ä»¥åï¼Œæ–­ç‚¹æ‰ä¼šç”Ÿæ•ˆã€‚ &lt;3ï¼šåªæœ‰å‰ 2 æ¬¡æ–­ç‚¹ä¼šç”Ÿæ•ˆã€‚ 10ï¼šç­‰ä»·äº &gt;&#x3D;10ã€‚ %2ï¼šéš”ä¸€æ¬¡ä¸­æ–­ä¸€æ¬¡ã€‚ æ³¨æ„ï¼šå¯ä»¥ç»„åˆè¡¨è¾¾å¼å’Œå‘½ä¸­æ¬¡æ•°æ¡ä»¶ä¸€èµ·ä½¿ç”¨ã€‚åœ¨åˆ‡æ¢æ¡ä»¶ç±»å‹æ—¶ï¼Œéœ€è¦å°†åŸæ¥çš„æ¡ä»¶æ¸…ç©ºï¼Œå¦åˆ™ä¼šæ·»åŠ ä¸¤ç§æ¡ä»¶ã€‚å°†é¼ æ ‡æ‚¬æµ®åœ¨æ–­ç‚¹ä¸Šï¼Œå¯ä»¥æŸ¥çœ‹è®¾ç½®äº†å“ªäº›æ¡ä»¶ã€‚ 4.3.4 æŠ€å·§ 2â€”â€”skipFilesä»ä¸Šé¢å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ VS Code å·¦ä¾§æœ‰ä¸€ä¸ª â€è°ƒç”¨å †æ ˆâ€œ é¢æ¿ï¼Œæ˜¾ç¤ºäº†å½“å‰æ–­ç‚¹çš„è°ƒç”¨å †æ ˆï¼Œä½†æ— æ³•ç›´è§‚åœ°çœ‹å‡ºå“ªäº›æ˜¯æˆ‘ä»¬é¡¹ç›®çš„ä»£ç ï¼Œå“ªäº›æ˜¯ node_modules é‡Œæ¨¡å—çš„ä»£ç ï¼Œè€Œä¸”åœ¨å•æ­¥è°ƒè¯•æ—¶ä¼šè¿›å…¥åˆ° node_modules é‡Œã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ node_modules é‡Œçš„ä»£ç ï¼Œæˆ‘ä»¬åªå…³å¿ƒé¡¹ç›®æœ¬èº«çš„ä»£ç ã€‚è¿™æ—¶ï¼ŒskipFiles å°±æ´¾ä¸Šç”¨åœºäº†ã€‚ skipFiles é¡¾åæ€ä¹‰å°±æ˜¯å¿½ç•¥æˆ‘ä»¬ä¸å…³å¿ƒçš„æ–‡ä»¶ã€‚ä¿®æ”¹ launch.json å¦‚ä¸‹ï¼š 123456789101112131415&#123; &quot;version&quot;: &quot;0.2.0&quot;, &quot;configurations&quot;: [ &#123; &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;launch&quot;, &quot;name&quot;: &quot;å¯åŠ¨ç¨‹åº&quot;, &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;, &quot;skipFiles&quot;: [ &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;, &quot;&lt;node_internals&gt;/**/*.js&quot; ] &#125; ]&#125; æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦è§£é‡Šï¼š æ”¯æŒ ${xxx} è¿™ç§å˜é‡æ›¿æ¢ã€‚ æ”¯æŒ glob æ¨¡å¼åŒ¹é…ã€‚ ç”¨æ¥å¿½ç•¥ Node.js æ ¸å¿ƒæ¨¡å—ã€‚ é‡å¯è°ƒè¯•åï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šåœ¨å·¦ä¾§ â€è°ƒç”¨å †æ ˆâ€œ ä¸­ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒçš„è°ƒç”¨æ ˆéƒ½å˜ç°äº†ï¼Œè€Œä¸”å•æ­¥è°ƒè¯•ä¹Ÿä¸ä¼šè¿›å…¥åˆ° skipFiles æ‰€åŒ¹é…çš„æ–‡ä»¶é‡Œã€‚ 4.3.5 æŠ€å·§ 3â€”â€”è‡ªåŠ¨é‡å¯åœ¨æ¯æ¬¡ä¿®æ”¹ä»£ç ä¿å­˜åéƒ½è¦æ‰‹åŠ¨é‡å¯ï¼Œå¦åˆ™ä¿®æ”¹åçš„ä»£ç å’Œæ–­ç‚¹éƒ½ä¸ä¼šç”Ÿæ•ˆã€‚VS Code å¼€å‘è€…ä»¬æƒ³åˆ°äº†è¿™ä¸€ç‚¹ï¼Œé€šè¿‡æ·»åŠ é…ç½®å¯ä»¥å®ç°ä¿®æ”¹ä»£ç ä¿å­˜åä¼šè‡ªåŠ¨é‡å¯è°ƒè¯•ï¼Œéœ€è¦ç»“åˆ nodemon ä¸€èµ·ä½¿ç”¨ã€‚ é¦–å…ˆï¼Œå…¨å±€å®‰è£… nodemonï¼š 1$ npm i nodemon -g ç„¶åï¼Œä¿®æ”¹ launch.jsonï¼š 123456789101112131415161718&#123; &quot;version&quot;: &quot;0.2.0&quot;, &quot;configurations&quot;: [ &#123; &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;launch&quot;, &quot;name&quot;: &quot;å¯åŠ¨ç¨‹åº&quot;, &quot;runtimeExecutable&quot;: &quot;nodemon&quot;, &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;, &quot;restart&quot;: true, &quot;console&quot;: &quot;integratedTerminal&quot;, &quot;skipFiles&quot;: [ &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;, &quot;&lt;node_internals&gt;/**/*.js&quot; ] &#125; ]&#125; å½“å‰çš„ launch.json ç›¸æ¯”è¾ƒä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ launch.jsonï¼Œå¤šäº†ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š runtimeExecutableï¼šç”¨ä»€ä¹ˆå‘½ä»¤æ‰§è¡Œ app.jsï¼Œè¿™é‡Œè®¾ç½®ä¸º nodemonã€‚ restartï¼šè®¾ç½®ä¸º trueï¼Œä¿®æ”¹ä»£ç å¹¶ä¿å­˜åä¼šè‡ªåŠ¨é‡å¯è°ƒè¯•ã€‚ consoleï¼šå½“å•å‡»åœæ­¢æŒ‰é’®æˆ–è€…ä¿®æ”¹ä»£ç å¹¶ä¿å­˜åè‡ªåŠ¨é‡å¯è°ƒè¯•ï¼Œè€Œ nodemon æ˜¯ä»ç„¶åœ¨è¿è¡Œçš„ï¼Œé€šè¿‡è®¾ç½®ä¸º console ä¸º integratedTerminal å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ­¤æ—¶ VS Code ç»ˆç«¯å°†ä¼šæ‰“å° nodemon çš„ logï¼Œå¯ä»¥åœ¨ç»ˆç«¯å³ä¾§çš„ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©è¿”å›ç¬¬ 1 ä¸ªç»ˆç«¯ï¼Œç„¶åè¿è¡Œ curl localhost:3000 è¿›è¡Œè°ƒè¯•ã€‚ å¯¹äºå·²ç»ä½¿ç”¨ nodemon è¿è¡Œçš„ç¨‹åºï¼Œä¾‹å¦‚ï¼š 1$ nodemon --inspect app.js å¯ä½¿ç”¨ attach æ¨¡å¼å¯åŠ¨è°ƒè¯•ï¼Œlaunch.json å¦‚ä¸‹ï¼š 123456789101112&#123; &quot;version&quot;: &quot;0.2.0&quot;, &quot;configurations&quot;: [ &#123; &quot;name&quot;: &quot;Attach to node&quot;, &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;attach&quot;, &quot;restart&quot;: true, &quot;processId&quot;: &quot;$&#123;command:PickProcess&#125;&quot; &#125; ]&#125; è¿è¡Œ Attach to node é…ç½®è¿›è¡Œè°ƒè¯•æ—¶ï¼ŒVS Code ä¼šåˆ—å‡ºæ­£åœ¨æ‰§è¡Œçš„ node è¿›ç¨‹åŠå¯¹åº”çš„ PID ä»¥ä¾›é€‰æ‹©ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ address å’Œ port å‚æ•°è®¾ç½® attach åˆ°å…·ä½“çš„è¿›ç¨‹å¼€å¯è°ƒè¯•ã€‚ 4.3.6 æŠ€å·§ 4â€”â€”ç‰¹å®šæ“ä½œç³»ç»Ÿè®¾ç½®é’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œå¯èƒ½ä¼šç”¨åˆ°ä¸åŒçš„è°ƒè¯•é…ç½®ã€‚å¯é€‰çš„å‚æ•°ä¸ºï¼š windows linux osx ç¤ºä¾‹å¦‚ä¸‹ï¼š 123456789101112131415&#123; &quot;version&quot;: &quot;0.2.0&quot;, &quot;configurations&quot;: [ &#123; &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;launch&quot;, &quot;name&quot;: &quot;å¯åŠ¨è°ƒè¯•&quot;, &quot;program&quot;: &quot;./node_modules/gulp/bin/gulpfile.js&quot;, &quot;args&quot;: [&quot;/path/to/app.js&quot;], &quot;windows&quot;: &#123; &quot;args&quot;: [&quot;\\\\path\\\\to\\\\app.js&quot;] &#125; &#125; ]&#125; 4.3.7 æŠ€å·§ 5â€”â€”å¤šé…ç½®configurations æ˜¯ä¸ªæ•°ç»„è€Œä¸æ˜¯ä¸ªå¯¹è±¡ï¼Œè¿™æ ·è®¾è®¡å°±æ˜¯ä¸ºäº†å¯ä»¥æ·»åŠ å¤šä¸ªè°ƒè¯•é…ç½®ã€‚æ‰“å¼€ launch.jsonï¼Œå•å‡»å³ä¸‹è§’çš„ â€æ·»åŠ é…ç½®â€¦â€œï¼Œä¼šå¼¹å‡ºé…ç½®æ¨¡æ¿ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š configurations å¯ä»¥ç”¨æ¥é…ç½®ä¸åŒçš„è°ƒè¯•è§„åˆ™ï¼Œæ¯”å¦‚æœ€ç»ˆå°† launch.json ä¿®æ”¹å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425&#123; &quot;version&quot;: &quot;0.2.0&quot;, &quot;configurations&quot;: [ &#123; &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;attach&quot;, &quot;name&quot;: &quot;Attach to node&quot;, &quot;restart&quot;: true, &quot;processId&quot;: &quot;$&#123;command:PickProcess&#125;&quot; &#125;, &#123; &quot;type&quot;: &quot;node&quot;, &quot;request&quot;: &quot;launch&quot;, &quot;name&quot;: &quot;å¯åŠ¨ç¨‹åº&quot;, &quot;runtimeExecutable&quot;: &quot;nodemon&quot;, &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;, &quot;restart&quot;: true, &quot;console&quot;: &quot;integratedTerminal&quot;, &quot;skipFiles&quot;: [ &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;, &quot;&lt;node_internals&gt;/**/*.js&quot; ] &#125; ]&#125; 4.3.8 æ€»ç»“VS Code çš„è°ƒè¯•åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œæœ¬èŠ‚åªè®²è§£äº†ä¸€äº›å¸¸ç”¨çš„è°ƒè¯•åŠŸèƒ½ï¼Œå¯¹äºå…¶ä½™çš„è°ƒè¯•åŠŸèƒ½ï¼Œè¿˜è¯·è¯»è€…è‡ªè¡Œå°è¯•ã€‚ 4.3.9 å‚è€ƒé“¾æ¥ https://code.visualstudio.com/docs/editor/debugging https://code.visualstudio.com/docs/nodejs/nodejs-debugging","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 4.2 Chrome Devtools","slug":"4.2.1 ä½¿ç”¨ Chrome DevTools","date":"2019-07-22T06:00:00.000Z","updated":"2022-05-25T04:23:06.702Z","comments":true,"path":"2019/07/22/4.2.1 ä½¿ç”¨ Chrome DevTools/","link":"","permalink":"https://marvinliu1.github.io/2019/07/22/4.2.1%20%E4%BD%BF%E7%94%A8%20Chrome%20DevTools/","excerpt":"","text":"Node in Debugging è°ƒè¯•æ˜¯æ¯ä¸ªç¨‹åºå‘˜å¿…å¤‡çš„æŠ€èƒ½ï¼Œå› æ­¤é€‰æ‹©åˆé€‚çš„è°ƒè¯•å·¥å…·èƒ½æå¤§åœ°æ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•ä»£ç ã€‚Node.js çš„è°ƒè¯•æ–¹å¼ä¹Ÿæœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ï¼š ä¸‡èƒ½çš„ console.log debugger node-inspector ä»¥ä¸Šæœ¬èŠ‚éƒ½ä¸ä¼šè®²è§£ï¼Œå› ä¸ºï¼š console.log å°±ä¸ç”¨è¯´äº†ã€‚ debugger ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºï¼š ä½¿ç”¨ç¹çï¼Œéœ€æ‰‹åŠ¨æ‰“ç‚¹ã€‚ è‹¥å¿˜è®°åˆ é™¤ debuggerï¼Œè¿˜ä¼šå¼•èµ·æ€§èƒ½é—®é¢˜ã€‚ node-inspector å·²ç»é€€å‡ºå†å²èˆå°ã€‚&#x6e;&#x6f;&#100;&#x65;&#64;&#54;&#46;&#51; ä»¥åå†…ç½®äº†ä¸€ä¸ªè°ƒè¯•å™¨ï¼Œå¯ä»¥ç»“åˆ Chrome DevTools ä½¿ç”¨ï¼Œè€Œä¸”æ¯” node-inspector æ›´å¼ºå¤§ã€‚ ä¸‹é¢å°±è®²è®² Chrome DevTools çš„ç”¨æ³•ã€‚ 4.2.1 ä½¿ç”¨ Chrome DevToolsåˆ›å»ºç¤ºä¾‹ä»£ç ï¼š app.js 12345678const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.use(ctx =&gt; &#123; ctx.body = &#x27;hello world!&#x27;&#125;)app.listen(3000) è¿è¡Œï¼š 1$ node --inspect app.js æ³¨æ„ï¼šå¦‚æœæƒ³è®©ä»£ç åœ¨ç¬¬ 1 è¡Œå°±æš‚åœæ‰§è¡Œï¼Œéœ€è¦ä½¿ç”¨ â€“inspect-brk å‚æ•°å¯åŠ¨ï¼Œå³ node --inspect-brk app.jsã€‚ æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè®¿é—® chrome:&#x2F;&#x2F;inspectï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å•å‡» Remote Target ä¸‹çš„ inspectï¼Œé€‰æ‹© Sourcesï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ä½¿ç”¨æ–¹å¼ä¸ node-inspector ç±»ä¼¼ï¼Œå¯ä»¥æ·»åŠ æ–­ç‚¹ï¼Œç„¶ååœ¨ Console é‡Œé¢ç›´æ¥è¾“å…¥å˜é‡åæ¥æ‰“å°è¯¥å˜é‡çš„å€¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨ç¬¬ 6 è¡Œæ·»åŠ æ–­ç‚¹ï¼Œç„¶åé€šè¿‡ curl localhost:3000?name=nswbmwï¼Œä»£ç æ‰§è¡Œåˆ°ç¬¬ 6 è¡Œæš‚åœæ‰§è¡Œï¼Œåœ¨ Console é‡Œæ‰“å° ctx.query çš„å€¼ï¼š å°æç¤ºï¼šå°†é¼ æ ‡æ‚¬æµ®åœ¨æŸä¸ªå˜é‡ä¸Šï¼Œä¹Ÿä¼šæ˜¾ç¤ºå®ƒçš„å€¼ï¼Œä¾‹å¦‚ï¼šctxã€‚ å±•å¼€å³ä¾§çš„ debugger æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚å•æ­¥æ‰§è¡Œã€å•æ­¥è¿›å…¥ã€å•æ­¥é€€å‡ºç­‰ç­‰ï¼Œè¿™é‡Œä¸å†è¯¦ç»†è®²è§£ã€‚ 4.2.2 NIMæ¯æ¬¡è°ƒè¯• Node.js éƒ½è¦æ‰“å¼€éšè—é‚£ä¹ˆæ·±çš„å…¥å£æ˜¯ä¸æ˜¯å¾ˆçƒ¦ï¼Ÿè¿˜å¥½æˆ‘ä»¬æœ‰ NIMã€‚NIMï¼ˆNode Inspector Managerï¼‰æ˜¯ä¸€ä¸ª Chrome æ’ä»¶ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«æ·åœ°æ‰“å¼€ DevToolsï¼Œä¹Ÿå¯ä»¥è®¾ç½®è‡ªåŠ¨å‘ç°å¹¶æ‰“å¼€ DevToolsã€‚ 4.2.3 inspect-processå¦‚æœä½ è§‰å¾— NIM ç”¨èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œé‚£ä½ å¯èƒ½éœ€è¦ inspect-processã€‚ å…¨å±€å®‰è£…ï¼š 1$ npm i inspect-process -g ä½¿ç”¨ï¼š 1$ inspect app.js inspect-process ä¼šè‡ªåŠ¨è°ƒèµ· Chrome DevToolsï¼Œç„¶åå®šä½åˆ° app.jsï¼Œå…¶ä½™ç”¨æ³•ä¸ Chrome DevTools ä¸€è‡´ã€‚ 4.2.4 process._debugProcesså¦‚æœä¸€ä¸ª Node.js è¿›ç¨‹å·²ç»å¯åŠ¨ï¼Œæ²¡æœ‰æ·»åŠ  â€“inspect å‚æ•°ï¼Œæˆ‘ä»¬ä¸æƒ³é‡å¯ï¼ˆä¼šä¸¢å¤±ç°åœºï¼‰åˆæƒ³è°ƒè¯•æ€ä¹ˆåŠï¼Ÿè¿™æ—¶å¯ä»¥ç”¨ process._debugProcessã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š é€šè¿‡ ps å‘½ä»¤æˆ–è€… pgrep -n node æŸ¥çœ‹å½“å‰å¯åŠ¨çš„ Node.js è¿›ç¨‹çš„ pidï¼Œä¾‹å¦‚ï¼š53911ã€‚ æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œè¿è¡Œï¼šnode -e &quot;process._debugProcess(53911)&quot;ï¼ŒåŸæ¥çš„ Node.js è¿›ç¨‹ä¼šæ‰“å°å‡ºï¼šDebugger listening on ws:&#x2F;&#x2F;127.0.0.1:9229&#x2F;2331fa07-32af-45eb-a1a8-bead7a0ab905ã€‚ è°ƒå‡º Chrome DevTools è¿›è¡Œè°ƒè¯•ã€‚ 4.2.5 å‚è€ƒé“¾æ¥ https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Nohup stop running unexpected - solved","slug":"Nohup-exit","date":"2019-07-21T06:00:00.000Z","updated":"2022-05-25T05:05:54.636Z","comments":true,"path":"2019/07/21/Nohup-exit/","link":"","permalink":"https://marvinliu1.github.io/2019/07/21/Nohup-exit/","excerpt":"","text":"Today I have encounterd a weird issue with Nohup, my sh command is used as: 1nohup npm start 2&gt;/dev/null 1&gt;/dev/null&amp; But after I have closed the connection of my Putty, the npm thread was terminated. Finally, I have found the problem is with the session, to disconnect the Putty, I have to tpye in command exit, instead of closing the window directly, the exit command will leave the session running in background.","categories":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/categories/Hexo/"},{"name":"Linux","slug":"Hexo/Linux","permalink":"https://marvinliu1.github.io/categories/Hexo/Linux/"}],"tags":[{"name":"Nohup","slug":"Nohup","permalink":"https://marvinliu1.github.io/tags/Nohup/"},{"name":"Linux","slug":"Linux","permalink":"https://marvinliu1.github.io/tags/Linux/"}]},{"title":"Node in Debugging, 4.1 Source Map","slug":"4.1.1 ä»€ä¹ˆæ˜¯ Source Mapï¼Ÿ","date":"2019-07-18T06:00:00.000Z","updated":"2022-05-25T04:23:06.703Z","comments":true,"path":"2019/07/18/4.1.1 ä»€ä¹ˆæ˜¯ Source Mapï¼Ÿ/","link":"","permalink":"https://marvinliu1.github.io/2019/07/18/4.1.1%20%E4%BB%80%E4%B9%88%E6%98%AF%20Source%20Map%EF%BC%9F/","excerpt":"","text":"Node in Debugging 4.1.1 ä»€ä¹ˆæ˜¯ Source Mapï¼Ÿå¯¹äº Source Mapï¼Œæƒ³å¿…å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œåœ¨å‰ç«¯å¼€å‘ä¸­é€šå¸¸è¦å‹ç¼© JavaScriptï¼ŒCSSï¼Œä»¥å‡å°ä½“ç§¯ï¼ŒåŠ å¿«ç½‘é¡µæ˜¾ç¤ºã€‚ä½†å¸¦æ¥çš„åæœæ˜¯å¦‚æœå‡ºç°é”™è¯¯ï¼Œå°±ä¼šå¯¼è‡´æ— æ³•å®šä½é”™è¯¯ï¼Œè¿™æ—¶ Source Map åº”è¿è€Œç”Ÿã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ jQuery 1.9 å¼•å…¥äº† Source Mapï¼Œæ‰“å¼€ http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.jsï¼Œæœ€åä¸€è¡Œæ˜¯è¿™æ ·çš„ï¼š 1//@ sourceMappingURL=jquery.min.map è¿™å°±æ˜¯ Source Mapã€‚å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ mapï¼ˆå…¶å®å°±æ˜¯ JSONï¼‰ æ–‡ä»¶ï¼Œé€šå¸¸ä¸æºç åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚ Source Map å¸¸ç”¨äºä»¥ä¸‹å‡ ä¸ªåœºæ™¯ï¼š å‹ç¼©ä»£ç ï¼Œå‡å°ä½“ç§¯ã€‚æ¯”å¦‚ jQuery 1.9 çš„æºç ï¼Œå‹ç¼©å‰æ˜¯ 252KBï¼Œå‹ç¼©åæ˜¯ 32KBã€‚ å¤šä¸ªæ–‡ä»¶åˆå¹¶ï¼Œå‡å°‘ HTTP è¯·æ±‚æ•°ï¼Œä»…ç”¨äºå‰ç«¯ã€‚ å°†å…¶ä»–è¯­è¨€ç¼–è¯‘æˆ JavaScriptï¼Œä¾‹å¦‚ï¼šCoffeeScriptã€TypeScript ç­‰ã€‚ æœ¬èŠ‚åªè®²è§£å¦‚ä½•ä½¿ç”¨ Source Mapï¼Œå…³äº map æ–‡ä»¶ä¸­å­—æ®µçš„å«ä¹‰æœ¬èŠ‚ä¸ä¼šè§£é‡Šï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æŸ¥çœ‹å‚è€ƒé“¾æ¥ä¸­çš„æ–‡ç« ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ Node.js ç¯å¢ƒä¸‹ä»¥åœºæ™¯ 1ã€3 ä¸ºä¾‹ï¼Œåˆ†åˆ«ä»‹ç»å¦‚ä½•å°† uglify-es å’Œ TypeScript ç»“åˆ Source Map ä½¿ç”¨ã€‚ 4.1.2 uglify-esuglify-js æ˜¯æœ€å¸¸ç”¨çš„ JavaScript ä»£ç å‹ç¼©å·¥å…·ï¼Œä½†åªæ”¯æŒåˆ° ES5ï¼Œuglify-es æ”¯æŒ ES6+ å¹¶ä¸”å…¼å®¹ uglify-jsï¼Œæ‰€ä»¥æœ¬èŠ‚ä½¿ç”¨ uglify-esã€‚ source-map-support æ˜¯ä¸€ä¸ªåœ¨ Node.js ç¯å¢ƒä¸‹æ”¯æŒ Source Map çš„æ¨¡å—ã€‚ å®‰è£… uglify-es å’Œ source-map-supportï¼š 12$ npm i uglify-es -g$ npm i source-map-support åˆ›å»ºæµ‹è¯•ä»£ç ï¼š app.js 12345678require(&#x27;source-map-support&#x27;).install()function sayHello (name) &#123; throw new Error(&#x27;error!!!&#x27;) console.log(`Hello, $&#123;name&#125;`)&#125;sayHello(&#x27;World&#x27;) ä½¿ç”¨ uglify-es å‹ç¼©ä»£ç æ–‡ä»¶å¹¶ç”Ÿæˆ map æ–‡ä»¶ï¼š 1$ uglifyjs app.js -o app.min.js --source-map &quot;url=app.min.js.map&quot; ç”Ÿæˆ app.min.js å’Œ app.min.js.map æ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹ï¼š app.min.js 12require(&quot;source-map-support&quot;).install();function sayHello(name)&#123;throw new Error(&quot;error!!!&quot;);console.log(`Hello, $&#123;name&#125;`)&#125;sayHello(&quot;World&quot;);//# sourceMappingURL=app.min.js.map app.min.js.map 1&#123;&quot;version&quot;:3,&quot;sources&quot;:[&quot;app.js&quot;],&quot;names&quot;:[&quot;require&quot;,&quot;install&quot;,&quot;sayHello&quot;,&quot;name&quot;,&quot;Error&quot;,&quot;console&quot;,&quot;log&quot;],&quot;mappings&quot;:&quot;AAAAA,QAAQ,sBAAsBC,UAE9B,SAASC,SAAUC,MACjB,MAAM,IAAIC,MAAM,YAChBC,QAAQC,cAAcH,QAGxBD,SAAS&quot;&#125; æ­¤æ—¶è¿è¡Œ app.min.js å¯ä»¥æ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æ ˆï¼š 1234567$ node app.min.js/Users/nswbmw/Desktop/test/app.js:4 throw new Error(&#x27;error!!!&#x27;) ^Error: error!!! at sayHello (/Users/nswbmw/Desktop/test/app.js:4:9) å¦‚æœåˆ é™¤ app.min.js æœ€åé‚£è¡Œæ³¨é‡Šï¼Œé‡æ–°è¿è¡Œåˆ™æ— æ³•æ˜¾ç¤ºæ­£ç¡®çš„é”™è¯¯æ ˆï¼š 1234567$ node app.min.js/Users/nswbmw/Desktop/test/app.min.js:1require(&quot;source-map-support&quot;).install();function sayHello(name)&#123;throw new Error(&quot;error!!!&quot;);console.log(`Hello, $&#123;name&#125;`)&#125;sayHello(&quot;World&quot;); ^Error: error!!! at sayHello (/Users/nswbmw/Desktop/test/app.min.js:1:71) source-map-support æ˜¯é€šè¿‡ Error.prepareStackTrace å®ç°çš„ï¼Œå‰é¢è®²è§£è¿‡å®ƒçš„ç”¨æ³•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ 4.1.3 TypeScriptå…¨å±€å®‰è£… TypeScriptï¼š 1$ npm i typescript -g åˆ›å»ºæµ‹è¯•ä»£ç ï¼š app_ts.ts 12345678declare function require(name: string)require(&#x27;source-map-support&#x27;).install()function sayHello (name: string): any &#123; throw new Error(&#x27;error!!!&#x27;)&#125;sayHello(&#x27;World&#x27;) è¿è¡Œï¼š 1$ tsc --sourceMap app_ts.ts ç”Ÿæˆ app_ts.js å’Œ app_ts.js.mapï¼Œè¿è¡Œ app_ts.js å¦‚ä¸‹ï¼š 1234567$ node app_ts.js/Users/nswbmw/Desktop/test/app_ts.ts:5 throw new Error(&#x27;error!!!&#x27;) ^Error: error!!! at sayHello (/Users/nswbmw/Desktop/test/app_ts.ts:5:9) 4.1.4 source-map-support é«˜çº§ç”¨æ³•æˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨ install æ–¹æ³•æ—¶ä¼ å…¥ä¸€ä¸ª retrieveSourceMap å‚æ•°ï¼Œç”¨æ¥è‡ªå®šä¹‰å¤„ç† Source Mapï¼š 1234567891011require(&#x27;source-map-support&#x27;).install(&#123; retrieveSourceMap: function(source) &#123; if (source === &#x27;compiled.js&#x27;) &#123; return &#123; url: &#x27;original.js&#x27;, map: fs.readFileSync(&#x27;compiled.js.map&#x27;, &#x27;utf8&#x27;) &#125; &#125; return null &#125;&#125;) æ¯”å¦‚å°†æ‰€æœ‰ map æ–‡ä»¶ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯ç£ç›˜ä¸Šã€‚ 4.1.5 å‚è€ƒé“¾æ¥ http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html https://yq.aliyun.com/articles/73529 https://github.com/v8/v8/wiki/Stack-Trace-API https://github.com/evanw/node-source-map-support","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Adding Tag-Cloud","slug":"Adding-tag-cloud","date":"2019-06-21T06:26:30.000Z","updated":"2022-05-25T04:33:16.035Z","comments":true,"path":"2019/06/21/Adding-tag-cloud/","link":"","permalink":"https://marvinliu1.github.io/2019/06/21/Adding-tag-cloud/","excerpt":"","text":"Step 1: Install the plugin hexo-tag-cloud1npm install hexo-tag-cloud@^2.0.* --save Step 2: ConfigurationFor the SwigLocate the file bash theme/next/layout/_macro/sidebar.swig 123456789101112&#123;% if site.tags.length &gt; 1 %&#125;&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot; src=&quot;/js/tagcloud.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot; src=&quot;/js/tagcanvas.js&quot;&gt;&lt;/script&gt;&lt;div class=&quot;widget-wrap&quot;&gt; &lt;h3 class=&quot;widget-title&quot;&gt;æ ‡ç­¾äº‘&lt;/h3&gt; &lt;div id=&quot;myCanvasContainer&quot; class=&quot;widget tagcloud&quot;&gt; &lt;canvas width=&quot;250&quot; height=&quot;250&quot; id=&quot;resCanvas&quot; style=&quot;width=100%&quot;&gt; &#123;&#123; list_tags() &#125;&#125; &lt;/canvas&gt; &lt;/div&gt;&lt;/div&gt;&#123;% endif %&#125; For the ejsLocated the file bash hexo/themes/landscape/layout/_widget/tagcloud.ejs 12345678910111213&lt;% if (site.tags.length) &#123; %&gt; &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot; src=&quot;/js/tagcloud.js&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot; src=&quot;/js/tagcanvas.js&quot;&gt;&lt;/script&gt; &lt;div class=&quot;widget-wrap&quot;&gt; &lt;h3 class=&quot;widget-title&quot;&gt;Tag Cloud&lt;/h3&gt; &lt;div id=&quot;myCanvasContainer&quot; class=&quot;widget tagcloud&quot;&gt; &lt;canvas width=&quot;250&quot; height=&quot;250&quot; id=&quot;resCanvas&quot; style=&quot;width=100%&quot;&gt; &lt;%- tagcloud() %&gt; &lt;/canvas&gt; &lt;/div&gt; &lt;/div&gt;&lt;% &#125; %&gt; For the jadeLocate the file bash apollo/layout/archive.jade 123456789101112block container include mixins/post .archive h2(class=&#x27;archive-year&#x27;)= &#x27;Tag Cloud&#x27; script(type=&#x27;text/javascript&#x27;, charset=&#x27;utf-8&#x27;, src=&#x27;/oj-code/js/tagcloud.js&#x27;) script(type=&#x27;text/javascript&#x27;, charset=&#x27;utf-8&#x27;, src=&#x27;/oj-code/js/tagcanvas.js&#x27;) #myCanvasContainer.widget.tagcloud(align=&#x27;center&#x27;) canvas#resCanvas(width=&#x27;500&#x27;, height=&#x27;500&#x27;, style=&#x27;width=100%&#x27;) !=tagcloud() !=tagcloud() +postList() Step 3: Config the themeLocate the config file in your theme folder bash _config.yml Adding new lines below in the end of the config file 1234567# hexo-tag-cloudtag_cloud: textFont: Trebuchet MS, Helvetica textColor: &#x27;#333&#x27; textHeight: 25 outlineColor: &#x27;#E2E1D1&#x27; maxSpeed: 0.1","categories":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/categories/Hexo/"}],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/tags/Hexo/"},{"name":"NeXt","slug":"NeXt","permalink":"https://marvinliu1.github.io/tags/NeXt/"}]},{"title":"Node in Debugging, 3.7 UncaughtException","slug":"3.7.1 uncaughtException","date":"2019-06-20T06:00:00.000Z","updated":"2022-05-25T04:23:06.703Z","comments":true,"path":"2019/06/20/3.7.1 uncaughtException/","link":"","permalink":"https://marvinliu1.github.io/2019/06/20/3.7.1%20uncaughtException/","excerpt":"","text":"Node in Debugging ç›¸ä¿¡æ‰€æœ‰ Node.js å¼€å‘è€…éƒ½å¯¹ TypeError: Cannot read property &#39;xxx&#39; of undefined/null è¿™ç§é”™è¯¯å¹¶ä¸é™Œç”Ÿï¼Œè¿™æ˜¯å› ä¸ºæœŸæœ›ä»ä¸€ä¸ªå¯¹è±¡ä¸Šè·å– xxx å±æ€§ï¼Œç»“æœè¿™ä¸ªå¯¹è±¡çš„å€¼æ˜¯ undefined æˆ–è€… nullã€‚ 3.7.1 uncaughtExceptionçœ‹ä¸€æ®µä»£ç ï¼š 1234const article = &#123; title: &#x27;Node.js&#x27;, content: &#x27;Hello, Node.js&#x27; &#125;setImmediate(() =&gt; &#123; console.log(article.author.name)&#125;) è¿è¡Œä»¥ä¸Šä»£ç æ‰“å°å‡ºï¼š 12345678/Users/nswbmw/Desktop/test/app.js:3 console.log(article.author.name) ^TypeError: Cannot read property &#x27;name&#x27; of undefined at Timeout.setInterval [as _onTimeout] (/Users/nswbmw/Desktop/test/app.js:3:30) at ontimeout (timers.js:475:11) at tryOnTimeout (timers.js:310:5) at Timer.listOnTimeout (timers.js:270:5) article æ˜¯ä¸€ä¸ªæ–‡ç« å¯¹è±¡æœ‰ title å’Œ content å±æ€§ï¼Œæ²¡æœ‰ author å±æ€§ï¼Œæ‰€ä»¥ article.author æ˜¯ undefinedï¼Œè°ƒç”¨ article.author.name ä¼šæŠ¥é”™ã€‚è€Œä¸”è¿™ä¸ªè¿è¡Œæ—¶é”™è¯¯æ˜¯åœ¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼ˆsetImmediateï¼‰å†…æŠ›å‡ºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªé”™è¯¯æ˜¯ä¸€ä¸ª â€œuncaught exceptionâ€ï¼Œå¦‚æœæ²¡æœ‰ process.on(â€˜uncaughtExceptionâ€™, () &#x3D;&gt; {}) äº‹ä»¶ç›‘å¬å™¨çš„è¯ç¨‹åºä¼š crashã€‚ è°ƒè¯•è¿™ç§é”™è¯¯æ²¡æœ‰æ¯”è¾ƒå¥½çš„æ–¹æ³•ï¼Œé€šå¸¸åªèƒ½æ·»åŠ  console.log æ‰“å°å‡º article çš„å€¼ã€‚ä½†æ˜¯æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡ llnode çš„ç”¨æ³•ï¼Œæ˜¯å¦å¯ä»¥ä½¿ç”¨ llnode è°ƒè¯•è¿™ç±»é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ 3.7.2 llnodeæˆ‘ä»¬æ·»åŠ  â€“abort-on-uncaught-exception å‚æ•°é‡æ–°è¿è¡Œç¨‹åºï¼Œå½“ç¨‹åº crash çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ Core Dumpã€‚ 12345678910$ ulimit -c unlimited$ node --abort-on-uncaught-exception app.jsUncaught TypeError: Cannot read property &#x27;name&#x27; of undefinedFROMImmediate.setImmediate (/home/nswbmw/test/app.js:1:1)runCallback (timers.js:1:1)tryOnImmediate (timers.js:1:1)processImmediate [as _immediateCallback] (timers.js:1:1)Illegal instruction (core dumped) æ­¤æ—¶ç”Ÿæˆä¸€ä¸ª core æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ llnode åŠ è½½å¹¶è¯Šæ–­è¿™ä¸ª core æ–‡ä»¶ã€‚ 1234$ lldb-4.0 -c ./core(lldb) target create --core &quot;./core&quot;Core file &#x27;/home/nswbmw/test/./core&#x27; (x86_64) was loaded.(lldb) ä½¿ç”¨ v8 bt æŸ¥çœ‹æœ€è¿‘çš„ backtraceã€‚ 12345678910(lldb) v8 bt * thread #1: tid = 4750, 0x00007ffd905d5b39 node`v8::base::OS::Abort() + 9, name = &#x27;node&#x27;, stop reason = signal SIGILL * frame #0: 0x00007ffd905d5b39 node`v8::base::OS::Abort() + 9 frame #1: 0x00007ffd900a4d19 node`v8::internal::Isolate::Throw(v8::internal::Object*, v8::internal::MessageLocation*) + 489 frame #2: 0x00007ffd9005e7f9 node`v8::internal::LoadIC::Load(v8::internal::Handle&lt;v8::internal::Object&gt;, v8::internal::Handle&lt;v8::internal::Name&gt;) + 569 frame #3: 0x00007ffd9005f759 node`v8::internal::Runtime_LoadIC_Miss(int, v8::internal::Object**, v8::internal::Isolate*) + 633 frame #4: 0x000018e6e710463d &lt;exit&gt; frame #5: 0x000018e6e71ecce4 &lt;stub&gt; frame #6: 0x000018e6e71bf9ce setImmediate(this=0x0000154a3ae09429:&lt;Object: Immediate&gt;) at /home/nswbmw/test/app.js:2:14 fn=0x0000154a3ae09281 ... å¯ä»¥çœ‹å‡ºï¼šåœ¨ frame #4 å¤„ç¨‹åºè§¦å‘ exitï¼Œå¾€ä¸Šè¿½æº¯åˆ° frame #6 æœ‰ä¸€ä¸ª setImmediate æŠ›å‡ºäº†é”™è¯¯ï¼Œåœ¨ app.js ç¬¬ 2 è¡Œï¼Œç¬¦åˆæ‰“å°å‡ºçš„é”™è¯¯ä¿¡æ¯ã€‚setImmediate çš„å›è°ƒå‡½æ•°çš„åœ°å€ä¸º 0x0000154a3ae09281ï¼Œæˆ‘ä»¬ä½¿ç”¨ v8 i æ£€ç´¢è¿™ä¸ªå‡½æ•°ã€‚ 12345678910(lldb) v8 i 0x0000154a3ae092810x0000154a3ae09281:&lt;function: setImmediate at /home/nswbmw/test/app.js:2:14 context=0x0000154a3ae09199&#123; (previous)=0x000017849b703d89 (closure)=0x0000154a3ae08d81 &#123;&lt;function: (anonymous) at /home/nswbmw/test/app.js:1:10&gt;&#125;, article=0x0000154a3ae091d1:&lt;Object: Object&gt;&#125;&gt;(lldb) v8 i 0x0000154a3ae091d10x0000154a3ae091d1:&lt;Object: Object properties &#123; .title=0x000014117e04c9e9:&lt;String: &quot;Node.js&quot;&gt;, .content=0x000014117e04ca09:&lt;String: &quot;Hello, Node.js&quot;&gt;&#125;&gt; setImmediate å‡½æ•°å†…æœ‰ä¸€ä¸ª article å¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­é€šè¿‡ v8 i æ£€ç´¢å¾—çŸ¥ article çš„å€¼ä¸º { title: â€œNode.jsâ€, content: â€œHello, Node.jsâ€ }ï¼Œå¹¶æ²¡æœ‰ author å±æ€§ï¼ŒçœŸç›¸å¤§ç™½ã€‚ 3.7.3 ReDoSDoSï¼ˆDenial of Serviceï¼‰å…¨ç§°æ˜¯æ‹’ç»æœåŠ¡æ”»å‡»ï¼ŒReDoSï¼ˆRegExp Denial of Serviceï¼‰å³æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‹’ç»æœåŠ¡æ”»å‡»ã€‚ReDoS æ˜¯ç”±äºæ­£åˆ™è¡¨è¾¾å¼å†™å¾—æœ‰ç¼ºé™·ï¼Œæ‰€ä»¥ä½¿ç”¨æ­£åˆ™åŒ¹é…æ—¶ï¼Œä¼šå‡ºç°å¤§é‡å ç”¨ CPU çš„æƒ…å†µï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œè€Œå¯¼è‡´æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… â€œå¡ä½â€ çš„åŸå› æ­£æ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„ â€œå›æº¯â€ ç‰¹æ€§ã€‚ çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š 1/a.*b/g.test(&#x27;aaaf&#x27;) åŒ¹é…è¿‡ç¨‹å¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºï¼šå› ä¸º * æ˜¯è´ªå©ªåŒ¹é…ï¼Œæ‰€ä»¥ç¬¬ 3 æ­¥ .* åŒ¹é…äº†å­—ç¬¦ä¸²æœ«å°¾ï¼Œç”±äºå‰©ä¸‹ä¸€ä¸ª b æ— æ³•åŒ¹é…æ‰€ä»¥ â€œåâ€ å‡ºä¸€ä¸ªå­—ç¬¦å†å°è¯•åŒ¹é…ï¼ˆç¬¬ 4 æ­¥ï¼‰ï¼Œä»ç„¶ä¸åŒ¹é…ï¼ˆç¬¬ 5 æ­¥ï¼‰ï¼Œç»§ç»­ â€œåâ€ å‡ºä¸€ä¸ªå­—ç¬¦â€¦è¿™ä¸ª â€œåâ€ ä¸€ä¸ªå­—ç¬¦çš„è¿‡ç¨‹å°±æ˜¯å›æº¯ï¼ˆbacktrackï¼‰ã€‚ å†çœ‹ä¸ªä¾‹å­ï¼š 1234567const reg = /(a*)+b/console.time(&#x27;reg&#x27;)reg.test(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaf&#x27;) // reg: 2572.022ms// reg.test(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaf&#x27;) // reg: 5048.735ms// reg.test(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaf&#x27;) // reg: 10710.070msconsole.timeEnd(&#x27;reg&#x27;) è¿è¡Œä»¥ä¸Šä»£ç ï¼Œæ¯æ·»åŠ ä¸€ä¸ªå­—æ¯ aï¼Œç¨‹åºçš„è¿è¡Œæ—¶é—´å°±ç¿»å€ï¼Œè¿™æ­£æ˜¯ç”±äºæ­£åˆ™è¡¨è¾¾å¼çš„å›æº¯å¯¼è‡´çš„ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ—¶é—´å¤æ‚åº¦ä¸º O(2^n)ã€‚ å¹³æ—¶å†™å‡ºå…·æœ‰å›æº¯çš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œè¿™ä¸ªæ—¶å€™ç¨‹åºä¼š â€œå¡ä½â€ï¼Œä½¿ç”¨ llnode ä¹Ÿå¯ä»¥è°ƒè¯•è¿™ç±»é—®é¢˜ã€‚ è¿è¡Œä»¥ä¸‹ä»£ç ï¼š 123$ echo &quot;/(a*)+b/.test(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaf&#x27;)&quot; &gt; app.js$ node --abort-on-uncaught-exception app.js &amp;$ kill -BUS `pgrep -n node` ç”Ÿæˆ core æ–‡ä»¶ï¼Œä½¿ç”¨ llnode è°ƒè¯•ã€‚ 123456789101112$ lldb-4.0 -c ./core(lldb) target create --core &quot;./core&quot;Core file &#x27;/home/nswbmw/test/./core&#x27; (x86_64) was loaded.(lldb) v8 bt * thread #1: tid = 5381, 0x000036a6db804f6b, name = &#x27;node&#x27;, stop reason = signal SIGBUS * frame #0: 0x000036a6db804f6b &lt;builtin&gt; ... frame #6: 0x000036a6db68463d &lt;exit&gt; frame #7: 0x000036a6db7135f4 test(this=0x0000038344709119:&lt;JSRegExp source=/(a*)+b/&gt;, 0x0000098ccdb4c9e9:&lt;String: &quot;aaaaaaaaaaaaaaaa...&quot;&gt;) at (no script) fn=0x0000183ca0c134a1 ...(lldb) v8 i -F 0x0000098ccdb4c9e90x0000098ccdb4c9e9:&lt;String: &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaf&quot;&gt; å¯ä»¥çœ‹å‡ºï¼šåœ¨ç¨‹åºé€€å‡ºå‰ï¼Œç¨‹åºåœ¨æ‰§è¡Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼ˆ/(a*)+b/ï¼‰çš„ test æ–¹æ³•ï¼Œå‚æ•°æ˜¯å­—ç¬¦ä¸²(aaaaaaaaaaaaaaaaaaaaaaaaaaaaaf)ã€‚ å‡å°‘æ­£åˆ™è¡¨è¾¾å¼å›æº¯çš„ç®€å•æ–¹æ³•å°±æ˜¯åˆå¹¶ä¸å¿…è¦çš„é‡è¯ï¼Œå¦‚å°†ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼ /(a*)+b/ ä¿®æ”¹ä¸º /a*b/ã€‚ 3.7.4 å‚è€ƒé“¾æ¥ https://www.rawidn.com/posts/ddos-and-ddos-in-regular-expression.html","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 3.6 What is event loop?","slug":"3.6.1 ä»€ä¹ˆæ˜¯ Event Loopï¼Ÿ","date":"2019-05-28T06:00:00.000Z","updated":"2022-05-25T04:23:06.983Z","comments":true,"path":"2019/05/28/3.6.1 ä»€ä¹ˆæ˜¯ Event Loopï¼Ÿ/","link":"","permalink":"https://marvinliu1.github.io/2019/05/28/3.6.1%20%E4%BB%80%E4%B9%88%E6%98%AF%20Event%20Loop%EF%BC%9F/","excerpt":"","text":"Node in Debugging äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰æ˜¯ Node.js æœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼Œæ‰€ä»¥ç†è§£ Event Loop å¦‚ä½•è¿ä½œå¯¹äºå†™å‡ºæ­£ç¡®çš„ä»£ç å’Œè°ƒè¯•æ˜¯éå¸¸é‡è¦çš„ã€‚æ¯”å¦‚è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š 1234setTimeout(() =&gt; &#123; console.log(&#x27;hi&#x27;)&#125;, 1000)... æˆ‘ä»¬æœŸæœ›ç¨‹åºè¿è¡Œ 1s åæ‰“å°å‡º hiï¼Œä½†æ˜¯å®é™…æƒ…å†µå¯èƒ½æ˜¯è¿œå¤§äº 1s åæ‰æ‰“å°å‡º hiã€‚è¿™ä¸ªæ—¶å€™å¦‚æœç†è§£ Event Loop å°±å¯ä»¥è½»æ˜“å‘ç°é—®é¢˜ï¼Œå¦åˆ™ä»»å‡­æ€ä¹ˆè°ƒè¯•éƒ½æ˜¯å‘ç°ä¸äº†é—®é¢˜çš„ã€‚ 3.6.1 ä»€ä¹ˆæ˜¯ Event Loopï¼ŸEvent Loop å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆï¼ˆExecution Context Stackï¼‰ã€‚ ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª â€œä»»åŠ¡é˜Ÿåˆ—â€ï¼ˆTask Queueï¼‰ã€‚ç³»ç»ŸæŠŠå¼‚æ­¥ä»»åŠ¡æ”¾åˆ° â€œä»»åŠ¡é˜Ÿåˆ—â€ ä¹‹ä¸­ï¼Œç„¶åä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œåç»­çš„ä»»åŠ¡ã€‚ ä¸€æ—¦ â€œæ‰§è¡Œæ ˆâ€ ä¸­çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿå°±ä¼šè¯»å– â€œä»»åŠ¡é˜Ÿåˆ—â€ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™ï¼Œå¼‚æ­¥ä»»åŠ¡å·²ç»ç»“æŸäº†ç­‰å¾…çŠ¶æ€ï¼Œå°±ä¼šä» â€œä»»åŠ¡é˜Ÿåˆ—â€ è¿›å…¥æ‰§è¡Œæ ˆï¼Œæ¢å¤æ‰§è¡Œã€‚ ä¸»çº¿ç¨‹ä¸æ–­é‡å¤ä¸Šé¢çš„ç¬¬ä¸‰æ­¥ã€‚ å°æç¤ºï¼šæˆ‘ä»¬å¸¸è¯´ Node.js æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†ä¸ºä½•èƒ½è¾¾åˆ°é«˜å¹¶å‘å‘¢ï¼ŸåŸå› å°±åœ¨äºåº•å±‚çš„ Libuv ç»´æŠ¤ä¸€ä¸ª I&#x2F;O çº¿ç¨‹æ± ï¼ˆå³ä¸Šè¿°çš„ â€œä»»åŠ¡é˜Ÿåˆ—â€ï¼‰ï¼Œç»“åˆ Node.js å¼‚æ­¥ I&#x2F;O çš„ç‰¹æ€§ï¼Œå•çº¿ç¨‹ä¹Ÿèƒ½è¾¾åˆ°é«˜å¹¶å‘å•¦ã€‚ ä¸Šé¢æåˆ°äº† â€œè¯»å–ä»»åŠ¡é˜Ÿåˆ—â€ï¼Œè¿™æ ·è®²æœ‰ç‚¹ç¬¼ç»Ÿï¼Œå…¶å® Event Loop çš„ â€œè¯»å–ä»»åŠ¡é˜Ÿåˆ—â€ æœ‰ 6 ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€&gt;â”‚ timers â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚ I/O callbacks â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚ idle, prepare â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ incoming: â”‚â”‚ â”‚ poll â”‚&lt;â”€â”€â”€â”€â”€â”¤ connections, â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ data, etc. â”‚â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚ check â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â””â”€â”€â”¤ close callbacks â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ª FIFO çš„å›è°ƒé˜Ÿåˆ—ï¼ˆqueueï¼‰ï¼Œå½“ Event Loop æ‰§è¡Œåˆ°è¿™ä¸ªé˜¶æ®µæ—¶ï¼Œä¼šä»å½“å‰é˜¶æ®µçš„é˜Ÿåˆ—é‡Œæ‹¿å‡ºä¸€ä¸ªä»»åŠ¡æ”¾åˆ°æ ˆä¸­æ‰§è¡Œï¼Œå½“é˜Ÿåˆ—ä»»åŠ¡æ¸…ç©ºï¼Œæˆ–è€…æ‰§è¡Œçš„å›è°ƒæ•°é‡è¾¾åˆ°ä¸Šé™åï¼ŒEvent Loop ä¼šè¿›å…¥ä¸‹ä¸ªé˜¶æ®µã€‚ æ¯ä¸ªé˜¶æ®µï¼ˆphaseï¼‰çš„ä½œç”¨ï¼š timersï¼šæ‰§è¡Œ setTimeout() å’Œ setInterval() ä¸­åˆ°æœŸçš„ callbackã€‚ I&#x2F;O callbacksï¼šä¸Šä¸€è½®å¾ªç¯ä¸­æœ‰å°‘æ•°çš„ I&#x2F;O callback ä¼šè¢«å»¶è¿Ÿåˆ°è¿™ä¸€è½®çš„è¿™ä¸€é˜¶æ®µæ‰§è¡Œã€‚ idle, prepareï¼šä»…å†…éƒ¨ä½¿ç”¨ã€‚ pollï¼šæœ€é‡è¦çš„é˜¶æ®µï¼Œæ‰§è¡Œ I&#x2F;O callbackï¼Œåœ¨é€‚å½“çš„æ¡ä»¶ä¸‹ node ä¼šé˜»å¡åœ¨è¿™ä¸ªé˜¶æ®µã€‚ checkï¼šæ‰§è¡Œ setImmediate() çš„ callbackã€‚ close callbacksï¼šæ‰§è¡Œ close äº‹ä»¶çš„ callbackï¼Œä¾‹å¦‚ socket.on(â€˜closeâ€™,func)ã€‚ 3.6.2 poll é˜¶æ®µpoll é˜¶æ®µä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š å½“ timers çš„å®šæ—¶å™¨åˆ°æœŸåï¼Œæ‰§è¡Œå®šæ—¶å™¨ï¼ˆsetTimeout å’Œ setIntervalï¼‰çš„ callbackã€‚ æ‰§è¡Œ poll é˜Ÿåˆ—é‡Œé¢çš„ I&#x2F;O callbackã€‚ å¦‚æœ Event Loop è¿›å…¥äº† poll é˜¶æ®µï¼Œä¸”ä»£ç æœªè®¾å®š timerï¼Œå¯èƒ½å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š å¦‚æœ poll queue ä¸ä¸ºç©ºï¼ŒEvent Loop å°†åŒæ­¥çš„æ‰§è¡Œ queue é‡Œçš„ callbackï¼Œç›´è‡³ queue ä¸ºç©ºï¼Œæˆ–è€…æ‰§è¡Œçš„ callback åˆ°è¾¾ç³»ç»Ÿä¸Šé™ã€‚ å¦‚æœ poll queue ä¸ºç©ºï¼Œå¯èƒ½å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š å¦‚æœä»£ç ä½¿ç”¨ setImmediate() è®¾å®šäº† callbackï¼ŒEvent Loop å°†ç»“æŸ poll é˜¶æ®µè¿›å…¥ check é˜¶æ®µï¼Œå¹¶æ‰§è¡Œ check é˜¶æ®µçš„ queueã€‚ å¦‚æœä»£ç æ²¡æœ‰ä½¿ç”¨ setImmediate()ï¼ŒEvent Loop å°†é˜»å¡åœ¨è¯¥é˜¶æ®µç­‰å¾… callbacks åŠ å…¥ poll queueï¼Œå¦‚æœæœ‰ callback è¿›æ¥åˆ™ç«‹å³æ‰§è¡Œã€‚ ä¸€æ—¦ poll queue ä¸ºç©ºï¼ŒEvent Loop å°†æ£€æŸ¥ timersï¼Œå¦‚æœæœ‰ timer çš„æ—¶é—´åˆ°æœŸï¼ŒEvent Loop å°†å›åˆ° timers é˜¶æ®µï¼Œç„¶åæ‰§è¡Œ timer queueã€‚ 3.6.3 process.nextTick()ä¸Šé¢çš„ 6 ä¸ªé˜¶æ®µå¹¶æ²¡æœ‰å‡ºç° process.nextTick()ï¼Œprocess.nextTick() ä¸åœ¨ Event Loop çš„ä»»ä½•é˜¶æ®µæ‰§è¡Œï¼Œè€Œæ˜¯åœ¨å„ä¸ªé˜¶æ®µåˆ‡æ¢çš„ä¸­é—´æ‰§è¡Œï¼Œå³ä»ä¸€ä¸ªé˜¶æ®µåˆ‡æ¢åˆ°ä¸‹ä¸ªé˜¶æ®µå‰æ‰§è¡Œã€‚è¿™é‡Œè¿˜éœ€è¦æä¸€ä¸‹ macrotask å’Œ microtask çš„æ¦‚å¿µï¼Œmacrotaskï¼ˆå®ä»»åŠ¡ï¼‰æŒ‡ Event Loop æ¯ä¸ªé˜¶æ®µæ‰§è¡Œçš„ä»»åŠ¡ï¼Œmicrotaskï¼ˆå¾®ä»»åŠ¡ï¼‰æŒ‡æ¯ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œçš„ä»»åŠ¡ã€‚å³ä¸Šè¿° 6 ä¸ªé˜¶æ®µéƒ½å±äº macrotaskï¼Œprocess.nextTick() å±äº microtaskã€‚ å°æç¤ºï¼šprocess.nextTick() çš„å®ç°å’Œ v8 çš„ microtask å¹¶æ— å…³ç³»ï¼Œæ˜¯ Node.js å±‚é¢çš„ä¸œè¥¿ï¼Œåº”è¯¥è¯´ process.nextTick() çš„è¡Œä¸ºæ¥è¿‘ä¸º microtaskã€‚Promise.then ä¹Ÿå±äº microtask çš„ä¸€ç§ã€‚ æœ€åï¼Œæ”¾å‡ºä¸€å¼ å…³äº Event Loop éå¸¸ç›´è§‚çš„å›¾ï¼š ç»¿è‰²å°å—è¡¨ç¤º Event Loop çš„å„ä¸ªé˜¶æ®µï¼Œæ‰§è¡Œçš„æ˜¯ macrotaskï¼Œmacrotask ä¸­é—´çš„ç²‰çº¢ç®­å¤´è¡¨ç¤ºæ‰§è¡Œçš„æ˜¯ microtaskã€‚ 3.6.4 å…­é“é¢˜ä¸‹é¢æˆ‘ä»¬ä»¥å…­é“é¢˜å·©å›ºä¸€ä¸‹å‰é¢è®²åˆ°çš„ Event Loop çš„çŸ¥è¯†ã€‚ é¢˜ç›®ä¸€1234567setTimeout(() =&gt; &#123; console.log(&#x27;setTimeout&#x27;)&#125;, 0)setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate&#x27;)&#125;) è¿è¡Œç»“æœï¼š 12setImmediatesetTimeout æˆ–è€…ï¼š 12setTimeoutsetImmediate ä¸ºä»€ä¹ˆç»“æœä¸ç¡®å®šå‘¢ï¼Ÿ è§£é‡Šï¼šsetTimeout&#x2F;setInterval çš„ç¬¬ 2 ä¸ªå‚æ•°å–å€¼èŒƒå›´æ˜¯ï¼š[1, 2^31 - 1]ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªèŒƒå›´åˆ™ä¼šåˆå§‹åŒ–ä¸º 1ï¼Œå³ setTimeout(fn, 0) &#x3D;&#x3D;&#x3D; setTimeout(fn, 1)ã€‚æˆ‘ä»¬çŸ¥é“ setTimeout çš„å›è°ƒå‡½æ•°åœ¨ timer é˜¶æ®µæ‰§è¡Œï¼ŒsetImmediate çš„å›è°ƒå‡½æ•°åœ¨ check é˜¶æ®µæ‰§è¡Œï¼Œevent loop çš„å¼€å§‹ä¼šå…ˆæ£€æŸ¥ timer é˜¶æ®µï¼Œä½†æ˜¯åœ¨å¼€å§‹ä¹‹å‰åˆ° timer é˜¶æ®µä¼šæ¶ˆè€—ä¸€å®šæ—¶é—´ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼š timer å‰çš„å‡†å¤‡æ—¶é—´è¶…è¿‡ 1msï¼Œæ»¡è¶³ loop-&gt;time &gt;&#x3D; 1ï¼Œåˆ™æ‰§è¡Œ timer é˜¶æ®µï¼ˆsetTimeoutï¼‰çš„å›è°ƒå‡½æ•°ã€‚ timer å‰çš„å‡†å¤‡æ—¶é—´å°äº 1msï¼Œåˆ™å…ˆæ‰§è¡Œ check é˜¶æ®µï¼ˆsetImmediateï¼‰çš„å›è°ƒå‡½æ•°ï¼Œä¸‹ä¸€æ¬¡ event loop æ‰§è¡Œ timer é˜¶æ®µï¼ˆsetTimeoutï¼‰çš„å›è°ƒå‡½æ•°ã€‚ å†çœ‹ä¸ªä¾‹å­ï¼š 12345678910setTimeout(() =&gt; &#123; console.log(&#x27;setTimeout&#x27;)&#125;, 0)setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate&#x27;)&#125;)const start = Date.now()while (Date.now() - start &lt; 10); è¿è¡Œç»“æœä¸€å®šæ˜¯ï¼š 12setTimeoutsetImmediate é¢˜ç›®äºŒ1234567891011const fs = require(&#x27;fs&#x27;)fs.readFile(__filename, () =&gt; &#123; setTimeout(() =&gt; &#123; console.log(&#x27;setTimeout&#x27;) &#125;, 0) setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate&#x27;) &#125;)&#125;) è¿è¡Œç»“æœï¼š 12setImmediatesetTimeout è§£é‡Šï¼šfs.readFile çš„å›è°ƒå‡½æ•°æ‰§è¡Œå®Œåï¼š æ³¨å†Œ setTimeout çš„å›è°ƒå‡½æ•°åˆ° timer é˜¶æ®µã€‚ æ³¨å†Œ setImmediate çš„å›è°ƒå‡½æ•°åˆ° check é˜¶æ®µã€‚ event loop ä» pool é˜¶æ®µå‡ºæ¥ç»§ç»­å¾€ä¸‹ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œï¼Œæ°å¥½æ˜¯ check é˜¶æ®µï¼Œæ‰€ä»¥ setImmediate çš„å›è°ƒå‡½æ•°å…ˆæ‰§è¡Œã€‚ æœ¬æ¬¡ event loop ç»“æŸåï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡ event loopï¼Œæ‰§è¡Œ setTimeout çš„å›è°ƒå‡½æ•°ã€‚ æ‰€ä»¥ï¼Œåœ¨ I&#x2F;O Callbacks ä¸­æ³¨å†Œçš„ setTimeout å’Œ setImmediateï¼Œæ°¸è¿œéƒ½æ˜¯ setImmediate å…ˆæ‰§è¡Œã€‚ é¢˜ç›®ä¸‰1234567setInterval(() =&gt; &#123; console.log(&#x27;setInterval&#x27;)&#125;, 100)process.nextTick(function tick () &#123; process.nextTick(tick)&#125;) è¿è¡Œç»“æœï¼šsetInterval æ°¸è¿œä¸ä¼šæ‰“å°å‡ºæ¥ã€‚ è§£é‡Šï¼šprocess.nextTick ä¼šæ— é™å¾ªç¯ï¼Œå°† event loop é˜»å¡åœ¨ microtask é˜¶æ®µï¼Œå¯¼è‡´ event loop ä¸Šå…¶ä»– macrotask é˜¶æ®µçš„å›è°ƒå‡½æ•°æ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚ è§£å†³æ–¹æ³•é€šå¸¸æ˜¯ç”¨ setImmediate æ›¿ä»£ process.nextTickï¼Œå¦‚ä¸‹ï¼š 1234567setInterval(() =&gt; &#123; console.log(&#x27;setInterval&#x27;)&#125;, 100)setImmediate(function immediate () &#123; setImmediate(immediate)&#125;) è¿è¡Œç»“æœï¼šæ¯ 100ms æ‰“å°ä¸€æ¬¡ setIntervalã€‚ è§£é‡Šï¼šprocess.nextTick å†…æ‰§è¡Œ process.nextTick ä»ç„¶å°† tick å‡½æ•°æ³¨å†Œåˆ°å½“å‰ microtask çš„å°¾éƒ¨ï¼Œæ‰€ä»¥å¯¼è‡´ microtask æ°¸è¿œæ‰§è¡Œä¸å®Œï¼› setImmediate å†…æ‰§è¡Œ setImmediate ä¼šå°† immediate å‡½æ•°æ³¨å†Œåˆ°ä¸‹ä¸€æ¬¡ event loop çš„ check é˜¶æ®µï¼Œè€Œä¸æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„ check é˜¶æ®µï¼Œæ‰€ä»¥ç»™äº† event loop ä¸Šå…¶ä»– macrotask æ‰§è¡Œçš„æœºä¼šã€‚ å†çœ‹ä¸ªä¾‹å­ï¼š 12345678910111213setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate1&#x27;) setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate2&#x27;) &#125;) process.nextTick(() =&gt; &#123; console.log(&#x27;nextTick&#x27;) &#125;)&#125;)setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate3&#x27;)&#125;) è¿è¡Œç»“æœï¼š 1234setImmediate1setImmediate3nextTicksetImmediate2 æ³¨æ„ï¼šå¹¶ä¸æ˜¯è¯´ setImmediate å¯ä»¥å®Œå…¨ä»£æ›¿ process.nextTickï¼Œprocess.nextTick åœ¨ç‰¹å®šåœºæ™¯ä¸‹è¿˜æ˜¯æ— æ³•è¢«ä»£æ›¿çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å°±æƒ³å°†ä¸€äº›æ“ä½œæ”¾åˆ°æœ€è¿‘çš„ microtask é‡Œæ‰§è¡Œã€‚ é¢˜ç›®å››12345const promise = Promise.resolve() .then(() =&gt; &#123; return promise &#125;)promise.catch(console.error) è¿è¡Œç»“æœï¼š 123456TypeError: Chaining cycle detected for promise #&lt;Promise&gt; at &lt;anonymous&gt; at process._tickCallback (internal/process/next_tick.js:188:7) at Function.Module.runMain (module.js:667:11) at startup (bootstrap_node.js:187:16) at bootstrap_node.js:607:3 è§£é‡Šï¼šPromise A+ çš„è§„èŒƒé‡Œè§„å®š promise ä¸èƒ½è¿”å›è‡ªå·±ã€‚ä»”ç»†æƒ³æƒ³ï¼Œå³ä½¿è§„èŒƒé‡Œä¸è§„å®šï¼Œpromise.then ç±»ä¼¼äº process.nextTickï¼Œéƒ½ä¼šå°†å›è°ƒå‡½æ•°æ³¨å†Œåˆ° microtask é˜¶æ®µã€‚ä¸Šé¢ä»£ç ä¹Ÿä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œç±»ä¼¼å‰é¢æåˆ°çš„ï¼š 123process.nextTick(function tick () &#123; process.nextTick(tick)&#125;) å†çœ‹ä¸ªä¾‹å­ï¼š 123456789const promise = Promise.resolve()promise.then(() =&gt; &#123; console.log(&#x27;promise&#x27;)&#125;)process.nextTick(() =&gt; &#123; console.log(&#x27;nextTick&#x27;)&#125;) è¿è¡Œç»“æœï¼š 12nextTickpromise è§£é‡Šï¼špromise.then è™½ç„¶å’Œ process.nextTick ä¸€æ ·ï¼Œéƒ½å°†å›è°ƒå‡½æ•°æ³¨å†Œåˆ° microtaskï¼Œä½†ä¼˜å…ˆçº§ä¸ä¸€æ ·ã€‚process.nextTick çš„ microtask queue æ€»æ˜¯ä¼˜å…ˆäº promise çš„ microtask queue æ‰§è¡Œã€‚ é¢˜ç›®äº”12345678910111213setTimeout(() =&gt; &#123; console.log(1)&#125;, 0)new Promise((resolve, reject) =&gt; &#123; console.log(2) for (let i = 0; i &lt; 10000; i++) &#123; i === 9999 &amp;&amp; resolve() &#125; console.log(3)&#125;).then(() =&gt; &#123; console.log(4)&#125;)console.log(5) è¿è¡Œç»“æœï¼š 1234523541 è§£é‡Šï¼šPromise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å…ˆæ‰“å° 2ã€3ï¼Œç„¶åæ‰“å° 5ï¼Œæ¥ä¸‹æ¥ event loop è¿›å…¥æ‰§è¡Œ microtask é˜¶æ®µï¼Œæ‰§è¡Œ promise.then çš„å›è°ƒå‡½æ•°æ‰“å°å‡º 4ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ª macrotaskï¼Œæ°å¥½æ˜¯ timer é˜¶æ®µçš„ setTimeout çš„å›è°ƒå‡½æ•°ï¼Œæ‰“å°å‡º 1ã€‚ é¢˜ç›®å…­12345678910111213141516171819202122232425setImmediate(() =&gt; &#123; console.log(1) setTimeout(() =&gt; &#123; console.log(2) &#125;, 100) setImmediate(() =&gt; &#123; console.log(3) &#125;) process.nextTick(() =&gt; &#123; console.log(4) &#125;)&#125;)process.nextTick(() =&gt; &#123; console.log(5) setTimeout(() =&gt; &#123; console.log(6) &#125;, 100) setImmediate(() =&gt; &#123; console.log(7) &#125;) process.nextTick(() =&gt; &#123; console.log(8) &#125;)&#125;)console.log(9) è¿è¡Œç»“æœï¼š 123456789958174362 process.nextTickã€setTimeout å’Œ setImmediate çš„ç»„åˆï¼Œè¯·è¯»è€…è‡ªè¡Œæ¨ç†å§ã€‚ 3.6.5 å‚è€ƒé“¾æ¥ https://cnodejs.org/topic/57d68794cb6f605d360105bf https://cnodejs.org/topic/5a9108d78d6e16e56bb80882 https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/ https://medium.com/the-node-js-collection/what-you-should-know-to-really-understand-the-node-js-event-loop-and-its-metrics-c4907b19da4c","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Nuxt.js Tutorial","slug":"Nuxtjs åŸºç¡€å…¥é—¨æ•™ç¨‹","date":"2019-05-21T06:12:31.000Z","updated":"2022-05-25T04:06:27.954Z","comments":true,"path":"2019/05/21/Nuxtjs åŸºç¡€å…¥é—¨æ•™ç¨‹/","link":"","permalink":"https://marvinliu1.github.io/2019/05/21/Nuxtjs%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/","excerpt":"","text":"åŸæ–‡é“¾æ¥ Vue å¼€å‘ä¸€ä¸ªå•é¡µé¢åº”ç”¨ï¼Œç›¸ä¿¡å¾ˆå¤šå‰ç«¯å·¥ç¨‹å¸ˆéƒ½å·²ç»å­¦ä¼šäº†ï¼Œä½†æ˜¯å•é¡µé¢åº”ç”¨æœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯ SEO æä¸å‹å¥½ã€‚é™¤éï¼Œvue èƒ½åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆssrï¼‰å¹¶ç›´æ¥è¿”å›å·²ç»æ¸²æŸ“å¥½çš„é¡µé¢ï¼Œè€Œå¹¶éåªæ˜¯ä¸€ä¸ªå•çº¯çš„ &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;ã€‚ Nuxt.js å°±æ˜¯ä¸€ä¸ªæç®€çš„ vue ç‰ˆçš„ ssr æ¡†æ¶ã€‚åŸºäºå®ƒï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿå¼€å‘ä¸€ä¸ªåŸºäº vue çš„ ssr å•é¡µé¢åº”ç”¨ã€‚ å®‰è£…Nuxt.js å®˜æ–¹æä¾›äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œå¯ä»¥ä½¿ç”¨ vue-cli ç›´æ¥å®‰è£…ã€‚ 1$ vue init nuxt-community/starter-template &lt;project-name&gt; ç›®å½•ç»“æ„1234567891011121314.â”œâ”€â”€ README.mdâ”œâ”€â”€ assetsâ”œâ”€â”€ componentsâ”œâ”€â”€ layoutsâ”œâ”€â”€ middlewareâ”œâ”€â”€ node_modulesâ”œâ”€â”€ nuxt.config.jsâ”œâ”€â”€ package.jsonâ”œâ”€â”€ pagesâ”œâ”€â”€ pluginsâ”œâ”€â”€ staticâ”œâ”€â”€ storeâ””â”€â”€ yarn.lock å…¶ä¸­ï¼š assets: èµ„æºæ–‡ä»¶ã€‚æ”¾ç½®éœ€è¦ç»è¿‡ webpack æ‰“åŒ…å¤„ç†çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚ scssï¼Œå›¾ç‰‡ï¼Œå­—ä½“ç­‰ã€‚ components: ç»„ä»¶ã€‚è¿™é‡Œå­˜æ”¾åœ¨é¡µé¢ä¸­ï¼Œå¯ä»¥å¤ç”¨çš„ç»„ä»¶ã€‚ layouts: å¸ƒå±€ã€‚é¡µé¢éƒ½éœ€è¦æœ‰ä¸€ä¸ªå¸ƒå±€ï¼Œé»˜è®¤ä¸º defaultã€‚å®ƒè§„å®šäº†ä¸€ä¸ªé¡µé¢å¦‚ä½•å¸ƒå±€é¡µé¢ã€‚æ‰€æœ‰é¡µé¢éƒ½ä¼šåŠ è½½åœ¨å¸ƒå±€é¡µé¢ä¸­çš„ &lt;nuxt /&gt; æ ‡ç­¾ä¸­ã€‚å¦‚æœéœ€è¦åœ¨æ™®é€šé¡µé¢ä¸­ä½¿ç”¨ä¸‹çº§è·¯ç”±ï¼Œåˆ™éœ€è¦åœ¨é¡µé¢ä¸­æ·»åŠ  &lt;nuxt-child /&gt;ã€‚è¯¥ç›®å½•åä¸ºNuxt.jsä¿ç•™çš„ï¼Œä¸å¯æ›´æ”¹ã€‚ middleware: ä¸­é—´ä»¶ã€‚å­˜æ”¾ä¸­é—´ä»¶ã€‚å¯ä»¥åœ¨é¡µé¢ä¸­è°ƒç”¨ï¼š middleware: &#39;middlewareName&#39; ã€‚ pages: é¡µé¢ã€‚ä¸€ä¸ª vue æ–‡ä»¶å³ä¸ºä¸€ä¸ªé¡µé¢ã€‚index.vue ä¸ºæ ¹é¡µé¢ã€‚ è‹¥éœ€è¦äºŒçº§é¡µé¢ï¼Œåˆ™æ·»åŠ æ–‡ä»¶å¤¹å³å¯ã€‚ å¦‚æœé¡µé¢çš„åç§°ç±»ä¼¼äº _id.vue ï¼ˆä»¥ _ å¼€å¤´ï¼‰ï¼Œåˆ™ä¸ºåŠ¨æ€è·¯ç”±é¡µé¢ï¼Œ_ åä¸ºåŒ¹é…çš„å˜é‡ï¼ˆparamsï¼‰ã€‚ è‹¥å˜é‡æ˜¯å¿…é¡»çš„ï¼Œåˆ™åœ¨æ–‡ä»¶å¤¹ä¸‹å»ºç«‹ç©ºæ–‡ä»¶ index.vueã€‚æ›´å¤šçš„é…ç½®è¯·ç§»æ­¥è‡³ å®˜ç½‘ ã€‚ plugin: æ’ä»¶ã€‚ç”¨äºç»„ç»‡é‚£äº›éœ€è¦åœ¨ æ ¹vue.jsåº”ç”¨ å®ä¾‹åŒ–ä¹‹å‰éœ€è¦è¿è¡Œçš„ Javascript æ’ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä»»ä½• Vue ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œ åªæœ‰ beforeCreate å’Œ created è¿™ä¸¤ä¸ªé’©å­æ–¹æ³•ä¼šåœ¨ *å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å‡è¢«è°ƒç”¨*ã€‚å…¶ä»–é’©å­æ–¹æ³•ä»…åœ¨å®¢æˆ·ç«¯è¢«è°ƒç”¨ã€‚ static: é™æ€æ–‡ä»¶ã€‚æ”¾ç½®ä¸éœ€è¦ç»è¿‡ webpack æ‰“åŒ…çš„é™æ€èµ„æºã€‚å¦‚ä¸€äº› js, css åº“ã€‚ store: çŠ¶æ€ç®¡ç†ã€‚å…·ä½“ä½¿ç”¨è¯·ç§»æ­¥è‡³ å®˜ç½‘ã€‚ nuxt.config.js: nuxt.config.js æ–‡ä»¶ç”¨äºç»„ç»‡Nuxt.js åº”ç”¨çš„ä¸ªæ€§åŒ–é…ç½®ï¼Œä»¥ä¾¿è¦†ç›–é»˜è®¤é…ç½®ã€‚å…·ä½“é…ç½®è¯·ç§»æ­¥è‡³ å®˜ç½‘ã€‚ Nuxt ç‰¹æœ‰å‡½æ•°é¦–å…ˆï¼Œäº†è§£ä¸€ä¸‹åœ¨ nuxt çš„é¡µé¢ä¸­ç‹¬æœ‰çš„å‡½æ•°&#x2F;å˜é‡ï¼š asyncData(context)asyncDataæ–¹æ³•ä½¿å¾—ä½ èƒ½å¤Ÿåœ¨æ¸²æŸ“ç»„ä»¶ä¹‹å‰å¼‚æ­¥è·å–æ•°æ®ã€‚è¯¥æ–¹æ³•åœ¨æœåŠ¡ç«¯ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ï¼Œè¯·æ±‚æ•°æ®æ—¶ï¼Œä¸å­˜åœ¨è·¨åŸŸé—®é¢˜ã€‚è¿”å›çš„æ•°æ®å°†ä¸ data() è¿”å›çš„æ•°æ®è¿›è¡Œåˆå¹¶ã€‚ç”±äºasyncDataæ–¹æ³•æ˜¯åœ¨ç»„ä»¶ *åˆå§‹åŒ–* å‰è¢«è°ƒç”¨çš„ï¼Œæ‰€ä»¥åœ¨æ–¹æ³•å†…æ˜¯æ²¡æœ‰åŠæ³•é€šè¿‡ this æ¥å¼•ç”¨ç»„ä»¶çš„å®ä¾‹å¯¹è±¡ã€‚ context å˜é‡çš„å¯ç”¨å±æ€§ä¸€è§ˆï¼š å±æ€§å­—æ®µ ç±»å‹ å¯ç”¨ æè¿° isClient Boolean å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ æ˜¯å¦æ¥è‡ªå®¢æˆ·ç«¯æ¸²æŸ“ isServer Boolean å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ æ˜¯å¦æ¥è‡ªæœåŠ¡ç«¯æ¸²æŸ“ isDev Boolean å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ æ˜¯å¦æ˜¯å¼€å‘(dev) æ¨¡å¼ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®ç¼“å­˜ä¸­ç”¨åˆ° route vue-router è·¯ç”± å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ vue-router è·¯ç”±å®ä¾‹ã€‚ store vuex æ•°æ®æµ å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ Vuex.Store å®ä¾‹ã€‚åªæœ‰vuex æ•°æ®æµå­˜åœ¨ç›¸å…³é…ç½®æ—¶å¯ç”¨ã€‚ env Object å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ nuxt.config.js ä¸­é…ç½®çš„ç¯å¢ƒå˜é‡, è§ ç¯å¢ƒå˜é‡ api params Object å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ route.params çš„åˆ«å query Object å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ route.query çš„åˆ«å req http.Request æœåŠ¡ç«¯ Node.js API çš„ Request å¯¹è±¡ã€‚å¦‚æœ nuxt ä»¥ä¸­é—´ä»¶å½¢å¼ä½¿ç”¨çš„è¯ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ ¹æ®ä½ æ‰€ä½¿ç”¨çš„æ¡†æ¶è€Œå®šã€‚nuxt generate ä¸å¯ç”¨ã€‚ res http.Response æœåŠ¡ç«¯ Node.js API çš„ Response å¯¹è±¡ã€‚å¦‚æœ nuxt ä»¥ä¸­é—´ä»¶å½¢å¼ä½¿ç”¨çš„è¯ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ ¹æ®ä½ æ‰€ä½¿ç”¨çš„æ¡†æ¶è€Œå®šã€‚nuxt generate ä¸å¯ç”¨ã€‚ redirect Function å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ ç”¨è¿™ä¸ªæ–¹æ³•é‡å®šå‘ç”¨æˆ·è¯·æ±‚åˆ°å¦ä¸€ä¸ªè·¯ç”±ã€‚çŠ¶æ€ç åœ¨æœåŠ¡ç«¯è¢«ä½¿ç”¨ï¼Œé»˜è®¤ 302ã€‚redirect([status,] path [, query]) error Function å®¢æˆ·ç«¯ &amp; æœåŠ¡ç«¯ ç”¨è¿™ä¸ªæ–¹æ³•å±•ç¤ºé”™è¯¯é¡µï¼šerror(params)ã€‚params å‚æ•°åº”è¯¥åŒ…å« statusCode å’Œ message å­—æ®µã€‚ fetch(context)fetch æ–¹æ³•ç”¨äºåœ¨æ¸²æŸ“é¡µé¢å‰å¡«å……åº”ç”¨çš„çŠ¶æ€æ ‘ï¼ˆstoreï¼‰æ•°æ®ï¼Œ ä¸ asyncData æ–¹æ³•ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒä¸ä¼šè®¾ç½®ç»„ä»¶çš„æ•°æ®ã€‚ä¸ºäº†è®©è·å–è¿‡ç¨‹å¯ä»¥å¼‚æ­¥ï¼Œä½ éœ€è¦è¿”å›ä¸€ä¸ª Promiseï¼ŒNuxt.js ä¼šç­‰è¿™ä¸ª promise å®Œæˆåå†æ¸²æŸ“ç»„ä»¶ã€‚ fetch ä¼šåœ¨ç»„ä»¶æ¯æ¬¡åŠ è½½å‰è¢«è°ƒç”¨ï¼ˆåœ¨æœåŠ¡ç«¯æˆ–åˆ‡æ¢è‡³ç›®æ ‡è·¯ç”±ä¹‹å‰ï¼‰ã€‚ headNuxt.js ä½¿ç”¨äº† vue-meta æ›´æ–°åº”ç”¨çš„ å¤´éƒ¨æ ‡ç­¾(Head) å’Œ html å±æ€§ã€‚ ç”¨äºæ›´æ–° å¤´éƒ¨ä¿¡æ¯ã€‚å¦‚ titleï¼Œdescripe ç­‰ã€‚åœ¨ head æ–¹æ³•é‡Œå¯é€šè¿‡ this å…³é”®å­—æ¥è·å–ç»„ä»¶çš„æ•°æ®ã€‚ layoutæŒ‡å®šè¯¥é¡µé¢ä½¿ç”¨å“ªä¸ªå¸ƒå±€æ–‡ä»¶ã€‚é»˜è®¤å€¼ä¸º defaultã€‚ middlewareéœ€è¦æ‰§è¡Œçš„ä¸­é—´ä»¶ï¼Œå¦‚é‰´æƒçš„ authç­‰ã€‚ transitionæŒ‡å®šé¡µé¢åˆ‡æ¢æ—¶çš„åŠ¨ç”»æ•ˆæœã€‚æ”¯æŒä¼ å…¥ String, Object, Functionã€‚å…·ä½“é…ç½®è¯·ç§»æ­¥è‡³ å®˜ç½‘ ã€‚ validateNuxt.js å¯ä»¥è®©ä½ åœ¨åŠ¨æ€è·¯ç”±å¯¹åº”çš„é¡µé¢ç»„ä»¶ä¸­é…ç½®ä¸€ä¸ªæ ¡éªŒæ–¹æ³•ç”¨äºæ ¡éªŒåŠ¨æ€è·¯ç”±å‚æ•°çš„æœ‰æ•ˆæ€§ã€‚ è¿”å› true è¯´æ˜è·¯ç”±æœ‰æ•ˆï¼Œåˆ™è¿›å…¥è·¯ç”±é¡µé¢ã€‚è¿”å›ä¸æ˜¯ true åˆ™æ˜¾ç¤º 404 é¡µé¢ã€‚ Begin Codingå‰ç½®å·¥ä½œAPIåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ CNode API è¿›è¡Œå¼€å‘ Demo. axiosè¯·æ±‚æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨ Nuxt å®˜æ–¹æä¾›çš„ @nuxtjs&#x2F;axios å®‰è£…åï¼Œåœ¨ nuxt.config.js ä¸­åŠ ä¸Šï¼š 1234567891011export default &#123; ... modules: [ &#x27;@nuxtjs/axios&#x27; ], axios: &#123; baseURL: &#x27;https://cnodejs.org/api/v1&#x27;, // or other axios configs. &#125; ...&#125; å°±å¯ä»¥åœ¨é¡µé¢ä¸­é€šè¿‡ this.$axios.$get æ¥è·å–æ•°æ®ï¼Œä¸éœ€è¦åœ¨æ¯ä¸ªé¡µé¢éƒ½å•ç‹¬å¼•å…¥ axios. scsséœ€è¦å…ˆå®‰è£… sass-loader å’Œ node-sass 1$ yarn add sass-loader node-sass --dev å¦‚æœéœ€è¦åœ¨é¡¹ç›®ä¸­å…¨å±€ä½¿ç”¨æŸä¸ª scss æ–‡ä»¶ï¼ˆå¦‚ mixins, vars ç­‰ï¼‰ï¼Œéœ€è¦å€ŸåŠ© sass-resources-loader : yarn add sass-resources-loader â€”devï¼Œ è¿˜éœ€è¦åœ¨ nuxt.config.js çš„ build é…ç½®ä¸­è°ƒæ•´å¯¼å‡ºçš„ loader é…ç½®ï¼š 123456789101112131415161718192021222324252627export default &#123; ... build: &#123; extend(config, &#123; isDev, isClient &#125;) &#123; const sassResourcesLoader = &#123; loader: &#x27;sass-resources-loader&#x27;, options: &#123; resources: [ // å¡«å†™éœ€è¦å…¨å±€æ³¨å…¥ scss çš„æ–‡ä»¶ã€‚å¼•å…¥åï¼Œæ‰€æœ‰é¡µé¢å‡æœ‰æ•ˆã€‚ &#x27;assets/styles/mixins.scss&#x27; ] &#125; &#125; // ä¿®æ”¹ scss sass å¼•ç”¨çš„ loaderã€‚ config.module.rules.forEach((rule) =&gt; &#123; if (rule.test.toString() === &#x27;/\\\\.vue$/&#x27;) &#123; rule.options.loaders.sass.push(sassResourcesLoader) rule.options.loaders.scss.push(sassResourcesLoader) &#125; if ([&#x27;/\\\\.sass$/&#x27;, &#x27;/\\\\.scss$/&#x27;].indexOf(rule.test.toString()) !== -1) &#123; rule.use.push(sassResourcesLoader) &#125; &#125;) &#125; &#125; ...&#125; é¦–é¡µé¦–é¡µä¸€èˆ¬åªéœ€è¦ç®€å•çš„è·å–é¦–é¡µæ•°æ®å¹¶æ¸²æŸ“å³å¯ã€‚ ä¸»è¦ ä»£ç ï¼š 123456789asyncData(&#123;app, query&#125;) &#123; console.log(query) // æ ¹æ®ä¸ç”¨çš„æ ‡ç­¾è·å–ä¸åŒçš„æ•°æ®ï¼Œæœ€åè¿”å›è¯é¢˜åˆ—è¡¨ã€‚ return app.$axios.$get(`topics?tab=$&#123;query.tab || &#x27;&#x27;&#125;`).then(res =&gt; &#123; // console.log(res) // console.log(JSON.parse(res)) return &#123;list: res.data&#125; &#125;)&#125; å½“è¿›å…¥é¦–é¡µæ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¢«æ‰§è¡Œï¼Œ nuxt ä¼šç­‰åˆ°è·å–æ•°æ®åå†å’Œç»„ä»¶çš„ data åˆå¹¶ï¼Œè¿›è€Œæ¸²æŸ“æ•°æ®ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ list å˜é‡è·å–æ•°æ®ã€‚ 123456789101112131415&lt;div class=&quot;card fluid topic&quot; v-for=&quot;topic in list&quot; :key=&quot;topic.id&quot; &gt; &lt;div class=&quot;section&quot;&gt; &lt;h3&gt;&lt;nuxt-link :to=&quot;&#123;name: &#x27;topic-id&#x27;, params: &#123;id: topic.id&#125;&#125;&quot; class=&quot;topic-title&quot;&gt;&#123;&#123;topic.title&#125;&#125;&lt;/nuxt-link&gt;&lt;/h3&gt; &lt;p class=&quot;topic-info&quot;&gt; &lt;mark v-if=&quot;topic.top&quot; class=&quot;tertiary&quot;&gt;ç²¾å&lt;/mark&gt; &lt;mark v-else&gt;&#123;&#123;tabsObj[topic.tab]&#125;&#125;&lt;/mark&gt; &lt;span class=&quot;avatar&quot;&gt; &lt;img :src=&quot;topic.author.avatar_url&quot; alt=&quot;&quot;&gt; &lt;/span&gt; &lt;span class=&quot;username&quot;&gt; &#123;&#123;topic.author.loginname&#125;&#125; &lt;/span&gt; &lt;/p&gt; &lt;/div&gt;&lt;/div&gt; åœ¨è¿™é‡ŒæåŠä¸€ä¸‹ï¼Œ &lt;nuxt-link /&gt; å’Œ &lt;a /&gt; çš„åŒºåˆ«æ˜¯ï¼š nuxt-link èµ°çš„æ˜¯ vue-router çš„è·¯ç”±ï¼Œå³ç½‘é¡µå·²ä¸ºå•é¡µé¢ï¼Œå¹¶ä¸”æµè§ˆå™¨ä¸ä¼šé‡å®šå‘ã€‚è€Œ a æ ‡ç­¾èµ°çš„æ˜¯ window.location.hrefï¼Œæ¯ä¸€æ¬¡ç‚¹å‡» a æ ‡ç­¾åçš„é¡µé¢ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå’Œæ™®é€šçš„ PHP æ··åˆå¼€å‘æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚ åœ¨è¿™é‡Œä½¿ç”¨äº† nuxt-link æ˜¯å› ä¸º CNode çš„ API ä¸å­˜åœ¨è·¨åŸŸé—®é¢˜ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºä¸€ä¸ªå•é¡µé¢åº”ç”¨ï¼Œä½“éªŒæ›´å¥½ã€‚ å› ä¸ºåˆ—è¡¨é¡µæ•°æ®ç±»å‹æœ‰å¤šç§ï¼Œè¯¥é¡µé¢å¯èƒ½ä¼šè¢«å¤ç”¨ï¼Œæ‰€ä»¥å½“è·¯ç”±å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦é‡æ–°è·å–æ•°æ®ï¼Œè¿™æ—¶å¯ä»¥ç›‘å¬è·¯ç”±çš„å˜åŒ–ä»¥åšå‡ºå“åº”ï¼š 123456watch: &#123; &#x27;$route&#x27;: function() &#123; console.log(&#x27;$route has changed.&#x27;) this.getData() &#125;&#125; é…ç½® seo ä¼˜åŒ–ï¼ˆè¿™é‡Œåªæ˜¯å•çº¯çš„å¤åˆ¶ç½¢äº†ï¼Œdemo ä½¿ç”¨ï¼Œä¾µåˆ ï¼‰ï¼š 12345678910head() &#123; return &#123; title: &#x27;é¦–é¡µ&#x27; + (this.$route.query.tab ? `- $&#123;this.tabsObj[this.$route.query.tab]&#125;` : &#x27;&#x27;), meta: [&#123; hid: &#x27;description&#x27;, name: &#x27;description&#x27;, content: &#x27;CNodeï¼šNode.jsä¸“ä¸šä¸­æ–‡ç¤¾åŒº&#x27; &#125;] &#125;&#125; è¯é¢˜è¯¦æƒ…åŒæ ·çš„ï¼Œä½¿ç”¨ asyncData å‡½æ•°è¿›è¡Œè·å–æ•°æ®ï¼Œå†æ¸²æŸ“é¡µé¢ã€‚ 12345678910111213141516asyncData(&#123;app, params&#125;) &#123; console.log(params) return app.$axios.$get(&#x27;topic/&#x27; + params.id).then(res =&gt; &#123; // let data = res.data instanceof String ? JSON.parse(res.data) : res.data let data = res.data // console.log(res) // let div = document.createElement(&#x27;div&#x27;) // div.innerHTML = res.data.data.content // res.data.summary = div.innerText.substr(0, 120) data.summary = data.content.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;).substr(0, 120).replace(/\\s+/g, &#x27;&#x27;) return &#123;detail: data&#125; &#125;).catch(err =&gt; &#123; console.log(&#x27;axios.get failed.&#x27;) console.error(err) &#125;)&#125; åœ¨è¿™é‡Œï¼Œè¸©è¿‡å‘ã€‚æƒ³ä½¿ç”¨ div çš„ innerText æ¥è¿‡æ»¤æ‰æ­£æ–‡ä¸­çš„ HTML æ ‡ç­¾ï¼Œä½†æ˜¯ï¼Œå¦‚æœç”¨æˆ·æ˜¯ç›´æ¥è¿›å…¥è¿™ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œæ‰§è¡Œ asyncData æ—¶ï¼Œdocument å¯¹è±¡æ˜¯ä¸å­˜åœ¨çš„ï¼Œä»è€Œä¼šæŠ¥é”™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ asyncData åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ—¶ï¼Œæ˜¯æ²¡æœ‰ document å’Œ window å¯¹è±¡çš„ï¼Œè¯·å¤§å®¶æ³¨æ„ä¸€ä¸‹ã€‚ ä½œä¸ºä¸€ä¸ªç¤¾åŒºï¼Œseo å°¤ä¸ºé‡è¦ï¼Œå€˜è‹¥æ¯ä¸ªé¡µé¢éƒ½éœ€è¦å†™ä¸€å¤§å †çš„ head å¯¹è±¡ï¼Œå°±ä¼šæ˜¾å¾—å°¤å…¶çš„ç¹çã€‚æ‰€ä»¥å¯ä»¥å€ŸåŠ© nuxt çš„ plugin æœºåˆ¶ï¼Œå°†å…¶å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œå¹¶æ³¨å…¥åˆ°æ¯ä¸€ä¸ªé¡µé¢å½“ä¸­ï¼š 123456789101112131415161718// plugins/global.jsimport Vue from &#x27;vue&#x27;Vue.mixin(&#123; methods: &#123; // å¿…ä¼  æ ‡é¢˜ï¼Œæè¿°ã€‚å…¶ä»–çš„ meta æ ‡ç­¾é€šè¿‡ payload æ³¨å…¥ï¼Œå…¶ä¸­ï¼Œæ¯ä¸ª meta çš„ hid éœ€è¦æ˜¯å”¯ä¸€çš„ã€‚ $seo(title, content, payload = []) &#123; return &#123; title, meta: [&#123; hid: &#x27;description&#x27;, name: &#x27;description&#x27;, content &#125;].concat(payload) &#125; &#125; &#125;&#125;) åœ¨ nuxt.config.js ä¸­åŠ ä¸Šï¼š 12345export default &#123; plugins: [ &#x27;~plugins/global.js&#x27; ]&#125; è¿™æ ·ï¼Œåªéœ€è¦åœ¨é¡µé¢çš„ head çš„å‡½æ•°ä¸­ï¼Œè¿”å›è¯¥å‡½æ•°å³å¯ï¼š 123head() &#123; return this.$seo(this.detail.title, this.detail.summary)&#125; å¯è§ï¼Œè¯¦æƒ…é¡µå·²ç»æˆåŠŸçš„è®¾ç½®äº†éƒ¨åˆ† seo çš„æ ‡ç­¾ã€‚ ä»¥ä¸Šæ˜¯ Nuxt çš„ä¸€äº›åŸºç¡€é…ç½®åŠåº”ç”¨ã€‚ æˆ‘å†å»ç ”ç©¶ä¸€ä¸‹ï¼Œ fetch å’Œ store çš„ç»“åˆï¼Œå°†è¯¥ demo ç»§ç»­å®Œå–„ã€‚ Demo çº¿ä¸Šåœ°å€GitHub åœ°å€","categories":[{"name":"Nuxt","slug":"Nuxt","permalink":"https://marvinliu1.github.io/categories/Nuxt/"}],"tags":[{"name":"Vue","slug":"Vue","permalink":"https://marvinliu1.github.io/tags/Vue/"},{"name":"Nuxt","slug":"Nuxt","permalink":"https://marvinliu1.github.io/tags/Nuxt/"},{"name":"Javascript","slug":"Javascript","permalink":"https://marvinliu1.github.io/tags/Javascript/"}]},{"title":"Node in Debugging, 3.5 Evironment","slug":"3.5.1 ç¯å¢ƒ","date":"2019-05-16T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/05/16/3.5.1 ç¯å¢ƒ/","link":"","permalink":"https://marvinliu1.github.io/2019/05/16/3.5.1%20%E7%8E%AF%E5%A2%83/","excerpt":"","text":"Node in Debugging æˆ‘ä»¬çŸ¥é“ï¼ŒNode.js ä¸é€‚åˆ CPU å¯†é›†å‹è®¡ç®—çš„åœºæ™¯ï¼Œé€šå¸¸çš„è§£å†³æ–¹æ³•æ˜¯ç”¨ C&#x2F;C++ ç¼–å†™ Node.js çš„æ‰©å±•ï¼ˆAddonsï¼‰ã€‚ä»¥å‰åªèƒ½ç”¨ C&#x2F;C++ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†æ–°çš„é€‰æ‹©â€”â€”Rustã€‚ 3.5.1 ç¯å¢ƒ &#x6e;&#x6f;&#100;&#101;&#x40;&#56;&#46;&#57;&#x2e;&#x34; rust@1.26.0-nightly 3.5.2 RustRust æ˜¯ Mozilla å¼€å‘çš„æ³¨é‡å®‰å…¨ã€æ€§èƒ½å’Œå¹¶å‘çš„ç°ä»£ç¼–ç¨‹è¯­è¨€ã€‚ç›¸æ¯”è¾ƒäºå…¶ä»–å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒæœ‰ 3 ä¸ªç‹¬ç‰¹çš„æ¦‚å¿µï¼š æ‰€æœ‰æƒ å€Ÿç”¨ ç”Ÿå‘½å‘¨æœŸ æ­£æ˜¯è¿™ 3 ä¸ªç‰¹æ€§ä¿è¯äº† Rust æ˜¯å†…å­˜å®‰å…¨çš„ï¼Œè¿™é‡Œä¸ä¼šå±•å¼€è®²è§£ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»äº†è§£ä¸€ä¸‹ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‰ç§æ–¹å¼ä½¿ç”¨ Rust ç¼–å†™ Node.js çš„æ‰©å±•ã€‚ 3.5.3 FFIFFI çš„å…¨ç§°æ˜¯ Foreign Function Interfaceï¼Œå³å¯ä»¥ç”¨ Node.js è°ƒç”¨åŠ¨æ€é“¾æ¥åº“ã€‚ è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1234$ cargo new ffi-demo &amp;&amp; cd ffi-demo$ npm init -y$ npm i ffi --save$ touch index.js éƒ¨åˆ†æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹ï¼š src&#x2F;lib.rs 1234567#[no_mangle]pub extern fn fib(n: i64) -&gt; i64 &#123; return match n &#123; 1 | 2 =&gt; 1, n =&gt; fib(n - 1) + fib(n - 2) &#125;&#125; Cargo.toml 1234567[package]name = &quot;ffi-demo&quot;version = &quot;0.1.0&quot;[lib]name = &quot;ffi&quot;crate-type = [&quot;dylib&quot;] Cargo.toml æ˜¯ Rust é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œç›¸å½“äº Node.js ä¸­çš„ package.jsonã€‚è¿™é‡ŒæŒ‡å®šç¼–è¯‘ç”Ÿæˆçš„ç±»å‹æ˜¯ dylibï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰ï¼Œåå­—åœ¨ *inux ä¸‹æ˜¯ libffiï¼ŒWindows ä¸‹æ˜¯ ffiã€‚ ä½¿ç”¨ cargo ç¼–è¯‘ä»£ç ï¼š 123$ cargo build #å¼€å‘ç¯å¢ƒç”¨æˆ–è€…$ cargo build --release #ç”Ÿäº§ç¯å¢ƒç”¨ï¼Œç¼–è¯‘å™¨åšäº†æ›´å¤šä¼˜åŒ–ï¼Œä½†ç¼–è¯‘æ…¢ cargo æ˜¯ Rust çš„æ„å»ºå·¥å…·å’ŒåŒ…ç®¡ç†å·¥å…·ï¼Œè´Ÿè´£æ„å»ºä»£ç ã€ä¸‹è½½ä¾èµ–åº“å¹¶ç¼–è¯‘å®ƒä»¬ã€‚æ­¤æ—¶ä¼šç”Ÿæˆä¸€ä¸ª target çš„ç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹ä¼šæœ‰ debugï¼ˆä¸åŠ  â€“releaseï¼‰æˆ–è€… releaseï¼ˆåŠ  â€“releaseï¼‰ç›®å½•ï¼Œå­˜æ”¾äº†ç”Ÿæˆçš„åŠ¨æ€é“¾æ¥åº“ã€‚ index.js 1234567891011121314151617181920212223const ffi = require(&#x27;ffi&#x27;)const isWin = /^win/.test(process.platform)const rust = ffi.Library(&#x27;target/debug/&#x27; + (!isWin ? &#x27;lib&#x27; : &#x27;&#x27;) + &#x27;ffi&#x27;, &#123; fib: [&#x27;int&#x27;, [&#x27;int&#x27;]]&#125;)function fib(n) &#123; if (n === 1 || n === 2) &#123; return 1 &#125; return fib(n - 1) + fib(n - 2)&#125;// jsconsole.time(&#x27;node&#x27;)console.log(fib(40))console.timeEnd(&#x27;node&#x27;)// rustconsole.time(&#x27;rust&#x27;)console.log(rust.fib(40))console.timeEnd(&#x27;rust&#x27;) è¿è¡Œ index.jsï¼š 12345$ node index.js102334155node: 1053.743ms102334155rust: 1092.570ms å°† index.js ä¸­ debug æ”¹ä¸º releaseï¼Œè¿è¡Œï¼š 123456$ cargo build --release$ node index.js102334155node: 1050.467ms102334155rust: 273.508ms å¯ä»¥çœ‹å‡ºï¼šæ·»åŠ äº† â€“release ç¼–è¯‘åçš„ä»£ç ï¼Œæ‰§è¡Œæ•ˆç‡æå‡ååˆ†æ˜æ˜¾ã€‚ 3.5.4 Neonå®˜æ–¹ä»‹ç»ï¼š Rust bindings for writing safe and fast native Node.js modules. ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819$ npm i neon-cli -g$ neon new neon-demo$ cd neon-demo$ tree ..â”œâ”€â”€ README.mdâ”œâ”€â”€ libâ”‚ â””â”€â”€ index.jsâ”œâ”€â”€ nativeâ”‚ â”œâ”€â”€ Cargo.tomlâ”‚ â”œâ”€â”€ build.rsâ”‚ â””â”€â”€ srcâ”‚ â””â”€â”€ lib.rsâ””â”€â”€ package.json3 directories, 6 files$ npm i #è§¦å‘ neon build$ node lib/index.jshello node æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å…³é”®çš„ä»£ç æ–‡ä»¶ã€‚ lib&#x2F;index.js 12var addon = require(&#x27;../native&#x27;);console.log(addon.hello()); native&#x2F;src&#x2F;lib.rs 1234567891011121314#[macro_use]extern crate neon;use neon::vm::&#123;Call, JsResult&#125;;use neon::js::JsString;fn hello(call: Call) -&gt; JsResult&lt;JsString&gt; &#123; let scope = call.scope; Ok(JsString::new(scope, &quot;hello node&quot;).unwrap())&#125;register_module!(m, &#123; m.export(&quot;hello&quot;, hello)&#125;); native&#x2F;build.rs 1234567extern crate neon_build;fn main() &#123; neon_build::setup(); // must be called in build.rs // add project-specific build logic here...&#125; native&#x2F;Cargo.toml 12345678910111213141516[package]name = &quot;neon-demo&quot;version = &quot;0.1.0&quot;authors = [&quot;nswbmw&quot;]license = &quot;MIT&quot;build = &quot;build.rs&quot;[lib]name = &quot;neon_demo&quot;crate-type = [&quot;dylib&quot;][build-dependencies]neon-build = &quot;0.1.22&quot;[dependencies]neon = &quot;0.1.22&quot; åœ¨è¿è¡Œ neon build æ—¶ï¼Œä¼šæ ¹æ® native&#x2F;Cargo.toml ä¸­ build å­—æ®µæŒ‡å®šçš„æ–‡ä»¶ï¼ˆè¿™é‡Œæ˜¯ build.rsï¼‰ç¼–è¯‘ï¼Œå¹¶ä¸”ç”Ÿæˆçš„ç±»å‹æ˜¯ dylibï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰ã€‚native&#x2F;src&#x2F;lib.rs å­˜æ”¾äº†æ‰©å±•çš„ä»£ç é€»è¾‘ï¼Œé€šè¿‡ register_module æ³¨å†Œäº†ä¸€ä¸ª hello æ–¹æ³•ï¼Œè¿”å› hello node å­—ç¬¦ä¸²ã€‚ æ¥ä¸‹æ¥æµ‹è¯•åŸç”Ÿ Node.js å’Œ Neon ç¼–å†™çš„æ‰©å±•è¿è¡Œæ–æ³¢é‚£å¥‘æ•°åˆ—çš„æ‰§è¡Œæ•ˆç‡ã€‚ ä¿®æ”¹å¯¹åº”æ–‡ä»¶å¦‚ä¸‹ï¼š native&#x2F;src&#x2F;lib.rs 12345678910111213141516171819202122232425#[macro_use]extern crate neon;use neon::vm::&#123;Call, JsResult&#125;;use neon::mem::Handle;use neon::js::JsInteger;fn fib(call: Call) -&gt; JsResult&lt;JsInteger&gt; &#123; let scope = call.scope; let index: Handle&lt;JsInteger&gt; = try!(try!(call.arguments.require(scope, 0)).check::&lt;JsInteger&gt;()); let index: i32 = index.value() as i32; let result: i32 = fibonacci(index); Ok(JsInteger::new(scope, result))&#125;fn fibonacci(n: i32) -&gt; i32 &#123; match n &#123; 1 | 2 =&gt; 1, _ =&gt; fibonacci(n - 1) + fibonacci(n - 2) &#125;&#125;register_module!(m, &#123; m.export(&quot;fib&quot;, fib)&#125;); lib&#x2F;index.js 123456789101112131415161718const rust = require(&#x27;../native&#x27;)function fib (n) &#123; if (n === 1 || n === 2) &#123; return 1 &#125; return fib(n - 1) + fib(n - 2)&#125;// jsconsole.time(&#x27;node&#x27;)console.log(fib(40))console.timeEnd(&#x27;node&#x27;)// rustconsole.time(&#x27;rust&#x27;)console.log(rust.fib(40))console.timeEnd(&#x27;rust&#x27;) è¿è¡Œï¼š 123456$ neon build$ node lib/index.js102334155node: 1030.681ms102334155rust: 270.417ms æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ï¼Œç”¨ Neon ç¼–å†™ä¸€ä¸ª User ç±»ï¼Œå¯ä¼ å…¥ä¸€ä¸ªå«æœ‰ first_name å’Œ last_name çš„å¯¹è±¡ï¼Œæš´éœ²å‡ºä¸€ä¸ª get_full_name æ–¹æ³•ã€‚ ä¿®æ”¹å¯¹åº”æ–‡ä»¶å¦‚ä¸‹ï¼š native&#x2F;src&#x2F;lib.rs 123456789101112131415161718192021222324252627282930313233343536373839404142#[macro_use]extern crate neon;use neon::js::&#123;JsFunction, JsString, Object, JsObject&#125;;use neon::js::class::&#123;Class, JsClass&#125;;use neon::mem::Handle;use neon::vm::Lock;pub struct User &#123; first_name: String, last_name: String,&#125;declare_types! &#123; pub class JsUser for User &#123; init(call) &#123; let scope = call.scope; let user = try!(try!(call.arguments.require(scope, 0)).check::&lt;JsObject&gt;()); let first_name: Handle&lt;JsString&gt; = try!(try!(user.get(scope, &quot;first_name&quot;)).check::&lt;JsString&gt;()); let last_name: Handle&lt;JsString&gt; = try!(try!(user.get(scope, &quot;last_name&quot;)).check::&lt;JsString&gt;()); Ok(User &#123; first_name: first_name.value(), last_name: last_name.value(), &#125;) &#125; method get_full_name(call) &#123; let scope = call.scope; let first_name = call.arguments.this(scope).grab(|user| &#123; user.first_name.clone() &#125;); let last_name = call.arguments.this(scope).grab(|user| &#123; user.last_name.clone() &#125;); Ok(try!(JsString::new_or_throw(scope, &amp;(first_name + &amp;last_name))).upcast()) &#125; &#125;&#125;register_module!(m, &#123; let class: Handle&lt;JsClass&lt;JsUser&gt;&gt; = try!(JsUser::class(m.scope)); let constructor: Handle&lt;JsFunction&lt;JsUser&gt;&gt; = try!(class.constructor(m.scope)); try!(m.exports.set(&quot;User&quot;, constructor)); Ok(())&#125;); lib&#x2F;index.js 123456789const rust = require(&#x27;../native&#x27;)const User = rust.Userconst user = new User(&#123; first_name: &#x27;zhang&#x27;, last_name: &#x27;san&#x27;&#125;)console.log(user.get_full_name()) è¿è¡Œï¼š 123$ neon build$ node lib/index.jszhangsan 3.5.5 NAPIä¸å°‘ Node.js å¼€å‘è€…å¯èƒ½éƒ½é‡åˆ°è¿‡å‡çº§ Node.js ç‰ˆæœ¬å¯¼è‡´ç¨‹åºè¿è¡Œä¸èµ·æ¥çš„æƒ…å†µï¼Œéœ€è¦é‡æ–°å®‰è£…ä¾èµ–è§£å†³ï¼Œæ¯”å¦‚ï¼šnode-sass æ¨¡å—ã€‚å› ä¸ºä¹‹å‰ç¼–å†™ Node.js æ‰©å±•ä¸¥é‡ä¾èµ–äº V8 æš´éœ²çš„ APIï¼Œè€Œä¸åŒç‰ˆæœ¬çš„ Node.js ä¾èµ–çš„ V8 ç‰ˆæœ¬å¯èƒ½ä¸åŒï¼Œä¸€æ—¦å‡çº§ Node.js ç‰ˆæœ¬ï¼ŒåŸå…ˆè¿è¡Œæ­£å¸¸çš„ Node.js çš„æ‰©å±•å°±å¯èƒ½å¤±æ•ˆäº†ã€‚ NAPI æ˜¯ node@8 æ–°æ·»åŠ çš„ç”¨äºåŸç”Ÿæ¨¡å—å¼€å‘çš„æ¥å£ï¼Œç›¸è¾ƒäºä»¥å‰çš„å¼€å‘æ–¹å¼ï¼ŒNAPI æä¾›äº†ç¨³å®šçš„ ABI æ¥å£ï¼Œæ¶ˆé™¤äº† Node.js ç‰ˆæœ¬å·®å¼‚ã€å¼•æ“å·®å¼‚ç­‰ç¼–è¯‘åä¸å…¼å®¹çš„é—®é¢˜ï¼Œè§£å†³äº†ç¼–å†™ Node.js æ’ä»¶æœ€å¤´ç–¼çš„é—®é¢˜ã€‚ ç›®å‰ NAPI è¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œæ‰€ä»¥ç›¸å…³èµ„æ–™å¹¶ä¸å¤šï¼Œç¬”è€…å†™äº†ä¸€ä¸ª demo æ”¾åˆ°äº† GitHub ä¸Šï¼Œè¿™é‡Œç›´æ¥ clone ä¸‹æ¥è¿è¡Œï¼š 1$ git clone https://github.com/nswbmw/rust-napi-demo ä¸»è¦æ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š src&#x2F;lib.rs 12345678910111213141516171819202122232425#[macro_use]extern crate napi;#[macro_use]extern crate napi_derive;use napi::&#123;NapiEnv, NapiNumber, NapiResult&#125;;#[derive(NapiArgs)]struct Args&lt;&#x27;a&gt; &#123; n: NapiNumber&lt;&#x27;a&gt;&#125;fn fibonacci&lt;&#x27;a&gt;(env: &amp;&#x27;a NapiEnv, args: &amp;Args&lt;&#x27;a&gt;) -&gt; NapiResult&lt;NapiNumber&lt;&#x27;a&gt;&gt; &#123; let number = args.n.to_i32()?; NapiNumber::from_i32(env, _fibonacci(number))&#125;napi_callback!(export_fibonacci, fibonacci);fn _fibonacci(n: i32) -&gt; i32 &#123; match n &#123; 1 | 2 =&gt; 1, _ =&gt; _fibonacci(n - 1) + _fibonacci(n - 2) &#125;&#125; index.js 123456789101112131415161718const rust = require(&#x27;./build/Release/example.node&#x27;)function fib (n) &#123; if (n === 1 || n === 2) &#123; return 1 &#125; return fib(n - 1) + fib(n - 2)&#125;// jsconsole.time(&#x27;node&#x27;)console.log(fib(40))console.timeEnd(&#x27;node&#x27;)// rustconsole.time(&#x27;rust&#x27;)console.log(rust.fibonacci(40))console.timeEnd(&#x27;rust&#x27;) è¿è¡Œç»“æœï¼š 123456$ npm start102334155node: 1087.650ms102334155rust: 268.395ms(node:33302) Warning: N-API is an experimental feature and could change at any time. 3.5.6 å‚è€ƒé“¾æ¥ https://github.com/neon-bindings/neon https://github.com/napi-rs/napi https://zhuanlan.zhihu.com/p/27650526","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 3.4 Ignition + Turbofan","slug":"3.4.1 Ignition + Turbofan","date":"2019-05-10T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/05/10/3.4.1 Ignition + Turbofan/","link":"","permalink":"https://marvinliu1.github.io/2019/05/10/3.4.1%20Ignition%20+%20Turbofan/","excerpt":"","text":"Node in Debugging å¦‚æœä½ æƒ³ä»¥æœ€ç®€å•çš„æ–¹å¼æå‡ Node.js ç¨‹åºçš„æ€§èƒ½ï¼Œé‚£å°±å‡çº§åˆ° node@8+ å§ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªç©ç¬‘ï¼Œå¤šå°‘ JavaScript å‰è¾ˆä»¬ä»¥è¡€çš„æ•™è®­æ€»ç»“å‡ºäº†ä¸€é•¿åˆ— â€œOptimization killersâ€ï¼Œå…¸å‹çš„æœ‰ï¼š åœ¨ try é‡Œé¢ä¸è¦å†™è¿‡å¤šä»£ç ï¼ŒV8 æ— æ³•ä¼˜åŒ–ï¼Œæœ€å¥½å°†è¿™äº›ä»£ç æ”¾åˆ°ä¸€ä¸ªå‡½æ•°é‡Œï¼Œç„¶å try è¿™ä¸ªå‡½æ•°ã€‚ å°‘ç”¨ deleteã€‚ å°‘ç”¨ argumentsã€‚ â€¦ ç„¶è€Œï¼Œéšç€ V8 å½»åº•æ¢ä¸Šäº†æ–°çš„ JIT ç¼–è¯‘å™¨â€”â€” Turbofanï¼Œå¤§å¤šæ•° â€œOptimization killersâ€ éƒ½å·²ç»æˆäº†è¿‡å»æ—¶ã€‚æ‰€ä»¥åœ¨æœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å“ªäº›è¿‡å»å¸¸è§çš„ â€œOptimization killersâ€ å·²ç»å¯ä»¥è¢« V8 ä¼˜åŒ–ã€‚ 3.4.1 Ignition + Turbofanä¹‹å‰ V8 ä½¿ç”¨çš„æ˜¯åä¸º Crankshaft çš„ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªç¼–è¯‘å™¨åæ¥é€æ¸æš´éœ²å‡ºä¸€äº›ç¼ºç‚¹ï¼š Doesnâ€™t scale to full, modern JavaScript (try-catch, for-of, generators, async&#x2F;await, â€¦) Defaults to deoptimization (performance cliffs, deoptimization loops) Graph construction, inlining and optimization all mixed up Tight coupling to fullcodegen &#x2F; brittle environment tracking Limited optimization potential &#x2F; limited static analysis (i.e. type propagation) High porting overhead Mixed low-level and high-level semantics of instructions è€Œå¼•å…¥ Turbofan çš„å¥½å¤„æ˜¯ï¼š Full ESnext language support (try-catch&#x2F;-finally, class literals, eval, generators, async functions, modules, destructuring, etc.) Utilize and propagate (static) type information Separate graph building from optimization &#x2F; inlining No deoptimization loops &#x2F; deoptimization only when really beneficial Sane environment tracking (also for lazy deoptimization) Predictable peak performance Ignition æ˜¯ V8 æ–°å¼•å…¥çš„è§£é‡Šå™¨ï¼Œç”¨æ¥å°†ä»£ç ç¼–è¯‘æˆç®€æ´çš„å­—èŠ‚ç ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„æœºå™¨ç ï¼Œè¿™å¤§å¤§å‡å°‘äº†ç»“æœä»£ç ï¼Œå‡å°‘äº†ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨ã€‚ç”±äºå­—èŠ‚ç è¾ƒå°ï¼Œæ‰€ä»¥å¯ä»¥ç¼–è¯‘å…¨éƒ¨æºä»£ç ï¼Œè€Œä¸ç”¨é¿å…ç¼–è¯‘æœªä½¿ç”¨çš„ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè„šæœ¬åªéœ€è¦è§£æä¸€æ¬¡ï¼Œè€Œä¸æ˜¯åƒä¹‹å‰çš„ç¼–è¯‘è¿‡ç¨‹é‚£æ ·è§£æå¤šæ¬¡ã€‚ Ignition ä¸ TurboFan çš„å…³ç³»ä¸ºï¼šIgnition è§£é‡Šå™¨ä½¿ç”¨ä½çº§çš„ã€ä½“ç³»ç»“æ„æ— å…³çš„ TurboFan å®æ±‡ç¼–æŒ‡ä»¤ä¸ºæ¯ä¸ªæ“ä½œç ç”Ÿæˆå­—èŠ‚ç å¤„ç†ç¨‹åºï¼ŒTurboFan å°†è¿™äº›æŒ‡ä»¤ç¼–è¯‘æˆç›®æ ‡å¹³å°çš„ä»£ç ï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰§è¡Œä½çº§çš„æŒ‡ä»¤é€‰æ‹©å’Œæœºå™¨å¯„å­˜å™¨åˆ†é…ã€‚ è¡¥å……ä¸€ç‚¹ï¼Œä¹‹å‰çš„ V8 å°†ä»£ç ç¼–è¯‘æˆæœºå™¨ç æ‰§è¡Œï¼Œè€Œæ–°çš„ V8 å°†ä»£ç ç¼–è¯‘æˆå­—èŠ‚ç è§£é‡Šæ‰§è¡Œï¼ŒåŠ¨æœºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯èƒ½æ˜¯ï¼š å‡å°‘æœºå™¨ç å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå³ç‰ºç‰²æ—¶é—´æ¢ç©ºé—´ï¼ˆä¸»è¦åŠ¨æœºï¼‰ã€‚ åŠ å¿«ä»£ç çš„å¯åŠ¨é€Ÿåº¦ã€‚ å¯¹ V8 çš„ä»£ç è¿›è¡Œé‡æ„ï¼Œé™ä½ V8 çš„ä»£ç å¤æ‚åº¦ã€‚ 3.4.2 ç‰ˆæœ¬å¯¹åº”å…³ç³»1234node@6 -&gt; V8@5.1 -&gt; Crankshaftnode@8.0-8.2 -&gt; V8@5.8 -&gt; Crankshaft + Turbofan V8@5.9 -&gt; Turbofannode@8.3-8.4 -&gt; V8@6.0 -&gt; Turbofan 3.4.3 try&#x2F;catchæœ€è‘—åçš„å»ä¼˜åŒ–ä¹‹ä¸€æ˜¯ä½¿ç”¨ try&#x2F;catch ä»£ç å—ã€‚ä¸‹é¢é€šè¿‡ 4 ç§åœºæ™¯æ¯”è¾ƒåœ¨ä¸åŒçš„ V8 ç‰ˆæœ¬ä¸‹æ‰§è¡Œçš„æ•ˆç‡ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657var benchmark = require(&#x27;benchmark&#x27;)var suite = new benchmark.Suite()function sum (base, max) &#123; var total = 0 for (var i = base; i &lt; max; i++) &#123; total += i &#125;&#125;suite.add(&#x27;sum with try catch&#x27;, function sumTryCatch () &#123; try &#123; var base = 0 var max = 65535 var total = 0 for (var i = base; i &lt; max; i++) &#123; total += i &#125; &#125; catch (err) &#123; console.log(err.message) &#125;&#125;)suite.add(&#x27;sum without try catch&#x27;, function noTryCatch () &#123; var base = 0 var max = 65535 var total = 0 for (var i = base; i &lt; max; i++) &#123; total += i &#125;&#125;)suite.add(&#x27;sum wrapped&#x27;, function wrapped () &#123; var base = 0 var max = 65535 try &#123; sum(base, max) &#125; catch (err) &#123; console.log(err.message) &#125;&#125;)suite.add(&#x27;sum function&#x27;, function func () &#123; var base = 0 var max = 65535 sum(base, max)&#125;)suite.on(&#x27;complete&#x27;, require(&#x27;./print&#x27;))suite.run() è¿è¡Œç»“æœå¦‚ä¸‹ï¼š ç»“è®ºï¼šåœ¨ &#110;&#111;&#x64;&#101;&#64;&#56;&#x2e;&#x33; åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œåœ¨ try å—å†…å†™ä»£ç çš„æ€§èƒ½æŸè€—å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ 3.4.4 deleteå¤šå¹´ä»¥æ¥ï¼Œdelete å¯¹äºä»»ä½•å¸Œæœ›ç¼–å†™é«˜æ€§èƒ½ JavaScript çš„äººæ¥è¯´éƒ½æ˜¯å—é™åˆ¶çš„ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨èµ‹å€¼ undefined æ›¿ä»£ã€‚delete çš„é—®é¢˜å½’ç»“ä¸º V8 å¤„ç† JavaScript å¯¹è±¡çš„åŠ¨æ€ç‰¹æ€§å’ŒåŸå‹é“¾æ–¹å¼ï¼Œä½¿å¾—å±æ€§æŸ¥æ‰¾åœ¨å®ç°ä¸Šå˜å¾—å¤æ‚ã€‚ä¸‹é¢é€šè¿‡ 3 ç§åœºæ™¯æ¯”è¾ƒåœ¨ä¸åŒçš„ V8 ç‰ˆæœ¬ä¸‹æ‰§è¡Œçš„æ•ˆç‡ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657var benchmark = require(&#x27;benchmark&#x27;)var suite = new benchmark.Suite()function MyClass (x, y) &#123; this.x = x this.y = y&#125;function MyClassLast (x, y) &#123; this.y = y this.x = x&#125;suite.add(&#x27;setting to undefined&#x27;, function undefProp () &#123; var obj = new MyClass(2, 3) obj.x = undefined JSON.stringify(obj)&#125;)suite.add(&#x27;delete&#x27;, function deleteProp () &#123; var obj = new MyClass(2, 3) delete obj.x JSON.stringify(obj)&#125;)suite.add(&#x27;delete last property&#x27;, function deleteProp () &#123; var obj = new MyClassLast(2, 3) delete obj.x JSON.stringify(obj)&#125;)suite.add(&#x27;setting to undefined literal&#x27;, function undefPropLit () &#123; var obj = &#123; x: 2, y: 3 &#125; obj.x = undefined JSON.stringify(obj)&#125;)suite.add(&#x27;delete property literal&#x27;, function deletePropLit () &#123; var obj = &#123; x: 2, y: 3 &#125; delete obj.x JSON.stringify(obj)&#125;)suite.add(&#x27;delete last property literal&#x27;, function deletePropLit () &#123; var obj = &#123; y: 3, x: 2 &#125; delete obj.x JSON.stringify(obj)&#125;)suite.on(&#x27;complete&#x27;, require(&#x27;./print&#x27;))suite.run() è¿è¡Œç»“æœå¦‚ä¸‹ï¼š ç»“è®ºï¼šåœ¨ node@8 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œdelete ä¸€ä¸ªå¯¹è±¡ä¸Šçš„å±æ€§æ¯” node@6 å¿«äº†ä¸€å€ã€‚åœ¨ &#110;&#111;&#x64;&#101;&#x40;&#x38;&#x2e;&#51; åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œdelete ä¸€ä¸ªå¯¹è±¡ä¸Šæœ€åä¸€ä¸ªå±æ€§å‡ ä¹ä¸èµ‹å€¼ undefined åŒæ ·å¿«äº†ã€‚ 3.4.5 argumentsæˆ‘ä»¬çŸ¥é“ arguments æ˜¯ä¸ªç±»æ•°ç»„ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬è¦ä½¿ç”¨ Array.prototype.slice.call(arguments) å°†å®ƒè½¬åŒ–æˆæ•°ç»„å†ä½¿ç”¨ï¼Œè¿™æ ·ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—ã€‚ä¸‹é¢é€šè¿‡ 4 ç§åœºæ™¯æ¯”è¾ƒåœ¨ä¸åŒçš„ V8 ç‰ˆæœ¬ä¸‹æ‰§è¡Œçš„æ•ˆç‡ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152var benchmark = require(&#x27;benchmark&#x27;)var suite = new benchmark.Suite()function leakyArguments () &#123; return other(arguments)&#125;function copyArgs () &#123; var array = new Array(arguments.length) for (var i = 0; i &lt; array.length; i++) &#123; array[i] = arguments[i] &#125; return other(array)&#125;function sliceArguments () &#123; var array = Array.prototype.slice.apply(arguments) return other(array)&#125;function spreadOp(...args) &#123; return other(args)&#125;function other (toSum) &#123; var total = 0 for (var i = 0; i &lt; toSum.length; i++) &#123; total += toSum[i] &#125; return total&#125;suite.add(&#x27;leaky arguments&#x27;, () =&gt; &#123; leakyArguments(1, 2, 3)&#125;)suite.add(&#x27;Array.prototype.slice arguments&#x27;, () =&gt; &#123; sliceArguments(1, 2, 3)&#125;)suite.add(&#x27;for-loop copy arguments&#x27;, () =&gt; &#123; copyArgs(1, 2, 3)&#125;)suite.add(&#x27;spread operator&#x27;, () =&gt; &#123; spreadOp(1, 2, 3)&#125;)suite.on(&#x27;complete&#x27;, require(&#x27;./print&#x27;))suite.run() è¿è¡Œç»“æœå¦‚ä¸‹ï¼š ç»“è®ºï¼šåœ¨ &#x6e;&#x6f;&#x64;&#x65;&#x40;&#56;&#x2e;&#51; åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨å¯¹è±¡å±•å¼€è¿ç®—ç¬¦æ˜¯é™¤ç›´æ¥ä½¿ç”¨ arguments å¤–æœ€å¿«çš„æ–¹æ¡ˆï¼Œå¯¹äº &#x6e;&#111;&#100;&#x65;&#x40;&#56;&#x2e;&#50; åŠä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä¸€ä¸ª for å¾ªç¯å°† key ä» arguments å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„ï¼ˆé¢„å…ˆåˆ†é…çš„ï¼‰æ•°ç»„ä¸­ã€‚æ€»ä¹‹ï¼Œæ˜¯æ—¶å€™æŠ›å¼ƒ Array.prototype.slice.call äº†ã€‚ 3.4.6 async æ€§èƒ½æå‡åœ¨ &#86;&#x38;&#x40;&#x35;&#46;&#x37; å‘å¸ƒåï¼ŒåŸç”Ÿçš„ async å‡½æ•°ä¸ Promise ä¸€æ ·å¿«äº†ï¼ŒåŒæ—¶ï¼ŒPromise çš„æ€§èƒ½ä¹Ÿæ¯” &#86;&#x38;&#x40;&#x35;&#46;&#54; å¿«äº†ä¸€å€ã€‚å¦‚å›¾æ‰€ç¤ºï¼š 3.4.7 ä¸ä¼šä¼˜åŒ–çš„ç‰¹æ€§å¹¶ä¸æ˜¯è¯´ä¸Šäº† Turbofan å°±èƒ½ä¼˜åŒ–æ‰€æœ‰çš„ JavaScript è¯­æ³•ï¼Œæœ‰äº›è¯­æ³• V8 æ˜¯ä¸ä¼šå»ä¼˜åŒ–çš„ï¼ˆä¹Ÿæ²¡æœ‰å¿…è¦ï¼‰ï¼Œä¾‹å¦‚ï¼š debugger eval with æˆ‘ä»¬ä»¥ debugger ä¸ºä¾‹ï¼Œæ¯”è¾ƒä½¿ç”¨å’Œä¸ä½¿ç”¨ debugger æ—¶çš„æ€§èƒ½ï¼š 12345678910111213141516171819202122232425262728var benchmark = require(&#x27;benchmark&#x27;)var suite = new benchmark.Suite()suite.add(&#x27;with debugger&#x27;, function withDebugger () &#123; var base = 0 var max = 65535 var total = 0 for (var i = base; i &lt; max; i++) &#123; debugger total += i &#125;&#125;)suite.add(&#x27;without debugger&#x27;, function withoutDebugger () &#123; var base = 0 var max = 65535 var total = 0 for (var i = base; i &lt; max; i++) &#123; total += i &#125;&#125;)suite.on(&#x27;complete&#x27;, require(&#x27;./print&#x27;))suite.run() è¿è¡Œç»“æœå¦‚ä¸‹ï¼š ç»“è®ºï¼šåœ¨æ‰€æœ‰æµ‹è¯•çš„ V8 ç‰ˆæœ¬ä¸­ï¼Œdebugger ä¸€ç›´éƒ½å¾ˆæ…¢ï¼Œæ‰€ä»¥è®°å¾—åœ¨æ‰“æ–­ç‚¹æµ‹è¯•å®Œåä¸€å®šè¦åˆ æ‰ debuggerã€‚ 3.4.8 æ€»ç»“ ä½¿ç”¨æœ€æ–° LTS ç‰ˆæœ¬çš„ Node.jsã€‚ å…³æ³¨ V8 å›¢é˜Ÿçš„åšå®¢â€”â€”https://v8project.blogspot.comï¼Œäº†è§£ç¬¬ä¸€æ‰‹èµ„è®¯ã€‚ æ¸…æ™°çš„ä»£ç è¿œæ¯”ä½¿ç”¨ä¸€äº›å¥‡æŠ€æ·«å·§æå‡çš„ä¸€ç‚¹æ€§èƒ½é‡è¦å¾—å¤šã€‚ 3.4.9 å‚è€ƒé“¾æ¥ https://github.com/davidmarkclements/v8-perf http://www.infoq.com/cn/news/2016/08/v8-ignition-javascript-inteprete https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.g18ceb14729_0_59 https://www.nearform.com/blog/node-js-is-getting-a-new-v8-with-turbofan https://zhuanlan.zhihu.com/p/26669846","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 3.3 Stack Trace","slug":"3.3.1 Stack Trace","date":"2019-05-02T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/05/02/3.3.1 Stack Trace/","link":"","permalink":"https://marvinliu1.github.io/2019/05/02/3.3.1%20Stack%20Trace/","excerpt":"","text":"Node in Debugging å¯¹äº JavaScript ä¸­çš„ Errorï¼Œæƒ³å¿…å¤§å®¶å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæ¯•ç«Ÿå¤©å¤©ä¸å®ƒæ‰“äº¤é“ã€‚ Node.js å†…ç½®çš„ Error ç±»å‹æœ‰ï¼š Errorï¼šé€šç”¨çš„é”™è¯¯ç±»å‹ï¼Œä¾‹å¦‚ï¼šnew Error(&#39;error!!!&#39;)ã€‚ SyntaxErrorï¼šè¯­æ³•é”™è¯¯ï¼Œä¾‹å¦‚ï¼šrequire(&#39;vm&#39;).runInThisContext(&#39;binary ! isNotOk&#39;)ã€‚ ReferenceErrorï¼šå¼•ç”¨é”™è¯¯ï¼Œå¦‚å¼•ç”¨ä¸€ä¸ªæœªå®šä¹‰çš„å˜é‡ï¼Œä¾‹å¦‚ï¼šdoesNotExistã€‚ TypeErrorï¼šç±»å‹é”™è¯¯ï¼Œä¾‹å¦‚ï¼šrequire(&#39;url&#39;).parse(() =&gt; &#123;&#125;)ã€‚ URIErrorï¼šå…¨å±€çš„ URI å¤„ç†å‡½æ•°æŠ›å‡ºçš„é”™è¯¯ï¼Œä¾‹å¦‚ï¼šencodeURI(&#39;\\uD800&#39;)ã€‚ AssertErrorï¼šä½¿ç”¨ assert æ¨¡å—æ—¶æŠ›å‡ºçš„é”™è¯¯ï¼Œä¾‹å¦‚ï¼šassert(false)ã€‚ æ¯ä¸ª Error å¯¹è±¡é€šå¸¸æœ‰ nameã€messageã€stackã€constructor ç­‰å±æ€§ã€‚å½“ç¨‹åºæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®é”™è¯¯æ ˆï¼ˆerror.stackï¼‰å®šä½åˆ°å‡ºé”™ä»£ç ã€‚å¸Œæœ›æœ¬èŠ‚èƒ½å¤Ÿå¸®åŠ©è¯»è€…ç†è§£å¹¶ç©è½¬é”™è¯¯æ ˆï¼Œå†™å‡ºé”™è¯¯æ ˆæ¸…æ™°çš„ä»£ç ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚ 3.3.1 Stack Traceé”™è¯¯æ ˆæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨æ ˆï¼ˆæˆ–è€…å«ï¼šå †æ ˆè¿½è¸ªï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆå¤ä¹ ä¸€ä¸‹ JavaScript ä¸­è°ƒç”¨æ ˆçš„æ¦‚å¿µã€‚ è°ƒç”¨æ ˆï¼šæ¯å½“æœ‰ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå°±ä¼šå°†å…¶å‹å…¥æ ˆé¡¶ï¼Œåœ¨è°ƒç”¨ç»“æŸçš„æ—¶å€™å†å°†å…¶ä»æ ˆé¡¶ç§»å‡ºã€‚ æ¥çœ‹ä¸€æ®µä»£ç ï¼š 12345678910111213141516function c () &#123; console.log(&#x27;c&#x27;) console.trace()&#125;function b () &#123; console.log(&#x27;b&#x27;) c()&#125;function a () &#123; console.log(&#x27;a&#x27;) b()&#125;a() æ‰§è¡Œåæ‰“å°å‡ºï¼š 123456789abcTrace at c (/Users/nswbmw/Desktop/test/app.js:3:11) at b (/Users/nswbmw/Desktop/test/app.js:8:3) at a (/Users/nswbmw/Desktop/test/app.js:13:3) at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:16:1) at ... å¯ä»¥çœ‹å‡ºï¼šc å‡½æ•°ä¸­ console.trace() æ‰“å°å‡ºçš„å †æ ˆè¿½è¸ªä¾æ¬¡ä¸º cã€bã€aï¼Œå³ a è°ƒç”¨äº† bï¼Œb è°ƒç”¨äº† cã€‚ ç¨å¾®ä¿®æ”¹ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼š 12345678910111213141516function c () &#123; console.log(&#x27;c&#x27;)&#125;function b () &#123; console.log(&#x27;b&#x27;) c() console.trace()&#125;function a () &#123; console.log(&#x27;a&#x27;) b()&#125;a() æ‰§è¡Œåæ‰“å°å‡ºï¼š 12345678abcTrace at b (/Users/nswbmw/Desktop/test/app.js:8:11) at a (/Users/nswbmw/Desktop/test/app.js:13:3) at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:16:1) at ... å¯ä»¥çœ‹å‡ºï¼šc() åœ¨ console.trace() ä¹‹å‰æ‰§è¡Œå®Œæ¯•ï¼Œä»æ ˆä¸­ç§»é™¤ï¼Œæ‰€ä»¥æ ˆä¸­ä»ä¸Šå¾€ä¸‹ä¸º bã€aã€‚ ä¸Šé¢ç¤ºä¾‹çš„ä»£ç è¿‡äºç®€å•ï¼Œåœ¨å®é™…æƒ…å†µä¸‹é”™è¯¯æ ˆå¹¶æ²¡æœ‰è¿™ä¹ˆç›´è§‚ã€‚ä»¥å¸¸ç”¨çš„ mongoose ä¸ºä¾‹ï¼Œmongoose çš„é”™è¯¯æ ˆå¹¶ä¸å‹å¥½ï¼š 123456789101112const mongoose = require(&#x27;mongoose&#x27;)const Schema = mongoose.Schemamongoose.connect(&#x27;mongodb://localhost/test&#x27;)const UserSchema = new Schema(&#123; id: mongoose.Schema.Types.ObjectId&#125;)const User = mongoose.model(&#x27;User&#x27;, UserSchema)User .create(&#123; id: &#x27;xxx&#x27; &#125;) .then(console.log) .catch(console.error) è¿è¡Œåæ‰“å°å‡ºï¼š 123456789101112131415161718&#123; ValidationError: User validation failed: id: Cast to ObjectID failed for value &quot;xxx&quot; at path &quot;id&quot; at ValidationError.inspect (/Users/nswbmw/Desktop/test/node_modules/mongoose/lib/error/validation.js:56:24) at ... errors: &#123; id: &#123; CastError: Cast to ObjectID failed for value &quot;xxx&quot; at path &quot;id&quot; at new CastError (/Users/nswbmw/Desktop/test/node_modules/mongoose/lib/error/cast.js:27:11) at model.$set (/Users/nswbmw/Desktop/test/node_modules/mongoose/lib/document.js:792:7) at ... message: &#x27;Cast to ObjectID failed for value &quot;xxx&quot; at path &quot;id&quot;&#x27;, name: &#x27;CastError&#x27;, stringValue: &#x27;&quot;xxx&quot;&#x27;, kind: &#x27;ObjectID&#x27;, value: &#x27;xxx&#x27;, path: &#x27;id&#x27;, reason: [Object] &#125; &#125;, _message: &#x27;User validation failed&#x27;, name: &#x27;ValidationError&#x27; &#125; ä» mongoose ç»™å‡ºçš„ error.stack ä¸­çœ‹ä¸åˆ°ä»»ä½•æœ‰ç”¨çš„ä¿¡æ¯ï¼Œerror.message å‘Šè¯‰æˆ‘ä»¬ â€œxxxâ€ ä¸åŒ¹é… User è¿™ä¸ª Model çš„ idï¼ˆObjectIDï¼‰çš„ç±»å‹ï¼Œå…¶ä»–çš„å­—æ®µåŸºæœ¬ä¸Šä¹Ÿæ˜¯è¿™ä¸ªç»“è®ºçš„è¡¥å……ï¼Œå´æ²¡æœ‰ç»™å‡ºæˆ‘ä»¬æœ€å…³å¿ƒçš„é—®é¢˜ï¼šæˆ‘å†™çš„ä»£ç ä¸­ï¼Œåˆ°åº•å“ªä¸€è¡Œå‡ºäº†é—®é¢˜ï¼Ÿ å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹çœ‹ Error.captureStackTrace çš„ç”¨æ³•ã€‚ 3.3.2 Error.captureStackTraceError.captureStackTrace æ˜¯ V8 æä¾›çš„ä¸€ä¸ª APIï¼Œå¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š 1Error.captureStackTrace(targetObject[, constructorOpt]) Error.captureStackTrace ä¼šåœ¨ targetObject ä¸­æ·»åŠ ä¸€ä¸ª stack å±æ€§ï¼Œå¯¹è¯¥å±æ€§è¿›è¡Œè®¿é—®æ—¶ï¼Œå°†ä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”å› Error.captureStackTrace() è¯­å¥è¢«è°ƒç”¨æ—¶çš„ä»£ç ä½ç½®ä¿¡æ¯ï¼ˆå³ï¼šè°ƒç”¨æ ˆå†å²ï¼‰ã€‚ ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 1234567const myObject = &#123;&#125;Error.captureStackTrace(myObject)console.log(myObject.stack)// è¾“å‡ºError at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:2:7) at ... é™¤äº† targetObjectï¼ŒcaptureStackTrace è¿˜æ¥æ”¶ä¸€ä¸ªç±»å‹ä¸º function çš„å¯é€‰å‚æ•° constructorOptï¼Œå½“ä¼ é€’è¯¥å‚æ•°æ—¶ï¼Œè°ƒç”¨æ ˆä¸­æ‰€æœ‰ constructorOpt å‡½æ•°ä¹‹ä¸Šçš„ä¿¡æ¯(åŒ…æ‹¬ constructorOpt å‡½æ•°è‡ªèº«)ï¼Œéƒ½ä¼šåœ¨è®¿é—® targetObject.stack æ—¶è¢«å¿½ç•¥ã€‚å½“éœ€è¦å¯¹ç»ˆç«¯ç”¨æˆ·éšè—å†…éƒ¨çš„å®ç°ç»†èŠ‚æ—¶ï¼ŒconstructorOpt å‚æ•°ä¼šå¾ˆæœ‰ç”¨ã€‚ä¼ å…¥ç¬¬ 2 ä¸ªå‚æ•°é€šå¸¸ç”¨äºè‡ªå®šä¹‰é”™è¯¯ï¼Œä¾‹å¦‚ï¼š 1234567891011121314function MyError() &#123; Error.captureStackTrace(this, MyError) this.name = this.constructor.name this.message = &#x27;you got MyError&#x27;&#125;const myError = new MyError()console.log(myError)console.log(myError.stack)// è¾“å‡ºMyError &#123; name: &#x27;MyError&#x27;, message: &#x27;you got MyError&#x27; &#125;Error at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:7:17) at ... å¦‚æœå»æ‰ captureStackTrace çš„ç¬¬ 2 ä¸ªå‚æ•°ï¼š 123456789101112131415function MyError() &#123; Error.captureStackTrace(this) this.name = this.constructor.name this.message = &#x27;you got MyError&#x27;&#125;const myError = new MyError()console.log(myError)console.log(myError.stack)// è¾“å‡ºMyError &#123; name: &#x27;MyError&#x27;, message: &#x27;you got MyError&#x27; &#125;Error at new MyError (/Users/nswbmw/Desktop/test/app.js:2:9) at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:7:17) at ... å¯ä»¥çœ‹å‡ºï¼šå‡ºç°äº† MyError ç›¸å…³çš„è°ƒç”¨æ ˆï¼Œä½†æˆ‘ä»¬å¹¶ä¸å…³å¿ƒ MyError åŠå…¶å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚ captureStackTrace çš„ç¬¬ 2 ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥è°ƒç”¨é“¾ä¸Šçš„å…¶ä»–å‡½æ•°ï¼Œä¸ä¸€å®šæ˜¯å½“å‰å‡½æ•°ï¼Œä¾‹å¦‚ï¼š 123456789101112131415161718192021const myObj = &#123;&#125;function c () &#123; Error.captureStackTrace(myObj, b)&#125;function b () &#123; c()&#125;function a () &#123; b()&#125;a()console.log(myObj.stack)// è¾“å‡ºError at a (/Users/nswbmw/Desktop/test/app.js:12:3) at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:15:1) at ... å¯ä»¥çœ‹å‡ºï¼šcaptureStackTrace çš„ç¬¬ 2 ä¸ªå‚æ•°ä¼ å…¥äº†å‡½æ•° bï¼Œè°ƒç”¨æ ˆä¸­éšè—äº† b å‡½æ•°åŠå…¶ä»¥ä¸Šæ‰€æœ‰çš„å †æ ˆå¸§ã€‚ è®²åˆ°è¿™é‡Œï¼Œç›¸ä¿¡è¯»è€…éƒ½æ˜ç™½äº† captureStackTrace çš„ç”¨æ³•ã€‚ä½†è¿™å…·ä½“æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå…¶å®ä¸Šé¢æåˆ°äº†ï¼šéšè—å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œä¼˜åŒ–é”™è¯¯æ ˆã€‚ ä¸‹é¢ä»¥ç¬”è€…å†™çš„ä¸€ä¸ªæ¨¡å— Mongolass ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•åº”ç”¨ captureStackTraceã€‚ Mongolass æ˜¯ä¸€ä¸ªè½»é‡ä¸”ä¼˜é›…çš„è¿æ¥ MongoDB çš„æ¨¡å—ã€‚ 3.3.3 captureStackTrace åœ¨ Mongolass ä¸­çš„åº”ç”¨è¿™é‡Œå…ˆå¤§ä½“è®²è®² Mongolass çš„ç”¨æ³•ã€‚Mongolass ä¸ Mongoose ç±»ä¼¼ï¼Œæœ‰ Model çš„æ¦‚å¿µï¼ŒModel ä¸ŠæŒ‚è½½çš„æ–¹æ³•å¯¹åº”å¯¹ MongoDB çš„ collections çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šUser.insertã€‚User æ˜¯ä¸€ä¸ª Model å®ä¾‹ï¼ŒUser.insert æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª Query å®ä¾‹ã€‚Query çš„ä»£ç å¦‚ä¸‹ï¼š 123456class Query &#123; constructor(op, args) &#123; Error.captureStackTrace(this, this.constructor); ... &#125;&#125; è¿™é‡Œç”¨ Error.captureStackTrace éšè—äº† Query å†…éƒ¨çš„é”™è¯¯æ ˆç»†èŠ‚ï¼Œä½†è¿™æ ·å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šä¸¢å¤±äº†åŸæ¥çš„ error.stackï¼Œåœ¨ Mongolass ä¸­å¯ä»¥è‡ªå®šä¹‰æ’ä»¶ï¼Œè€Œæ’ä»¶å‡½æ•°çš„æ‰§è¡Œæ˜¯åœ¨ Query å†…éƒ¨ï¼Œå‡å¦‚åœ¨æ’ä»¶ä¸­æŠ›é”™ï¼Œåˆ™ä¼šä¸¢å¤±ç›¸å…³é”™è¯¯æ ˆä¿¡æ¯ã€‚ å¦‚ä½•å¼¥è¡¥å‘¢ï¼ŸMongolass çš„åšæ³•æ˜¯ï¼šå½“ Query å†…éƒ¨æŠ›å‡ºé”™è¯¯ï¼ˆerrorï¼‰æ—¶ï¼Œæˆªå–æœ‰ç”¨çš„ error.stackï¼Œç„¶åæ‹¼æ¥åˆ° Query å®ä¾‹é€šè¿‡ Error.captureStackTrace ç”Ÿæˆçš„ stack ä¸Šã€‚ æ¥çœ‹ä¸€æ®µ Mongolass çš„ä»£ç ï¼š 123456789101112131415const Mongolass = require(&#x27;mongolass&#x27;)const Schema = Mongolass.Schemaconst mongolass = new Mongolass(&#x27;mongodb://localhost:27017/test&#x27;)const UserSchema = new Schema(&#x27;UserSchema&#x27;, &#123; name: &#123; type: &#x27;string&#x27; &#125;, age: &#123; type: &#x27;number&#x27; &#125;&#125;)const User = mongolass.model(&#x27;User&#x27;, UserSchema)User .insertOne(&#123; name: &#x27;nswbmw&#x27;, age: &#x27;wrong age&#x27; &#125;) .exec() .then(console.log) .catch(console.error) è¿è¡Œåæ‰“å°çš„é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112131415&#123; TypeError: ($.age: &quot;wrong age&quot;) âœ– (type: number) at Model.insertOne (/Users/nswbmw/Desktop/test/node_modules/mongolass/lib/query.js:104:16) at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:12:4) at ... validator: &#x27;type&#x27;, actual: &#x27;wrong age&#x27;, expected: &#123; type: &#x27;number&#x27; &#125;, path: &#x27;$.age&#x27;, schema: &#x27;UserSchema&#x27;, model: &#x27;User&#x27;, op: &#x27;insertOne&#x27;, args: [ &#123; name: &#x27;nswbmw&#x27;, age: &#x27;wrong age&#x27; &#125; ], pluginName: &#x27;MongolassSchema&#x27;, pluginOp: &#x27;beforeInsertOne&#x27;, pluginArgs: [] &#125; å¯ä»¥çœ‹å‡ºï¼šapp.js ç¬¬ 12 è¡Œçš„ insertOne æŠ¥é”™ï¼ŒæŠ¥é”™åŸå› æ˜¯ age å­—æ®µæ˜¯å­—ç¬¦ä¸² â€œwrong ageâ€ï¼Œè€Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯ number ç±»å‹çš„å€¼ã€‚ 3.3.4 Error.prepareStackTraceV8 æš´éœ²äº†å¦å¤–ä¸€ä¸ªæ¥å£â€”â€”Error.prepareStackTraceã€‚ç®€å•æ¥è®²ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ï¼šå®šåˆ¶ stackã€‚ç”¨æ³•å¦‚ä¸‹ï¼š 1Error.prepareStackTrace(error, structuredStackTrace) ç¬¬ 1 ä¸ªå‚æ•°æ˜¯ä¸ª Error å¯¹è±¡ï¼Œç¬¬ 2 ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª CallSite å¯¹è±¡ï¼ŒåŒ…å«é”™è¯¯çš„å‡½æ•°åã€è¡Œæ•°ç­‰ä¿¡æ¯ã€‚å¯¹æ¯”ä»¥ä¸‹ä¸¤ç§ä»£ç ï¼š æ­£å¸¸çš„ throw errorï¼š 123456789101112131415161718192021222324function c () &#123; throw new Error(&#x27;error!!!&#x27;)&#125;function b () &#123; c()&#125;function a () &#123; b()&#125;try &#123; a()&#125; catch (e) &#123; console.log(e.stack)&#125;// è¾“å‡ºError: error!!! at c (/Users/nswbmw/Desktop/test/app.js:2:9) at b (/Users/nswbmw/Desktop/test/app.js:6:3) at a (/Users/nswbmw/Desktop/test/app.js:10:3) at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/test/app.js:14:3) at ... ä½¿ç”¨ Error.prepareStackTrace æ ¼å¼åŒ– stackï¼š 123456789101112131415161718192021222324252627282930313233Error.prepareStackTrace = function (error, callSites) &#123; return error.toString() + &#x27;\\n&#x27; + callSites.map(callSite =&gt; &#123; return &#x27; -&gt; &#x27; + callSite.getFunctionName() + &#x27; (&#x27; + callSite.getFileName() + &#x27;:&#x27; + callSite.getLineNumber() + &#x27;:&#x27; + callSite.getColumnNumber() + &#x27;)&#x27; &#125;).join(&#x27;\\n&#x27;)&#125;function c () &#123; throw new Error(&#x27;error!!!&#x27;)&#125;function b () &#123; c()&#125;function a () &#123; b()&#125;try &#123; a()&#125; catch (e) &#123; console.log(e.stack)&#125;// è¾“å‡ºError: error!!! -&gt; c (/Users/nswbmw/Desktop/test/app.js:11:9) -&gt; b (/Users/nswbmw/Desktop/test/app.js:15:3) -&gt; a (/Users/nswbmw/Desktop/test/app.js:19:3) -&gt; null (/Users/nswbmw/Desktop/test/app.js:23:3) -&gt; ... å¯ä»¥çœ‹å‡ºï¼šæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ª Error.prepareStackTrace æ ¼å¼åŒ–äº† stack å¹¶æ‰“å°å‡ºæ¥ã€‚ CallSite å¯¹è±¡è¿˜æœ‰è®¸å¤š APIï¼Œä¾‹å¦‚ï¼šgetThisã€getTypeNameã€getFunctionã€getFunctionNameã€getMethodNameã€getFileNameã€getLineNumberã€getColumnNumberã€getEvalOriginã€isToplevelã€isEvalã€isNative å’Œ isConstructorï¼Œè¿™é‡Œä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯æŸ¥çœ‹å‚è€ƒé“¾æ¥ã€‚ åœ¨ä½¿ç”¨ Error.prepareStackTrace æ—¶éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š è¿™ä¸ªæ–¹æ³•æ˜¯ V8 æš´éœ²å‡ºæ¥çš„ï¼Œæ‰€ä»¥åªèƒ½åœ¨åŸºäº V8 çš„ Node.js æˆ–è€… Chrome é‡Œæ‰èƒ½ä½¿ç”¨ã€‚ è¿™ä¸ªæ–¹æ³•ä¼šä¿®æ”¹å…¨å±€ Error çš„è¡Œä¸ºã€‚ 3.3.5 Error.prepareStackTrace çš„å…¶ä»–ç”¨æ³•Error.prepareStackTrace é™¤äº†æ ¼å¼åŒ–é”™è¯¯æ ˆå¤–è¿˜æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿsindresorhus å¤§ç¥è¿˜å†™äº†ä¸€ä¸ª callsites çš„æ¨¡å—ï¼Œå¯ä»¥ç”¨æ¥è·å–å‡½æ•°è°ƒç”¨ç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è·å–æ‰§è¡Œè¯¥å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶åï¼š 12345678const callsites = require(&#x27;callsites&#x27;)function getFileName() &#123; console.log(callsites()[0].getFileName()) //=&gt; &#x27;/Users/nswbmw/Desktop/test/app.js&#x27;&#125;getFileName() æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æºä»£ç ï¼š 1234567module.exports = () =&gt; &#123; const _ = Error.prepareStackTrace Error.prepareStackTrace = (_, stack) =&gt; stack const stack = new Error().stack.slice(1) Error.prepareStackTrace = _ return stack&#125; æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š å› ä¸ºä¿®æ”¹ Error.prepareStackTrace ä¼šå…¨å±€ç”Ÿæ•ˆï¼Œæ‰€ä»¥å°†åŸæ¥çš„ Error.prepareStackTrace å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œå‡½æ•°æ‰§è¡Œå®Œåå†é‡ç½®å›å»ï¼Œé¿å…å½±å“å…¨å±€çš„ Errorã€‚ Error.prepareStackTrace å‡½æ•°ç›´æ¥è¿”å› CallSite å¯¹è±¡æ•°ç»„ï¼Œè€Œä¸æ˜¯æ ¼å¼åŒ–åçš„ stack å­—ç¬¦ä¸²ã€‚ new ä¸€ä¸ª Errorï¼Œstack æ˜¯è¿”å›çš„ CallSite å¯¹è±¡æ•°ç»„ï¼Œå› ä¸ºç¬¬ 1 é¡¹æ˜¯ callsitesï¼Œå®ƒæ€»æ˜¯è¿™ä¸ªæ¨¡å—çš„ CallSiteï¼Œæ‰€ä»¥é€šè¿‡ slice(1) å»æ‰ã€‚ å‡å¦‚æˆ‘ä»¬æƒ³è·å–å½“å‰å‡½æ•°çš„çˆ¶å‡½æ•°åï¼Œåˆ™å¯ä»¥è¿™æ ·ç”¨ï¼š 1234567891011const callsites = require(&#x27;callsites&#x27;)function b () &#123; console.log(callsites()[1].getFunctionName()) // =&gt; &#x27;a&#x27;&#125;function a () &#123; b()&#125;a() 3.3.6 Error.stackTraceLimitNode.js è¿˜æš´éœ²äº†ä¸€ä¸ª Error.stackTraceLimit çš„è®¾ç½®ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®è¿™ä¸ªå€¼æ¥æ”¹å˜è¾“å‡ºçš„ stack çš„è¡Œæ•°ï¼Œé»˜è®¤å€¼æ˜¯ 10ã€‚ 3.3.7 Long Stack Tracestack trace ä¹Ÿæœ‰çŸ­æ¿ï¼Œé—®é¢˜å‡ºåœ¨å¼‚æ­¥æ“ä½œä¸Šã€‚è‹¥åœ¨å¼‚æ­¥å›è°ƒä¸­æŠ›é”™ï¼Œå°±ä¼šä¸¢å¤±ç»‘å®šå›è°ƒå‰çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œæ¥çœ‹ä¸ªä¾‹å­ï¼š 1234567891011121314151617const foo = function () &#123; throw new Error(&#x27;error!!!&#x27;)&#125;const bar = function () &#123; setTimeout(foo)&#125;bar()// è¾“å‡º/Users/nswbmw/Desktop/test/app.js:2 throw new Error(&#x27;error!!!&#x27;) ^Error: error!!! at Timeout.foo [as _onTimeout] (/Users/nswbmw/Desktop/test/app.js:2:9) at ontimeout (timers.js:469:11) at tryOnTimeout (timers.js:304:5) at Timer.listOnTimeout (timers.js:264:5) å¯ä»¥çœ‹å‡ºï¼šä¸¢å¤±äº† bar çš„è°ƒç”¨æ ˆã€‚ åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼‚æ­¥å›è°ƒçš„ä¾‹å­æ•°ä¸èƒœæ•°ï¼Œå¦‚æœä¸èƒ½çŸ¥é“å¼‚æ­¥å›è°ƒä¹‹å‰çš„è§¦å‘ä½ç½®ï¼Œåˆ™ä¼šç»™ debug å¸¦æ¥å¾ˆå¤§çš„éš¾åº¦ã€‚è¿™æ—¶ï¼Œå‡ºç°äº†ä¸€ä¸ªå« long Stack Trace çš„æ¦‚å¿µã€‚ long Stack Trace å¹¶ä¸æ˜¯ JavaScript åŸç”Ÿå°±æ”¯æŒçš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¦æ‹¥æœ‰è¿™æ ·çš„åŠŸèƒ½ï¼Œå°±éœ€è¦æˆ‘ä»¬åšä¸€äº› hackï¼Œå¹¸å¥½åœ¨ V8 ç¯å¢ƒä¸‹ï¼Œæ‰€æœ‰ hack æ‰€éœ€çš„ APIï¼ŒV8 éƒ½å·²ç»æä¾›äº†ã€‚ å¯¹äºå¼‚æ­¥å›è°ƒï¼Œç›®å‰èƒ½åšçš„å°±æ˜¯åœ¨æ‰€æœ‰ä¼šäº§ç”Ÿå¼‚æ­¥æ“ä½œçš„ API ä¸Šåšä¸€äº›æ‰‹è„šï¼Œè¿™äº› API åŒ…æ‹¬ï¼š setTimeout, setInterval, setImmediateã€‚ nextTick, nextDomainTickã€‚ EventEmitter.addEventListenerã€‚ EventEmitter.onã€‚ Ajax XHRã€‚ Long Stack Trace ç›¸å…³çš„åº“å¯ä»¥å‚è€ƒï¼š AndreasMadsen&#x2F;trace mattinsler&#x2F;longjohn tlrobinson&#x2F;long-stack-traces node@8+ æä¾›äº†å¼ºå¤§çš„ async_hooks æ¨¡å—ï¼Œåœ¨æœ¬ä¹¦çš„åé¢ç« èŠ‚ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ã€‚ 3.3.8 å‚è€ƒé“¾æ¥ https://zhuanlan.zhihu.com/p/25338849 https://segmentfault.com/a/1190000007076507 https://github.com/v8/v8/wiki/Stack-Trace-API https://www.jianshu.com/p/1d5120ad62bb","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 3.2 Async and Await","slug":"3.2.1 async + await","date":"2019-04-28T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/28/3.2.1 async + await/","link":"","permalink":"https://marvinliu1.github.io/2019/04/28/3.2.1%20async%20+%20await/","excerpt":"","text":"Node in Debugging ç¬”è€…åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…éƒ½åœ¨ä½¿ç”¨ koa@1 +ï¼ˆgenerator|bluebirdï¼‰+ sequelize è¿™ä¸ªç»„åˆï¼Œè¿™ä¸ªç»„åˆå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¹Ÿå¾ˆå¸¸è§ï¼Œä½†æ˜¯åˆ°äº†æ»¥ç”¨çš„åœ°æ­¥ï¼Œå¯¼è‡´åæ¥ç»´æŠ¤å’Œè°ƒè¯•èµ·æ¥éƒ½å¾ˆç—›è‹¦ã€‚è‹¥æ’é™¤ sequelize è¿™ä¸ªæˆ‘ä»¬ä¸å¾—ä¸ç”¨çš„æ¨¡å—ï¼Œä»è°ƒè¯• cpuprofile çš„è§’åº¦è®²è®²ä¸ºä»€ä¹ˆç¬”è€…è®¤ä¸ºåº”è¯¥ç”¨ async&#x2F;await + Promise æ›¿ä»£ co + generator|bluebirdã€‚ ç¬”è€…çš„è§‚ç‚¹æ˜¯ï¼šä½¿ç”¨åŸç”Ÿæ¨¡å—å…·æœ‰æ›´æ¸…æ™°çš„è°ƒç”¨æ ˆã€‚ ä¸‹é¢ç”¨ 4 ä¸ªä¾‹å­è¿›è¡Œå¯¹æ¯”ï¼Œçœ‹çœ‹å®ç°ç›¸åŒé€»è¾‘çš„ä¸åŒä»£ç ç”Ÿæˆçš„ cpuprofile ä¸­è°ƒç”¨æ ˆçš„ä¿¡æ¯ã€‚ 3.2.1 async + awaitasync.js 12345678910111213141516171819202122232425const fs = require(&#x27;fs&#x27;)const profiler = require(&#x27;v8-profiler&#x27;)async function A () &#123; return await Promise.resolve(&#x27;A&#x27;)&#125;async function B () &#123; return await A()&#125;(async function asyncWrap () &#123; const start = Date.now() profiler.startProfiling() while (Date.now() - start &lt; 10000) &#123; await B() &#125; const profile = profiler.stopProfiling() profile.export() .pipe(fs.createWriteStream(&#x27;async.cpuprofile&#x27;)) .on(&#x27;finish&#x27;, () =&gt; &#123; profile.delete() console.error(&#x27;async.cpuprofile export success&#x27;) &#125;)&#125;)() åŠ è½½è¿è¡Œåç”Ÿæˆçš„ async.cpuprofileï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šasyncWrap ä¸­è°ƒç”¨äº† B å‡½æ•°ï¼ŒB å‡½æ•°è°ƒç”¨äº† A å‡½æ•°ï¼ŒA å‡½æ•°ä¸­ resolve äº†ä¸€ä¸ªå€¼ã€‚åœ¨ asyncWrap ä¸­è¿˜è°ƒç”¨äº† stopProfiling å‡½æ•°ã€‚ 3.2.2 co + yieldco.js 1234567891011121314151617181920212223242526const fs = require(&#x27;fs&#x27;)const co = require(&#x27;co&#x27;)const profiler = require(&#x27;v8-profiler&#x27;)function * A () &#123; return yield Promise.resolve(&#x27;A&#x27;)&#125;function * B () &#123; return yield A()&#125;co(function * coWrap () &#123; const start = Date.now() profiler.startProfiling() while (Date.now() - start &lt; 10000) &#123; yield B() &#125; const profile = profiler.stopProfiling() profile.export() .pipe(fs.createWriteStream(&#x27;co.cpuprofile&#x27;)) .on(&#x27;finish&#x27;, () =&gt; &#123; profile.delete() console.error(&#x27;co.cpuprofile export success&#x27;) &#125;)&#125;) åŠ è½½è¿è¡Œåç”Ÿæˆçš„ co.cpuprofileï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šè°ƒç”¨æ ˆéå¸¸æ·±ï¼Œæœ‰å¤ªå¤šæ²¡æœ‰ç”¨çš„ co ç›¸å…³çš„è°ƒç”¨æ ˆã€‚å¦‚æœ n ä¸ª generator å±‚å±‚åµŒå¥—ï¼Œå°±ä¼šå‡ºç° n å€çš„ (anonymous)-&gt;onFullfiled-&gt;next-&gt;toPromise-&gt;co-&gt;Promise-&gt;(anonymous) è°ƒç”¨æ ˆã€‚å¦‚æœä½ è¯»è¿‡ co çš„æºç ï¼Œå°±å¯èƒ½çŸ¥é“ï¼Œè¿™æ˜¯ co å°† generator è§£åŒ…çš„è¿‡ç¨‹ã€‚å…¶å®è¿™ä¸ªå¯ä»¥é€šè¿‡å°† yield generator æ›¿æ¢æˆ yield* generator æ¥ä¼˜åŒ–ã€‚ 3.2.3 co + yield*co_better.js 1234567891011121314151617181920212223242526const fs = require(&#x27;fs&#x27;)const co = require(&#x27;co&#x27;)const profiler = require(&#x27;v8-profiler&#x27;)function * A () &#123; return yield Promise.resolve(&#x27;A&#x27;)&#125;function * B () &#123; return yield * A()&#125;co(function * coWrap () &#123; const start = Date.now() profiler.startProfiling() while (Date.now() - start &lt; 10000) &#123; yield * B() &#125; const profile = profiler.stopProfiling() profile.export() .pipe(fs.createWriteStream(&#x27;co_better.cpuprofile&#x27;)) .on(&#x27;finish&#x27;, () =&gt; &#123; profile.delete() console.error(&#x27;co_better.cpuprofile export success&#x27;) &#125;)&#125;) åŠ è½½è¿è¡Œåç”Ÿæˆçš„ co_better.cpuprofileï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šä¸ co.js ç›¸æ¯”ï¼Œè°ƒç”¨æ ˆæ¸…æ™°äº†å¾ˆå¤šï¼Œä¸è¿‡ä¸ä½¿ç”¨ async&#x2F;await ç›¸æ¯”ï¼Œè¿˜æ˜¯å¤šäº†äº› onFulfilledã€nextã€‚ 3.2.4 co + bluebirdco_bluebird.js 123456789101112131415161718192021222324252627const fs = require(&#x27;fs&#x27;)const co = require(&#x27;co&#x27;)const Promise = require(&#x27;bluebird&#x27;)const profiler = require(&#x27;v8-profiler&#x27;)function * A () &#123; return yield Promise.resolve(&#x27;A&#x27;)&#125;function * B () &#123; return yield * A()&#125;co(function * coBluebirdWrap () &#123; const start = Date.now() profiler.startProfiling() while (Date.now() - start &lt; 10000) &#123; yield * B() &#125; const profile = profiler.stopProfiling() profile.export() .pipe(fs.createWriteStream(&#x27;co_bluebird.cpuprofile&#x27;)) .on(&#x27;finish&#x27;, () =&gt; &#123; profile.delete() console.error(&#x27;co_bluebird.cpuprofile export success&#x27;) &#125;)&#125;) åŠ è½½è¿è¡Œåç”Ÿæˆçš„ co_bluebird.cpuprofileï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šä¸ co_better.js ç›¸æ¯”ï¼Œè°ƒç”¨æ ˆä¸­å¤šäº†è®¸å¤š bluebird æ¨¡å—çš„æ— ç”¨ä¿¡æ¯ã€‚è€Œä¸”è¿™åªæ˜¯éå¸¸ç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œè¦æ˜¯åœ¨å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ä¸­å¤§é‡ä½¿ç”¨ bluebird ä»£ç ç”Ÿæˆçš„ cpuprofileï¼Œå°±å‡ ä¹æ²¡æ³•çœ‹äº†ã€‚ ç»“è®ºï¼šä½¿ç”¨ async&#x2F;await + Promise + å‘½åå‡½æ•°ï¼Œå…·æœ‰æ›´æ¸…æ™°çš„è°ƒç”¨æ ˆï¼Œè®©åˆ†æ cpuprofile æ—¶ä¸å†ç—›è‹¦ã€‚ èªæ˜çš„ä½ å¯èƒ½ä¼šé—®ï¼š ä¸ºä»€ä¹ˆä¸å»ºè®®ç”¨ bluebirdï¼Ÿå› ä¸ºï¼š éšç€ V8 ä¸æ–­ä¼˜åŒ–ï¼ŒåŸç”Ÿ Promise æ€§èƒ½é€æ¸æé«˜ï¼Œbluebird çš„æ€§èƒ½ä¼˜åŠ¿ä¸æ˜æ˜¾ã€‚ åŸç”Ÿ Promise çš„ API è¶³å¤Ÿç”¨ï¼Œè‡³å°‘èƒ½è¦†ç›–å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯ï¼Œè€Œä¸”è¿˜åœ¨ä¸æ–­å®Œå–„ï¼Œæœªæ¥è¿˜ä¼šæ·»åŠ æ–°çš„ APIï¼Œä¾‹å¦‚ï¼šPromise.prototype.finallyã€‚ å…·æœ‰æ›´æ¸…æ™°çš„è°ƒç”¨æ ˆã€‚ ç”±äºå†å²é—ç•™åŸå› ï¼Œç°åœ¨ä»£ç ä¸­å¤§é‡ä½¿ç”¨äº† yield + generator æ€ä¹ˆåŠï¼Ÿå¯ä»¥ï¼š å°†æ‰€æœ‰ yield generator æ›¿æ¢æˆ yield * generatorã€‚ å‡çº§åˆ° node@8+ï¼Œé€æ­¥ç”¨ async&#x2F;await æ›¿æ¢ï¼Œæ¯•ç«Ÿ async å‡½æ•°è°ƒç”¨åè¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ª promiseï¼Œä¹Ÿæ˜¯ yieldable çš„ã€‚ æ€§èƒ½æ¯”è¾ƒå‘¢ï¼Ÿ node@8+ ä¸‹ async&#x2F;await å®Œèƒœ coã€‚ 3.2.5 yield -&gt; yield* é‡åˆ°çš„å‘ä¸Šé¢è®²åˆ°ï¼Œå¯ä»¥å°† yield generator æ”¹æˆ yield * generatorï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªå‘ï¼Œæ˜¯ç”±äºä¸æ˜ç™½ co çš„åŸç†è€Œæ»¥ç”¨ co å¯¼è‡´çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š 12345678910const co = require(&#x27;co&#x27;)function * genFunc () &#123; return Promise.resolve(&#x27;genFunc&#x27;)&#125;co(function * () &#123; console.log(yield genFunc()) // =&gt; genFunc console.log(yield * genFunc()) // =&gt; Promise &#123; &#x27;genFunc&#x27; &#125;&#125;) å¯ä»¥çœ‹å‡ºï¼šgenFunc è¿™ä¸ª generatorFunction åœ¨æ‰§è¡Œåä¼šè¿”å›ä¸€ä¸ª promiseï¼Œå½“ä½¿ç”¨ yield genFunc() çš„æ—¶å€™ï¼Œco åˆ¤æ–­è¿”å›äº†ä¸€ä¸ª promise ä¼šç»§ç»­å¸®æˆ‘ä»¬è°ƒç”¨å®ƒçš„ then ä»è€Œå¾—åˆ°çœŸæ­£çš„å­—ç¬¦ä¸²ã€‚å¦‚æœä½¿ç”¨ yield * genFunc()ï¼Œå°±ç”¨äº†è¯­è¨€åŸç”Ÿçš„ç‰¹æ€§è€Œä¸ç»è¿‡ coï¼Œç›´æ¥è¿”å›ä¸€ä¸ª promiseã€‚ è§£å†³æ–¹æ³•ï¼ˆä»»é€‰å…¶ä¸€ï¼‰ï¼š function * genFunc -&gt; function genFuncï¼Œç”¨ yield genFunc()ã€‚ return Promise.resolve(&#39;genFunc&#39;) -&gt; return yield Promise.resolve(&#39;genFunc&#39;)ï¼Œç”¨ yield* genFunc()ã€‚ ä¸è¿‡ï¼Œå»ºè®®æœ€ç»ˆè½¬æ¢åˆ° async&#x2F;await + Promise ä¸Šæ¥ï¼Œæ¯•ç«Ÿ co + generator åªæ˜¯ä¸€ä¸ªè¿‡æ¸¡äº§ç‰©ã€‚ 3.2.6 async + bluebirdå¦‚æœæ˜¯ä½¿ç”¨ async&#x2F;await + bluebird çš„æƒ…å†µå‘¢ï¼Ÿä»£ç å¦‚ä¸‹ï¼š async_bluebird.js 1234567891011121314151617181920212223242526const fs = require(&#x27;fs&#x27;)const profiler = require(&#x27;v8-profiler&#x27;)const Promise = require(&#x27;bluebird&#x27;)async function A () &#123; return await Promise.resolve(&#x27;A&#x27;)&#125;async function B () &#123; return await A()&#125;(async function asyncBluebirdWrap () &#123; const start = Date.now() profiler.startProfiling() while (Date.now() - start &lt; 10000) &#123; await B() &#125; const profile = profiler.stopProfiling() profile.export() .pipe(fs.createWriteStream(&#x27;async_bluebird.cpuprofile&#x27;)) .on(&#x27;finish&#x27;, () =&gt; &#123; profile.delete() console.error(&#x27;async_bluebird.cpuprofile export success&#x27;) &#125;)&#125;)() ç»“è®ºï¼šè°ƒç”¨æ ˆæ¯” co_blueblird.js çš„è¿˜ä¹±ã€‚ 3.2.7 å‚è€ƒé“¾æ¥ https://medium.com/@markherhold/generators-vs-async-await-performance-806d8375a01a","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 3.1 PromiseA standard","slug":"3.1.1 PromiseA+ è§„èŒƒ","date":"2019-04-21T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/21/3.1.1 PromiseA+ è§„èŒƒ/","link":"","permalink":"https://marvinliu1.github.io/2019/04/21/3.1.1%20PromiseA+%20%E8%A7%84%E8%8C%83/","excerpt":"","text":"Node in Debugging å¦‚ä½•å†™å‡ºæ¸…æ™°ä¼˜é›…çš„ä»£ç ä¹Ÿæ˜¯è°ƒè¯•é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œè€Œåœ¨è¿‡å»å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ï¼ŒJavaScript æœ€ä»¤äººåæ§½çš„å°±æ˜¯å›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰äº†ã€‚å…ˆçœ‹ä¸€æ®µä»£ç ï¼š 12345678910111213141516171819step1(function (err, value1) &#123; if (err) &#123; ... return &#125; step2(value1, function (err, value2) &#123; if (err) &#123; ... return &#125; step3(value2, function (err, value3) &#123; if (err) &#123; ... return &#125; // Do something with value3 &#125;) &#125;)&#125;) ä¸Šé¢ä»£ç ä¾æ¬¡æ‰§è¡Œ step1ã€step2ã€step3ï¼Œä¸”åä¸€ä¸ªå‡½æ•°ç”¨åˆ°äº†å‰ä¸€ä¸ªå‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ŒçœŸå®ç¯å¢ƒä¸‹å¯èƒ½ä¼šå†™å‡ºåµŒå¥—æ›´æ·±çš„å›è°ƒå‡½æ•°ï¼Œä»£ç å½¢æˆä¸€ä¸ªå€’é‡‘å­—å¡”ã€‚å¦‚æœä½¿ç”¨ Promiseï¼Œä»£ç å°±ä¼˜é›…å¾ˆå¤šäº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456step1() .then(step2) .then(step3) .catch((e) =&gt; &#123; // Do something with error &#125;) Promise çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå®ƒæœ€æ—©æ˜¯ç”±ç¤¾åŒºæå‡ºå’Œå®ç°çš„ï¼Œè¡ç”Ÿçš„è§„èŒƒä¹Ÿæœ‰å¾ˆå¤šï¼Œæœ€ç»ˆ ES6 é‡‡ç”¨äº† Promise&#x2F;A+ è§„èŒƒï¼Œå¹¶å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ã€‚ 3.1.1 Promise&#x2F;A+ è§„èŒƒPromise è§„èŒƒæœ‰å¾ˆå¤šï¼Œå¦‚ Promise&#x2F;Aï¼ŒPromise&#x2F;Bï¼ŒPromise&#x2F;D ä»¥åŠ Promise&#x2F;A çš„å‡çº§ç‰ˆ Promise&#x2F;A+ï¼Œç»†èŠ‚å„æœ‰ä¸åŒï¼Œæœ€ç»ˆ ES6 ä¸­é‡‡ç”¨äº† Promise&#x2F;A+ è§„èŒƒã€‚åœ¨è®²è§£ Promise å®ç°ä¹‹å‰ï¼Œå½“ç„¶è¦å…ˆäº†è§£ Promise&#x2F;A+ è§„èŒƒï¼ŒPromise&#x2F;A+ è§„èŒƒå‚è€ƒï¼š è‹±æ–‡ç‰ˆï¼šhttps://promisesaplus.com/ ä¸­æ–‡ç‰ˆï¼šhttp://www.ituring.com.cn/article/66566 è§„èŒƒè™½ç„¶ä¸é•¿ï¼Œä½†ç»†èŠ‚ä¹Ÿæ¯”è¾ƒå¤šï¼Œç¬”è€…æŒ‘å‡ºå‡ ä¸ªè¦ç‚¹ç®€å•è¯´æ˜ä¸€ä¸‹ï¼š Promise æœ¬è´¨æ˜¯ä¸€ä¸ªçŠ¶æ€æœºã€‚æ¯ä¸ª promise åªèƒ½æ˜¯ 3 ç§çŠ¶æ€ä¸­çš„ä¸€ç§ï¼špendingã€fulfilled æˆ– rejectedã€‚çŠ¶æ€è½¬å˜åªèƒ½æ˜¯ pending -&gt; fulfilled æˆ–è€… pending -&gt; rejectedã€‚çŠ¶æ€è½¬å˜ä¸å¯é€†ã€‚ then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡ã€‚ then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promiseï¼Œä»è€Œå¯ä»¥å®ç°é“¾å¼è°ƒç”¨ã€‚ å€¼ç©¿é€ã€‚ä¸‹é¢ä¼šè®²ã€‚ Promise çš„ API å¹¶ä¸å¤šï¼Œä½†æ˜¯ Promise å¹¶ä¸ç®€å•ï¼Œå¦‚ä½•å½»åº•ç†è§£å¹¶ç©è½¬ Promise å‘¢ï¼Ÿå½“ç„¶æ˜¯ä»å¤´å®ç°ä¸€é Promise å•¦ã€‚æˆ‘ä»¬å‡è®¾è¯»è€…å·²ç»ç†Ÿæ‚‰äº† Promise çš„åŸºæœ¬ç”¨æ³•ï¼Œæœ¬èŠ‚å†…å®¹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†è®²è§£å¦‚ä½•ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ª Promiseï¼Œç¬¬äºŒéƒ¨åˆ†é€šè¿‡åé“é¢˜å·©å›ºè¯»è€…å¯¹ Promise çš„ç†è§£ã€‚ 3.1.2 ä»é›¶å¼€å§‹å®ç° Promiseæˆ‘ä»¬çŸ¥é“ Promise æ˜¯æœ¬è´¨æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œéœ€è¦ç”¨ new è°ƒç”¨ï¼Œå¹¶æœ‰ä»¥ä¸‹å‡ ä¸ª apiï¼š 123456789function Promise (resolver) &#123;&#125;Promise.prototype.then = function () &#123;&#125;Promise.prototype.catch = function () &#123;&#125;Promise.resolve = function () &#123;&#125;Promise.reject = function () &#123;&#125;Promise.all = function () &#123;&#125;Promise.race = function () &#123;&#125; åˆ›å»ºä»¥ä¸‹åˆå§‹ä»£ç ï¼Œç„¶åå¼€å§‹ä¸€æ­¥ä¸€æ­¥æ„å»ºå®Œæ•´çš„ Promise å®ç°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819202122232425262728function INTERNAL () &#123;&#125;function isFunction (func) &#123; return typeof func === &#x27;function&#x27;&#125;function isObject (obj) &#123; return typeof obj === &#x27;object&#x27;&#125;function isArray (arr) &#123; return Array.isArray(arr)&#125;const PENDING = &#x27;pending&#x27;const FULFILLED = &#x27;fulfilled&#x27;const REJECTED = &#x27;rejected&#x27;module.exports = Promisefunction Promise (resolver) &#123; if (!isFunction(resolver)) &#123; throw new TypeError(&#x27;resolver must be a function&#x27;) &#125; this.state = PENDING this.value = void 0 this.queue = [] if (resolver !== INTERNAL) &#123; safelyResolveThen(this, resolver) &#125;&#125; æ³¨æ„ï¼šä»¥ä¸‹ promise å‡æŒ‡ä»£ Promise å®ä¾‹ã€‚ INTERNAL å°±æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œåé¢ä¼šç”¨æ¥ä¼ å…¥ Promise æ„é€ å‡½æ•°ç”Ÿæˆä¸€ä¸ª promise å®ä¾‹ã€‚å®šä¹‰äº† 3 ä¸ªè¾…åŠ©å‡½æ•°ï¼šisFunctionã€isObject å’Œ isArrayã€‚å®šä¹‰äº† 3 ç§çŠ¶æ€ï¼šPENDINGã€FULFILLED å’Œ REJECTEDã€‚safelyResolveThen åé¢ä¼šè®²ã€‚promise å†…éƒ¨æœ‰ä¸‰ä¸ªå˜é‡ï¼š stateï¼šå½“å‰ promise çš„çŠ¶æ€ï¼Œåˆå§‹å€¼ä¸º PENDINGã€‚çŠ¶æ€æ”¹å˜åªèƒ½æ˜¯ PENDING -&gt; FULFILLED æˆ– PENDING -&gt; REJECTEDã€‚ valueï¼šåˆå§‹å€¼æ˜¯ void 0ï¼ˆå³ undefinedï¼‰ï¼Œå½“ state æ˜¯ FULFILLED æ—¶å­˜å‚¨è¿”å›å€¼ï¼Œå½“ state æ˜¯ REJECTED æ—¶å­˜å‚¨é”™è¯¯ã€‚ queueï¼špromise å†…éƒ¨çš„å›è°ƒé˜Ÿåˆ—ï¼Œåé¢ä¼šè®²å®ƒçš„ä½œç”¨ã€‚ 3.1.3 Promise å®ç°åŸç†ç¬”è€…å‘å¸ƒäº†ä¸€ä¸ª Promise&#x2F;A+ è§„èŒƒå®ç°çš„æ¨¡å—â€”â€”appointï¼Œæˆ‘ä»¬æ‹¿è¿™ä¸ªæ¨¡å—ç ”ç©¶ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•å®ç° Promise çš„ã€‚çœ‹ä¸€æ®µä»£ç ï¼š 1234567891011const Promise = require(&#x27;appoint&#x27;)const promise = new Promise((resolve) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)const a = promise.then(function onSuccess () &#123;&#125;)const b = promise.catch(function onError () &#123;&#125;)console.dir(promise, &#123; depth: 10 &#125;)console.log(promise.queue[0].promise === a)console.log(promise.queue[1].promise === b) è¿è¡Œåæ‰“å°å‡ºï¼š 1234567891011121314Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [ QueueItem &#123; promise: Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [] &#125;, callFulfilled: [Function], callRejected: [Function] &#125;, QueueItem &#123; promise: Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [] &#125;, callFulfilled: [Function], callRejected: [Function] &#125; ] &#125;truetrue æ³¨æ„ï¼šåŸç”Ÿ Promise æ˜¯æ²¡æœ‰ queue å±æ€§çš„ï¼Œappoint çš„å®ç°ä¸­æ·»åŠ äº†è¿™ä¸ªå±æ€§ã€‚ å¯ä»¥çœ‹å‡ºï¼Œqueue æ•°ç»„ä¸­æœ‰ä¸¤ä¸ªå¯¹è±¡ã€‚å› ä¸ºè§„èŒƒä¸­è§„å®šï¼šthen æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡ã€‚ä¸Šä¾‹ä¸­åœ¨è°ƒç”¨ .then å’Œ .catch æ—¶ promise å¹¶æ²¡æœ‰è¢« resolveï¼Œæ‰€ä»¥å°† .then å’Œ .catch ç”Ÿæˆçš„æ–° promiseï¼ˆa å’Œ bï¼‰ å’Œæ­£ç¡®æ—¶çš„å›è°ƒï¼ˆonSuccess åŒ…è£…æˆ callFulfilledï¼‰å’Œé”™è¯¯æ—¶çš„å›è°ƒï¼ˆonError åŒ…è£…æˆ callRejectedï¼‰ç”Ÿæˆä¸€ä¸ª QueueItem å®ä¾‹å¹¶ push åˆ° queue æ•°ç»„é‡Œï¼Œæ‰€ä»¥ä¸¤ä¸ª console.log éƒ½æ‰“å° trueã€‚å½“ promise çŠ¶æ€æ”¹å˜æ—¶éå†å†…éƒ¨ queue æ•°ç»„ï¼Œç»Ÿä¸€æ‰§è¡ŒæˆåŠŸï¼ˆcallFulfilledï¼‰æˆ–å¤±è´¥ï¼ˆcallRejectedï¼‰çš„å›è°ƒï¼ˆä¼ å…¥ promise çš„ value å€¼ï¼‰ï¼Œç”Ÿæˆçš„ç»“æœåˆ†åˆ«è®¾ç½® a å’Œ b çš„ state å’Œ valueï¼Œè¿™å°±æ˜¯ Promise å®ç°çš„åŸºæœ¬åŸç†ã€‚ å†æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼š 1234567891011const Promise = require(&#x27;appoint&#x27;)const promise = new Promise((resolve) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)promise .then(() =&gt; &#123;&#125;) .then(() =&gt; &#123;&#125;) .then(() =&gt; &#123;&#125;)console.dir(promise, &#123; depth: 10 &#125;) æ‰“å°å‡ºï¼š 123456789101112131415161718192021222324Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [ QueueItem &#123; promise: Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [ QueueItem &#123; promise: Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [ QueueItem &#123; promise: Promise &#123; state: &#x27;pending&#x27;, value: undefined, queue: [] &#125;, callFulfilled: [Function], callRejected: [Function] &#125; ] &#125;, callFulfilled: [Function], callRejected: [Function] &#125; ] &#125;, callFulfilled: [Function], callRejected: [Function] &#125; ] &#125; é“¾å¼è°ƒç”¨äº† 3 æ¬¡ .thenï¼Œæ¯æ¬¡è°ƒç”¨ .then å°†å®ƒç”Ÿæˆçš„ promise æ”¾åˆ°äº†è°ƒç”¨å®ƒçš„ promise é˜Ÿåˆ—é‡Œï¼Œå½¢æˆäº† 3 å±‚è°ƒç”¨å…³ç³»ã€‚å½“æœ€å¤–å±‚çš„ promise çŠ¶æ€æ”¹å˜æ—¶ï¼Œéå†å®ƒçš„ queue æ•°ç»„è°ƒç”¨å¯¹åº”çš„å›è°ƒï¼Œè®¾ç½®å­ promise çš„ state å’Œ value å¹¶éå†å®ƒçš„ queue æ•°ç»„è°ƒç”¨å¯¹åº”çš„å›è°ƒâ€¦â€¦ä»¥æ­¤ç±»æ¨ã€‚ æ³¨æ„ï¼šè¿™é‡Œ queue æ˜¯åµŒå¥—çš„ï¼Œè€Œä¸æ˜¯åƒä¸Šä¸ªä¾‹å­ä¸­ queue æ˜¯å¹³é“ºçš„ã€‚ 3.1.4 safelyResolveThenæ¥ä¸‹æ¥å®Œæˆ safelyResolveThen çš„é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324function safelyResolveThen (self, then) &#123; let called = false try &#123; then(function (value) &#123; if (called) &#123; return &#125; called = true doResolve(self, value) &#125;, function (error) &#123; if (called) &#123; return &#125; called = true doReject(self, error) &#125;) &#125; catch (error) &#123; if (called) &#123; return &#125; called = true doReject(self, error) &#125;&#125; safelyResolveThen é¡¾åæ€ä¹‰ç”¨æ¥ â€œå®‰å…¨çš„æ‰§è¡Œ then å‡½æ•°â€ï¼Œè¿™é‡Œçš„ then å‡½æ•°æŒ‡ â€œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ resolve å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯ reject å‡½æ•°çš„å‡½æ•°â€ï¼Œé€‚ç”¨äºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œå³è¿™é‡Œçš„ resolverï¼š 12345new Promise(function resolver (resolve, reject) &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;) promise çš„ thenï¼š 1promise.then(resolve, reject) safelyResolveThen æœ‰ 3 ä¸ªä½œç”¨ï¼š tryâ€¦catch ç”¨æ¥æ•è·å‡½æ•°å†…æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¦‚æ„é€ å‡½æ•°å†…æŠ›å‡ºå¼‚å¸¸ï¼š 123new Promise(function resolver (resolve, reject) &#123; throw new Error(&#x27;Oops&#x27;)&#125;) called æ§åˆ¶ resolve æˆ– reject åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚å³ï¼š 123456789const Promise = require(&#x27;appoint&#x27;)const promise = new Promise(function resolver (resolve, reject) &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000) reject(&#x27;error&#x27;)&#125;)promise.then(console.log)promise.catch(console.error) æ‰“å° errorï¼Œä¸ä¼šå†æ‰“å° hahaã€‚ æ²¡æœ‰é”™è¯¯åˆ™æ‰§è¡Œ doResolveï¼Œæœ‰é”™è¯¯åˆ™æ‰§è¡Œ doRejectã€‚ 3.1.5 doResolve å’Œ doRejectdoResolve å’Œ doReject ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526function doResolve (self, value) &#123; try &#123; const then = getThen(value) if (then) &#123; safelyResolveThen(self, then) &#125; else &#123; self.state = FULFILLED self.value = value self.queue.forEach(function (queueItem) &#123; queueItem.callFulfilled(value) &#125;) &#125; return self &#125; catch (error) &#123; return doReject(self, error) &#125;&#125;function doReject (self, error) &#123; self.state = REJECTED self.value = error self.queue.forEach(function (queueItem) &#123; queueItem.callRejected(error) &#125;) return self&#125; doReject ç”¨æ¥è®¾ç½® promise çš„ state ä¸º REJECTEDï¼Œvalue ä¸º errorï¼Œç„¶åéå† queueï¼Œè®¾ç½®æ‰€æœ‰å­ promise çš„çŠ¶æ€ä¸º REJECTED å’Œå€¼ä¸º errorã€‚doResolve ç»“åˆ safelyResolveThen ä½¿ç”¨ä¸æ–­åœ°è§£åŒ… promiseï¼Œç›´è‡³è¿”å›å€¼æ˜¯é promise å¯¹è±¡åï¼Œè®¾ç½® promise çš„çŠ¶æ€å’Œå€¼ï¼Œç„¶åè®¾ç½®å­ promise çš„çŠ¶æ€å’Œå€¼ã€‚ è¿™é‡Œæœ‰ä¸ªè¾…åŠ©å‡½æ•° getThenï¼š 12345678function getThen (promise) &#123; const then = promise &amp;&amp; promise.then if (promise &amp;&amp; (isObject(promise) || isFunction(promise)) &amp;&amp; isFunction(then)) &#123; return function applyThen () &#123; then.apply(promise, arguments) &#125; &#125;&#125; getThen å®ç°äº†è§„èŒƒä¸­è§„å®šçš„ï¼šå¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† xï¼ˆå³è¢«è°ƒç”¨çš„ promiseï¼‰ ä½œä¸ºå‡½æ•°çš„ this è°ƒç”¨ã€‚ 3.1.6 Promise.prototype.then å’Œ Promise.prototype.catchæ¥ä¸‹æ¥å®ç° Promise.prototype.then å’Œ Promise.prototype.catchï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718Promise.prototype.then = function (onFulfilled, onRejected) &#123; if ((!isFunction(onFulfilled) &amp;&amp; this.state === FULFILLED) || (!isFunction(onRejected) &amp;&amp; this.state === REJECTED)) &#123; return this &#125; const promise = new this.constructor(INTERNAL) if (this.state !== PENDING) &#123; const resolver = this.state === FULFILLED ? onFulfilled : onRejected unwrap(promise, resolver, this.value) &#125; else &#123; this.queue.push(new QueueItem(promise, onFulfilled, onRejected)) &#125; return promise&#125;Promise.prototype.catch = function (onRejected) &#123; return this.then(null, onRejected)&#125; ä¸Šè¿°ä»£ç ä¸­çš„ return this å®ç°äº†å€¼ç©¿é€ï¼Œåé¢ä¼šç»†è®²ã€‚å¯ä»¥çœ‹å‡ºï¼Œthen æ–¹æ³•ä¸­ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„ promise ç„¶åè¿”å›ã€‚å¦‚æœ promise çš„çŠ¶æ€æ”¹å˜äº†ï¼Œåˆ™è°ƒç”¨ unwrapï¼Œå¦åˆ™å°†ç”Ÿæˆçš„ promise åŠ å…¥åˆ°å½“å‰ promise çš„å›è°ƒé˜Ÿåˆ— queue é‡Œï¼Œä¹‹å‰å·²ç»è®²è§£äº†å¦‚ä½•æ¶ˆè´¹ queueã€‚æœ‰ 3 ç‚¹éœ€è¦è®²è§£ï¼š Promise æ„é€ å‡½æ•°ä¼ å…¥äº†ä¸€ä¸ª INTERNAL ç©ºå‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªæ–°äº§ç”Ÿçš„ promise å¯ä»¥è®¤ä¸ºæ˜¯å†…éƒ¨çš„ promiseï¼Œéœ€è¦æ ¹æ®å¤–éƒ¨çš„ promise çš„çŠ¶æ€å’Œå€¼äº§ç”Ÿè‡ªèº«çš„çŠ¶æ€å’Œå€¼ï¼Œä¸éœ€è¦ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œè€Œå¤–éƒ¨ Promise éœ€è¦ä¼ å…¥å›è°ƒå‡½æ•°å†³å®šå®ƒçš„çŠ¶æ€å’Œå€¼ï¼Œæ‰€ä»¥ä¹‹å‰ Promise çš„æ„é€ å‡½æ•°é‡Œåšäº†åˆ¤æ–­åŒºåˆ†å¤–éƒ¨è°ƒç”¨è¿˜æ˜¯å†…éƒ¨è°ƒç”¨ï¼š 123if (resolver !== INTERNAL) &#123; safelyResolveThen(this, resolver)&#125; QueueItem ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819function QueueItem (promise, onFulfilled, onRejected) &#123; this.promise = promise this.callFulfilled = function (value) &#123; doResolve(this.promise, value) &#125; this.callRejected = function (error) &#123; doReject(this.promise, error) &#125; if (isFunction(onFulfilled)) &#123; this.callFulfilled = function (value) &#123; unwrap(this.promise, onFulfilled, value) &#125; &#125; if (isFunction(onRejected)) &#123; this.callRejected = function (error) &#123; unwrap(this.promise, onRejected, error) &#125; &#125;&#125; promise ä¸º then ç”Ÿæˆçš„æ–° promiseï¼ŒonFulfilled å’Œ onRejected å³æ˜¯ then å‚æ•°ä¸­çš„ onFulfilled å’Œ onRejectedã€‚ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼šå½“ promise çŠ¶æ€å˜ä¸º FULFILLED æ—¶ï¼Œä¹‹å‰æ³¨å†Œçš„ then å‡½æ•°é€šè¿‡ callFulfilled è°ƒç”¨ unwrap è¿›è¡Œè§£åŒ…æœ€ç»ˆå¾—å‡º promise çš„çŠ¶æ€å’Œå€¼ï¼›ä¹‹å‰æ³¨å†Œçš„ catch å‡½æ•°ï¼Œç”¨ callRejected ç›´æ¥è°ƒç”¨ doRejectï¼Œè®¾ç½®é˜Ÿåˆ—é‡Œ promise çš„çŠ¶æ€å’Œå€¼ã€‚å½“ promise çŠ¶æ€å˜ä¸º REJECTED ç±»ä¼¼ã€‚ unwrap ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415function unwrap (promise, func, value) &#123; process.nextTick(function () &#123; let returnValue try &#123; returnValue = func(value) &#125; catch (error) &#123; return doReject(promise, error) &#125; if (returnValue === promise) &#123; doReject(promise, new TypeError(&#x27;Cannot resolve promise with itself&#x27;)) &#125; else &#123; doResolve(promise, returnValue) &#125; &#125;)&#125; unwrap å‡½æ•°ä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºæ˜¯ç”¨æ¥è§£åŒ…çš„ï¼Œå³æ‹¿åˆ°çˆ¶ promise çš„ç»“æœè®¾ç½®å½“å‰ promise çš„çŠ¶æ€å’Œå€¼ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ promiseï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯çˆ¶ promise çš„ then çš„å›è°ƒï¼ˆonFulfilled&#x2F;onRejectedï¼‰ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯çˆ¶ promise çš„å€¼ï¼ˆæ­£å¸¸å€¼&#x2F;é”™è¯¯ï¼‰ã€‚æœ‰ 3 ç‚¹éœ€è¦è¯´æ˜ï¼š ä½¿ç”¨ process.nextTick å°†ä»£ç å¼‚æ­¥æ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯è§„èŒƒé‡Œæ˜ç¡®è§„å®šçš„ã€‚çœ‹ä¸€æ®µä»£ç ï¼š 123456789101112const Promise = require(&#x27;appoint&#x27;)const promise = new Promise((resolve, reject) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)promise.then(() =&gt; &#123; promise.then(() =&gt; &#123; console.log(&#x27;1&#x27;) &#125;) console.log(&#x27;2&#x27;)&#125;) æ‰“å° 2 1ï¼Œå»æ‰ process.nextTick åˆ™æ‰“å° 1 2ã€‚ tryâ€¦catch ç”¨æ¥æ•è· then&#x2F;catch å‡½æ•°å†…æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¹¶è°ƒç”¨ doRejectï¼Œå¦‚ï¼š 123456promise.then(() =&gt; &#123; throw new Error(&#x27;haha&#x27;)&#125;)promise.catch(() =&gt; &#123; throw new Error(&#x27;haha&#x27;)&#125;) è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ï¼Œå¦‚ä¸‹ä»£ç ï¼š 12345678910const promise = new Promise((resolve, reject) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)const a = promise.then(() =&gt; &#123; return a&#125;)a.catch(console.log)// [TypeError: Chaining cycle detected for promise #&lt;Promise&gt;] æ³¨æ„ï¼špromise.catch(onRejected) å°±æ˜¯ promise.then(null, onRejected) çš„è¯­æ³•ç³–ã€‚ è‡³æ­¤ï¼ŒPromise çš„æ ¸å¿ƒéƒ¨åˆ†å°±å®ç°å®Œäº†ã€‚ 3.1.7 å€¼ç©¿é€ä¸Šé¢æåˆ°è¿‡å¥½å‡ æ¬¡å€¼ç©¿é€ï¼Œä»€ä¹ˆæ˜¯å€¼ç©¿é€å‘¢ï¼Ÿä¸Šé¢çš„ Promise.prototype.then çš„å®ç°ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š 1234567Promise.prototype.then = function (onFulfilled, onRejected) &#123; if ((!isFunction(onFulfilled) &amp;&amp; this.state === FULFILLED) || (!isFunction(onRejected) &amp;&amp; this.state === REJECTED)) &#123; return this &#125; ...&#125;; å€¼ç©¿é€å³ä¼ å…¥ then&#x2F;catch çš„å‚æ•°å¦‚æœä¸ä¸ºå‡½æ•°ï¼Œåˆ™å¿½ç•¥è¯¥å€¼ï¼Œè¿”å›ä¸Šä¸€ä¸ª promise çš„ç»“æœã€‚çœ‹ä¸€æ®µä»£ç ï¼š 12345678const promise = new Promise((resolve, reject) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)promise .then(&#x27;hehe&#x27;) .then(console.log) æœ€ç»ˆæ‰“å° haha è€Œä¸æ˜¯ heheã€‚ é€šè¿‡ return this åªå®ç°äº†å€¼ç©¿é€çš„ä¸€ç§æƒ…å†µï¼Œå…¶å®å€¼ç©¿é€æœ‰ä¸¤ç§æƒ…å†µï¼š promise å·²ç»æ˜¯ FULFILLED&#x2F;REJECTED æ—¶ï¼Œé€šè¿‡ return this å®ç°çš„å€¼ç©¿é€ï¼š 12345678910111213141516const Promise = require(&#x27;appoint&#x27;)const promise = new Promise(function (resolve) &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)promise.then(() =&gt; &#123; promise.then().then((res) =&gt; &#123;// (1) console.log(res)// haha &#125;) promise.catch().then((res) =&gt; &#123;// (2) console.log(res)// haha &#125;) console.log(promise.then() === promise.catch())// true console.log(promise.then(1) === promise.catch(&#123; name: &#x27;nswbmw&#x27; &#125;))// true&#125;) ä¸Šè¿°ä»£ç  (1)ã€(2) å¤„ promise å·²ç»æ˜¯ FULFILLED äº†ç¬¦åˆæ¡ä»¶æ‰€ä»¥æ‰§è¡Œäº† return thisã€‚ promise æ˜¯ PENDING æ—¶ï¼Œé€šè¿‡ç”Ÿæˆæ–°çš„ promise åŠ å…¥åˆ°çˆ¶ promise çš„ queueï¼Œçˆ¶ promise çŠ¶æ€æ”¹å˜æ—¶è°ƒç”¨ callFulfilled-&gt;doResolve æˆ– callRejected-&gt;doRejectï¼ˆå› ä¸º then&#x2F;catch ä¼ å…¥çš„å‚æ•°ä¸æ˜¯å‡½æ•°ï¼‰è®¾ç½®å­ promise çš„çŠ¶æ€å’Œå€¼ä¸ºçˆ¶ promise çš„çŠ¶æ€å’Œå€¼ã€‚çœ‹ä¸€æ®µä»£ç ï¼š 123456789101112131415const Promise = require(&#x27;appoint&#x27;)const promise = new Promise((resolve) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;haha&#x27;) &#125;, 1000)&#125;)const a = promise.then()a.then((res) =&gt; &#123; console.log(res)// haha&#125;)const b = promise.catch()b.then((res) =&gt; &#123; console.log(res)// haha&#125;)console.log(a === b)// false 3.1.8 Promise.resolve å’Œ Promise.rejectPromise.resolve å’Œ Promise.reject æ˜¯ Promise çš„ä¸¤ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨æ¥å¿«æ·çš„ç”Ÿæˆä¸€ä¸ªçŠ¶æ€ä¸º fulfilled æˆ–è€… rejected çš„ promise å®ä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š 123456789101112Promise.resolve = resolvefunction resolve (value) &#123; if (value instanceof this) &#123; return value &#125; return doResolve(new this(INTERNAL), value)&#125;Promise.reject = rejectfunction reject (reason) &#123; return doReject(new this(INTERNAL), reason)&#125; å½“ Promise.resolve å‚æ•°æ˜¯ä¸€ä¸ª promise æ—¶ï¼Œç›´æ¥è¿”å›è¯¥å€¼ã€‚ 3.1.9 Promise.allPromise.all æ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥å¹¶è¡Œæ‰§è¡Œä¸€ç»„ promiseã€‚ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738Promise.all = allfunction all (iterable) &#123; const self = this if (!isArray(iterable)) &#123; return this.reject(new TypeError(&#x27;must be an array&#x27;)) &#125; const len = iterable.length let called = false if (!len) &#123; return this.resolve([]) &#125; const values = new Array(len) let resolved = 0 let i = -1 const promise = new this(INTERNAL) while (++i &lt; len) &#123; allResolver(iterable[i], i) &#125; return promise function allResolver (value, i) &#123; self.resolve(value).then(resolveFromAll, function (error) &#123; if (!called) &#123; called = true doReject(promise, error) &#125; &#125;) function resolveFromAll (outValue) &#123; values[i] = outValue if (++resolved === len &amp;&amp; !called) &#123; called = true doResolve(promise, values) &#125; &#125; &#125;&#125; Promise.all ç”¨æ¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ª promise&#x2F;å€¼ï¼Œå½“æ‰€æœ‰ promise&#x2F;å€¼æ‰§è¡Œå®Œæ¯•æˆ–æœ‰ä¸€ä¸ª promise çŠ¶æ€å˜ä¸º rejected æ—¶è¿”å›ã€‚ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼š Promise.all å†…éƒ¨ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„ promise è¿”å›ã€‚ called ç”¨æ¥æ§åˆ¶å³ä½¿æœ‰å¤šä¸ª promise rejected ä¹Ÿåªæœ‰ç¬¬ä¸€ä¸ªç”Ÿæ•ˆã€‚ values ç”¨æ¥å­˜å‚¨æ‰§è¡Œç»“æœã€‚ å½“æœ€åä¸€ä¸ª promise çŠ¶æ€æ”¹å˜åï¼Œä½¿ç”¨ doResolve(promise, values) è®¾ç½® promise çš„ state ä¸º FULFILLEDï¼Œvalue ä¸ºç»“æœæ•°ç»„ valuesã€‚ 3.1.10 Promise.racePromise.race æ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œå½“æ•°ç»„ä¸­æœ‰ä¸€ä¸ª promise çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼ˆ pending -&gt; fulfilled&#x2F;rejectedï¼‰æ—¶è¿”å›ã€‚ 12345678910111213141516171819202122232425262728293031323334Promise.race = racefunction race (iterable) &#123; const self = this if (!isArray(iterable)) &#123; return this.reject(new TypeError(&#x27;must be an array&#x27;)) &#125; const len = iterable.length let called = false if (!len) &#123; return this.resolve([]) &#125; let i = -1 const promise = new this(INTERNAL) while (++i &lt; len) &#123; resolver(iterable[i]) &#125; return promise function resolver (value) &#123; self.resolve(value).then(function (response) &#123; if (!called) &#123; called = true doResolve(promise, response) &#125; &#125;, function (error) &#123; if (!called) &#123; called = true doReject(promise, error) &#125; &#125;) &#125;&#125; Promise.race ä¸ Promise.all ä»£ç ç›¸è¿‘ï¼Œåªä¸è¿‡è¿™é‡Œç”¨ called æ§åˆ¶åªè¦æœ‰ä»»ä½•ä¸€ä¸ª promise çŠ¶æ€æ”¹å˜åˆ™ç«‹å³å»è®¾ç½®è¿”å›çš„ promise çš„çŠ¶æ€å’Œå€¼ã€‚ è‡³æ­¤ï¼ŒPromise çš„å®ç°å…¨éƒ¨è®²è§£å®Œæ¯•ã€‚ 3.1.11 åé“é¢˜ç°åœ¨ï¼Œæˆ‘ä»¬ä»¥åé“é¢˜å·©å›ºä¸€ä¸‹å‰é¢æ‰€å­¦åˆ°çš„ Promise çš„çŸ¥è¯†ç‚¹ã€‚ é¢˜ç›®ä¸€123456789const promise = new Promise((resolve, reject) =&gt; &#123; console.log(1) resolve() console.log(2)&#125;)promise.then(() =&gt; &#123; console.log(3)&#125;)console.log(4) è¿è¡Œç»“æœï¼š 12341243 è§£é‡Šï¼šPromise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œpromise.then ä¸­çš„å‡½æ•°æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚ é¢˜ç›®äºŒ12345678910111213141516const promise1 = new Promise((resolve, reject) =&gt; &#123; setTimeout(() =&gt; &#123; resolve(&#x27;success&#x27;) &#125;, 1000)&#125;)const promise2 = promise1.then(() =&gt; &#123; throw new Error(&#x27;error!!!&#x27;)&#125;)console.log(&#x27;promise1&#x27;, promise1)console.log(&#x27;promise2&#x27;, promise2)setTimeout(() =&gt; &#123; console.log(&#x27;promise1&#x27;, promise1) console.log(&#x27;promise2&#x27;, promise2)&#125;, 2000) è¿è¡Œç»“æœï¼š 123456789promise1 Promise &#123; &lt;pending&gt; &#125;promise2 Promise &#123; &lt;pending&gt; &#125;(node:50928) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: error!!!(node:50928) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.promise1 Promise &#123; &#x27;success&#x27; &#125;promise2 Promise &#123; &lt;rejected&gt; Error: error!!! at promise.then (...) at &lt;anonymous&gt; &#125; è§£é‡Šï¼špromise æœ‰ 3 ç§çŠ¶æ€ï¼špendingã€fulfilled æˆ– rejectedã€‚çŠ¶æ€æ”¹å˜åªèƒ½æ˜¯ pending-&gt;fulfilled æˆ–è€… pending-&gt;rejectedï¼ŒçŠ¶æ€ä¸€æ—¦æ”¹å˜åˆ™ä¸èƒ½å†å˜ã€‚ä¸Šé¢çš„ promise2 å¹¶ä¸æ˜¯ promise1ï¼Œè€Œæ˜¯è¿”å›çš„ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚ é¢˜ç›®ä¸‰12345678910111213const promise = new Promise((resolve, reject) =&gt; &#123; resolve(&#x27;success1&#x27;) reject(&#x27;error&#x27;) resolve(&#x27;success2&#x27;)&#125;)promise .then((res) =&gt; &#123; console.log(&#x27;then: &#x27;, res) &#125;) .catch((err) =&gt; &#123; console.log(&#x27;catch: &#x27;, err) &#125;) è¿è¡Œç»“æœï¼š 1then: success1 è§£é‡Šï¼šæ„é€ å‡½æ•°ä¸­çš„ resolve æˆ– reject åªæœ‰åœ¨ç¬¬ 1 æ¬¡æ‰§è¡Œæ—¶æœ‰æ•ˆï¼Œå¤šæ¬¡è°ƒç”¨æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œå†æ¬¡å°è¯ä»£ç äºŒçš„ç»“è®ºï¼špromise çŠ¶æ€ä¸€æ—¦æ”¹å˜åˆ™ä¸èƒ½å†å˜ã€‚ å†çœ‹ä¸¤ä¸ªä¾‹å­ï¼š 1234567891011const promise = new Promise((resolve, reject) =&gt; &#123; console.log(1) return Promise.reject(new Error(&#x27;haha&#x27;))&#125;)promise.then((res) =&gt; &#123; console.log(2, res)&#125;).catch((err) =&gt; &#123; console.error(3, err)&#125;)console.log(4)console.log(promise) è¿è¡Œç»“æœï¼š 1234567891011121314151614Promise &#123; &lt;pending&gt; &#125;(node:22493) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: haha(node:22493) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.const promise = new Promise((resolve, reject) =&gt; &#123; console.log(1) throw new Error(&#x27;haha&#x27;)&#125;)promise.then((res) =&gt; &#123; console.log(2, res)&#125;).catch((err) =&gt; &#123; console.error(3, err)&#125;)console.log(4)console.log(promise) è¿è¡Œç»“æœï¼š 12345678914Promise &#123; &lt;rejected&gt; Error: haha at Promise (/Users/nswbmw/Desktop/test/app.js:6:9) ...3 Error: haha at Promise (/Users/nswbmw/Desktop/test/app.js:6:9) ... è§£é‡Šï¼šæ„é€ å‡½æ•°å†…åªèƒ½é€šè¿‡è°ƒç”¨ resolve(pending-&gt;fullfiled) æˆ–è€… reject(pending-&gt;rejected) æˆ–è€… throw ä¸€ä¸ª error(pending-&gt;rejected) æ”¹å˜çŠ¶æ€ã€‚æ‰€ä»¥ç¬¬ä¸€ä¸ªä¾‹å­çš„ promise çŠ¶æ€æ˜¯ pendingï¼Œä¹Ÿå°±ä¸ä¼šè°ƒç”¨ .then&#x2F;.catchã€‚ é¢˜ç›®å››1234567891011Promise.resolve(1) .then((res) =&gt; &#123; console.log(res) return 2 &#125;) .catch((err) =&gt; &#123; return 3 &#125;) .then((res) =&gt; &#123; console.log(res) &#125;) è¿è¡Œç»“æœï¼š 1212 è§£é‡Šï¼špromise å¯ä»¥é“¾å¼è°ƒç”¨ã€‚æèµ·é“¾å¼è°ƒç”¨æˆ‘ä»¬é€šå¸¸ä¼šæƒ³åˆ°é€šè¿‡ return this å®ç°ï¼Œä¸è¿‡ Promise å¹¶ä¸æ˜¯è¿™æ ·å®ç°çš„ã€‚promise åœ¨æ¯æ¬¡è°ƒç”¨ .then æˆ–è€… .catch æ—¶éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ promiseï¼Œä»è€Œå¯ä»¥å®ç°é“¾å¼è°ƒç”¨ã€‚ é¢˜ç›®äº”1234567891011121314const promise = new Promise((resolve, reject) =&gt; &#123; setTimeout(() =&gt; &#123; console.log(&#x27;once&#x27;) resolve(&#x27;success&#x27;) &#125;, 1000)&#125;)const start = Date.now()promise.then((res) =&gt; &#123; console.log(res, Date.now() - start)&#125;)promise.then((res) =&gt; &#123; console.log(res, Date.now() - start)&#125;) è¿è¡Œç»“æœï¼š 123oncesuccess 1005success 1007 è§£é‡Šï¼špromise çš„ .then æˆ–è€… .catch å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ï¼Œä½†è¿™é‡Œ Promise æ„é€ å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ã€‚æˆ–è€…è¯´ï¼Œpromise å†…éƒ¨çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œåˆ™åç»­åœ¨æ¯æ¬¡è°ƒç”¨ .then æˆ–è€… .catch æ—¶éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚ é¢˜ç›®å…­12345678910Promise.resolve() .then(() =&gt; &#123; return new Error(&#x27;error!!!&#x27;) &#125;) .then((res) =&gt; &#123; console.log(&#x27;then: &#x27;, res) &#125;) .catch((err) =&gt; &#123; console.log(&#x27;catch: &#x27;, err) &#125;) è¿è¡Œç»“æœï¼š 123then: Error: error!!! at Promise.resolve.then (...) at ... è§£é‡Šï¼š.then æˆ–è€… .catch ä¸­ return ä¸€ä¸ª error å¯¹è±¡å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åç»­çš„ .catch æ•è·ï¼Œéœ€è¦æ”¹æˆå¦‚ä¸‹å…¶ä¸­ä¸€ç§ï¼š return Promise.reject(new Error(â€˜error!!!â€™)) throw new Error(â€˜error!!!â€™) å› ä¸ºè¿”å›ä»»æ„ä¸€ä¸ªé promise çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ promise å¯¹è±¡ï¼Œå³ return new Error(&#39;error!!!&#39;) ç­‰ä»·äº return Promise.resolve(new Error(&#39;error!!!&#39;))ã€‚ é¢˜ç›®ä¸ƒ12345const promise = Promise.resolve() .then(() =&gt; &#123; return promise &#125;)promise.catch(console.error) è¿è¡Œç»“æœï¼š 123456TypeError: Chaining cycle detected for promise #&lt;Promise&gt; at &lt;anonymous&gt; at process._tickCallback (internal/process/next_tick.js:188:7) at Function.Module.runMain (module.js:667:11) at startup (bootstrap_node.js:187:16) at bootstrap_node.js:607:3 è§£é‡Šï¼š.then æˆ– .catch è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚ç±»ä¼¼äºï¼š 1234process.nextTick(function tick () &#123; console.log(&#x27;tick&#x27;) process.nextTick(tick)&#125;) é¢˜ç›®å…«1234Promise.resolve(1) .then(2) .then(Promise.resolve(3)) .then(console.log) è¿è¡Œç»“æœï¼š 11 è§£é‡Šï¼š.then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼ç©¿é€ã€‚ é¢˜ç›®ä¹123456789Promise.resolve() .then(function success (res) &#123; throw new Error(&#x27;error&#x27;) &#125;, function fail1 (e) &#123; console.error(&#x27;fail1: &#x27;, e) &#125;) .catch(function fail2 (e) &#123; console.error(&#x27;fail2: &#x27;, e) &#125;) è¿è¡Œç»“æœï¼š 123fail2: Error: error at success (...) at ... è§£é‡Šï¼š.then å¯ä»¥æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ 1 ä¸ªæ˜¯å¤„ç†æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬ 2 ä¸ªæ˜¯å¤„ç†é”™è¯¯çš„å‡½æ•°ã€‚.catch æ˜¯ .then ç¬¬ 2 ä¸ªå‚æ•°çš„ç®€ä¾¿å†™æ³•ï¼Œä½†æ˜¯åœ¨ç”¨æ³•ä¸Šæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼š.then çš„ç¬¬ 2 ä¸ªå¤„ç†é”™è¯¯çš„å‡½æ•°ï¼ˆfail1ï¼‰æ•è·ä¸äº†ç¬¬ 1 ä¸ªå¤„ç†æˆåŠŸçš„å‡½æ•°ï¼ˆsuccessï¼‰æŠ›å‡ºçš„é”™è¯¯ï¼Œè€Œåç»­çš„ .catch æ–¹æ³•ï¼ˆfail2ï¼‰å¯ä»¥æ•è·ä¹‹å‰çš„é”™è¯¯ã€‚å½“ç„¶ï¼Œä»¥ä¸‹ä»£ç ä¹Ÿå¯ä»¥ï¼š 12345678910Promise.resolve() .then(function success1 (res) &#123; throw new Error(&#x27;error&#x27;) &#125;, function fail1 (e) &#123; console.error(&#x27;fail1: &#x27;, e) &#125;) .then(function success2 (res) &#123; &#125;, function fail2 (e) &#123; console.error(&#x27;fail2: &#x27;, e) &#125;) é¢˜ç›®å1234567891011Promise.resolve() .then(() =&gt; &#123; console.log(&#x27;then&#x27;) &#125;)process.nextTick(() =&gt; &#123; console.log(&#x27;nextTick&#x27;)&#125;)setImmediate(() =&gt; &#123; console.log(&#x27;setImmediate&#x27;)&#125;)console.log(&#x27;end&#x27;) è¿è¡Œç»“æœï¼š 1234endnextTickthensetImmediate è§£é‡Šï¼šprocess.nextTick å’Œ promise.then éƒ½å±äº microtaskï¼ˆä½† process.nextTick çš„ä¼˜å…ˆçº§å¤§äº promise.thenï¼‰ï¼Œè€Œ setImmediate å±äº macrotaskï¼Œåœ¨äº‹ä»¶å¾ªç¯çš„ check é˜¶æ®µæ‰§è¡Œã€‚äº‹ä»¶å¾ªç¯çš„æ¯ä¸ªé˜¶æ®µï¼ˆmacrotaskï¼‰ä¹‹é—´éƒ½ä¼šæ‰§è¡Œ microtaskï¼Œä»¥ä¸Šä»£ç æœ¬èº«ï¼ˆmacrotaskï¼‰åœ¨æ‰§è¡Œå®Œåä¼šæ‰§è¡Œä¸€æ¬¡ microtaskã€‚ 3.1.12 å‚è€ƒé“¾æ¥ http://es6.ruanyifeng.com/#docs/promise https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise https://promisesaplus.com/","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 2.4 Cpu-memory monitor","slug":"2.4.1 ä½¿ç”¨ cpu-memory-monitor","date":"2019-04-18T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/18/2.4.1 ä½¿ç”¨ cpu-memory-monitor/","link":"","permalink":"https://marvinliu1.github.io/2019/04/18/2.4.1%20%E4%BD%BF%E7%94%A8%20cpu-memory-monitor/","excerpt":"","text":"Node in Debugging å‰é¢ä»‹ç»äº† heapdump å’Œ memwatch-next çš„ç”¨æ³•ï¼Œä½†åœ¨å®é™…ä½¿ç”¨æ—¶å¹¶ä¸é‚£ä¹ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬æ€»ä¸èƒ½ä¸€ç›´ç›¯ç€æœåŠ¡å™¨çš„çŠ¶å†µï¼Œåœ¨å‘ç°å†…å­˜æŒç»­å¢é•¿å¹¶è¶…è¿‡å¿ƒé‡Œçš„é˜ˆå€¼æ—¶ï¼Œå†æ‰‹åŠ¨å»è§¦å‘ Core Dump å§ï¼Ÿåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å‘ç°é—®é¢˜æ—¶ï¼Œå°±å·²ç»é”™è¿‡äº†ç°åœºã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ cpu-memory-monitorã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ¨¡å—å¯ä»¥ç”¨æ¥ç›‘æ§ CPU å’Œ Memory çš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶å¯ä»¥æ ¹æ®é…ç½®ç­–ç•¥è‡ªåŠ¨ dump CPU çš„ä½¿ç”¨æƒ…å†µï¼ˆcpuprofileï¼‰å’Œå†…å­˜å¿«ç…§ï¼ˆheapsnapshotï¼‰ã€‚ 2.4.1 ä½¿ç”¨ cpu-memory-monitoræˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ cpu-memory-monitorï¼Œå…¶å®å¾ˆç®€å•ï¼Œåªéœ€åœ¨è¿›ç¨‹å¯åŠ¨çš„å…¥å£æ–‡ä»¶ä¸­å¼•å…¥ä»¥ä¸‹ä»£ç ï¼š 12345678910require(&#x27;cpu-memory-monitor&#x27;)(&#123; cpu: &#123; interval: 1000, duration: 30000, threshold: 60, profileDir: &#x27;/tmp&#x27;, counter: 3, limiter: [5, &#x27;hour&#x27;] &#125;&#125;) ä¸Šè¿°ä»£ç çš„ä½œç”¨æ˜¯ï¼šæ¯ 1000ms(interval)æ£€æŸ¥ä¸€æ¬¡ CPU çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœå‘ç°è¿ç»­ 3(counter)æ¬¡ CPU ä½¿ç”¨ç‡å¤§äº 60%(threshold)ï¼Œåˆ™ dump 30000ms(duration) CPU çš„ä½¿ç”¨æƒ…å†µï¼Œç”Ÿæˆ cpu-$&#123;process.pid&#125;-$&#123;Date.now()&#125;.cpuprofile åˆ° &#x2F;tmp(profileDir) ç›®å½•ä¸‹ï¼Œ1(limiter[1]) å°æ—¶æœ€å¤š dump 5(limiter[0]) æ¬¡ã€‚ ä»¥ä¸Šæ˜¯è‡ªåŠ¨ dump CPU ä½¿ç”¨æƒ…å†µçš„ç­–ç•¥ã€‚dump Memory ä½¿ç”¨æƒ…å†µçš„ç­–ç•¥åŒç†ï¼š 123456789require(&#x27;cpu-memory-monitor&#x27;)(&#123; memory: &#123; interval: 1000, threshold: &#x27;1.2gb&#x27;, profileDir: &#x27;/tmp&#x27;, counter: 3, limiter: [3, &#x27;hour&#x27;] &#125;&#125;) ä¸Šè¿°ä»£ç çš„ä½œç”¨æ˜¯ï¼šæ¯ 1000ms(interval) æ£€æŸ¥ä¸€æ¬¡ Memory çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœå‘ç°è¿ç»­ 3(counter) æ¬¡ Memory å¤§äº 1.2gb(threshold)ï¼Œåˆ™ dump ä¸€æ¬¡ Memoryï¼Œç”Ÿæˆ memory-$&#123;process.pid&#125;-$&#123;Date.now()&#125;.heapsnapshot åˆ° &#x2F;tmp(profileDir) ç›®å½•ä¸‹ï¼Œ1(limiter[1]) å°æ—¶æœ€å¤š dump 3(limiter[0]) æ¬¡ã€‚ æ³¨æ„ï¼šmemory çš„é…ç½®æ²¡æœ‰ duration å‚æ•°ï¼Œå› ä¸º Memroy çš„ dump åªæ˜¯æŸä¸€æ—¶åˆ»çš„ï¼Œè€Œä¸æ˜¯ä¸€æ®µæ—¶é—´çš„ã€‚ èªæ˜çš„ä½ è‚¯å®šä¼šé—®äº†ï¼šèƒ½ä¸èƒ½å°† cpu å’Œ memory é…ç½®ä¸€å—ä½¿ç”¨ï¼Ÿæ¯”å¦‚ï¼š 12345678910111213require(&#x27;cpu-memory-monitor&#x27;)(&#123; cpu: &#123; interval: 1000, duration: 30000, threshold: 60, ... &#125;, memory: &#123; interval: 10000, threshold: &#x27;1.2gb&#x27;, ... &#125;&#125;) ç­”æ¡ˆæ˜¯ï¼šå¯ä»¥ï¼Œä½†ä¸è¦è¿™ä¹ˆåšã€‚å› ä¸ºè¿™æ ·åšå¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼šå†…å­˜é«˜äº†ä¸”è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼ -&gt; è§¦å‘ Memory Dump&#x2F;GC -&gt; å¯¼è‡´ CPU ä½¿ç”¨ç‡é«˜ä¸”è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼ -&gt; è§¦å‘ CPU Dump -&gt; å¯¼è‡´å †ç§¯çš„è¯·æ±‚è¶Šæ¥è¶Šå¤šï¼ˆæ¯”å¦‚å†…å­˜ä¸­å †ç§¯äº†å¾ˆå¤š SQL æŸ¥è¯¢ï¼‰-&gt; è§¦å‘ Memory Dump -&gt; å¯¼è‡´é›ªå´©ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œåªä½¿ç”¨å…¶ä¸­ä¸€ç§å°±å¯ä»¥äº†ã€‚ 2.4.2 æºç è§£è¯»cpu-memory-monitor çš„æºä»£ç ä¸è¿‡ç™¾ä½™è¡Œï¼Œå¤§ä½“é€»è¾‘å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253...const processing = &#123; cpu: false, memory: false&#125;const counter = &#123; cpu: 0, memory: 0&#125;function dumpCpu(cpuProfileDir, cpuDuration) &#123; ... &#125;function dumpMemory(memProfileDir) &#123; ... &#125;module.exports = function cpuMemoryMonitor(options = &#123;&#125;) &#123; ... if (options.cpu) &#123; const cpuTimer = setInterval(() =&gt; &#123; if (processing.cpu) &#123; return &#125; pusage.stat(process.pid, (err, stat) =&gt; &#123; if (err) &#123; clearInterval(cpuTimer) return &#125; if (stat.cpu &gt; cpuThreshold) &#123; counter.cpu += 1 if (counter.cpu &gt;= cpuCounter) &#123; memLimiter.removeTokens(1, (limiterErr, remaining) =&gt; &#123; if (limiterErr) &#123; return &#125; if (remaining &gt; -1) &#123; dumpCpu(cpuProfileDir, cpuDuration) counter.cpu = 0 &#125; &#125;) &#125; else &#123; counter.cpu = 0 &#125; &#125; &#125;) &#125;, cpuInterval) &#125; if (options.memory) &#123; ... memwatch.on(&#x27;leak&#x27;, () =&gt; &#123; dumpMemory(...) &#125;) &#125;&#125; å¯ä»¥çœ‹å‡ºï¼šcpu-memory-monitor æ²¡æœ‰ç”¨åˆ°ä»€ä¹ˆæ–°é²œçš„ä¸œè¥¿ï¼Œè¿˜æ˜¯ä¹‹å‰è®²è§£è¿‡çš„ v8-profilerã€heapdumpã€memwatch-next çš„ç»„åˆä½¿ç”¨è€Œå·²ã€‚ æœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š åªæœ‰ä¼ å…¥äº† cpu æˆ–è€… memory çš„é…ç½®ï¼Œæ‰ä¼šå»ç›‘å¬ç›¸åº”çš„ CPU æˆ–è€… Memoryã€‚ åœ¨ä¼ å…¥ memory é…ç½®æ—¶ï¼Œå› ä¸ºç”¨ memwatch-next é¢å¤–ç›‘å¬äº† leak äº‹ä»¶ï¼Œä¹Ÿä¼š dump Memoryï¼Œæ ¼å¼æ˜¯ leak-memory-$&#123;process.pid&#125;-$&#123;Date.now()&#125;.heapsnapshotã€‚ é¡¶éƒ¨å¼•å…¥äº† heapdumpï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰ memory é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ kill -USR2 &lt;PID&gt; æ‰‹åŠ¨è§¦å‘ Memory Dumpã€‚ 2.4.3 å‚è€ƒé“¾æ¥ https://github.com/node-inspector/v8-profiler https://github.com/bnoordhuis/node-heapdump https://github.com/marcominetti/node-memwatch","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 2.3 How to use memwatch-next","slug":"2.3.1 ä½¿ç”¨ memwatch-next","date":"2019-04-13T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/13/2.3.1 ä½¿ç”¨ memwatch-next/","link":"","permalink":"https://marvinliu1.github.io/2019/04/13/2.3.1%20%E4%BD%BF%E7%94%A8%20memwatch-next/","excerpt":"","text":"Node in Debugging memwatch-nextï¼ˆä»¥ä¸‹ç®€ç§° memwatchï¼‰æ˜¯ä¸€ä¸ªç”¨æ¥ç›‘æµ‹ Node.js çš„å†…å­˜æ³„æ¼å’Œå †ä¿¡æ¯æ¯”è¾ƒçš„æ¨¡å—ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€æ®µäº‹ä»¶ç›‘å¬å™¨å¯¼è‡´å†…å­˜æ³„æ¼çš„ä»£ç ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•ä½¿ç”¨ memwatchã€‚ 2.3.1 ä½¿ç”¨ memwatch-nextæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š app.js 12345678910111213141516171819let count = 1const memwatch = require(&#x27;memwatch-next&#x27;)memwatch.on(&#x27;stats&#x27;, (stats) =&gt; &#123; console.log(count++, stats)&#125;)memwatch.on(&#x27;leak&#x27;, (info) =&gt; &#123; console.log(&#x27;---&#x27;) console.log(info) console.log(&#x27;---&#x27;)&#125;)const http = require(&#x27;http&#x27;)const server = http.createServer((req, res) =&gt; &#123; for (let i = 0; i &lt; 10000; i++) &#123; server.on(&#x27;request&#x27;, function leakEventCallback() &#123;&#125;) &#125; res.end(&#x27;Hello World&#x27;) global.gc()&#125;).listen(3000) åœ¨æ¯ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œåœ¨ server ä¸Šæ³¨å†Œ 10000 ä¸ª request äº‹ä»¶çš„ç›‘å¬å‡½æ•°ï¼ˆå¤§é‡çš„äº‹ä»¶ç›‘å¬å‡½æ•°å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œä»è€Œé€ æˆäº†å†…å­˜æ³„æ¼ï¼‰ï¼Œç„¶åæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ GCã€‚ è¿è¡Œè¯¥ç¨‹åºï¼š 1$ node --expose-gc app.js æ³¨æ„ï¼šè¿™é‡Œæ·»åŠ  â€“expose-gc å‚æ•°å¯åŠ¨ç¨‹åºï¼Œè¿™æ ·æˆ‘ä»¬æ‰å¯ä»¥åœ¨ç¨‹åºä¸­æ‰‹åŠ¨è§¦å‘ GCã€‚ memwatch ç›‘å¬ä»¥ä¸‹ä¸¤ä¸ªäº‹ä»¶ï¼š statsï¼šGC äº‹ä»¶ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡ GCï¼Œéƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ï¼Œæ‰“å° heap ç›¸å…³çš„ä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š 12345678910&#123; num_full_gc: 1,// å®Œæ•´çš„åƒåœ¾å›æ”¶æ¬¡æ•° num_inc_gc: 1,// å¢é•¿çš„åƒåœ¾å›æ”¶æ¬¡æ•° heap_compactions: 1,// å†…å­˜å‹ç¼©æ¬¡æ•° usage_trend: 0,// ä½¿ç”¨è¶‹åŠ¿ estimated_base: 5350136,// é¢„æœŸåŸºæ•° current_base: 5350136,// å½“å‰åŸºæ•° min: 0,// æœ€å°å€¼ max: 0// æœ€å¤§å€¼&#125; leakï¼šå¯ç–‘çš„å†…å­˜æ³„éœ²äº‹ä»¶ï¼Œè§¦å‘è¯¥äº‹ä»¶çš„æ¡ä»¶æ˜¯ï¼šå†…å­˜åœ¨è¿ç»­ 5 æ¬¡ GC åéƒ½æ˜¯å¢é•¿çš„ã€‚æ‰“å°å¦‚ä¸‹ï¼š 1234&#123; growth: 4051464, reason: &#x27;heap growth over 5 consecutive GCs (2s) - -2147483648 bytes/hr&#x27;&#125; è¿è¡Œï¼š 1$ ab -c 1 -n 5 http://localhost:3000/ è¾“å‡ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445(node:20989) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 request listeners added. Use emitter.setMaxListeners() to increase limit1 &#123; num_full_gc: 1, num_inc_gc: 1, heap_compactions: 1, usage_trend: 0, estimated_base: 5720064, current_base: 5720064, min: 0, max: 0 &#125;2 &#123; num_full_gc: 2, num_inc_gc: 1, heap_compactions: 2, usage_trend: 0, estimated_base: 7073824, current_base: 7073824, min: 0, max: 0 &#125;3 &#123; num_full_gc: 3, num_inc_gc: 1, heap_compactions: 3, usage_trend: 0, estimated_base: 7826368, current_base: 7826368, min: 7826368, max: 7826368 &#125;4 &#123; num_full_gc: 4, num_inc_gc: 1, heap_compactions: 4, usage_trend: 0, estimated_base: 8964784, current_base: 8964784, min: 7826368, max: 8964784 &#125;---&#123; growth: 3820272, reason: &#x27;heap growth over 5 consecutive GCs (0s) - -2147483648 bytes/hr&#x27; &#125;---5 &#123; num_full_gc: 5, num_inc_gc: 1, heap_compactions: 5, usage_trend: 0, estimated_base: 9540336, current_base: 9540336, min: 7826368, max: 9540336 &#125; å¯ä»¥çœ‹å‡ºï¼šNode.js å·²ç»è­¦å‘Šæˆ‘ä»¬äº‹ä»¶ç›‘å¬å™¨è¶…è¿‡äº† 11 ä¸ªï¼Œå¯èƒ½é€ æˆå†…å­˜æ³„éœ²ã€‚è¿ç»­ 5 æ¬¡å†…å­˜å¢é•¿è§¦å‘ leak äº‹ä»¶æ‰“å°å‡ºå¢é•¿äº†å¤šå°‘å†…å­˜ï¼ˆbytesï¼‰å’Œé¢„ä¼°æ¯å°æ—¶å¢é•¿å¤šå°‘ bytesã€‚ 2.3.2 Heap Diffingmemwatch æœ‰ä¸€ä¸ª HeapDiff å‡½æ•°ï¼Œç”¨æ¥å¯¹æ¯”å¹¶è®¡ç®—å‡ºä¸¤æ¬¡å †å¿«ç…§çš„å·®å¼‚ã€‚ä¿®æ”¹æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415const memwatch = require(&#x27;memwatch-next&#x27;)const http = require(&#x27;http&#x27;)const server = http.createServer((req, res) =&gt; &#123; for (let i = 0; i &lt; 10000; i++) &#123; server.on(&#x27;request&#x27;, function leakEventCallback() &#123;&#125;) &#125; res.end(&#x27;Hello World&#x27;) global.gc()&#125;).listen(3000)const hd = new memwatch.HeapDiff()memwatch.on(&#x27;leak&#x27;, (info) =&gt; &#123; const diff = hd.end() console.dir(diff, &#123; depth: 10 &#125;)&#125;) è¿è¡Œè¿™æ®µä»£ç å¹¶æ‰§è¡ŒåŒæ ·çš„ ab å‘½ä»¤ï¼Œæ‰“å°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223&#123; before: &#123; nodes: 35727, size_bytes: 4725128, size: &#x27;4.51 mb&#x27; &#125;, after: &#123; nodes: 87329, size_bytes: 8929792, size: &#x27;8.52 mb&#x27; &#125;, change: &#123; size_bytes: 4204664, size: &#x27;4.01 mb&#x27;, freed_nodes: 862, allocated_nodes: 52464, details: [ ... &#123; what: &#x27;Array&#x27;, size_bytes: 530200, size: &#x27;517.77 kb&#x27;, &#x27;+&#x27;: 1023, &#x27;-&#x27;: 510 &#125;, &#123; what: &#x27;Closure&#x27;, size_bytes: 3599856, size: &#x27;3.43 mb&#x27;, &#x27;+&#x27;: 50001, &#x27;-&#x27;: 3 &#125;, ... ] &#125;&#125; å¯ä»¥çœ‹å‡ºï¼šå†…å­˜ç”± 4.51mb æ¶¨åˆ°äº† 8.52mbï¼Œå…¶ä¸­ Closure å’Œ Array æ¶¨äº†ç»å¤§éƒ¨åˆ†ï¼Œè€Œæˆ‘ä»¬çŸ¥é“æ³¨å†Œäº‹ä»¶ç›‘å¬å‡½æ•°çš„æœ¬è´¨å°±æ˜¯å°†äº‹ä»¶å‡½æ•°ï¼ˆClosureï¼‰push åˆ°ç›¸åº”çš„æ•°ç»„ï¼ˆArrayï¼‰é‡Œã€‚ 2.3.3 ç»“åˆ heapdumpmemwatch åœ¨ç»“åˆ heapdump ä½¿ç”¨æ—¶æ‰èƒ½å‘æŒ¥æ›´å¥½çš„ä½œç”¨ã€‚é€šå¸¸ç”¨ memwatch ç›‘æµ‹åˆ°å†…å­˜æ³„æ¼ï¼Œç”¨ heapdump å¯¼å‡ºå¤šä»½å †å¿«ç…§ï¼Œç„¶åç”¨ Chrome DevTools åˆ†æå’Œæ¯”è¾ƒï¼Œå®šä½å†…å­˜æ³„æ¼çš„å…ƒå‡¶ã€‚ ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324const memwatch = require(&#x27;memwatch-next&#x27;)const heapdump = require(&#x27;heapdump&#x27;)const http = require(&#x27;http&#x27;)const server = http.createServer((req, res) =&gt; &#123; for (let i = 0; i &lt; 10000; i++) &#123; server.on(&#x27;request&#x27;, function leakEventCallback() &#123;&#125;) &#125; res.end(&#x27;Hello World&#x27;) global.gc()&#125;).listen(3000)dump()memwatch.on(&#x27;leak&#x27;, () =&gt; &#123; dump()&#125;)function dump() &#123; const filename = `$&#123;__dirname&#125;/heapdump-$&#123;process.pid&#125;-$&#123;Date.now()&#125;.heapsnapshot` heapdump.writeSnapshot(filename, () =&gt; &#123; console.log(`$&#123;filename&#125; dump completed.`) &#125;)&#125; ä»¥ä¸Šç¨‹åºåœ¨å¯åŠ¨åå…ˆæ‰§è¡Œä¸€æ¬¡ heap dumpï¼Œå½“è§¦å‘ leak äº‹ä»¶æ—¶å†æ‰§è¡Œä¸€æ¬¡ heap dumpã€‚è¿è¡Œè¿™æ®µä»£ç å¹¶æ‰§è¡ŒåŒæ ·çš„ ab å‘½ä»¤ï¼Œç”Ÿæˆä¸¤ä¸ª heapsnapshot æ–‡ä»¶ï¼š 12heapdump-21126-1519545957879.heapsnapshotheapdump-21126-1519545975702.heapsnapshot ç”¨ Chrome DevTools åŠ è½½è¿™ä¸¤ä¸ª heapsnapshot æ–‡ä»¶ï¼Œé€‰æ‹© comparison æ¯”è¾ƒè§†å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šå¢åŠ äº† 5 ä¸‡ä¸ª leakEventCallback å‡½æ•°ï¼Œå•å‡»å…¶ä¸­ä»»æ„ä¸€ä¸ªï¼Œå¯ä»¥ä» Retainers ä¸­çœ‹åˆ°æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ GC path å’Œæ‰€åœ¨çš„æ–‡ä»¶ç­‰ä¿¡æ¯ã€‚ 2.3.4 å‚è€ƒé“¾æ¥ https://github.com/marcominetti/node-memwatch","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 2.2 About heapdump","slug":"2.2.1 ä½¿ç”¨ heapdump","date":"2019-04-12T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/12/2.2.1 ä½¿ç”¨ heapdump/","link":"","permalink":"https://marvinliu1.github.io/2019/04/12/2.2.1%20%E4%BD%BF%E7%94%A8%20heapdump/","excerpt":"","text":"Node in Debugging heapdump æ˜¯ä¸€ä¸ª dump V8 å †ä¿¡æ¯çš„å·¥å…·ã€‚v8-profiler ä¹ŸåŒ…å«äº†è¿™ä¸ªåŠŸèƒ½ï¼Œè¿™ä¸¤ä¸ªå·¥å…·çš„åŸç†éƒ½æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯ v8::Isolate::GetCurrent()-&gt;GetHeapProfiler()-&gt;TakeHeapSnapshot(title, control)ï¼Œä½†æ˜¯ heapdump çš„ä½¿ç”¨ç®€å•äº›ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ heapdump ä¸ºä¾‹è®²è§£å¦‚ä½•åˆ†æ Node.js çš„å†…å­˜æ³„æ¼ã€‚ 2.2.1 ä½¿ç”¨ heapdumpè¿™é‡Œä»¥ä¸€æ®µç»å…¸çš„å†…å­˜æ³„æ¼ä»£ç ä½œä¸ºæµ‹è¯•ä»£ç ï¼š app.js 12345678910111213141516171819const heapdump = require(&#x27;heapdump&#x27;)let leakObject = nulllet count = 0setInterval(function testMemoryLeak() &#123; const originLeakObject = leakObject const unused = function () &#123; if (originLeakObject) &#123; console.log(&#x27;originLeakObject&#x27;) &#125; &#125; leakObject = &#123; count: String(count++), leakStr: new Array(1e7).join(&#x27;*&#x27;), leakMethod: function () &#123; console.log(&#x27;leakMessage&#x27;) &#125; &#125;&#125;, 1000) ä¸ºä»€ä¹ˆè¿™æ®µç¨‹åºä¼šå‘ç”Ÿå†…å­˜æ³„æ¼å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½é—­åŒ…çš„åŸç†ï¼šåŒä¸€ä¸ªå‡½æ•°å†…éƒ¨çš„é—­åŒ…ä½œç”¨åŸŸåªæœ‰ä¸€ä¸ªï¼Œæ‰€æœ‰é—­åŒ…å…±äº«ã€‚åœ¨æ‰§è¡Œå‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°é—­åŒ…ï¼Œåˆ™ä¼šåˆ›å»ºé—­åŒ…ä½œç”¨åŸŸçš„å†…å­˜ç©ºé—´ï¼Œå°†è¯¥é—­åŒ…æ‰€ç”¨åˆ°çš„å±€éƒ¨å˜é‡æ·»åŠ è¿›å»ï¼Œç„¶åå†é‡åˆ°é—­åŒ…æ—¶ï¼Œä¼šåœ¨ä¹‹å‰åˆ›å»ºå¥½çš„ä½œç”¨åŸŸç©ºé—´æ·»åŠ æ­¤é—­åŒ…ä¼šç”¨åˆ°è€Œå‰é—­åŒ…æ²¡ç”¨åˆ°çš„å˜é‡ã€‚å‡½æ•°ç»“æŸæ—¶ï¼Œä¼šæ¸…é™¤æ²¡æœ‰è¢«é—­åŒ…ä½œç”¨åŸŸå¼•ç”¨çš„å˜é‡ã€‚ è¿™æ®µä»£ç å†…å­˜æ³„éœ²åŸå› æ˜¯ï¼šåœ¨ testMemoryLeak å‡½æ•°å†…æœ‰ä¸¤ä¸ªé—­åŒ…ï¼šunused å’Œ leakMethodã€‚unused è¿™ä¸ªé—­åŒ…å¼•ç”¨äº†çˆ¶ä½œç”¨åŸŸä¸­çš„ originLeakObject å˜é‡ï¼Œå¦‚æœæ²¡æœ‰åé¢çš„ leakMethodï¼Œåˆ™ä¼šåœ¨å‡½æ•°ç»“æŸåè¢«æ¸…é™¤ï¼Œé—­åŒ…ä½œç”¨åŸŸä¹Ÿè·Ÿç€è¢«æ¸…é™¤äº†ã€‚å› ä¸ºåé¢çš„ leakObject æ˜¯å…¨å±€å˜é‡ï¼Œå³ leakMethod æ˜¯å…¨å±€å˜é‡ï¼Œå®ƒå¼•ç”¨çš„é—­åŒ…ä½œç”¨åŸŸï¼ˆåŒ…å«äº† unused æ‰€å¼•ç”¨çš„ originLeakObjectï¼‰ä¸ä¼šé‡Šæ”¾ã€‚è€Œéšç€ testMemoryLeak ä¸æ–­çš„è°ƒç”¨ï¼ŒoriginLeakObject æŒ‡å‘å‰ä¸€æ¬¡çš„ leakObjectï¼Œä¸‹æ¬¡çš„ leakObject.leakMethod åˆä¼šå¼•ç”¨ä¹‹å‰çš„ originLeakObjectï¼Œä»è€Œå½¢æˆä¸€ä¸ªé—­åŒ…å¼•ç”¨é“¾ï¼Œè€Œ leakStr æ˜¯ä¸€ä¸ªå¤§å­—ç¬¦ä¸²ï¼Œå¾—ä¸åˆ°é‡Šæ”¾ï¼Œä»è€Œé€ æˆäº†å†…å­˜æ³„æ¼ã€‚ è§£å†³æ–¹æ³•ï¼šåœ¨ testMemoryLeak å‡½æ•°å†…éƒ¨çš„æœ€åæ·»åŠ  originLeakObject = null å³å¯ã€‚ è¿è¡Œæµ‹è¯•ä»£ç ï¼š 1$ node app ç„¶åå…ˆåæ‰§è¡Œä¸¤æ¬¡ï¼š 1$ kill -USR2 `pgrep -n node` åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†ä¸¤ä¸ª heapsnapshot æ–‡ä»¶ï¼š 12heapdump-100427359.61348.heapsnapshotheapdump-100438986.797085.heapsnapshot 2.2.2 Chrome DevToolsæˆ‘ä»¬ä½¿ç”¨ Chrome DevTools æ¥åˆ†æå‰é¢ç”Ÿæˆçš„ heapsnapshot æ–‡ä»¶ã€‚è°ƒå‡º Chrome DevTools -&gt; Memory -&gt; Loadï¼ŒæŒ‰é¡ºåºä¾æ¬¡åŠ è½½å‰é¢ç”Ÿæˆçš„ heapsnapshot æ–‡ä»¶ã€‚å•å‡»ç¬¬ 2 ä¸ªå †å¿«ç…§ï¼Œåœ¨å·¦ä¸Šè§’æœ‰ä¸ªä¸‹æ‹‰èœå•ï¼Œæœ‰å¦‚ä¸‹ 4 ä¸ªé€‰é¡¹ï¼š Summaryï¼šä»¥æ„é€ å‡½æ•°ååˆ†ç±»æ˜¾ç¤ºã€‚ Comparisonï¼šæ¯”è¾ƒå¤šä¸ªå¿«ç…§ä¹‹é—´çš„å·®å¼‚ã€‚ Containmentï¼šæŸ¥çœ‹æ•´ä¸ª GC è·¯å¾„ã€‚ Statisticsï¼šä»¥é¥¼çŠ¶å›¾æ˜¾ç¤ºå†…å­˜å ç”¨ä¿¡æ¯ã€‚ é€šå¸¸æˆ‘ä»¬åªä¼šç”¨å‰ä¸¤ä¸ªé€‰é¡¹ï¼›ç¬¬ 3 ä¸ªé€‰é¡¹ä¸€èˆ¬ç”¨ä¸åˆ°ï¼Œå› ä¸ºåœ¨å±•å¼€ Summary å’Œ Comparison ä¸­çš„æ¯ä¸€é¡¹æ—¶ï¼Œéƒ½å¯ä»¥çœ‹åˆ°ä» GC roots åˆ°è¿™ä¸ªå¯¹è±¡çš„è·¯å¾„ï¼›ç¬¬ 4 ä¸ªé€‰é¡¹åªèƒ½çœ‹åˆ°å†…å­˜å ç”¨æ¯”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åˆ‡æ¢åˆ° Summary é¡µï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹ 5 ä¸ªå±æ€§ï¼š Contructorï¼šæ„é€ å‡½æ•°åï¼Œä¾‹å¦‚ Objectã€Moduleã€Socketï¼Œ(array)ã€(string)ã€(regexp) ç­‰åŠ äº†æ‹¬å·çš„åˆ†åˆ«ä»£è¡¨å†…ç½®çš„ Arrayã€String å’Œ Regexpã€‚ Distanceï¼šåˆ° GC roots ï¼ˆGC æ ¹å¯¹è±¡ï¼‰çš„è·ç¦»ã€‚GC æ ¹å¯¹è±¡åœ¨æµè§ˆå™¨ä¸­ä¸€èˆ¬æ˜¯ window å¯¹è±¡ï¼Œåœ¨ Node.js ä¸­æ˜¯ global å¯¹è±¡ï¼Œè·ç¦»è¶Šå¤§ï¼Œåˆ™è¯´æ˜å¼•ç”¨è¶Šæ·±ã€‚ Objects Countï¼šå¯¹è±¡ä¸ªæ•°ã€‚ Shallow Sizeï¼šå¯¹è±¡è‡ªèº«çš„å¤§å°ï¼Œä¸åŒ…æ‹¬å®ƒå¼•ç”¨çš„å¯¹è±¡ã€‚ Retained Sizeï¼šå¯¹è±¡è‡ªèº«çš„å¤§å°å’Œå®ƒå¼•ç”¨çš„å¯¹è±¡çš„å¤§å°ï¼Œå³è¯¥å¯¹è±¡è¢« GC ä¹‹åæ‰€èƒ½å›æ”¶çš„å†…å­˜å¤§å°ã€‚ å°æç¤ºï¼šä¸€ä¸ªå¯¹è±¡çš„ Retained Size &#x3D; è¯¥å¯¹è±¡çš„ Shallow Size + è¯¥å¯¹è±¡æ”¯é…æ ‘ä¸Šå…¶å­èŠ‚ç‚¹çš„ Retained Size ä¹‹å’Œã€‚Shallow Size &#x3D;&#x3D; Retained Size çš„æœ‰ (boolean)ã€(number)ã€(string)ï¼Œå®ƒä»¬æ— æ³•å¼•ç”¨å…¶ä»–å€¼ï¼Œå¹¶ä¸”å§‹ç»ˆæ˜¯å¶å­èŠ‚ç‚¹ã€‚ å•å‡» Retained Size é€‰æ‹©é™åºå±•ç¤ºï¼Œå¯ä»¥çœ‹åˆ° (closure) è¿™ä¸€é¡¹å¼•ç”¨çš„å†…å®¹è¾¾åˆ° 98%ï¼Œç»§ç»­å±•å¼€å¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºï¼šä¸€ä¸ª leakStr å äº† 8% çš„å†…å­˜ï¼Œè€Œ leakMethod å¼•ç”¨äº† 81% çš„å†…å­˜ã€‚å¯¹è±¡ä¿ç•™æ ‘ï¼ˆRetainersï¼Œè€ç‰ˆæœ¬ Chrome ä¸­å« Objectâ€™s retaining treeï¼‰å±•ç¤ºäº†å¯¹è±¡çš„ GC pathï¼Œå•å‡»å¦‚ä¸Šå›¾ä¸­çš„ leakStrï¼ˆDistance æ˜¯ 13ï¼‰ï¼ŒRetainers ä¼šè‡ªåŠ¨å±•å¼€ï¼ŒDistance ä» 13 é€’å‡åˆ° 1ã€‚ ç»§ç»­å±•å¼€ leakMethodï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šæœ‰ä¸€ä¸ª count&#x3D;â€10â€ çš„ originLeakObject çš„ leakMethod å‡½æ•°çš„ contextï¼ˆå³ä¸Šä¸‹æ–‡ï¼‰ å¼•ç”¨äº†ä¸€ä¸ª count&#x3D;â€9â€ çš„ originLeakObject å¯¹è±¡ï¼Œè€Œè¿™ä¸ª originLeakObject å¯¹è±¡çš„ leakMethod å‡½æ•°çš„ context åˆå¼•ç”¨äº† count&#x3D;â€8â€ çš„ originLeakObject å¯¹è±¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚è€Œæ¯ä¸ª originLeakObject å¯¹è±¡ä¸Šéƒ½æœ‰ä¸€ä¸ªå¤§å­—ç¬¦ä¸² leakStrï¼ˆå ç”¨ 8% çš„å†…å­˜ï¼‰ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ï¼Œç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„æ¨æ–­ã€‚ å°æç¤ºï¼šå¦‚æœèƒŒæ™¯è‰²æ˜¯é»„è‰²çš„ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡åœ¨ JavaScript ä¸­è¿˜å­˜åœ¨å¼•ç”¨ï¼Œæ‰€ä»¥å¯èƒ½æ²¡æœ‰è¢«æ¸…é™¤ã€‚å¦‚æœèƒŒæ™¯è‰²æ˜¯çº¢è‰²çš„ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡åœ¨ JavaScript ä¸­ä¸å­˜åœ¨å¼•ç”¨ï¼Œä½†æ˜¯ä¾ç„¶å­˜æ´»åœ¨å†…å­˜ä¸­ï¼Œä¸€èˆ¬å¸¸è§äº DOM å¯¹è±¡ï¼Œå®ƒä»¬å­˜æ”¾çš„ä½ç½®å’Œ JavaScript ä¸­çš„å¯¹è±¡è¿˜æ˜¯æœ‰ä¸åŒçš„ï¼Œåœ¨ Node.js ä¸­å¾ˆå°‘é‡è§ã€‚ 2.2.3 å¯¹æ¯”å¿«ç…§åˆ‡æ¢åˆ° Comparison è§†å›¾ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° #Newã€#Deletedã€#Delta ç­‰å±æ€§ï¼Œ+ å’Œ - è¡¨ç¤ºç›¸å¯¹äºæ¯”è¾ƒçš„å †å¿«ç…§è€Œè¨€ã€‚æˆ‘ä»¬å¯¹æ¯”ç¬¬ 2 ä¸ªå¿«ç…§å’Œç¬¬ 1 ä¸ªå¿«ç…§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼š(string) å¢åŠ äº† 10 ä¸ªï¼Œæ¯ä¸ª string å¤§å°ä¸º 10000024 å­—èŠ‚ã€‚ 2.2.4 å‚è€ƒé“¾æ¥ https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156 https://www.zhihu.com/question/56806069 http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/ https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 2.1 Core & Core Dump","slug":"2.1.1 Core & Core Dump","date":"2019-04-07T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/07/2.1.1 Core & Core Dump/","link":"","permalink":"https://marvinliu1.github.io/2019/04/07/2.1.1%20Core%20&%20Core%20Dump/","excerpt":"","text":"Node in Debugging 2.1.1 Core &amp; Core Dumpåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ Core å’Œ Core Dumpã€‚ ä»€ä¹ˆæ˜¯ Core? åœ¨ä½¿ç”¨åŠå¯¼ä½“ä½œä¸ºå†…å­˜ææ–™å‰ï¼Œäººç±»ç”¨çº¿åœˆä½œä¸ºå†…å­˜çš„ææ–™ï¼Œçº¿åœˆå°±å«ä½œ core ï¼Œç”¨çº¿åœˆåšçš„å†…å­˜å°±å«ä½œ core memoryã€‚å¦‚ä»Šï¼ŒåŠå¯¼ä½“å·¥ä¸šè“¬å‹ƒå‘å±•ï¼Œå·²ç»æ²¡æœ‰äººç”¨ core memory äº†ï¼Œä¸è¿‡åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œäººä»¬è¿˜æ˜¯æŠŠè®°å¿†ä½“å«ä½œ core ã€‚ ä»€ä¹ˆæ˜¯ Core Dump? å½“ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­å¼‚å¸¸ç»ˆæ­¢æˆ–å´©æºƒï¼Œæ“ä½œç³»ç»Ÿä¼šå°†ç¨‹åºå½“æ—¶çš„å†…å­˜çŠ¶æ€è®°å½•ä¸‹æ¥ï¼Œä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™ç§è¡Œä¸ºå°±å«ä½œ Core Dumpï¼ˆä¸­æ–‡ç¿»è¯‘æˆ â€œæ ¸å¿ƒè½¬å‚¨â€)ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸º Core Dump æ˜¯ â€œå†…å­˜å¿«ç…§â€ï¼Œä½†å®é™…ä¸Šï¼Œé™¤äº†å†…å­˜ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰äº›å…³é”®çš„ç¨‹åºè¿è¡ŒçŠ¶æ€ä¹Ÿä¼šåŒæ—¶ dump ä¸‹æ¥ï¼Œä¾‹å¦‚å¯„å­˜å™¨ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç¨‹åºæŒ‡é’ˆã€æ ˆæŒ‡é’ˆç­‰ï¼‰ã€å†…å­˜ç®¡ç†ä¿¡æ¯ã€å…¶ä»–å¤„ç†å™¨å’Œæ“ä½œç³»ç»ŸçŠ¶æ€å’Œä¿¡æ¯ã€‚Core Dump å¯¹äºç¼–ç¨‹äººå‘˜è¯Šæ–­å’Œè°ƒè¯•ç¨‹åºæ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºæœ‰äº›ç¨‹åºä¸­çš„é”™è¯¯æ˜¯å¾ˆéš¾é‡ç°çš„ï¼Œä¾‹å¦‚æŒ‡é’ˆå¼‚å¸¸ï¼Œè€Œ Core Dump æ–‡ä»¶å¯ä»¥å†ç°ç¨‹åºå‡ºé”™æ—¶çš„æƒ…æ™¯ã€‚ æµ‹è¯•ç¯å¢ƒ 12$ uname -aLinux nswbmw-VirtualBox 4.13.0-36-generic #40~16.04.1-Ubuntu SMP Fri Feb 16 23:25:58 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux å¼€å¯ Core Dump åœ¨ç»ˆç«¯ä¸­è¾“å…¥ï¼š 1$ ulimit -c æŸ¥çœ‹å…è®¸ Core Dump ç”Ÿæˆçš„æ–‡ä»¶çš„å¤§å°ï¼Œå¦‚æœæ˜¯ 0 åˆ™è¡¨ç¤ºå…³é—­äº† Core Dumpã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¼€å¯ Core Dumpï¼Œå¹¶ä¸”ä¸é™åˆ¶ Core Dump ç”Ÿæˆçš„æ–‡ä»¶å¤§å°ï¼š 1$ ulimit -c unlimited ä»¥ä¸Šå‘½ä»¤åªåœ¨å½“å‰ç»ˆç«¯ç¯å¢ƒä¸‹æœ‰æ•ˆï¼Œå¦‚æœæƒ³æ°¸ä¹…ç”Ÿæ•ˆï¼Œå°±éœ€è¦ä¿®æ”¹ &#x2F;etc&#x2F;security&#x2F;limits.conf æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š 2.1.2 gcoreä½¿ç”¨ gcore å¯ä»¥ä¸é‡å¯ç¨‹åºè€Œ dump å‡ºç‰¹å®šè¿›ç¨‹çš„ core æ–‡ä»¶ã€‚gcore ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 1$ gcore [-o filename] pid åœ¨ Core Dump æ—¶ï¼Œé»˜è®¤ä¼šåœ¨æ‰§è¡Œ gcore å‘½ä»¤çš„ç›®å½•ç”Ÿæˆ core. æ–‡ä»¶ã€‚ 2.1.3 llnodeä»€ä¹ˆæ˜¯ llnodeï¼Ÿ Node.js v4.x+ C++ plugin for LLDB - a next generation, high-performance debugger. ä»€ä¹ˆæ˜¯ LLDBï¼Ÿ LLDB is a next generation, high-performance debugger. It is built as a set of reusable components which highly leverage existing libraries in the larger LLVM Project, such as the Clang expression parser and LLVM disassembler. å®‰è£… llnode + lldbï¼š 12345678910111213141516171819$ sudo apt-get update# Clone llnode$ git clone https://github.com/nodejs/llnode.git ~/llnode &amp;&amp; cd ~/llnode# Install lldb and headers$ sudo apt-get install lldb-4.0 liblldb-4.0-dev# Initialize GYP$ git clone https://github.com/bnoordhuis/gyp.git tools/gyp# Configure$ ./gyp_llnode -Dlldb_dir=/usr/lib/llvm-4.0/# Build$ make -C out/ -j9# Install$ sudo make install-linux æ³¨æ„ï¼šå¦‚æœ sudo apt-get update é‡åˆ°è¿™ç§é”™è¯¯ï¼š 1W: GPG error: xxx stable Release: The following signatures couldn&#x27;t be verified because the public key is not available: NO_PUBKEY 6DA62DE462C7DA6D å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤è§£å†³ï¼š 1$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6DA62DE462C7DA6D â€“recv-keys åé¢è·Ÿçš„æ˜¯å‰é¢æŠ¥é”™æç¤ºçš„ PUBKEYã€‚ 2.1.4 æµ‹è¯• Core Dumpä¸‹é¢ç”¨ä¸€ä¸ªå…¸å‹çš„å…¨å±€å˜é‡ç¼“å­˜å¯¼è‡´çš„å†…å­˜æ³„æ¼çš„ä¾‹å­æ¥æµ‹è¯• llnode çš„ç”¨æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š app.js 1234567891011121314const leaks = []function LeakingClass() &#123; this.name = Math.random().toString(36) this.age = Math.floor(Math.random() * 100)&#125;setInterval(() =&gt; &#123; for (let i = 0; i &lt; 100; i++) &#123; leaks.push(new LeakingClass) &#125; console.warn(&#x27;Leaks: %d&#x27;, leaks.length)&#125;, 1000) è¿è¡Œè¯¥ç¨‹åºï¼š 1$ node app.js ç­‰å¾…å‡ ç§’ï¼Œæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ gcoreï¼š 12$ ulimit -c unlimited$ sudo gcore `pgrep -n node` ç”Ÿæˆ core.2763 æ–‡ä»¶ã€‚ 2.1.5 åˆ†æ Core æ–‡ä»¶ä½¿ç”¨ lldb åŠ è½½åˆšæ‰ç”Ÿæˆçš„ Core æ–‡ä»¶ï¼š 1234$ lldb-4.0 -c ./core.2763 (lldb) target create --core &quot;./core.2763&quot;Core file &#x27;/home/nswbmw/test/./core.2763&#x27; (x86_64) was loaded.(lldb) è¾“å…¥ v8 æŸ¥çœ‹ä½¿ç”¨æ–‡æ¡£ï¼Œæœ‰ä»¥ä¸‹å‡ æ¡å‘½ä»¤ï¼š bt findjsinstances findjsobjects findrefs inspect nodeinfo print source è¿è¡Œ v8 findjsobjects æŸ¥çœ‹æ‰€æœ‰å¯¹è±¡å®ä¾‹åŠæ€»å…±å å†…å­˜å¤§å°ï¼š 12345678(lldb) v8 findjsobjects Instances Total Size Name ---------- ---------- ---- ... 2100 84000 LeakingClass 8834 39792 (String) ---------- ---------- 12088 181320 å¯ä»¥çœ‹å‡ºï¼šLeakingClass æœ‰ 2100 ä¸ªå®ä¾‹ï¼Œå å†…å­˜ 84000 byteã€‚ä½¿ç”¨ v8 findjsinstances æŸ¥çœ‹æ‰€æœ‰ LeakingClass å®ä¾‹ï¼š 12345(lldb) v8 findjsinstances LeakingClass0x000022aaa118ab19:&lt;Object: LeakingClass&gt;0x000022aaa118acf9:&lt;Object: LeakingClass&gt;0x000022aaa118ade1:&lt;Object: LeakingClass&gt;... ä½¿ç”¨ v8 i æ£€ç´¢å®ä¾‹çš„å…·ä½“å†…å®¹ï¼š 123456789101112(lldb) v8 i 0x000022aaa118ab190x000022aaa118ab19:&lt;Object: LeakingClass properties &#123; .name=0x000022aaa118ab91:&lt;String: &quot;0.4tx00cipe8&quot;&gt;, .age=&lt;Smi: 71&gt;&#125;&gt;(lldb) v8 i 0x000022aaa118acf90x000022aaa118acf9:&lt;Object: LeakingClass properties &#123; .name=0x000022aaa118ad71:&lt;String: &quot;0.48563ixsblf&quot;&gt;, .age=&lt;Smi: 70&gt;&#125;&gt;(lldb) v8 i 0x000022aaa118ade10x000022aaa118ade1:&lt;Object: LeakingClass properties &#123; .name=0x000022aaa118ae59:&lt;String: &quot;0.w1nel407zj&quot;&gt;, .age=&lt;Smi: 80&gt;&#125;&gt; å¯ä»¥çœ‹åˆ°æ¯ä¸ª LeakingClass å®ä¾‹çš„ name å’Œ age å­—æ®µçš„å€¼ã€‚ ä½¿ç”¨ v8 findrefs æŸ¥çœ‹å¼•ç”¨ï¼š 1234567891011121314151617181920(lldb) v8 findrefs 0x000022aaa118ab190x22aaa1189729: (Array)[0]=0x22aaa118ab19(lldb) v8 i 0x22aaa11897290x000022aaa1189729:&lt;Array: length=2100 &#123; [0]=0x000022aaa118ab19:&lt;Object: LeakingClass&gt;, [1]=0x000022aaa118acf9:&lt;Object: LeakingClass&gt;, [2]=0x000022aaa118ade1:&lt;Object: LeakingClass&gt;, [3]=0x000022aaa118aea1:&lt;Object: LeakingClass&gt;, [4]=0x000022aaa118af61:&lt;Object: LeakingClass&gt;, [5]=0x000022aaa118b021:&lt;Object: LeakingClass&gt;, [6]=0x000022aaa118b0e1:&lt;Object: LeakingClass&gt;, [7]=0x000022aaa118b1a1:&lt;Object: LeakingClass&gt;, [8]=0x000022aaa118b221:&lt;Object: LeakingClass&gt;, [9]=0x000022aaa118b2a1:&lt;Object: LeakingClass&gt;, [10]=0x000022aaa118b321:&lt;Object: LeakingClass&gt;, [11]=0x000022aaa118b3a1:&lt;Object: LeakingClass&gt;, [12]=0x000022aaa118b421:&lt;Object: LeakingClass&gt;, [13]=0x000022aaa118b4a1:&lt;Object: LeakingClass&gt;, [14]=0x000022aaa118b521:&lt;Object: LeakingClass&gt;, [15]=0x000022aaa118b5a1:&lt;Object: LeakingClass&gt;&#125;&gt; å¯ä»¥çœ‹å‡ºï¼šé€šè¿‡ä¸€ä¸ª LeakingClass å®ä¾‹çš„å†…å­˜åœ°å€ï¼Œæˆ‘ä»¬ä½¿ç”¨ v8 findrefs æ‰¾åˆ°äº†å¼•ç”¨å®ƒçš„æ•°ç»„çš„å†…å­˜åœ°å€ï¼Œç„¶åé€šè¿‡è¿™ä¸ªåœ°å€å»æ£€ç´¢æ•°ç»„ï¼Œå¾—åˆ°è¿™ä¸ªæ•°ç»„é•¿åº¦ä¸º 2100ï¼Œæ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª LeakingClass å®ä¾‹ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬ä»£ç ä¸­çš„ leaks æ•°ç»„å—ï¼Ÿ å°æç¤º: v8 i æ˜¯ v8 inspect çš„ç¼©å†™ï¼Œv8 p æ˜¯ v8 print çš„ç¼©å†™ã€‚ 2.1.6 â€“abort-on-uncaught-exceptionåœ¨ Node.js ç¨‹åºå¯åŠ¨æ—¶æ·»åŠ  â€“abort-on-uncaught-exception å‚æ•°ï¼Œå½“ç¨‹åº crash çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ Core Dumpï¼Œæ–¹ä¾¿ â€œæ­»åéªŒå°¸â€ã€‚ æ·»åŠ  â€“abort-on-uncaught-exception å‚æ•°ï¼Œå¯åŠ¨æµ‹è¯•ç¨‹åºï¼š 12$ ulimit -c unlimited$ node --abort-on-uncaught-exception app.js å¯åŠ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š 1$ kill -BUS `pgrep -n node` ç¬¬ 1 ä¸ªç»ˆç«¯ä¼šæ˜¾ç¤ºï¼š 123456789Leaks: 100Leaks: 200Leaks: 300Leaks: 400Leaks: 500Leaks: 600Leaks: 700Leaks: 800Bus error (core dumped) è°ƒè¯•æ­¥éª¤ä¸ä¸Šé¢ä¸€è‡´ï¼š 1234567891011$ lldb-4.0 -c ./core(lldb) target create --core &quot;./core&quot;Core file &#x27;/home/nswbmw/test/./core&#x27; (x86_64) was loaded.(lldb) v8 findjsobjects Instances Total Size Name ---------- ---------- ---- ... 800 32000 LeakingClass 7519 38512 (String) ---------- ---------- 9440 126368 2.1.7 æ€»ç»“æˆ‘ä»¬çš„æµ‹è¯•ä»£ç å¾ˆç®€å•ï¼Œæ²¡æœ‰å¼•ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¦‚æœé¡¹ç›®è¾ƒå¤§ä¸”å¼•ç”¨çš„æ¨¡å—è¾ƒå¤šï¼Œåˆ™ v8 findjsobjects çš„ç»“æœå°†éš¾ä»¥ç”„åˆ«ï¼Œè¿™æ—¶å¯ä»¥å¤šæ¬¡ä½¿ç”¨ gcore è¿›è¡Œ Core Dumpï¼Œå¯¹æ¯”å‘ç°å¢é•¿çš„å¯¹è±¡ï¼Œå†è¿›è¡Œè¯Šæ–­ã€‚ 2.1.8 å‚è€ƒé“¾æ¥ http://www.cnblogs.com/Anker/p/6079580.html http://www.brendangregg.com/blog/2016-07-13/llnode-nodejs-memory-leak-analysis.html","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 1.3 Tick Processor","slug":"1.3.1 Tick Processor","date":"2019-04-01T06:00:00.000Z","updated":"2022-05-25T04:23:07.031Z","comments":true,"path":"2019/04/01/1.3.1 Tick Processor/","link":"","permalink":"https://marvinliu1.github.io/2019/04/01/1.3.1%20Tick%20Processor/","excerpt":"","text":"Node in Debugging V8 å†…ç½®äº†ä¸€ä¸ªæ€§èƒ½åˆ†æå·¥å…·â€”â€”Tick Processorï¼Œå¯ä»¥è®°å½• JavaScript&#x2F;C&#x2F;C++ ä»£ç çš„å †æ ˆä¿¡æ¯ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ å‘½ä»¤è¡Œå‚æ•° --prof å¼€å¯ã€‚ 1.3.1 Tick Processoråˆ›å»ºæµ‹è¯•ä»£ç ï¼š app.js 12345678910111213const crypto = require(&#x27;crypto&#x27;)function hash (password) &#123; const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;) const hash = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;) return hash&#125;console.time(&#x27;pbkdf2Sync&#x27;)for (let i = 0; i &lt; 100; i++) &#123; hash(&#x27;random_password&#x27;)&#125;console.timeEnd(&#x27;pbkdf2Sync&#x27;) è¿è¡Œï¼š 12$ node --prof apppbkdf2Sync: 1375.582ms å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œ 100 æ¬¡ hash å‡½æ•°æ€»å…±ç”¨äº† 1375.585msï¼Œå¹¶ä¸”å½“å‰ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª isolate-xxx-v8.log æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è®°å½•äº† V8 çš„æ€§èƒ½æ—¥å¿—ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 12345678v8-version,6,1,534,50,0shared-library,&quot;/usr/local/bin/node&quot;,0x100001800,0x100bbb69a,0...code-creation,Function,18,111912,0x37d07c7246a8,144,&quot;hash /Users/nswbmw/Desktop/test/app.js:3:15&quot;,0x37d07c7076d0,~code-creation,LazyCompile,18,111927,0x37d07c7246a8,144,&quot;hash /Users/nswbmw/Desktop/test/app.js:3:15&quot;,0x37d07c7076d0,~code-creation,Function,18,112058,0x37d07c725690,80,&quot;exports.pbkdf2Sync crypto.js:686:30&quot;,0x37d07c70cb58,~code-creation,LazyCompile,18,112074,0x37d07c725690,80,&quot;exports.pbkdf2Sync crypto.js:686:30&quot;,0x37d07c70cb58,~... æ—©æœŸæˆ‘ä»¬éœ€è¦å€ŸåŠ© node-tick-processor è¿™æ ·çš„å·¥å…·è§£æ v8.logï¼Œä½† Node.js åœ¨ v5.2.0 ä¹‹ååŒ…å«äº† v8.log å¤„ç†å™¨ï¼Œæ·»åŠ å‘½ä»¤è¡Œå‚æ•° --prof-process å¼€å¯ã€‚ è¿è¡Œï¼š 1$ node --prof-process isolate-0x103000000-v8.log ç»“æœå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344Statistical profiling result from isolate-0x103000000-v8.log, (1152 ticks, 44 unaccounted, 0 excluded). [Shared libraries]: ticks total nonlib name [JavaScript]: ticks total nonlib name 1 0.1% 0.1% Function: ~Uint8Array native typedarray.js:158:31 1 0.1% 0.1% Function: ~NativeModule.cache bootstrap_node.js:604:42 1 0.1% 0.1% Function: ~Buffer.toString buffer.js:609:37 [C++]: ticks total nonlib name 1023 88.8% 88.8% T node::crypto::PBKDF2(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) 27 2.3% 2.3% t node::(anonymous namespace)::ContextifyScript::New(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) ... [Summary]: ticks total nonlib name 3 0.3% 0.3% JavaScript 1105 95.9% 95.9% C++ 3 0.3% 0.3% GC 0 0.0% Shared libraries 44 3.8% Unaccounted [C++ entry points]: ticks cpp total name 1062 98.2% 92.2% T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*) 13 1.2% 1.1% T v8::internal::Runtime_CompileLazy(int, v8::internal::Object**, v8::internal::Isolate*) ... [Bottom up (heavy) profile]: Note: percentage shows a share of a particular caller in the total amount of its parent calls. Callers occupying less than 1.0% are not shown. ticks parent name 1023 88.8% T node::crypto::PBKDF2(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) 1023 100.0% T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*) 1023 100.0% Function: ~pbkdf2 crypto.js:691:16 1023 100.0% Function: ~exports.pbkdf2Sync crypto.js:686:30 1023 100.0% Function: ~hash /Users/nswbmw/Desktop/test/app.js:3:15 1023 100.0% Function: ~&lt;anonymous&gt; /Users/nswbmw/Desktop/test/app.js:1:11 ... æ‰“å°ç»“æœåŒ…å«å…­éƒ¨åˆ†ï¼šShared librariesã€JavaScriptã€C++ã€Summaryã€C++ entry points å’Œ Bottom up (heavy) profileã€‚[JavaScript] éƒ¨åˆ†åˆ—å‡ºäº† JavaScript ä»£ç æ‰§è¡Œæ‰€å ç”¨çš„ CPU ticksï¼ˆCPU æ—¶é’Ÿå‘¨æœŸï¼‰ï¼Œ[C++] éƒ¨åˆ†åˆ—å‡ºäº† C++ ä»£ç æ‰§è¡Œæ‰€å ç”¨çš„ CPU ticksï¼Œ[Summary] åˆ—å‡ºäº†å„ä¸ªéƒ¨åˆ†çš„å æ¯”ï¼Œ[Bottom up] åˆ—å‡ºäº†æ‰€æœ‰ CPU å ç”¨æ—¶é—´ä»å¤§åˆ°å°çš„å‡½æ•°åŠå †æ ˆä¿¡æ¯ï¼Œå°äº 1% çš„åˆ™ä¸äºˆæ˜¾ç¤ºã€‚ å¯ä»¥çœ‹å‡ºï¼š88.8%çš„ CPU æ—¶é—´éƒ½èŠ±åœ¨äº† crypto.js æ–‡ä»¶çš„ pbkdf2Sync å‡½æ•°ä¸Šï¼Œè¯¥å‡½æ•°åœ¨ app.js ç¬¬ 3 è¡Œè¢«è°ƒç”¨ï¼Œå³æˆ‘ä»¬çš„ hash å‡½æ•°ã€‚ è§£å†³æ–¹æ³•ï¼šå°†åŒæ­¥çš„ pbkdf2Sync æ”¹ä¸ºå¼‚æ­¥çš„ pbkdf2ã€‚ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617const crypto = require(&#x27;crypto&#x27;)function hash (password, cb) &#123; const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;) crypto.pbkdf2(password, salt, 10000, 64, &#x27;sha512&#x27;, cb)&#125;let count = 0console.time(&#x27;pbkdf2&#x27;)for (let i = 0; i &lt; 100; i++) &#123; hash(&#x27;random_password&#x27;, () =&gt; &#123; count++ if (count === 100) &#123; console.timeEnd(&#x27;pbkdf2&#x27;) &#125; &#125;)&#125; è¿è¡Œç»“æœï¼š 12$ node --prof apppbkdf2: 656.332ms å¯ä»¥çœ‹å‡ºï¼Œç¨‹åºè¿è¡Œäº† 656.332msï¼Œç›¸æ¯”è¾ƒäºä¹‹å‰çš„ 1375.585msï¼Œæ€§èƒ½æå‡äº† 1 å€ã€‚æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ v8.log çš„åˆ†æç»“æœï¼Œè¿è¡Œï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849$ node --prof-process isolate-0x102802400-v8.logStatistical profiling result from isolate-0x103001a00-v8.log, (198 ticks, 19 unaccounted, 0 excluded). [Shared libraries]: ticks total nonlib name [JavaScript]: ticks total nonlib name 1 0.5% 0.5% StoreIC: A store IC from the snapshot 1 0.5% 0.5% Function: ~set native collection.js:149:4 1 0.5% 0.5% Function: ~pbkdf2 crypto.js:691:16 1 0.5% 0.5% Function: ~inherits util.js:962:18 1 0.5% 0.5% Builtin: ArrayIteratorPrototypeNext [C++]: ticks total nonlib name 83 41.9% 41.9% T ___kdebug_trace_string 31 15.7% 15.7% t node::(anonymous namespace)::ContextifyScript::New(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) 14 7.1% 7.1% T ___pthread_sigmask ... [Summary]: ticks total nonlib name 5 2.5% 2.5% JavaScript 174 87.9% 87.9% C++ 3 1.5% 1.5% GC 0 0.0% Shared libraries 19 9.6% Unaccounted [C++ entry points]: ticks cpp total name 41 60.3% 20.7% T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*) 17 25.0% 8.6% T v8::internal::Runtime_CompileLazy(int, v8::internal::Object**, v8::internal::Isolate*) ... [Bottom up (heavy) profile]: Note: percentage shows a share of a particular caller in the total amount of its parent calls. Callers occupying less than 1.0% are not shown. ticks parent name 83 41.9% T ___kdebug_trace_string 31 15.7% t node::(anonymous namespace)::ContextifyScript::New(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;) 31 100.0% T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*) 31 100.0% Function: ~runInThisContext bootstrap_node.js:495:28 31 100.0% Function: ~NativeModule.compile bootstrap_node.js:584:44 31 100.0% Function: ~NativeModule.require bootstrap_node.js:516:34 ... å¯ä»¥çœ‹å‡ºï¼Œ[Bottom up] æ²¡æœ‰å¾ˆå¤š ticksï¼Œè€Œä¸”ä¸å†æœ‰ pbkdf2 è¿™ç§å †æ ˆä¿¡æ¯ã€‚ 1.3.2 Web UIV8 è¿˜æä¾›äº†ä¸€ä¸ª Web å¯è§†åŒ–å·¥å…·æ¥æŸ¥çœ‹ç”Ÿæˆçš„ v8 æ—¥å¿—ã€‚é¦–å…ˆï¼Œå°†ä»£ç è¿˜åŸåˆ°ä½¿ç”¨ pbkdf2Sync çš„ç‰ˆæœ¬ï¼Œè¿è¡Œï¼š 1234$ node --prof app # ç”Ÿæˆ isolate-0x103000000-v8.log$ node --prof-process --preprocess isolate-0x103000000-v8.log &gt; v8.json # æ ¼å¼åŒ–æˆ JSON æ–‡ä»¶$ git clone https://github.com/v8/v8.git # å…‹éš† v8 ä»“åº“$ open v8/tools/profview/index.html # æ‰“å¼€ V8 profiling log processor ç‚¹å‡» â€œé€‰æ‹©æ–‡ä»¶â€ï¼Œé€‰æ‹©åˆšæ‰ç”Ÿæˆçš„ v8.json æ–‡ä»¶ï¼Œç‚¹å‡» â€œBottom upâ€ è§†å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š æœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦è§£é‡Šï¼š å›¾ä¸­çš„ä¸ŠåŠéƒ¨åˆ†å±•ç¤ºäº† CPU çš„ timelineï¼ŒX è½´ä»£è¡¨æ—¶é—´çš„æµé€ï¼ŒY è½´ä»£è¡¨å½“å‰æ—¶é—´ç‚¹ä¸åŒéƒ¨åˆ†å ç”¨ CPU çš„æ¯”ä¾‹ï¼Œå¯ä»¥åœ¨ timeline å›¾è¡¨ä¸Šå•å‡»å·¦é”®ä¸æ”¾ï¼Œç„¶åæ‹–åŠ¨ï¼Œé€‰æ‹©æ—¶é—´åŒºé—´ã€‚ å›¾ä¸­çš„ä¸‹åŠéƒ¨åˆ†å±•ç¤ºäº†å½“å‰æ—¶é—´æ®µå†… CPU å ç”¨æ¯”ä»å¤§åˆ°å°é™åºæ’åˆ—çš„å‡½æ•°ï¼Œå±•å¼€å¯æŸ¥çœ‹å †æ ˆä¿¡æ¯ã€‚ä¸åŒçš„é¢œè‰²ä»£è¡¨äº†ä¸åŒçš„éƒ¨åˆ†ï¼Œç‚¹å‡»ä»»æ„ä¸€ä¸ªå‡½æ•°ï¼Œtimeline åº•éƒ¨ä¼šå±•ç¤ºè¯¥å‡½æ•°çš„æ‰§è¡Œæ—¶é—´åˆ†å¸ƒã€‚ 1.3.3 å‚è€ƒé“¾æ¥ https://github.com/v8/v8/wiki/V8-Profiler https://blog.ghaiklor.com/profiling-nodejs-applications-1609b77afe4e https://stackoverflow.com/questions/23934451/how-to-read-nodejs-internal-profiler-tick-processor-output","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging, 1.2 How to use v8-profiler","slug":"1.2.1 ä½¿ç”¨ v8-profiler","date":"2019-03-23T06:00:00.000Z","updated":"2022-05-25T04:22:04.311Z","comments":true,"path":"2019/03/23/1.2.1 ä½¿ç”¨ v8-profiler/","link":"","permalink":"https://marvinliu1.github.io/2019/03/23/1.2.1%20%E4%BD%BF%E7%94%A8%20v8-profiler/","excerpt":"","text":"Node in Debugging æˆ‘ä»¬çŸ¥é“ Node.js æ˜¯åŸºäº V8 å¼•æ“çš„ï¼ŒV8 æš´éœ²äº†ä¸€äº› profiler APIï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ v8-profiler æ”¶é›†ä¸€äº›è¿è¡Œæ—¶æ•°æ®ï¼ˆä¾‹å¦‚ï¼šCPU å’Œå†…å­˜ï¼‰ã€‚æœ¬èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ v8-profiler åˆ†æ CPU çš„ä½¿ç”¨æƒ…å†µã€‚ 1.2.1 ä½¿ç”¨ v8-profileråˆ›å»ºæµ‹è¯•ä»£ç ï¼š app.js 12345678910111213141516171819202122232425262728const fs = require(&#x27;fs&#x27;)const crypto = require(&#x27;crypto&#x27;)const Bluebird = require(&#x27;bluebird&#x27;)const profiler = require(&#x27;v8-profiler&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/encrypt&#x27;, controller: function encryptRouter (ctx) &#123; const password = ctx.query.password || &#x27;test&#x27; const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;) const encryptedPassword = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;) ctx.body = encryptedPassword&#125;&#125;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/cpuprofile&#x27;, async controller (ctx) &#123; //Start Profiling profiler.startProfiling(&#x27;CPU profile&#x27;) await Bluebird.delay(30000) //Stop Profiling after 30s const profile = profiler.stopProfiling() profile.export() .pipe(fs.createWriteStream(`cpuprofile-$&#123;Date.now()&#125;.cpuprofile`)) .on(&#x27;finish&#x27;, () =&gt; profile.delete()) ctx.status = 204&#125;&#125;) app.listen(3000) GET /encrypt æœ‰ä¸€ä¸ª CPU å¯†é›†å‹çš„è®¡ç®—å‡½æ•° crypto.pbkdf2Syncï¼ŒGET /cpuprofile ç”¨æ¥æ”¶é›† 30s çš„ V8 log ç„¶åå°†å…¶ dump åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ è¿è¡Œè¯¥ç¨‹åºï¼Œæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯çª—å£ã€‚ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š 1$ curl localhost:3000/cpuprofile æ¥è§¦å‘ CPU profilingï¼Œç„¶åå¦ä¸€ä¸ªç»ˆç«¯ç«‹å³è¿è¡Œï¼š 1$ ab -c 20 -n 2000 &quot;http://localhost:3000/encrypt?password=123456&quot; æ¥è§¦å‘ CPU å¯†é›†è®¡ç®—ã€‚ æœ€åç”Ÿæˆ cpuprofile-xxx.cpuprofile æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹å…¶å®å°±æ˜¯ä¸€ä¸ªå¤§çš„ JSON å¯¹è±¡ï¼Œå¤§ä½“å¦‚ä¸‹ï¼š 12345678910111213141516171819&#123; &quot;typeId&quot;: &quot;CPU&quot;, &quot;uid&quot;: &quot;1&quot;, &quot;title&quot;: &quot;CPU profile&quot;, &quot;head&quot;: &#123; &quot;functionName&quot;: &quot;(root)&quot;, &quot;url&quot;: &quot;&quot;, &quot;lineNumber&quot;: 0, &quot;callUID&quot;: 154, &quot;bailoutReason&quot;: &quot;&quot;, &quot;id&quot;: 1, &quot;scriptId&quot;: 0, &quot;hitCount&quot;: 0, &quot;children&quot;: [ ... ] &#125;, &quot;startTime&quot;: 276245, &quot;endTime&quot;: 276306, &quot;samples&quot;: [ ... ], &quot;timestamps&quot;: [ ... ]&#125; è¿™ä¸ª JSON å¯¹è±¡è®°å½•äº†å‡½æ•°è°ƒç”¨æ ˆã€è·¯å¾„ã€æ—¶é—´æˆ³å’Œä¸€äº›å…¶ä»–ä¿¡æ¯ï¼Œsamples èŠ‚ç‚¹æ•°ç»„ä¸ timestamps èŠ‚ç‚¹æ•°ç»„ä¸­çš„æ—¶é—´æˆ³æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¹¶ä¸” samples èŠ‚ç‚¹æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå€¼å…¶å®å¯¹åº”äº† head èŠ‚ç‚¹çš„æ·±åº¦ä¼˜å…ˆéå† IDã€‚è¿™é‡Œæˆ‘ä»¬ä¸æ·±ç©¶æ¯ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œå…ˆæ¥çœ‹çœ‹å¦‚ä½•å¯è§†åŒ–è¿™äº›æ•°æ®ã€‚ 1.2.2 æ–¹æ³• 1â€”â€”Chrome DevToolsChrome è‡ªå¸¦äº†åˆ†æ CPU profile æ—¥å¿—çš„å·¥å…·ã€‚æ‰“å¼€ Chrome -&gt; è°ƒå‡ºå¼€å‘è€…å·¥å…·ï¼ˆDevToolsï¼‰ -&gt; å•å‡»å³ä¸Šè§’ä¸‰ä¸ªç‚¹çš„æŒ‰é’® -&gt; More tools -&gt; JavaScript Profiler -&gt; Loadï¼ŒåŠ è½½åˆšæ‰ç”Ÿæˆçš„ cpuprofile æ–‡ä»¶ã€‚å·¦ä¸Šè§’çš„ä¸‹æ‹‰èœå•å¯ä»¥é€‰æ‹©å¦‚ä¸‹ä¸‰ç§æ¨¡å¼ï¼š Chartï¼šæ˜¾ç¤ºæŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„ç«ç„°å›¾ã€‚ Heavy (Bottom Up)ï¼šæŒ‰ç…§å‡½æ•°å¯¹æ€§èƒ½çš„å½±å“æ’åˆ—ï¼ŒåŒæ—¶å¯ä»¥æ£€æŸ¥å‡½æ•°çš„è°ƒç”¨è·¯å¾„ã€‚ Tree (Top Down)ï¼šæ˜¾ç¤ºè°ƒç”¨ç»“æ„çš„æ€»ä½“çŠ¶å†µï¼Œä»è°ƒç”¨å †æ ˆçš„é¡¶ç«¯å¼€å§‹ã€‚ è¿™é‡Œæˆ‘ä»¬é€‰æ‹© Tree (Top Down) æ¨¡å¼ï¼ŒæŒ‰ Total Time é™åºæ’åˆ—ã€‚å¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹ä¸‰åˆ—ï¼š Self Timeï¼šå‡½æ•°è°ƒç”¨æ‰€è€—è´¹çš„æ—¶é—´ï¼Œä»…åŒ…å«å‡½æ•°æœ¬èº«çš„å£°æ˜ï¼Œä¸åŒ…å«ä»»ä½•å­å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚ Total Timeï¼šå‡½æ•°è°ƒç”¨æ‰€è€—è´¹çš„æ€»æ—¶é—´ï¼ŒåŒ…å«å‡½æ•°æœ¬èº«çš„å£°æ˜åŠæ‰€æœ‰å­å‡½æ•°æ‰§è¡Œæ—¶é—´ã€‚å³ï¼šçˆ¶å‡½æ•°çš„ Total Time &#x3D; çˆ¶å‡½æ•°çš„ Self Time + æ‰€æœ‰å­å‡½æ•°çš„ Total Timeã€‚ Functionï¼šå‡½æ•°ååŠè·¯å¾„ï¼Œå¯å±•å¼€æŸ¥çœ‹å­å‡½æ•°ã€‚ æˆ‘ä»¬ä¸æ–­åœ°å±•å¼€ï¼Œå¹¶å®šä½åˆ°äº† encryptRouterï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šæˆ‘ä»¬å®šä½åˆ°äº† encryptRouter è¿™ä¸ªè·¯ç”±ï¼Œå¹¶ä¸”è¿™ä¸ªè·¯ç”±ä¸­ exports.pbkdf2Sync å æ®äº†ç»å¤§éƒ¨åˆ† CPU æ—¶é—´ã€‚ 1.2.3 æ–¹æ³• 2â€”â€”ç«ç„°å›¾æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç«ç„°å›¾æ¥å±•ç¤º cpuprofile æ•°æ®ã€‚é¦–å…ˆå…¨å±€å®‰è£… flamegraph æ¨¡å—ï¼š 1$ npm i flamegraph -g è¿è¡Œä»¥ä¸‹å‘½ä»¤å°† cpuprofile æ–‡ä»¶ç”Ÿæˆ svg æ–‡ä»¶ï¼š 1$ flamegraph -t cpuprofile -f cpuprofile-xxx.cpuprofile -o cpuprofile.svg ç”¨æµè§ˆå™¨æ‰“å¼€ cpuprofile.svgï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºï¼šæˆ‘ä»¬å®šä½åˆ°äº† app.js çš„ç¬¬ 8 è¡Œï¼Œå³ encryptRouter è¿™ä¸ªè·¯ç”±ï¼Œå¹¶ä¸”è¿™ä¸ªè·¯ç”±ä¸­ exports.pbkdf2Sync å æ®äº†ç»å¤§éƒ¨åˆ† CPU æ—¶é—´ã€‚ 1.2.4 æ–¹æ³• 3â€”â€”v8-analyticsv8-analytics æ˜¯ç¤¾åŒºå¼€æºçš„ä¸€ä¸ªè§£æ v8-profiler å’Œ heapdump ç­‰æ¨¡å—ç”Ÿæˆçš„ CPU å’Œ heap-memory æ—¥å¿—çš„å·¥å…·ã€‚å®ƒæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š å°† V8 å¼•æ“é€†ä¼˜åŒ–æˆ–è€…ä¼˜åŒ–å¤±è´¥çš„å‡½æ•°æ ‡çº¢å±•ç¤ºï¼Œå¹¶å±•ç¤ºä¼˜åŒ–å¤±è´¥çš„åŸå› ã€‚ åœ¨å‡½æ•°æ‰§è¡Œæ—¶é•¿è¶…è¿‡é¢„æœŸæ—¶æ ‡çº¢å±•ç¤ºã€‚ å±•ç¤ºå½“å‰é¡¹ç›®ä¸­å¯ç–‘çš„å†…å­˜æ³„æ¼ç‚¹ã€‚ æˆ‘ä»¬ä»¥ä¸Šè¿°ç¬¬ 2 ä¸ªåŠŸèƒ½ä¸ºä¾‹ï¼Œä½¿ç”¨ v8-analytics åˆ†æ CPU çš„ä½¿ç”¨æƒ…å†µã€‚ é¦–å…ˆï¼Œå…¨å±€å®‰è£… v8-analyticsï¼š 1$ npm i v8-analytics -g ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰§è¡Œæ—¶é—´å¤§äº 200ms çš„å‡½æ•°ï¼š 1$ va timeout cpuprofile-xxx.cpuprofile 200 --only ç»“æœæˆªå›¾å¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºï¼šæˆ‘ä»¬ä¾ç„¶èƒ½å¤Ÿå®šä½åˆ° encryptRouter å’Œ exports.pbkdf2Syncã€‚ 1.2.5 å‚è€ƒé“¾æ¥ https://developers.google.com/web/tools/chrome-devtools/rendering-tools/js-execution http://www.ebaytechblog.com/2016/06/15/igniting-node-js-flames/ https://cnodejs.org/topic/58b562f97872ea0864fee1a7 https://github.com/hyj1991/v8-analytics/blob/master/README_ZH.md","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Node in Debugging 1.1 Perf + FameGraph","slug":"1.1.1 perf","date":"2019-03-21T06:00:00.000Z","updated":"2022-05-25T04:21:57.857Z","comments":true,"path":"2019/03/21/1.1.1 perf/","link":"","permalink":"https://marvinliu1.github.io/2019/03/21/1.1.1%20perf/","excerpt":"","text":"Node in Debugging å½“ç¨‹åºå‡ºç°æ€§èƒ½ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸é€šè¿‡è¡¨è±¡ï¼ˆæ¯”å¦‚è¯·æ±‚æŸä¸ªæ¥å£æ—¶ CPU ä½¿ç”¨ç‡é£™æ¶¨ï¼‰ç„¶åç»“åˆä»£ç å»æ¨æµ‹å¯èƒ½å‡ºé—®é¢˜çš„åœ°æ–¹ï¼Œå´ä¸çŸ¥é“é—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆå¼•èµ·çš„ã€‚å¦‚æœæœ‰ä¸ªä¸€å¯è§†åŒ–çš„å·¥å…·ç›´è§‚åœ°å±•ç°ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆå°±å¥½äº†ï¼Œå¹¸å¥½ Brendan D. Gregg å‘æ˜äº†ç«ç„°å›¾ã€‚ ç«ç„°å›¾ï¼ˆFlame Graphï¼‰çœ‹èµ·æ¥å°±åƒä¸€å›¢è·³åŠ¨çš„ç«ç„°ï¼Œå› æ­¤å¾—åã€‚ç«ç„°å›¾å¯ä»¥å°† CPU çš„ä½¿ç”¨æƒ…å†µå¯è§†åŒ–ï¼Œä½¿æˆ‘ä»¬ç›´è§‚åœ°äº†è§£åˆ°ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œé€šå¸¸è¦ç»“åˆæ“ä½œç³»ç»Ÿçš„æ€§èƒ½åˆ†æå·¥å…·ï¼ˆprofiling tracerï¼‰ä½¿ç”¨ï¼Œå¸¸è§çš„æ“ä½œç³»ç»Ÿçš„æ€§èƒ½åˆ†æå·¥å…·å¦‚ä¸‹ï¼š Linuxï¼šperf, eBPF, SystemTap, and ktapã€‚ Solaris, illumos, FreeBSDï¼šDTraceã€‚ Mac OS Xï¼šDTrace and Instrumentsã€‚ Windowsï¼šXperf.exeã€‚ 1.1.1 perfperf_eventsï¼ˆç®€ç§° perfï¼‰æ˜¯ Linux Kernal è‡ªå¸¦çš„ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿè¿›è¡Œå‡½æ•°çº§ä¸æŒ‡ä»¤çº§çš„çƒ­ç‚¹æŸ¥æ‰¾ã€‚å®ƒåŸºäºäº‹ä»¶é‡‡æ ·åŸç†ï¼Œä»¥æ€§èƒ½äº‹ä»¶ä¸ºåŸºç¡€ï¼Œæ”¯æŒé’ˆå¯¹å¤„ç†å™¨ç›¸å…³æ€§èƒ½æŒ‡æ ‡ä¸æ“ä½œç³»ç»Ÿç›¸å…³æ€§èƒ½æŒ‡æ ‡çš„æ€§èƒ½å‰–æï¼Œå¸¸ç”¨äºæŸ¥æ‰¾æ€§èƒ½ç“¶é¢ˆåŠå®šä½çƒ­ç‚¹ä»£ç ã€‚ æµ‹è¯•æœºå™¨ï¼š 12$ uname -aLinux nswbmw-VirtualBox 4.10.0-28-generic #32~16.04.2-Ubuntu SMP Thu Jul 20 10:19:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux æ³¨æ„ï¼šé Linux ç”¨æˆ·éœ€è¦ç”¨è™šæ‹Ÿæœºå®‰è£… Ubuntu 16.04 å’Œ &#110;&#111;&#x64;&#x65;&#x40;&#56;&#46;&#57;&#x2e;&#x34; åè¿›è¡Œåé¢çš„æ“ä½œã€‚ å®‰è£… perfï¼š 123$ sudo apt install linux-tools-common$ perf # æ ¹æ®æç¤ºå®‰è£…å¯¹åº”çš„å†…æ ¸ç‰ˆæœ¬çš„ tools, å¦‚ä¸‹$ sudo apt install linux-tools-4.10.0-28-generic linux-cloud-tools-4.10.0-28-generic åˆ›å»ºæµ‹è¯•ç›®å½• ~&#x2F;test å’Œæµ‹è¯•ä»£ç ï¼š app.js 12345678910111213141516171819202122232425262728293031323334const crypto = require(&#x27;crypto&#x27;)const Paloma = require(&#x27;paloma&#x27;)const app = new Paloma()const users = &#123;&#125;app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/newUser&#x27;, controller (ctx) &#123; const username = ctx.query.username || &#x27;test&#x27; const password = ctx.query.password || &#x27;test&#x27; const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;) const hash = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;) users[username] = &#123; salt, hash &#125; ctx.status = 204&#125;&#125;)app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/auth&#x27;, controller (ctx) &#123; const username = ctx.query.username || &#x27;test&#x27; const password = ctx.query.password || &#x27;test&#x27; if (!users[username]) &#123; ctx.throw(400) &#125; const hash = crypto.pbkdf2Sync(password, users[username].salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;) if (users[username].hash === hash) &#123; ctx.status = 204 &#125; else &#123; ctx.throw(403) &#125;&#125;&#125;) app.listen(3000) æ·»åŠ  â€“perf_basic_profï¼ˆæˆ–è€… â€“perf-basic-profï¼‰å‚æ•°è¿è¡Œæ­¤ç¨‹åºï¼Œä¼šå¯¹åº”ç”Ÿæˆä¸€ä¸ª &#x2F;tmp&#x2F;perf-.map çš„æ–‡ä»¶ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š 12345678910111213$ node --perf_basic_prof app.js &amp;[1] 3590$ tail /tmp/perf-3590.map51b87a7b93e 18 Function:~emitListeningNT net.js:137551b87a7b93e 18 LazyCompile:~emitListeningNT net.js:137551b87a7bad6 39 Function:~emitAfterScript async_hooks.js:44351b87a7bad6 39 LazyCompile:~emitAfterScript async_hooks.js:44351b87a7bcbe 77 Function:~tickDone internal/process/next_tick.js:8851b87a7bcbe 77 LazyCompile:~tickDone internal/process/next_tick.js:8851b87a7bf36 12 Function:~clear internal/process/next_tick.js:4251b87a7bf36 12 LazyCompile:~clear internal/process/next_tick.js:4251b87a7c126 b8 Function:~emitPendingUnhandledRejections internal/process/promises.js:8651b87a7c126 b8 LazyCompile:~emitPendingUnhandledRejections internal/process/promises.js:86 map æ–‡ä»¶å†…å®¹ä¸‰åˆ—ä¾æ¬¡ä¸ºï¼š16è¿›åˆ¶çš„ç¬¦å·åœ°å€ï¼ˆsymbol addressesï¼‰ã€å¤§å°ï¼ˆsizesï¼‰å’Œç¬¦å·åï¼ˆsymbol namesï¼‰ã€‚perf ä¼šå°è¯•æŸ¥æ‰¾ &#x2F;tmp&#x2F;perf-.map æ–‡ä»¶ï¼Œç”¨æ¥åšç¬¦å·è½¬æ¢ï¼Œå³æŠŠ 16 è¿›åˆ¶çš„ç¬¦å·åœ°å€è½¬æ¢æˆäººèƒ½è¯»æ‡‚çš„ç¬¦å·åã€‚ æ³¨æ„ï¼šä½¿ç”¨ â€“perf_basic_prof_only_functions å‚æ•°ä¹Ÿå¯ä»¥ï¼Œä½†ç»å°è¯•åå‘ç°ç”Ÿæˆçš„ç«ç„°å›¾ä¿¡æ¯ä¸å…¨ï¼ˆä¸å…¨çš„åœ°æ–¹æ˜¾ç¤º [perf-.map]ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ â€“perf_basic_profã€‚ä½†æ˜¯ï¼Œä½¿ç”¨ â€“perf_basic_prof æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ä¼šå¯¼è‡´ map æ–‡ä»¶ä¸€ç›´å¢å¤§ï¼Œè¿™æ˜¯ç”±äºç¬¦å·ï¼ˆsymbolsï¼‰åœ°å€ä¸æ–­å˜æ¢å¯¼è‡´çš„ï¼Œç”¨ â€“perf_basic_prof_only_functions å¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚å…³äºå¦‚ä½•å–èˆï¼Œè¿˜è¯·è¯»è€…è‡ªè¡Œå°è¯•ã€‚ æ¥ä¸‹æ¥ clone ç”¨æ¥ç”Ÿæˆç«ç„°å›¾çš„å·¥å…·ï¼š 1$ git clone http://github.com/brendangregg/FlameGraph ~/FlameGraph æˆ‘ä»¬å…ˆç”¨ ab å‹æµ‹ï¼š 12$ curl &quot;http://localhost:3000/newUser?username=admin&amp;password=123456&quot;$ ab -k -c 10 -n 2000 &quot;http://localhost:3000/auth?username=admin&amp;password=123456&quot; æ–°å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼Œåœ¨ ab å¼€å§‹å‹æµ‹åç«‹å³è¿è¡Œï¼š 1234$ sudo perf record -F 99 -p 3590 -g -- sleep 30$ sudo chown root /tmp/perf-3590.map$ sudo perf script &gt; perf.stacks$ ~/FlameGraph/stackcollapse-perf.pl --kernel &lt; ~/perf.stacks | ~/FlameGraph/flamegraph.pl --color=js --hash&gt; ~/flamegraph.svg æ³¨æ„ï¼šç¬¬ 1 æ¬¡ç”Ÿæˆçš„ svg å¯èƒ½ä¸å¤ªå‡†ç¡®ï¼Œæœ€å¥½é‡å¤å‡ æ¬¡ä»¥ä¸Šæ­¥éª¤ï¼Œä½¿ç”¨ç¬¬ 2 æ¬¡åŠä»¥åç”Ÿæˆçš„ flamegraph.svgã€‚ æœ‰å‡ ç‚¹éœ€è¦è§£é‡Šä¸€ä¸‹ï¼š perf record -F æŒ‡å®šäº†é‡‡æ ·é¢‘ç‡ 99Hzï¼ˆå³æ¯ç§’ 99 æ¬¡ï¼Œå¦‚æœ 99 æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªå‡½æ•°åï¼Œé‚£å°±è¯´æ˜ CPU åœ¨è¿™ä¸€ç§’é’Ÿéƒ½åœ¨æ‰§è¡ŒåŒä¸€ä¸ªå‡½æ•°ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼‰ã€‚ -p æŒ‡å®šè¿›ç¨‹çš„ pidã€‚ -g å¯ç”¨ call-graph è®°å½•ã€‚ â€“ sleep 30 æŒ‡å®šè®°å½• 30sã€‚ sudo chown root &#x2F;tmp&#x2F;perf-3009.mapï¼Œå°† map æ–‡ä»¶æ›´æ”¹ä¸º root æƒé™ï¼Œå¦åˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š File &#x2F;tmp&#x2F;perf-PID.map not owned by current user or root, ignoring it (use -f to override). Failed to open &#x2F;tmp&#x2F;perf-PID.map, continuing without symbols perf record ä¼šå°†è®°å½•çš„ä¿¡æ¯ä¿å­˜åˆ°å½“å‰æ‰§è¡Œç›®å½•çš„ perf.data æ–‡ä»¶ä¸­ï¼Œç„¶åä½¿ç”¨ perf script è¯»å– perf.data çš„ trace ä¿¡æ¯å†™å…¥ perf.stacksã€‚ â€“color&#x3D;js æŒ‡å®šç”Ÿæˆé’ˆå¯¹ JavaScript é…è‰²çš„ svgï¼Œå³ï¼š greenï¼šJavaScriptã€‚ blueï¼šBuiltinã€‚ yellowï¼šC++ã€‚ redï¼šSystemï¼ˆnative user-level, and kernelï¼‰ã€‚ ab å‹æµ‹ç”¨äº† 30s å·¦å³ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ flamegraph.svgï¼Œæˆªå–å…³é”®çš„éƒ¨åˆ†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š 1.1.2 ç†è§£ç«ç„°å›¾ç«ç„°å›¾å«ä¹‰ï¼š æ¯ä¸€ä¸ªå°å—ä»£è¡¨äº†ä¸€ä¸ªå‡½æ•°åœ¨æ ˆä¸­çš„ä½ç½®ï¼ˆå³ä¸€ä¸ªæ ˆå¸§ï¼‰ã€‚ Y è½´ä»£è¡¨æ ˆçš„æ·±åº¦ï¼ˆæ ˆä¸Šçš„å¸§æ•°ï¼‰ï¼Œé¡¶ç«¯çš„å°å—æ˜¾ç¤ºäº†å æ® CPU çš„å‡½æ•°ã€‚æ¯ä¸ªå°å—çš„ä¸‹é¢æ˜¯å®ƒçš„ç¥–å…ˆï¼ˆå³çˆ¶å‡½æ•°ï¼‰ã€‚ X è½´ä»£è¡¨æ€»çš„æ ·ä¾‹ç¾¤ä½“ã€‚å®ƒä¸åƒç»å¤§å¤šæ•°å›¾è¡¨é‚£æ ·ä»å·¦åˆ°å³è¡¨ç¤ºæ—¶é—´çš„æµé€ï¼Œå…¶å·¦å³é¡ºåºæ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œä»…ä»…æŒ‰ç…§å­—æ¯è¡¨çš„é¡ºåºæ’åˆ—ã€‚ å°å—çš„å®½åº¦ä»£è¡¨ CPU çš„ä½¿ç”¨æ—¶é—´ï¼Œæˆ–è€…è¯´ç›¸å¯¹äºçˆ¶å‡½æ•°è€Œè¨€ä½¿ç”¨ CPU çš„æ¯”ä¾‹ï¼ˆåŸºäºæ‰€æœ‰æ ·ä¾‹ï¼‰ï¼Œè¶Šå®½åˆ™ä»£è¡¨å ç”¨ CPU çš„æ—¶é—´è¶Šé•¿ï¼Œæˆ–è€…ä½¿ç”¨ CPU å¾ˆé¢‘ç¹ã€‚ å¦‚æœé‡‡å–å¤šçº¿ç¨‹å¹¶å‘è¿è¡Œå–æ ·ï¼Œåˆ™å–æ ·æ•°é‡ä¼šè¶…è¿‡è¿è¡Œæ—¶é—´ã€‚ ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šæœ€ä¸Šé¢çš„ç»¿è‰²å°å—ï¼ˆå³ JavaScript ä»£ç ï¼‰æŒ‡å‘ test&#x2F;app.js ç¬¬ 18 è¡Œï¼Œå³ GET /auth è¿™ä¸ªè·¯ç”±ã€‚å†å¾€ä¸Šçœ‹ï¼Œé»„è‰²çš„å°å—ï¼ˆå³ C++ ä»£ç ï¼‰ node::crypto::PBKDF2 å ç”¨äº†å¤§é‡çš„ CPU æ—¶é—´ã€‚ è§£å†³æ–¹æ³•ï¼šå°†åŒæ­¥æ”¹ä¸ºå¼‚æ­¥ï¼Œå³å°† crypto.pbkdf2Sync æ”¹ä¸º crypto.pbkdf2ã€‚ä¿®æ”¹å¦‚ä¸‹ï¼š 12345678910111213141516171819202122app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/auth&#x27;, async controller (ctx) &#123; const username = ctx.query.username || &#x27;test&#x27; const password = ctx.query.password || &#x27;test&#x27; if (!users[username]) &#123; ctx.throw(400) &#125; const hash = await new Promise((resolve, reject) =&gt; &#123; crypto.pbkdf2(password, users[username].salt, 10000, 64, &#x27;sha512&#x27;, (err, derivedKey) =&gt; &#123; if (err) &#123; return reject(err) &#125; resolve(derivedKey.toString(&#x27;hex&#x27;)) &#125;) &#125;) if (users[username].hash === hash) &#123; ctx.status = 204 &#125; else &#123; ctx.throw(403) &#125;&#125;&#125;) ç”¨ ab é‡æ–°å‹æµ‹ï¼Œç»“æœç”¨äº† 16sã€‚é‡æ–°ç”Ÿæˆçš„ç«ç„°å›¾å¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºï¼šåªæœ‰åœ¨å·¦ä¾§æçª„çš„ç»¿è‰²å°å—å¯ä»¥çœ‹åˆ° JavaScript ä»£ç ï¼Œçº¢è‰²çš„éƒ¨åˆ†æˆ‘ä»¬ä¸å…³å¿ƒä¹Ÿæ— æ³•ä¼˜åŒ–ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå¼‚æ­¥æ¯”åŒæ­¥çš„ QPS è¦é«˜å‘¢ï¼ŸåŸå› æ˜¯ Node.js åº•å±‚çš„ libuv ç”¨äº†å¤šä¸ªçº¿ç¨‹è¿›è¡Œè®¡ç®—ï¼Œè¿™é‡Œå°±ä¸å†æ·±å…¥ä»‹ç»äº†ã€‚ svg ç«ç„°å›¾çš„å…¶ä»–å°æŠ€å·§å¦‚ä¸‹ï¼š å•å‡»ä»»æ„ä¸€ä¸ªå°å—å³å¯å±•å¼€ï¼Œå³è¢«å•å‡»çš„å°å—å®½åº¦å˜å®½ï¼Œå®ƒçš„å­å‡½æ•°ä¹ŸæŒ‰æ¯”ä¾‹å˜å®½ï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚ å¯å•å‡» svg å³ä¸Šè§’çš„ search æŒ‰é’®è¿›è¡Œæœç´¢ï¼Œè¢«æœç´¢çš„å…³é”®è¯ä¼šé«˜äº®æ˜¾ç¤ºï¼Œåœ¨æœ‰ç›®çš„åœ°æŸ¥æ‰¾æŸä¸ªå‡½æ•°æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚ 1.1.3 çº¢è“å·®åˆ†ç«ç„°å›¾è™½ç„¶æˆ‘ä»¬æœ‰äº†ç«ç„°å›¾ï¼Œä½†è¦å¤„ç†æ€§èƒ½å›é€€é—®é¢˜ï¼Œè¿˜éœ€è¦åœ¨ä¿®æ”¹ä»£ç å‰åçš„ç«ç„°å›¾ä¹‹é—´ï¼Œä¸æ–­åˆ‡æ¢å’Œå¯¹æ¯”ï¼Œæ¥æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œå¾ˆä¸æ–¹ä¾¿ã€‚äºæ˜¯ Brendan D. Gregg åˆå‘æ˜äº†çº¢è“å·®åˆ†ç«ç„°å›¾ï¼ˆRed&#x2F;Blue Differential Flame Graphsï¼‰ã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼šçº¢è‰²è¡¨ç¤ºå¢é•¿ï¼Œè“è‰²è¡¨ç¤ºè¡°å‡ã€‚ çº¢è“å·®åˆ†ç«ç„°å›¾çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š æŠ“å–ä¿®æ”¹å‰çš„æ ˆ profile1 æ–‡ä»¶ã€‚ æŠ“å–ä¿®æ”¹åçš„æ ˆ profile2 æ–‡ä»¶ã€‚ ä½¿ç”¨ profile2 æ¥ç”Ÿæˆç«ç„°å›¾ï¼Œè¿™æ ·æ ˆå¸§çš„å®½åº¦å°±æ˜¯ä»¥ profile2 æ–‡ä»¶ä¸ºåŸºå‡†çš„ã€‚ ä½¿ç”¨ profile2 - profile1 çš„å·®å¼‚æ¥å¯¹ç«ç„°å›¾é‡æ–°ä¸Šè‰²ã€‚ä¸Šè‰²çš„åŸåˆ™æ˜¯ï¼šå¦‚æœæ ˆå¸§åœ¨ profile2 ä¸­å‡ºç°å‡ºç°çš„æ¬¡æ•°æ›´å¤šï¼Œåˆ™æ ‡ä¸ºçº¢è‰²ï¼Œå¦åˆ™æ ‡ä¸ºè“è‰²ã€‚è‰²å½©æ˜¯æ ¹æ®ä¿®æ”¹å‰åçš„å·®å¼‚æ¥å¡«å……çš„ã€‚ è¿™æ ·ï¼Œé€šè¿‡çº¢è“å·®åˆ†ç«ç„°å›¾ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ç³»ç»Ÿæ€§èƒ½çš„å·®å¼‚ä¹‹å¤„ã€‚ ç”Ÿæˆçº¢è“å·®åˆ†ç«ç„°å›¾çš„æµç¨‹å¦‚ä¸‹ï¼š ä¿®æ”¹ä»£ç å‰è¿è¡Œï¼š 123$ sudo perf record -F 99 -p &lt;PID&gt; -g -- sleep 30$ sudo chown root /tmp/perf-&lt;PID&gt;.map$ sudo perf script &gt; perf_before.stacks ä¿®æ”¹ä»£ç åè¿è¡Œï¼š 123$ sudo perf record -F 99 -p &lt;PID&gt; -g -- sleep 30$ sudo chown root /tmp/perf-&lt;PID&gt;.map$ sudo perf script &gt; perf_after.stacks å°† profile æ–‡ä»¶è¿›è¡ŒæŠ˜å ï¼ˆfoldï¼‰ï¼Œç„¶åç”Ÿæˆå·®åˆ†ç«ç„°å›¾ï¼š 123$ ~/FlameGraph/stackcollapse-perf.pl ~/perf_before.stacks &gt; perf_before.folded$ ~/FlameGraph/stackcollapse-perf.pl ~/perf_after.stacks &gt; perf_after.folded$ ./FlameGraph/difffolded.pl perf_before.folded perf_after.folded | ./FlameGraph/flamegraph.pl &gt; flamegraph_diff.svg å¦‚ä¸Šç¼ºç‚¹æ˜¯ï¼šå¦‚æœä¸€ä¸ªä»£ç æ‰§è¡Œè·¯å¾„å®Œå…¨æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆåœ¨ç«ç„°å›¾ä¸­å°±æ‰¾ä¸åˆ°åœ°æ–¹æ¥æ ‡æ³¨è“è‰²ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°å½“å‰çš„ CPU ä½¿ç”¨æƒ…å†µï¼Œå´ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·ã€‚ ä¸€ç§è§£å†³åŠæ³•æ˜¯ï¼šç”Ÿæˆä¸€ä¸ªç›¸åçš„å·®åˆ†ç«ç„°å›¾ï¼Œå³åŸºäº profile1 ç”Ÿæˆ profile1 - profile2 çš„å·®åˆ†ç«ç„°å›¾ã€‚å¯¹åº”å‘½ä»¤å¦‚ä¸‹ï¼š 1$ ./FlameGraph/difffolded.pl perf_after.folded perf_before.folded | ./FlameGraph/flamegraph.pl --negate &gt; flamegraph_diff2.svg å…¶ä¸­ï¼Œâ€“negate ç”¨äºé¢ å€’çº¢&#x2F;è“é…è‰²ã€‚æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°ï¼š flamegraph_diff.svgï¼šå®½åº¦æ˜¯ä»¥ä¿®æ”¹å‰çš„ profile æ–‡ä»¶ä¸ºåŸºå‡†ï¼Œé¢œè‰²è¡¨æ˜å°†è¦å‘ç”Ÿçš„æƒ…å†µã€‚ flamegraph_diff2.svgï¼šå®½åº¦æ˜¯ä»¥ä¿®æ”¹åçš„ profile æ–‡ä»¶ä¸ºåŸºå‡†ï¼Œé¢œè‰²è¡¨æ˜å·²ç»å‘ç”Ÿçš„æƒ…å†µã€‚ æ€»ä¹‹ï¼Œçº¢è“å·®åˆ†ç«ç„°å›¾å¯èƒ½åªåœ¨ä»£ç å˜åŒ–ä¸å¤§çš„æƒ…å†µä¸‹ä½¿ç”¨æ—¶æ•ˆæœæ˜æ˜¾ï¼Œåœ¨ä»£ç å˜åŒ–è¾ƒå¤§çš„æƒ…å†µä¸‹ä½¿ç”¨æ—¶æ•ˆæœå¯èƒ½å°±ä¸æ˜æ˜¾äº†ã€‚ 1.1.4 å‚è€ƒé“¾æ¥ https://yunong.io/2015/11/23/generating-node-js-flame-graphs/ http://www.brendangregg.com/perf.html http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html https://linux.cn/article-4670-1.html http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html http://www.ruanyifeng.com/blog/2017/09/flame-graph.html","categories":[{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"}],"tags":[{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"}]},{"title":"Hexo: Update server automatically","slug":"Hexo-update-server-automatically","date":"2018-05-20T21:45:26.000Z","updated":"2022-05-21T07:36:18.586Z","comments":true,"path":"2018/05/20/Hexo-update-server-automatically/","link":"","permalink":"https://marvinliu1.github.io/2018/05/20/Hexo-update-server-automatically/","excerpt":"","text":"How to update the Hexo server automatically:Sometimes you may want to update your Hexo server after editing a post or creating a new one, here is how to use Browsersync to achieve that. Step 1: Install the Browsersync1&gt;npm install -g browser-sync Step 2: Install Hexo plugin1&gt;npm install hexo-browsersync --save Step 3: Start your Hexo service1hexo s","categories":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/categories/Hexo/"}],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/tags/Hexo/"}]},{"title":"Hello World","slug":"hello-world","date":"2018-01-02T07:26:30.000Z","updated":"2022-05-21T08:41:13.026Z","comments":true,"path":"2018/01/02/hello-world/","link":"","permalink":"https://marvinliu1.github.io/2018/01/02/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[]}],"categories":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/categories/Hexo/"},{"name":"Nuxt","slug":"Nuxt","permalink":"https://marvinliu1.github.io/categories/Nuxt/"},{"name":"Node in Debugging","slug":"Node-in-Debugging","permalink":"https://marvinliu1.github.io/categories/Node-in-Debugging/"},{"name":"Linux","slug":"Hexo/Linux","permalink":"https://marvinliu1.github.io/categories/Hexo/Linux/"}],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://marvinliu1.github.io/tags/Hexo/"},{"name":"NeXt","slug":"NeXt","permalink":"https://marvinliu1.github.io/tags/NeXt/"},{"name":"Vue","slug":"Vue","permalink":"https://marvinliu1.github.io/tags/Vue/"},{"name":"MarkDown","slug":"MarkDown","permalink":"https://marvinliu1.github.io/tags/MarkDown/"},{"name":"Next","slug":"Next","permalink":"https://marvinliu1.github.io/tags/Next/"},{"name":"Node","slug":"Node","permalink":"https://marvinliu1.github.io/tags/Node/"},{"name":"Debugging","slug":"Debugging","permalink":"https://marvinliu1.github.io/tags/Debugging/"},{"name":"Nohup","slug":"Nohup","permalink":"https://marvinliu1.github.io/tags/Nohup/"},{"name":"Linux","slug":"Linux","permalink":"https://marvinliu1.github.io/tags/Linux/"},{"name":"Nuxt","slug":"Nuxt","permalink":"https://marvinliu1.github.io/tags/Nuxt/"},{"name":"Javascript","slug":"Javascript","permalink":"https://marvinliu1.github.io/tags/Javascript/"}]}