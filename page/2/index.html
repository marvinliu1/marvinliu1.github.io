<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#64CEAA"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#64CEAA">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"marvinliu1.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Take in the good!">
<meta property="og:type" content="website">
<meta property="og:title" content="Marvin&#39;s Blog">
<meta property="og:url" content="https://marvinliu1.github.io/page/2/index.html">
<meta property="og:site_name" content="Marvin&#39;s Blog">
<meta property="og:description" content="Take in the good!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Marvin Liu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://marvinliu1.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Marvin's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Marvin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Marvin's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>links</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Marvin Liu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Marvin Liu</p>
  <div class="site-description" itemprop="description">Take in the good!</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/marvinliu1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;marvinliu1" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liuyongquan2010@gmail.com" title="E-Mail → mailto:liuyongquan2010@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="color:white;">document.designMode='on'</div>

        </div>
      </div>
    </div>
    
    <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
    <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
    <div class="widget-wrap">
        <h3 class="widget-title">Tags</h3>
        <div id="myCanvasContainer" class="widget tagcloud">
            <canvas width="250" height="250" id="resCanvas" style="width=100%">
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debugging/" rel="tag">Debugging</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/" rel="tag">Javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MarkDown/" rel="tag">MarkDown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NeXt/" rel="tag">NeXt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Next/" rel="tag">Next</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node/" rel="tag">Node</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nohup/" rel="tag">Nohup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nuxt/" rel="tag">Nuxt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a><span class="tag-list-count">2</span></li></ul>
            </canvas>
        </div>
    </div>
    
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/marvinliu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/10/15/6.3%20ELK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/15/6.3%20ELK/" class="post-title-link" itemprop="url">Node in Debugging - 6.3 ELK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-10-15 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-15T00:00:00-06:00">2019-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/10/15/6.3%20ELK/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.3 ELK" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>ELK 是 ElasticSearch + Logstash + Kibana 这套组合工具的简称，是一个常用的日志系统。</p>
<ul>
<li>ElasticSearch：是一款开源的基于 Lucene 之上实现的一个分布式搜索引擎，也是一个存储引擎（例如：日志），它的特点有：分布式、零配置、自动发现、索引自动分片、索引副本机制、Restful 风格的接口、多数据源和自动搜索负载等。</li>
<li>Logstash：是一款开源的日志收集工具，它可以对日志进行收集、分析、过滤，并将其存储（例如：ElasticSearch）起来供以后使用。</li>
<li>Kibana：是一款开源的可视化工具，可以为 ElasticSearch 提供的日志分析友好的 Web 界面，可以汇总、分析和搜索重要的数据日志。</li>
</ul>
<h2 id="6-3-1-安装-ELK"><a href="#6-3-1-安装-ELK" class="headerlink" title="6.3.1 安装 ELK"></a>6.3.1 安装 ELK</h2><p>我们使用 Docker 安装 ELK，运行如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 5601:5601 \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 5044:5044 \</span><br><span class="line">    -p 15044:15044/udp \</span><br><span class="line">    -it --name elk sebp/elk</span><br></pre></td></tr></table></figure>

<p>进入容器：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it elk /bin/bash</span><br></pre></td></tr></table></figure>

<p>运行以下命令设置 logstash 的 input 和 output：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /opt/logstash/bin/logstash --path.data /tmp/logstash/data \</span></span><br><span class="line">  -e <span class="string">&#x27;input &#123; udp &#123; codec =&gt; &quot;json&quot; port =&gt; 15044 &#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; [&quot;localhost&quot;] &#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里我们启动一个 15044 的 UDP 端口，用来接收通过 UDP 发送到 Logstash 的日志。</p>
<p>用浏览器打开 localhost:5601，如下所示：</p>
<p><img src="/./assets/6.3.1.png"></p>
<p>目前还没有指定 index（ElasticSearch 的 index 类似于 MySQL&#x2F;MongoDB 中的 database），即日志来源。下面我们尝试向 ELK 中写入一些日志。</p>
<h2 id="6-3-2-使用-ELK"><a href="#6-3-2-使用-ELK" class="headerlink" title="6.3.2 使用 ELK"></a>6.3.2 使用 ELK</h2><p>这里仍然以使用 koa-await-breakpoint 为例，来演示如何将日志发送到 ELK。</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>],</span><br><span class="line">  <span class="attr">store</span>: <span class="built_in">require</span>(<span class="string">&#x27;./logger&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>logger.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Logstash</span> = <span class="built_in">require</span>(<span class="string">&#x27;logstash-client&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logstash = <span class="keyword">new</span> <span class="title class_">Logstash</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;udp&#x27;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">15044</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  save (log) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.<span class="property">error</span>) &#123;</span><br><span class="line">      log.<span class="property">errMsg</span> = log.<span class="property">error</span>.<span class="property">message</span></span><br><span class="line">      log.<span class="property">errStack</span> = log.<span class="property">error</span>.<span class="property">stack</span></span><br><span class="line">    &#125;</span><br><span class="line">    logstash.<span class="title function_">send</span>(log)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>routes&#x2F;user.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Post</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Comment</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createPost</span>(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> post = (<span class="keyword">await</span> <span class="title class_">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">uid</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;post&#x27;</span></span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createComment</span>(user, post)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (user, post) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">userId</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">postId</span>: post.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;comment&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure>

<p>此时刷新 Kibana，如下所示：</p>
<p><img src="/./assets/6.3.2.png"></p>
<p>在初次使用 Kibana 时，需要配置 Kibana 从 ElasticSearch 的哪些 index 中搜索日志，我们在 <code>Index pattern</code> 处填 <code>logstash-*</code>，然后单击 Next step 按钮，在 <code>Time Filter field name</code> 中选择 timestamp，单击 Create index pattern 完成配置。</p>
<p><strong>注意</strong>：我们选择 timestamp 而不是默认的 @timestamp，是因为在 koa-await-breakpoint 的日志中有 timestamp 字段。</p>
<p>单击左侧目录的 Discover，我们发现已经有日志了。分别单击左侧出现的 Available Fields 的 fn、type、step、take，然后按 step 升序展示，如下所示：</p>
<p><img src="/./assets/6.3.3.png"></p>
<p>是不是一目了然！我们把每个请求的每一步的函数及其执行时间都记录下来了。</p>
<p>修改 routes&#x2F;users.js 的 createComment，throw 一个 <code>new Error(&#39;test&#39;)</code>。重启程序并发起一个请求，ELK 显示如下：</p>
<p><img src="/./assets/6.3.4.png"></p>
<p><strong>小提示</strong>：在实际应用中会有非常多的日志，我们可以通过 requestId 找到一个请求的所有日志，在 7.2 小节会讲解。</p>
<p>ELK 非常强大，基本能满足所有日志查询需求，Kibana 的查询使用 lucene 语法，用 10 分钟左右就能大体上手。Kibana 还能创建各种仪表盘和聚合图表，读者可自行尝试。</p>
<h2 id="6-3-3-参考链接"><a href="#6-3-3-参考链接" class="headerlink" title="6.3.3 参考链接"></a>6.3.3 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="http://blog.51cto.com/baidu/1676798">http://blog.51cto.com/baidu/1676798</a></li>
<li><a target="_blank" rel="noopener" href="http://elk-docker.readthedocs.io/">http://elk-docker.readthedocs.io</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.2%20async_hooks.md">6.2 async_hooks</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.4%20OpenTracing%20%2B%20Jaeger.md">6.4 OpenTracing + Jaeger</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/09/29/6.2%20async_hooks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/29/6.2%20async_hooks/" class="post-title-link" itemprop="url">Node in Debugging - 6.2 Async Hooks</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-29 00:00:00" itemprop="dateCreated datePublished" datetime="2019-09-29T00:00:00-06:00">2019-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/09/29/6.2%20async_hooks/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.2 Async Hooks" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>上一小节讲解了 koa-await-breakpoint 的用法，但 koa-await-breakpoint 仍然有一个很大的缺憾，即无法记录除 routes&#x2F;controllers 外的函数的执行时间（因为获取不到当前请求的 ctx）。举个通俗的例子：在一个路由的 controller 里面调用了 A ，A 调用了其他文件的 B ，B 又调用了其他文件的 C…这是非常常见的用法，但之前使用 koa-await-breakpoint 只能获取 A 的执行时间，无法获取 B 和 C 的执行时间。</p>
<p><strong>根本原因在于</strong>：无法知道函数之间的调用关系，即 B 不知道是 A 调用的它，即便知道也不知道是哪次请求到来时执行的 A 调用的它。</p>
<p>但是，<a href="mailto:&#110;&#111;&#100;&#x65;&#64;&#56;&#46;&#49;">&#110;&#111;&#100;&#x65;&#64;&#56;&#46;&#49;</a> 引入了一个黑魔法——Async Hooks。</p>
<h2 id="6-2-1-Async-Hooks"><a href="#6-2-1-Async-Hooks" class="headerlink" title="6.2.1 Async Hooks"></a>6.2.1 Async Hooks</h2><p>我们先看看 async_hooks 是什么。Node.js 官网对 async_hooks 的介绍为：</p>
<blockquote>
<p>The <code>async_hooks</code> module provides an API to register callbacks tracking the lifetime of asynchronous resources created inside a Node.js application.</p>
</blockquote>
<p><strong>一句话概括</strong>：async_hooks 用来追踪 Node.js 中异步资源的生命周期。</p>
<p>我们来看段测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">&#x27;async_hooks&#x27;</span>)</span><br><span class="line"></span><br><span class="line">async_hooks.<span class="title function_">createHook</span>(&#123;</span><br><span class="line">  init (asyncId, type, triggerAsyncId, resource) &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`<span class="subst">$&#123;type&#125;</span>(<span class="subst">$&#123;asyncId&#125;</span>): trigger: <span class="subst">$&#123;triggerAsyncId&#125;</span>\n`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy (asyncId) &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`destroy: <span class="subst">$&#123;asyncId&#125;</span>\n`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">enable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">A</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`A -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`A in setTimeout -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">    <span class="title function_">B</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">B</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`B -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`B in process.nextTick -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">    <span class="title function_">C</span>()</span><br><span class="line">    <span class="title function_">C</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">C</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`C -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`C in promise.then -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`top level -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line"><span class="title function_">A</span>()</span><br></pre></td></tr></table></figure>

<p>async_hooks.createHook 可以注册 4 个方法来跟踪所有异步资源的初始化（init）、回调之前（before）、回调之后（after）、销毁后（destroy）事件，并通过调用 .enable() 启用，调用 .disable() 关闭。</p>
<p>这里我们只关心异步资源的初始化和销毁的事件，并使用 <code>fs.writeSync(1, msg)</code> 打印到标准输出，writeSync 的第 1 个参数接收文件描述符，1 表示标准输出。为什么不使用 console.log 呢？因为 console.log 是一个异步操作，如果在 init、before、after 和 destroy 事件处理函数中出现，就会导致无限循环，同理也不能使用任何其他的异步操作。</p>
<p>运行该程序，打印如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">top level -&gt; 1</span><br><span class="line">PROMISE(6): trigger: 1</span><br><span class="line">A -&gt; 1</span><br><span class="line">Timeout(7): trigger: 1</span><br><span class="line">TIMERWRAP(8): trigger: 1</span><br><span class="line">A in setTimeout -&gt; 7</span><br><span class="line">PROMISE(9): trigger: 7</span><br><span class="line">B -&gt; 7</span><br><span class="line">TickObject(10): trigger: 7</span><br><span class="line">B in process.nextTick -&gt; 10</span><br><span class="line">C -&gt; 10</span><br><span class="line">PROMISE(11): trigger: 10</span><br><span class="line">PROMISE(12): trigger: 11</span><br><span class="line">C -&gt; 10</span><br><span class="line">PROMISE(13): trigger: 10</span><br><span class="line">PROMISE(14): trigger: 13</span><br><span class="line">C in promise.then -&gt; 12</span><br><span class="line">C in promise.then -&gt; 14</span><br><span class="line">destroy: 7</span><br><span class="line">destroy: 10</span><br><span class="line">destroy: 8</span><br></pre></td></tr></table></figure>

<p>这段程序的打印结果包含了很多信息，下面逐一进行解释：</p>
<ol>
<li>为了实现对异步资源的跟踪，Node.js 对每一个函数（不论异步还是同步）提供了一个 async scope，我们可以通过调用 <code>async_hooks.executionAsyncId()</code> 来获取函数当前的 async scope 的 id（称为 asyncId），通过调用 <code>async_hooks.triggerAsyncId()</code> 来获取当前函数调用者的 asyncId。</li>
<li>异步资源在创建时触发 init 事件函数，init 函数中的第 1 个参数代表该异步资源的 asyncId，type 表示异步资源的类型（例如 TCPWRAP、PROMISE、Timeout、Immediate、TickObject 等等），triggerAsyncId 表示该异步资源的调用者的 asyncId。异步资源在销毁时触发 destroy 事件函数，该函数只接收一个参数，即该异步资源的 asyncId。</li>
<li>函数调用关系明确。我们通过上面的打印结果可以很容易地看出（从下往上看） ：C（asyncId: 10）被 B（asyncId: 7）调用，B（asyncId: 7）被 A（asyncId: 1）调用。而且 C 的 promise.then 里面的 asyncId（值为 12&#x2F;14）也可以通过 12&#x2F;14 -&gt; 11&#x2F;13 -&gt; 10 定位到 C 的 asyncId（值为 10）。</li>
<li>同步函数每次调用的 asyncId 都一样，如上所示，C 调用了两次，都打印了 C -&gt; 10，与调用方的作用域的 asyncId 一致，即如上所示打印的 B in process.nextTick -&gt; 10。异步函数每次调用的 asyncId 都不一样，即如上所示打印的 C in promise.then -&gt; 12 和 C in promise.then -&gt; 14。</li>
<li>最外层作用域的 asyncId 总是 1，每个异步资源在创建时 asyncId 全局递增。</li>
</ol>
<p>上面 5 条结论非常重要。接下来我们看看如何使用 async_hooks 改造 koa-await-breakpoint。</p>
<h2 id="6-2-2-改造-koa-await-breakpoint"><a href="#6-2-2-改造-koa-await-breakpoint" class="headerlink" title="6.2.2 改造 koa-await-breakpoint"></a>6.2.2 改造 koa-await-breakpoint</h2><p>我们通过前面的结论已经知道，使用 async_hooks 时可以通过 asyncId 串起函数的调用关系，但是如何将这些函数的调用链与 koa 接收的每个请求关联起来呢?</p>
<p>首先，定义一个全局 Map，存储函数的调用关系：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">&#x27;async_hooks&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> asyncIdMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">async_hooks.<span class="title function_">createHook</span>(&#123;</span><br><span class="line">  init (asyncId, type, triggerAsyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="title function_">getCtx</span>(triggerAsyncId)</span><br><span class="line">    <span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">      asyncIdMap.<span class="title function_">set</span>(asyncId, ctx)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      asyncIdMap.<span class="title function_">set</span>(asyncId, triggerAsyncId)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy (asyncId) &#123;</span><br><span class="line">    asyncIdMap.<span class="title function_">delete</span>(asyncId)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">enable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCtx</span> (asyncId) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!asyncId) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> asyncId === <span class="string">&#x27;object&#x27;</span> &amp;&amp; asyncId.<span class="property">app</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> asyncId</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getCtx</span>(asyncIdMap.<span class="title function_">get</span>(asyncId))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有以下三点需要解释：</p>
<ol>
<li>定义了一个全局 Map 来存储函数的调用关系，在适当的地方（下面会讲到）将当前请求的 ctx 存储到 Map 中，key 是 asyncId。</li>
<li>每个异步资源在初始化时，会尝试通过 asyncId 向上寻找祖先的 value 是否是 ctx（koa 应用中每个请求的 ctx），如果有，则直接将 value 设置为 ctx，否则将 value 设置为调用者的 asyncId（即 triggerAsyncId）。</li>
<li>在 destroy 事件函数里直接删除调用关系，保证了不会引起内存泄漏，即杜绝引用了 ctx 但没有释放的情况。</li>
</ol>
<p>然后，修改 global[loggerName] 如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>[loggerName] = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, fn, fnStr, filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> originalContext = ctx</span><br><span class="line">  <span class="keyword">let</span> requestId = <span class="title function_">_getRequestId</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> asyncId = async_hooks.<span class="title function_">executionAsyncId</span>()</span><br><span class="line">  <span class="keyword">if</span> (!requestId) &#123;</span><br><span class="line">    <span class="keyword">const</span> _ctx = <span class="title function_">getCtx</span>(asyncId)</span><br><span class="line">    <span class="keyword">if</span> (_ctx) &#123;</span><br><span class="line">      ctx = _ctx</span><br><span class="line">      requestId = <span class="title function_">_getRequestId</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    asyncIdMap.<span class="title function_">set</span>(asyncId, ctx)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestId) &#123;</span><br><span class="line">    <span class="title function_">_logger</span>(<span class="string">&#x27;beforeAwait&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> fn.<span class="title function_">call</span>(originalContext)</span><br><span class="line">  <span class="keyword">if</span> (requestId) &#123;</span><br><span class="line">    <span class="title function_">_logger</span>(<span class="string">&#x27;afterAwait&#x27;</span>, result)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_getRequestId</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx &amp;&amp; ctx.<span class="property">app</span> &amp;&amp; _.<span class="title function_">get</span>(ctx, requestIdPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_logger</span> (type, result) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有以下两点需要解释：</p>
<ol>
<li>logger 函数传入的第 1 个参数 ctx，之前是每个请求的 ctx，现在可能是当前执行上下文的 this，所以先将 ctx 赋值给 originalContext，然后通过 <code>await fn.call(originalContext)</code> 让函数在执行时有正确的上下文。</li>
<li>如果传入的 ctx 是来自请求的 ctx 且能拿到 requestId，那么将当前 asyncId 和 ctx 写入 Map，如果不是来自请求的 ctx，则尝试从 Map 里向上寻找祖先的 value 是否是 ctx，如果找到，则覆盖当前的 ctx 并拿到 requestId。</li>
</ol>
<p>至此，koa-await-breakpoint 全部改造完毕。接下来我们通过一个例子验证下升级后的 koa-await-breakpoint：</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>routes&#x2F;users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Post</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Comment</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createPost</span>(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> post = (<span class="keyword">await</span> <span class="title class_">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">uid</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;post&#x27;</span></span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createComment</span>(user, post)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (user, post) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">userId</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">postId</span>: post.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;comment&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的意思是：在访问创建用户接口时，调用 createUser，createUser 里面又调用了 createPost，createPost 里面又调用了 createComment。运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure>

<p>打印如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;start&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createUser(name, age)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;User.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;User.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">36</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createPost(user)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">6</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Post.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">7</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Post.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">3</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createComment(user, post)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">9</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Comment.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Comment.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">11</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createComment(user, post)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createPost(user)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">6</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createUser(name, age)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">44</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;end&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br></pre></td></tr></table></figure>

<p>至此，一个全链路、无侵入、强大的日志打点工具就完成了。</p>
<p><strong>注意</strong>：使用 async_hooks 在目前有较严重的性能损耗，见 <a target="_blank" rel="noopener" href="https://github.com/bmeurer/async-hooks-performance-impact">https://github.com/bmeurer/async-hooks-performance-impact</a>，请慎重在生产环境中使用。</p>
<h2 id="6-2-3-参考链接"><a href="#6-2-3-参考链接" class="headerlink" title="6.2.3 参考链接"></a>6.2.3 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html">https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27394440">https://zhuanlan.zhihu.com/p/27394440</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a568dac41ed">https://www.jianshu.com/p/4a568dac41ed</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.1%20koa-await-breakpoint.md">6.1 koa-await-breakpoint</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.3%20ELK.md">6.3 ELK</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/09/20/6.1%20koa-await-breakpoint/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/20/6.1%20koa-await-breakpoint/" class="post-title-link" itemprop="url">Node in Debugging - 6.1 Koa-await-breakpoint</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-09-20T00:00:00-06:00">2019-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/09/20/6.1%20koa-await-breakpoint/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 6.1 Koa-await-breakpoint" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>日志打点一直是个调试最头疼的问题。如果直接在代码中插入埋点代码，不仅侵入性强而且工作量大也不够灵活，要是能做到智能打点就好了，koa-await-breakpoint 正是我们需要的。</p>
<h2 id="6-1-1-什么是-koa-await-breakpoint？"><a href="#6-1-1-什么是-koa-await-breakpoint？" class="headerlink" title="6.1.1 什么是 koa-await-breakpoint？"></a>6.1.1 什么是 <a target="_blank" rel="noopener" href="https://github.com/nswbmw/koa-await-breakpoint">koa-await-breakpoint</a>？</h2><p>koa-await-breakpoint 是一个 Koa 的中间件，是一个在 routes&#x2F;controllers 里（作用域包含 ctx）的 await 表达式前后自动打点的工具，不用插入一行日志打点代码，只需要在引入时配置一下，就可以记录每个请求到来时 await 表达式前后的现场，例如：</p>
<ol>
<li>await 表达式所在的文件及行列号（filename）。</li>
<li>await 表达式是执行的第几步（step）。</li>
<li>await 表达式字符串形式（fn）。</li>
<li>执行 await 表达式所花费的毫秒（take）。</li>
<li>执行 await 表达式的结果（result）。</li>
<li>当前请求的 ctx。</li>
</ol>
<p>使用方法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// On top of the main file</span></span><br><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generally, above other middlewares</span></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="6-1-2-实现原理"><a href="#6-1-2-实现原理" class="headerlink" title="6.1.2 实现原理"></a>6.1.2 实现原理</h2><ol>
<li><p>重载 Module.prototype._compile，相当于 hack 了 require，如果发现是 require 了配置里指定的文件，则进行下一步，否则返回原始代码的内容，相关源代码如下：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shimmer.<span class="title function_">wrap</span>(<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;_compile&#x27;</span>, <span class="keyword">function</span> (<span class="params">__compile</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">koaBreakpointCompile</span>(<span class="params">content, filename</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_.<span class="title function_">includes</span>(filenames, filename)) &#123;</span><br><span class="line">      <span class="keyword">return</span> __compile.<span class="title function_">call</span>(<span class="variable language_">this</span>, content, filename);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>用 esprima 解析代码，生成 AST。例如：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getUsers</span> = <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUsers</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">find</span>()</span><br><span class="line">  <span class="keyword">return</span> users</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  会生成如下 AST，只截取了 <code>await User.create(...)</code> 相关的 AST：</p>
</li>
</ol>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Script</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title class_">AwaitExpression</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;AwaitExpression&#x27;</span>,</span><br><span class="line">    <span class="attr">argument</span>:</span><br><span class="line">     <span class="title class_">CallExpression</span> &#123;</span><br><span class="line">       <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">       <span class="attr">callee</span>:</span><br><span class="line">        <span class="title class_">StaticMemberExpression</span> &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;MemberExpression&#x27;</span>,</span><br><span class="line">          <span class="attr">computed</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">object</span>:</span><br><span class="line">           <span class="title class_">Identifier</span> &#123;</span><br><span class="line">             <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">             <span class="attr">name</span>: <span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">             <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">10</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">14</span> &#125; &#125; &#125;,</span><br><span class="line">          <span class="attr">property</span>:</span><br><span class="line">           <span class="title class_">Identifier</span> &#123;</span><br><span class="line">             <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">             <span class="attr">name</span>: <span class="string">&#x27;create&#x27;</span>,</span><br><span class="line">             <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">15</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">21</span> &#125; &#125; &#125;,</span><br><span class="line">          <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">10</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">21</span> &#125; &#125; &#125;,</span><br><span class="line">       <span class="attr">arguments</span>:</span><br><span class="line">        [ <span class="title class_">ObjectExpression</span> &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;ObjectExpression&#x27;</span>,</span><br><span class="line">            <span class="attr">properties</span>:</span><br><span class="line">             [ <span class="title class_">Property</span> &#123;</span><br><span class="line">                 <span class="attr">type</span>: <span class="string">&#x27;Property&#x27;</span>,</span><br><span class="line">                 <span class="attr">key</span>:</span><br><span class="line">                  <span class="title class_">Identifier</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">                    <span class="attr">name</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">10</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">computed</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">value</span>:</span><br><span class="line">                  <span class="title class_">Literal</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Literal&#x27;</span>,</span><br><span class="line">                    <span class="attr">value</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">                    <span class="attr">raw</span>: <span class="string">&#x27;\&#x27;xx\&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">12</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">16</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">kind</span>: <span class="string">&#x27;init&#x27;</span>,</span><br><span class="line">                 <span class="attr">method</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">shorthand</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">16</span> &#125; &#125; &#125;,</span><br><span class="line">               <span class="title class_">Property</span> &#123;</span><br><span class="line">                 <span class="attr">type</span>: <span class="string">&#x27;Property&#x27;</span>,</span><br><span class="line">                 <span class="attr">key</span>:</span><br><span class="line">                  <span class="title class_">Identifier</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">                    <span class="attr">name</span>: <span class="string">&#x27;age&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">9</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">computed</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">value</span>:</span><br><span class="line">                  <span class="title class_">Literal</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Literal&#x27;</span>,</span><br><span class="line">                    <span class="attr">value</span>: <span class="number">18</span>,</span><br><span class="line">                    <span class="attr">raw</span>: <span class="string">&#x27;18&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">11</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">13</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">kind</span>: <span class="string">&#x27;init&#x27;</span>,</span><br><span class="line">                 <span class="attr">method</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">shorthand</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">13</span> &#125; &#125; &#125; ],</span><br><span class="line">            <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">22</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">9</span>, <span class="attr">column</span>: <span class="number">5</span> &#125; &#125; &#125; ],</span><br><span class="line">       <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">10</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">9</span>, <span class="attr">column</span>: <span class="number">6</span> &#125; &#125; &#125;,</span><br><span class="line">    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">4</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">9</span>, <span class="attr">column</span>: <span class="number">6</span> &#125; &#125; &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>遍历找到 awaitExpression 节点，进行以下包装后生成 AST，替换掉原来的节点。  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="title function_">logger</span>(</span><br><span class="line">  (<span class="keyword">typeof</span> ctx !== <span class="string">&#x27;undefined&#x27;</span> ? ctx : <span class="variable language_">this</span>),</span><br><span class="line">  <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> awaitExpression</span><br><span class="line">  &#125;,</span><br><span class="line">  awaitExpressionString,</span><br><span class="line">  filename</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
  相关源代码如下：  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">findAwaitAndWrapLogger</span>(parsedCodes)</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  content = escodegen.<span class="title function_">generate</span>(parsedCodes, &#123;</span><br><span class="line">    <span class="attr">format</span>: &#123; <span class="attr">indent</span>: &#123; <span class="attr">style</span>: <span class="string">&#x27;  &#x27;</span> &#125; &#125;,</span><br><span class="line">    <span class="attr">sourceMap</span>: filename,</span><br><span class="line">    <span class="attr">sourceMapWithCode</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;cannot generate code for file: %s&#x27;</span>, filename)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(e.<span class="property">stack</span>)</span><br><span class="line">  process.<span class="title function_">exit</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">debug</span>(<span class="string">&#x27;file %s regenerate codes:\n%s&#x27;</span>, filename, content.<span class="property">code</span>)</span><br></pre></td></tr></table></figure>
  findAwaitAndWrapLogger 的作用就是遍历 AST，将 awaitExpression 替换成用日志函数包裹后新的 awaitExpression 的 AST。最后用 escodegen 将 AST 生成代码（支持 soucemap，所以错误栈对应的行数是正确的）。</li>
</ol>
<p><strong>核心</strong>：每个请求到来时，生成一个 requestId（可自定义，默认为 uuid）挂载到 ctx 上，这样就可以通过 requestId 将日志串起来了。</p>
<p><strong>特点</strong>：可以记录每个请求的每一步（await 表达式）的现场及返回值，方便查日志。</p>
<h2 id="6-1-3-使用-koa-await-breakpoint"><a href="#6-1-3-使用-koa-await-breakpoint" class="headerlink" title="6.1.3 使用 koa-await-breakpoint"></a>6.1.3 使用 koa-await-breakpoint</h2><p>测试代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: userRouter.<span class="property">getUsers</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>routes&#x2F;user.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getUsers</span> = <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUsers</span> (ctx) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">find</span>()</span><br><span class="line">  ctx.<span class="property">body</span> = users</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG=koa-await-breakpoint node app.js</span><br></pre></td></tr></table></figure>

<p>终端打印出转换后的代码，可以看出 routes&#x2F;users.js 被转换成了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;users&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getUsers</span> = <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUsers</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">global</span>.<span class="title function_">logger</span>(<span class="keyword">typeof</span> ctx !== <span class="string">&#x27;undefined&#x27;</span> ? ctx : <span class="variable language_">this</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="string">&#x27;User.create(&#123;\n    name: \&#x27;xx\&#x27;,\n    age: 18\n&#125;)&#x27;</span>, <span class="string">&#x27;/Users/nswbmw/Desktop/test/routes/user.js:6:2&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="variable language_">global</span>.<span class="title function_">logger</span>(<span class="keyword">typeof</span> ctx !== <span class="string">&#x27;undefined&#x27;</span> ? ctx : <span class="variable language_">this</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>.<span class="title function_">find</span>();</span><br><span class="line">  &#125;, <span class="string">&#x27;User.find()&#x27;</span>, <span class="string">&#x27;/Users/nswbmw/Desktop/test/routes/user.js:11:16&#x27;</span>);</span><br><span class="line">  ctx.<span class="property">body</span> = users;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>访问 localhost:3000&#x2F;users，终端打印出:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.100Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;start&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">1</span>,<span class="string">&quot;take&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">2</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:6:2&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.104Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;beforeAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.create(&#123;\n    name: &#x27;xx&#x27;,\n    age: 18\n&#125;)&quot;</span>,<span class="string">&quot;take&quot;</span>:<span class="number">4</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">3</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:6:2&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.175Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;afterAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.create(&#123;\n    name: &#x27;xx&#x27;,\n    age: 18\n&#125;)&quot;</span>,<span class="string">&quot;result&quot;</span>:&#123;<span class="string">&quot;result&quot;</span>:&#123;<span class="string">&quot;ok&quot;</span>:<span class="number">1</span>,<span class="string">&quot;n&quot;</span>:<span class="number">1</span>&#125;,<span class="string">&quot;ops&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>,<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;5a93a9c3cf8c8797c9b47482&quot;</span>&#125;],<span class="string">&quot;insertedCount&quot;</span>:<span class="number">1</span>,<span class="string">&quot;insertedIds&quot;</span>:[<span class="string">&quot;5a93a9c3cf8c8797c9b47482&quot;</span>]&#125;,<span class="string">&quot;take&quot;</span>:<span class="number">71</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">4</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:11:16&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.175Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;beforeAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.find()&quot;</span>,<span class="string">&quot;take&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">5</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:11:16&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.180Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;afterAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.find()&quot;</span>,<span class="string">&quot;result&quot;</span>:[&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;5a93a9c3cf8c8797c9b47482&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>&#125;],<span class="string">&quot;take&quot;</span>:<span class="number">5</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.181Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;end&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">6</span>,<span class="string">&quot;take&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：type 是以下其中一种，take 的单位是 ms。</p>
<ol>
<li>start：请求到来时第 1 次打点。</li>
<li>beforeAwait：上一个 awaitExpression 之后到这一个 awaitExpression 之前。</li>
<li>afterAwait：这个 awaitExpression 开始到结束。</li>
<li>error：错误日志，包含了错误信息。</li>
<li>end：请求结束时打点。</li>
</ol>
<h2 id="6-1-4-自定义日志存储"><a href="#6-1-4-自定义日志存储" class="headerlink" title="6.1.4 自定义日志存储"></a>6.1.4 自定义日志存储</h2><p>store 参数最好自己定义（默认打印日志到 stdout），该参数是一个对象并且有一个 save 方法即可。在 save 方法内可做一些逻辑修改或者日志策略，比如：</p>
<ol>
<li>添加日志标识（例如：name）方便区分不同服务的日志。</li>
<li>针对错误日志，添加一些额外字段方便追踪现场。</li>
<li>将日志发送到 Logstash 或其他日志服务。</li>
<li>限制日志频率，比如：只有响应时间大于 500ms 的请求日志才会被记录。</li>
</ol>
<p><strong>koa_await_breakpoint_store.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">save</span> = <span class="keyword">function</span> <span class="title function_">save</span>(<span class="params">record, ctx</span>) &#123;</span><br><span class="line">  record.<span class="property">name</span> = <span class="string">&#x27;app name&#x27;</span></span><br><span class="line">  record.<span class="property">env</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (record.<span class="property">error</span>) &#123;</span><br><span class="line">    record.<span class="property">error</span> = &#123;</span><br><span class="line">      <span class="attr">message</span>: record.<span class="property">error</span>.<span class="property">message</span>,</span><br><span class="line">      <span class="attr">stack</span>: record.<span class="property">error</span>.<span class="property">stack</span>,</span><br><span class="line">      <span class="attr">status</span>: record.<span class="property">error</span>.<span class="property">status</span> || record.<span class="property">error</span>.<span class="property">statusCode</span> || <span class="number">500</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  logstash.<span class="title function_">send</span>(record)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-1-5-参考链接"><a href="#6-1-5-参考链接" class="headerlink" title="6.1.5 参考链接"></a>6.1.5 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/jquery/esprima">https://github.com/jquery/esprima</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/estools/escodegen">https://github.com/estools/escodegen</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/5.2%20Elastic%20APM.md">5.2 Elastic APM</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.2%20async_hooks.md">6.2 async_hooks</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/08/26/5.2%20Elastic%20APM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/26/5.2%20Elastic%20APM/" class="post-title-link" itemprop="url">Node in Debugging - 5.2 Elastic APM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-26T00:00:00-06:00">2019-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/08/26/5.2%20Elastic%20APM/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging - 5.2 Elastic APM" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<h2 id="5-2-1-什么是-Elastic-APM？"><a href="#5-2-1-什么是-Elastic-APM？" class="headerlink" title="5.2.1 什么是 Elastic APM？"></a>5.2.1 什么是 Elastic APM？</h2><p>Elastic APM 是 Elastic 公司开源的一款 APM 工具，目前还处于 Beta 阶段，它有以下几个优势：</p>
<ol>
<li>开源。我们可以免费使用，像使用 ELK 一样。</li>
<li>功能完善。API 比较完善，有 Agent、Transaction 和 Trace，默认创建响应时间和每分钟请求数两种图表，且可以使用 Kibana 的 Filter 过滤生成关心的数据的图表。</li>
<li>监控与日志统一。Elastic APM 依赖 ElasticSearch + Kibana，所以可以结合 ELK 使用，可在 Kibana 中查看监控，然后直接查询日志。</li>
</ol>
<p>Elastic APM 架构如下：</p>
<p><img src="/./assets/5.2.1.png"></p>
<p>APM Agent（即在应用端引入的探针）将收集的日志发送到 APM Server（Go 写的 HTTP 服务），APM Server 将数据存储到 ElasticSearch 中，然后通过 Kibana 展示。</p>
<p>Kibana 展示如下：</p>
<p><img src="/./assets/5.2.2.png"></p>
<h2 id="5-2-2-启动-ELK"><a href="#5-2-2-启动-ELK" class="headerlink" title="5.2.2 启动 ELK"></a>5.2.2 启动 ELK</h2><p>我们使用 Docker 安装并启动 ELK，运行如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 5601:5601 \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 5044:5044 \</span><br><span class="line">    -it --name elk sebp/elk</span><br></pre></td></tr></table></figure>

<h2 id="5-2-3-启动-APM-Server"><a href="#5-2-3-启动-APM-Server" class="headerlink" title="5.2.3 启动 APM Server"></a>5.2.3 启动 APM Server</h2><p>首先，下载 <a target="_blank" rel="noopener" href="https://www.elastic.co/downloads/apm/apm-server">APM Server</a> 解压。然后运行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./apm-server setup <span class="comment"># 导入 APM 仪表盘到 Kibana</span></span><br><span class="line">$ ./apm-server -e <span class="comment"># 启动 APM Server，默认监听 8200 端口</span></span><br></pre></td></tr></table></figure>

<p>用浏览器打开 localhost:5601，进入 Dashboard 页，如下所示：</p>
<p><img src="/./assets/5.2.3.png"></p>
<h2 id="5-2-4-使用-Elastic-APM"><a href="#5-2-4-使用-Elastic-APM" class="headerlink" title="5.2.4 使用 Elastic APM"></a>5.2.4 使用 Elastic APM</h2><p>测试代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apm = <span class="built_in">require</span>(<span class="string">&#x27;elastic-apm-node&#x27;</span>).<span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">appName</span>: <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  apm.<span class="title function_">setTransactionName</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx._matchedRoute&#125;</span>`</span>)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/:name&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  apm.<span class="title function_">setTransactionName</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx._matchedRoute&#125;</span>`</span>)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>运行该程序，发起两个请求：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:3000/</span><br><span class="line">$ curl localhost:3000/nswbmw</span><br></pre></td></tr></table></figure>

<p>等待一会，Kibana 展示如下：</p>
<p><img src="/./assets/5.2.4.png"></p>
<p>在 Elastic APM 中，有两个术语：</p>
<ul>
<li>transaction：一组 traces 的集合，例如：一个 HTTP 请求。</li>
<li>trace：一个事件及持续时间，例如：一个 SQL 查询。</li>
</ul>
<h2 id="5-2-5-错误日志"><a href="#5-2-5-错误日志" class="headerlink" title="5.2.5 错误日志"></a>5.2.5 错误日志</h2><p>现在，我们来测试下 Elastic APM 的错误收集功能。修改测试代码为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apm = <span class="built_in">require</span>(<span class="string">&#x27;elastic-apm-node&#x27;</span>).<span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">appName</span>: <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    apm.<span class="title function_">captureError</span>(e)</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">500</span></span><br><span class="line">    ctx.<span class="property">message</span> = e.<span class="property">message</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">controller</span>: <span class="keyword">function</span> <span class="title function_">indexRouter</span> (ctx) &#123;</span><br><span class="line">  apm.<span class="title function_">setTransactionName</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx._matchedRoute&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error!!!&#x27;</span>)</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>重启测试程序，并发起一次请求。回到 Kibana，单击 Dashboard -&gt; [APM] Errors 可以看到错误日志记录（自动聚合）和图表，如下所示：</p>
<p><img src="/./assets/5.2.5.png"></p>
<p>单击 View Error Details 进入错误详情页，如下所示：</p>
<p><img src="/./assets/5.2.6.png"></p>
<p><strong>可以看出</strong>：在错误日志中展示了错误代码及行数、上下几行代码、父级函数名和所在文件等信息。</p>
<h2 id="5-2-6-参考链接"><a href="#5-2-6-参考链接" class="headerlink" title="5.2.6 参考链接"></a>5.2.6 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/index.html">https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/custom-stack.html">https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/custom-stack.html</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/5.1%20NewRelic.md">5.1 NewRelic</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/6.1%20koa-await-breakpoint.md">6.1 koa-await-breakpoint</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/08/05/5.1%20NewRelic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/05/5.1%20NewRelic/" class="post-title-link" itemprop="url">Node in Debugging, 5.1 NewRelic</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-05T00:00:00-06:00">2019-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/08/05/5.1%20NewRelic/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 5.1 NewRelic" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p><a target="_blank" rel="noopener" href="https://newrelic.com/">NewRelic</a> 是一个老牌的应用性能监测工具，提供 14 天免费试用，本节将讲解如何使用 NewRelic 监控 Node.js 程序的性能。</p>
<p>测试代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;newrelic&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">const</span> createUser = <span class="built_in">require</span>(<span class="string">&#x27;./routes/users&#x27;</span>).<span class="property">createUser</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> salt = crypto.<span class="title function_">randomBytes</span>(<span class="number">128</span>).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> hash = crypto.<span class="title function_">pbkdf2Sync</span>(<span class="title class_">String</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()), salt, <span class="number">10000</span>, <span class="number">512</span>, <span class="string">&#x27;sha512&#x27;</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; salt, hash &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/error&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error!!!&#x27;</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/users/:user&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">createUser</span>(req.<span class="property">params</span>.<span class="property">user</span>, <span class="number">18</span>)</span><br><span class="line">  res.<span class="title function_">json</span>(user)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>routes&#x2F;users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">return</span> user</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-1-1-使用-NewRelic"><a href="#5-1-1-使用-NewRelic" class="headerlink" title="5.1.1 使用 NewRelic"></a>5.1.1 使用 NewRelic</h2><p>首先，注册一个 <a target="_blank" rel="noopener" href="https://newrelic.com/signup">NewRelic</a> 账号。创建一个应用，如下所示：</p>
<p><img src="/./assets/5.1.1.png"></p>
<p>选择 APM，进入下一步，选择 Node.js 应用，并拿到 license key：</p>
<p><img src="/./assets/5.1.2.png"></p>
<p>在 Node.js 中使用 NewRelic 的步骤如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i newrelic --save <span class="comment"># 安装 NewRelic 的 Node.js SDK</span></span><br><span class="line">$ <span class="built_in">cp</span> node_modules/newrelic/newrelic.js . <span class="comment"># 将默认配置文件拷贝到项目根目录下</span></span><br></pre></td></tr></table></figure>

<p>修改 newrelic.js，app_name 填写我们的应用名（例如：api），license_key 填写刚才生成的 license key。</p>
<p>启动测试程序，并发起几个请求，稍等几分钟，NewRelic 的后台将会收到并展示一些数据（例如：吞吐量，请求的 Urls，错误率、Apdex score 等），如下所示：</p>
<p><img src="/./assets/5.1.3.png"></p>
<p>试用版的功能有限，升级到付费版可解锁更多功能，例如：数据库分析、错误分析甚至 Node.js VM 监控（CPU、内存、GC、Event Loop）等等。</p>
<p>类似的其他 APM 有：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.appdynamics.com/">AppDynamics</a></li>
<li><a href="oneapm.com">OneAPM</a></li>
<li><a target="_blank" rel="noopener" href="https://www.datadoghq.com/monitor-nodejs/">DataDog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatus.com/">atatus</a></li>
<li><a target="_blank" rel="noopener" href="https://opbeat.com/nodejs">opbeat</a></li>
</ul>
<p>用法大同小异，这里就不一一介绍了。</p>
<h2 id="5-1-2-参考链接"><a href="#5-1-2-参考链接" class="headerlink" title="5.1.2 参考链接"></a>5.1.2 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://newrelic.com/">https://newrelic.com/</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/4.5%20supervisor-hot-reload.md">4.5 supervisor-hot-reload</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/5.2%20Elastic%20APM.md">5.2 Elastic APM</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/08/03/4.5%20supervisor-hot-reload/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/03/4.5%20supervisor-hot-reload/" class="post-title-link" itemprop="url">Node in Debugging, 4.5 Supervisor-hot-reload</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-03 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-03T00:00:00-06:00">2019-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/08/03/4.5%20supervisor-hot-reload/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 4.5 Supervisor-hot-reload" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>我们在本地开发 Node.js 程序时通常会使用 <a target="_blank" rel="noopener" href="https://github.com/remy/nodemon">nodemon</a> 或者 <a target="_blank" rel="noopener" href="https://github.com/petruisfan/node-supervisor">supervisor</a> 这种进程管理工具，当有文件修改时自动重启应用。小项目还好，项目大了（尤其是前端应用）每次重启应用都用几秒到几十秒的时间，大部分时间都花在了加载及编译代码上。</p>
<p>这让笔者联想到前端比较火的一个名词——Hot Reload（热加载），比如 React 静态资源的热加载通过 webpack-dev-server 和 react-hot-loader 实现，webpack-dev-server 负责重新编译代码，react-hot-loader 负责热加载。</p>
<p>那在 Node.js 应用中，如何实现 Hot Reload 呢？最好能实现不重启应用便使新代码生效。幸好 ES6 引入了一个新特性——Proxy。</p>
<h2 id="4-5-1-Proxy"><a href="#4-5-1-Proxy" class="headerlink" title="4.5.1 Proxy"></a>4.5.1 Proxy</h2><p>Proxy 用于修改对象的默认行为，等同于在语言层面做出修改，属于一种 “元编程”。Proxy 在要访问的对象之前架设一层拦截，在访问该对象成员时必须先经过这层拦截。示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`getting <span class="subst">$&#123;key&#125;</span>!`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;haha&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>)</span><br><span class="line"><span class="comment">// getting name!</span></span><br><span class="line"><span class="comment">// haha</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">age</span>)</span><br><span class="line"><span class="comment">// getting age!</span></span><br><span class="line"><span class="comment">// haha</span></span><br></pre></td></tr></table></figure>

<p><strong>可以看出</strong>：我们并没有在 obj 上定义 name 和 age 属性，所有获取 obj 上属性都会执行 get 方法然后打印 getting xxx! 和返回 haha。</p>
<p>这里 Proxy 的第 1 个参数是一个空对象，也可以是一个其他的对象，比如函数（毕竟在 JavaScript 中函数也是对象）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">user</span> () &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(user, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`getting <span class="subst">$&#123;key&#125;</span>!`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;haha&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">name</span>)</span><br><span class="line"><span class="comment">// user</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">age</span>)</span><br><span class="line"><span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>)</span><br><span class="line"><span class="comment">// getting name!</span></span><br><span class="line"><span class="comment">// haha</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">age</span>)</span><br><span class="line"><span class="comment">// getting age!</span></span><br><span class="line"><span class="comment">// haha</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="number">1</span>, &#123;&#125;)</span><br><span class="line"><span class="comment">// TypeError: Cannot create proxy with a non-object as target or handler</span></span><br></pre></td></tr></table></figure>

<h2 id="4-5-2-Proxy-实现-Hot-Reload"><a href="#4-5-2-Proxy-实现-Hot-Reload" class="headerlink" title="4.5.2 Proxy 实现 Hot Reload"></a>4.5.2 Proxy 实现 Hot Reload</h2><p><strong>核心原理</strong>：使用 Proxy 将模块导出的对象包装一层 “代理”，即 module.exports 导出的是一个 Proxy 实例，定义一个 get 方法，使得获取实例上的属性其实是去获取最新的 require.cache 中的对象上的属性。同时，监听代码文件，如果有修改，则更新 require.cache。</p>
<p><strong>简而言之</strong>：我们在获取对象的属性时，中间加了一层代理，通过代理间接获取原有属性的值，如果属性值有更新，则会更新 require.cache 的缓存，那么下次再获取对象的属性时，通过代理将获取该属性最新的值。可见，Proxy 可以实现属性访问拦截，也可实现断开强引用的作用。</p>
<p>笔者发布了一个 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/proxy-hot-reload">proxy-hot-reload</a> 模块，核心代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">proxyHotReload</span>(<span class="params">opts</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> includes = [ ... ]</span><br><span class="line">  <span class="keyword">const</span> excludes = [ ... ]</span><br><span class="line">  <span class="keyword">const</span> filenames = _.<span class="title function_">difference</span>(includes, excludes)</span><br><span class="line"></span><br><span class="line">  chokidar</span><br><span class="line">    .<span class="title function_">watch</span>(filenames, &#123;</span><br><span class="line">      <span class="attr">usePolling</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">require</span>.<span class="property">cache</span>[path]) &#123;</span><br><span class="line">          <span class="keyword">const</span> _exports = <span class="built_in">require</span>.<span class="property">cache</span>[path].<span class="property">exports</span></span><br><span class="line">          <span class="keyword">if</span> (_.<span class="title function_">isPlainObject</span>(_exports) &amp;&amp; !_.<span class="title function_">isEmpty</span>(_exports)) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="built_in">require</span>.<span class="property">cache</span>[path]</span><br><span class="line">            <span class="built_in">require</span>(path)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">error</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error))</span><br><span class="line"></span><br><span class="line">  shimmer.<span class="title function_">wrap</span>(<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;_compile&#x27;</span>, <span class="keyword">function</span> (<span class="params">__compile</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">proxyHotReloadCompile</span>(<span class="params">content, filename</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!_.<span class="title function_">includes</span>(filenames, filename)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> __compile.<span class="title function_">call</span>(<span class="variable language_">this</span>, content, filename)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = __compile.<span class="title function_">call</span>(<span class="variable language_">this</span>, content, filename)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_exports</span> = <span class="variable language_">this</span>.<span class="property">exports</span></span><br><span class="line">        <span class="comment">// non-object return original compiled code</span></span><br><span class="line">        <span class="keyword">if</span> (!_.<span class="title function_">isPlainObject</span>(<span class="variable language_">this</span>.<span class="property">_exports</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">exports</span> =  <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>.<span class="property">_exports</span>, &#123;</span><br><span class="line">            <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">require</span>.<span class="property">cache</span>[filename]) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="built_in">require</span>.<span class="property">cache</span>[filename].<span class="property">_exports</span>[key]</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单讲解一下：</p>
<ol>
<li>可传入 includes 和 excludes 参数，支持 glob 写法，用来设置监听哪些代码文件。</li>
<li>用 chokidar 模块监听文件，如果有改动则重新加载该文件。这里只针对 module.exports 导出的是纯对象的模块有用，做这个限制的原因是：对于非对象比如函数，一般我们导出一个函数会直接调用执行而不是获取函数上的属性或方法，这种导出非纯对象模块即使重建缓存也不会生效，所以干脆忽略。幸运的是，module.exports 导出对象占了大多数场景。</li>
<li>用 shimmer 模块重载 Module.prototype._compile 方法，如果是被监听的文件并且导出的是纯对象，则尝试将导出的对象包装成 Proxy 实例。这样，在获取该对象上的属性时，将从 require.cache 中读取最新的值。</li>
</ol>
<p>使用示例：</p>
<p><strong>user.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;nswbmw&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;proxy-hot-reload&#x27;</span>)(&#123;</span><br><span class="line">    <span class="attr">includes</span>: <span class="string">&#x27;**/*.js&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">&#x27;./user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = user</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>浏览器访问 localhost:3000 查看结果，修改 user.js 中字段的值，然后刷新浏览器查看结果。</p>
<p>proxy-hot-reload 有个非常明显的<strong>缺点</strong>：只支持对导出的是纯对象的文件做代理，而且程序入口文件不会生效，比如上面的 app.js，修改端口号只能重启才会生效。Proxy 再怎么黑魔法也只能做到这个地步了，退一步想，如果修改了 proxy-hot-reload 覆盖不到的文件（例如：app.js）降级成自动重启就好了，如果将 proxy-hot-reload 和 supervisor 结合，会怎么样呢？</p>
<h2 id="4-5-3-supervisor-hot-reload"><a href="#4-5-3-supervisor-hot-reload" class="headerlink" title="4.5.3 supervisor-hot-reload"></a>4.5.3 <a target="_blank" rel="noopener" href="https://github.com/nswbmw/supervisor-hot-reload">supervisor-hot-reload</a></h2><p>如果要将 proxy-hot-reload 结合 supervisor 使用，需要解决以下几个难点：</p>
<ol>
<li>非侵入式。即代码里不再写：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;proxy-hot-reload&#x27;</span>)(&#123;</span><br><span class="line">    <span class="attr">includes</span>: <span class="string">&#x27;**/*.js&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>参数统一。supervisor 可接受 -w 参数表明监听哪些文件，-i 参数表明忽略哪些文件，这两个参数怎么与 proxy-hot-reload 的 includes 和 excludes 参数整合。</p>
</li>
<li><p>职责分明。修改代码文件并保存后，优先尝试 proxy-hot-reload 的热更新，如果 proxy-hot-reload 热更新不了，则使用 supervisor 重启。</p>
</li>
</ol>
<p>首先，我们来看下 supervisor 的源码（lib&#x2F;supervisor.js），源码中有这么一段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> watchItems = watch.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">watchItems.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">watchItem</span>) &#123;</span><br><span class="line">    watchItem = path.<span class="title function_">resolve</span>(watchItem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! ignoredPaths[watchItem] ) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&quot;Watching directory &#x27;&quot;</span> + watchItem + <span class="string">&quot;&#x27; for changes.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(interactive) &#123;</span><br><span class="line">            <span class="title function_">log</span>(<span class="string">&quot;Press rs for restarting the process.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">findAllWatchFiles</span>(watchItem, <span class="keyword">function</span>(<span class="params">f</span>) &#123;</span><br><span class="line">            <span class="title function_">watchGivenFile</span>( f, poll_interval );</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上代码的作用是：遍历找到所有需要监听的文件，然后调用 watchGivenFile 监听文件。watchGivenFile 代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watchGivenFile</span> (watch, poll_interval) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isWindowsWithoutWatchFile || forceWatchFlag) &#123;</span><br><span class="line">        fs.<span class="title function_">watch</span>(watch, &#123; <span class="attr">persistent</span>: <span class="literal">true</span>, <span class="attr">interval</span>: poll_interval &#125;, crashWin);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fs.<span class="title function_">watchFile</span>(watch, &#123; <span class="attr">persistent</span>: <span class="literal">true</span>, <span class="attr">interval</span>: poll_interval &#125;, <span class="keyword">function</span>(<span class="params">oldStat, newStat</span>) &#123;</span><br><span class="line">            <span class="comment">// we only care about modification time, not access time.</span></span><br><span class="line">            <span class="keyword">if</span> ( newStat.<span class="property">mtime</span>.<span class="title function_">getTime</span>() !== oldStat.<span class="property">mtime</span>.<span class="title function_">getTime</span>() ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">                    <span class="title function_">log</span>(<span class="string">&quot;file changed: &quot;</span> + watch);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">crash</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&quot;watching file &#x27;&quot;</span> + watch + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>watchGivenFile 的作用是：用 fs.watch&#x2F;fs.watchFile 监听文件，如果有改动则调用 crashWin&#x2F;crash 程序退出。supervisor 使用 child_process.spawn 将程序运行在子进程，子进程退出后会被 supervisor 重新启动。相关代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">startProgram</span> (prog, exec) &#123;</span><br><span class="line">    <span class="keyword">var</span> child = <span class="built_in">exports</span>.<span class="property">child</span> = <span class="title function_">spawn</span>(exec, prog, &#123;<span class="attr">stdio</span>: <span class="string">&#x27;inherit&#x27;</span>&#125;);</span><br><span class="line">    ...</span><br><span class="line">    child.<span class="title function_">addListener</span>(<span class="string">&quot;exit&quot;</span>, <span class="keyword">function</span> (<span class="params">code</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="title function_">startProgram</span>(prog, exec);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大体理清 supervisor 的关键源码后，我们就知道如何解决上面提到的几个难点了。</p>
<p>首先需要修改 proxy-hot-reload，添加以下几个功能：</p>
<ol>
<li>添加 includeFiles 和 excludeFiles 选项，值为数组，用来接收 supervisor 传来的文件列表。</li>
<li>添加 watchedFileChangedButNotReloadCache 参数。proxy-hot-reload 可以知道哪些代码文件可以热更新，哪些不可以。当监听到不能热更新的文件有修改时，则调用 watchedFileChangedButNotReloadCache 函数，这个函数里有 process.exit() 使进程退出。</li>
</ol>
<p>难点及解决方案如下：</p>
<ol>
<li>非侵入式。因为真正的程序试运行在 supervisor 创建的子进程中，所以我们无法在 supervisor 进程中引入 proxy-hot-reload，只能通过子进程用 <code>node -r xxx</code> 提前引入并覆盖 Module.prototype._compile。解决方案：将 supervisor 需要监听的文件数组（watchFiles）和 proxy-hot-reload 配置写到一个文件（例如：proxy-hot-reload.js）里，子进程通过 <code>node -r proxy-hot-reload.js app.js</code> 预加载此文件启动。</li>
</ol>
<p>supervisor 相关代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 watchFiles</span></span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;proxy-hot-reload.js&#x27;</span>), <span class="string">`</span></span><br><span class="line"><span class="string">    require(&#x27;<span class="subst">$&#123;path.join(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;node_modules&quot;</span>, <span class="string">&quot;proxy-hot-reload&quot;</span>)&#125;</span>&#x27;)(&#123;</span></span><br><span class="line"><span class="string">    includeFiles: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(watchFiles)&#125;</span>,</span></span><br><span class="line"><span class="string">    excludeFiles: [],</span></span><br><span class="line"><span class="string">    watchedFileChangedButNotReloadCache: function (filename) &#123;</span></span><br><span class="line"><span class="string">        console.log(filename + &#x27; changed, restarting...&#x27;);</span></span><br><span class="line"><span class="string">        setTimeout(function () &#123;</span></span><br><span class="line"><span class="string">            process.exit();</span></span><br><span class="line"><span class="string">        &#125;, <span class="subst">$&#123;poll_interval&#125;</span>);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);`</span>);</span><br><span class="line"><span class="comment">// startChildProcess()</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>参数统一。将上面的 watchItems.forEach 内异步遍历需要监听的文件列表修改为同步，代码如下：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> watchFiles = []</span><br><span class="line"><span class="keyword">var</span> watchItems = watch.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">watchItems.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">watchItem</span>) &#123;</span><br><span class="line">    watchItem = path.<span class="title function_">resolve</span>(watchItem);</span><br><span class="line">    <span class="keyword">if</span> ( ! ignoredPaths[watchItem] ) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&quot;Watching directory &#x27;&quot;</span> + watchItem + <span class="string">&quot;&#x27; for changes.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(interactive) &#123;</span><br><span class="line">            <span class="title function_">log</span>(<span class="string">&quot;Press rs for restarting the process.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">findAllWatchFiles</span>(watchItem, <span class="keyword">function</span>(<span class="params">f</span>) &#123;</span><br><span class="line">            watchFiles.<span class="title function_">push</span>(f)</span><br><span class="line">            <span class="comment">// watchGivenFile( f, poll_interval );</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：这里 findAllWatchFiles 虽然有回调函数，但却是同步的。将 findAllWatchFiles 内的 fs.lstat&#x2F;fs.stat&#x2F;fs.readdir 分别改为 fs.lstatSync&#x2F;fs.statSync&#x2F;fs.readdirSync，这里就不贴代码了。</p>
<ol start="3">
<li>职责分明。子进程使用 <code>node -r proxy-hot-reload.js app.js</code> 启动后，能热更新的则热更新，不能热更新的执行 watchedFileChangedButNotReloadCache，子进程退出，supervisor 会启动一个新的子进程，实现了职责分明。</li>
</ol>
<p>笔者将改进后的 supervisor 发布成一个新的包——<a target="_blank" rel="noopener" href="https://github.com/nswbmw/supervisor-hot-reload">supervisor-hot-reload</a> 。使用如下：</p>
<p><strong>user.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;nswbmw&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">&#x27;./user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = user</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>全局安装并使用 supervisor-hot-reload：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i supervisor-hot-reload -g</span><br><span class="line">$ DEBUG=proxy-hot-reload supervisor-hot-reload app.js</span><br></pre></td></tr></table></figure>

<p>修改 user.js，程序不会重启，打印：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy-hot-reload Reload file: /Users/nswbmw/Desktop/test/user.js</span><br></pre></td></tr></table></figure>

<p>修改 app.js，程序会重启，打印：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/Users/nswbmw/Desktop/test/app.js changed, restarting...</span><br><span class="line">Program node app.js exited with code 0</span><br><span class="line"></span><br><span class="line">Starting child process with &#x27;node app.js&#x27;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="4-5-4-内存泄露问题"><a href="#4-5-4-内存泄露问题" class="headerlink" title="4.5.4 内存泄露问题"></a>4.5.4 内存泄露问题</h2><p>这里需要声明一下，虽然修改 require.cache + Proxy 实现了我们想要的功能，但这样做存在内存泄漏问题，因为即使删除了一个模块的缓存，但父模块的缓存中还引用着旧的模块导出的对象。这个问题可以不用太关心，知道为什么就好，因为我们只是在开发环境使用 proxy-hot-reload。</p>
<h2 id="4-5-5-参考链接"><a href="#4-5-5-参考链接" class="headerlink" title="4.5.5 参考链接"></a>4.5.5 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html">https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html</a></li>
</ul>
<p>上一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/4.4%20debug%20%2B%20repl2%20%2B%20power-assert.md">4.4 debug + repl2 + power-assert</a></p>
<p>下一节：<a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/5.1%20NewRelic.md">5.1 NewRelic</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/07/30/4.4.1%20debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/30/4.4.1%20debug/" class="post-title-link" itemprop="url">Node in Debugging, 4.4 Debug</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-30 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-30T00:00:00-06:00">2019-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/07/30/4.4.1%20debug/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 4.4 Debug" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>上一小节讲解了如何用使用 VS Code 调试 Node.js 代码，但调试不只是打断点，比如：</p>
<ul>
<li>如何快速地切换输出的日志类型（或级别）?</li>
<li>我想用 moment 打印出年份，是使用 <code>moment().format(&#39;YYYY&#39;)</code>，还是 <code>moment().format(&#39;yyyy&#39;)</code>，还是两种写法都可以?</li>
<li>断言报错：AssertionError: false &#x3D;&#x3D; true，没啥有用信息，黑人问号???</li>
</ul>
<p>本节将介绍 3 款实用的调试工具，分别解决以上 3 种情况，来提高我们的调试效率。</p>
<h2 id="4-4-1-debug"><a href="#4-4-1-debug" class="headerlink" title="4.4.1 debug"></a>4.4.1 debug</h2><p>debug 是一个小巧却非常实用的日志模块，可以根据环境变量决定打印不同类型（或级别）的日志。代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const normalLog = require(&#x27;debug&#x27;)(&#x27;log&#x27;)</span><br><span class="line">const errorLowLog = require(&#x27;debug&#x27;)(&#x27;error:low&#x27;)</span><br><span class="line">const errorNormalLog = require(&#x27;debug&#x27;)(&#x27;error:normal&#x27;)</span><br><span class="line">const errorHighLog = require(&#x27;debug&#x27;)(&#x27;error:high&#x27;)</span><br><span class="line"></span><br><span class="line">setInterval(() =&gt; &#123;</span><br><span class="line">  const value = Math.random()</span><br><span class="line">  switch (true) &#123;</span><br><span class="line">    case value &lt; 0.5: normalLog(value); break</span><br><span class="line">    case value &gt;= 0.5 &amp;&amp; value &lt; 0.7: errorLowLog(value); break</span><br><span class="line">    case value &gt;= 0.7 &amp;&amp; value &lt; 0.9: errorNormalLog(value); break</span><br><span class="line">    case value &gt;= 0.9: errorHighLog(value); break</span><br><span class="line">    default: normalLog(value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, 1000)</span><br></pre></td></tr></table></figure>

<p>运行上面的代码，每一秒生成一个随机数，根据随机数的值模拟不同级别的日志输出：</p>
<ul>
<li>&lt; 0.5：正常日志。</li>
<li>0.5~0.7：低级别的错误日志。</li>
<li>0.7~0.9：一般级别的错误日志。</li>
<li>&gt;&#x3D; 0.9：严重级别的错误日志。</li>
</ul>
<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG=* node app.js</span><br></pre></td></tr></table></figure>

<p>打印如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.4.1.jpg"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.4.1.jpg" alt="img"></a></p>
<p>可以看出，debug 模块打印的日志与 console.log 相比，有以下几个特点：</p>
<ol>
<li>不同的日志类型分配了不同的颜色加以区分，更直观。</li>
<li>添加了日志类型的前缀。</li>
<li>添加了自上一次该类型日志打印到这次日志打印经历了多长时间的后缀。</li>
</ol>
<p>debug 模块支持以下用法：</p>
<ul>
<li>DEBUG&#x3D;*：打印所有类型的日志。</li>
<li>DEBUG&#x3D;log：只打印 log 类型的日志。</li>
<li>DEBUG&#x3D;error:*：打印所有以 error: 开头的日志。</li>
<li>DEBUG&#x3D;error:*,-error:low：打印所有以 error: 开头的并且过滤掉 error:low 类型的日志。</li>
</ul>
<p>下面演示一下第 4 种的用法，运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG=error:*,-error:low node app.js</span><br></pre></td></tr></table></figure>

<p>打印如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.4.2.jpg"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.4.2.jpg" alt="img"></a></p>
<h2 id="4-4-2-repl2"><a href="#4-4-2-repl2" class="headerlink" title="4.4.2 repl2"></a>4.4.2 repl2</h2><p>我们在写代码时，有时可能记不清某个模块的某个方法的具体用法，比如：用 moment 格式化年份是用 <code>moment().format(&#39;YYYY&#39;)</code> 还是用 <code>moment().format(&#39;yyyy&#39;)</code> 还是两种写法都可以？lodash 的 <code>_.pick</code> 方法能否能接收数组作为参数？这个时候相对于翻阅官方文档，在 REPL 里试一下可能会更快，通常步骤是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ npm i moment</span><br><span class="line">$ node</span><br><span class="line">&gt; const moment = require(&#x27;moment&#x27;)</span><br><span class="line">&gt; moment().format(&#x27;YYYY&#x27;)</span><br><span class="line">&#x27;2017&#x27;</span><br><span class="line">&gt; moment().format(&#x27;yyyy&#x27;)</span><br><span class="line">&#x27;yyyy&#x27;</span><br></pre></td></tr></table></figure>

<p>一次还好，次数多了也略微烦琐。repl2 模块便是为了解决这个问题而生的。</p>
<p>repl2 顾名思义是 REPL 的增强版，repl2 会根据一个用户配置（~&#x2F;.noderc），预先加载模块到 REPL 中，省下了我们手动在 REPL 中 require 模块的过程。</p>
<p>全局安装 repl2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i repl2 -g</span><br></pre></td></tr></table></figure>

<p>使用方式很简单:</p>
<ol>
<li>将常用的模块全局安装，例如：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i lodash validator moment -g</span><br></pre></td></tr></table></figure>

<ol>
<li>添加配置到 ~&#x2F;.noderc：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;lodash&quot;: &quot;__&quot;,</span><br><span class="line">  &quot;moment&quot;: &quot;moment&quot;,</span><br><span class="line">  &quot;validator&quot;: &quot;validator&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>运行 noder：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ noder</span><br><span class="line">__ = lodash@4.17.4 -&gt; local</span><br><span class="line">moment = moment@2.18.1 -&gt; global</span><br><span class="line">validator = validator@7.0.0 -&gt; global</span><br><span class="line">&gt; moment().format(&#x27;YYYY&#x27;)</span><br><span class="line">&#x27;2017&#x27;</span><br><span class="line">&gt; __.random(0, 5)</span><br><span class="line">3</span><br><span class="line">&gt; validator.isEmail(&#x27;foo@bar.com&#x27;)</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>需要讲解以下几点：</p>
<ol>
<li>~&#x2F;.noderc 是一个 JSON 文件，key 是模块的名字，value 是 require 这个模块后加载到 REPL 中的变量名。这里给 lodash 命名的变量名是 __ 而不是 _，是因为 REPL 中 _ 有特殊含义，表示上一个表达式的结果。</li>
<li>repl2 会优先加载当前目录下的模块，没有找到然后再去加载全局安装的模块。上面结果显示 lodash 是从本地目录加载的，因为 test 目录下已经安装了 lodash，其余的模块没有从本地目录找到则尝试从全局 npm 目录加载。如果都没有找到，则不会加载。</li>
</ol>
<h2 id="4-4-3-power-assert"><a href="#4-4-3-power-assert" class="headerlink" title="4.4.3 power-assert"></a>4.4.3 power-assert</h2><p>我们常用的断言库有：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/shouldjs/should.js">should.js</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Automattic/expect.js">expect.js</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/chaijs/chai">chai</a></li>
</ul>
<p>但这类断言库都有一些通病：</p>
<ol>
<li>过分追求语义化，API 复杂。</li>
<li>错误信息不足。</li>
</ol>
<p>先看一段代码：</p>
<p><strong>test.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const assert = require(&#x27;assert&#x27;)</span><br><span class="line">const should = require(&#x27;should&#x27;)</span><br><span class="line">const expect = require(&#x27;expect.js&#x27;)</span><br><span class="line"></span><br><span class="line">const tom = &#123; id: 1, age: 18 &#125;</span><br><span class="line">const bob = &#123; id: 2, age: 20 &#125;</span><br><span class="line"></span><br><span class="line">describe(&#x27;app.js&#x27;, () =&gt; &#123;</span><br><span class="line">  it(&#x27;assert&#x27;, () =&gt; &#123;</span><br><span class="line">    assert(tom.age &gt; bob.age)</span><br><span class="line">  &#125;)</span><br><span class="line">  it(&#x27;should.js&#x27;, () =&gt; &#123;</span><br><span class="line">    tom.age.should.be.above(bob.age)</span><br><span class="line">  &#125;)</span><br><span class="line">  it(&#x27;expect.js&#x27;, () =&gt; &#123;</span><br><span class="line">    expect(tom.age).be.above(bob.age)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mocha</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">app.js</span><br><span class="line">  1) assert</span><br><span class="line">  2) should.js</span><br><span class="line">  3) expect.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 passing (13ms)</span><br><span class="line">3 failing</span><br><span class="line"></span><br><span class="line">1) app.js</span><br><span class="line">     assert:</span><br><span class="line"></span><br><span class="line">    AssertionError [ERR_ASSERTION]: false == true</span><br><span class="line">    + expected - actual</span><br><span class="line"></span><br><span class="line">    -false</span><br><span class="line">    +true</span><br><span class="line"></span><br><span class="line">    at Context.it (test.js:10:5)</span><br><span class="line"></span><br><span class="line">2) app.js</span><br><span class="line">     should.js:</span><br><span class="line">   AssertionError: expected 18 to be above 20</span><br><span class="line">    at Assertion.fail (node_modules/should/cjs/should.js:275:17)</span><br><span class="line">    at Assertion.value (node_modules/should/cjs/should.js:356:19)</span><br><span class="line">    at Context.it (test.js:13:23)</span><br><span class="line"></span><br><span class="line">3) app.js</span><br><span class="line">     expect.js:</span><br><span class="line">   Error: expected 18 to be above 20</span><br><span class="line">    at Assertion.assert (node_modules/expect.js/index.js:96:13)</span><br><span class="line">    at Assertion.greaterThan.Assertion.above (node_modules/expect.js/index.js:297:10)</span><br><span class="line">    at Function.above (node_modules/expect.js/index.js:499:17)</span><br><span class="line">    at Context.it (test.js:16:24)</span><br></pre></td></tr></table></figure>

<p>可以看出，基本没有有用的信息。这时，power-assert 粉墨登场。</p>
<p>power-assert 使用起来很简单，理论上只用一个 assert 就可以了，而且可以无缝迁移。</p>
<p><strong>注意</strong>：在使用 intelli-espower-loader 时，要求必须将测试文件放到 test&#x2F; 目录下，所以我们在 test 目录下创建 test&#x2F;app.js，将原来的 test.js 代码粘贴过去。</p>
<p>安装 power-assert 和 intelli-espower-loader，然后运行测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i power-assert intelli-espower-loader --save-dev</span><br><span class="line">$ mocha -r intelli-espower-loader</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">app.js</span><br><span class="line">  1) assert</span><br><span class="line">  2) should.js</span><br><span class="line">  3) expect.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 passing (42ms)</span><br><span class="line">3 failing</span><br><span class="line"></span><br><span class="line">1) app.js</span><br><span class="line">     assert:</span><br><span class="line"></span><br><span class="line">    AssertionError [ERR_ASSERTION]:   # test/app.js:10</span><br><span class="line"></span><br><span class="line">assert(tom.age &gt; bob.age)</span><br><span class="line">       |   |   | |   |</span><br><span class="line">       |   |   | |   20</span><br><span class="line">       |   |   | Object&#123;id:2,age:20&#125;</span><br><span class="line">       |   18  false</span><br><span class="line">       Object&#123;id:1,age:18&#125;</span><br><span class="line"></span><br><span class="line">    + expected - actual</span><br><span class="line"></span><br><span class="line">    -false</span><br><span class="line">    +true</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>错误信息非常直观，有以下两点需要说明：</p>
<ol>
<li>mocha 需要引入 intelli-espower-loader，主要是转译代码，转译之后 <code>require(&#39;assert&#39;)</code> 都不需要改。</li>
<li>intelli-espower-loader 可选择地在 package.json 中添加 directories.test 配置，例如：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;directories&quot;: &#123;</span><br><span class="line">  &quot;test&quot;: &quot;mytest/&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有 directories.test 配置，则默认是 <code>test/</code>。</p>
<h2 id="4-4-4-参考链接"><a href="#4-4-4-参考链接" class="headerlink" title="4.4.4 参考链接"></a>4.4.4 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25956323">https://zhuanlan.zhihu.com/p/25956323</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/intelli-espower-loader">https://www.npmjs.com/package/intelli-espower-loader</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/07/26/4.3.1%20%E5%9F%BA%E6%9C%AC%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/26/4.3.1%20%E5%9F%BA%E6%9C%AC%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">Node in Debugging, 4.3 VS Code Debugging</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-26 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-26T00:00:00-06:00">2019-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/07/26/4.3.1%20%E5%9F%BA%E6%9C%AC%E8%B0%83%E8%AF%95/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 4.3 VS Code Debugging" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>Visual Studio Code（简称 VS Code）是一款微软开源的现代化、跨平台、轻量级的代码编辑器。VS Code 很好很强大，本节将介绍如何使用 VS Code 来调试 Node.js 代码。</p>
<h2 id="4-3-1-基本调试"><a href="#4-3-1-基本调试" class="headerlink" title="4.3.1 基本调试"></a>4.3.1 基本调试</h2><p>示例代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const Paloma = require(&#x27;paloma&#x27;)</span><br><span class="line">const app = new Paloma()</span><br><span class="line"></span><br><span class="line">app.use(ctx =&gt; &#123;</span><br><span class="line">  ctx.body = &#x27;hello world!&#x27;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure>

<p>用 VS Code 加载 test 文件夹，打开 app.js，然后进行如下操作：</p>
<ol>
<li>单击左侧第 4 个 tab，切换到调试模式。</li>
<li>单击代码第 5 行 <code>ctx.body=&#39;hello world!&#39;</code> 左侧空白处添加断点。</li>
<li>单击左上角 ”调试“ 的绿色三角按钮启动调试。</li>
<li>单击左上角的终端图标打开调试控制台。</li>
</ol>
<p>最终如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.1.png" alt="img"></a></p>
<p>从 “调试控制台“ 切换到 ”终端“，运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:3000</span><br></pre></td></tr></table></figure>

<p>如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.2.png" alt="img"></a></p>
<p>可以看出，VS Code 基本覆盖了 Chrome DevTools 的所有功能，并且有两个额外的优点：</p>
<ol>
<li>集成了终端，不用再打开新的终端输入命令了。</li>
<li>调试动作里添加了 ”重启“ 和 ”停止“ 按钮，不用每次修改完代码后切回终端去重启了。</li>
</ol>
<p>但 VS Code 的强大远不止如此，通过 launch.json 可以配置详细的调试功能。</p>
<h2 id="4-3-2-launch-json"><a href="#4-3-2-launch-json" class="headerlink" title="4.3.2 launch.json"></a>4.3.2 launch.json</h2><p>上图可以看出，”调试“ 按钮右边有一个下拉菜单，默认是 ”没有配置“。单击右侧的齿轮状图标，会在项目根目录下创建 .vscode 文件夹及 launch.json 文件。launch.json 的内容如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.3.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.3.png" alt="img"></a></p>
<p>这个默认配置的意思是执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node $&#123;workspaceFolder&#125;/app.js</span><br></pre></td></tr></table></figure>

<p>launch.json 其实就是存储了一些调试相关的配置，VS Code 在启动调试时，会读取 launch.json 决定以何种方式调试。launch.json 有以下常用选项：</p>
<p>必需字段如下：</p>
<ul>
<li>type：调试器类型。这里是 node（内置的调试器），如果安装了 Go 和 PHP 的扩展后，则对应的 type 分别为 go 和 php。</li>
<li>request：请求的类型，支持 launch 和 attach。launch 就是以 debug 模式启动调试，attach 就是附加到已经启动的进程开启 debug 模式并调试，跟在上一小节中提到的用 <code>node -e &quot;process._debugProcess(PID)&quot;</code> 作用一样。</li>
<li>name：下拉菜单显示的名字。</li>
</ul>
<p>可选字段（括号里表示适用的类型）如下：</p>
<ul>
<li>program：可执行文件或者调试器要运行的文件 (launch)。</li>
<li>args：要传递给调试程序的参数 (launch)。</li>
<li>env：环境变量 (launch)。</li>
<li>cwd：当前执行目录 (launch)。</li>
<li>address：IP 地址 (launch &amp; attach)。</li>
<li>port：端口号 (launch &amp; attach)。</li>
<li>skipFiles：想要忽略的文件，数组类型 (launch &amp; attach)。</li>
<li>processId：进程 PID (attach)。</li>
<li>…</li>
</ul>
<p>变量替换：</p>
<ul>
<li>${workspaceFolder}：当前打开工程的路径。</li>
<li>${file}：当前打开文件的路径。</li>
<li>${fileBasename}：当前打开文件的名字，包含后缀名。</li>
<li>${fileDirname}：当前打开文件所在的文件夹的路径。</li>
<li>${fileExtname}：当前打开文件的后缀名。</li>
<li>${cwd}：当前执行目录。</li>
<li>…</li>
</ul>
<p>如果当前打开的文件是 app.js，则以下配置与默认配置是等效的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;file&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若想了解更多的 launch.json 选项，则请查阅：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/editor/debugging#_launchjson-attributes">Debugging in Visual Studio Code</a>。</li>
<li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_launch-configuration-attributes">Debug Node.js Apps using VS Code</a>。</li>
</ul>
<p>下面以 5 个实用的技巧讲解部分 launch.json 配置的作用。</p>
<h2 id="4-3-3-技巧-1——条件断点"><a href="#4-3-3-技巧-1——条件断点" class="headerlink" title="4.3.3 技巧 1——条件断点"></a>4.3.3 技巧 1——条件断点</h2><p>VS Code 可以添加条件断点，即执行到该行代码满足特定条件后程序才会中断。在断点小红点上右键选择 ”编辑断点“，可以选择以下两种条件：</p>
<ol>
<li>表达式：当表达式计算结果为 true 时中断，例如设置：<code>ctx.query.name === &#39;nswbmw&#39;</code>，表示当访问 <code>localhost:3000?name=nswbmw</code> 时断点才会生效，其余请求断点无效。</li>
<li>命中次数：同样当表达式计算结果为 true 时中断，支持运算符 &lt;、&lt;&#x3D;、&#x3D;&#x3D;、&gt;、&gt;&#x3D;、%。例如：<ol>
<li>&gt;10：执行 10 次以后，断点才会生效。</li>
<li>&lt;3：只有前 2 次断点会生效。</li>
<li>10：等价于 &gt;&#x3D;10。</li>
<li>%2：隔一次中断一次。</li>
</ol>
</li>
</ol>
<p><strong>注意</strong>：可以组合表达式和命中次数条件一起使用。在切换条件类型时，需要将原来的条件清空，否则会添加两种条件。将鼠标悬浮在断点上，可以查看设置了哪些条件。</p>
<h2 id="4-3-4-技巧-2——skipFiles"><a href="#4-3-4-技巧-2——skipFiles" class="headerlink" title="4.3.4 技巧 2——skipFiles"></a>4.3.4 技巧 2——skipFiles</h2><p>从上面图中可以看到，在 VS Code 左侧有一个 ”调用堆栈“ 面板，显示了当前断点的调用堆栈，但无法直观地看出哪些是我们项目的代码，哪些是 node_modules 里模块的代码，而且在单步调试时会进入到 node_modules 里。总之，我们不关心 node_modules 里的代码，我们只关心项目本身的代码。这时，skipFiles 就派上用场了。</p>
<p>skipFiles 顾名思义就是忽略我们不关心的文件。修改 launch.json 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;,</span><br><span class="line">                &quot;&lt;node_internals&gt;/**/*.js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有以下几点需要解释：</p>
<ol>
<li>支持 ${xxx} 这种变量替换。</li>
<li>支持 glob 模式匹配。</li>
<li><node_internals> 用来忽略 Node.js 核心模块。</li>
</ol>
<p>重启调试后，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.4.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.4.png" alt="img"></a></p>
<p><strong>可以看出</strong>：在左侧 ”调用堆栈“ 中，我们不关心的调用栈都变灰了，而且单步调试也不会进入到 skipFiles 所匹配的文件里。</p>
<h2 id="4-3-5-技巧-3——自动重启"><a href="#4-3-5-技巧-3——自动重启" class="headerlink" title="4.3.5 技巧 3——自动重启"></a>4.3.5 技巧 3——自动重启</h2><p>在每次修改代码保存后都要手动重启，否则修改后的代码和断点都不会生效。VS Code 开发者们想到了这一点，通过添加配置可以实现修改代码保存后会自动重启调试，需要结合 <a target="_blank" rel="noopener" href="https://nodemon.io/">nodemon</a> 一起使用。</p>
<p>首先，全局安装 nodemon：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i nodemon -g</span><br></pre></td></tr></table></figure>

<p>然后，修改 launch.json：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;runtimeExecutable&quot;: &quot;nodemon&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;console&quot;: &quot;integratedTerminal&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;,</span><br><span class="line">                &quot;&lt;node_internals&gt;/**/*.js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前的 launch.json 相比较上一个版本的 launch.json，多了以下几个字段：</p>
<ul>
<li>runtimeExecutable：用什么命令执行 app.js，这里设置为 nodemon。</li>
<li>restart：设置为 true，修改代码并保存后会自动重启调试。</li>
<li>console：当单击停止按钮或者修改代码并保存后自动重启调试，而 nodemon 是仍然在运行的，通过设置为 console 为 integratedTerminal 可以解决这个问题。此时 VS Code 终端将会打印 nodemon 的 log，可以在终端右侧的下拉菜单中选择返回第 1 个终端，然后运行 <code>curl localhost:3000</code> 进行调试。</li>
</ul>
<p>对于已经使用 nodemon 运行的程序，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nodemon --inspect app.js</span><br></pre></td></tr></table></figure>

<p>可使用 attach 模式启动调试，launch.json 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;Attach to node&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;attach&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;processId&quot;: &quot;$&#123;command:PickProcess&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行 Attach to node 配置进行调试时，VS Code 会列出正在执行的 node 进程及对应的 PID 以供选择。也可以通过 address 和 port 参数设置 attach 到具体的进程开启调试。</p>
<h2 id="4-3-6-技巧-4——特定操作系统设置"><a href="#4-3-6-技巧-4——特定操作系统设置" class="headerlink" title="4.3.6 技巧 4——特定操作系统设置"></a>4.3.6 技巧 4——特定操作系统设置</h2><p>针对不同的操作系统，可能会用到不同的调试配置。可选的参数为：</p>
<ul>
<li>windows</li>
<li>linux</li>
<li>osx</li>
</ul>
<p>示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动调试&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;./node_modules/gulp/bin/gulpfile.js&quot;,</span><br><span class="line">            &quot;args&quot;: [&quot;/path/to/app.js&quot;],</span><br><span class="line">            &quot;windows&quot;: &#123;</span><br><span class="line">                &quot;args&quot;: [&quot;\\path\\to\\app.js&quot;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-7-技巧-5——多配置"><a href="#4-3-7-技巧-5——多配置" class="headerlink" title="4.3.7 技巧 5——多配置"></a>4.3.7 技巧 5——多配置</h2><p>configurations 是个数组而不是个对象，这样设计就是为了可以添加多个调试配置。打开 launch.json，单击右下角的 ”添加配置…“，会弹出配置模板，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.5.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.5.png" alt="img"></a></p>
<p>configurations 可以用来配置不同的调试规则，比如最终将 launch.json 修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;attach&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;Attach to node&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;processId&quot;: &quot;$&#123;command:PickProcess&#125;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;runtimeExecutable&quot;: &quot;nodemon&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;console&quot;: &quot;integratedTerminal&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;,</span><br><span class="line">                &quot;&lt;node_internals&gt;/**/*.js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-8-总结"><a href="#4-3-8-总结" class="headerlink" title="4.3.8 总结"></a>4.3.8 总结</h2><p>VS Code 的调试功能十分强大，本节只讲解了一些常用的调试功能，对于其余的调试功能，还请读者自行尝试。</p>
<h2 id="4-3-9-参考链接"><a href="#4-3-9-参考链接" class="headerlink" title="4.3.9 参考链接"></a>4.3.9 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/editor/debugging">https://code.visualstudio.com/docs/editor/debugging</a></li>
<li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging">https://code.visualstudio.com/docs/nodejs/nodejs-debugging</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/07/22/4.2.1%20%E4%BD%BF%E7%94%A8%20Chrome%20DevTools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/22/4.2.1%20%E4%BD%BF%E7%94%A8%20Chrome%20DevTools/" class="post-title-link" itemprop="url">Node in Debugging, 4.2 Chrome Devtools</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-22T00:00:00-06:00">2019-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/07/22/4.2.1%20%E4%BD%BF%E7%94%A8%20Chrome%20DevTools/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 4.2 Chrome Devtools" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>调试是每个程序员必备的技能，因此选择合适的调试工具能极大地方便我们调试代码。Node.js 的调试方式也有很多，常见的有：</p>
<ol>
<li>万能的 console.log</li>
<li>debugger</li>
<li>node-inspector</li>
</ol>
<p>以上本节都不会讲解，因为：</p>
<ol>
<li>console.log 就不用说了。</li>
<li>debugger 不推荐使用，因为：<ol>
<li>使用繁琐，需手动打点。</li>
<li>若忘记删除 debugger，还会引起性能问题。</li>
</ol>
</li>
<li>node-inspector 已经退出历史舞台。<a href="mailto:&#x6e;&#111;&#100;&#101;&#x40;&#54;&#46;&#51;">&#x6e;&#111;&#100;&#101;&#x40;&#54;&#46;&#51;</a> 以后内置了一个调试器，可以结合 Chrome DevTools 使用，而且比 node-inspector 更强大。</li>
</ol>
<p>下面就讲讲 Chrome DevTools 的用法。</p>
<h2 id="4-2-1-使用-Chrome-DevTools"><a href="#4-2-1-使用-Chrome-DevTools" class="headerlink" title="4.2.1 使用 Chrome DevTools"></a>4.2.1 使用 Chrome DevTools</h2><p>创建示例代码：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const Paloma = require(&#x27;paloma&#x27;)</span><br><span class="line">const app = new Paloma()</span><br><span class="line"></span><br><span class="line">app.use(ctx =&gt; &#123;</span><br><span class="line">  ctx.body = &#x27;hello world!&#x27;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node --inspect app.js</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：如果想让代码在第 1 行就暂停执行，需要使用 –inspect-brk 参数启动，即 <code>node --inspect-brk app.js</code>。</p>
<p>打开 Chrome 浏览器，访问 chrome:&#x2F;&#x2F;inspect，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.1.png" alt="img"></a></p>
<p>单击 Remote Target 下的 inspect，选择 Sources，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.2.png" alt="img"></a></p>
<p>使用方式与 node-inspector 类似，可以添加断点，然后在 Console 里面直接输入变量名来打印该变量的值。如下所示，在第 6 行添加断点，然后通过 <code>curl localhost:3000?name=nswbmw</code>，代码执行到第 6 行暂停执行，在 Console 里打印 ctx.query 的值：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.3.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.3.png" alt="img"></a></p>
<p><strong>小提示</strong>：将鼠标悬浮在某个变量上，也会显示它的值，例如：ctx。</p>
<p>展开右侧的 debugger 有更多的功能，例如单步执行、单步进入、单步退出等等，这里不再详细讲解。</p>
<h2 id="4-2-2-NIM"><a href="#4-2-2-NIM" class="headerlink" title="4.2.2 NIM"></a>4.2.2 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/nim-node-inspector-manage/gnhhdgbaldcilmgcpfddgdbkhjohddkj">NIM</a></h2><p>每次调试 Node.js 都要打开隐藏那么深的入口是不是很烦？还好我们有 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/nim-node-inspector-manage/gnhhdgbaldcilmgcpfddgdbkhjohddkj">NIM</a>。NIM（Node Inspector Manager）是一个 Chrome 插件，可以帮助我们快捷地打开 DevTools，也可以设置自动发现并打开 DevTools。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.4.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.4.png" alt="img"></a></p>
<h2 id="4-2-3-inspect-process"><a href="#4-2-3-inspect-process" class="headerlink" title="4.2.3 inspect-process"></a>4.2.3 <a target="_blank" rel="noopener" href="https://github.com/jaridmargolin/inspect-process">inspect-process</a></h2><p>如果你觉得 NIM 用起来也麻烦，那你可能需要 <a target="_blank" rel="noopener" href="https://github.com/jaridmargolin/inspect-process">inspect-process</a>。</p>
<p>全局安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i inspect-process -g</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ inspect app.js</span><br></pre></td></tr></table></figure>

<p>inspect-process 会自动调起 Chrome DevTools，然后定位到 app.js，其余用法与 Chrome DevTools 一致。</p>
<h2 id="4-2-4-process-debugProcess"><a href="#4-2-4-process-debugProcess" class="headerlink" title="4.2.4 process._debugProcess"></a>4.2.4 process._debugProcess</h2><p>如果一个 Node.js 进程已经启动，没有添加 –inspect 参数，我们不想重启（会丢失现场）又想调试怎么办？这时可以用 process._debugProcess。使用方法如下：</p>
<ol>
<li>通过 ps 命令或者 <code>pgrep -n node</code> 查看当前启动的 Node.js 进程的 pid，例如：53911。</li>
<li>打开新的终端，运行：<code>node -e &quot;process._debugProcess(53911)&quot;</code>，原来的 Node.js 进程会打印出：Debugger listening on ws:&#x2F;&#x2F;127.0.0.1:9229&#x2F;2331fa07-32af-45eb-a1a8-bead7a0ab905。</li>
<li>调出 Chrome DevTools 进行调试。</li>
</ol>
<h2 id="4-2-5-参考链接"><a href="#4-2-5-参考链接" class="headerlink" title="4.2.5 参考链接"></a>4.2.5 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27">https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/07/21/Nohup-exit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/21/Nohup-exit/" class="post-title-link" itemprop="url">Nohup stop running unexpected - solved</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-21 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-21T00:00:00-06:00">2019-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hexo/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/2019/07/21/Nohup-exit/" class="post-meta-item leancloud_visitors" data-flag-title="Nohup stop running unexpected - solved" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Today I have encounterd a weird issue with Nohup, my sh command is used as:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> npm start 2&gt;/dev/null 1&gt;/dev/null&amp;</span><br></pre></td></tr></table></figure>
<p>But after I have closed the connection of my Putty, the npm thread was terminated.</p>
<p>Finally, I have found the problem is with the session, to disconnect the Putty, I have to tpye in command exit, instead of closing the window directly, the exit command will leave the session running in background.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018  
  <!-- <span itemprop="copyrightYear">2022</span> -->
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Marvin Liu</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"appid":"qAsjmBkdw5m0pBHIrH2owQQT-MdYXbMMI","appkey":"xmNL8CNHrbd2QvJOzWwbj3ny","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
