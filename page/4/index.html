<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#64CEAA"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#64CEAA">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"marvinliu1.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Take in the good!">
<meta property="og:type" content="website">
<meta property="og:title" content="Marvin&#39;s Blog">
<meta property="og:url" content="https://marvinliu1.github.io/page/4/index.html">
<meta property="og:site_name" content="Marvin&#39;s Blog">
<meta property="og:description" content="Take in the good!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Marvin Liu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://marvinliu1.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Marvin's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Marvin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Marvin's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>links</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Marvin Liu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Marvin Liu</p>
  <div class="site-description" itemprop="description">Take in the good!</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/marvinliu1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;marvinliu1" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liuyongquan2010@gmail.com" title="E-Mail → mailto:liuyongquan2010@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="color:white;">document.designMode='on'</div>

        </div>
      </div>
    </div>
    
    <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
    <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
    <div class="widget-wrap">
        <h3 class="widget-title">Tags</h3>
        <div id="myCanvasContainer" class="widget tagcloud">
            <canvas width="250" height="250" id="resCanvas" style="width=100%">
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debugging/" rel="tag">Debugging</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/" rel="tag">Javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MarkDown/" rel="tag">MarkDown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NeXt/" rel="tag">NeXt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Next/" rel="tag">Next</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node/" rel="tag">Node</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nohup/" rel="tag">Nohup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nuxt/" rel="tag">Nuxt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a><span class="tag-list-count">2</span></li></ul>
            </canvas>
        </div>
    </div>
    
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/marvinliu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/04/13/2.3.1%20%E4%BD%BF%E7%94%A8%20memwatch-next/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/13/2.3.1%20%E4%BD%BF%E7%94%A8%20memwatch-next/" class="post-title-link" itemprop="url">Node in Debugging, 2.3 How to use memwatch-next</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-13 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-13T00:00:00-06:00">2019-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/04/13/2.3.1%20%E4%BD%BF%E7%94%A8%20memwatch-next/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 2.3 How to use memwatch-next" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/marcominetti/node-memwatch">memwatch-next</a>（以下简称 memwatch）是一个用来监测 Node.js 的内存泄漏和堆信息比较的模块。下面我们以一段事件监听器导致内存泄漏的代码为例，讲解如何使用 memwatch。</p>
<h2 id="2-3-1-使用-memwatch-next"><a href="#2-3-1-使用-memwatch-next" class="headerlink" title="2.3.1 使用 memwatch-next"></a>2.3.1 使用 memwatch-next</h2><p>测试代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let count = 1</span><br><span class="line">const memwatch = require(&#x27;memwatch-next&#x27;)</span><br><span class="line">memwatch.on(&#x27;stats&#x27;, (stats) =&gt; &#123; </span><br><span class="line">  console.log(count++, stats)</span><br><span class="line">&#125;)</span><br><span class="line">memwatch.on(&#x27;leak&#x27;, (info) =&gt; &#123;</span><br><span class="line">  console.log(&#x27;---&#x27;)</span><br><span class="line">  console.log(info)</span><br><span class="line">  console.log(&#x27;---&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const http = require(&#x27;http&#x27;)</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  for (let i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">    server.on(&#x27;request&#x27;, function leakEventCallback() &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(&#x27;Hello World&#x27;)</span><br><span class="line">  global.gc()</span><br><span class="line">&#125;).listen(3000)</span><br></pre></td></tr></table></figure>

<p>在每个请求到来时，在 server 上注册 10000 个 request 事件的监听函数（大量的事件监听函数存储到内存中，从而造成了内存泄漏），然后手动触发一次 GC。</p>
<p>运行该程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node --expose-gc app.js</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：这里添加 –expose-gc 参数启动程序，这样我们才可以在程序中手动触发 GC。</p>
<p>memwatch 监听以下两个事件：</p>
<ol>
<li><p>stats：GC 事件，每执行一次 GC，都会触发该函数，打印 heap 相关的信息。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  num_full_gc: 1,// 完整的垃圾回收次数</span><br><span class="line">  num_inc_gc: 1,// 增长的垃圾回收次数</span><br><span class="line">  heap_compactions: 1,// 内存压缩次数</span><br><span class="line">  usage_trend: 0,// 使用趋势</span><br><span class="line">  estimated_base: 5350136,// 预期基数</span><br><span class="line">  current_base: 5350136,// 当前基数</span><br><span class="line">  min: 0,// 最小值</span><br><span class="line">  max: 0// 最大值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>leak：可疑的内存泄露事件，触发该事件的条件是：内存在连续 5 次 GC 后都是增长的。打印如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  growth: 4051464,</span><br><span class="line">  reason: &#x27;heap growth over 5 consecutive GCs (2s) - -2147483648 bytes/hr&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -c 1 -n 5 http://localhost:3000/</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(node:20989) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 request listeners added. Use emitter.setMaxListeners() to increase limit</span><br><span class="line">1 &#123; num_full_gc: 1,</span><br><span class="line">  num_inc_gc: 1,</span><br><span class="line">  heap_compactions: 1,</span><br><span class="line">  usage_trend: 0,</span><br><span class="line">  estimated_base: 5720064,</span><br><span class="line">  current_base: 5720064,</span><br><span class="line">  min: 0,</span><br><span class="line">  max: 0 &#125;</span><br><span class="line">2 &#123; num_full_gc: 2,</span><br><span class="line">  num_inc_gc: 1,</span><br><span class="line">  heap_compactions: 2,</span><br><span class="line">  usage_trend: 0,</span><br><span class="line">  estimated_base: 7073824,</span><br><span class="line">  current_base: 7073824,</span><br><span class="line">  min: 0,</span><br><span class="line">  max: 0 &#125;</span><br><span class="line">3 &#123; num_full_gc: 3,</span><br><span class="line">  num_inc_gc: 1,</span><br><span class="line">  heap_compactions: 3,</span><br><span class="line">  usage_trend: 0,</span><br><span class="line">  estimated_base: 7826368,</span><br><span class="line">  current_base: 7826368,</span><br><span class="line">  min: 7826368,</span><br><span class="line">  max: 7826368 &#125;</span><br><span class="line">4 &#123; num_full_gc: 4,</span><br><span class="line">  num_inc_gc: 1,</span><br><span class="line">  heap_compactions: 4,</span><br><span class="line">  usage_trend: 0,</span><br><span class="line">  estimated_base: 8964784,</span><br><span class="line">  current_base: 8964784,</span><br><span class="line">  min: 7826368,</span><br><span class="line">  max: 8964784 &#125;</span><br><span class="line">---</span><br><span class="line">&#123; growth: 3820272,</span><br><span class="line">  reason: &#x27;heap growth over 5 consecutive GCs (0s) - -2147483648 bytes/hr&#x27; &#125;</span><br><span class="line">---</span><br><span class="line">5 &#123; num_full_gc: 5,</span><br><span class="line">  num_inc_gc: 1,</span><br><span class="line">  heap_compactions: 5,</span><br><span class="line">  usage_trend: 0,</span><br><span class="line">  estimated_base: 9540336,</span><br><span class="line">  current_base: 9540336,</span><br><span class="line">  min: 7826368,</span><br><span class="line">  max: 9540336 &#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看出</strong>：Node.js 已经警告我们事件监听器超过了 11 个，可能造成内存泄露。连续 5 次内存增长触发 leak 事件打印出增长了多少内存（bytes）和预估每小时增长多少 bytes。</p>
<h2 id="2-3-2-Heap-Diffing"><a href="#2-3-2-Heap-Diffing" class="headerlink" title="2.3.2 Heap Diffing"></a>2.3.2 Heap Diffing</h2><p>memwatch 有一个 HeapDiff 函数，用来对比并计算出两次堆快照的差异。修改测试代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const memwatch = require(&#x27;memwatch-next&#x27;)</span><br><span class="line">const http = require(&#x27;http&#x27;)</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  for (let i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">    server.on(&#x27;request&#x27;, function leakEventCallback() &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(&#x27;Hello World&#x27;)</span><br><span class="line">  global.gc()</span><br><span class="line">&#125;).listen(3000)</span><br><span class="line"></span><br><span class="line">const hd = new memwatch.HeapDiff()</span><br><span class="line">memwatch.on(&#x27;leak&#x27;, (info) =&gt; &#123;</span><br><span class="line">  const diff = hd.end()</span><br><span class="line">  console.dir(diff, &#123; depth: 10 &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>运行这段代码并执行同样的 ab 命令，打印如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123; before: &#123; nodes: 35727, size_bytes: 4725128, size: &#x27;4.51 mb&#x27; &#125;,</span><br><span class="line">  after: &#123; nodes: 87329, size_bytes: 8929792, size: &#x27;8.52 mb&#x27; &#125;,</span><br><span class="line">  change:</span><br><span class="line">   &#123; size_bytes: 4204664,</span><br><span class="line">     size: &#x27;4.01 mb&#x27;,</span><br><span class="line">     freed_nodes: 862,</span><br><span class="line">     allocated_nodes: 52464,</span><br><span class="line">     details:</span><br><span class="line">      [ ...</span><br><span class="line">        &#123; what: &#x27;Array&#x27;,</span><br><span class="line">          size_bytes: 530200,</span><br><span class="line">          size: &#x27;517.77 kb&#x27;,</span><br><span class="line">          &#x27;+&#x27;: 1023,</span><br><span class="line">          &#x27;-&#x27;: 510 &#125;,</span><br><span class="line">        &#123; what: &#x27;Closure&#x27;,</span><br><span class="line">          size_bytes: 3599856,</span><br><span class="line">          size: &#x27;3.43 mb&#x27;,</span><br><span class="line">          &#x27;+&#x27;: 50001,</span><br><span class="line">          &#x27;-&#x27;: 3 &#125;,</span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看出</strong>：内存由 4.51mb 涨到了 8.52mb，其中 Closure 和 Array 涨了绝大部分，而我们知道注册事件监听函数的本质就是将事件函数（Closure）push 到相应的数组（Array）里。</p>
<h2 id="2-3-3-结合-heapdump"><a href="#2-3-3-结合-heapdump" class="headerlink" title="2.3.3 结合 heapdump"></a>2.3.3 结合 heapdump</h2><p>memwatch 在结合 heapdump 使用时才能发挥更好的作用。通常用 memwatch 监测到内存泄漏，用 heapdump 导出多份堆快照，然后用 Chrome DevTools 分析和比较，定位内存泄漏的元凶。</p>
<p>修改代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const memwatch = require(&#x27;memwatch-next&#x27;)</span><br><span class="line">const heapdump = require(&#x27;heapdump&#x27;)</span><br><span class="line"></span><br><span class="line">const http = require(&#x27;http&#x27;)</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  for (let i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">    server.on(&#x27;request&#x27;, function leakEventCallback() &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(&#x27;Hello World&#x27;)</span><br><span class="line">  global.gc()</span><br><span class="line">&#125;).listen(3000)</span><br><span class="line"></span><br><span class="line">dump()</span><br><span class="line">memwatch.on(&#x27;leak&#x27;, () =&gt; &#123;</span><br><span class="line">  dump()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">function dump() &#123;</span><br><span class="line">  const filename = `$&#123;__dirname&#125;/heapdump-$&#123;process.pid&#125;-$&#123;Date.now()&#125;.heapsnapshot`</span><br><span class="line"></span><br><span class="line">  heapdump.writeSnapshot(filename, () =&gt; &#123;</span><br><span class="line">    console.log(`$&#123;filename&#125; dump completed.`)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上程序在启动后先执行一次 heap dump，当触发 leak 事件时再执行一次 heap dump。运行这段代码并执行同样的 ab 命令，生成两个 heapsnapshot 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heapdump-21126-1519545957879.heapsnapshot</span><br><span class="line">heapdump-21126-1519545975702.heapsnapshot</span><br></pre></td></tr></table></figure>

<p>用 Chrome DevTools 加载这两个 heapsnapshot 文件，选择 comparison 比较视图，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/2.3.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/2.3.1.png" alt="img"></a></p>
<p><strong>可以看出</strong>：增加了 5 万个 leakEventCallback 函数，单击其中任意一个，可以从 Retainers 中看到更详细的信息，例如 GC path 和所在的文件等信息。</p>
<h2 id="2-3-4-参考链接"><a href="#2-3-4-参考链接" class="headerlink" title="2.3.4 参考链接"></a>2.3.4 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/marcominetti/node-memwatch">https://github.com/marcominetti/node-memwatch</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/04/12/2.2.1%20%E4%BD%BF%E7%94%A8%20heapdump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/12/2.2.1%20%E4%BD%BF%E7%94%A8%20heapdump/" class="post-title-link" itemprop="url">Node in Debugging, 2.2 About heapdump</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-12T00:00:00-06:00">2019-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/04/12/2.2.1%20%E4%BD%BF%E7%94%A8%20heapdump/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 2.2 About heapdump" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/bnoordhuis/node-heapdump">heapdump</a> 是一个 dump V8 堆信息的工具。<a target="_blank" rel="noopener" href="https://github.com/node-inspector/v8-profiler">v8-profiler</a> 也包含了这个功能，这两个工具的原理都是一致的，都是 v8::Isolate::GetCurrent()-&gt;GetHeapProfiler()-&gt;TakeHeapSnapshot(title, control)，但是 heapdump 的使用简单些。下面我们以 heapdump 为例讲解如何分析 Node.js 的内存泄漏。</p>
<h2 id="2-2-1-使用-heapdump"><a href="#2-2-1-使用-heapdump" class="headerlink" title="2.2.1 使用 heapdump"></a>2.2.1 使用 heapdump</h2><p>这里以一段经典的内存泄漏代码作为测试代码：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const heapdump = require(&#x27;heapdump&#x27;)</span><br><span class="line">let leakObject = null</span><br><span class="line">let count = 0</span><br><span class="line"></span><br><span class="line">setInterval(function testMemoryLeak() &#123;</span><br><span class="line">  const originLeakObject = leakObject</span><br><span class="line">  const unused = function () &#123;</span><br><span class="line">    if (originLeakObject) &#123;</span><br><span class="line">      console.log(&#x27;originLeakObject&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  leakObject = &#123;</span><br><span class="line">    count: String(count++),</span><br><span class="line">    leakStr: new Array(1e7).join(&#x27;*&#x27;),</span><br><span class="line">    leakMethod: function () &#123;</span><br><span class="line">      console.log(&#x27;leakMessage&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, 1000)</span><br></pre></td></tr></table></figure>

<p>为什么这段程序会发生内存泄漏呢？首先我们要明白闭包的原理：<strong>同一个函数内部的闭包作用域只有一个，所有闭包共享。在执行函数的时候，如果遇到闭包，则会创建闭包作用域的内存空间，将该闭包所用到的局部变量添加进去，然后再遇到闭包时，会在之前创建好的作用域空间添加此闭包会用到而前闭包没用到的变量。函数结束时，会清除没有被闭包作用域引用的变量。</strong></p>
<p><strong>这段代码内存泄露原因是</strong>：在 testMemoryLeak 函数内有两个闭包：unused 和 leakMethod。unused 这个闭包引用了父作用域中的 originLeakObject 变量，如果没有后面的 leakMethod，则会在函数结束后被清除，闭包作用域也跟着被清除了。因为后面的 leakObject 是全局变量，即 leakMethod 是全局变量，它引用的闭包作用域（包含了 unused 所引用的 originLeakObject）不会释放。而随着 testMemoryLeak 不断的调用，originLeakObject 指向前一次的 leakObject，下次的 leakObject.leakMethod 又会引用之前的 originLeakObject，从而形成一个闭包引用链，而 leakStr 是一个大字符串，得不到释放，从而造成了内存泄漏。</p>
<p><strong>解决方法</strong>：在 testMemoryLeak 函数内部的最后添加 <code>originLeakObject = null</code> 即可。</p>
<p>运行测试代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node app</span><br></pre></td></tr></table></figure>

<p>然后先后执行<strong>两</strong>次：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kill -USR2 `pgrep -n node`</span><br></pre></td></tr></table></figure>

<p>在当前目录下生成了两个 heapsnapshot 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heapdump-100427359.61348.heapsnapshot</span><br><span class="line">heapdump-100438986.797085.heapsnapshot</span><br></pre></td></tr></table></figure>

<h2 id="2-2-2-Chrome-DevTools"><a href="#2-2-2-Chrome-DevTools" class="headerlink" title="2.2.2 Chrome DevTools"></a>2.2.2 Chrome DevTools</h2><p>我们使用 Chrome DevTools 来分析前面生成的 heapsnapshot 文件。调出 Chrome DevTools -&gt; Memory -&gt; Load，按顺序依次加载前面生成的 heapsnapshot 文件。单击第 2 个堆快照，在左上角有个下拉菜单，有如下 4 个选项：</p>
<ol>
<li>Summary：以构造函数名分类显示。</li>
<li>Comparison：比较多个快照之间的差异。</li>
<li>Containment：查看整个 GC 路径。</li>
<li>Statistics：以饼状图显示内存占用信息。</li>
</ol>
<p>通常我们只会用前两个选项；第 3 个选项一般用不到，因为在展开 Summary 和 Comparison 中的每一项时，都可以看到从 GC roots 到这个对象的路径；第 4 个选项只能看到内存占用比，如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/2.2.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/2.2.1.png" alt="img"></a></p>
<p>切换到 Summary 页，可以看到有如下 5 个属性：</p>
<ol>
<li>Contructor：构造函数名，例如 Object、Module、Socket，(array)、(string)、(regexp) 等加了括号的分别代表内置的 Array、String 和 Regexp。</li>
<li>Distance：到 GC roots （GC 根对象）的距离。GC 根对象在浏览器中一般是 window 对象，在 Node.js 中是 global 对象，距离越大，则说明引用越深。</li>
<li>Objects Count：对象个数。</li>
<li>Shallow Size：对象自身的大小，不包括它引用的对象。</li>
<li>Retained Size：对象自身的大小和它引用的对象的大小，即该对象被 GC 之后所能回收的内存大小。</li>
</ol>
<p><strong>小提示</strong>：一个对象的 Retained Size &#x3D; 该对象的 Shallow Size + 该对象支配树上其子节点的 Retained Size 之和。Shallow Size &#x3D;&#x3D; Retained Size 的有 (boolean)、(number)、(string)，它们无法引用其他值，并且始终是叶子节点。</p>
<p>单击 Retained Size 选择降序展示，可以看到 (closure) 这一项引用的内容达到 98%，继续展开如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/2.2.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/2.2.2.png" alt="img"></a></p>
<p><strong>可以看出</strong>：一个 leakStr 占了 8% 的内存，而 leakMethod 引用了 81% 的内存。对象保留树（Retainers，老版本 Chrome 中叫 Object’s retaining tree）展示了对象的 GC path，单击如上图中的 leakStr（Distance 是 13），Retainers 会自动展开，Distance 从 13 递减到 1。</p>
<p>继续展开 leakMethod，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/2.2.3.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/2.2.3.png" alt="img"></a></p>
<p><strong>可以看出</strong>：有一个 count&#x3D;”10” 的 originLeakObject 的 leakMethod 函数的 context（即上下文） 引用了一个 count&#x3D;”9” 的 originLeakObject 对象，而这个 originLeakObject 对象的 leakMethod 函数的 context 又引用了 count&#x3D;”8” 的 originLeakObject 对象，以此类推。而每个 originLeakObject 对象上都有一个大字符串 leakStr（占用 8% 的内存），从而造成内存泄漏，符合我们之前的推断。</p>
<p><strong>小提示</strong>：如果背景色是黄色的，则表示这个对象在 JavaScript 中还存在引用，所以可能没有被清除。如果背景色是红色的，则表示这个对象在 JavaScript 中不存在引用，但是依然存活在内存中，一般常见于 DOM 对象，它们存放的位置和 JavaScript 中的对象还是有不同的，在 Node.js 中很少遇见。</p>
<h2 id="2-2-3-对比快照"><a href="#2-2-3-对比快照" class="headerlink" title="2.2.3 对比快照"></a>2.2.3 对比快照</h2><p>切换到 Comparison 视图下，可以看到 #New、#Deleted、#Delta 等属性，+ 和 - 表示相对于比较的堆快照而言。我们对比第 2 个快照和第 1 个快照，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/2.2.4.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/2.2.4.png" alt="img"></a></p>
<p><strong>可以看出</strong>：(string) 增加了 10 个，每个 string 大小为 10000024 字节。</p>
<h2 id="2-2-4-参考链接"><a href="#2-2-4-参考链接" class="headerlink" title="2.2.4 参考链接"></a>2.2.4 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156">https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/56806069">https://www.zhihu.com/question/56806069</a></li>
<li><a target="_blank" rel="noopener" href="http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/">http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101">https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/04/07/2.1.1%20Core%20&%20Core%20Dump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/07/2.1.1%20Core%20&%20Core%20Dump/" class="post-title-link" itemprop="url">Node in Debugging, 2.1 Core & Core Dump</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-07 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-07T00:00:00-06:00">2019-04-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/04/07/2.1.1%20Core%20&%20Core%20Dump/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 2.1 Core & Core Dump" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<h2 id="2-1-1-Core-amp-Core-Dump"><a href="#2-1-1-Core-amp-Core-Dump" class="headerlink" title="2.1.1 Core &amp; Core Dump"></a>2.1.1 Core &amp; Core Dump</h2><p>在开始之前，我们先了解下什么是 Core 和 Core Dump。</p>
<p><strong>什么是 Core?</strong></p>
<blockquote>
<p>在使用半导体作为内存材料前，人类用线圈作为内存的材料，线圈就叫作 core ，用线圈做的内存就叫作 core memory。如今，半导体工业蓬勃发展，已经没有人用 core memory 了，不过在许多情况下，人们还是把记忆体叫作 core 。</p>
</blockquote>
<p><strong>什么是 Core Dump?</strong></p>
<blockquote>
<p>当程序运行的过程中异常终止或崩溃，操作系统会将程序当时的内存状态记录下来，保存在一个文件中，这种行为就叫作 Core Dump（中文翻译成 “核心转储”)。我们可以认为 Core Dump 是 “内存快照”，但实际上，除了内存信息之外，还有些关键的程序运行状态也会同时 dump 下来，例如寄存器信息（包括程序指针、栈指针等）、内存管理信息、其他处理器和操作系统状态和信息。Core Dump 对于编程人员诊断和调试程序是非常有帮助的，因为有些程序中的错误是很难重现的，例如指针异常，而 Core Dump 文件可以再现程序出错时的情景。</p>
</blockquote>
<p><strong>测试环境</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux nswbmw-VirtualBox 4.13.0-36-generic #40~16.04.1-Ubuntu SMP Fri Feb 16 23:25:58 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p><strong>开启 Core Dump</strong></p>
<p>在终端中输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -c</span><br></pre></td></tr></table></figure>

<p>查看允许 Core Dump 生成的文件的大小，如果是 0 则表示关闭了 Core Dump。使用以下命令开启 Core Dump，并且不限制 Core Dump 生成的文件大小：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -c unlimited</span><br></pre></td></tr></table></figure>

<p>以上命令只在当前终端环境下有效，如果想永久生效，就需要修改 &#x2F;etc&#x2F;security&#x2F;limits.conf 文件，如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/2.1.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/2.1.1.png" alt="img"></a></p>
<h2 id="2-1-2-gcore"><a href="#2-1-2-gcore" class="headerlink" title="2.1.2 gcore"></a>2.1.2 <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man1/gcore.1.html">gcore</a></h2><p>使用 gcore 可以不重启程序而 dump 出特定进程的 core 文件。gcore 使用方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcore [-o filename] pid</span><br></pre></td></tr></table></figure>

<p>在 Core Dump 时，默认会在执行 gcore 命令的目录生成 core.<PID> 文件。</p>
<h2 id="2-1-3-llnode"><a href="#2-1-3-llnode" class="headerlink" title="2.1.3 llnode"></a>2.1.3 llnode</h2><p>什么是 llnode？</p>
<blockquote>
<p>Node.js v4.x+ C++ plugin for <a target="_blank" rel="noopener" href="http://lldb.llvm.org/">LLDB</a> - a next generation, high-performance debugger.</p>
</blockquote>
<p>什么是 LLDB？</p>
<blockquote>
<p>LLDB is a next generation, high-performance debugger. It is built as a set of reusable components which highly leverage existing libraries in the larger LLVM Project, such as the Clang expression parser and LLVM disassembler.</p>
</blockquote>
<p>安装 llnode + lldb：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line"></span><br><span class="line"># Clone llnode</span><br><span class="line">$ git clone https://github.com/nodejs/llnode.git ~/llnode &amp;&amp; cd ~/llnode</span><br><span class="line"></span><br><span class="line"># Install lldb and headers</span><br><span class="line">$ sudo apt-get install lldb-4.0 liblldb-4.0-dev</span><br><span class="line"></span><br><span class="line"># Initialize GYP</span><br><span class="line">$ git clone https://github.com/bnoordhuis/gyp.git tools/gyp</span><br><span class="line"></span><br><span class="line"># Configure</span><br><span class="line">$ ./gyp_llnode -Dlldb_dir=/usr/lib/llvm-4.0/</span><br><span class="line"></span><br><span class="line"># Build</span><br><span class="line">$ make -C out/ -j9</span><br><span class="line"></span><br><span class="line"># Install</span><br><span class="line">$ sudo make install-linux</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：如果 <code>sudo apt-get update</code> 遇到这种错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W: GPG error: xxx stable Release: The following signatures couldn&#x27;t be verified because the public key is not available: NO_PUBKEY 6DA62DE462C7DA6D</span><br></pre></td></tr></table></figure>

<p>可以用以下命令解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6DA62DE462C7DA6D</span><br></pre></td></tr></table></figure>

<p>–recv-keys 后面跟的是前面报错提示的 PUBKEY。</p>
<h2 id="2-1-4-测试-Core-Dump"><a href="#2-1-4-测试-Core-Dump" class="headerlink" title="2.1.4 测试 Core Dump"></a>2.1.4 测试 Core Dump</h2><p>下面用一个典型的全局变量缓存导致的内存泄漏的例子来测试 llnode 的用法。代码如下：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const leaks = []</span><br><span class="line"></span><br><span class="line">function LeakingClass() &#123;</span><br><span class="line">  this.name = Math.random().toString(36)</span><br><span class="line">  this.age = Math.floor(Math.random() * 100)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setInterval(() =&gt; &#123;</span><br><span class="line">  for (let i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">    leaks.push(new LeakingClass)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  console.warn(&#x27;Leaks: %d&#x27;, leaks.length)</span><br><span class="line">&#125;, 1000)</span><br></pre></td></tr></table></figure>

<p>运行该程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node app.js</span><br></pre></td></tr></table></figure>

<p>等待几秒，打开另一个终端运行 gcore：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -c unlimited</span><br><span class="line">$ sudo gcore `pgrep -n node`</span><br></pre></td></tr></table></figure>

<p>生成 core.2763 文件。</p>
<h2 id="2-1-5-分析-Core-文件"><a href="#2-1-5-分析-Core-文件" class="headerlink" title="2.1.5 分析 Core 文件"></a>2.1.5 分析 Core 文件</h2><p>使用 lldb 加载刚才生成的 Core 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lldb-4.0 -c ./core.2763 </span><br><span class="line">(lldb) target create --core &quot;./core.2763&quot;</span><br><span class="line">Core file &#x27;/home/nswbmw/test/./core.2763&#x27; (x86_64) was loaded.</span><br><span class="line">(lldb) </span><br></pre></td></tr></table></figure>

<p>输入 v8 查看使用文档，有以下几条命令：</p>
<ul>
<li>bt</li>
<li>findjsinstances</li>
<li>findjsobjects</li>
<li>findrefs</li>
<li>inspect</li>
<li>nodeinfo</li>
<li>print</li>
<li>source</li>
</ul>
<p>运行 <code>v8 findjsobjects</code> 查看所有对象实例及总共占内存大小：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(lldb) v8 findjsobjects</span><br><span class="line"> Instances  Total Size Name</span><br><span class="line"> ---------- ---------- ----</span><br><span class="line">       ...</span><br><span class="line">       2100      84000 LeakingClass</span><br><span class="line">       8834      39792 (String)</span><br><span class="line"> ---------- ---------- </span><br><span class="line">      12088     181320 </span><br></pre></td></tr></table></figure>

<p><strong>可以看出</strong>：LeakingClass 有 2100 个实例，占内存 84000 byte。使用 <code>v8 findjsinstances</code> 查看所有 LeakingClass 实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) v8 findjsinstances LeakingClass</span><br><span class="line">0x000022aaa118ab19:&lt;Object: LeakingClass&gt;</span><br><span class="line">0x000022aaa118acf9:&lt;Object: LeakingClass&gt;</span><br><span class="line">0x000022aaa118ade1:&lt;Object: LeakingClass&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>使用 <code>v8 i</code> 检索实例的具体内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(lldb) v8 i 0x000022aaa118ab19</span><br><span class="line">0x000022aaa118ab19:&lt;Object: LeakingClass properties &#123;</span><br><span class="line">    .name=0x000022aaa118ab91:&lt;String: &quot;0.4tx00cipe8&quot;&gt;,</span><br><span class="line">    .age=&lt;Smi: 71&gt;&#125;&gt;</span><br><span class="line">(lldb) v8 i 0x000022aaa118acf9</span><br><span class="line">0x000022aaa118acf9:&lt;Object: LeakingClass properties &#123;</span><br><span class="line">    .name=0x000022aaa118ad71:&lt;String: &quot;0.48563ixsblf&quot;&gt;,</span><br><span class="line">    .age=&lt;Smi: 70&gt;&#125;&gt;</span><br><span class="line">(lldb) v8 i 0x000022aaa118ade1</span><br><span class="line">0x000022aaa118ade1:&lt;Object: LeakingClass properties &#123;</span><br><span class="line">    .name=0x000022aaa118ae59:&lt;String: &quot;0.w1nel407zj&quot;&gt;,</span><br><span class="line">    .age=&lt;Smi: 80&gt;&#125;&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到每个 LeakingClass 实例的 name 和 age 字段的值。</p>
<p>使用 <code>v8 findrefs</code> 查看引用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(lldb) v8 findrefs 0x000022aaa118ab19</span><br><span class="line">0x22aaa1189729: (Array)[0]=0x22aaa118ab19</span><br><span class="line">(lldb) v8 i 0x22aaa1189729</span><br><span class="line">0x000022aaa1189729:&lt;Array: length=2100 &#123;</span><br><span class="line">    [0]=0x000022aaa118ab19:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [1]=0x000022aaa118acf9:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [2]=0x000022aaa118ade1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [3]=0x000022aaa118aea1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [4]=0x000022aaa118af61:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [5]=0x000022aaa118b021:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [6]=0x000022aaa118b0e1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [7]=0x000022aaa118b1a1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [8]=0x000022aaa118b221:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [9]=0x000022aaa118b2a1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [10]=0x000022aaa118b321:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [11]=0x000022aaa118b3a1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [12]=0x000022aaa118b421:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [13]=0x000022aaa118b4a1:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [14]=0x000022aaa118b521:&lt;Object: LeakingClass&gt;,</span><br><span class="line">    [15]=0x000022aaa118b5a1:&lt;Object: LeakingClass&gt;&#125;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>可以看出</strong>：通过一个 LeakingClass 实例的内存地址，我们使用 <code>v8 findrefs</code> 找到了引用它的数组的内存地址，然后通过这个地址去检索数组，得到这个数组长度为 2100，每一项都是一个 LeakingClass 实例，这不就是我们代码中的 leaks 数组吗？</p>
<p><strong>小提示</strong>: <code>v8 i</code> 是 <code>v8 inspect</code> 的缩写，<code>v8 p</code> 是 <code>v8 print</code> 的缩写。</p>
<h2 id="2-1-6-–abort-on-uncaught-exception"><a href="#2-1-6-–abort-on-uncaught-exception" class="headerlink" title="2.1.6 –abort-on-uncaught-exception"></a>2.1.6 –abort-on-uncaught-exception</h2><p>在 Node.js 程序启动时添加 –abort-on-uncaught-exception 参数，当程序 crash 的时候，会自动 Core Dump，方便 “死后验尸”。</p>
<p>添加 –abort-on-uncaught-exception 参数，启动测试程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -c unlimited</span><br><span class="line">$ node --abort-on-uncaught-exception app.js</span><br></pre></td></tr></table></figure>

<p>启动另外一个终端运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kill -BUS `pgrep -n node`</span><br></pre></td></tr></table></figure>

<p>第 1 个终端会显示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Leaks: 100</span><br><span class="line">Leaks: 200</span><br><span class="line">Leaks: 300</span><br><span class="line">Leaks: 400</span><br><span class="line">Leaks: 500</span><br><span class="line">Leaks: 600</span><br><span class="line">Leaks: 700</span><br><span class="line">Leaks: 800</span><br><span class="line">Bus error (core dumped)</span><br></pre></td></tr></table></figure>

<p>调试步骤与上面一致：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ lldb-4.0 -c ./core</span><br><span class="line">(lldb) target create --core &quot;./core&quot;</span><br><span class="line">Core file &#x27;/home/nswbmw/test/./core&#x27; (x86_64) was loaded.</span><br><span class="line">(lldb) v8 findjsobjects</span><br><span class="line"> Instances  Total Size Name</span><br><span class="line"> ---------- ---------- ----</span><br><span class="line">        ...</span><br><span class="line">        800      32000 LeakingClass</span><br><span class="line">       7519      38512 (String)</span><br><span class="line"> ---------- ---------- </span><br><span class="line">       9440     126368</span><br></pre></td></tr></table></figure>

<h2 id="2-1-7-总结"><a href="#2-1-7-总结" class="headerlink" title="2.1.7 总结"></a>2.1.7 总结</h2><p>我们的测试代码很简单，没有引用任何第三方模块，如果项目较大且引用的模块较多，则 <code>v8 findjsobjects</code> 的结果将难以甄别，这时可以多次使用 gcore 进行 Core Dump，对比发现增长的对象，再进行诊断。</p>
<h2 id="2-1-8-参考链接"><a href="#2-1-8-参考链接" class="headerlink" title="2.1.8 参考链接"></a>2.1.8 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/Anker/p/6079580.html">http://www.cnblogs.com/Anker/p/6079580.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2016-07-13/llnode-nodejs-memory-leak-analysis.html">http://www.brendangregg.com/blog/2016-07-13/llnode-nodejs-memory-leak-analysis.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/04/01/1.3.1%20Tick%20Processor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/01/1.3.1%20Tick%20Processor/" class="post-title-link" itemprop="url">Node in Debugging, 1.3 Tick Processor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-01 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-01T00:00:00-06:00">2019-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/04/01/1.3.1%20Tick%20Processor/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 1.3 Tick Processor" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>V8 内置了一个性能分析工具——Tick Processor，可以记录 JavaScript&#x2F;C&#x2F;C++ 代码的堆栈信息，该功能默认是关闭的，可以通过添加命令行参数 <code>--prof</code> 开启。</p>
<h2 id="1-3-1-Tick-Processor"><a href="#1-3-1-Tick-Processor" class="headerlink" title="1.3.1 Tick Processor"></a>1.3.1 Tick Processor</h2><p>创建测试代码：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const crypto = require(&#x27;crypto&#x27;)</span><br><span class="line"></span><br><span class="line">function hash (password) &#123;</span><br><span class="line">  const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;)</span><br><span class="line">  const hash = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;)</span><br><span class="line">  return hash</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.time(&#x27;pbkdf2Sync&#x27;)</span><br><span class="line">for (let i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">  hash(&#x27;random_password&#x27;)</span><br><span class="line">&#125;</span><br><span class="line">console.timeEnd(&#x27;pbkdf2Sync&#x27;)</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node --prof app</span><br><span class="line">pbkdf2Sync: 1375.582ms</span><br></pre></td></tr></table></figure>

<p>可以看出，执行 100 次 hash 函数总共用了 1375.585ms，并且当前目录下多了一个 isolate-xxx-v8.log 文件，该文件记录了 V8 的性能日志，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v8-version,6,1,534,50,0</span><br><span class="line">shared-library,&quot;/usr/local/bin/node&quot;,0x100001800,0x100bbb69a,0</span><br><span class="line">...</span><br><span class="line">code-creation,Function,18,111912,0x37d07c7246a8,144,&quot;hash /Users/nswbmw/Desktop/test/app.js:3:15&quot;,0x37d07c7076d0,~</span><br><span class="line">code-creation,LazyCompile,18,111927,0x37d07c7246a8,144,&quot;hash /Users/nswbmw/Desktop/test/app.js:3:15&quot;,0x37d07c7076d0,~</span><br><span class="line">code-creation,Function,18,112058,0x37d07c725690,80,&quot;exports.pbkdf2Sync crypto.js:686:30&quot;,0x37d07c70cb58,~</span><br><span class="line">code-creation,LazyCompile,18,112074,0x37d07c725690,80,&quot;exports.pbkdf2Sync crypto.js:686:30&quot;,0x37d07c70cb58,~</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>早期我们需要借助 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/node-tick-processor">node-tick-processor</a> 这样的工具解析 v8.log，但 Node.js 在 v5.2.0 之后包含了 v8.log 处理器，添加命令行参数 <code>--prof-process</code> 开启。</p>
<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node --prof-process isolate-0x103000000-v8.log</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Statistical profiling result from isolate-0x103000000-v8.log, (1152 ticks, 44 unaccounted, 0 excluded).</span><br><span class="line"></span><br><span class="line"> [Shared libraries]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line"></span><br><span class="line"> [JavaScript]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line">      1    0.1%    0.1%  Function: ~Uint8Array native typedarray.js:158:31</span><br><span class="line">      1    0.1%    0.1%  Function: ~NativeModule.cache bootstrap_node.js:604:42</span><br><span class="line">      1    0.1%    0.1%  Function: ~Buffer.toString buffer.js:609:37</span><br><span class="line"></span><br><span class="line"> [C++]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line">   1023   88.8%   88.8%  T node::crypto::PBKDF2(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)</span><br><span class="line">     27    2.3%    2.3%  t node::(anonymous namespace)::ContextifyScript::New(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)</span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line"> [Summary]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line">      3    0.3%    0.3%  JavaScript</span><br><span class="line">   1105   95.9%   95.9%  C++</span><br><span class="line">      3    0.3%    0.3%  GC</span><br><span class="line">      0    0.0%          Shared libraries</span><br><span class="line">     44    3.8%          Unaccounted</span><br><span class="line"></span><br><span class="line"> [C++ entry points]:</span><br><span class="line">   ticks    cpp   total   name</span><br><span class="line">   1062   98.2%   92.2%  T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*)</span><br><span class="line">     13    1.2%    1.1%  T v8::internal::Runtime_CompileLazy(int, v8::internal::Object**, v8::internal::Isolate*)</span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line"> [Bottom up (heavy) profile]:</span><br><span class="line">  Note: percentage shows a share of a particular caller in the total</span><br><span class="line">  amount of its parent calls.</span><br><span class="line">  Callers occupying less than 1.0% are not shown.</span><br><span class="line"></span><br><span class="line">   ticks parent  name</span><br><span class="line">   1023   88.8%  T node::crypto::PBKDF2(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)</span><br><span class="line">   1023  100.0%    T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*)</span><br><span class="line">   1023  100.0%      Function: ~pbkdf2 crypto.js:691:16</span><br><span class="line">   1023  100.0%        Function: ~exports.pbkdf2Sync crypto.js:686:30</span><br><span class="line">   1023  100.0%          Function: ~hash /Users/nswbmw/Desktop/test/app.js:3:15</span><br><span class="line">   1023  100.0%            Function: ~&lt;anonymous&gt; /Users/nswbmw/Desktop/test/app.js:1:11</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>打印结果包含六部分：Shared libraries、JavaScript、C++、Summary、C++ entry points 和 Bottom up (heavy) profile。[JavaScript] 部分列出了 JavaScript 代码执行所占用的 CPU ticks（CPU 时钟周期），[C++] 部分列出了 C++ 代码执行所占用的 CPU ticks，[Summary] 列出了各个部分的占比，[Bottom up] 列出了所有 CPU 占用时间从大到小的函数及堆栈信息，小于 1% 的则不予显示。</p>
<p><strong>可以看出</strong>：88.8%的 CPU 时间都花在了 crypto.js 文件的 pbkdf2Sync 函数上，该函数在 app.js 第 3 行被调用，即我们的 hash 函数。</p>
<p><strong>解决方法</strong>：将同步的 pbkdf2Sync 改为异步的 pbkdf2。修改代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const crypto = require(&#x27;crypto&#x27;)</span><br><span class="line"></span><br><span class="line">function hash (password, cb) &#123;</span><br><span class="line">  const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;)</span><br><span class="line">  crypto.pbkdf2(password, salt, 10000, 64, &#x27;sha512&#x27;, cb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let count = 0</span><br><span class="line">console.time(&#x27;pbkdf2&#x27;)</span><br><span class="line">for (let i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">  hash(&#x27;random_password&#x27;, () =&gt; &#123;</span><br><span class="line">    count++</span><br><span class="line">    if (count === 100) &#123;</span><br><span class="line">      console.timeEnd(&#x27;pbkdf2&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node --prof app</span><br><span class="line">pbkdf2: 656.332ms</span><br></pre></td></tr></table></figure>

<p>可以看出，程序运行了 656.332ms，相比较于之前的 1375.585ms，性能提升了 1 倍。我们继续看下 v8.log 的分析结果，运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ node --prof-process isolate-0x102802400-v8.log</span><br><span class="line">Statistical profiling result from isolate-0x103001a00-v8.log, (198 ticks, 19 unaccounted, 0 excluded).</span><br><span class="line"></span><br><span class="line"> [Shared libraries]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line"></span><br><span class="line"> [JavaScript]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line">      1    0.5%    0.5%  StoreIC: A store IC from the snapshot</span><br><span class="line">      1    0.5%    0.5%  Function: ~set native collection.js:149:4</span><br><span class="line">      1    0.5%    0.5%  Function: ~pbkdf2 crypto.js:691:16</span><br><span class="line">      1    0.5%    0.5%  Function: ~inherits util.js:962:18</span><br><span class="line">      1    0.5%    0.5%  Builtin: ArrayIteratorPrototypeNext</span><br><span class="line"></span><br><span class="line"> [C++]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line">     83   41.9%   41.9%  T ___kdebug_trace_string</span><br><span class="line">     31   15.7%   15.7%  t node::(anonymous namespace)::ContextifyScript::New(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)</span><br><span class="line">     14    7.1%    7.1%  T ___pthread_sigmask</span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line"> [Summary]:</span><br><span class="line">   ticks  total  nonlib   name</span><br><span class="line">      5    2.5%    2.5%  JavaScript</span><br><span class="line">    174   87.9%   87.9%  C++</span><br><span class="line">      3    1.5%    1.5%  GC</span><br><span class="line">      0    0.0%          Shared libraries</span><br><span class="line">     19    9.6%          Unaccounted</span><br><span class="line"></span><br><span class="line"> [C++ entry points]:</span><br><span class="line">   ticks    cpp   total   name</span><br><span class="line">     41   60.3%   20.7%  T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*)</span><br><span class="line">     17   25.0%    8.6%  T v8::internal::Runtime_CompileLazy(int, v8::internal::Object**, v8::internal::Isolate*)</span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line"> [Bottom up (heavy) profile]:</span><br><span class="line">  Note: percentage shows a share of a particular caller in the total</span><br><span class="line">  amount of its parent calls.</span><br><span class="line">  Callers occupying less than 1.0% are not shown.</span><br><span class="line"></span><br><span class="line">   ticks parent  name</span><br><span class="line">     83   41.9%  T ___kdebug_trace_string</span><br><span class="line"></span><br><span class="line">     31   15.7%  t node::(anonymous namespace)::ContextifyScript::New(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)</span><br><span class="line">     31  100.0%    T v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*)</span><br><span class="line">     31  100.0%      Function: ~runInThisContext bootstrap_node.js:495:28</span><br><span class="line">     31  100.0%        Function: ~NativeModule.compile bootstrap_node.js:584:44</span><br><span class="line">     31  100.0%          Function: ~NativeModule.require bootstrap_node.js:516:34</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>

<p>可以看出，[Bottom up] 没有很多 ticks，而且不再有 pbkdf2 这种堆栈信息。</p>
<h2 id="1-3-2-Web-UI"><a href="#1-3-2-Web-UI" class="headerlink" title="1.3.2 Web UI"></a>1.3.2 Web UI</h2><p>V8 还提供了一个 Web 可视化工具来查看生成的 v8 日志。首先，将代码还原到使用 pbkdf2Sync 的版本，运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ node --prof app # 生成 isolate-0x103000000-v8.log</span><br><span class="line">$ node --prof-process --preprocess isolate-0x103000000-v8.log &gt; v8.json # 格式化成 JSON 文件</span><br><span class="line">$ git clone https://github.com/v8/v8.git # 克隆 v8 仓库</span><br><span class="line">$ open v8/tools/profview/index.html # 打开 V8 profiling log processor</span><br></pre></td></tr></table></figure>

<p>点击 “选择文件”，选择刚才生成的 v8.json 文件，点击 “Bottom up” 视图，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.3.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.3.1.png" alt="img"></a></p>
<p>有以下两点需要解释：</p>
<ol>
<li>图中的上半部分展示了 CPU 的 timeline，X 轴代表时间的流逝，Y 轴代表当前时间点不同部分占用 CPU 的比例，可以在 timeline 图表上单击左键不放，然后拖动，选择时间区间。</li>
<li>图中的下半部分展示了当前时间段内 CPU 占用比从大到小降序排列的函数，展开可查看堆栈信息。不同的颜色代表了不同的部分，点击任意一个函数，timeline 底部会展示该函数的执行时间分布。</li>
</ol>
<h2 id="1-3-3-参考链接"><a href="#1-3-3-参考链接" class="headerlink" title="1.3.3 参考链接"></a>1.3.3 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/v8/v8/wiki/V8-Profiler">https://github.com/v8/v8/wiki/V8-Profiler</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.ghaiklor.com/profiling-nodejs-applications-1609b77afe4e">https://blog.ghaiklor.com/profiling-nodejs-applications-1609b77afe4e</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/23934451/how-to-read-nodejs-internal-profiler-tick-processor-output">https://stackoverflow.com/questions/23934451/how-to-read-nodejs-internal-profiler-tick-processor-output</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/03/23/1.2.1%20%E4%BD%BF%E7%94%A8%20v8-profiler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/23/1.2.1%20%E4%BD%BF%E7%94%A8%20v8-profiler/" class="post-title-link" itemprop="url">Node in Debugging, 1.2 How to use v8-profiler</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-03-23 00:00:00" itemprop="dateCreated datePublished" datetime="2019-03-23T00:00:00-06:00">2019-03-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/03/23/1.2.1%20%E4%BD%BF%E7%94%A8%20v8-profiler/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging, 1.2 How to use v8-profiler" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>我们知道 Node.js 是基于 V8 引擎的，V8 暴露了一些 profiler API，我们可以通过 <a target="_blank" rel="noopener" href="https://github.com/node-inspector/v8-profiler">v8-profiler</a> 收集一些运行时数据（例如：CPU 和内存）。本节将介绍如何使用 v8-profiler 分析 CPU 的使用情况。</p>
<h2 id="1-2-1-使用-v8-profiler"><a href="#1-2-1-使用-v8-profiler" class="headerlink" title="1.2.1 使用 v8-profiler"></a>1.2.1 使用 v8-profiler</h2><p>创建测试代码：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;)</span><br><span class="line">const crypto = require(&#x27;crypto&#x27;)</span><br><span class="line">const Bluebird = require(&#x27;bluebird&#x27;)</span><br><span class="line">const profiler = require(&#x27;v8-profiler&#x27;)</span><br><span class="line">const Paloma = require(&#x27;paloma&#x27;)</span><br><span class="line">const app = new Paloma()</span><br><span class="line"></span><br><span class="line">app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/encrypt&#x27;, controller: function encryptRouter (ctx) &#123;</span><br><span class="line">  const password = ctx.query.password || &#x27;test&#x27;</span><br><span class="line">  const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;)</span><br><span class="line">  const encryptedPassword = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;)</span><br><span class="line"></span><br><span class="line">  ctx.body = encryptedPassword</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/cpuprofile&#x27;, async controller (ctx) &#123;</span><br><span class="line">   //Start Profiling</span><br><span class="line">   profiler.startProfiling(&#x27;CPU profile&#x27;)</span><br><span class="line">   await Bluebird.delay(30000)</span><br><span class="line">   //Stop Profiling after 30s</span><br><span class="line">   const profile = profiler.stopProfiling()</span><br><span class="line">   profile.export()</span><br><span class="line">     .pipe(fs.createWriteStream(`cpuprofile-$&#123;Date.now()&#125;.cpuprofile`))</span><br><span class="line">     .on(&#x27;finish&#x27;, () =&gt; profile.delete())</span><br><span class="line">   ctx.status = 204</span><br><span class="line">&#125;&#125;)</span><br><span class="line"> </span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure>

<p><code>GET /encrypt</code> 有一个 CPU 密集型的计算函数 crypto.pbkdf2Sync，<code>GET /cpuprofile</code> 用来收集 30s 的 V8 log 然后将其 dump 到一个文件中。</p>
<p>运行该程序，打开两个终端窗口。一个终端运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:3000/cpuprofile</span><br></pre></td></tr></table></figure>

<p>来触发 CPU profiling，然后另一个终端立即运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -c 20 -n 2000 &quot;http://localhost:3000/encrypt?password=123456&quot;</span><br></pre></td></tr></table></figure>

<p>来触发 CPU 密集计算。</p>
<p>最后生成 cpuprofile-xxx.cpuprofile 文件，该文件的内容其实就是一个大的 JSON 对象，大体如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;typeId&quot;: &quot;CPU&quot;,</span><br><span class="line">  &quot;uid&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;CPU profile&quot;,</span><br><span class="line">  &quot;head&quot;:</span><br><span class="line">   &#123; &quot;functionName&quot;: &quot;(root)&quot;,</span><br><span class="line">     &quot;url&quot;: &quot;&quot;,</span><br><span class="line">     &quot;lineNumber&quot;: 0,</span><br><span class="line">     &quot;callUID&quot;: 154,</span><br><span class="line">     &quot;bailoutReason&quot;: &quot;&quot;,</span><br><span class="line">     &quot;id&quot;: 1,</span><br><span class="line">     &quot;scriptId&quot;: 0,</span><br><span class="line">     &quot;hitCount&quot;: 0,</span><br><span class="line">     &quot;children&quot;: [ ... ] &#125;,</span><br><span class="line">  &quot;startTime&quot;: 276245,</span><br><span class="line">  &quot;endTime&quot;: 276306,</span><br><span class="line">  &quot;samples&quot;: [ ... ],</span><br><span class="line">  &quot;timestamps&quot;: [ ... ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 JSON 对象记录了函数调用栈、路径、时间戳和一些其他信息，samples 节点数组与 timestamps 节点数组中的时间戳是一一对应的，并且 samples 节点数组中的每一个值其实对应了 head 节点的深度优先遍历 ID。这里我们不深究每个字段的含义，先来看看如何可视化这些数据。</p>
<h2 id="1-2-2-方法-1——Chrome-DevTools"><a href="#1-2-2-方法-1——Chrome-DevTools" class="headerlink" title="1.2.2 方法 1——Chrome DevTools"></a>1.2.2 方法 1——Chrome DevTools</h2><p>Chrome 自带了分析 CPU profile 日志的工具。打开 Chrome -&gt; 调出开发者工具（DevTools） -&gt; 单击右上角三个点的按钮 -&gt; More tools -&gt; JavaScript Profiler -&gt; Load，加载刚才生成的 cpuprofile 文件。左上角的下拉菜单可以选择如下三种模式：</p>
<ol>
<li>Chart：显示按时间顺序排列的火焰图。</li>
<li>Heavy (Bottom Up)：按照函数对性能的影响排列，同时可以检查函数的调用路径。</li>
<li>Tree (Top Down)：显示调用结构的总体状况，从调用堆栈的顶端开始。</li>
</ol>
<p>这里我们选择 Tree (Top Down) 模式，按 Total Time 降序排列。可以看到有如下三列：</p>
<ol>
<li>Self Time：函数调用所耗费的时间，仅包含函数本身的声明，不包含任何子函数的执行时间。</li>
<li>Total Time：函数调用所耗费的总时间，包含函数本身的声明及所有子函数执行时间。即：父函数的 Total Time &#x3D; 父函数的 Self Time + 所有子函数的 Total Time。</li>
<li>Function：函数名及路径，可展开查看子函数。</li>
</ol>
<p>我们不断地展开，并定位到了 encryptRouter，如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.2.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.2.1.png" alt="img"></a></p>
<p><strong>可以看出</strong>：我们定位到了 encryptRouter 这个路由，并且这个路由中 exports.pbkdf2Sync 占据了绝大部分 CPU 时间。</p>
<h2 id="1-2-3-方法-2——火焰图"><a href="#1-2-3-方法-2——火焰图" class="headerlink" title="1.2.3 方法 2——火焰图"></a>1.2.3 方法 2——火焰图</h2><p>我们也可以用火焰图来展示 cpuprofile 数据。首先全局安装 flamegraph 模块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i flamegraph -g</span><br></pre></td></tr></table></figure>

<p>运行以下命令将 cpuprofile 文件生成 svg 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flamegraph -t cpuprofile -f cpuprofile-xxx.cpuprofile -o cpuprofile.svg</span><br></pre></td></tr></table></figure>

<p>用浏览器打开 cpuprofile.svg，如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.2.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.2.2.png" alt="img"></a></p>
<p><strong>可以看出</strong>：我们定位到了 app.js 的第 8 行，即 encryptRouter 这个路由，并且这个路由中 exports.pbkdf2Sync 占据了绝大部分 CPU 时间。</p>
<h2 id="1-2-4-方法-3——v8-analytics"><a href="#1-2-4-方法-3——v8-analytics" class="headerlink" title="1.2.4 方法 3——v8-analytics"></a>1.2.4 方法 3——v8-analytics</h2><p><a target="_blank" rel="noopener" href="https://github.com/hyj1991/v8-analytics">v8-analytics</a> 是社区开源的一个解析 v8-profiler 和 heapdump 等模块生成的 CPU 和 heap-memory 日志的工具。它提供以下功能：</p>
<ul>
<li>将 V8 引擎逆优化或者优化失败的函数标红展示，并展示优化失败的原因。</li>
<li>在函数执行时长超过预期时标红展示。</li>
<li>展示当前项目中可疑的内存泄漏点。</li>
</ul>
<p>我们以上述第 2 个功能为例，使用 v8-analytics 分析 CPU 的使用情况。</p>
<p>首先，全局安装 v8-analytics：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i v8-analytics -g</span><br></pre></td></tr></table></figure>

<p>使用以下命令查看执行时间大于 200ms 的函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ va timeout cpuprofile-xxx.cpuprofile 200 --only</span><br></pre></td></tr></table></figure>

<p>结果截图如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.2.3.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.2.3.png" alt="img"></a></p>
<p><strong>可以看出</strong>：我们依然能够定位到 encryptRouter 和 exports.pbkdf2Sync。</p>
<h2 id="1-2-5-参考链接"><a href="#1-2-5-参考链接" class="headerlink" title="1.2.5 参考链接"></a>1.2.5 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/web/tools/chrome-devtools/rendering-tools/js-execution">https://developers.google.com/web/tools/chrome-devtools/rendering-tools/js-execution</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ebaytechblog.com/2016/06/15/igniting-node-js-flames/">http://www.ebaytechblog.com/2016/06/15/igniting-node-js-flames/</a></li>
<li><a target="_blank" rel="noopener" href="https://cnodejs.org/topic/58b562f97872ea0864fee1a7">https://cnodejs.org/topic/58b562f97872ea0864fee1a7</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hyj1991/v8-analytics/blob/master/README_ZH.md">https://github.com/hyj1991/v8-analytics/blob/master/README_ZH.md</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2019/03/21/1.1.1%20perf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/03/21/1.1.1%20perf/" class="post-title-link" itemprop="url">Node in Debugging 1.1 Perf + FameGraph</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-03-21 00:00:00" itemprop="dateCreated datePublished" datetime="2019-03-21T00:00:00-06:00">2019-03-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Node-in-Debugging/" itemprop="url" rel="index"><span itemprop="name">Node in Debugging</span></a>
        </span>
    </span>

  
    <span id="/2019/03/21/1.1.1%20perf/" class="post-meta-item leancloud_visitors" data-flag-title="Node in Debugging 1.1 Perf + FameGraph" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p>
<p>当程序出现性能瓶颈时，我们通常通过表象（比如请求某个接口时 CPU 使用率飙涨）然后结合代码去推测可能出问题的地方，却不知道问题到底是什么引起的。如果有个一可视化的工具直观地展现程序的性能瓶颈就好了，幸好 <a target="_blank" rel="noopener" href="http://www.brendangregg.com/">Brendan D. Gregg</a> 发明了火焰图。</p>
<p><a target="_blank" rel="noopener" href="http://www.brendangregg.com/flamegraphs.html">火焰图</a>（Flame Graph）看起来就像一团跳动的火焰，因此得名。火焰图可以将 CPU 的使用情况可视化，使我们直观地了解到程序的性能瓶颈，通常要结合操作系统的性能分析工具（profiling tracer）使用，常见的操作系统的性能分析工具如下：</p>
<ul>
<li>Linux：perf, eBPF, SystemTap, and ktap。</li>
<li>Solaris, illumos, FreeBSD：DTrace。</li>
<li>Mac OS X：DTrace and Instruments。</li>
<li>Windows：Xperf.exe。</li>
</ul>
<h2 id="1-1-1-perf"><a href="#1-1-1-perf" class="headerlink" title="1.1.1 perf"></a>1.1.1 perf</h2><p><a target="_blank" rel="noopener" href="http://www.brendangregg.com/linuxperf.html">perf_events</a>（简称 perf）是 Linux Kernal 自带的系统性能分析工具，能够进行函数级与指令级的热点查找。它基于事件采样原理，以性能事件为基础，支持针对处理器相关性能指标与操作系统相关性能指标的性能剖析，常用于查找性能瓶颈及定位热点代码。</p>
<p>测试机器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux nswbmw-VirtualBox 4.10.0-28-generic #32~16.04.2-Ubuntu SMP Thu Jul 20 10:19:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：非 Linux 用户需要用虚拟机安装 Ubuntu 16.04 和 <a href="mailto:&#110;&#x6f;&#x64;&#101;&#64;&#x38;&#x2e;&#x39;&#46;&#52;">&#110;&#x6f;&#x64;&#101;&#64;&#x38;&#x2e;&#x39;&#46;&#52;</a> 后进行后面的操作。</p>
<p>安装 perf：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install linux-tools-common</span><br><span class="line">$ perf # 根据提示安装对应的内核版本的 tools, 如下</span><br><span class="line">$ sudo apt install linux-tools-4.10.0-28-generic linux-cloud-tools-4.10.0-28-generic</span><br></pre></td></tr></table></figure>

<p>创建测试目录 ~&#x2F;test 和测试代码：</p>
<p><strong>app.js</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const crypto = require(&#x27;crypto&#x27;)</span><br><span class="line">const Paloma = require(&#x27;paloma&#x27;)</span><br><span class="line">const app = new Paloma()</span><br><span class="line">const users = &#123;&#125;</span><br><span class="line"></span><br><span class="line">app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/newUser&#x27;, controller (ctx) &#123;</span><br><span class="line">  const username = ctx.query.username || &#x27;test&#x27;</span><br><span class="line">  const password = ctx.query.password || &#x27;test&#x27;</span><br><span class="line"></span><br><span class="line">  const salt = crypto.randomBytes(128).toString(&#x27;base64&#x27;)</span><br><span class="line">  const hash = crypto.pbkdf2Sync(password, salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;)</span><br><span class="line"></span><br><span class="line">  users[username] = &#123; salt, hash &#125;</span><br><span class="line"></span><br><span class="line">  ctx.status = 204</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/auth&#x27;, controller (ctx) &#123;</span><br><span class="line">  const username = ctx.query.username || &#x27;test&#x27;</span><br><span class="line">  const password = ctx.query.password || &#x27;test&#x27;</span><br><span class="line"></span><br><span class="line">  if (!users[username]) &#123;</span><br><span class="line">    ctx.throw(400)</span><br><span class="line">  &#125;</span><br><span class="line">  const hash = crypto.pbkdf2Sync(password, users[username].salt, 10000, 64, &#x27;sha512&#x27;).toString(&#x27;hex&#x27;)</span><br><span class="line"></span><br><span class="line">  if (users[username].hash === hash) &#123;</span><br><span class="line">    ctx.status = 204</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    ctx.throw(403)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#125;)</span><br><span class="line"> </span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure>

<p>添加 –perf_basic_prof（或者 –perf-basic-prof）参数运行此程序，会对应生成一个 &#x2F;tmp&#x2F;perf-<PID>.map 的文件。命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ node --perf_basic_prof app.js &amp;</span><br><span class="line">[1] 3590</span><br><span class="line">$ tail /tmp/perf-3590.map</span><br><span class="line">51b87a7b93e 18 Function:~emitListeningNT net.js:1375</span><br><span class="line">51b87a7b93e 18 LazyCompile:~emitListeningNT net.js:1375</span><br><span class="line">51b87a7bad6 39 Function:~emitAfterScript async_hooks.js:443</span><br><span class="line">51b87a7bad6 39 LazyCompile:~emitAfterScript async_hooks.js:443</span><br><span class="line">51b87a7bcbe 77 Function:~tickDone internal/process/next_tick.js:88</span><br><span class="line">51b87a7bcbe 77 LazyCompile:~tickDone internal/process/next_tick.js:88</span><br><span class="line">51b87a7bf36 12 Function:~clear internal/process/next_tick.js:42</span><br><span class="line">51b87a7bf36 12 LazyCompile:~clear internal/process/next_tick.js:42</span><br><span class="line">51b87a7c126 b8 Function:~emitPendingUnhandledRejections internal/process/promises.js:86</span><br><span class="line">51b87a7c126 b8 LazyCompile:~emitPendingUnhandledRejections internal/process/promises.js:86</span><br></pre></td></tr></table></figure>

<p><strong>map 文件内容三列依次为</strong>：16进制的符号地址（symbol addresses）、大小（sizes）和符号名（symbol names）。perf 会尝试查找 &#x2F;tmp&#x2F;perf-<PID>.map 文件，用来做符号转换，即把 16 进制的符号地址转换成人能读懂的符号名。</p>
<p><strong>注意</strong>：使用 –perf_basic_prof_only_functions 参数也可以，但经尝试后发现生成的火焰图信息不全（不全的地方显示 [perf-<PID>.map]），所以这里使用 –perf_basic_prof。但是，使用 –perf_basic_prof 有个缺点，就是会导致 map 文件一直增大，这是由于符号（symbols）地址不断变换导致的，用 –perf_basic_prof_only_functions 可以缓解这个问题。关于如何取舍，还请读者自行尝试。</p>
<p>接下来 clone 用来生成火焰图的工具：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone http://github.com/brendangregg/FlameGraph ~/FlameGraph</span><br></pre></td></tr></table></figure>

<p>我们先用 ab 压测：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl &quot;http://localhost:3000/newUser?username=admin&amp;password=123456&quot;</span><br><span class="line">$ ab -k -c 10 -n 2000 &quot;http://localhost:3000/auth?username=admin&amp;password=123456&quot;</span><br></pre></td></tr></table></figure>

<p>新开另一个终端，在 ab 开始压测后立即运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo perf record -F 99 -p 3590 -g -- sleep 30</span><br><span class="line">$ sudo chown root /tmp/perf-3590.map</span><br><span class="line">$ sudo perf script &gt; perf.stacks</span><br><span class="line">$ ~/FlameGraph/stackcollapse-perf.pl --kernel &lt; ~/perf.stacks | ~/FlameGraph/flamegraph.pl --color=js --hash&gt; ~/flamegraph.svg</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：第 1 次生成的 svg 可能不太准确，最好重复几次以上步骤，使用第 2 次及以后生成的 flamegraph.svg。</p>
<p>有几点需要解释一下：</p>
<ul>
<li><p>perf record</p>
<ul>
<li>-F 指定了采样频率 99Hz（即每秒 99 次，如果 99 次都返回同一个函数名，那就说明 CPU 在这一秒钟都在执行同一个函数，可能存在性能问题）。</li>
<li>-p 指定进程的 pid。</li>
<li>-g 启用 call-graph 记录。</li>
<li>– sleep 30 指定记录 30s。</li>
</ul>
</li>
<li><p>sudo chown root &#x2F;tmp&#x2F;perf-3009.map，将 map 文件更改为 root 权限，否则会报如下错误：</p>
<blockquote>
<p>File &#x2F;tmp&#x2F;perf-PID.map not owned by current user or root, ignoring it (use -f to override). Failed to open &#x2F;tmp&#x2F;perf-PID.map, continuing without symbols</p>
</blockquote>
</li>
<li><p>perf record 会将记录的信息保存到当前执行目录的 perf.data 文件中，然后使用 perf script 读取 perf.data 的 trace 信息写入 perf.stacks。</p>
</li>
<li><p>–color&#x3D;js 指定生成针对 JavaScript 配色的 svg，即：</p>
<ul>
<li>green：JavaScript。</li>
<li>blue：Builtin。</li>
<li>yellow：C++。</li>
<li>red：System（native user-level, and kernel）。</li>
</ul>
</li>
</ul>
<p>ab 压测用了 30s 左右，用浏览器打开 flamegraph.svg，截取关键的部分如下图所示： <a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.1.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.1.1.png" alt="img"></a></p>
<h2 id="1-1-2-理解火焰图"><a href="#1-1-2-理解火焰图" class="headerlink" title="1.1.2 理解火焰图"></a>1.1.2 理解火焰图</h2><p>火焰图含义：</p>
<ul>
<li>每一个小块代表了一个函数在栈中的位置（即一个栈帧）。</li>
<li>Y 轴代表栈的深度（栈上的帧数），顶端的小块显示了占据 CPU 的函数。每个小块的下面是它的祖先（即父函数）。</li>
<li>X 轴代表总的样例群体。它不像绝大多数图表那样从左到右表示时间的流逝，其左右顺序没有特殊含义，仅仅按照字母表的顺序排列。</li>
<li>小块的宽度代表 CPU 的使用时间，或者说相对于父函数而言使用 CPU 的比例（基于所有样例），越宽则代表占用 CPU 的时间越长，或者使用 CPU 很频繁。</li>
<li>如果采取多线程并发运行取样，则取样数量会超过运行时间。</li>
</ul>
<p><strong>从上图可以看出</strong>：最上面的绿色小块（即 JavaScript 代码）指向 test&#x2F;app.js 第 18 行，即 <code>GET /auth</code> 这个路由。再往上看，黄色的小块（即 C++ 代码） node::crypto::PBKDF2 占用了大量的 CPU 时间。</p>
<p><strong>解决方法</strong>：将同步改为异步，即将 crypto.pbkdf2Sync 改为 crypto.pbkdf2。修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">app.route(&#123; method: &#x27;GET&#x27;, path: &#x27;/auth&#x27;, async controller (ctx) &#123;</span><br><span class="line">  const username = ctx.query.username || &#x27;test&#x27;</span><br><span class="line">  const password = ctx.query.password || &#x27;test&#x27;</span><br><span class="line"></span><br><span class="line">  if (!users[username]) &#123;</span><br><span class="line">    ctx.throw(400)</span><br><span class="line">  &#125;</span><br><span class="line">  const hash = await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    crypto.pbkdf2(password, users[username].salt, 10000, 64, &#x27;sha512&#x27;, (err, derivedKey) =&gt; &#123;</span><br><span class="line">      if (err) &#123;</span><br><span class="line">        return reject(err)</span><br><span class="line">      &#125;</span><br><span class="line">      resolve(derivedKey.toString(&#x27;hex&#x27;))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  if (users[username].hash === hash) &#123;</span><br><span class="line">    ctx.status = 204</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    ctx.throw(403)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>用 ab 重新压测，结果用了 16s。重新生成的火焰图如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.1.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.1.2.png" alt="img"></a></p>
<p><strong>可以看出</strong>：只有在左侧极窄的绿色小块可以看到 JavaScript 代码，红色的部分我们不关心也无法优化。那么，为什么异步比同步的 QPS 要高呢？原因是 Node.js 底层的 libuv 用了多个线程进行计算，这里就不再深入介绍了。</p>
<p>svg 火焰图的其他小技巧如下：</p>
<ol>
<li>单击任意一个小块即可展开，即被单击的小块宽度变宽，它的子函数也按比例变宽，方便查看。</li>
<li>可单击 svg 右上角的 search 按钮进行搜索，被搜索的关键词会高亮显示，在有目的地查找某个函数时比较有用。</li>
</ol>
<h2 id="1-1-3-红蓝差分火焰图"><a href="#1-1-3-红蓝差分火焰图" class="headerlink" title="1.1.3 红蓝差分火焰图"></a>1.1.3 红蓝差分火焰图</h2><p>虽然我们有了火焰图，但要处理性能回退问题，还需要在修改代码前后的火焰图之间，不断切换和对比，来找出问题所在，很不方便。于是 <a target="_blank" rel="noopener" href="http://www.brendangregg.com/index.html">Brendan D. Gregg</a> 又发明了红蓝差分火焰图（Red&#x2F;Blue Differential Flame Graphs）。</p>
<p><strong>如下所示</strong>：红色表示增长，蓝色表示衰减。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/1.1.3.jpg"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/1.1.3.jpg" alt="img"></a></p>
<p>红蓝差分火焰图的工作原理如下：</p>
<ol>
<li>抓取修改前的栈 profile1 文件。</li>
<li>抓取修改后的栈 profile2 文件。</li>
<li>使用 profile2 来生成火焰图，这样栈帧的宽度就是以 profile2 文件为基准的。</li>
<li>使用 profile2 - profile1 的差异来对火焰图重新上色。上色的原则是：如果栈帧在 profile2 中出现出现的次数更多，则标为红色，否则标为蓝色。色彩是根据修改前后的差异来填充的。</li>
</ol>
<p>这样，通过红蓝差分火焰图，我们就可以清楚地看到系统性能的差异之处。</p>
<p>生成红蓝差分火焰图的流程如下：</p>
<ol>
<li><p>修改代码前运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo perf record -F 99 -p &lt;PID&gt; -g -- sleep 30</span><br><span class="line">$ sudo chown root /tmp/perf-&lt;PID&gt;.map</span><br><span class="line">$ sudo perf script &gt; perf_before.stacks</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改代码后运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo perf record -F 99 -p &lt;PID&gt; -g -- sleep 30</span><br><span class="line">$ sudo chown root /tmp/perf-&lt;PID&gt;.map</span><br><span class="line">$ sudo perf script &gt; perf_after.stacks</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 profile 文件进行折叠（fold），然后生成差分火焰图：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ~/FlameGraph/stackcollapse-perf.pl ~/perf_before.stacks &gt; perf_before.folded</span><br><span class="line">$ ~/FlameGraph/stackcollapse-perf.pl ~/perf_after.stacks &gt; perf_after.folded</span><br><span class="line">$ ./FlameGraph/difffolded.pl perf_before.folded perf_after.folded | ./FlameGraph/flamegraph.pl &gt; flamegraph_diff.svg</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>如上缺点是</strong>：如果一个代码执行路径完全消失了，那么在火焰图中就找不到地方来标注蓝色，我们只能看到当前的 CPU 使用情况，却不知道为什么会变成这样。</p>
<p>一种解决办法是：生成一个相反的差分火焰图，即基于 profile1 生成 profile1 - profile2 的差分火焰图。对应命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./FlameGraph/difffolded.pl perf_after.folded perf_before.folded | ./FlameGraph/flamegraph.pl --negate &gt; flamegraph_diff2.svg</span><br></pre></td></tr></table></figure>

<p>其中，–negate 用于颠倒红&#x2F;蓝配色。最终我们得到：</p>
<ul>
<li>flamegraph_diff.svg：宽度是以修改前的 profile 文件为基准，颜色表明将要发生的情况。</li>
<li>flamegraph_diff2.svg：宽度是以修改后的 profile 文件为基准，颜色表明已经发生的情况。</li>
</ul>
<p>总之，红蓝差分火焰图可能只在代码变化不大的情况下使用时效果明显，在代码变化较大的情况下使用时效果可能就不明显了。</p>
<h2 id="1-1-4-参考链接"><a href="#1-1-4-参考链接" class="headerlink" title="1.1.4 参考链接"></a>1.1.4 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://yunong.io/2015/11/23/generating-node-js-flame-graphs/">https://yunong.io/2015/11/23/generating-node-js-flame-graphs/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.brendangregg.com/perf.html">http://www.brendangregg.com/perf.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html">http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.cn/article-4670-1.html">https://linux.cn/article-4670-1.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html">http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2017/09/flame-graph.html">http://www.ruanyifeng.com/blog/2017/09/flame-graph.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2018/05/20/Hexo-update-server-automatically/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/20/Hexo-update-server-automatically/" class="post-title-link" itemprop="url">Hexo: Update server automatically</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-05-20 15:45:26" itemprop="dateCreated datePublished" datetime="2018-05-20T15:45:26-06:00">2018-05-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
        </span>
    </span>

  
    <span id="/2018/05/20/Hexo-update-server-automatically/" class="post-meta-item leancloud_visitors" data-flag-title="Hexo: Update server automatically" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="How-to-update-the-Hexo-server-automatically"><a href="#How-to-update-the-Hexo-server-automatically" class="headerlink" title="How to update the Hexo server automatically:"></a>How to update the Hexo server automatically:</h2><p>Sometimes you may want to update your Hexo server after editing a post or creating a new one, here is how to use Browsersync to achieve that.</p>
<h3 id="Step-1-Install-the-Browsersync"><a href="#Step-1-Install-the-Browsersync" class="headerlink" title="Step 1: Install the Browsersync"></a>Step 1: Install the Browsersync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;npm install -g browser-sync</span><br></pre></td></tr></table></figure>
<h3 id="Step-2-Install-Hexo-plugin"><a href="#Step-2-Install-Hexo-plugin" class="headerlink" title="Step 2: Install Hexo plugin"></a>Step 2: Install Hexo plugin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;npm install hexo-browsersync --save</span><br></pre></td></tr></table></figure>
<h3 id="Step-3-Start-your-Hexo-service"><a href="#Step-3-Start-your-Hexo-service" class="headerlink" title="Step 3: Start your Hexo service"></a>Step 3: Start your Hexo service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://marvinliu1.github.io/2018/01/02/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Marvin Liu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Marvin's Blog">
      <meta itemprop="description" content="Take in the good!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Marvin's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/02/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-01-02 00:26:30" itemprop="dateCreated datePublished" datetime="2018-01-02T00:26:30-07:00">2018-01-02</time>
    </span>

  
    <span id="/2018/01/02/hello-world/" class="post-meta-item leancloud_visitors" data-flag-title="Hello World" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018  
  <!-- <span itemprop="copyrightYear">2022</span> -->
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Marvin Liu</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"appid":"qAsjmBkdw5m0pBHIrH2owQQT-MdYXbMMI","appkey":"xmNL8CNHrbd2QvJOzWwbj3ny","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
