<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Marvin&#39;s Blog</title>
  
  
  <link href="https://marvinliu1.github.io/atom.xml" rel="self"/>
  
  <link href="https://marvinliu1.github.io/"/>
  <updated>2022-05-25T15:23:53.533Z</updated>
  <id>https://marvinliu1.github.io/</id>
  
  <author>
    <name>Marvin Liu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hexo - How to add external links</title>
    <link href="https://marvinliu1.github.io/2021/05/22/Adding%20links%20into%20Hexo%20NexT8%20/"/>
    <id>https://marvinliu1.github.io/2021/05/22/Adding%20links%20into%20Hexo%20NexT8%20/</id>
    <published>2021-05-22T18:11:00.000Z</published>
    <updated>2022-05-25T15:23:53.533Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.litcu.cn/posts/9f2deaa1/">本文转载自Cu Blog</a></p><p>NexT 主题自带的并没有友链页面，本着 “可以不用但必须有” 的思想，我通过搜索引擎找到了可行的解决方案，在此记录，希望能帮到其他人。</p><p>NexT 版本：8.10.1。</p><p>先看一下最终效果吧：</p><p><a href="/images/blogs/favlinks.png"><img src="/images/blogs/favlinks.png" alt="img"></a></p><h2 id="NexT-配置文件修改"><a href="#NexT-配置文件修改" class="headerlink" title="NexT 配置文件修改"></a>NexT 配置文件修改</h2><p>打开<code>_config.next.yml</code> 文件，搜索<code>_data</code>，能够找到这样一条被注释的语句：<code>style: source/_data/styles.styl</code>，取消注释即可。</p><p>然后在 source 文件夹下新建<code>_data</code> 目录，并创建文件 styles.styl，在里面写入以下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#links &#123;</span><br><span class="line"> margin-top: 5rem;</span><br><span class="line">&#125;</span><br><span class="line">.links-content &#123;</span><br><span class="line"> margin-top:1rem;</span><br><span class="line">&#125;</span><br><span class="line">.link-navigation::after &#123;</span><br><span class="line"> content: &quot; &quot;;</span><br><span class="line"> display: block;</span><br><span class="line"> clear: both;</span><br><span class="line">&#125;</span><br><span class="line">.card &#123;</span><br><span class="line"> width: 300px;</span><br><span class="line"> font-size: 1rem;</span><br><span class="line"> padding: 10px 20px;</span><br><span class="line"> border-radius: 4px;</span><br><span class="line"> transition-duration: 0.15s;</span><br><span class="line"> margin-bottom: 1rem;</span><br><span class="line"> display:flex;</span><br><span class="line">&#125;</span><br><span class="line">.card:nth-child(odd) &#123;</span><br><span class="line"> float: left;</span><br><span class="line">&#125;</span><br><span class="line">.card:nth-child(even) &#123;</span><br><span class="line"> float: right;</span><br><span class="line">&#125;</span><br><span class="line">.card:hover &#123;</span><br><span class="line"> transform: scale(1.1);</span><br><span class="line"> box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.12), 0 0 6px 0 rgba(0, 0, 0, 0.04);</span><br><span class="line">&#125;</span><br><span class="line">.card a &#123;</span><br><span class="line"> border:none;</span><br><span class="line">&#125;</span><br><span class="line">.card .ava &#123;</span><br><span class="line"> width: 3rem!important;</span><br><span class="line"> height: 3rem!important;</span><br><span class="line"> margin:0!important;</span><br><span class="line"> margin-right: 1em!important;</span><br><span class="line"> border-radius:4px;</span><br><span class="line">&#125;</span><br><span class="line">.card .card-header &#123;</span><br><span class="line"> font-style: italic;</span><br><span class="line"> overflow: hidden;</span><br><span class="line"> width: 236px;</span><br><span class="line">&#125;</span><br><span class="line">.card .card-header a &#123;</span><br><span class="line"> font-style: normal;</span><br><span class="line"> color: #2bbc8a;</span><br><span class="line"> font-weight: bold;</span><br><span class="line"> text-decoration: none;</span><br><span class="line">&#125;</span><br><span class="line">.card .card-header a:hover &#123;</span><br><span class="line"> color: #d480aa;</span><br><span class="line"> text-decoration: none;</span><br><span class="line">&#125;</span><br><span class="line">.card .card-header .info &#123;</span><br><span class="line"> font-style:normal;</span><br><span class="line"> color:#a3a3a3;</span><br><span class="line"> font-size:14px;</span><br><span class="line"> min-width: 0;</span><br><span class="line"> text-overflow: ellipsis;</span><br><span class="line"> overflow: hidden;</span><br><span class="line"> white-space: nowrap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后修改主页面板：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">友链: /links || fas fa-link</span><br></pre></td></tr></table></figure><h2 id="创建友链页面"><a href="#创建友链页面" class="headerlink" title="创建友链页面"></a>创建友链页面</h2><p>使用 <code>hexo new page link</code> 可以新建一个 link 页面，我们将其作为友链页面。创建完成后，写入以下内容（自己使用时请按需修改）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 友链</span><br><span class="line">type: links</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;links-content&quot;&gt;</span><br><span class="line">&lt;div class=&quot;no-icon note warning&quot;&gt;</span><br><span class="line">&lt;div class=&quot;link-info&quot;&gt;欢迎与我交换友链！&lt;/div&gt;&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;link-navigation&quot;&gt;</span><br><span class="line">&#123;% for link in site.data.links %&#125;</span><br><span class="line">&lt;div class=&quot;card&quot;&gt;&lt;img class=&quot;ava nomediumzoom&quot; src=&quot;&#123;&#123; link.avatar &#125;&#125;&quot;/&gt;</span><br><span class="line">&lt;div class=&quot;card-header&quot;&gt;</span><br><span class="line">&lt;div&gt;&lt;a href=&quot;&#123;&#123; link.site &#125;&#125;&quot; target=&quot;_blank&quot;&gt; &#123;&#123; link.name &#125;&#125;&lt;/a&gt; &lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;info&quot;&gt;&#123;&#123; link.info &#125;&#125;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% note success %&#125;</span><br><span class="line"></span><br><span class="line">**友链申请条件：**</span><br><span class="line"></span><br><span class="line">- 网站内容符合中国大陆法律</span><br><span class="line">- 已开启HTTPS，且至少有3篇博客，最新一篇为三个月之内发表</span><br><span class="line">- 网站内容以原创为主，技术性博客优先，娱乐性博客除非特别感兴趣，否则不会考虑</span><br><span class="line"></span><br><span class="line">**友链格式：**</span><br><span class="line"></span><br><span class="line">```yaml</span><br><span class="line">- name: Cu Blog</span><br><span class="line">  site: https://www.litcu.cn</span><br><span class="line">  info: 安全新人小醋的快乐收集处</span><br><span class="line">  avatar: https://img.litcu.cn/avatar/avatar1.jpg</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>核心是 HTML 代码中的那个 for 循环，<code>site.data</code> 就是 <code>source/_data</code> 目录，后面的 <code>links</code> 就是我们之后要创建的 <code>links.yml</code> 友链文件。如果后续没有正常显示友链，可以看看这里是否出现了问题。</p><h2 id="添加友链"><a href="#添加友链" class="headerlink" title="添加友链"></a>添加友链</h2><p>在 <code>source/_data/</code> 目录下新建 link.yml 文件，写入以下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: Cu Blog</span><br><span class="line">  site: https://www.litcu.cn</span><br><span class="line">  info: 安全新人小醋的快乐收集处</span><br><span class="line">  avatar: https://img.litcu.cn/avatar/avatar1.jpg</span><br></pre></td></tr></table></figure><p>然后 <code>hexo cl &amp;&amp; hexo g &amp;&amp; hexo s</code> 就可以看到效果啦！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.litcu.cn/posts/9f2deaa1/&quot;&gt;本文转载自Cu Blog&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;NexT 主题自带的并没有友链页面，本着 “可以不用但必须有” 的思想，我通过搜索引擎找到了可行的解决方案，在此记录，希望能帮到其他</summary>
      
    
    
    
    <category term="Hexo" scheme="https://marvinliu1.github.io/categories/Hexo/"/>
    
    
    <category term="Hexo" scheme="https://marvinliu1.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>How To Implement Authentication in a Nuxt.js App</title>
    <link href="https://marvinliu1.github.io/2020/09/25/How-To-Implement-Auth-in-Nuxt/"/>
    <id>https://marvinliu1.github.io/2020/09/25/How-To-Implement-Auth-in-Nuxt/</id>
    <published>2020-09-25T06:12:31.000Z</published>
    <updated>2022-05-24T22:31:18.910Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.digitalocean.com/community/tutorials/implementing-authentication-in-nuxtjs-app">Original published and copy-righted by Chimezie Enyinnaya</a><br><a href="https://assets.digitalocean.com/">View more on digitalocean.com</a></p><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>In this tutorial, you’ll implement authentication in a <a href="https://nuxtjs.org/">Nuxt.js</a> app using the <code>Auth</code> module.</p><p>For the purpose of this tutorial, you’ll be using <code>JWT</code> for authentication.</p><p>Below is a quick demo of what you’ll be building in this tutorial:</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/2tWhMLqrSl2lC07r3JA5_nuxt-auth-demo.gif" alt="Animated gif of the app showing a user signing in"></p><p>You can find the <a href="https://github.com/do-community/nuxt-auth-app">source code for this application at GitHub</a>.</p><p><strong>Warning:</strong> Several of the packages in this tutorial now contain dependencies with known vulnerabilities. In a production setting, you would resolve these issues by upgrading these packages, finding alternatives, or creating forked versions with patched fixes. However, within the limited context of a tutorial, it provides educational value as-is.</p><h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>To complete this tutorial, you will need:</p><ul><li>Node.js installed locally, which you can do by following <a href="https://www.digitalocean.com/community/tutorial_series/how-to-install-node-js-and-create-a-local-development-environment">How to Install Node.js and Create a Local Development Environment</a>.</li><li>A valid Git installation is optionally required for cloning the API, consult <a href="https://www.digitalocean.com/community/tutorials/how-to-contribute-to-open-source-getting-started-with-git">Getting Started with Git</a>.</li></ul><p>Some familiarity with Vue.js and Nuxt.js may be beneficial. You can <a href="https://www.digitalocean.com/community/tutorials/vuejs-server-side-rendering-with-nuxtjs">refer to this post</a> if you’re getting started with Nuxt.js.</p><p>This tutorial was verified with Node v13.13.0, npm v6.14.4, <code>vue</code> v2.6.11, and <code>nuxt</code> v2.12.2.</p><h2 id="Step-1-—-Spinning-up-a-Sample-API"><a href="#Step-1-—-Spinning-up-a-Sample-API" class="headerlink" title="Step 1 — Spinning up a Sample API"></a>Step 1 — Spinning up a Sample API</h2><p>You are free to use whatever framework that works best for you. However, for quick development, this tutorial will clone an API built with <a href="https://adonisjs.com/">AdonisJs</a>.</p><p>The API utilizes:</p><ul><li>JWT (<a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Tokens</a>) for authentication</li><li><a href="https://en.wikipedia.org/wiki/SQLite">SQLite</a></li><li><a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> enabled</li></ul><p>The API has three endpoints:</p><ul><li><code>/register</code>: endpoint for user registration</li><li><code>/login</code>: endpoint for authenticating users</li><li><code>/me</code>: endpoint for getting details for the currently authenticated user and it is protected by an <code>auth</code> middleware, which means a user must be authenticated to access the endpoint</li></ul><p>First, run the following command in your terminal window:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/do-community/jwt-auth-api.git</span><br></pre></td></tr></table></figure><p>Copy</p><p>Then, navigate to the project directory:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> jwt-auth-api</span><br></pre></td></tr></table></figure><p>Copy</p><p>And install the API dependencies:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure><p>Copy</p><p><strong>Note</strong>: When running install, you may encounter issues with <code>sqlite3</code> version <code>4.0.1</code> depending on the version of Node you are running. Refer to the <a href="https://github.com/mapbox/node-sqlite3/blob/master/CHANGELOG.md">changelog</a> to determine compatibility with your environment.</p><p>At the time of original publication, the latest version of Node was 10. One option is to downgrade your version of Node to <code>10.20.1</code> (with the understanding that it is nearing end-of-life support). Then, run <code>npm install</code>.</p><p>A second option is to remove the <code>package-lock.json</code> file which will cause the system to look for <code>4.2.0</code> which is supported up to Node 13. You may need to also downgrade your version of Node to <code>13.13.0</code>. Then, run <code>npm install</code>.</p><p>A third option would be to modify <code>package.json</code> to a version of <code>sqlite3</code> supported by your current version of Node, remove <code>package-lock.json</code>, and run <code>npm install</code>. However, at the time of testing, <code>5.0.0</code> is not yet released to handle Node 14+ support.</p><p>Other symptoms of incompatibility include the following errors: <code>TypeError: Cannot read property &#39;data&#39; of undefined</code> and <code>Error: Cannot find module &#39;[...]/node_modules/sqlite3/lib/binding/[...]/node_sqlite3.node&#39;</code>.</p><p>Next, rename <code>.env.example</code> to <code>.env</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> .env.example .<span class="built_in">env</span></span><br></pre></td></tr></table></figure><p>Copy</p><p>And generate an <code>APP_KEY</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx @adonisjs/cli@4.0.12 key:generate</span><br></pre></td></tr></table></figure><p>Copy</p><p>You should see:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Outputgenerated: unique APP_KEY</span><br></pre></td></tr></table></figure><p>Copy</p><p>Once that’s coomplete, let’s run the migrations:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx @adonisjs/cli@4.0.12 migration:run</span><br></pre></td></tr></table></figure><p>Copy</p><p>Now, you can start the API:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ensure that you are in the `jwt-auth-api` project directory</span></span><br><span class="line">npm start</span><br></pre></td></tr></table></figure><p>Copy</p><p>You can access the API on <code>http://127.0.0.1:3333/api</code>. Leave this running in a terminal window for the rest of the duration of the tutorial.</p><h2 id="Step-2-—-Creating-a-Nuxt-js-App"><a href="#Step-2-—-Creating-a-Nuxt-js-App" class="headerlink" title="Step 2 — Creating a Nuxt.js App"></a>Step 2 — Creating a Nuxt.js App</h2><p>Now, you can create a Nuxt.js app. Open a new terminal window and use <code>vue-cli</code> to initialize a new Vue project with the Nuxt starter template:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx vue-cli@2.9.6 init nuxt/starter nuxt-auth</span><br></pre></td></tr></table></figure><p>Copy</p><p><strong>Note:</strong> At the time of testing, <code>vue-cli</code> is deprecated. <code>@vue/cli</code> is the current command line tool for Vue projects. And <code>@vue/cli-init</code> is the recommended approach for legacy <code>vue-cli</code> projects. However, <code>create-nuxt-app</code> is the recommended approach for modern Nuxt projects.</p><p>Next, you need to navigate to the project directory:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> nuxt-auth</span><br></pre></td></tr></table></figure><p>Copy</p><p>And install the dependencies:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure><p>Then, you can launch the app:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure><p>Copy</p><p>The app should be running on <code>http://localhost:3000</code>. You can view the application in a web browser to see the default Vue application created by <code>vue-cli</code>.</p><h2 id="Step-3-—-Installing-Necessary-Nuxt-js-Modules"><a href="#Step-3-—-Installing-Necessary-Nuxt-js-Modules" class="headerlink" title="Step 3 — Installing Necessary Nuxt.js Modules"></a>Step 3 — Installing Necessary Nuxt.js Modules</h2><p>Now, let’s install the Nuxt.js modules that you’ll be needing for your app. You’ll be using the <a href="https://auth.nuxtjs.org/">Nuxt Auth module</a> and the <a href="https://axios.nuxtjs.org/">Nuxt Axios module</a>, since the <code>auth</code> module makes use of Axios internally:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ensure that you are in the `nuxt-auth` project directory</span></span><br><span class="line">npm install @nuxtjs/auth@4.5.1 @nuxtjs/axios@5.3.1 --save</span><br></pre></td></tr></table></figure><p>Copy</p><p>Once that’s completed, open <code>nuxt.config.js</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano nuxt.config.js</span><br></pre></td></tr></table></figure><p>Copy</p><p>Add the code below to <code>nuxt.config.js</code>:</p><p>nuxt.config.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">modules</span>: [</span><br><span class="line">    <span class="string">&#x27;@nuxtjs/axios&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@nuxtjs/auth&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p><strong>Note:</strong> At this point, newer versions of Nuxt may encounter the error: <code>Enable vuex store by creating &#39;store/index.js&#39;</code>. This error can be resolved by <a href="https://github.com/nuxt-community/auth-module/issues/104">adding an empty <code>index.js</code> file to the <code>store</code> directory</a>.</p><p>Next, you need to set up the modules. Paste the code below into <code>nuxt.config.js</code>:</p><p>nuxt.config.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">axios</span>: &#123;</span><br><span class="line">    <span class="attr">baseURL</span>: <span class="string">&#x27;http://127.0.0.1:3333/api&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">auth</span>: &#123;</span><br><span class="line">    <span class="attr">strategies</span>: &#123;</span><br><span class="line">      <span class="attr">local</span>: &#123;</span><br><span class="line">        <span class="attr">endpoints</span>: &#123;</span><br><span class="line">          <span class="attr">login</span>: &#123; <span class="attr">url</span>: <span class="string">&#x27;login&#x27;</span>, <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">propertyName</span>: <span class="string">&#x27;data.token&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">user</span>: &#123; <span class="attr">url</span>: <span class="string">&#x27;me&#x27;</span>, <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>, <span class="attr">propertyName</span>: <span class="string">&#x27;data&#x27;</span> &#125;,</span><br><span class="line">          <span class="attr">logout</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>Here, you set the base URL that Axios will use when making requests. In our case, we are referencing the sample API we set up earlier.</p><p>Then, you define the authentication endpoints for the <code>local</code> strategy corresponding to those on your API:</p><ul><li>On successful authentication, the token will be available in the response as a <code>token</code> object inside a <code>data</code> object.</li><li>Similarly, the response from the <code>/me</code> endpoint will be inside a <code>data</code> object.</li><li>Lastly, you set <code>logout</code> to <code>false</code> since your API doesn’t have an endpoint for logout. You’ll just remove the token from localStorage when a user logs out.</li></ul><h2 id="Step-4-—-Creating-a-Navbar-Component"><a href="#Step-4-—-Creating-a-Navbar-Component" class="headerlink" title="Step 4 — Creating a Navbar Component"></a>Step 4 — Creating a Navbar Component</h2><p>To style your app, you can make use of <a href="https://bulma.io/">Bulma</a>.</p><p>Open <code>nuxt.config.js</code> and paste the code below within the <code>link</code> object that is inside the <code>head</code> object:</p><p>nuxt.config.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">head</span>: &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    link [</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">rel</span>: <span class="string">&#x27;stylesheet&#x27;</span>,</span><br><span class="line">        <span class="attr">href</span>: <span class="string">&#x27;https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>Now, let’s create the Navbar component:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano components/Navbar.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>And add the following code:</p><p>components&#x2F;Navbar.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar is-light&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Nuxt Auth<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button navbar-burger&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-menu&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-end&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item has-dropdown is-hoverable&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-link&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              My Account</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-dropdown&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/profile&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">hr</span> <span class="attr">class</span>=<span class="string">&quot;navbar-divider&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p>Copy</p><p>The Navbar component contains links to <code>login</code>, <code>register</code>, <code>profile</code>, and <code>logout</code>.</p><p>Next, let’s update the default layout to make use of the <code>Navbar</code> component.</p><p>Open <code>default.vue</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano layouts/default.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>And replace the content with the following:</p><p>layouts&#x2F;default.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">Navbar</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">nuxt</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">Navbar</span> <span class="keyword">from</span> <span class="string">&#x27;~/components/Navbar&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Navbar</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Copy</p><p>Also, let’s update the homepage.</p><p>Open <code>index.vue</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/index.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>And replace the content with the following:</p><p>pages&#x2F;index.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>Nuxt Auth<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p>Copy</p><p>At this point, you should have an application that displays a title of <code>&quot;Nuxt Auth&quot;</code> with a header bar with navigation links:</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/Y27FZj1TNm6tj0skgdhV_homepage.png" alt="App page with title and header bar"></p><h2 id="Step-5-—-Handling-User-Registration"><a href="#Step-5-—-Handling-User-Registration" class="headerlink" title="Step 5 — Handling User Registration"></a>Step 5 — Handling User Registration</h2><p>Inside the <code>pages</code> directory, create a new <code>register.vue</code> file:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/register.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>And add the following code:</p><p>pages&#x2F;register.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column is-4 is-offset-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title has-text-centered&quot;</span>&gt;</span>Register!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Notification</span> <span class="attr">:message</span>=<span class="string">&quot;error&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;error&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> @<span class="attr">submit.prevent</span>=<span class="string">&quot;register&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;username&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;username&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button is-dark is-fullwidth&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;has-text-centered&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 20px&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            Already got an account? <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">Notification</span> <span class="keyword">from</span> <span class="string">&#x27;~/components/Notification&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Notification</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">email</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">error</span>: <span class="literal">null</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$axios</span>.<span class="title function_">post</span>(<span class="string">&#x27;register&#x27;</span>, &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">username</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">email</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">loginWith</span>(<span class="string">&#x27;local&#x27;</span>, &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">data</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">email</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125; <span class="keyword">catch</span> (e) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">error</span> = e.<span class="property">response</span>.<span class="property">data</span>.<span class="property">message</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Copy</p><p>This contains a form with three fields: <code>username</code>, <code>email</code>, and <code>password</code>. Each field is bound to corresponding data on the component. When the form is submitted, a <code>register</code> method will be called. Using the Axios module, you make a post request to the <code>/register</code> endpoint, passing along the user data. If the registration was successful, you make use of the Auth module’s <code>loginWith()</code>, using the <code>local</code> strategy and passing the user data to log the user in. Then, you redirect the user to the homepage. If there is an error during the registration, you set the <code>error</code> data as the error message gotten from the API response.</p><p>If there is an error, the error message is displayed by a Notification component.</p><p>Create a new <code>Notification.vue</code> file inside <code>components</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano components/Notifaction.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>And paste the code below in it:</p><p>components&#x2F;Notification.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;notification is-danger&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;&#123; message &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;Notification&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">props</span>: [<span class="string">&#x27;message&#x27;</span>]</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Copy</p><p>The Notification component accepts a <code>message</code> props, which is the error message.</p><p>Now, you can test out user registration:</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/wOTj1xspRjiwMsaiWKt5_register.png" alt="Register page with Username, Email, and Password fields"></p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/qsHgdfDIR3ijyirZVqu4_register_failed.png" alt="Register page but with a notification message to the user that there was an error"></p><h2 id="Step-6-—-Handling-LoggedUsers-Logged-In-and-Logged-Out"><a href="#Step-6-—-Handling-LoggedUsers-Logged-In-and-Logged-Out" class="headerlink" title="Step 6 — Handling LoggedUsers Logged In and Logged Out"></a>Step 6 — Handling LoggedUsers Logged In and Logged Out</h2><p>Upon successful registration, users should be logged in but there is currently no way for the app to know whether users are logged in or not. So let’s fix that by updating the Navbar component and adding some computed properties.</p><p>Before you do just that, let’s first activate the Vuex store by creating an <code>index.js</code> file inside the <code>store</code> directory. The Auth module stores user authentication status as well as user details inside Vuex state in an <code>auth</code> object. So you can check if a user is logged in or not with <code>this.$store.state.auth.loggedIn</code>, which will either return <code>true</code> or <code>false</code>. Similarly, you can get a user’s details with <code>this.$store.state.auth.user</code>, which will be <code>null</code> if no user is logged in.</p><p><strong>Note:</strong> You can also access the user authentication status as well as the user details directly with the Auth module using <code>this.$auth.loggedIn</code> and <code>this.$auth.user</code> respectively.</p><p>Since you might want to use the computed properties in multiple places in your app, let’s create store getters.</p><p>Open <code>index.js</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano store/index.js</span><br></pre></td></tr></table></figure><p>Copy</p><p>And paste the code below in it:</p><p>store&#x2F;index.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="title function_">isAuthenticated</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> state.<span class="property">auth</span>.<span class="property">loggedIn</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loggedInUser</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> state.<span class="property">auth</span>.<span class="property">user</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>Here, you create two getters. The first one (<code>isAuthenticated</code>) will return the authentication status of a user and the second (<code>loggedInUser</code>) will return the details or the logged in user.</p><p>Next, let’s update the Navbar component to make use of the getters. Replace the content of <code>components/Navbar.vue</code> with the following:</p><p>components&#x2F;Navbar.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar is-light&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Nuxt Auth<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button navbar-burger&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-menu&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-end&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item has-dropdown is-hoverable&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;isAuthenticated&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-link&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              &#123;&#123; loggedInUser.username &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-dropdown&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/profile&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">hr</span> <span class="attr">class</span>=<span class="string">&quot;navbar-divider&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-else</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    ...<span class="title function_">mapGetters</span>([<span class="string">&#x27;isAuthenticated&#x27;</span>, <span class="string">&#x27;loggedInUser&#x27;</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Copy</p><p>You create the computed properties by using the spread operator (<code>...</code>) to extract the getters from <code>mapGetters</code>. Then using <code>isAuthenticated</code>, you display the user menu or links to <code>login</code> or <code>register</code> depending on whether the user is logged in or not. Also, you use <code>loggedInUser</code> to display the authenticated user username.</p><p>Now, if you give your app a refresh, you should see something similar to below:</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/NwqCBhzrSxysvLV832HE_loggedin.png" alt="App page with the user&#39;s username in the header"></p><h2 id="Step-7-—-Handling-User-Log-In"><a href="#Step-7-—-Handling-User-Log-In" class="headerlink" title="Step 7 — Handling User Log In"></a>Step 7 — Handling User Log In</h2><p>Now, let’s allow returning users the ability to log in.</p><p>Create a new <code>login.vue</code> file inside the <code>pages</code> directory:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/login.vue</span><br></pre></td></tr></table></figure><p>And paste the code below in it:</p><p>pages&#x2F;login.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column is-4 is-offset-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title has-text-centered&quot;</span>&gt;</span>Welcome back!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Notification</span> <span class="attr">:message</span>=<span class="string">&quot;error&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;error&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> @<span class="attr">submit.prevent</span>=<span class="string">&quot;login&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">class</span>=<span class="string">&quot;input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">name</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">v-model</span>=<span class="string">&quot;password&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button is-dark is-fullwidth&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;has-text-centered&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 20px&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              Don&#x27;t have an account? <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">Notification</span> <span class="keyword">from</span> <span class="string">&#x27;~/components/Notification&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Notification</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">email</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">error</span>: <span class="literal">null</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">loginWith</span>(<span class="string">&#x27;local&#x27;</span>, &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">data</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">email</span>: <span class="variable language_">this</span>.<span class="property">email</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125; <span class="keyword">catch</span> (e) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">error</span> = e.<span class="property">response</span>.<span class="property">data</span>.<span class="property">message</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Copy</p><p>This is quite similar to the <code>register</code> page. The form contains two fields: <code>email</code> and <code>password</code>. When the form is submitted, a <code>login</code> method will be called. Using the Auth module <code>loginWith()</code> and passing along the user data, you log the user in. If the authentication was successful, you redirect the user to the homepage. Otherwise, set <code>error</code> to the error message gotten from the API response. Again, you are using the Notification component from earlier on to display the error message.</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/neC1nzCQeeBX5jgZZskQ_login.png" alt="App Welcome Back page containing two fields: email and password"></p><h2 id="Step-8-—-Displaying-the-User-Profile"><a href="#Step-8-—-Displaying-the-User-Profile" class="headerlink" title="Step 8 — Displaying the User Profile"></a>Step 8 — Displaying the User Profile</h2><p>Let’s allow logged in users to view their profile.</p><p>Create a new <code>profile.vue</code> file inside the <code>pages</code> directory:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano pages/profile.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>And paste the code below in it:</p><p>pages&#x2F;profile.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Username:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;&#123; loggedInUser.username &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Email:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;&#123; loggedInUser.email &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">computed</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    ...<span class="title function_">mapGetters</span>([<span class="string">&#x27;loggedInUser&#x27;</span>])</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Copy</p><p>Notice how you are using the <code>loggedInUser</code> getter from earlier on to display the user details.</p><p>Clicking on the <strong>My Profile</strong> link should result in a <strong>My Profile</strong> page being displayed.</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/UqKusiHSRCC2H7IcytjA_profile.png" alt="My Profile page displaying username and email"></p><h2 id="Step-9-—-Logging-Users-Out"><a href="#Step-9-—-Logging-Users-Out" class="headerlink" title="Step 9 — Logging Users Out"></a>Step 9 — Logging Users Out</h2><p>Update the logout link inside the Navbar component.</p><p>Open <code>Navbar.vue</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano components/Navbar.vue</span><br></pre></td></tr></table></figure><p>Copy</p><p>Modify the logout link to use <code>@click=&quot;logout&quot;</code>:</p><p>components&#x2F;Navbar.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">&quot;navbar-dropdown&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/profile&quot;</span>&gt;</span>My Profile<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">class</span>=<span class="string">&quot;navbar-divider&quot;</span>/&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-item&quot;</span>  @<span class="attr">click</span>=<span class="string">&quot;logout&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>Copy</p><p>When the logout link is clicked, it will trigger a <code>logout</code> method.</p><p>Next, let’s add the <code>logout</code> method inside the script section of the Navbar component:</p><p>components&#x2F;Navbar.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">$auth</span>.<span class="title function_">logout</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>You call the <code>logout()</code> of the Auth module. This will delete the user’s token from localstorage and redirect the user to the homepage.</p><h2 id="Step-10-—-Restricting-the-Profile-Page"><a href="#Step-10-—-Restricting-the-Profile-Page" class="headerlink" title="Step 10 — Restricting the Profile Page"></a>Step 10 — Restricting the Profile Page</h2><p>As it stands now, anybody can visit the <code>profile</code> page. And if the user is not logged in, it will result in an error.</p><p><img src="https://assets.digitalocean.com/articles/implementing-authentication-in-nuxtjs-app/9UMgSTQCQUqSTGAdb6nY_profile_error.png" alt="TypeError on app page"></p><p>To fix this, you need to restrict the profile page to only logged in users. Luckily for us, you can achieve that with the Auth module. The Auth module comes with an <code>auth</code> middleware, which you can use in this scenario.</p><p>So let’s add the <code>auth</code> middleware to the <code>profile</code> page. Update the <code>script</code> section as below:</p><p>pages&#x2F;profile.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">middleware</span>: <span class="string">&#x27;auth&#x27;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>Now when a user that is not logged in tries to visit the <code>profile</code> page, the user will be redirected to the <code>login</code> page.</p><h2 id="Step-11-—-Creating-a-Guest-Middleware"><a href="#Step-11-—-Creating-a-Guest-Middleware" class="headerlink" title="Step 11 — Creating a Guest Middleware"></a>Step 11 — Creating a Guest Middleware</h2><p>Again as it stands, even as a logged in user, you can still access the login and register pages. One way to fix that is to restrict login and register pages to only users that are not logged in. You can do that by creating a guest middleware.</p><p>Inside the <code>middleware</code> directory, create a new <code>guest.js</code> file:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano middleware/guest.js</span><br></pre></td></tr></table></figure><p>Copy</p><p>And paste the code below in it:</p><p>middleware&#x2F;guest.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params">&#123; store, redirect &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">state</span>.<span class="property">auth</span>.<span class="property">loggedIn</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>A middleware accepts the context as its first argument. So you extract <code>store</code> and <code>redirect</code> from the context. Then, you check if the user is logged in then redirect the user to the homepage. Otherwise, you allow the normal execution of the request.</p><p>Next, let’s make use of this middleware. Update the <code>script</code> section of both <code>login</code> and <code>register</code> as below:</p><p>pages&#x2F;login.vue and pages&#x2F;register.vue</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">middleware</span>: <span class="string">&#x27;guest&#x27;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Copy</p><p>Now, everything will be working as expected.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this tutorial, you looked at how to implement authentication in a Nuxt.js application using the Auth module. You also saw how to keep the authentication flow sleek by making use of middleware.</p><p>To learn more about the Auth module, check out the <a href="https://auth.nuxtjs.org/">docs</a>.</p><p>If you’d like to learn more about Vue.js, check out <a href="https://www.digitalocean.com/community/tags/vue-js">our Vue.js topic page</a> for exercises and programming projects.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.digitalocean.com/community/tutorials/implementing-authentication-in-nuxtjs-app&quot;&gt;Original published and copy-righted </summary>
      
    
    
    
    <category term="Nuxt" scheme="https://marvinliu1.github.io/categories/Nuxt/"/>
    
    
    <category term="NeXt" scheme="https://marvinliu1.github.io/tags/NeXt/"/>
    
    <category term="Vue" scheme="https://marvinliu1.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Markdown Handbook</title>
    <link href="https://marvinliu1.github.io/2020/05/21/Markdown%E5%85%AC%E5%BC%8F%E7%94%A8%E6%B3%95%E5%A4%A7%E5%85%A8/"/>
    <id>https://marvinliu1.github.io/2020/05/21/Markdown%E5%85%AC%E5%BC%8F%E7%94%A8%E6%B3%95%E5%A4%A7%E5%85%A8/</id>
    <published>2020-05-21T06:12:31.000Z</published>
    <updated>2022-05-25T04:06:46.126Z</updated>
    
    <content type="html"><![CDATA[<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p>Markdown是一种轻量级标记语言</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一级标题</span></span><br><span class="line"><span class="comment">## 二级标题</span></span><br><span class="line"><span class="comment">### 三级标题</span></span><br><span class="line"><span class="comment">#### 四级标题</span></span><br><span class="line"><span class="comment">##### 五级标题</span></span><br><span class="line"><span class="comment">###### 六级标题</span></span><br><span class="line">**加粗**</span><br><span class="line">*斜体*</span><br><span class="line">==高亮==</span><br></pre></td></tr></table></figure><h4 id="两种代码引用方式"><a href="#两种代码引用方式" class="headerlink" title="两种代码引用方式"></a>两种代码引用方式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">``式或```式</span><br></pre></td></tr></table></figure><h4 id="插入链接并描述"><a href="#插入链接并描述" class="headerlink" title="插入链接并描述"></a>插入链接并描述</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[博客]</span>(<span class="attribute">https</span>:<span class="comment">//www.cnblogs.com/ &quot;博客&quot;)</span></span><br></pre></td></tr></table></figure><h4 id="插入图片"><a href="#插入图片" class="headerlink" title="插入图片"></a>插入图片</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![路飞](https://pic.baike.soso.com/ugc/baikepic2/0/ori-20190529230042-1249666563_jpeg_640_960_59726.jpg/800 <span class="string">&#x27;路飞&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表"></a>有序列表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="keyword">one</span></span><br><span class="line"><span class="number">2.</span>two</span><br><span class="line"><span class="number">3.</span>three</span><br></pre></td></tr></table></figure><h4 id="无序列表"><a href="#无序列表" class="headerlink" title="无序列表"></a>无序列表</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*</span> one</span><br><span class="line"><span class="bullet">*</span> two</span><br><span class="line"><span class="bullet">*</span> three</span><br></pre></td></tr></table></figure><h4 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h4 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name | age | sex</span><br><span class="line"><span class="section">:-: | :- | -:</span></span><br><span class="line">tony|20|男</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">name</th><th align="left">age</th><th align="center">sex</th></tr></thead><tbody><tr><td align="center">tony</td><td align="left">20</td><td align="center">男</td></tr></tbody></table><p>注：代码中第二行分别表示居中，右对齐，左对齐，若结果不显示，转化成源代码模式去掉行与行之间的空行。</p><h3 id="如何插入公式"><a href="#如何插入公式" class="headerlink" title="如何插入公式"></a>如何插入公式</h3><p>数学公式有两种：行中公式（与文字搭配使用）和独立公式（独立成行）</p><p>行内公式表示：<code>$ 数学公式 $</code></p><p>独立公式表示：<code>$$ 数学公式 $$</code></p><h3 id="如何输入上下标"><a href="#如何输入上下标" class="headerlink" title="如何输入上下标"></a>如何输入上下标</h3><p><code>^</code> 表示上标, <code>_</code> 表示下标。如果上下标的内容多于一个字符，需要用 <code>&#123;&#125;</code> 将这些内容括成一个整体。上下标可以嵌套，也可以同时使用。</p><p>如：<code>$$ x^&#123;y^z&#125;=(1+&#123;\rm e&#125;^x)^&#123;-2xy^w&#125; $$</code>,显示：$x{yz}&#x3D;(1+{\rm e}x){-2xy^w} $</p><p>另外，如果要在左右两边都有上下标，可以用 <code>\sideset</code> 命令。</p><p>如：<code>$$ \sideset&#123;^1_2&#125;&#123;^3_4&#125;\bigotimes $$</code>,显示：$ \sideset{1_2}{3_4}\bigotimes $</p><h3 id="如何输入括号和分隔符"><a href="#如何输入括号和分隔符" class="headerlink" title="如何输入括号和分隔符"></a>如何输入括号和分隔符</h3><p><code>()</code>、<code>[]</code> 和 <code>|</code> 表示符号本身，使用 <code>\&#123;\&#125;</code> 来表示 <code>&#123;&#125;</code> 。当要显示大号的括号或分隔符时，要用 <code>\left</code> 和 <code>\right</code> 命令。</p><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\langle</td><td align="center">⟨⟨</td><td align="center">\rangle</td><td align="center">⟩⟩</td></tr><tr><td align="center">\lceil</td><td align="center">⌈⌈</td><td align="center">\rceil</td><td align="center">⌉⌉</td></tr><tr><td align="center">\lfloor</td><td align="center">⌊⌊</td><td align="center">\rfloor</td><td align="center">⌋⌋</td></tr><tr><td align="center">\lbrace</td><td align="center">{ {</td><td align="center">\rbrace</td><td align="center">} }</td></tr></tbody></table><p>如：<code>$$ f(x,y,z) = 3y^2z \left( 3+\frac&#123;7x+5&#125;&#123;1+y^2&#125; \right) $$</code>,显示：f(x,y,z)&#x3D;3y2z(3+7x+51+y2)f(x,y,z)&#x3D;3y2z(3+7x+51+y2)</p><p>有时候要用 <code>\left.</code> 或 <code>\right.</code> 进行匹配而不显示本身。</p><p>如：<code>$$ \left. \frac&#123;&#123;\rm d&#125;u&#125;&#123;&#123;\rm d&#125;x&#125; \right| _&#123;x=0&#125; $$`,显示：[MathProcessingError]dudx∣∣x=0[MathProcessingError]dudx|x=0### 如何输入分数通常使用 `\frac &#123;分子&#125; &#123;分母&#125;` 命令产生一个分数，分数可嵌套。便捷情况可直接输入 `\frac ab` 来快速生成一个 abab 。如果分式很复杂，亦可使用 `分子 \over 分母` 命令，此时分数仅有一层。如：`$$ \frac&#123;a-1&#125;&#123;b-1&#125; \quad and \quad &#123;a+1\over b+1&#125; $$`,显示：a−1b−1anda+1b+1a−1b−1anda+1b+1### 如何输入开方使用 `\sqrt [根指数，省略时为2] &#123;被开方数&#125;` 命令输入开方。如：`$$ \sqrt&#123;2&#125; \quad and \quad \sqrt[n]&#123;3&#125; $$`,显示：2–√and3–√n2and3n### 如何输入省略号数学公式中常见的省略号有两种，`\ldots` 表示与文本底线对齐的省略号，`\cdots` 表示与文本中线对齐的省略号。如：`$$ f(x_1,x_2,\underbrace&#123;\ldots&#125;_&#123;\rm ldots&#125; ,x_n) = x_1^2 + x_2^2 + \underbrace&#123;\cdots&#125;_&#123;\rm cdots&#125; + x_n^2 $$`,显示：$ f(x_1,x_2,\underbrace&#123;\ldots&#125;*&#123;\rm ldots&#125; ,x_n) = x_1^2 + x_2^2 + \underbrace&#123;\cdots&#125;*&#123;\rm cdots&#125; + x_n^2 $### 如何输入矢量使用 `\vec&#123;矢量&#125;` 来自动产生一个矢量。也可以使用 `\overrightarrow` 等命令自定义字母上方的符号。如：`$$ \vec&#123;a&#125; \cdot \vec&#123;b&#125;=0 $$`,显示：a⃗ ⋅b⃗ =0a→⋅b→=0如：`$$ \overleftarrow&#123;xy&#125; \quad and \quad \overleftrightarrow&#123;xy&#125; \quad and \quad \overrightarrow&#123;xy&#125; $$`,显示：xy←−andxy←→andxy−→xy←andxy↔andxy→### 如何输入积分使用 `\int_积分下限^积分上限 &#123;被积表达式&#125;` 来输入一个积分。如：`$$ \int_0^1 &#123;x^2&#125; \,&#123;\rm d&#125;x $$`,显示：∫10x2,dx∫01x2,dx,例中 `\,` 和 `&#123;\rm d&#125;` 部分可省略，建议加入，使式子更美观。### 如何输入极限运算使用 `\lim_&#123;变量 \to 表达式&#125; 表达式` 来输入一个极限。如有需求，可以更改 `\to` 符号至任意符号。如：`$$ \lim_&#123;n \to +\infty&#125; \frac&#123;1&#125;&#123;n(n+1)&#125; \quad and \quad \lim_&#123;x\leftarrow&#123;示例&#125;&#125; \frac&#123;1&#125;&#123;n(n+1)&#125; $$</code>,显示：</p><p>limn→+∞1n(n+1)andlimx←示例1n(n+1)limn→+∞1n(n+1)andlimx←示例1n(n+1)</p><h3 id="如何输入累加、累乘运算"><a href="#如何输入累加、累乘运算" class="headerlink" title="如何输入累加、累乘运算"></a>如何输入累加、累乘运算</h3><p>使用 <code>\sum_&#123;下标表达式&#125;^&#123;上标表达式&#125; &#123;累加表达式&#125;</code> 来输入一个累加。与之类似，使用 <code>\prod</code> <code>\bigcup</code> <code>\bigcap</code> 来分别输入累乘、并集和交集。此类符号在行内显示时上下标表达式将会移至右上角和右下角。</p><p>如：<code>$$ \sum_&#123;i=1&#125;^n \frac&#123;1&#125;&#123;i^2&#125; \quad and \quad \prod_&#123;i=1&#125;^n \frac&#123;1&#125;&#123;i^2&#125; \quad and \quad \bigcup_&#123;i=1&#125;^&#123;2&#125; R $$</code>,显示：∑ni&#x3D;11i2and∏ni&#x3D;11i2and⋃2i&#x3D;1R∑i&#x3D;1n1i2and∏i&#x3D;1n1i2and⋃i&#x3D;12R</p><h3 id="如何输入希腊字母"><a href="#如何输入希腊字母" class="headerlink" title="如何输入希腊字母"></a>如何输入希腊字母</h3><p>输入 <code>\小写希腊字母英文全称</code> 和 <code>\首字母大写希腊字母英文全称</code> 来分别输入小写和大写希腊字母,对于大写希腊字母与现有字母相同的，直接输入大写字母即可。</p><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\alpha</td><td align="center">αα</td><td align="center">A</td><td align="center">AA</td><td align="center">\beta</td><td align="center">ββ</td><td align="center">B</td><td align="center">BB</td></tr><tr><td align="center">\gamma</td><td align="center">γγ</td><td align="center">\Gamma</td><td align="center">ΓΓ</td><td align="center">\delta</td><td align="center">δδ</td><td align="center">\Delta</td><td align="center">ΔΔ</td></tr><tr><td align="center">\epsilon</td><td align="center">ϵϵ</td><td align="center">E</td><td align="center">EE</td><td align="center">\zeta</td><td align="center">ζζ</td><td align="center">Z</td><td align="center">ZZ</td></tr><tr><td align="center">\eta</td><td align="center">ηη</td><td align="center">H</td><td align="center">HH</td><td align="center">\theta</td><td align="center">θθ</td><td align="center">\Theta</td><td align="center">ΘΘ</td></tr><tr><td align="center">\iota</td><td align="center">ιι</td><td align="center">I</td><td align="center">II</td><td align="center">\kappa</td><td align="center">κκ</td><td align="center">K</td><td align="center">KK</td></tr><tr><td align="center">\lambda</td><td align="center">λλ</td><td align="center">\Lambda</td><td align="center">ΛΛ</td><td align="center">\mu</td><td align="center">μμ</td><td align="center">M</td><td align="center">MM</td></tr><tr><td align="center">\nu</td><td align="center">νν</td><td align="center">N</td><td align="center">NN</td><td align="center">\xi</td><td align="center">ξξ</td><td align="center">\Xi</td><td align="center">ΞΞ</td></tr><tr><td align="center">o</td><td align="center">oo</td><td align="center">O</td><td align="center">OO</td><td align="center">\pi</td><td align="center">ππ</td><td align="center">\Pi</td><td align="center">ΠΠ</td></tr><tr><td align="center">\rho</td><td align="center">ρρ</td><td align="center">P</td><td align="center">PP</td><td align="center">\sigma</td><td align="center">σσ</td><td align="center">\Sigma</td><td align="center">ΣΣ</td></tr><tr><td align="center">\tau</td><td align="center">ττ</td><td align="center">T</td><td align="center">TT</td><td align="center">\upsilon</td><td align="center">υυ</td><td align="center">\Upsilon</td><td align="center">ΥΥ</td></tr><tr><td align="center">\phi</td><td align="center">ϕϕ</td><td align="center">\Phi</td><td align="center">ΦΦ</td><td align="center">\chi</td><td align="center">χχ</td><td align="center">X</td><td align="center">XX</td></tr><tr><td align="center">\psi</td><td align="center">ψψ</td><td align="center">\Psi</td><td align="center">ΨΨ</td><td align="center">\omega</td><td align="center">ωω</td><td align="center">\Omega</td><td align="center">ΩΩ</td></tr></tbody></table><p>部分字母有变量专用形式，以 <code>\var-</code> 开头。</p><table><thead><tr><th align="center">小写形式</th><th align="center">大写形式</th><th align="center">变量形式</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\epsilon</td><td align="center">E</td><td align="center">\varepsilon</td><td align="center">ϵ∣E∣εϵ∣E∣ε</td></tr><tr><td align="center">\theta</td><td align="center">\Theta</td><td align="center">\vartheta</td><td align="center">θ∣Θ∣ϑθ∣Θ∣ϑ</td></tr><tr><td align="center">\rho</td><td align="center">P</td><td align="center">\varrho</td><td align="center">ρ∣P∣ϱρ∣P∣ϱ</td></tr><tr><td align="center">\sigma</td><td align="center">\Sigma</td><td align="center">\varsigma</td><td align="center">σ∣Σ∣ςσ∣Σ∣ς</td></tr><tr><td align="center">\phi</td><td align="center">\Phi</td><td align="center">\varphi</td><td align="center">ϕ∣Φ∣φϕ∣Φ∣φ</td></tr></tbody></table><h3 id="如何输入其它特殊字符"><a href="#如何输入其它特殊字符" class="headerlink" title="如何输入其它特殊字符"></a>如何输入其它特殊字符</h3><p>若需要显示更大或更小的字符，在符号前插入 <code>\large</code> 或 <code>\small</code> 命令。若找不到需要的符号，使用 <a href="http://detexify.kirelabs.org/classify.html">Detexify2Detexify2</a> 来画出想要的符号。</p><h4 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\pm</td><td align="center">±±</td><td align="center">\times</td><td align="center">××</td><td align="center">\div</td><td align="center">÷÷</td><td align="center">\mid</td><td align="center">∣∣</td></tr><tr><td align="center">\nmid</td><td align="center">∤∤</td><td align="center">\cdot</td><td align="center">⋅⋅</td><td align="center">\circ</td><td align="center">∘∘</td><td align="center">\ast</td><td align="center">∗∗</td></tr><tr><td align="center">\bigodot</td><td align="center">⨀⨀</td><td align="center">\bigotimes</td><td align="center">⨂⨂</td><td align="center">\bigoplus</td><td align="center">⨁⨁</td><td align="center">\leq</td><td align="center">≤≤</td></tr><tr><td align="center">\geq</td><td align="center">≥≥</td><td align="center">\neq</td><td align="center">≠≠</td><td align="center">\approx</td><td align="center">≈≈</td><td align="center">\equiv</td><td align="center">≡≡</td></tr><tr><td align="center">\sum</td><td align="center">∑∑</td><td align="center">\prod</td><td align="center">∏∏</td><td align="center">\coprod</td><td align="center">∐∐</td><td align="center">\backslash</td><td align="center">∖∖</td></tr></tbody></table><h4 id="集合运算符"><a href="#集合运算符" class="headerlink" title="集合运算符"></a>集合运算符</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\emptyset</td><td align="center">∅∅</td><td align="center">\in</td><td align="center">∈∈</td><td align="center">\notin</td><td align="center">∉∉</td></tr><tr><td align="center">\subset</td><td align="center">⊂⊂</td><td align="center">\supset</td><td align="center">⊃⊃</td><td align="center">\subseteq</td><td align="center">⊆⊆</td></tr><tr><td align="center">\supseteq</td><td align="center">⊇⊇</td><td align="center">\bigcap</td><td align="center">⋂⋂</td><td align="center">\bigcup</td><td align="center">⋃⋃</td></tr><tr><td align="center">\bigvee</td><td align="center">⋁⋁</td><td align="center">\bigwedge</td><td align="center">⋀⋀</td><td align="center">\biguplus</td><td align="center">⨄⨄</td></tr></tbody></table><h4 id="对数运算符"><a href="#对数运算符" class="headerlink" title="对数运算符"></a>对数运算符</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\log</td><td align="center">loglog</td><td align="center">\lg</td><td align="center">lglg</td><td align="center">\ln</td><td align="center">lnln</td></tr></tbody></table><h4 id="三角运算符"><a href="#三角运算符" class="headerlink" title="三角运算符"></a>三角运算符</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">30^\circ</td><td align="center">30∘30∘</td><td align="center">\bot</td><td align="center">⊥⊥</td><td align="center">\angle A</td><td align="center">∠A∠A</td></tr><tr><td align="center">\sin</td><td align="center">sinsin</td><td align="center">\cos</td><td align="center">coscos</td><td align="center">\tan</td><td align="center">tantan</td></tr><tr><td align="center">\csc</td><td align="center">csccsc</td><td align="center">\sec</td><td align="center">secsec</td><td align="center">\cot</td><td align="center">cotcot</td></tr></tbody></table><h4 id="微积分运算符"><a href="#微积分运算符" class="headerlink" title="微积分运算符"></a>微积分运算符</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\int</td><td align="center">∫∫</td><td align="center">\iint</td><td align="center">∬∬</td><td align="center">\iiint</td><td align="center">∭∭</td></tr><tr><td align="center">\iiiint</td><td align="center">∬∬⨌</td><td align="center">\oint</td><td align="center">∮∮</td><td align="center">\prime</td><td align="center">′′</td></tr><tr><td align="center">\lim</td><td align="center">limlim</td><td align="center">\infty</td><td align="center">∞∞</td><td align="center">\nabla</td><td align="center">∇∇</td></tr></tbody></table><h4 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\because</td><td align="center">∵∵</td><td align="center">\therefore</td><td align="center">∴∴</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">\forall</td><td align="center">∀∀</td><td align="center">\exists</td><td align="center">∃∃</td><td align="center">\not\subset</td><td align="center">⊄⊄</td></tr><tr><td align="center">\not&lt;</td><td align="center">≮≮</td><td align="center">\not&gt;</td><td align="center">≯≯</td><td align="center">\not&#x3D;</td><td align="center">≠≠</td></tr></tbody></table><h4 id="戴帽符号"><a href="#戴帽符号" class="headerlink" title="戴帽符号"></a>戴帽符号</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\hat{xy}</td><td align="center">xy^xy^</td><td align="center">\widehat{xyz}</td><td align="center">xyzˆxyz^</td></tr><tr><td align="center">\tilde{xy}</td><td align="center">xy<del>xy</del></td><td align="center">\widetilde{xyz}</td><td align="center">xyz˜xyz~</td></tr><tr><td align="center">\check{x}</td><td align="center">xˇxˇ</td><td align="center">\breve{y}</td><td align="center">y˘y˘</td></tr><tr><td align="center">\grave{x}</td><td align="center">x<code>x</code></td><td align="center">\acute{y}</td><td align="center">y´y´</td></tr></tbody></table><h4 id="连线符号"><a href="#连线符号" class="headerlink" title="连线符号"></a>连线符号</h4><table><thead><tr><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\fbox{a+b+c+d}</td><td align="center">a+b+c+da+b+c+d</td></tr><tr><td align="center">\overleftarrow{a+b+c+d}</td><td align="center">a+b+c+d←−−−a+b+c+d←</td></tr><tr><td align="center">\overrightarrow{a+b+c+d}</td><td align="center">a+b+c+d−→−−a+b+c+d→</td></tr><tr><td align="center">\overleftrightarrow{a+b+c+d}</td><td align="center">a+b+c+d←→−a+b+c+d↔</td></tr><tr><td align="center">\underleftarrow{a+b+c+d}</td><td align="center">a+b+c+d←−−−a+b+c+d←</td></tr><tr><td align="center">\underrightarrow{a+b+c+d}</td><td align="center">a+b+c+d−→−−a+b+c+d→</td></tr><tr><td align="center">\underleftrightarrow{a+b+c+d}</td><td align="center">a+b+c+d←→−a+b+c+d↔</td></tr><tr><td align="center">\overline{a+b+c+d}</td><td align="center">a+b+c+d¯¯¯¯¯¯¯¯¯¯¯a+b+c+d¯</td></tr><tr><td align="center">\underline{a+b+c+d}</td><td align="center">a+b+c+d–––––a+b+c+d_</td></tr><tr><td align="center">\overbrace{a+b+c+d}^{Sample}</td><td align="center">a+b+c+dSamplea+b+c+d⏞Sample</td></tr><tr><td align="center">\underbrace{a+b+c+d}_{Sample}</td><td align="center">a+b+c+dSamplea+b+c+d⏟Sample</td></tr><tr><td align="center">\overbrace{a+\underbrace{b+c}_{1.0}+d}^{2.0}</td><td align="center">a+b+c1.0+d2.0a+b+c⏟1.0+d⏞2.0</td></tr><tr><td align="center">\underbrace{a\cdot a\cdots a}_{b\text{ times}}</td><td align="center">a⋅a⋯ab timesa⋅a⋯a⏟b times</td></tr></tbody></table><h4 id="箭头符号"><a href="#箭头符号" class="headerlink" title="箭头符号"></a>箭头符号</h4><ul><li>推荐使用符号：<br>|输入|显示|输入|显示|输入|显示|<br>|:–😐:–😐:–😐:–😐:–😐:–😐<br>|\to|$ \to|↦||↦| \mapsto||||⟹|||||⟹| \implies|⟺||⟺| \iff|⟸||⟸| \impliedby$|</li><li>其它可用符号：<br>|输入|显示|输入|显示|<br>|:–😐:–😐:–😐:–😐<br>|\uparrow|$ \uparrow|⇑||⇑| \Uparrow||↓|||↓| \downarrow|⇓||⇓| \Downarrow||←|||←| \leftarrow|⇐||⇐| \Leftarrow||→|||→| \rightarrow|⇒||⇒| \Rightarrow||↔|||↔| \leftrightarrow|⇔||⇔| \Leftrightarrow||⟵|||⟵| \longleftarrow|⟸||⟸| \Longleftarrow||⟶|||⟶| \longrightarrow|⟹||⟹| \Longrightarrow||⟷|||⟷| \longleftrightarrow|⟺||⟺| \Longleftrightarrow$|</li></ul><h3 id="如何进行字体转换"><a href="#如何进行字体转换" class="headerlink" title="如何进行字体转换"></a>如何进行字体转换</h3><p>若要对公式的某一部分字符进行字体转换，可以用 <code>&#123;\字体 &#123;需转换的部分字符&#125;&#125;</code> 命令，其中 <code>\字体</code> 部分可以参照下表选择合适的字体。一般情况下，公式默认为意大利体 italicitalic 。示例中 全部大写 的字体仅大写可用。</p><table><thead><tr><th align="center">输入</th><th align="center">说明</th><th align="center">显示</th><th align="center">输入</th><th align="center">说明</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">\rm</td><td align="center">罗马体</td><td align="center">SampleSample</td><td align="center">\cal</td><td align="center">花体</td><td align="center">SAMPLESAMPLE</td></tr><tr><td align="center">\it</td><td align="center">意大利体</td><td align="center">SampleSample</td><td align="center">\Bbb</td><td align="center">黑板粗体</td><td align="center">SAMPLESAMPLE</td></tr><tr><td align="center">\bf</td><td align="center">粗体</td><td align="center">SampleSample</td><td align="center">\mit</td><td align="center">数学斜体</td><td align="center">SAMPLESAMPLE</td></tr><tr><td align="center">\sf</td><td align="center">等线体</td><td align="center">SampleSample</td><td align="center">\scr</td><td align="center">手写体</td><td align="center">SAMPLESAMPLE</td></tr><tr><td align="center">\tt</td><td align="center">打字机体</td><td align="center">SampleSample</td><td align="center">\frak</td><td align="center">旧德式字体</td><td align="center">SampleSample</td></tr></tbody></table><p>转换字体十分常用，例如在积分中：</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\<span class="keyword">begin</span>&#123;array&#125;&#123;cc&#125;</span><br><span class="line">\<span class="keyword">mathrm</span>&#123;Bad&#125; <span class="operator">&amp;</span> \<span class="keyword">mathrm</span>&#123;Better&#125; \\</span><br><span class="line">\hline \\</span><br><span class="line">\int_0<span class="operator">^</span><span class="number">1</span> x<span class="operator">^</span><span class="number">2</span> dx <span class="operator">&amp;</span> \int_0<span class="operator">^</span><span class="number">1</span> x<span class="operator">^</span><span class="number">2</span> \,&#123;\rm d&#125;x</span><br><span class="line">\<span class="keyword">end</span>&#123;array&#125;</span><br></pre></td></tr></table></figure><p>显示：\begin{array}{cc}<br>\mathrm{Bad} &amp; \mathrm{Better} \<br>\hline \<br>\int_0^1 x^2 dx &amp; \int_0^1 x^2 ,{\rm d}x<br>\end{array}\begin{array}{cc} \mathrm{Bad} &amp; \mathrm{Better} \ \hline \ \int_0^1 x^2 dx &amp; \int_0^1 x^2 ,{\rm d}x \end{array},注意比较两个式子间 dxdx 与 dxdx 的不同。</p><h3 id="如何使用大括号和行标"><a href="#如何使用大括号和行标" class="headerlink" title="如何使用大括号和行标"></a>如何使用大括号和行标</h3><p>使用 <code>\left</code> 和 <code>\right</code> 来创建自动匹配高度的 (圆括号)，[方括号] 和 {花括号} ，在每个公式末尾前使用 <code>\tag&#123;行标&#125;</code> 来实现行标。</p><ul><li>例如：</li></ul><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">$</span><span class="operator">$</span></span><br><span class="line">f\left(</span><br><span class="line">   \left[ </span><br><span class="line">     \<span class="keyword">frac</span>&#123;</span><br><span class="line">       <span class="number">1</span><span class="operator">+</span>\left\&#123;x,y\right\&#125;</span><br><span class="line">     &#125;&#123;</span><br><span class="line">       \left(</span><br><span class="line">          \<span class="keyword">frac</span>&#123;x&#125;&#123;y&#125;<span class="operator">+</span>\<span class="keyword">frac</span>&#123;y&#125;&#123;x&#125;</span><br><span class="line">       \right)</span><br><span class="line">       \left(u<span class="operator">+</span><span class="number">1</span>\right)</span><br><span class="line">     &#125;<span class="operator">+</span>a</span><br><span class="line">   \right]<span class="operator">^</span>&#123;<span class="number">3</span><span class="operator">/</span><span class="number">2</span>&#125;</span><br><span class="line">\right)</span><br><span class="line">\<span class="keyword">tag</span>&#123;行标&#125;</span><br><span class="line"><span class="operator">$</span><span class="operator">$</span></span><br></pre></td></tr></table></figure><ul><li>显示：</li></ul><p>f⎛⎝⎜⎜⎡⎣⎢1+{x,y}(xy+yx)(u+1)+a⎤⎦⎥3&#x2F;2⎞⎠⎟⎟(行标)(行标)f([1+{x,y}(xy+yx)(u+1)+a]3&#x2F;2)</p><p>如果你需要在不同的行显示对应括号，可以在每一行对应处使用 <code>\left.</code> 或 <code>\right.</code> 来放一个”影子”括号：</p><ul><li>例如：</li></ul><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$$</span></span><br><span class="line">\<span class="keyword">begin</span>&#123;aligned&#125;</span><br><span class="line">a=&amp;\left(<span class="number">1</span>+<span class="number">2</span>+<span class="number">3</span>+  \cdots \right. \\</span><br><span class="line">&amp; \cdots+ \left. \infty-<span class="number">2</span>+\infty-<span class="number">1</span>+\infty\right)</span><br><span class="line">\<span class="keyword">end</span>&#123;aligned&#125;</span><br><span class="line"><span class="variable">$$</span></span><br></pre></td></tr></table></figure><ul><li>显示：</li></ul><p>a&#x3D;(1+2+3+⋯⋯+∞−2+∞−1+∞)a&#x3D;(1+2+3+⋯⋯+∞−2+∞−1+∞)</p><p>如果你需要将行内显示的分隔符也变大，可以使用 <code>\middle</code> 命令：</p><ul><li>例如：</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span><span class="variable">$</span></span><br><span class="line">\left\langle  </span><br><span class="line">  q</span><br><span class="line">\middle\|</span><br><span class="line">  \frac&#123;\frac&#123;x&#125;&#123;y&#125;&#125;&#123;\frac&#123;u&#125;&#123;v&#125;&#125;</span><br><span class="line">\middle| </span><br><span class="line">   p </span><br><span class="line">\right\rangle</span><br><span class="line"><span class="variable">$</span><span class="variable">$</span></span><br></pre></td></tr></table></figure><ul><li>显示：</li></ul><p>⟨q∥∥∥xyuv∣∣∣p⟩⟨q‖xyuv|p⟩</p><h3 id="其它公式"><a href="#其它公式" class="headerlink" title="其它公式"></a>其它公式</h3><h4 id="定义新的符号-operatorname"><a href="#定义新的符号-operatorname" class="headerlink" title="定义新的符号\operatorname"></a>定义新的符号<code>\operatorname</code></h4><p>如：<code>$$ \operatorname&#123;Symbol&#125; A $$</code>，显示： SymbolASymbol⁡A</p><h4 id="添加注释文字-text"><a href="#添加注释文字-text" class="headerlink" title="添加注释文字 \text"></a>添加注释文字 <code>\text</code></h4><p>在 <code>\text &#123;文字&#125;</code> 中仍可以使用 <code>$公式$</code> 插入其它公式。</p><p>如：<code>$$ f(n)= \begin&#123;cases&#125; n/2, &amp; \text &#123;if $n$ is even&#125; \\ 3n+1, &amp; \text&#123;if $n$ is odd&#125; \end&#123;cases&#125; $$</code></p><p>显示：$ f(n)&#x3D; \begin{cases} n&#x2F;2, &amp; \text {if nn is even} \ 3n+1, &amp; \text{if nn is odd} \end{cases} $</p><h4 id="在字符间加入空格"><a href="#在字符间加入空格" class="headerlink" title="在字符间加入空格"></a>在字符间加入空格</h4><p>有四种宽度的空格可以使用： <code>\,</code>、<code>\;</code>、<code>\quad</code> 和 <code>\qquad</code> 。</p><p>如：<code>$$ a \, b \mid a \; b \mid a \quad b \mid a \qquad b $$</code>,显示：a,b∣a;b∣ab∣aba,b∣a;b∣ab∣ab</p><p>当然，使用 <code>\text &#123;n个空格&#125;</code> 也可以达到同样效果。</p><h4 id="更改文字颜色"><a href="#更改文字颜色" class="headerlink" title="更改文字颜色"></a>更改文字颜色</h4><p>使用 <code>\color&#123;颜色&#125;&#123;文字&#125;</code> 来更改特定的文字颜色,更改文字颜色 需要浏览器支持，如果浏览器不知道你所需的颜色，那么文字将被渲染为黑色。对于较旧的浏览器（HTML4与CSS2），以下颜色是被支持的：</p><table><thead><tr><th align="center">输入</th><th align="center">显示</th><th align="center">输入</th><th align="center">显示</th></tr></thead><tbody><tr><td align="center">black</td><td align="center">texttext</td><td align="center">grey</td><td align="center">texttext</td></tr><tr><td align="center">silver</td><td align="center">texttext</td><td align="center">white</td><td align="center">texttext</td></tr><tr><td align="center">maroon</td><td align="center">texttext</td><td align="center">red</td><td align="center">texttext</td></tr><tr><td align="center">yellow</td><td align="center">texttext</td><td align="center">lime</td><td align="center">texttext</td></tr><tr><td align="center">olive</td><td align="center">texttext</td><td align="center">green</td><td align="center">texttext</td></tr><tr><td align="center">teal</td><td align="center">texttext</td><td align="center">auqa</td><td align="center">texttext</td></tr><tr><td align="center">blue</td><td align="center">texttext</td><td align="center">navy</td><td align="center">texttext</td></tr><tr><td align="center">purple</td><td align="center">texttext</td><td align="center">fuchsia</td><td align="center">texttext</td></tr></tbody></table><p>对于较新的浏览器（HTML5与CSS3），额外的124种颜色将被支持：输入 &#96;\color </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;基本语法&quot;&gt;&lt;a href=&quot;#基本语法&quot; class=&quot;headerlink&quot; title=&quot;基本语法&quot;&gt;&lt;/a&gt;基本语法&lt;/h3&gt;&lt;p&gt;Markdown是一种轻量级标记语言&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table</summary>
      
    
    
    
    <category term="Hexo" scheme="https://marvinliu1.github.io/categories/Hexo/"/>
    
    
    <category term="MarkDown" scheme="https://marvinliu1.github.io/tags/MarkDown/"/>
    
    <category term="Next" scheme="https://marvinliu1.github.io/tags/Next/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 8.2 Alinode</title>
    <link href="https://marvinliu1.github.io/2020/03/08/8.2%20alinode/"/>
    <id>https://marvinliu1.github.io/2020/03/08/8.2%20alinode/</id>
    <published>2020-03-08T07:12:31.000Z</published>
    <updated>2022-05-25T04:31:30.684Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><h2 id="8-2-1-什么是-alinode？"><a href="#8-2-1-什么是-alinode？" class="headerlink" title="8.2.1 什么是 alinode？"></a>8.2.1 什么是 alinode？</h2><blockquote><p>Node.js 性能平台（原 alinode）是面向中大型 Node.js 应用提供性能监控、安全提醒、故障排查、性能优化等服务的整体性解决方案。alinode 团队凭借对 Node.js 内核的深入理解，提供了完善的工具链和服务，协助客户主动、快速地发现和定位线上问题。</p></blockquote><h2 id="8-2-2-创建-alinode-应用"><a href="#8-2-2-创建-alinode-应用" class="headerlink" title="8.2.2 创建 alinode 应用"></a>8.2.2 创建 alinode 应用</h2><p>访问官网 <a href="https://www.aliyun.com/product/nodejs">https://www.aliyun.com/product/nodejs</a>，如未开通，则使用阿里云账号登录并免费开通即可。</p><p>登录后进入<a href="https://node.console.aliyun.com/">控制台</a>，单击 “创建新应用”，创建一个名为 test_alinode 的应用。</p><p>进入设置页面，如下所示：</p><p><img src="/./assets/8.2.1.png"></p><p>App ID 和 App Secret 后面会用到。</p><h2 id="8-2-3-安装-alinode"><a href="#8-2-3-安装-alinode" class="headerlink" title="8.2.3 安装 alinode"></a>8.2.3 安装 alinode</h2><p>alinode 的整套服务由 alinode 运行时、agenthub（原 agentx + commdx 命令集）和服务平台组成，所以在自己的服务器上部署时需要安装 alinode 运行时和 agenthub。</p><p>我们使用交互式一键安装 alinode 和 agenthub：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">uname</span> -a <span class="comment"># 阿里云 ECS Ubuntu@16.04</span></span><br><span class="line">Linux nswbmw 4.4.0-105-generic <span class="comment">#128-Ubuntu SMP Thu Dec 14 12:42:11 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">$ wget https://raw.githubusercontent.com/aliyun-node/alinode-all-in-one/master/alinode_all.sh</span><br><span class="line">$ bash -i alinode_all.sh <span class="comment"># App ID 和 App Secret 填写上面生成的</span></span><br><span class="line">...</span><br><span class="line">$ node -p <span class="string">&#x27;process.alinode&#x27;</span> <span class="comment"># 查看 alinode 版本</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：如果遇到 wget 报错 <code>wget: unable to resolve host address &#39;raw.githubusercontent.com&#39;</code>，需要修改 DNS 配置，在 &#x2F;etc&#x2F;resolv.conf 最上面添加 <code>nameserver 8.8.8.8</code>。</p><p>生成一个 yourconfig.json 配置文件，内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;agentserver.node.aliyun.com:8080&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;appid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;secret&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;logdir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reconnectDelay&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;heartbeatInterval&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reportInterval&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error_log&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;packages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>使用该配置启动 agenthub：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">nohup</span> agenthub yourconfig.json &amp;</span><br></pre></td></tr></table></figure><p>agenthub 将以常驻进程的方式运行。</p><p>下面通过两个例子使用 alinode 分别调试内存泄露和 CPU 性能瓶颈的问题。</p><h2 id="8-2-4-使用-alinode-诊断内存泄露"><a href="#8-2-4-使用-alinode-诊断内存泄露" class="headerlink" title="8.2.4 使用 alinode 诊断内存泄露"></a>8.2.4 使用 alinode 诊断内存泄露</h2><p>我们以一段内存泄露代码为例，演示如何使用 alinode 调试内存泄漏的问题。代码如下：</p><p><strong>server.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;koa-generic-session&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="property">keys</span> = [<span class="string">&#x27;some secret&#x27;</span>]</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1e6</span>).<span class="title function_">join</span>(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">session</span>.<span class="property">user</span> = <span class="keyword">new</span> <span class="title class_">User</span>()</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>这段代码内存泄露的原因是：koa-generic-session 默认将 session 信息存储到了内存中。</p><p><strong>client.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>打开两个终端，分别运行 ：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ENABLE_NODE_LOG=YES node server <span class="comment"># 开启 alinode 的 log 功能，使得 agenthub 可以监控内核级的性能数据</span></span><br><span class="line">$ node client <span class="comment"># 1s 发起一次请求</span></span><br></pre></td></tr></table></figure><p>过一会儿就可以在 alinode 控制台看到数据了，如下所示：</p><p><img src="/./assets/8.2.2.png"></p><p>可以看出，alinode 监控了：</p><ul><li>异常日志</li><li>慢 HTTP 日志</li><li>模块依赖</li><li>系统监控数据（包含非常详尽的图表数据，有 Memory、CPU、Load、QPS、GC、Apdex、Apdex detail、node 进程数、磁盘）</li></ul><p>单击 “堆快照” 生成一个 heapsnapshot 文件，单击左侧的 “文件”，查看刚才生成的堆快照：</p><p><img src="/./assets/8.2.3.png"></p><p>在转储后单击 “分析”，选择 “对象簇视图” 的树状列表，展开后如下所示：</p><p><img src="/./assets/8.2.4.png"></p><p><strong>可以看出</strong>：MemoryStore 的 sessions 对象中存储了 97 个 session，并且每个 session.user 上有一个 name 字段是长字符串。</p><h2 id="8-2-5-使用-alinode-诊断-CPU-性能瓶颈"><a href="#8-2-5-使用-alinode-诊断-CPU-性能瓶颈" class="headerlink" title="8.2.5 使用 alinode 诊断 CPU 性能瓶颈"></a>8.2.5 使用 alinode 诊断 CPU 性能瓶颈</h2><p>测试代码如下：</p><p><strong>server.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/encrypt&#x27;</span>, <span class="attr">controller</span>: <span class="keyword">function</span> <span class="title function_">encryptRouter</span> (ctx) &#123;</span><br><span class="line">  <span class="keyword">const</span> password = ctx.<span class="property">query</span>.<span class="property">password</span> || <span class="string">&#x27;test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> salt = crypto.<span class="title function_">randomBytes</span>(<span class="number">128</span>).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> encryptedPassword = crypto.<span class="title function_">pbkdf2Sync</span>(password, salt, <span class="number">10000</span>, <span class="number">64</span>, <span class="string">&#x27;sha512&#x27;</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  ctx.<span class="property">body</span> = encryptedPassword</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p><strong>client.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> tps = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tps; i++) &#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000/encrypt?password=123456&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Sent <span class="subst">$&#123;tps&#125;</span> requests`</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>打开两个终端，分别运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ENABLE_NODE_LOG=YES node server</span><br><span class="line">$ node client</span><br></pre></td></tr></table></figure><p>回到 alinode 控制台，单击 “CPU Profile”，然后到 “文件” 查看刚才生成的 cpuprofile 文件，转储后单击 “分析”，可以看到生成的火焰图。展开后如下所示：</p><p><img src="/./assets/8.2.5.png"></p><p><strong>可以看出</strong>：server.js 的第 5 行，即 encryptRouter 占用 CPU 较多，而 encryptRouter 里的 exports.pbkdf2Sync 占用了 encryptRouter 绝大部分 CPU 时间。</p><p>回到 “文件”，选择 “devtools 分析”，如下所示：</p><p><img src="/./assets/8.2.6.png"></p><p><strong>可以看出</strong>：alinode 已经帮我们把可疑的 CPU 性能瓶颈的元凶标红显示了。</p><p><strong>小提示</strong>：不管是生成的 heapsnapshot 还是 cpuprofile，都可以选择 “下载” 后使用 Chrome DevTools 分析。</p><p>我们在上面只演示了 “堆快照” 和 “CPU Profile” 的使用，alinode 支持抓取以下 5 种数据：</p><ul><li>堆快照</li><li>堆时间线</li><li>CPU Profile</li><li>GC Trace</li><li>Heap Profile</li></ul><p>本节就不一一演示了。</p><p>alinode 如此强大，而且免费使用，可以说是开发 Node.js 应用必不可少的好伙伴了。</p><h2 id="8-2-6-参考链接"><a href="#8-2-6-参考链接" class="headerlink" title="8.2.6 参考链接"></a>8.2.6 参考链接</h2><ul><li><a href="https://www.aliyun.com/product/nodejs">https://www.aliyun.com/product/nodejs</a></li><li><a href="https://github.com/aliyun-node/agenthub">https://github.com/aliyun-node/agenthub</a></li><li><a href="https://cnodejs.org/topic/561f289b4928c5872abc18ee">https://cnodejs.org/topic/561f289b4928c5872abc18ee</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/8.1%20node-clinic.md">8.1 node-clinic</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;8-2-1-什么是-alinode？&quot;&gt;&lt;a href=&quot;#8-2-1-什么是-alinode？&quot;</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 8.1 Node-clinic</title>
    <link href="https://marvinliu1.github.io/2020/02/01/8.1%20node-clinic/"/>
    <id>https://marvinliu1.github.io/2020/02/01/8.1%20node-clinic/</id>
    <published>2020-02-01T07:00:00.000Z</published>
    <updated>2022-05-25T04:30:57.228Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><h2 id="8-1-1-使用-node-clinic"><a href="#8-1-1-使用-node-clinic" class="headerlink" title="8.1.1 使用 node-clinic"></a>8.1.1 使用 node-clinic</h2><p><a href="https://github.com/nearform/node-clinic">node-clinic</a>（简称 clinic） 是一个开箱即用的 Node.js 应用诊断工具。</p><p>首先，安装 Node.js@9+</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nvm install 9</span><br></pre></td></tr></table></figure><p>全局安装 clinic：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i clinic -g</span><br></pre></td></tr></table></figure><p>创建测试代码：</p><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sleep</span> (ms) &#123;</span><br><span class="line">  <span class="keyword">const</span> future = <span class="title class_">Date</span>.<span class="title function_">now</span>() + ms</span><br><span class="line">  <span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() &lt; future);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">sleep</span>(<span class="number">50</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>使用 clinic doctor 启动并诊断 Node.js 应用：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clinic doctor -- node app.js</span><br></pre></td></tr></table></figure><p>使用 ab 压测：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -c 10 -n 200 <span class="string">&quot;http://localhost:3000/&quot;</span></span><br></pre></td></tr></table></figure><p>CTRL+C 终止测试程序，终端打印出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: Trace event is an experimental feature and could change at any time.</span><br><span class="line">^Canalysing data</span><br><span class="line">generated HTML file is 51485.clinic-doctor.html</span><br></pre></td></tr></table></figure><p>用浏览器打开 51485.clinic-doctor.html，如下所示：</p><p><img src="/./assets/8.1.1.png"></p><p><strong>可以看出</strong>：Event Loop 被阻塞，CPU Usage 也居高不下，一定是有 CPU 密集计算，与我们的测试代码吻合。</p><p>clinic 也给出了猜测和解决方案，我们尝试使用 clinic flame 生成火焰图：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clinic flame -- node app.js</span><br></pre></td></tr></table></figure><p>也可以用以下命令代替：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ clinic flame --collect-only -- node app.js <span class="comment"># 只收集数据</span></span><br><span class="line">$ clinic flame --visualize-only PID.flamegraph <span class="comment"># 将数据生成火焰图</span></span><br></pre></td></tr></table></figure><p>使用同样的 ab 命令压测后，生成的火焰图如下：</p><p><img src="/./assets/8.1.2.png"></p><p><strong>可以看出</strong>：app.js 第 4 行的 sleep 函数占用了大量的 CPU 计算。</p><h2 id="8-1-2-参考链接"><a href="#8-1-2-参考链接" class="headerlink" title="8.1.2 参考链接"></a>8.1.2 参考链接</h2><ul><li><a href="https://www.nearform.com/blog/introducing-node-clinic-a-performance-toolkit-for-node-js-developers/">https://www.nearform.com/blog/introducing-node-clinic-a-performance-toolkit-for-node-js-developers/</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/7.2%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8B).md">7.2 Telegraf + InfluxDB + Grafana(下)</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/8.2%20alinode.md">8.2 alinode</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;8-1-1-使用-node-clinic&quot;&gt;&lt;a href=&quot;#8-1-1-使用-node-cli</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 7.2 Telegraf + InfluxDB + Grafana(2)</title>
    <link href="https://marvinliu1.github.io/2019/11/28/7.2%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8B)/"/>
    <id>https://marvinliu1.github.io/2019/11/28/7.2%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8B)/</id>
    <published>2019-11-28T07:00:00.000Z</published>
    <updated>2022-05-25T04:31:46.056Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>上一小节主要讲解了 Telegraf(StatsD) + InfluxDB + Grafana 的搭建和基本用法，并创建了请求量和响应时间这两种图表。本节讲解几个高级用法：</p><ol><li>如何将 Grafana（监控）跟 ELK（日志）结合起来。</li><li>Grafana 监控报警。</li><li>脚本一键生成图表。</li></ol><h2 id="7-2-1-Grafana-ELK"><a href="#7-2-1-Grafana-ELK" class="headerlink" title="7.2.1 Grafana + ELK"></a>7.2.1 Grafana + ELK</h2><p>在观察 Grafana 监控时，我们发现某个 api 接口的响应时间突然有一个尖刺，这个时候想查一查到底是什么原因导致的。在前面介绍过 koa-await-breakpoint + ELK 的用法，是否可以结合 Grafana 使用呢？答案是可以的。</p><p>因为涉及的代码量大，所以笔者写了一个 demo 托管到了 GitHub 上，有两个 repo，分别为：</p><ul><li><a href="https://github.com/nswbmw/grafana-to-elk">grafana-to-elk</a>：包含 web server 和模拟请求的 client，分别将统计信息发送到 StatsD 和将日志发送到 ELK。</li><li><a href="https://github.com/nswbmw/grafana-to-elk-extension">grafana-to-elk-extension</a>：Chrome 扩展，作用是：<ul><li>格式化从 Grafana 跳转到 ELK 的时间范围。</li><li>添加 requestId 的链接。</li><li>高亮显示重要的字段。</li></ul></li></ul><p>首先 clone 到本地：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/nswbmw/grafana-to-elk.git</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/nswbmw/grafana-to-elk-extension.git</span><br></pre></td></tr></table></figure><p>测试步骤如下：</p><ol><li><p>按照 7.2 节启动 Telegraf（StatsD）+ InfluxDB + Grafana。</p></li><li><p>按照 6.3 节启动 ELK。</p></li><li><p>到 grafana-to-elk 目录下运行：</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i</span><br><span class="line">$ node server</span><br></pre></td></tr></table></figure><p>  打开另外一个终端运行：</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node client</span><br></pre></td></tr></table></figure><p>  此时，ELK 应该有日志了。</p></li><li><p>加载 Chrome 扩展。打开 Chrome 扩展程序页 -&gt; 加载已解压的扩展程序… -&gt; 加载 grafana-to-elk-extension（非测试环境下需要修改 manifest.json 的 matches 字段）。</p></li><li><p>回到 Grafana 的 “getHome 响应时间” 图表，进入编辑页的 General tab，如下填写：<br>  <img src="/./assets/7.2.1.png"><br>  在保存后，图表的左上角会出现一个类似分享的按钮，鼠标悬浮到上面出现 “Go to ELK”，单击它跳转到 ELK。</p></li><li><p>ELK 显示如下：<br>  <img src="/./assets/7.2.2.png">grafana-to-elk-extension 插件会自动处理并跳转到对应 Grafana 中的时间段并且查询出了我们关心的结果。单击第 1 个 requestId，将会跳转并显示该请求所有的日志，如下所示：<br>  <img src="/./assets/7.2.3.png"><br>  错误请求的日志如下：<br>  <img src="/./assets/7.2.4.png"></p></li></ol><h2 id="7-2-2-监控报警"><a href="#7-2-2-监控报警" class="headerlink" title="7.2.2 监控报警"></a>7.2.2 监控报警</h2><p>Grafana 有内置的监控报警，设置步骤如下：</p><ol><li>进入 Alerting -&gt; Notifications 页，单击 New Notification 添加新的报警组，如下所示：<br>  <img src="/./assets/7.2.5.png"></li><li>回到 “getHome 响应时间” 图表，进入编辑页的 Alert tab，单击 Create Alert 创建报警规则，如下所示：<br>  <img src="/./assets/7.2.6.png"><br>  <strong>报警规则为</strong>：每 60s 检查一次过去 1min 的 mean（B 在 Metrics 里面代表了别名为 mean 的折线图）折线图的平均值是否大于 50，如果是则触发报警。<br>  <strong>注意</strong>：如需发邮件，则需要设置 Grafana 的 <a href="http://docs.grafana.org/installation/configuration/#smtp">SMTP settings</a>。</li></ol><p>我们还可以给 “getHome 请求量” 设置错误报警监控，如下所示：</p><p><img src="/./assets/7.2.7.png"></p><p>每 60s 检查一次过去 1min 内是否有 400 报错，如果有则触发报警，其中 B 代表了别名为 400 的折线图。 </p><p><strong>小提示</strong>：报警信息可以发送到 Email、Slack、DingTalk 或者 Webhook 等等。报警的内容可以包含图表的截图，需要配置 <a href="http://docs.grafana.org/installation/configuration/#external-image-storage">external image uploader</a>。</p><p><strong>小提示</strong>：Grafana 配置文件在 &#x2F;etc&#x2F;grafana&#x2F;grafana.ini，如需修改步骤如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it docker-statsd-influxdb-grafana bash <span class="comment"># 进入 docker 容器</span></span><br><span class="line">$ apt update</span><br><span class="line">$ apt install vim</span><br><span class="line">$ vim /etc/grafana/grafana.ini</span><br></pre></td></tr></table></figure><h2 id="7-2-3-脚本一键生成图表"><a href="#7-2-3-脚本一键生成图表" class="headerlink" title="7.2.3 脚本一键生成图表"></a>7.2.3 脚本一键生成图表</h2><p>我们只创建了一个接口的两种（请求量和响应时间）图表，每个图表要设置 link、alert 等等就很麻烦了。如果我们的 api 有几百个接口，岂不成了灾难了。</p><p>Grafana 虽然有 Template 的功能，但我们接下来讲一个奇技淫巧。</p><p>我们在保存图表的时候从 Chrome DevTools 的 Network 看到发起了一个 Ajax 请求，如下所示：</p><p><img src="/./assets/7.2.8.png"></p><p>dashboard 就是包含了当前仪表盘页所有图表的完整 JSON，其中：</p><ul><li>dashboard：包含一到多行 row。</li><li>rows：一行 row 包含一到多个 panel。</li><li>panels：一个 panel 是一个具体的图表。</li></ul><p>在拿到这个 JSON 后，我们就可以不断地尝试修改它，然后用 axios 带上浏览器拿到的 Cookie 发送到图中的 URL，模拟浏览器的保存操作，这里就不再展开讲解了。</p><h2 id="7-2-4-参考链接"><a href="#7-2-4-参考链接" class="headerlink" title="7.2.4 参考链接"></a>7.2.4 参考链接</h2><ul><li><a href="http://docs.grafana.org/alerting/notifications/">http://docs.grafana.org/alerting/notifications/</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/7.1%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8A).md">7.1 Telegraf + InfluxDB + Grafana(上)</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/8.1%20node-clinic.md">8.1 node-clinic</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上一小节主要讲解了 Telegraf(StatsD) + InfluxDB + Grafana 的搭建和基本</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 7.1 Telegraf + InfluxDB + Grafana(1)</title>
    <link href="https://marvinliu1.github.io/2019/11/26/7.1%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8A)/"/>
    <id>https://marvinliu1.github.io/2019/11/26/7.1%20Telegraf%20+%20InfluxDB%20+%20Grafana(%E4%B8%8A)/</id>
    <published>2019-11-26T07:00:00.000Z</published>
    <updated>2022-05-25T04:30:08.253Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>本节将会讲解如何使用 Telegraf(StatsD) + InfluxDB + Grafana 搭建一套完整的监控系统。</p><h2 id="7-1-1-Telegraf-StatsD-InfluxDB-Grafana-简介"><a href="#7-1-1-Telegraf-StatsD-InfluxDB-Grafana-简介" class="headerlink" title="7.1.1 Telegraf(StatsD) + InfluxDB + Grafana 简介"></a>7.1.1 Telegraf(StatsD) + InfluxDB + Grafana 简介</h2><p><a href="https://github.com/influxdata/telegraf">Telegraf</a> 是一个使用 Go 语言开发的代理程序，可收集系统和服务或者其他来源（inputs）的数据，并将其写入 InfluxDB（outputs）数据库，支持多种 inputs 和 outputs 插件。<a href="https://github.com/etsy/statsd">StatsD</a> 是一个使用 Node.js 开发的网络守护进程，通过 UDP 或者 TCP 方式收集各种统计信息，包括计数器和定时器等。</p><p><a href="https://github.com/influxdata/influxdb">InfluxDB</a> 是一个使用 Go 语言开发的开源的分布式时序、事件和指标数据库，无需外部依赖，其设计目标是实现分布式和水平伸缩扩展。</p><p><a href="https://github.com/grafana/grafana">Grafana</a> 是一个使用 Angular + Go 语言开发的开源的、功能齐全的、漂亮的仪表盘和图表的编辑器，可用来做日志的分析与展示曲线图（如 api 的请求日志），支持多种 backend，如 ElasticSearch、InfluxDB、OpenTSDB 等等。</p><p><strong>工作流程</strong>：Telegraf 将 StatsD（inputs）和 InfluxDB（outputs）结合起来，即发往 StatsD 的数据，最终通过 Telegraf 写入了 InfluxDB，然后 Grafana 读取 InfluxDB 的数据展示成图表。</p><h2 id="7-1-2-启动-docker-statsd-influxdb-grafana"><a href="#7-1-2-启动-docker-statsd-influxdb-grafana" class="headerlink" title="7.1.2 启动 docker-statsd-influxdb-grafana"></a>7.1.2 启动 docker-statsd-influxdb-grafana</h2><p>我们使用 Docker 一键启动 Telegraf(StatsD)+ InfluxDB + Grafana，节省搭建环境的时间。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name docker-statsd-influxdb-grafana \</span><br><span class="line">  -p 3003:3003 \</span><br><span class="line">  -p 3004:8083 \</span><br><span class="line">  -p 8086:8086 \</span><br><span class="line">  -p 22022:22 \</span><br><span class="line">  -p 8125:8125/udp \</span><br><span class="line">  samuelebistoletti/docker-statsd-influxdb-grafana:latest</span><br></pre></td></tr></table></figure><p>端口映射关系如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Host        Container       Service</span><br><span class="line">-----------------------------------</span><br><span class="line">3003        3003            grafana</span><br><span class="line">3004        8083            influxdb-admin</span><br><span class="line">8086        8086            influxdb</span><br><span class="line">8125        8125            statsd</span><br><span class="line">22022       22              sshd</span><br></pre></td></tr></table></figure><h2 id="7-1-3-熟悉-InfluxDB"><a href="#7-1-3-熟悉-InfluxDB" class="headerlink" title="7.1.3 熟悉 InfluxDB"></a>7.1.3 熟悉 InfluxDB</h2><p>容器启动后，浏览器访问 localhost:3004（以下称为 influxdb-admin），如下所示：</p><p><img src="/./assets/7.1.1.png"></p><p>InfluxDB 的基本概念如下：</p><ul><li>database：数据库。</li><li>measurement：数据库中的表。</li><li>point：表里面的一行数据，由时间戳（time）、数据（field）和标签（tag）组成<ul><li>time：每条数据记录的时间戳，是数据库中的主索引（会自动生成）。</li><li>field：各种记录的值（没有索引的属性）。</li><li>tag：各种有索引的属性。</li></ul></li><li>…</li></ul><p>InfluxDB 采用了类 SQL 的查询语法，例如：</p><ul><li>show databases：列出所有数据库。</li><li>show measurements：列出当前数据库的所有表。</li><li>select * from xxx：列出 xxx 表的所有数据。</li><li>…</li></ul><p>我们在 Query 中输入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases</span><br></pre></td></tr></table></figure><p>查询结果如下：</p><p><img src="/./assets/7.1.2.png"></p><p>_interal 是 InfluxDB 内部使用的数据库，telegraf 是我们当前 Docker 容器启动后默认创建的测试数据库。</p><h2 id="7-1-4-配置-Grafana"><a href="#7-1-4-配置-Grafana" class="headerlink" title="7.1.4 配置 Grafana"></a>7.1.4 配置 Grafana</h2><p>用浏览器打开 localhost:3003，如下所示：</p><p><img src="/./assets/7.1.3.png"></p><p>输入用户名 root 和密码 root 登录，进入初始化配置页，单击 “Add data source”，如下填写：</p><p><img src="/./assets/7.1.4.png"></p><p>单击 “Save &amp; Test” 保存配置。目前配置好了 Grafana 默认的 datasource 是名为 api 的 InfluxDB，接下来创建测试代码，产生测试数据。</p><h2 id="7-1-5-node-statsd"><a href="#7-1-5-node-statsd" class="headerlink" title="7.1.5 node-statsd"></a>7.1.5 node-statsd</h2><p><a href="https://github.com/sivy/node-statsd">node-statsd</a> 是一个 statsd 的 Node.js client。创建以下测试代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">StatsD</span> = <span class="built_in">require</span>(<span class="string">&#x27;node-statsd&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> statsdClient = <span class="keyword">new</span> <span class="title class_">StatsD</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8125</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> responseTime = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span>)</span><br><span class="line">  statsdClient.<span class="title function_">timing</span>(<span class="string">&#x27;api&#x27;</span>, responseTime, <span class="keyword">function</span> (<span class="params">error, bytes</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Successfully sent <span class="subst">$&#123;bytes&#125;</span> bytes, responseTime <span class="subst">$&#123;responseTime&#125;</span>ms`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>运行以上代码，每一秒钟会产生一个 0~99 之间的随机值（模拟响应时间，单位为毫秒），发送到 StatsD，StatsD 会通过 Telegraf 将这些数据写入 InfluxDB 的 telegraf 数据库。</p><p>回到 influxdb-admin，单击右上角的下拉菜单切换到 telegraf 数据库，然后输入 <code>show measurements </code> 查看已经存在 api 表了，然后输入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> api</span><br></pre></td></tr></table></figure><p>查询结果如下：</p><p><img src="/./assets/7.1.5.png"></p><p>可以看出 api 表有以下几个字段：</p><ul><li>time：InfluxDB 默认添加的时间戳。</li><li>90_percentile：所有记录中从小到大 90% 那个点的值。</li><li>count：一次收集的日志数量，可以看出每条记录（point）的 count 值接近或等于 10，而我们的测试代码是 1s 发送一条数据，也就说明 Telegraf 默认设置是 10s 收集一次数据，默认配置也的确是这样的，见：<a href="https://github.com/samuelebistoletti/docker-statsd-influxdb-grafana/blob/master/telegraf/telegraf.conf">https://github.com/samuelebistoletti/docker-statsd-influxdb-grafana/blob/master/telegraf/telegraf.conf</a>。</li><li>host：机器地址。</li><li>lower：最小的那条记录的值。</li><li>mean：所有记录的平均值。</li><li>metric_type：metric 类型。</li><li>stddev：所有记录的标准差。</li><li>upper：最大的那条记录的值。</li></ul><h2 id="7-1-6-创建-Grafana-图表"><a href="#7-1-6-创建-Grafana-图表" class="headerlink" title="7.1.6 创建 Grafana 图表"></a>7.1.6 创建 Grafana 图表</h2><p>回到 Grafana，单击左上角 Grafana 图标的下拉菜单，单击 Dashboards 回到仪表盘页继续完成配置，单击 “New dashboard”，然后单击创建 Graph 类型的图表，就创建了一个空的图表，如下所示：</p><p><img src="/./assets/7.1.6.png"></p><p>单击当前的图表，选择 Edit，修改如下几个地方：</p><ol><li>Metrics 配置中选择 FROM -&gt; api 表，SELECT -&gt; field(mean) 字段。</li><li>Display 配置中 “Null value” 选择 connected，将每个点连成折线。</li></ol><p>效果如下所示：</p><p><img src="/./assets/7.1.7.png"></p><h2 id="7-1-7-模拟真实环境"><a href="#7-1-7-模拟真实环境" class="headerlink" title="7.1.7 模拟真实环境"></a>7.1.7 模拟真实环境</h2><p><strong>middlewares&#x2F;statsd.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">StatsD</span> = <span class="built_in">require</span>(<span class="string">&#x27;node-statsd&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> statsdClient = <span class="keyword">new</span> <span class="title class_">StatsD</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8125</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">routerName</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">statsdMiddleware</span> (ctx, next) &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">      <span class="keyword">const</span> spent = <span class="title class_">Date</span>.<span class="title function_">now</span>() - start</span><br><span class="line">      statsdClient.<span class="title function_">timing</span>(<span class="string">`api_<span class="subst">$&#123;routerName&#125;</span>`</span>, spent)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      statsdClient.<span class="title function_">increment</span>(<span class="string">`api_<span class="subst">$&#123;routerName&#125;</span>_<span class="subst">$&#123;e.status || (ctx.status !== <span class="number">404</span> ? ctx.status : <span class="number">500</span>)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>server.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Bluebird</span> = <span class="built_in">require</span>(<span class="string">&#x27;bluebird&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> statsd = <span class="built_in">require</span>(<span class="string">&#x27;./middlewares/statsd&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">controller</span>: [</span><br><span class="line">  <span class="title function_">statsd</span>(<span class="string">&#x27;getHome&#x27;</span>),</span><br><span class="line">  <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 模拟十分之一出错概率</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">0.1</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">400</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 模拟 1-100 毫秒响应时间</span></span><br><span class="line">    <span class="keyword">const</span> responseTime = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span> + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Bluebird</span>.<span class="title function_">delay</span>(responseTime)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Spent <span class="subst">$&#123;responseTime&#125;</span>ms`</span>)</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">  &#125;</span><br><span class="line">]&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p><strong>client.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 模拟 1-10 的 tps</span></span><br><span class="line">  <span class="keyword">const</span> tps = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span> + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tps; i++) &#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:3000&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>打开两个终端，分别运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js</span><br><span class="line">$ node client.js</span><br></pre></td></tr></table></figure><p>回到 influxdb-admin，输入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> measurements</span><br></pre></td></tr></table></figure><p>可以看到已经有 api_getHome 和 api_getHome_400 表了。回到 Grafana，在一行（row）里创建两个图表，分别为：</p><ul><li>请求量：包含了正常请求（200）和错误请求（4xx、5xx 等等）请求量的折线图。</li><li>响应时间：正常请求的最低（lower）、平均（mean）、最高（upper）响应时间的折线图。</li></ul><p><img src="/./assets/7.1.8.png"></p><p>以 “getHome 响应时间” 的图表为例，Metrics 配置截图如下：</p><p><img src="/./assets/7.1.9.png"></p><h2 id="7-1-8-参考链接"><a href="#7-1-8-参考链接" class="headerlink" title="7.1.8 参考链接"></a>7.1.8 参考链接</h2><ul><li><a href="https://www.cnblogs.com/shhnwangjian/p/6897216.html">https://www.cnblogs.com/shhnwangjian/p/6897216.html</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.5%20Sentry.md">6.5 Sentry</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/7.2%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8B).md">7.2 Telegraf + InfluxDB + Grafana(下)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本节将会讲解如何使用 Telegraf(StatsD) + InfluxDB + Grafana 搭建一套完</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 6.5 Sentry</title>
    <link href="https://marvinliu1.github.io/2019/11/03/6.5%20Sentry/"/>
    <id>https://marvinliu1.github.io/2019/11/03/6.5%20Sentry/</id>
    <published>2019-11-03T06:00:00.000Z</published>
    <updated>2022-05-25T04:29:30.953Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><h2 id="6-5-1-什么是-Sentry？"><a href="#6-5-1-什么是-Sentry？" class="headerlink" title="6.5.1 什么是 Sentry？"></a>6.5.1 什么是 Sentry？</h2><p>Sentry<a href="sentry.io">官网</a>的介绍：</p><blockquote><p>Sentry’s real-time error tracking gives you insight into production deployments and information to reproduce and fix crashes.</p></blockquote><p><strong>简而言之</strong>：Sentry 是一个开源的实时错误日志收集平台。</p><h2 id="6-5-2-安装-Sentry"><a href="#6-5-2-安装-Sentry" class="headerlink" title="6.5.2 安装 Sentry"></a>6.5.2 安装 Sentry</h2><p>我们使用 Docker 安装并启动 Sentry，步骤如下：</p><ol><li><p>启动一个 Redis 容器，命名为 sentry-redis：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name sentry-redis redis</span><br></pre></td></tr></table></figure></li><li><p>启动一个 Postgres 容器，命名为 sentry-postgres：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name sentry-postgres \</span><br><span class="line">  -e POSTGRES_PASSWORD=secret \</span><br><span class="line">  -e POSTGRES_USER=sentry \</span><br><span class="line">  postgres</span><br></pre></td></tr></table></figure></li><li><p>生成一个 Sentry 的 secret key：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --<span class="built_in">rm</span> sentry config generate-secret-key</span><br></pre></td></tr></table></figure><p>将下面的 &lt;secret-key&gt; 都替换成上面生成的 secret key。</p></li><li><p>如果是新的数据库（第 1 次运行），则需要运行 upgrade：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --<span class="built_in">rm</span> \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  sentry upgrade</span><br></pre></td></tr></table></figure><p>按步骤填写自己的信息：</p><p><img src="/./assets/6.5.1.jpg"></p><p>最终创建了一个超级管理员和一个默认的名为 sentry 的组织（organization）。</p></li><li><p>启动 Sentry，并对外暴露 9000 端口：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name my-sentry \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  -p 9000:9000 \</span><br><span class="line">  sentry</span><br></pre></td></tr></table></figure></li><li><p>启动 Celery cron 和 Celery workers：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name sentry-cron \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  sentry run cron</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name sentry-worker-1 \</span><br><span class="line">  -e SENTRY_SECRET_KEY=<span class="string">&#x27;&lt;secret-key&gt;&#x27;</span> \</span><br><span class="line">  --<span class="built_in">link</span> sentry-postgres:postgres \</span><br><span class="line">  --<span class="built_in">link</span> sentry-redis:redis \</span><br><span class="line">  sentry run worker</span><br></pre></td></tr></table></figure><p><strong>小提示</strong>：Celery 是用 Python 写的一个分布式任务调度模块。</p></li><li><p>完成！</p></li></ol><p>用浏览器打开 localhost:9000，就能看到 Sentry 的登录页面了，如下所示：</p><p><img src="/./assets/6.5.2.jpg"></p><p>首次登录时需要填写一些必要信息 ，如下所示：</p><p><img src="/./assets/6.5.3.png"></p><p>单击 Continue 进入 Sentry 仪表盘（Dashboard）。单击右上角的 New Project 按钮创建一个项目，选择 Node.js 并填写项目名称为 API，然后单击 Create Project 按钮创建项目。如下所示：</p><p><img src="/./assets/6.5.4.png"></p><p>创建成功后进入 Node.js 使用示例页面，我们选择使用 Koa 测试，在右侧选择 Koa：</p><p><img src="/./assets/6.5.5.png"></p><p>上图所示是 koa@1 的示例代码，我们以 Paloma（基于  koa@2）为例，编写测试代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Raven</span> = <span class="built_in">require</span>(<span class="string">&#x27;raven&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line"><span class="title class_">Raven</span>.<span class="title function_">config</span>(<span class="variable constant_">DSN</span>).<span class="title function_">install</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Raven</span>.<span class="title function_">captureException</span>(err, <span class="function">(<span class="params">err, eventId</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Reported error &#x27;</span> + eventId)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>raven 是 Node.js 版的 Sentry SDK，用来收集和发送错误日志。</p><p><strong>小提示</strong>：将 DSN 替换为上图中的 <code>http://xxx@localhost:9000/2</code>，DSN 既告诉客户端 Sentry 服务器的地址，也用来当做身份认证的 token。</p><p>运行以上测试代码，访问 localhost:3000，错误信息会发送给 Sentry。Sentry 展示如下：</p><p><img src="/./assets/6.5.6.png"></p><p>点进去可以看到详细的信息：</p><p><img src="/./assets/6.5.7.png"></p><p>Sentry 还有许多功能，比如：错误归类、展示错误的频率柱状图、将错误指派给组织中的某个人、给错误添加标签、查看这类错误事件的历史、标记错误为已解决、在错误下发表评论、警报等等功能。</p><h2 id="6-5-3-koa-raven"><a href="#6-5-3-koa-raven" class="headerlink" title="6.5.3 koa-raven"></a>6.5.3 koa-raven</h2><p>笔者将 raven 封装成 Koa 的一个中间件。使用如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> raven = <span class="built_in">require</span>(<span class="string">&#x27;koa-raven&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">raven</span>(<span class="variable constant_">DSN</span>))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>或者使用 ctx.raven：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> raven = <span class="built_in">require</span>(<span class="string">&#x27;koa-raven&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">raven</span>(<span class="variable constant_">DSN</span>))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    ctx.<span class="property">raven</span>.<span class="title function_">captureException</span>(e, &#123; <span class="attr">extra</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;tom&#x27;</span> &#125; &#125;)</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">500</span></span><br><span class="line">    ctx.<span class="property">body</span> = e.<span class="property">stack</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><h2 id="6-5-4-参考链接"><a href="#6-5-4-参考链接" class="headerlink" title="6.5.4 参考链接"></a>6.5.4 参考链接</h2><ul><li><a href="https://sentry.io/">https://sentry.io/</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.4%20OpenTracing%20%2B%20Jaeger.md">6.4 OpenTracing + Jaeger</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/7.1%20Telegraf%20%2B%20InfluxDB%20%2B%20Grafana(%E4%B8%8A).md">7.1 Telegraf + InfluxDB + Grafana(上)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;6-5-1-什么是-Sentry？&quot;&gt;&lt;a href=&quot;#6-5-1-什么是-Sentry？&quot; c</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 6.4 OpenTracing + Jaeger</title>
    <link href="https://marvinliu1.github.io/2019/10/28/6.4%20OpenTracing%20+%20Jaeger/"/>
    <id>https://marvinliu1.github.io/2019/10/28/6.4%20OpenTracing%20+%20Jaeger/</id>
    <published>2019-10-28T06:00:00.000Z</published>
    <updated>2022-05-25T04:29:03.625Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><h2 id="6-4-1-什么是-OpenTracing？"><a href="#6-4-1-什么是-OpenTracing？" class="headerlink" title="6.4.1 什么是 OpenTracing？"></a>6.4.1 什么是 OpenTracing？</h2><p><a href="http://opentracing.io/">OpenTracing</a> 是一个分布式追踪规范。OpenTracing 通过提供平台无关、厂商无关的 API，为分布式追踪提供统一的概念和数据标准，使得开发人员能够方便的添加（或更换）追踪系统的实现。OpenTracing 定义了如下几个术语：</p><ul><li>Span：代表了系统中的一个逻辑工作单元，它具有操作名、操作开始时间以及持续时长。Span 可能会有嵌套或排序，从而对因果关系建模。<ul><li>Tags：每个 Span 可以有多个键值对（key: value）形式的 Tags，Tags 是没有时间戳的，支持简单地对 Span 进行注解和补充。</li><li>Logs：每个 Span 可以进行多次 Log 操作，每一次 Log 操作，都需要一个带时间戳的时间名称，以及可选的任意大小的存储结构。</li></ul></li><li>Trace：代表了系统中的一个数据&#x2F;执行路径（一个或多个 Span），可以将其理解为 Span 的有向无环图。</li></ul><p>OpenTracing 还有其他一些概念，这里不过多解释。我们看个传统的调用关系例子，如下所示：</p><p><img src="/./assets/6.4.1.jpg"></p><blockquote><p>在一个分布式系统中，追踪一个事务或者调用流一般如上图所示。虽然这种图对于看清各组件的组合关系是很有用的，但是，它不能很好显示组件的调用时间，以及是串行调用还是并行调用。如果展现更复杂的调用关系，会更加复杂，甚至无法画出这样的图。另外，这种图也无法显示调用间的时间间隔以及是否通过定时调用来启动调用。一种更有效的展现一个典型的 trace 过程，如下图所示：</p></blockquote><p><img src="/./assets/6.4.2.jpg"></p><blockquote><p>这种展现方式增加了执行时间的上下文，相关服务间的层次关系，进程或者任务的串行或并行调用关系。这样的视图有助于发现系统调用的关键路径。通过关注关键路径的执行过程，项目团队可能专注于优化路径中的关键位置，最大幅度地提升系统的性能。例如：可以通过追踪一个资源定位的调用情况，明确底层的调用情况，发现哪些操作有阻塞的情况。</p></blockquote><h2 id="6-4-2-什么是-Jaeger"><a href="#6-4-2-什么是-Jaeger" class="headerlink" title="6.4.2 什么是 Jaeger?"></a>6.4.2 什么是 Jaeger?</h2><p>Jaeger 是 OpenTracing 的一个实现，是 Uber 开源的一个分布式追踪系统，其灵感来源于Dapper 和 OpenZipkin。从 2016 年开始，该系统已经在 Uber 内部得到了广泛的应用，它可以用于微服务架构应用的监控，特性包括分布式上下文传播（Distributed context propagation）、分布式事务监控、根原因分析、服务依赖分析以及性能优化。该项目已经被云原生计算基金会（Cloud Native Computing Foundation，CNCF）接纳为第 12 个项目。</p><h2 id="6-4-3-启动-Jaeger-Jaeger-UI"><a href="#6-4-3-启动-Jaeger-Jaeger-UI" class="headerlink" title="6.4.3 启动 Jaeger + Jaeger UI"></a>6.4.3 启动 Jaeger + Jaeger UI</h2><p>我们使用 Docker 启动 Jaeger + Jaeger UI（Jaeger 可视化 web 控制台），运行如下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p5775:5775/udp \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  jaegertracing/all-in-one:latest</span><br></pre></td></tr></table></figure><p>用浏览器打开 localhost:16686，如下所示：</p><p><img src="/./assets/6.4.3.jpg"></p><p>现在并没有任何数据，接下来我们看看如何使用 Jaeger 接收并查询日志。</p><h2 id="6-4-4-如何使用-OpenTracing-Jaeger"><a href="#6-4-4-如何使用-OpenTracing-Jaeger" class="headerlink" title="6.4.4 如何使用 OpenTracing + Jaeger?"></a>6.4.4 如何使用 OpenTracing + Jaeger?</h2><p>OpenTracing 和 Jaeger 分别提供了 JavaScript&#x2F;Node.js 的 SDK：</p><ul><li><a href="https://github.com/opentracing/opentracing-javascript">opentracing&#x2F;opentracing-javascript</a></li><li><a href="https://github.com/jaegertracing/jaeger-client-node">jaegertracing&#x2F;jaeger-client-node</a></li></ul><p>opentracing 示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> opentracing = <span class="built_in">require</span>(<span class="string">&#x27;opentracing&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> the default OpenTracing tracer does not record any tracing information.</span></span><br><span class="line"><span class="comment">// Replace this line with the tracer implementation of your choice.</span></span><br><span class="line"><span class="keyword">const</span> tracer = <span class="keyword">new</span> opentracing.<span class="title class_">Tracer</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> span = tracer.<span class="title function_">startSpan</span>(<span class="string">&#x27;http_request&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> opts = &#123;</span><br><span class="line">  host : <span class="string">&#x27;example.com&#x27;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  port : <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">http.<span class="title function_">request</span>(opts, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// assuming no retries, mark the span as failed</span></span><br><span class="line">    span.<span class="title function_">setTag</span>(opentracing.<span class="property">Tags</span>.<span class="property">ERROR</span>, <span class="literal">true</span>)</span><br><span class="line">    span.<span class="title function_">log</span>(&#123;<span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;error.object&#x27;</span>: err, <span class="string">&#x27;message&#x27;</span>: err.<span class="property">message</span>, <span class="string">&#x27;stack&#x27;</span>: err.<span class="property">stack</span>&#125;)</span><br><span class="line">    span.<span class="title function_">finish</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123;</span><br><span class="line">    span.<span class="title function_">log</span>(&#123;<span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;data_received&#x27;</span>, <span class="string">&#x27;chunk_length&#x27;</span>: chunk.<span class="property">length</span>&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  res.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    span.<span class="title function_">log</span>(&#123;<span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;request_end&#x27;</span>&#125;)</span><br><span class="line">    span.<span class="title function_">finish</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).<span class="title function_">end</span>()</span><br></pre></td></tr></table></figure><p>有以下两点需要解释：</p><ol><li>需要将上面的 <code>const tracer = new opentracing.Tracer()</code> 替换成自己的 tracer 实现，即 Jaeger 的实现。</li><li>通过 tracer.startSpan 启动一个 Span，span.setTag 用来设置 Tags，span.log 用来设置 Logs，span.finish 用来结束一个 Span。</li></ol><p>这有点类似于我们的手动埋点，只不过变成了一个规范而已。但 OpenTracing 的功能不止如此，上面只是一个 Span 的用法，Span 之间还可以关联调用关系，最后得到一个 DAG（有向无环图）。</p><p><strong>举个例子</strong>：假如我们正在做微服务，多个服务之间有调用关系（不管是 HTTP 还是 RPC 等），每次调用服务在内部可能产生多个 Span，最终会在 Jaeger 控制台页面看到一个完整的 Trace 和 DAG 图（微服务之间的调用关系）。</p><p>jaeger-client-node 使用如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tracer = <span class="keyword">new</span> jaeger.<span class="title class_">Tracer</span>(</span><br><span class="line">  serviceName,</span><br><span class="line">  <span class="keyword">new</span> jaeger.<span class="title class_">RemoteReporter</span>(<span class="keyword">new</span> <span class="title class_">UDPSender</span>()),</span><br><span class="line">  <span class="keyword">new</span> jaeger.<span class="title class_">RateLimitingSampler</span>(<span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>创建一个 tracer，可以接收 3 个参数：</p><ol><li>serviceName：服务名。</li><li>Reporter：上报器，即往哪发日志，如上述代码是通过 UDP 发送日志，默认地址 localhost:6832。</li><li>Sampler：采样器，即日志如何采样，如上述代码是限制 1 秒采样一次。</li></ol><p>这里不再详细介绍其它选项，读者可自行去查阅 jaeger-client-node 的文档。</p><h2 id="6-4-5-koa-await-breakpoint-jaeger"><a href="#6-4-5-koa-await-breakpoint-jaeger" class="headerlink" title="6.4.5 koa-await-breakpoint-jaeger"></a>6.4.5 koa-await-breakpoint-jaeger</h2><p>通过上面的例子我们知道，在使用 Jaeger 时需要手动埋点。前面我们介绍了 koa-await-breakpoint 日志自动打点，可自定义 store，koa-await-breakpoint-jaeger 是为 koa-await-breakpoint 写的 store 的 adaptor，在实现上有一些小技巧，有兴趣的读者可以去读下源码。</p><p>还是以 koa-await-breakpoint 的 example 举例，只添加了两行代码引入 jaeger 的使用。代码如下：</p><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">JaegerStore</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint-jaeger&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>],</span><br><span class="line">  <span class="attr">store</span>: <span class="keyword">new</span> <span class="title class_">JaegerStore</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure><p>刷新 localhost:16686，可以看到已经有日志了，如下所示：</p><p><img src="/./assets/6.4.4.jpg"></p><p>选择 Sercice -&gt; api，Operation -&gt; POST &#x2F;users，单击 Find Traces 查看所有结果，右侧展示了一条日志，点进去如下所示：</p><p><img src="/./assets/6.4.5.jpg"></p><p><strong>小提示</strong>：可以根据 tags 过滤结果。</p><p><strong>注意</strong>：Jaeger 是分布式追踪系统，通常用来追踪多个服务之间的调用关系，而这里用来追踪一个服务的多个函数之间的调用关系。</p><p>修改 routes&#x2F;user.js 的 createComment 函数 throw 一个 <code>new Error(&#39;test&#39;)</code>，重新运行，如下所示：</p><p><img src="/./assets/6.4.6.jpg"></p><p>可以看出，Jaeger 完美地展现了在一个请求到来时，函数之间的调用关系、层级关系及耗时，甚至函数体和错误栈都有！然后，我们可以用 requestId 去 ELK 中查询日志了。</p><h2 id="6-4-6-参考链接"><a href="#6-4-6-参考链接" class="headerlink" title="6.4.6 参考链接"></a>6.4.6 参考链接</h2><ul><li><a href="https://wu-sheng.gitbooks.io/opentracing-io/content/">https://wu-sheng.gitbooks.io/opentracing-io/content/</a></li><li><a href="https://segmentfault.com/a/1190000008895129">https://segmentfault.com/a/1190000008895129</a></li><li><a href="http://www.infoq.com/cn/news/2017/11/Uber-open-spurce-Jaeger">http://www.infoq.com/cn/news/2017/11/Uber-open-spurce-Jaeger</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.3%20ELK.md">6.3 ELK</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.5%20Sentry.md">6.5 Sentry</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;6-4-1-什么是-OpenTracing？&quot;&gt;&lt;a href=&quot;#6-4-1-什么是-OpenT</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 6.3 ELK</title>
    <link href="https://marvinliu1.github.io/2019/10/15/6.3%20ELK/"/>
    <id>https://marvinliu1.github.io/2019/10/15/6.3%20ELK/</id>
    <published>2019-10-15T06:00:00.000Z</published>
    <updated>2022-05-25T04:28:29.086Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>ELK 是 ElasticSearch + Logstash + Kibana 这套组合工具的简称，是一个常用的日志系统。</p><ul><li>ElasticSearch：是一款开源的基于 Lucene 之上实现的一个分布式搜索引擎，也是一个存储引擎（例如：日志），它的特点有：分布式、零配置、自动发现、索引自动分片、索引副本机制、Restful 风格的接口、多数据源和自动搜索负载等。</li><li>Logstash：是一款开源的日志收集工具，它可以对日志进行收集、分析、过滤，并将其存储（例如：ElasticSearch）起来供以后使用。</li><li>Kibana：是一款开源的可视化工具，可以为 ElasticSearch 提供的日志分析友好的 Web 界面，可以汇总、分析和搜索重要的数据日志。</li></ul><h2 id="6-3-1-安装-ELK"><a href="#6-3-1-安装-ELK" class="headerlink" title="6.3.1 安装 ELK"></a>6.3.1 安装 ELK</h2><p>我们使用 Docker 安装 ELK，运行如下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 5601:5601 \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 5044:5044 \</span><br><span class="line">    -p 15044:15044/udp \</span><br><span class="line">    -it --name elk sebp/elk</span><br></pre></td></tr></table></figure><p>进入容器：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it elk /bin/bash</span><br></pre></td></tr></table></figure><p>运行以下命令设置 logstash 的 input 和 output：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /opt/logstash/bin/logstash --path.data /tmp/logstash/data \</span></span><br><span class="line">  -e <span class="string">&#x27;input &#123; udp &#123; codec =&gt; &quot;json&quot; port =&gt; 15044 &#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; [&quot;localhost&quot;] &#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>这里我们启动一个 15044 的 UDP 端口，用来接收通过 UDP 发送到 Logstash 的日志。</p><p>用浏览器打开 localhost:5601，如下所示：</p><p><img src="/./assets/6.3.1.png"></p><p>目前还没有指定 index（ElasticSearch 的 index 类似于 MySQL&#x2F;MongoDB 中的 database），即日志来源。下面我们尝试向 ELK 中写入一些日志。</p><h2 id="6-3-2-使用-ELK"><a href="#6-3-2-使用-ELK" class="headerlink" title="6.3.2 使用 ELK"></a>6.3.2 使用 ELK</h2><p>这里仍然以使用 koa-await-breakpoint 为例，来演示如何将日志发送到 ELK。</p><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>],</span><br><span class="line">  <span class="attr">store</span>: <span class="built_in">require</span>(<span class="string">&#x27;./logger&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p><strong>logger.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Logstash</span> = <span class="built_in">require</span>(<span class="string">&#x27;logstash-client&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logstash = <span class="keyword">new</span> <span class="title class_">Logstash</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;udp&#x27;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">15044</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  save (log) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.<span class="property">error</span>) &#123;</span><br><span class="line">      log.<span class="property">errMsg</span> = log.<span class="property">error</span>.<span class="property">message</span></span><br><span class="line">      log.<span class="property">errStack</span> = log.<span class="property">error</span>.<span class="property">stack</span></span><br><span class="line">    &#125;</span><br><span class="line">    logstash.<span class="title function_">send</span>(log)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>routes&#x2F;user.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Post</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Comment</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createPost</span>(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> post = (<span class="keyword">await</span> <span class="title class_">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">uid</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;post&#x27;</span></span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createComment</span>(user, post)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (user, post) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">userId</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">postId</span>: post.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;comment&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure><p>此时刷新 Kibana，如下所示：</p><p><img src="/./assets/6.3.2.png"></p><p>在初次使用 Kibana 时，需要配置 Kibana 从 ElasticSearch 的哪些 index 中搜索日志，我们在 <code>Index pattern</code> 处填 <code>logstash-*</code>，然后单击 Next step 按钮，在 <code>Time Filter field name</code> 中选择 timestamp，单击 Create index pattern 完成配置。</p><p><strong>注意</strong>：我们选择 timestamp 而不是默认的 @timestamp，是因为在 koa-await-breakpoint 的日志中有 timestamp 字段。</p><p>单击左侧目录的 Discover，我们发现已经有日志了。分别单击左侧出现的 Available Fields 的 fn、type、step、take，然后按 step 升序展示，如下所示：</p><p><img src="/./assets/6.3.3.png"></p><p>是不是一目了然！我们把每个请求的每一步的函数及其执行时间都记录下来了。</p><p>修改 routes&#x2F;users.js 的 createComment，throw 一个 <code>new Error(&#39;test&#39;)</code>。重启程序并发起一个请求，ELK 显示如下：</p><p><img src="/./assets/6.3.4.png"></p><p><strong>小提示</strong>：在实际应用中会有非常多的日志，我们可以通过 requestId 找到一个请求的所有日志，在 7.2 小节会讲解。</p><p>ELK 非常强大，基本能满足所有日志查询需求，Kibana 的查询使用 lucene 语法，用 10 分钟左右就能大体上手。Kibana 还能创建各种仪表盘和聚合图表，读者可自行尝试。</p><h2 id="6-3-3-参考链接"><a href="#6-3-3-参考链接" class="headerlink" title="6.3.3 参考链接"></a>6.3.3 参考链接</h2><ul><li><a href="http://blog.51cto.com/baidu/1676798">http://blog.51cto.com/baidu/1676798</a></li><li><a href="http://elk-docker.readthedocs.io/">http://elk-docker.readthedocs.io</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.2%20async_hooks.md">6.2 async_hooks</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.4%20OpenTracing%20%2B%20Jaeger.md">6.4 OpenTracing + Jaeger</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ELK 是 ElasticSearch + Logstash + Kibana 这套组合工具的简称，是一个常</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 6.2 Async Hooks</title>
    <link href="https://marvinliu1.github.io/2019/09/29/6.2%20async_hooks/"/>
    <id>https://marvinliu1.github.io/2019/09/29/6.2%20async_hooks/</id>
    <published>2019-09-29T06:00:00.000Z</published>
    <updated>2022-05-25T04:28:09.798Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>上一小节讲解了 koa-await-breakpoint 的用法，但 koa-await-breakpoint 仍然有一个很大的缺憾，即无法记录除 routes&#x2F;controllers 外的函数的执行时间（因为获取不到当前请求的 ctx）。举个通俗的例子：在一个路由的 controller 里面调用了 A ，A 调用了其他文件的 B ，B 又调用了其他文件的 C…这是非常常见的用法，但之前使用 koa-await-breakpoint 只能获取 A 的执行时间，无法获取 B 和 C 的执行时间。</p><p><strong>根本原因在于</strong>：无法知道函数之间的调用关系，即 B 不知道是 A 调用的它，即便知道也不知道是哪次请求到来时执行的 A 调用的它。</p><p>但是，<a href="mailto:&#110;&#x6f;&#100;&#x65;&#x40;&#56;&#46;&#49;">&#110;&#x6f;&#100;&#x65;&#x40;&#56;&#46;&#49;</a> 引入了一个黑魔法——Async Hooks。</p><h2 id="6-2-1-Async-Hooks"><a href="#6-2-1-Async-Hooks" class="headerlink" title="6.2.1 Async Hooks"></a>6.2.1 Async Hooks</h2><p>我们先看看 async_hooks 是什么。Node.js 官网对 async_hooks 的介绍为：</p><blockquote><p>The <code>async_hooks</code> module provides an API to register callbacks tracking the lifetime of asynchronous resources created inside a Node.js application.</p></blockquote><p><strong>一句话概括</strong>：async_hooks 用来追踪 Node.js 中异步资源的生命周期。</p><p>我们来看段测试代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">&#x27;async_hooks&#x27;</span>)</span><br><span class="line"></span><br><span class="line">async_hooks.<span class="title function_">createHook</span>(&#123;</span><br><span class="line">  init (asyncId, type, triggerAsyncId, resource) &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`<span class="subst">$&#123;type&#125;</span>(<span class="subst">$&#123;asyncId&#125;</span>): trigger: <span class="subst">$&#123;triggerAsyncId&#125;</span>\n`</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy (asyncId) &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`destroy: <span class="subst">$&#123;asyncId&#125;</span>\n`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">enable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">A</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`A -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`A in setTimeout -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">    <span class="title function_">B</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">B</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`B -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`B in process.nextTick -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">    <span class="title function_">C</span>()</span><br><span class="line">    <span class="title function_">C</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">C</span> () &#123;</span><br><span class="line">  fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`C -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`C in promise.then -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">writeSync</span>(<span class="number">1</span>, <span class="string">`top level -&gt; <span class="subst">$&#123;async_hooks.executionAsyncId()&#125;</span>\n`</span>)</span><br><span class="line"><span class="title function_">A</span>()</span><br></pre></td></tr></table></figure><p>async_hooks.createHook 可以注册 4 个方法来跟踪所有异步资源的初始化（init）、回调之前（before）、回调之后（after）、销毁后（destroy）事件，并通过调用 .enable() 启用，调用 .disable() 关闭。</p><p>这里我们只关心异步资源的初始化和销毁的事件，并使用 <code>fs.writeSync(1, msg)</code> 打印到标准输出，writeSync 的第 1 个参数接收文件描述符，1 表示标准输出。为什么不使用 console.log 呢？因为 console.log 是一个异步操作，如果在 init、before、after 和 destroy 事件处理函数中出现，就会导致无限循环，同理也不能使用任何其他的异步操作。</p><p>运行该程序，打印如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">top level -&gt; 1</span><br><span class="line">PROMISE(6): trigger: 1</span><br><span class="line">A -&gt; 1</span><br><span class="line">Timeout(7): trigger: 1</span><br><span class="line">TIMERWRAP(8): trigger: 1</span><br><span class="line">A in setTimeout -&gt; 7</span><br><span class="line">PROMISE(9): trigger: 7</span><br><span class="line">B -&gt; 7</span><br><span class="line">TickObject(10): trigger: 7</span><br><span class="line">B in process.nextTick -&gt; 10</span><br><span class="line">C -&gt; 10</span><br><span class="line">PROMISE(11): trigger: 10</span><br><span class="line">PROMISE(12): trigger: 11</span><br><span class="line">C -&gt; 10</span><br><span class="line">PROMISE(13): trigger: 10</span><br><span class="line">PROMISE(14): trigger: 13</span><br><span class="line">C in promise.then -&gt; 12</span><br><span class="line">C in promise.then -&gt; 14</span><br><span class="line">destroy: 7</span><br><span class="line">destroy: 10</span><br><span class="line">destroy: 8</span><br></pre></td></tr></table></figure><p>这段程序的打印结果包含了很多信息，下面逐一进行解释：</p><ol><li>为了实现对异步资源的跟踪，Node.js 对每一个函数（不论异步还是同步）提供了一个 async scope，我们可以通过调用 <code>async_hooks.executionAsyncId()</code> 来获取函数当前的 async scope 的 id（称为 asyncId），通过调用 <code>async_hooks.triggerAsyncId()</code> 来获取当前函数调用者的 asyncId。</li><li>异步资源在创建时触发 init 事件函数，init 函数中的第 1 个参数代表该异步资源的 asyncId，type 表示异步资源的类型（例如 TCPWRAP、PROMISE、Timeout、Immediate、TickObject 等等），triggerAsyncId 表示该异步资源的调用者的 asyncId。异步资源在销毁时触发 destroy 事件函数，该函数只接收一个参数，即该异步资源的 asyncId。</li><li>函数调用关系明确。我们通过上面的打印结果可以很容易地看出（从下往上看） ：C（asyncId: 10）被 B（asyncId: 7）调用，B（asyncId: 7）被 A（asyncId: 1）调用。而且 C 的 promise.then 里面的 asyncId（值为 12&#x2F;14）也可以通过 12&#x2F;14 -&gt; 11&#x2F;13 -&gt; 10 定位到 C 的 asyncId（值为 10）。</li><li>同步函数每次调用的 asyncId 都一样，如上所示，C 调用了两次，都打印了 C -&gt; 10，与调用方的作用域的 asyncId 一致，即如上所示打印的 B in process.nextTick -&gt; 10。异步函数每次调用的 asyncId 都不一样，即如上所示打印的 C in promise.then -&gt; 12 和 C in promise.then -&gt; 14。</li><li>最外层作用域的 asyncId 总是 1，每个异步资源在创建时 asyncId 全局递增。</li></ol><p>上面 5 条结论非常重要。接下来我们看看如何使用 async_hooks 改造 koa-await-breakpoint。</p><h2 id="6-2-2-改造-koa-await-breakpoint"><a href="#6-2-2-改造-koa-await-breakpoint" class="headerlink" title="6.2.2 改造 koa-await-breakpoint"></a>6.2.2 改造 koa-await-breakpoint</h2><p>我们通过前面的结论已经知道，使用 async_hooks 时可以通过 asyncId 串起函数的调用关系，但是如何将这些函数的调用链与 koa 接收的每个请求关联起来呢?</p><p>首先，定义一个全局 Map，存储函数的调用关系：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">&#x27;async_hooks&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> asyncIdMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line">async_hooks.<span class="title function_">createHook</span>(&#123;</span><br><span class="line">  init (asyncId, type, triggerAsyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="title function_">getCtx</span>(triggerAsyncId)</span><br><span class="line">    <span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">      asyncIdMap.<span class="title function_">set</span>(asyncId, ctx)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      asyncIdMap.<span class="title function_">set</span>(asyncId, triggerAsyncId)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy (asyncId) &#123;</span><br><span class="line">    asyncIdMap.<span class="title function_">delete</span>(asyncId)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">enable</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCtx</span> (asyncId) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!asyncId) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> asyncId === <span class="string">&#x27;object&#x27;</span> &amp;&amp; asyncId.<span class="property">app</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> asyncId</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getCtx</span>(asyncIdMap.<span class="title function_">get</span>(asyncId))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有以下三点需要解释：</p><ol><li>定义了一个全局 Map 来存储函数的调用关系，在适当的地方（下面会讲到）将当前请求的 ctx 存储到 Map 中，key 是 asyncId。</li><li>每个异步资源在初始化时，会尝试通过 asyncId 向上寻找祖先的 value 是否是 ctx（koa 应用中每个请求的 ctx），如果有，则直接将 value 设置为 ctx，否则将 value 设置为调用者的 asyncId（即 triggerAsyncId）。</li><li>在 destroy 事件函数里直接删除调用关系，保证了不会引起内存泄漏，即杜绝引用了 ctx 但没有释放的情况。</li></ol><p>然后，修改 global[loggerName] 如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>[loggerName] = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, fn, fnStr, filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> originalContext = ctx</span><br><span class="line">  <span class="keyword">let</span> requestId = <span class="title function_">_getRequestId</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> asyncId = async_hooks.<span class="title function_">executionAsyncId</span>()</span><br><span class="line">  <span class="keyword">if</span> (!requestId) &#123;</span><br><span class="line">    <span class="keyword">const</span> _ctx = <span class="title function_">getCtx</span>(asyncId)</span><br><span class="line">    <span class="keyword">if</span> (_ctx) &#123;</span><br><span class="line">      ctx = _ctx</span><br><span class="line">      requestId = <span class="title function_">_getRequestId</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    asyncIdMap.<span class="title function_">set</span>(asyncId, ctx)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestId) &#123;</span><br><span class="line">    <span class="title function_">_logger</span>(<span class="string">&#x27;beforeAwait&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> fn.<span class="title function_">call</span>(originalContext)</span><br><span class="line">  <span class="keyword">if</span> (requestId) &#123;</span><br><span class="line">    <span class="title function_">_logger</span>(<span class="string">&#x27;afterAwait&#x27;</span>, result)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_getRequestId</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx &amp;&amp; ctx.<span class="property">app</span> &amp;&amp; _.<span class="title function_">get</span>(ctx, requestIdPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_logger</span> (type, result) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有以下两点需要解释：</p><ol><li>logger 函数传入的第 1 个参数 ctx，之前是每个请求的 ctx，现在可能是当前执行上下文的 this，所以先将 ctx 赋值给 originalContext，然后通过 <code>await fn.call(originalContext)</code> 让函数在执行时有正确的上下文。</li><li>如果传入的 ctx 是来自请求的 ctx 且能拿到 requestId，那么将当前 asyncId 和 ctx 写入 Map，如果不是来自请求的 ctx，则尝试从 Map 里向上寻找祖先的 value 是否是 ctx，如果找到，则覆盖当前的 ctx 并拿到 requestId。</li></ol><p>至此，koa-await-breakpoint 全部改造完毕。接下来我们通过一个例子验证下升级后的 koa-await-breakpoint：</p><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>).<span class="property">createUser</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p><strong>routes&#x2F;users.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Post</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Comment</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">204</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createPost</span>(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPost</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> post = (<span class="keyword">await</span> <span class="title class_">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">uid</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;post&#x27;</span></span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">createComment</span>(user, post)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (user, post) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">userId</span>: user.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">postId</span>: post.<span class="property">_id</span>,</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;comment&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码的意思是：在访问创建用户接口时，调用 createUser，createUser 里面又调用了 createPost，createPost 里面又调用了 createComment。运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST localhost:3000/users</span><br></pre></td></tr></table></figure><p>打印如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;start&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createUser(name, age)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;User.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;User.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">36</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createPost(user)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">6</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Post.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">7</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Post.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">3</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createComment(user, post)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;beforeAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">9</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Comment.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;Comment.create(...)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">11</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createComment(user, post)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">1</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createPost(user)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">6</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;afterAwait&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="string">&#x27;createUser(name, age)&#x27;</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">44</span> ... &#125;</span><br><span class="line">&#123; <span class="attr">type</span>: <span class="string">&#x27;end&#x27;</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="attr">take</span>: <span class="number">0</span> ... &#125;</span><br></pre></td></tr></table></figure><p>至此，一个全链路、无侵入、强大的日志打点工具就完成了。</p><p><strong>注意</strong>：使用 async_hooks 在目前有较严重的性能损耗，见 <a href="https://github.com/bmeurer/async-hooks-performance-impact">https://github.com/bmeurer/async-hooks-performance-impact</a>，请慎重在生产环境中使用。</p><h2 id="6-2-3-参考链接"><a href="#6-2-3-参考链接" class="headerlink" title="6.2.3 参考链接"></a>6.2.3 参考链接</h2><ul><li><a href="https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html">https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html</a></li><li><a href="https://zhuanlan.zhihu.com/p/27394440">https://zhuanlan.zhihu.com/p/27394440</a></li><li><a href="https://www.jianshu.com/p/4a568dac41ed">https://www.jianshu.com/p/4a568dac41ed</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.1%20koa-await-breakpoint.md">6.1 koa-await-breakpoint</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.3%20ELK.md">6.3 ELK</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上一小节讲解了 koa-await-breakpoint 的用法，但 koa-await-breakpoin</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 6.1 Koa-await-breakpoint</title>
    <link href="https://marvinliu1.github.io/2019/09/20/6.1%20koa-await-breakpoint/"/>
    <id>https://marvinliu1.github.io/2019/09/20/6.1%20koa-await-breakpoint/</id>
    <published>2019-09-20T06:00:00.000Z</published>
    <updated>2022-05-25T04:27:36.571Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>日志打点一直是个调试最头疼的问题。如果直接在代码中插入埋点代码，不仅侵入性强而且工作量大也不够灵活，要是能做到智能打点就好了，koa-await-breakpoint 正是我们需要的。</p><h2 id="6-1-1-什么是-koa-await-breakpoint？"><a href="#6-1-1-什么是-koa-await-breakpoint？" class="headerlink" title="6.1.1 什么是 koa-await-breakpoint？"></a>6.1.1 什么是 <a href="https://github.com/nswbmw/koa-await-breakpoint">koa-await-breakpoint</a>？</h2><p>koa-await-breakpoint 是一个 Koa 的中间件，是一个在 routes&#x2F;controllers 里（作用域包含 ctx）的 await 表达式前后自动打点的工具，不用插入一行日志打点代码，只需要在引入时配置一下，就可以记录每个请求到来时 await 表达式前后的现场，例如：</p><ol><li>await 表达式所在的文件及行列号（filename）。</li><li>await 表达式是执行的第几步（step）。</li><li>await 表达式字符串形式（fn）。</li><li>执行 await 表达式所花费的毫秒（take）。</li><li>执行 await 表达式的结果（result）。</li><li>当前请求的 ctx。</li></ol><p>使用方法如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// On top of the main file</span></span><br><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generally, above other middlewares</span></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><h2 id="6-1-2-实现原理"><a href="#6-1-2-实现原理" class="headerlink" title="6.1.2 实现原理"></a>6.1.2 实现原理</h2><ol><li><p>重载 Module.prototype._compile，相当于 hack 了 require，如果发现是 require 了配置里指定的文件，则进行下一步，否则返回原始代码的内容，相关源代码如下：</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shimmer.<span class="title function_">wrap</span>(<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;_compile&#x27;</span>, <span class="keyword">function</span> (<span class="params">__compile</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">koaBreakpointCompile</span>(<span class="params">content, filename</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_.<span class="title function_">includes</span>(filenames, filename)) &#123;</span><br><span class="line">      <span class="keyword">return</span> __compile.<span class="title function_">call</span>(<span class="variable language_">this</span>, content, filename);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>用 esprima 解析代码，生成 AST。例如：</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getUsers</span> = <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUsers</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">find</span>()</span><br><span class="line">  <span class="keyword">return</span> users</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  会生成如下 AST，只截取了 <code>await User.create(...)</code> 相关的 AST：</p></li></ol>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Script</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title class_">AwaitExpression</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;AwaitExpression&#x27;</span>,</span><br><span class="line">    <span class="attr">argument</span>:</span><br><span class="line">     <span class="title class_">CallExpression</span> &#123;</span><br><span class="line">       <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">       <span class="attr">callee</span>:</span><br><span class="line">        <span class="title class_">StaticMemberExpression</span> &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;MemberExpression&#x27;</span>,</span><br><span class="line">          <span class="attr">computed</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">object</span>:</span><br><span class="line">           <span class="title class_">Identifier</span> &#123;</span><br><span class="line">             <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">             <span class="attr">name</span>: <span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">             <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">10</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">14</span> &#125; &#125; &#125;,</span><br><span class="line">          <span class="attr">property</span>:</span><br><span class="line">           <span class="title class_">Identifier</span> &#123;</span><br><span class="line">             <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">             <span class="attr">name</span>: <span class="string">&#x27;create&#x27;</span>,</span><br><span class="line">             <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">15</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">21</span> &#125; &#125; &#125;,</span><br><span class="line">          <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">10</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">21</span> &#125; &#125; &#125;,</span><br><span class="line">       <span class="attr">arguments</span>:</span><br><span class="line">        [ <span class="title class_">ObjectExpression</span> &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;ObjectExpression&#x27;</span>,</span><br><span class="line">            <span class="attr">properties</span>:</span><br><span class="line">             [ <span class="title class_">Property</span> &#123;</span><br><span class="line">                 <span class="attr">type</span>: <span class="string">&#x27;Property&#x27;</span>,</span><br><span class="line">                 <span class="attr">key</span>:</span><br><span class="line">                  <span class="title class_">Identifier</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">                    <span class="attr">name</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">10</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">computed</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">value</span>:</span><br><span class="line">                  <span class="title class_">Literal</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Literal&#x27;</span>,</span><br><span class="line">                    <span class="attr">value</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">                    <span class="attr">raw</span>: <span class="string">&#x27;\&#x27;xx\&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">12</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">16</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">kind</span>: <span class="string">&#x27;init&#x27;</span>,</span><br><span class="line">                 <span class="attr">method</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">shorthand</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">7</span>, <span class="attr">column</span>: <span class="number">16</span> &#125; &#125; &#125;,</span><br><span class="line">               <span class="title class_">Property</span> &#123;</span><br><span class="line">                 <span class="attr">type</span>: <span class="string">&#x27;Property&#x27;</span>,</span><br><span class="line">                 <span class="attr">key</span>:</span><br><span class="line">                  <span class="title class_">Identifier</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">                    <span class="attr">name</span>: <span class="string">&#x27;age&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">9</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">computed</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">value</span>:</span><br><span class="line">                  <span class="title class_">Literal</span> &#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;Literal&#x27;</span>,</span><br><span class="line">                    <span class="attr">value</span>: <span class="number">18</span>,</span><br><span class="line">                    <span class="attr">raw</span>: <span class="string">&#x27;18&#x27;</span>,</span><br><span class="line">                    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">11</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">13</span> &#125; &#125; &#125;,</span><br><span class="line">                 <span class="attr">kind</span>: <span class="string">&#x27;init&#x27;</span>,</span><br><span class="line">                 <span class="attr">method</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">shorthand</span>: <span class="literal">false</span>,</span><br><span class="line">                 <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">6</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">8</span>, <span class="attr">column</span>: <span class="number">13</span> &#125; &#125; &#125; ],</span><br><span class="line">            <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">22</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">9</span>, <span class="attr">column</span>: <span class="number">5</span> &#125; &#125; &#125; ],</span><br><span class="line">       <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">10</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">9</span>, <span class="attr">column</span>: <span class="number">6</span> &#125; &#125; &#125;,</span><br><span class="line">    <span class="attr">loc</span>: &#123; <span class="attr">start</span>: &#123; <span class="attr">line</span>: <span class="number">6</span>, <span class="attr">column</span>: <span class="number">4</span> &#125;, <span class="attr">end</span>: &#123; <span class="attr">line</span>: <span class="number">9</span>, <span class="attr">column</span>: <span class="number">6</span> &#125; &#125; &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><ol start="3"><li>遍历找到 awaitExpression 节点，进行以下包装后生成 AST，替换掉原来的节点。  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="title function_">logger</span>(</span><br><span class="line">  (<span class="keyword">typeof</span> ctx !== <span class="string">&#x27;undefined&#x27;</span> ? ctx : <span class="variable language_">this</span>),</span><br><span class="line">  <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> awaitExpression</span><br><span class="line">  &#125;,</span><br><span class="line">  awaitExpressionString,</span><br><span class="line">  filename</span><br><span class="line">)</span><br></pre></td></tr></table></figure>  相关源代码如下：  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">findAwaitAndWrapLogger</span>(parsedCodes)</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  content = escodegen.<span class="title function_">generate</span>(parsedCodes, &#123;</span><br><span class="line">    <span class="attr">format</span>: &#123; <span class="attr">indent</span>: &#123; <span class="attr">style</span>: <span class="string">&#x27;  &#x27;</span> &#125; &#125;,</span><br><span class="line">    <span class="attr">sourceMap</span>: filename,</span><br><span class="line">    <span class="attr">sourceMapWithCode</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;cannot generate code for file: %s&#x27;</span>, filename)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(e.<span class="property">stack</span>)</span><br><span class="line">  process.<span class="title function_">exit</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">debug</span>(<span class="string">&#x27;file %s regenerate codes:\n%s&#x27;</span>, filename, content.<span class="property">code</span>)</span><br></pre></td></tr></table></figure>  findAwaitAndWrapLogger 的作用就是遍历 AST，将 awaitExpression 替换成用日志函数包裹后新的 awaitExpression 的 AST。最后用 escodegen 将 AST 生成代码（支持 soucemap，所以错误栈对应的行数是正确的）。</li></ol><p><strong>核心</strong>：每个请求到来时，生成一个 requestId（可自定义，默认为 uuid）挂载到 ctx 上，这样就可以通过 requestId 将日志串起来了。</p><p><strong>特点</strong>：可以记录每个请求的每一步（await 表达式）的现场及返回值，方便查日志。</p><h2 id="6-1-3-使用-koa-await-breakpoint"><a href="#6-1-3-使用-koa-await-breakpoint" class="headerlink" title="6.1.3 使用 koa-await-breakpoint"></a>6.1.3 使用 koa-await-breakpoint</h2><p>测试代码如下：</p><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaAwaitBreakpoint = <span class="built_in">require</span>(<span class="string">&#x27;koa-await-breakpoint&#x27;</span>)(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">  <span class="attr">files</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./routes/user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(koaAwaitBreakpoint)</span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/users&#x27;</span>, <span class="attr">controller</span>: userRouter.<span class="property">getUsers</span> &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p><strong>routes&#x2F;user.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getUsers</span> = <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUsers</span> (ctx) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">find</span>()</span><br><span class="line">  ctx.<span class="property">body</span> = users</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG=koa-await-breakpoint node app.js</span><br></pre></td></tr></table></figure><p>终端打印出转换后的代码，可以看出 routes&#x2F;users.js 被转换成了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;users&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">getUsers</span> = <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUsers</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">global</span>.<span class="title function_">logger</span>(<span class="keyword">typeof</span> ctx !== <span class="string">&#x27;undefined&#x27;</span> ? ctx : <span class="variable language_">this</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="string">&#x27;User.create(&#123;\n    name: \&#x27;xx\&#x27;,\n    age: 18\n&#125;)&#x27;</span>, <span class="string">&#x27;/Users/nswbmw/Desktop/test/routes/user.js:6:2&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="variable language_">global</span>.<span class="title function_">logger</span>(<span class="keyword">typeof</span> ctx !== <span class="string">&#x27;undefined&#x27;</span> ? ctx : <span class="variable language_">this</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>.<span class="title function_">find</span>();</span><br><span class="line">  &#125;, <span class="string">&#x27;User.find()&#x27;</span>, <span class="string">&#x27;/Users/nswbmw/Desktop/test/routes/user.js:11:16&#x27;</span>);</span><br><span class="line">  ctx.<span class="property">body</span> = users;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>访问 localhost:3000&#x2F;users，终端打印出:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.100Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;start&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">1</span>,<span class="string">&quot;take&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">2</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:6:2&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.104Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;beforeAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.create(&#123;\n    name: &#x27;xx&#x27;,\n    age: 18\n&#125;)&quot;</span>,<span class="string">&quot;take&quot;</span>:<span class="number">4</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">3</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:6:2&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.175Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;afterAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.create(&#123;\n    name: &#x27;xx&#x27;,\n    age: 18\n&#125;)&quot;</span>,<span class="string">&quot;result&quot;</span>:&#123;<span class="string">&quot;result&quot;</span>:&#123;<span class="string">&quot;ok&quot;</span>:<span class="number">1</span>,<span class="string">&quot;n&quot;</span>:<span class="number">1</span>&#125;,<span class="string">&quot;ops&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>,<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;5a93a9c3cf8c8797c9b47482&quot;</span>&#125;],<span class="string">&quot;insertedCount&quot;</span>:<span class="number">1</span>,<span class="string">&quot;insertedIds&quot;</span>:[<span class="string">&quot;5a93a9c3cf8c8797c9b47482&quot;</span>]&#125;,<span class="string">&quot;take&quot;</span>:<span class="number">71</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">4</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:11:16&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.175Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;beforeAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.find()&quot;</span>,<span class="string">&quot;take&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">5</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/Users/nswbmw/Desktop/test/routes/user.js:11:16&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.180Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;afterAwait&quot;</span>,<span class="string">&quot;fn&quot;</span>:<span class="string">&quot;User.find()&quot;</span>,<span class="string">&quot;result&quot;</span>:[&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;5a93a9c3cf8c8797c9b47482&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>&#125;],<span class="string">&quot;take&quot;</span>:<span class="number">5</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;api&quot;</span>,<span class="string">&quot;requestId&quot;</span>:<span class="string">&quot;50dbda0c-9e13-4659-acce-b237bc5178b7&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2018-02-26T06:31:31.181Z&quot;</span>,<span class="string">&quot;this&quot;</span>:...,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;end&quot;</span>,<span class="string">&quot;step&quot;</span>:<span class="number">6</span>,<span class="string">&quot;take&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：type 是以下其中一种，take 的单位是 ms。</p><ol><li>start：请求到来时第 1 次打点。</li><li>beforeAwait：上一个 awaitExpression 之后到这一个 awaitExpression 之前。</li><li>afterAwait：这个 awaitExpression 开始到结束。</li><li>error：错误日志，包含了错误信息。</li><li>end：请求结束时打点。</li></ol><h2 id="6-1-4-自定义日志存储"><a href="#6-1-4-自定义日志存储" class="headerlink" title="6.1.4 自定义日志存储"></a>6.1.4 自定义日志存储</h2><p>store 参数最好自己定义（默认打印日志到 stdout），该参数是一个对象并且有一个 save 方法即可。在 save 方法内可做一些逻辑修改或者日志策略，比如：</p><ol><li>添加日志标识（例如：name）方便区分不同服务的日志。</li><li>针对错误日志，添加一些额外字段方便追踪现场。</li><li>将日志发送到 Logstash 或其他日志服务。</li><li>限制日志频率，比如：只有响应时间大于 500ms 的请求日志才会被记录。</li></ol><p><strong>koa_await_breakpoint_store.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">save</span> = <span class="keyword">function</span> <span class="title function_">save</span>(<span class="params">record, ctx</span>) &#123;</span><br><span class="line">  record.<span class="property">name</span> = <span class="string">&#x27;app name&#x27;</span></span><br><span class="line">  record.<span class="property">env</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (record.<span class="property">error</span>) &#123;</span><br><span class="line">    record.<span class="property">error</span> = &#123;</span><br><span class="line">      <span class="attr">message</span>: record.<span class="property">error</span>.<span class="property">message</span>,</span><br><span class="line">      <span class="attr">stack</span>: record.<span class="property">error</span>.<span class="property">stack</span>,</span><br><span class="line">      <span class="attr">status</span>: record.<span class="property">error</span>.<span class="property">status</span> || record.<span class="property">error</span>.<span class="property">statusCode</span> || <span class="number">500</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  logstash.<span class="title function_">send</span>(record)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-1-5-参考链接"><a href="#6-1-5-参考链接" class="headerlink" title="6.1.5 参考链接"></a>6.1.5 参考链接</h2><ul><li><a href="https://github.com/jquery/esprima">https://github.com/jquery/esprima</a></li><li><a href="https://github.com/estools/escodegen">https://github.com/estools/escodegen</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/5.2%20Elastic%20APM.md">5.2 Elastic APM</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.2%20async_hooks.md">6.2 async_hooks</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;日志打点一直是个调试最头疼的问题。如果直接在代码中插入埋点代码，不仅侵入性强而且工作量大也不够灵活，要是能做</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging - 5.2 Elastic APM</title>
    <link href="https://marvinliu1.github.io/2019/08/26/5.2%20Elastic%20APM/"/>
    <id>https://marvinliu1.github.io/2019/08/26/5.2%20Elastic%20APM/</id>
    <published>2019-08-26T06:00:00.000Z</published>
    <updated>2022-05-25T04:27:00.216Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><h2 id="5-2-1-什么是-Elastic-APM？"><a href="#5-2-1-什么是-Elastic-APM？" class="headerlink" title="5.2.1 什么是 Elastic APM？"></a>5.2.1 什么是 Elastic APM？</h2><p>Elastic APM 是 Elastic 公司开源的一款 APM 工具，目前还处于 Beta 阶段，它有以下几个优势：</p><ol><li>开源。我们可以免费使用，像使用 ELK 一样。</li><li>功能完善。API 比较完善，有 Agent、Transaction 和 Trace，默认创建响应时间和每分钟请求数两种图表，且可以使用 Kibana 的 Filter 过滤生成关心的数据的图表。</li><li>监控与日志统一。Elastic APM 依赖 ElasticSearch + Kibana，所以可以结合 ELK 使用，可在 Kibana 中查看监控，然后直接查询日志。</li></ol><p>Elastic APM 架构如下：</p><p><img src="/./assets/5.2.1.png"></p><p>APM Agent（即在应用端引入的探针）将收集的日志发送到 APM Server（Go 写的 HTTP 服务），APM Server 将数据存储到 ElasticSearch 中，然后通过 Kibana 展示。</p><p>Kibana 展示如下：</p><p><img src="/./assets/5.2.2.png"></p><h2 id="5-2-2-启动-ELK"><a href="#5-2-2-启动-ELK" class="headerlink" title="5.2.2 启动 ELK"></a>5.2.2 启动 ELK</h2><p>我们使用 Docker 安装并启动 ELK，运行如下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 5601:5601 \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 5044:5044 \</span><br><span class="line">    -it --name elk sebp/elk</span><br></pre></td></tr></table></figure><h2 id="5-2-3-启动-APM-Server"><a href="#5-2-3-启动-APM-Server" class="headerlink" title="5.2.3 启动 APM Server"></a>5.2.3 启动 APM Server</h2><p>首先，下载 <a href="https://www.elastic.co/downloads/apm/apm-server">APM Server</a> 解压。然后运行以下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./apm-server setup <span class="comment"># 导入 APM 仪表盘到 Kibana</span></span><br><span class="line">$ ./apm-server -e <span class="comment"># 启动 APM Server，默认监听 8200 端口</span></span><br></pre></td></tr></table></figure><p>用浏览器打开 localhost:5601，进入 Dashboard 页，如下所示：</p><p><img src="/./assets/5.2.3.png"></p><h2 id="5-2-4-使用-Elastic-APM"><a href="#5-2-4-使用-Elastic-APM" class="headerlink" title="5.2.4 使用 Elastic APM"></a>5.2.4 使用 Elastic APM</h2><p>测试代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apm = <span class="built_in">require</span>(<span class="string">&#x27;elastic-apm-node&#x27;</span>).<span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">appName</span>: <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  apm.<span class="title function_">setTransactionName</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx._matchedRoute&#125;</span>`</span>)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/:name&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  apm.<span class="title function_">setTransactionName</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx._matchedRoute&#125;</span>`</span>)</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>运行该程序，发起两个请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:3000/</span><br><span class="line">$ curl localhost:3000/nswbmw</span><br></pre></td></tr></table></figure><p>等待一会，Kibana 展示如下：</p><p><img src="/./assets/5.2.4.png"></p><p>在 Elastic APM 中，有两个术语：</p><ul><li>transaction：一组 traces 的集合，例如：一个 HTTP 请求。</li><li>trace：一个事件及持续时间，例如：一个 SQL 查询。</li></ul><h2 id="5-2-5-错误日志"><a href="#5-2-5-错误日志" class="headerlink" title="5.2.5 错误日志"></a>5.2.5 错误日志</h2><p>现在，我们来测试下 Elastic APM 的错误收集功能。修改测试代码为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apm = <span class="built_in">require</span>(<span class="string">&#x27;elastic-apm-node&#x27;</span>).<span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">appName</span>: <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    apm.<span class="title function_">captureError</span>(e)</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">500</span></span><br><span class="line">    ctx.<span class="property">message</span> = e.<span class="property">message</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">controller</span>: <span class="keyword">function</span> <span class="title function_">indexRouter</span> (ctx) &#123;</span><br><span class="line">  apm.<span class="title function_">setTransactionName</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx._matchedRoute&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error!!!&#x27;</span>)</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>重启测试程序，并发起一次请求。回到 Kibana，单击 Dashboard -&gt; [APM] Errors 可以看到错误日志记录（自动聚合）和图表，如下所示：</p><p><img src="/./assets/5.2.5.png"></p><p>单击 View Error Details 进入错误详情页，如下所示：</p><p><img src="/./assets/5.2.6.png"></p><p><strong>可以看出</strong>：在错误日志中展示了错误代码及行数、上下几行代码、父级函数名和所在文件等信息。</p><h2 id="5-2-6-参考链接"><a href="#5-2-6-参考链接" class="headerlink" title="5.2.6 参考链接"></a>5.2.6 参考链接</h2><ul><li><a href="https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/index.html">https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/index.html</a></li><li><a href="https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/custom-stack.html">https://www.elastic.co/guide/en/apm/agent/nodejs/0.x/custom-stack.html</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/5.1%20NewRelic.md">5.1 NewRelic</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/6.1%20koa-await-breakpoint.md">6.1 koa-await-breakpoint</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;5-2-1-什么是-Elastic-APM？&quot;&gt;&lt;a href=&quot;#5-2-1-什么是-Elast</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging, 5.1 NewRelic</title>
    <link href="https://marvinliu1.github.io/2019/08/05/5.1%20NewRelic/"/>
    <id>https://marvinliu1.github.io/2019/08/05/5.1%20NewRelic/</id>
    <published>2019-08-05T06:00:00.000Z</published>
    <updated>2022-05-25T04:24:35.358Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p><a href="https://newrelic.com/">NewRelic</a> 是一个老牌的应用性能监测工具，提供 14 天免费试用，本节将讲解如何使用 NewRelic 监控 Node.js 程序的性能。</p><p>测试代码如下：</p><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;newrelic&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">const</span> createUser = <span class="built_in">require</span>(<span class="string">&#x27;./routes/users&#x27;</span>).<span class="property">createUser</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> salt = crypto.<span class="title function_">randomBytes</span>(<span class="number">128</span>).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> hash = crypto.<span class="title function_">pbkdf2Sync</span>(<span class="title class_">String</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()), salt, <span class="number">10000</span>, <span class="number">512</span>, <span class="string">&#x27;sha512&#x27;</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; salt, hash &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/error&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error!!!&#x27;</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/users/:user&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">createUser</span>(req.<span class="property">params</span>.<span class="property">user</span>, <span class="number">18</span>)</span><br><span class="line">  res.<span class="title function_">json</span>(user)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p><strong>routes&#x2F;users.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mongolass</span> = <span class="built_in">require</span>(<span class="string">&#x27;mongolass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> <span class="title class_">Mongolass</span>(<span class="string">&#x27;mongodb://localhost:27017/test&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongolass.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">createUser</span> = <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = ctx.<span class="property">query</span>.<span class="property">name</span> || <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> age = +ctx.<span class="property">query</span>.<span class="property">age</span> || <span class="number">18</span></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age)</span><br><span class="line">  ctx.<span class="property">status</span> = user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span> (name, age) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    name,</span><br><span class="line">    age</span><br><span class="line">  &#125;)).<span class="property">ops</span>[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">return</span> user</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-1-1-使用-NewRelic"><a href="#5-1-1-使用-NewRelic" class="headerlink" title="5.1.1 使用 NewRelic"></a>5.1.1 使用 NewRelic</h2><p>首先，注册一个 <a href="https://newrelic.com/signup">NewRelic</a> 账号。创建一个应用，如下所示：</p><p><img src="/./assets/5.1.1.png"></p><p>选择 APM，进入下一步，选择 Node.js 应用，并拿到 license key：</p><p><img src="/./assets/5.1.2.png"></p><p>在 Node.js 中使用 NewRelic 的步骤如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i newrelic --save <span class="comment"># 安装 NewRelic 的 Node.js SDK</span></span><br><span class="line">$ <span class="built_in">cp</span> node_modules/newrelic/newrelic.js . <span class="comment"># 将默认配置文件拷贝到项目根目录下</span></span><br></pre></td></tr></table></figure><p>修改 newrelic.js，app_name 填写我们的应用名（例如：api），license_key 填写刚才生成的 license key。</p><p>启动测试程序，并发起几个请求，稍等几分钟，NewRelic 的后台将会收到并展示一些数据（例如：吞吐量，请求的 Urls，错误率、Apdex score 等），如下所示：</p><p><img src="/./assets/5.1.3.png"></p><p>试用版的功能有限，升级到付费版可解锁更多功能，例如：数据库分析、错误分析甚至 Node.js VM 监控（CPU、内存、GC、Event Loop）等等。</p><p>类似的其他 APM 有：</p><ul><li><a href="https://www.appdynamics.com/">AppDynamics</a></li><li><a href="oneapm.com">OneAPM</a></li><li><a href="https://www.datadoghq.com/monitor-nodejs/">DataDog</a></li><li><a href="https://www.atatus.com/">atatus</a></li><li><a href="https://opbeat.com/nodejs">opbeat</a></li></ul><p>用法大同小异，这里就不一一介绍了。</p><h2 id="5-1-2-参考链接"><a href="#5-1-2-参考链接" class="headerlink" title="5.1.2 参考链接"></a>5.1.2 参考链接</h2><ul><li><a href="https://newrelic.com/">https://newrelic.com/</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/4.5%20supervisor-hot-reload.md">4.5 supervisor-hot-reload</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/5.2%20Elastic%20APM.md">5.2 Elastic APM</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://newrelic.com/&quot;&gt;NewRelic&lt;/a&gt; 是一个老牌的应用性</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging, 4.5 Supervisor-hot-reload</title>
    <link href="https://marvinliu1.github.io/2019/08/03/4.5%20supervisor-hot-reload/"/>
    <id>https://marvinliu1.github.io/2019/08/03/4.5%20supervisor-hot-reload/</id>
    <published>2019-08-03T06:00:00.000Z</published>
    <updated>2022-05-25T04:24:07.404Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>我们在本地开发 Node.js 程序时通常会使用 <a href="https://github.com/remy/nodemon">nodemon</a> 或者 <a href="https://github.com/petruisfan/node-supervisor">supervisor</a> 这种进程管理工具，当有文件修改时自动重启应用。小项目还好，项目大了（尤其是前端应用）每次重启应用都用几秒到几十秒的时间，大部分时间都花在了加载及编译代码上。</p><p>这让笔者联想到前端比较火的一个名词——Hot Reload（热加载），比如 React 静态资源的热加载通过 webpack-dev-server 和 react-hot-loader 实现，webpack-dev-server 负责重新编译代码，react-hot-loader 负责热加载。</p><p>那在 Node.js 应用中，如何实现 Hot Reload 呢？最好能实现不重启应用便使新代码生效。幸好 ES6 引入了一个新特性——Proxy。</p><h2 id="4-5-1-Proxy"><a href="#4-5-1-Proxy" class="headerlink" title="4.5.1 Proxy"></a>4.5.1 Proxy</h2><p>Proxy 用于修改对象的默认行为，等同于在语言层面做出修改，属于一种 “元编程”。Proxy 在要访问的对象之前架设一层拦截，在访问该对象成员时必须先经过这层拦截。示例代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`getting <span class="subst">$&#123;key&#125;</span>!`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;haha&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>)</span><br><span class="line"><span class="comment">// getting name!</span></span><br><span class="line"><span class="comment">// haha</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">age</span>)</span><br><span class="line"><span class="comment">// getting age!</span></span><br><span class="line"><span class="comment">// haha</span></span><br></pre></td></tr></table></figure><p><strong>可以看出</strong>：我们并没有在 obj 上定义 name 和 age 属性，所有获取 obj 上属性都会执行 get 方法然后打印 getting xxx! 和返回 haha。</p><p>这里 Proxy 的第 1 个参数是一个空对象，也可以是一个其他的对象，比如函数（毕竟在 JavaScript 中函数也是对象）。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">user</span> () &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(user, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`getting <span class="subst">$&#123;key&#125;</span>!`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;haha&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">name</span>)</span><br><span class="line"><span class="comment">// user</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">age</span>)</span><br><span class="line"><span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>)</span><br><span class="line"><span class="comment">// getting name!</span></span><br><span class="line"><span class="comment">// haha</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">age</span>)</span><br><span class="line"><span class="comment">// getting age!</span></span><br><span class="line"><span class="comment">// haha</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="number">1</span>, &#123;&#125;)</span><br><span class="line"><span class="comment">// TypeError: Cannot create proxy with a non-object as target or handler</span></span><br></pre></td></tr></table></figure><h2 id="4-5-2-Proxy-实现-Hot-Reload"><a href="#4-5-2-Proxy-实现-Hot-Reload" class="headerlink" title="4.5.2 Proxy 实现 Hot Reload"></a>4.5.2 Proxy 实现 Hot Reload</h2><p><strong>核心原理</strong>：使用 Proxy 将模块导出的对象包装一层 “代理”，即 module.exports 导出的是一个 Proxy 实例，定义一个 get 方法，使得获取实例上的属性其实是去获取最新的 require.cache 中的对象上的属性。同时，监听代码文件，如果有修改，则更新 require.cache。</p><p><strong>简而言之</strong>：我们在获取对象的属性时，中间加了一层代理，通过代理间接获取原有属性的值，如果属性值有更新，则会更新 require.cache 的缓存，那么下次再获取对象的属性时，通过代理将获取该属性最新的值。可见，Proxy 可以实现属性访问拦截，也可实现断开强引用的作用。</p><p>笔者发布了一个 <a href="https://www.npmjs.com/package/proxy-hot-reload">proxy-hot-reload</a> 模块，核心代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">proxyHotReload</span>(<span class="params">opts</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> includes = [ ... ]</span><br><span class="line">  <span class="keyword">const</span> excludes = [ ... ]</span><br><span class="line">  <span class="keyword">const</span> filenames = _.<span class="title function_">difference</span>(includes, excludes)</span><br><span class="line"></span><br><span class="line">  chokidar</span><br><span class="line">    .<span class="title function_">watch</span>(filenames, &#123;</span><br><span class="line">      <span class="attr">usePolling</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">require</span>.<span class="property">cache</span>[path]) &#123;</span><br><span class="line">          <span class="keyword">const</span> _exports = <span class="built_in">require</span>.<span class="property">cache</span>[path].<span class="property">exports</span></span><br><span class="line">          <span class="keyword">if</span> (_.<span class="title function_">isPlainObject</span>(_exports) &amp;&amp; !_.<span class="title function_">isEmpty</span>(_exports)) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="built_in">require</span>.<span class="property">cache</span>[path]</span><br><span class="line">            <span class="built_in">require</span>(path)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">error</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error))</span><br><span class="line"></span><br><span class="line">  shimmer.<span class="title function_">wrap</span>(<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;_compile&#x27;</span>, <span class="keyword">function</span> (<span class="params">__compile</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">proxyHotReloadCompile</span>(<span class="params">content, filename</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!_.<span class="title function_">includes</span>(filenames, filename)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> __compile.<span class="title function_">call</span>(<span class="variable language_">this</span>, content, filename)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = __compile.<span class="title function_">call</span>(<span class="variable language_">this</span>, content, filename)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_exports</span> = <span class="variable language_">this</span>.<span class="property">exports</span></span><br><span class="line">        <span class="comment">// non-object return original compiled code</span></span><br><span class="line">        <span class="keyword">if</span> (!_.<span class="title function_">isPlainObject</span>(<span class="variable language_">this</span>.<span class="property">_exports</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">exports</span> =  <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>.<span class="property">_exports</span>, &#123;</span><br><span class="line">            <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">require</span>.<span class="property">cache</span>[filename]) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="built_in">require</span>.<span class="property">cache</span>[filename].<span class="property">_exports</span>[key]</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123; ... &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单讲解一下：</p><ol><li>可传入 includes 和 excludes 参数，支持 glob 写法，用来设置监听哪些代码文件。</li><li>用 chokidar 模块监听文件，如果有改动则重新加载该文件。这里只针对 module.exports 导出的是纯对象的模块有用，做这个限制的原因是：对于非对象比如函数，一般我们导出一个函数会直接调用执行而不是获取函数上的属性或方法，这种导出非纯对象模块即使重建缓存也不会生效，所以干脆忽略。幸运的是，module.exports 导出对象占了大多数场景。</li><li>用 shimmer 模块重载 Module.prototype._compile 方法，如果是被监听的文件并且导出的是纯对象，则尝试将导出的对象包装成 Proxy 实例。这样，在获取该对象上的属性时，将从 require.cache 中读取最新的值。</li></ol><p>使用示例：</p><p><strong>user.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;nswbmw&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;proxy-hot-reload&#x27;</span>)(&#123;</span><br><span class="line">    <span class="attr">includes</span>: <span class="string">&#x27;**/*.js&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">&#x27;./user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = user</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>浏览器访问 localhost:3000 查看结果，修改 user.js 中字段的值，然后刷新浏览器查看结果。</p><p>proxy-hot-reload 有个非常明显的<strong>缺点</strong>：只支持对导出的是纯对象的文件做代理，而且程序入口文件不会生效，比如上面的 app.js，修改端口号只能重启才会生效。Proxy 再怎么黑魔法也只能做到这个地步了，退一步想，如果修改了 proxy-hot-reload 覆盖不到的文件（例如：app.js）降级成自动重启就好了，如果将 proxy-hot-reload 和 supervisor 结合，会怎么样呢？</p><h2 id="4-5-3-supervisor-hot-reload"><a href="#4-5-3-supervisor-hot-reload" class="headerlink" title="4.5.3 supervisor-hot-reload"></a>4.5.3 <a href="https://github.com/nswbmw/supervisor-hot-reload">supervisor-hot-reload</a></h2><p>如果要将 proxy-hot-reload 结合 supervisor 使用，需要解决以下几个难点：</p><ol><li>非侵入式。即代码里不再写：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;proxy-hot-reload&#x27;</span>)(&#123;</span><br><span class="line">    <span class="attr">includes</span>: <span class="string">&#x27;**/*.js&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>参数统一。supervisor 可接受 -w 参数表明监听哪些文件，-i 参数表明忽略哪些文件，这两个参数怎么与 proxy-hot-reload 的 includes 和 excludes 参数整合。</p></li><li><p>职责分明。修改代码文件并保存后，优先尝试 proxy-hot-reload 的热更新，如果 proxy-hot-reload 热更新不了，则使用 supervisor 重启。</p></li></ol><p>首先，我们来看下 supervisor 的源码（lib&#x2F;supervisor.js），源码中有这么一段代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> watchItems = watch.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">watchItems.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">watchItem</span>) &#123;</span><br><span class="line">    watchItem = path.<span class="title function_">resolve</span>(watchItem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! ignoredPaths[watchItem] ) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&quot;Watching directory &#x27;&quot;</span> + watchItem + <span class="string">&quot;&#x27; for changes.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(interactive) &#123;</span><br><span class="line">            <span class="title function_">log</span>(<span class="string">&quot;Press rs for restarting the process.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">findAllWatchFiles</span>(watchItem, <span class="keyword">function</span>(<span class="params">f</span>) &#123;</span><br><span class="line">            <span class="title function_">watchGivenFile</span>( f, poll_interval );</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>以上代码的作用是：遍历找到所有需要监听的文件，然后调用 watchGivenFile 监听文件。watchGivenFile 代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watchGivenFile</span> (watch, poll_interval) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isWindowsWithoutWatchFile || forceWatchFlag) &#123;</span><br><span class="line">        fs.<span class="title function_">watch</span>(watch, &#123; <span class="attr">persistent</span>: <span class="literal">true</span>, <span class="attr">interval</span>: poll_interval &#125;, crashWin);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fs.<span class="title function_">watchFile</span>(watch, &#123; <span class="attr">persistent</span>: <span class="literal">true</span>, <span class="attr">interval</span>: poll_interval &#125;, <span class="keyword">function</span>(<span class="params">oldStat, newStat</span>) &#123;</span><br><span class="line">            <span class="comment">// we only care about modification time, not access time.</span></span><br><span class="line">            <span class="keyword">if</span> ( newStat.<span class="property">mtime</span>.<span class="title function_">getTime</span>() !== oldStat.<span class="property">mtime</span>.<span class="title function_">getTime</span>() ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">                    <span class="title function_">log</span>(<span class="string">&quot;file changed: &quot;</span> + watch);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">crash</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&quot;watching file &#x27;&quot;</span> + watch + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>watchGivenFile 的作用是：用 fs.watch&#x2F;fs.watchFile 监听文件，如果有改动则调用 crashWin&#x2F;crash 程序退出。supervisor 使用 child_process.spawn 将程序运行在子进程，子进程退出后会被 supervisor 重新启动。相关代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">startProgram</span> (prog, exec) &#123;</span><br><span class="line">    <span class="keyword">var</span> child = <span class="built_in">exports</span>.<span class="property">child</span> = <span class="title function_">spawn</span>(exec, prog, &#123;<span class="attr">stdio</span>: <span class="string">&#x27;inherit&#x27;</span>&#125;);</span><br><span class="line">    ...</span><br><span class="line">    child.<span class="title function_">addListener</span>(<span class="string">&quot;exit&quot;</span>, <span class="keyword">function</span> (<span class="params">code</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="title function_">startProgram</span>(prog, exec);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大体理清 supervisor 的关键源码后，我们就知道如何解决上面提到的几个难点了。</p><p>首先需要修改 proxy-hot-reload，添加以下几个功能：</p><ol><li>添加 includeFiles 和 excludeFiles 选项，值为数组，用来接收 supervisor 传来的文件列表。</li><li>添加 watchedFileChangedButNotReloadCache 参数。proxy-hot-reload 可以知道哪些代码文件可以热更新，哪些不可以。当监听到不能热更新的文件有修改时，则调用 watchedFileChangedButNotReloadCache 函数，这个函数里有 process.exit() 使进程退出。</li></ol><p>难点及解决方案如下：</p><ol><li>非侵入式。因为真正的程序试运行在 supervisor 创建的子进程中，所以我们无法在 supervisor 进程中引入 proxy-hot-reload，只能通过子进程用 <code>node -r xxx</code> 提前引入并覆盖 Module.prototype._compile。解决方案：将 supervisor 需要监听的文件数组（watchFiles）和 proxy-hot-reload 配置写到一个文件（例如：proxy-hot-reload.js）里，子进程通过 <code>node -r proxy-hot-reload.js app.js</code> 预加载此文件启动。</li></ol><p>supervisor 相关代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 watchFiles</span></span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;proxy-hot-reload.js&#x27;</span>), <span class="string">`</span></span><br><span class="line"><span class="string">    require(&#x27;<span class="subst">$&#123;path.join(__dirname, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;node_modules&quot;</span>, <span class="string">&quot;proxy-hot-reload&quot;</span>)&#125;</span>&#x27;)(&#123;</span></span><br><span class="line"><span class="string">    includeFiles: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(watchFiles)&#125;</span>,</span></span><br><span class="line"><span class="string">    excludeFiles: [],</span></span><br><span class="line"><span class="string">    watchedFileChangedButNotReloadCache: function (filename) &#123;</span></span><br><span class="line"><span class="string">        console.log(filename + &#x27; changed, restarting...&#x27;);</span></span><br><span class="line"><span class="string">        setTimeout(function () &#123;</span></span><br><span class="line"><span class="string">            process.exit();</span></span><br><span class="line"><span class="string">        &#125;, <span class="subst">$&#123;poll_interval&#125;</span>);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);`</span>);</span><br><span class="line"><span class="comment">// startChildProcess()</span></span><br></pre></td></tr></table></figure><ol start="2"><li>参数统一。将上面的 watchItems.forEach 内异步遍历需要监听的文件列表修改为同步，代码如下：</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> watchFiles = []</span><br><span class="line"><span class="keyword">var</span> watchItems = watch.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">watchItems.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">watchItem</span>) &#123;</span><br><span class="line">    watchItem = path.<span class="title function_">resolve</span>(watchItem);</span><br><span class="line">    <span class="keyword">if</span> ( ! ignoredPaths[watchItem] ) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&quot;Watching directory &#x27;&quot;</span> + watchItem + <span class="string">&quot;&#x27; for changes.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(interactive) &#123;</span><br><span class="line">            <span class="title function_">log</span>(<span class="string">&quot;Press rs for restarting the process.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">findAllWatchFiles</span>(watchItem, <span class="keyword">function</span>(<span class="params">f</span>) &#123;</span><br><span class="line">            watchFiles.<span class="title function_">push</span>(f)</span><br><span class="line">            <span class="comment">// watchGivenFile( f, poll_interval );</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：这里 findAllWatchFiles 虽然有回调函数，但却是同步的。将 findAllWatchFiles 内的 fs.lstat&#x2F;fs.stat&#x2F;fs.readdir 分别改为 fs.lstatSync&#x2F;fs.statSync&#x2F;fs.readdirSync，这里就不贴代码了。</p><ol start="3"><li>职责分明。子进程使用 <code>node -r proxy-hot-reload.js app.js</code> 启动后，能热更新的则热更新，不能热更新的执行 watchedFileChangedButNotReloadCache，子进程退出，supervisor 会启动一个新的子进程，实现了职责分明。</li></ol><p>笔者将改进后的 supervisor 发布成一个新的包——<a href="https://github.com/nswbmw/supervisor-hot-reload">supervisor-hot-reload</a> 。使用如下：</p><p><strong>user.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;nswbmw&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>app.js</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Paloma</span> = <span class="built_in">require</span>(<span class="string">&#x27;paloma&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Paloma</span>()</span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">&#x27;./user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(&#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, controller (ctx) &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = user</span><br><span class="line">&#125;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>全局安装并使用 supervisor-hot-reload：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i supervisor-hot-reload -g</span><br><span class="line">$ DEBUG=proxy-hot-reload supervisor-hot-reload app.js</span><br></pre></td></tr></table></figure><p>修改 user.js，程序不会重启，打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy-hot-reload Reload file: /Users/nswbmw/Desktop/test/user.js</span><br></pre></td></tr></table></figure><p>修改 app.js，程序会重启，打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/Users/nswbmw/Desktop/test/app.js changed, restarting...</span><br><span class="line">Program node app.js exited with code 0</span><br><span class="line"></span><br><span class="line">Starting child process with &#x27;node app.js&#x27;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="4-5-4-内存泄露问题"><a href="#4-5-4-内存泄露问题" class="headerlink" title="4.5.4 内存泄露问题"></a>4.5.4 内存泄露问题</h2><p>这里需要声明一下，虽然修改 require.cache + Proxy 实现了我们想要的功能，但这样做存在内存泄漏问题，因为即使删除了一个模块的缓存，但父模块的缓存中还引用着旧的模块导出的对象。这个问题可以不用太关心，知道为什么就好，因为我们只是在开发环境使用 proxy-hot-reload。</p><h2 id="4-5-5-参考链接"><a href="#4-5-5-参考链接" class="headerlink" title="4.5.5 参考链接"></a>4.5.5 参考链接</h2><ul><li><a href="https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html">https://nodejs.org/dist/latest-v8.x/docs/api/async_hooks.html</a></li></ul><p>上一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/4.4%20debug%20%2B%20repl2%20%2B%20power-assert.md">4.4 debug + repl2 + power-assert</a></p><p>下一节：<a href="https://github.com/nswbmw/node-in-debugging/blob/master/5.1%20NewRelic.md">5.1 NewRelic</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我们在本地开发 Node.js 程序时通常会使用 &lt;a href=&quot;https://github.com/r</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging, 4.4 Debug</title>
    <link href="https://marvinliu1.github.io/2019/07/30/4.4.1%20debug/"/>
    <id>https://marvinliu1.github.io/2019/07/30/4.4.1%20debug/</id>
    <published>2019-07-30T06:00:00.000Z</published>
    <updated>2022-05-25T04:23:30.946Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>上一小节讲解了如何用使用 VS Code 调试 Node.js 代码，但调试不只是打断点，比如：</p><ul><li>如何快速地切换输出的日志类型（或级别）?</li><li>我想用 moment 打印出年份，是使用 <code>moment().format(&#39;YYYY&#39;)</code>，还是 <code>moment().format(&#39;yyyy&#39;)</code>，还是两种写法都可以?</li><li>断言报错：AssertionError: false &#x3D;&#x3D; true，没啥有用信息，黑人问号???</li></ul><p>本节将介绍 3 款实用的调试工具，分别解决以上 3 种情况，来提高我们的调试效率。</p><h2 id="4-4-1-debug"><a href="#4-4-1-debug" class="headerlink" title="4.4.1 debug"></a>4.4.1 debug</h2><p>debug 是一个小巧却非常实用的日志模块，可以根据环境变量决定打印不同类型（或级别）的日志。代码如下：</p><p><strong>app.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const normalLog = require(&#x27;debug&#x27;)(&#x27;log&#x27;)</span><br><span class="line">const errorLowLog = require(&#x27;debug&#x27;)(&#x27;error:low&#x27;)</span><br><span class="line">const errorNormalLog = require(&#x27;debug&#x27;)(&#x27;error:normal&#x27;)</span><br><span class="line">const errorHighLog = require(&#x27;debug&#x27;)(&#x27;error:high&#x27;)</span><br><span class="line"></span><br><span class="line">setInterval(() =&gt; &#123;</span><br><span class="line">  const value = Math.random()</span><br><span class="line">  switch (true) &#123;</span><br><span class="line">    case value &lt; 0.5: normalLog(value); break</span><br><span class="line">    case value &gt;= 0.5 &amp;&amp; value &lt; 0.7: errorLowLog(value); break</span><br><span class="line">    case value &gt;= 0.7 &amp;&amp; value &lt; 0.9: errorNormalLog(value); break</span><br><span class="line">    case value &gt;= 0.9: errorHighLog(value); break</span><br><span class="line">    default: normalLog(value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, 1000)</span><br></pre></td></tr></table></figure><p>运行上面的代码，每一秒生成一个随机数，根据随机数的值模拟不同级别的日志输出：</p><ul><li>&lt; 0.5：正常日志。</li><li>0.5~0.7：低级别的错误日志。</li><li>0.7~0.9：一般级别的错误日志。</li><li>&gt;&#x3D; 0.9：严重级别的错误日志。</li></ul><p>运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG=* node app.js</span><br></pre></td></tr></table></figure><p>打印如下：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.4.1.jpg"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.4.1.jpg" alt="img"></a></p><p>可以看出，debug 模块打印的日志与 console.log 相比，有以下几个特点：</p><ol><li>不同的日志类型分配了不同的颜色加以区分，更直观。</li><li>添加了日志类型的前缀。</li><li>添加了自上一次该类型日志打印到这次日志打印经历了多长时间的后缀。</li></ol><p>debug 模块支持以下用法：</p><ul><li>DEBUG&#x3D;*：打印所有类型的日志。</li><li>DEBUG&#x3D;log：只打印 log 类型的日志。</li><li>DEBUG&#x3D;error:*：打印所有以 error: 开头的日志。</li><li>DEBUG&#x3D;error:*,-error:low：打印所有以 error: 开头的并且过滤掉 error:low 类型的日志。</li></ul><p>下面演示一下第 4 种的用法，运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG=error:*,-error:low node app.js</span><br></pre></td></tr></table></figure><p>打印如下：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.4.2.jpg"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.4.2.jpg" alt="img"></a></p><h2 id="4-4-2-repl2"><a href="#4-4-2-repl2" class="headerlink" title="4.4.2 repl2"></a>4.4.2 repl2</h2><p>我们在写代码时，有时可能记不清某个模块的某个方法的具体用法，比如：用 moment 格式化年份是用 <code>moment().format(&#39;YYYY&#39;)</code> 还是用 <code>moment().format(&#39;yyyy&#39;)</code> 还是两种写法都可以？lodash 的 <code>_.pick</code> 方法能否能接收数组作为参数？这个时候相对于翻阅官方文档，在 REPL 里试一下可能会更快，通常步骤是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ npm i moment</span><br><span class="line">$ node</span><br><span class="line">&gt; const moment = require(&#x27;moment&#x27;)</span><br><span class="line">&gt; moment().format(&#x27;YYYY&#x27;)</span><br><span class="line">&#x27;2017&#x27;</span><br><span class="line">&gt; moment().format(&#x27;yyyy&#x27;)</span><br><span class="line">&#x27;yyyy&#x27;</span><br></pre></td></tr></table></figure><p>一次还好，次数多了也略微烦琐。repl2 模块便是为了解决这个问题而生的。</p><p>repl2 顾名思义是 REPL 的增强版，repl2 会根据一个用户配置（~&#x2F;.noderc），预先加载模块到 REPL 中，省下了我们手动在 REPL 中 require 模块的过程。</p><p>全局安装 repl2：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i repl2 -g</span><br></pre></td></tr></table></figure><p>使用方式很简单:</p><ol><li>将常用的模块全局安装，例如：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i lodash validator moment -g</span><br></pre></td></tr></table></figure><ol><li>添加配置到 ~&#x2F;.noderc：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;lodash&quot;: &quot;__&quot;,</span><br><span class="line">  &quot;moment&quot;: &quot;moment&quot;,</span><br><span class="line">  &quot;validator&quot;: &quot;validator&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>运行 noder：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ noder</span><br><span class="line">__ = lodash@4.17.4 -&gt; local</span><br><span class="line">moment = moment@2.18.1 -&gt; global</span><br><span class="line">validator = validator@7.0.0 -&gt; global</span><br><span class="line">&gt; moment().format(&#x27;YYYY&#x27;)</span><br><span class="line">&#x27;2017&#x27;</span><br><span class="line">&gt; __.random(0, 5)</span><br><span class="line">3</span><br><span class="line">&gt; validator.isEmail(&#x27;foo@bar.com&#x27;)</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>需要讲解以下几点：</p><ol><li>~&#x2F;.noderc 是一个 JSON 文件，key 是模块的名字，value 是 require 这个模块后加载到 REPL 中的变量名。这里给 lodash 命名的变量名是 __ 而不是 _，是因为 REPL 中 _ 有特殊含义，表示上一个表达式的结果。</li><li>repl2 会优先加载当前目录下的模块，没有找到然后再去加载全局安装的模块。上面结果显示 lodash 是从本地目录加载的，因为 test 目录下已经安装了 lodash，其余的模块没有从本地目录找到则尝试从全局 npm 目录加载。如果都没有找到，则不会加载。</li></ol><h2 id="4-4-3-power-assert"><a href="#4-4-3-power-assert" class="headerlink" title="4.4.3 power-assert"></a>4.4.3 power-assert</h2><p>我们常用的断言库有：</p><ul><li><a href="https://github.com/shouldjs/should.js">should.js</a></li><li><a href="https://github.com/Automattic/expect.js">expect.js</a></li><li><a href="https://github.com/chaijs/chai">chai</a></li></ul><p>但这类断言库都有一些通病：</p><ol><li>过分追求语义化，API 复杂。</li><li>错误信息不足。</li></ol><p>先看一段代码：</p><p><strong>test.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const assert = require(&#x27;assert&#x27;)</span><br><span class="line">const should = require(&#x27;should&#x27;)</span><br><span class="line">const expect = require(&#x27;expect.js&#x27;)</span><br><span class="line"></span><br><span class="line">const tom = &#123; id: 1, age: 18 &#125;</span><br><span class="line">const bob = &#123; id: 2, age: 20 &#125;</span><br><span class="line"></span><br><span class="line">describe(&#x27;app.js&#x27;, () =&gt; &#123;</span><br><span class="line">  it(&#x27;assert&#x27;, () =&gt; &#123;</span><br><span class="line">    assert(tom.age &gt; bob.age)</span><br><span class="line">  &#125;)</span><br><span class="line">  it(&#x27;should.js&#x27;, () =&gt; &#123;</span><br><span class="line">    tom.age.should.be.above(bob.age)</span><br><span class="line">  &#125;)</span><br><span class="line">  it(&#x27;expect.js&#x27;, () =&gt; &#123;</span><br><span class="line">    expect(tom.age).be.above(bob.age)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mocha</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">app.js</span><br><span class="line">  1) assert</span><br><span class="line">  2) should.js</span><br><span class="line">  3) expect.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 passing (13ms)</span><br><span class="line">3 failing</span><br><span class="line"></span><br><span class="line">1) app.js</span><br><span class="line">     assert:</span><br><span class="line"></span><br><span class="line">    AssertionError [ERR_ASSERTION]: false == true</span><br><span class="line">    + expected - actual</span><br><span class="line"></span><br><span class="line">    -false</span><br><span class="line">    +true</span><br><span class="line"></span><br><span class="line">    at Context.it (test.js:10:5)</span><br><span class="line"></span><br><span class="line">2) app.js</span><br><span class="line">     should.js:</span><br><span class="line">   AssertionError: expected 18 to be above 20</span><br><span class="line">    at Assertion.fail (node_modules/should/cjs/should.js:275:17)</span><br><span class="line">    at Assertion.value (node_modules/should/cjs/should.js:356:19)</span><br><span class="line">    at Context.it (test.js:13:23)</span><br><span class="line"></span><br><span class="line">3) app.js</span><br><span class="line">     expect.js:</span><br><span class="line">   Error: expected 18 to be above 20</span><br><span class="line">    at Assertion.assert (node_modules/expect.js/index.js:96:13)</span><br><span class="line">    at Assertion.greaterThan.Assertion.above (node_modules/expect.js/index.js:297:10)</span><br><span class="line">    at Function.above (node_modules/expect.js/index.js:499:17)</span><br><span class="line">    at Context.it (test.js:16:24)</span><br></pre></td></tr></table></figure><p>可以看出，基本没有有用的信息。这时，power-assert 粉墨登场。</p><p>power-assert 使用起来很简单，理论上只用一个 assert 就可以了，而且可以无缝迁移。</p><p><strong>注意</strong>：在使用 intelli-espower-loader 时，要求必须将测试文件放到 test&#x2F; 目录下，所以我们在 test 目录下创建 test&#x2F;app.js，将原来的 test.js 代码粘贴过去。</p><p>安装 power-assert 和 intelli-espower-loader，然后运行测试：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i power-assert intelli-espower-loader --save-dev</span><br><span class="line">$ mocha -r intelli-espower-loader</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">app.js</span><br><span class="line">  1) assert</span><br><span class="line">  2) should.js</span><br><span class="line">  3) expect.js</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 passing (42ms)</span><br><span class="line">3 failing</span><br><span class="line"></span><br><span class="line">1) app.js</span><br><span class="line">     assert:</span><br><span class="line"></span><br><span class="line">    AssertionError [ERR_ASSERTION]:   # test/app.js:10</span><br><span class="line"></span><br><span class="line">assert(tom.age &gt; bob.age)</span><br><span class="line">       |   |   | |   |</span><br><span class="line">       |   |   | |   20</span><br><span class="line">       |   |   | Object&#123;id:2,age:20&#125;</span><br><span class="line">       |   18  false</span><br><span class="line">       Object&#123;id:1,age:18&#125;</span><br><span class="line"></span><br><span class="line">    + expected - actual</span><br><span class="line"></span><br><span class="line">    -false</span><br><span class="line">    +true</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>错误信息非常直观，有以下两点需要说明：</p><ol><li>mocha 需要引入 intelli-espower-loader，主要是转译代码，转译之后 <code>require(&#39;assert&#39;)</code> 都不需要改。</li><li>intelli-espower-loader 可选择地在 package.json 中添加 directories.test 配置，例如：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;directories&quot;: &#123;</span><br><span class="line">  &quot;test&quot;: &quot;mytest/&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果没有 directories.test 配置，则默认是 <code>test/</code>。</p><h2 id="4-4-4-参考链接"><a href="#4-4-4-参考链接" class="headerlink" title="4.4.4 参考链接"></a>4.4.4 参考链接</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/25956323">https://zhuanlan.zhihu.com/p/25956323</a></li><li><a href="https://www.npmjs.com/package/intelli-espower-loader">https://www.npmjs.com/package/intelli-espower-loader</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上一小节讲解了如何用使用 VS Code 调试 Node.js 代码，但调试不只是打断点，比如：&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging, 4.3 VS Code Debugging</title>
    <link href="https://marvinliu1.github.io/2019/07/26/4.3.1%20%E5%9F%BA%E6%9C%AC%E8%B0%83%E8%AF%95/"/>
    <id>https://marvinliu1.github.io/2019/07/26/4.3.1%20%E5%9F%BA%E6%9C%AC%E8%B0%83%E8%AF%95/</id>
    <published>2019-07-26T06:00:00.000Z</published>
    <updated>2022-05-25T04:23:06.702Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>Visual Studio Code（简称 VS Code）是一款微软开源的现代化、跨平台、轻量级的代码编辑器。VS Code 很好很强大，本节将介绍如何使用 VS Code 来调试 Node.js 代码。</p><h2 id="4-3-1-基本调试"><a href="#4-3-1-基本调试" class="headerlink" title="4.3.1 基本调试"></a>4.3.1 基本调试</h2><p>示例代码如下：</p><p><strong>app.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const Paloma = require(&#x27;paloma&#x27;)</span><br><span class="line">const app = new Paloma()</span><br><span class="line"></span><br><span class="line">app.use(ctx =&gt; &#123;</span><br><span class="line">  ctx.body = &#x27;hello world!&#x27;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure><p>用 VS Code 加载 test 文件夹，打开 app.js，然后进行如下操作：</p><ol><li>单击左侧第 4 个 tab，切换到调试模式。</li><li>单击代码第 5 行 <code>ctx.body=&#39;hello world!&#39;</code> 左侧空白处添加断点。</li><li>单击左上角 ”调试“ 的绿色三角按钮启动调试。</li><li>单击左上角的终端图标打开调试控制台。</li></ol><p>最终如下所示：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.1.png" alt="img"></a></p><p>从 “调试控制台“ 切换到 ”终端“，运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:3000</span><br></pre></td></tr></table></figure><p>如下所示：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.2.png" alt="img"></a></p><p>可以看出，VS Code 基本覆盖了 Chrome DevTools 的所有功能，并且有两个额外的优点：</p><ol><li>集成了终端，不用再打开新的终端输入命令了。</li><li>调试动作里添加了 ”重启“ 和 ”停止“ 按钮，不用每次修改完代码后切回终端去重启了。</li></ol><p>但 VS Code 的强大远不止如此，通过 launch.json 可以配置详细的调试功能。</p><h2 id="4-3-2-launch-json"><a href="#4-3-2-launch-json" class="headerlink" title="4.3.2 launch.json"></a>4.3.2 launch.json</h2><p>上图可以看出，”调试“ 按钮右边有一个下拉菜单，默认是 ”没有配置“。单击右侧的齿轮状图标，会在项目根目录下创建 .vscode 文件夹及 launch.json 文件。launch.json 的内容如下：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.3.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.3.png" alt="img"></a></p><p>这个默认配置的意思是执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node $&#123;workspaceFolder&#125;/app.js</span><br></pre></td></tr></table></figure><p>launch.json 其实就是存储了一些调试相关的配置，VS Code 在启动调试时，会读取 launch.json 决定以何种方式调试。launch.json 有以下常用选项：</p><p>必需字段如下：</p><ul><li>type：调试器类型。这里是 node（内置的调试器），如果安装了 Go 和 PHP 的扩展后，则对应的 type 分别为 go 和 php。</li><li>request：请求的类型，支持 launch 和 attach。launch 就是以 debug 模式启动调试，attach 就是附加到已经启动的进程开启 debug 模式并调试，跟在上一小节中提到的用 <code>node -e &quot;process._debugProcess(PID)&quot;</code> 作用一样。</li><li>name：下拉菜单显示的名字。</li></ul><p>可选字段（括号里表示适用的类型）如下：</p><ul><li>program：可执行文件或者调试器要运行的文件 (launch)。</li><li>args：要传递给调试程序的参数 (launch)。</li><li>env：环境变量 (launch)。</li><li>cwd：当前执行目录 (launch)。</li><li>address：IP 地址 (launch &amp; attach)。</li><li>port：端口号 (launch &amp; attach)。</li><li>skipFiles：想要忽略的文件，数组类型 (launch &amp; attach)。</li><li>processId：进程 PID (attach)。</li><li>…</li></ul><p>变量替换：</p><ul><li>${workspaceFolder}：当前打开工程的路径。</li><li>${file}：当前打开文件的路径。</li><li>${fileBasename}：当前打开文件的名字，包含后缀名。</li><li>${fileDirname}：当前打开文件所在的文件夹的路径。</li><li>${fileExtname}：当前打开文件的后缀名。</li><li>${cwd}：当前执行目录。</li><li>…</li></ul><p>如果当前打开的文件是 app.js，则以下配置与默认配置是等效的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;file&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>若想了解更多的 launch.json 选项，则请查阅：</p><ul><li><a href="https://code.visualstudio.com/docs/editor/debugging#_launchjson-attributes">Debugging in Visual Studio Code</a>。</li><li><a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_launch-configuration-attributes">Debug Node.js Apps using VS Code</a>。</li></ul><p>下面以 5 个实用的技巧讲解部分 launch.json 配置的作用。</p><h2 id="4-3-3-技巧-1——条件断点"><a href="#4-3-3-技巧-1——条件断点" class="headerlink" title="4.3.3 技巧 1——条件断点"></a>4.3.3 技巧 1——条件断点</h2><p>VS Code 可以添加条件断点，即执行到该行代码满足特定条件后程序才会中断。在断点小红点上右键选择 ”编辑断点“，可以选择以下两种条件：</p><ol><li>表达式：当表达式计算结果为 true 时中断，例如设置：<code>ctx.query.name === &#39;nswbmw&#39;</code>，表示当访问 <code>localhost:3000?name=nswbmw</code> 时断点才会生效，其余请求断点无效。</li><li>命中次数：同样当表达式计算结果为 true 时中断，支持运算符 &lt;、&lt;&#x3D;、&#x3D;&#x3D;、&gt;、&gt;&#x3D;、%。例如：<ol><li>&gt;10：执行 10 次以后，断点才会生效。</li><li>&lt;3：只有前 2 次断点会生效。</li><li>10：等价于 &gt;&#x3D;10。</li><li>%2：隔一次中断一次。</li></ol></li></ol><p><strong>注意</strong>：可以组合表达式和命中次数条件一起使用。在切换条件类型时，需要将原来的条件清空，否则会添加两种条件。将鼠标悬浮在断点上，可以查看设置了哪些条件。</p><h2 id="4-3-4-技巧-2——skipFiles"><a href="#4-3-4-技巧-2——skipFiles" class="headerlink" title="4.3.4 技巧 2——skipFiles"></a>4.3.4 技巧 2——skipFiles</h2><p>从上面图中可以看到，在 VS Code 左侧有一个 ”调用堆栈“ 面板，显示了当前断点的调用堆栈，但无法直观地看出哪些是我们项目的代码，哪些是 node_modules 里模块的代码，而且在单步调试时会进入到 node_modules 里。总之，我们不关心 node_modules 里的代码，我们只关心项目本身的代码。这时，skipFiles 就派上用场了。</p><p>skipFiles 顾名思义就是忽略我们不关心的文件。修改 launch.json 如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;,</span><br><span class="line">                &quot;&lt;node_internals&gt;/**/*.js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有以下几点需要解释：</p><ol><li>支持 ${xxx} 这种变量替换。</li><li>支持 glob 模式匹配。</li><li><node_internals> 用来忽略 Node.js 核心模块。</li></ol><p>重启调试后，如下所示：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.4.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.4.png" alt="img"></a></p><p><strong>可以看出</strong>：在左侧 ”调用堆栈“ 中，我们不关心的调用栈都变灰了，而且单步调试也不会进入到 skipFiles 所匹配的文件里。</p><h2 id="4-3-5-技巧-3——自动重启"><a href="#4-3-5-技巧-3——自动重启" class="headerlink" title="4.3.5 技巧 3——自动重启"></a>4.3.5 技巧 3——自动重启</h2><p>在每次修改代码保存后都要手动重启，否则修改后的代码和断点都不会生效。VS Code 开发者们想到了这一点，通过添加配置可以实现修改代码保存后会自动重启调试，需要结合 <a href="https://nodemon.io/">nodemon</a> 一起使用。</p><p>首先，全局安装 nodemon：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i nodemon -g</span><br></pre></td></tr></table></figure><p>然后，修改 launch.json：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;runtimeExecutable&quot;: &quot;nodemon&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;console&quot;: &quot;integratedTerminal&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;,</span><br><span class="line">                &quot;&lt;node_internals&gt;/**/*.js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当前的 launch.json 相比较上一个版本的 launch.json，多了以下几个字段：</p><ul><li>runtimeExecutable：用什么命令执行 app.js，这里设置为 nodemon。</li><li>restart：设置为 true，修改代码并保存后会自动重启调试。</li><li>console：当单击停止按钮或者修改代码并保存后自动重启调试，而 nodemon 是仍然在运行的，通过设置为 console 为 integratedTerminal 可以解决这个问题。此时 VS Code 终端将会打印 nodemon 的 log，可以在终端右侧的下拉菜单中选择返回第 1 个终端，然后运行 <code>curl localhost:3000</code> 进行调试。</li></ul><p>对于已经使用 nodemon 运行的程序，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nodemon --inspect app.js</span><br></pre></td></tr></table></figure><p>可使用 attach 模式启动调试，launch.json 如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;Attach to node&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;attach&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;processId&quot;: &quot;$&#123;command:PickProcess&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行 Attach to node 配置进行调试时，VS Code 会列出正在执行的 node 进程及对应的 PID 以供选择。也可以通过 address 和 port 参数设置 attach 到具体的进程开启调试。</p><h2 id="4-3-6-技巧-4——特定操作系统设置"><a href="#4-3-6-技巧-4——特定操作系统设置" class="headerlink" title="4.3.6 技巧 4——特定操作系统设置"></a>4.3.6 技巧 4——特定操作系统设置</h2><p>针对不同的操作系统，可能会用到不同的调试配置。可选的参数为：</p><ul><li>windows</li><li>linux</li><li>osx</li></ul><p>示例如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动调试&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;./node_modules/gulp/bin/gulpfile.js&quot;,</span><br><span class="line">            &quot;args&quot;: [&quot;/path/to/app.js&quot;],</span><br><span class="line">            &quot;windows&quot;: &#123;</span><br><span class="line">                &quot;args&quot;: [&quot;\\path\\to\\app.js&quot;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3-7-技巧-5——多配置"><a href="#4-3-7-技巧-5——多配置" class="headerlink" title="4.3.7 技巧 5——多配置"></a>4.3.7 技巧 5——多配置</h2><p>configurations 是个数组而不是个对象，这样设计就是为了可以添加多个调试配置。打开 launch.json，单击右下角的 ”添加配置…“，会弹出配置模板，如下所示：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.3.5.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.3.5.png" alt="img"></a></p><p>configurations 可以用来配置不同的调试规则，比如最终将 launch.json 修改如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;attach&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;Attach to node&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;processId&quot;: &quot;$&#123;command:PickProcess&#125;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;启动程序&quot;,</span><br><span class="line">            &quot;runtimeExecutable&quot;: &quot;nodemon&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/app.js&quot;,</span><br><span class="line">            &quot;restart&quot;: true,</span><br><span class="line">            &quot;console&quot;: &quot;integratedTerminal&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/node_modules/**/*.js&quot;,</span><br><span class="line">                &quot;&lt;node_internals&gt;/**/*.js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3-8-总结"><a href="#4-3-8-总结" class="headerlink" title="4.3.8 总结"></a>4.3.8 总结</h2><p>VS Code 的调试功能十分强大，本节只讲解了一些常用的调试功能，对于其余的调试功能，还请读者自行尝试。</p><h2 id="4-3-9-参考链接"><a href="#4-3-9-参考链接" class="headerlink" title="4.3.9 参考链接"></a>4.3.9 参考链接</h2><ul><li><a href="https://code.visualstudio.com/docs/editor/debugging">https://code.visualstudio.com/docs/editor/debugging</a></li><li><a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging">https://code.visualstudio.com/docs/nodejs/nodejs-debugging</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Visual Studio Code（简称 VS Code）是一款微软开源的现代化、跨平台、轻量级的代码编辑</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging, 4.2 Chrome Devtools</title>
    <link href="https://marvinliu1.github.io/2019/07/22/4.2.1%20%E4%BD%BF%E7%94%A8%20Chrome%20DevTools/"/>
    <id>https://marvinliu1.github.io/2019/07/22/4.2.1%20%E4%BD%BF%E7%94%A8%20Chrome%20DevTools/</id>
    <published>2019-07-22T06:00:00.000Z</published>
    <updated>2022-05-25T04:23:06.702Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><p>调试是每个程序员必备的技能，因此选择合适的调试工具能极大地方便我们调试代码。Node.js 的调试方式也有很多，常见的有：</p><ol><li>万能的 console.log</li><li>debugger</li><li>node-inspector</li></ol><p>以上本节都不会讲解，因为：</p><ol><li>console.log 就不用说了。</li><li>debugger 不推荐使用，因为：<ol><li>使用繁琐，需手动打点。</li><li>若忘记删除 debugger，还会引起性能问题。</li></ol></li><li>node-inspector 已经退出历史舞台。<a href="mailto:&#x6e;&#x6f;&#100;&#x65;&#64;&#54;&#46;&#51;">&#x6e;&#x6f;&#100;&#x65;&#64;&#54;&#46;&#51;</a> 以后内置了一个调试器，可以结合 Chrome DevTools 使用，而且比 node-inspector 更强大。</li></ol><p>下面就讲讲 Chrome DevTools 的用法。</p><h2 id="4-2-1-使用-Chrome-DevTools"><a href="#4-2-1-使用-Chrome-DevTools" class="headerlink" title="4.2.1 使用 Chrome DevTools"></a>4.2.1 使用 Chrome DevTools</h2><p>创建示例代码：</p><p><strong>app.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const Paloma = require(&#x27;paloma&#x27;)</span><br><span class="line">const app = new Paloma()</span><br><span class="line"></span><br><span class="line">app.use(ctx =&gt; &#123;</span><br><span class="line">  ctx.body = &#x27;hello world!&#x27;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node --inspect app.js</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：如果想让代码在第 1 行就暂停执行，需要使用 –inspect-brk 参数启动，即 <code>node --inspect-brk app.js</code>。</p><p>打开 Chrome 浏览器，访问 chrome:&#x2F;&#x2F;inspect，如下所示：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.1.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.1.png" alt="img"></a></p><p>单击 Remote Target 下的 inspect，选择 Sources，如下所示：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.2.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.2.png" alt="img"></a></p><p>使用方式与 node-inspector 类似，可以添加断点，然后在 Console 里面直接输入变量名来打印该变量的值。如下所示，在第 6 行添加断点，然后通过 <code>curl localhost:3000?name=nswbmw</code>，代码执行到第 6 行暂停执行，在 Console 里打印 ctx.query 的值：</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.3.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.3.png" alt="img"></a></p><p><strong>小提示</strong>：将鼠标悬浮在某个变量上，也会显示它的值，例如：ctx。</p><p>展开右侧的 debugger 有更多的功能，例如单步执行、单步进入、单步退出等等，这里不再详细讲解。</p><h2 id="4-2-2-NIM"><a href="#4-2-2-NIM" class="headerlink" title="4.2.2 NIM"></a>4.2.2 <a href="https://chrome.google.com/webstore/detail/nim-node-inspector-manage/gnhhdgbaldcilmgcpfddgdbkhjohddkj">NIM</a></h2><p>每次调试 Node.js 都要打开隐藏那么深的入口是不是很烦？还好我们有 <a href="https://chrome.google.com/webstore/detail/nim-node-inspector-manage/gnhhdgbaldcilmgcpfddgdbkhjohddkj">NIM</a>。NIM（Node Inspector Manager）是一个 Chrome 插件，可以帮助我们快捷地打开 DevTools，也可以设置自动发现并打开 DevTools。</p><p><a href="https://github.com/nswbmw/node-in-debugging/blob/master/assets/4.2.4.png"><img src="https://github.com/nswbmw/node-in-debugging/raw/master/assets/4.2.4.png" alt="img"></a></p><h2 id="4-2-3-inspect-process"><a href="#4-2-3-inspect-process" class="headerlink" title="4.2.3 inspect-process"></a>4.2.3 <a href="https://github.com/jaridmargolin/inspect-process">inspect-process</a></h2><p>如果你觉得 NIM 用起来也麻烦，那你可能需要 <a href="https://github.com/jaridmargolin/inspect-process">inspect-process</a>。</p><p>全局安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i inspect-process -g</span><br></pre></td></tr></table></figure><p>使用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ inspect app.js</span><br></pre></td></tr></table></figure><p>inspect-process 会自动调起 Chrome DevTools，然后定位到 app.js，其余用法与 Chrome DevTools 一致。</p><h2 id="4-2-4-process-debugProcess"><a href="#4-2-4-process-debugProcess" class="headerlink" title="4.2.4 process._debugProcess"></a>4.2.4 process._debugProcess</h2><p>如果一个 Node.js 进程已经启动，没有添加 –inspect 参数，我们不想重启（会丢失现场）又想调试怎么办？这时可以用 process._debugProcess。使用方法如下：</p><ol><li>通过 ps 命令或者 <code>pgrep -n node</code> 查看当前启动的 Node.js 进程的 pid，例如：53911。</li><li>打开新的终端，运行：<code>node -e &quot;process._debugProcess(53911)&quot;</code>，原来的 Node.js 进程会打印出：Debugger listening on ws:&#x2F;&#x2F;127.0.0.1:9229&#x2F;2331fa07-32af-45eb-a1a8-bead7a0ab905。</li><li>调出 Chrome DevTools 进行调试。</li></ol><h2 id="4-2-5-参考链接"><a href="#4-2-5-参考链接" class="headerlink" title="4.2.5 参考链接"></a>4.2.5 参考链接</h2><ul><li><a href="https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27">https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;调试是每个程序员必备的技能，因此选择合适的调试工具能极大地方便我们调试代码。Node.js 的调试方式也有很</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
  <entry>
    <title>Nohup stop running unexpected - solved</title>
    <link href="https://marvinliu1.github.io/2019/07/21/Nohup-exit/"/>
    <id>https://marvinliu1.github.io/2019/07/21/Nohup-exit/</id>
    <published>2019-07-21T06:00:00.000Z</published>
    <updated>2022-05-25T05:05:54.636Z</updated>
    
    <content type="html"><![CDATA[<p>Today I have encounterd a weird issue with Nohup, my sh command is used as:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> npm start 2&gt;/dev/null 1&gt;/dev/null&amp;</span><br></pre></td></tr></table></figure><p>But after I have closed the connection of my Putty, the npm thread was terminated.</p><p>Finally, I have found the problem is with the session, to disconnect the Putty, I have to tpye in command exit, instead of closing the window directly, the exit command will leave the session running in background.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Today I have encounterd a weird issue with Nohup, my sh command is used as:&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutt</summary>
      
    
    
    
    <category term="Hexo" scheme="https://marvinliu1.github.io/categories/Hexo/"/>
    
    <category term="Linux" scheme="https://marvinliu1.github.io/categories/Hexo/Linux/"/>
    
    
    <category term="Nohup" scheme="https://marvinliu1.github.io/tags/Nohup/"/>
    
    <category term="Linux" scheme="https://marvinliu1.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Node in Debugging, 4.1 Source Map</title>
    <link href="https://marvinliu1.github.io/2019/07/18/4.1.1%20%E4%BB%80%E4%B9%88%E6%98%AF%20Source%20Map%EF%BC%9F/"/>
    <id>https://marvinliu1.github.io/2019/07/18/4.1.1%20%E4%BB%80%E4%B9%88%E6%98%AF%20Source%20Map%EF%BC%9F/</id>
    <published>2019-07-18T06:00:00.000Z</published>
    <updated>2022-05-25T04:23:06.703Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/nswbmw/node-in-debugging">Node in Debugging</a></p><h2 id="4-1-1-什么是-Source-Map？"><a href="#4-1-1-什么是-Source-Map？" class="headerlink" title="4.1.1 什么是 Source Map？"></a>4.1.1 什么是 Source Map？</h2><p>对于 Source Map，想必大家并不陌生，在前端开发中通常要压缩 JavaScript，CSS，以减小体积，加快网页显示。但带来的后果是如果出现错误，就会导致无法定位错误，这时 Source Map 应运而生。举个例子， jQuery 1.9 引入了 Source Map，打开 <a href="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js%EF%BC%8C%E6%9C%80%E5%90%8E%E4%B8%80%E8%A1%8C%E6%98%AF%E8%BF%99%E6%A0%B7%E7%9A%84%EF%BC%9A">http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js，最后一行是这样的：</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//@ sourceMappingURL=jquery.min.map</span><br></pre></td></tr></table></figure><p>这就是 Source Map。它是一个独立的 map（其实就是 JSON） 文件，通常与源码在同一个目录下。</p><p>Source Map 常用于以下几个场景：</p><ol><li>压缩代码，减小体积。比如 jQuery 1.9 的源码，压缩前是 252KB，压缩后是 32KB。</li><li>多个文件合并，减少 HTTP 请求数，仅用于前端。</li><li>将其他语言编译成 JavaScript，例如：CoffeeScript、TypeScript 等。</li></ol><p>本节只讲解如何使用 Source Map，关于 map 文件中字段的含义本节不会解释，有兴趣的读者可以查看参考链接中的文章。接下来我们在 Node.js 环境下以场景 1、3 为例，分别介绍如何将 uglify-es 和 TypeScript 结合 Source Map 使用。</p><h2 id="4-1-2-uglify-es"><a href="#4-1-2-uglify-es" class="headerlink" title="4.1.2 uglify-es"></a>4.1.2 uglify-es</h2><p>uglify-js 是最常用的 JavaScript 代码压缩工具，但只支持到 ES5，uglify-es 支持 ES6+ 并且兼容 uglify-js，所以本节使用 uglify-es。</p><p>source-map-support 是一个在 Node.js 环境下支持 Source Map 的模块。</p><p>安装 uglify-es 和 source-map-support：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i uglify-es -g</span><br><span class="line">$ npm i source-map-support</span><br></pre></td></tr></table></figure><p>创建测试代码：</p><p><strong>app.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">require(&#x27;source-map-support&#x27;).install()</span><br><span class="line"></span><br><span class="line">function sayHello (name) &#123;</span><br><span class="line">  throw new Error(&#x27;error!!!&#x27;)</span><br><span class="line">  console.log(`Hello, $&#123;name&#125;`)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sayHello(&#x27;World&#x27;)</span><br></pre></td></tr></table></figure><p>使用 uglify-es 压缩代码文件并生成 map 文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ uglifyjs app.js -o app.min.js --source-map &quot;url=app.min.js.map&quot;</span><br></pre></td></tr></table></figure><p>生成 app.min.js 和 app.min.js.map 文件，内容分别如下：</p><p><strong>app.min.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">require(&quot;source-map-support&quot;).install();function sayHello(name)&#123;throw new Error(&quot;error!!!&quot;);console.log(`Hello, $&#123;name&#125;`)&#125;sayHello(&quot;World&quot;);</span><br><span class="line">//# sourceMappingURL=app.min.js.map</span><br></pre></td></tr></table></figure><p><strong>app.min.js.map</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;version&quot;:3,&quot;sources&quot;:[&quot;app.js&quot;],&quot;names&quot;:[&quot;require&quot;,&quot;install&quot;,&quot;sayHello&quot;,&quot;name&quot;,&quot;Error&quot;,&quot;console&quot;,&quot;log&quot;],&quot;mappings&quot;:&quot;AAAAA,QAAQ,sBAAsBC,UAE9B,SAASC,SAAUC,MACjB,MAAM,IAAIC,MAAM,YAChBC,QAAQC,cAAcH,QAGxBD,SAAS&quot;&#125;</span><br></pre></td></tr></table></figure><p>此时运行 app.min.js 可以显示正确的错误栈：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node app.min.js</span><br><span class="line"></span><br><span class="line">/Users/nswbmw/Desktop/test/app.js:4</span><br><span class="line">  throw new Error(&#x27;error!!!&#x27;)</span><br><span class="line">        ^</span><br><span class="line">Error: error!!!</span><br><span class="line">    at sayHello (/Users/nswbmw/Desktop/test/app.js:4:9)</span><br></pre></td></tr></table></figure><p>如果删除 app.min.js 最后那行注释，重新运行则无法显示正确的错误栈：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node app.min.js</span><br><span class="line"></span><br><span class="line">/Users/nswbmw/Desktop/test/app.min.js:1</span><br><span class="line">require(&quot;source-map-support&quot;).install();function sayHello(name)&#123;throw new Error(&quot;error!!!&quot;);console.log(`Hello, $&#123;name&#125;`)&#125;sayHello(&quot;World&quot;);</span><br><span class="line">                                                                      ^</span><br><span class="line">Error: error!!!</span><br><span class="line">    at sayHello (/Users/nswbmw/Desktop/test/app.min.js:1:71)</span><br></pre></td></tr></table></figure><p>source-map-support 是通过 Error.prepareStackTrace 实现的，前面讲解过它的用法，这里不再赘述。</p><h2 id="4-1-3-TypeScript"><a href="#4-1-3-TypeScript" class="headerlink" title="4.1.3 TypeScript"></a>4.1.3 TypeScript</h2><p>全局安装 TypeScript：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i typescript -g</span><br></pre></td></tr></table></figure><p>创建测试代码：</p><p><strong>app_ts.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">declare function require(name: string)</span><br><span class="line">require(&#x27;source-map-support&#x27;).install()</span><br><span class="line"></span><br><span class="line">function sayHello (name: string): any &#123;</span><br><span class="line">  throw new Error(&#x27;error!!!&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sayHello(&#x27;World&#x27;)</span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tsc --sourceMap app_ts.ts</span><br></pre></td></tr></table></figure><p>生成 app_ts.js 和 app_ts.js.map，运行 app_ts.js 如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node app_ts.js</span><br><span class="line"></span><br><span class="line">/Users/nswbmw/Desktop/test/app_ts.ts:5</span><br><span class="line">  throw new Error(&#x27;error!!!&#x27;)</span><br><span class="line">        ^</span><br><span class="line">Error: error!!!</span><br><span class="line">    at sayHello (/Users/nswbmw/Desktop/test/app_ts.ts:5:9)</span><br></pre></td></tr></table></figure><h2 id="4-1-4-source-map-support-高级用法"><a href="#4-1-4-source-map-support-高级用法" class="headerlink" title="4.1.4 source-map-support 高级用法"></a>4.1.4 source-map-support 高级用法</h2><p>我们可以在调用 install 方法时传入一个 retrieveSourceMap 参数，用来自定义处理 Source Map：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">require(&#x27;source-map-support&#x27;).install(&#123;</span><br><span class="line">  retrieveSourceMap: function(source) &#123;</span><br><span class="line">    if (source === &#x27;compiled.js&#x27;) &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        url: &#x27;original.js&#x27;,</span><br><span class="line">        map: fs.readFileSync(&#x27;compiled.js.map&#x27;, &#x27;utf8&#x27;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>比如将所有 map 文件缓存到内存中，而不是磁盘上。</p><h2 id="4-1-5-参考链接"><a href="#4-1-5-参考链接" class="headerlink" title="4.1.5 参考链接"></a>4.1.5 参考链接</h2><ul><li><a href="http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html">http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html</a></li><li><a href="https://yq.aliyun.com/articles/73529">https://yq.aliyun.com/articles/73529</a></li><li><a href="https://github.com/v8/v8/wiki/Stack-Trace-API">https://github.com/v8/v8/wiki/Stack-Trace-API</a></li><li><a href="https://github.com/evanw/node-source-map-support">https://github.com/evanw/node-source-map-support</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://github.com/nswbmw/node-in-debugging&quot;&gt;Node in Debugging&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;4-1-1-什么是-Source-Map？&quot;&gt;&lt;a href=&quot;#4-1-1-什么是-Source</summary>
      
    
    
    
    <category term="Node in Debugging" scheme="https://marvinliu1.github.io/categories/Node-in-Debugging/"/>
    
    
    <category term="Node" scheme="https://marvinliu1.github.io/tags/Node/"/>
    
    <category term="Debugging" scheme="https://marvinliu1.github.io/tags/Debugging/"/>
    
  </entry>
  
</feed>
